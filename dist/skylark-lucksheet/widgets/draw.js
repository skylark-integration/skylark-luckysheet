/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../methods/pivotTable_methods","../methods/conditionformat_methods","../methods/alternateformat_methods","../widgets/sparkline","../methods/cells","../widgets/dataVerificationCtrl","../widgets/constant","../methods/sheetSearch","../methods/dynamicArray","../utils/browser","../methods/validate","../methods/getRowlen","../methods/getdata","../methods/border","../methods/get","../utils/util","../methods/luckysheetConfigsetting","../store","../locale/locale"],function(e,t,l,o,i,n,a,c,r,s,d,f,h,u,m,g,b,y,v){"use strict";const{luckysheetdefaultstyle:T,luckysheet_CFiconsImg:w,luckysheetdefaultFont:k}=a,{luckysheet_searcharray:x}=c,{dynamicArrayCompute:R}=r,{isRealNull:S,isRealNum:_}=d,{getMeasureText:p,getCellTextInfo:P}=f,{getRealCellValue:H}=h,{getBorderInfoComputeRange:C}=u,{getSheetIndex:z}=m,{getObjType:W,chatatABC:D,luckysheetfontformat:B}=g,{isInlineStringCell:F}=i;let L=function(e,t,l,i,n,a){if(null==y.flowdata[e]||null==y.flowdata[e][t])return;let c=y.flowdata[e][t].spl;if(null!=c)if("string"==typeof c&&(c=new Function("return "+c)()),"object"==W(c)){let e=c,t=e.offsetX,r=e.offsetY;t=null==t?0:t,r=null==r?0:r,o.render(e.shapeseq,e.shapes,l+t,i+r,e.pixelWidth,e.pixelHeight,n,a)}else if("array"==W(c)&&"object"==W(c[0]))for(let e=0;e<c.length;e++){let t=c[e],r=t.offsetX,s=t.offsetY;r=null==r?0:r,s=null==s?0:s,o.render(t.shapeseq,t.shapes,l+r,i+s,t.pixelWidth,t.pixelHeight,n,a)}},I=function(e,o,n,a,c,r,d,f,h,u,m,g,v,w,x,R,S,_,p){let P=l.checksAF(e,o,f),H=t.checksCF(e,o,h),C=i.borderfix(y.flowdata,e,o),z=i.checkstatus(y.flowdata,e,o,"bg");null!=P&&null!=P[1]&&(z=P[1]),null!=H&&null!=H.cellColor&&(z=H.cellColor),null!=y.flowdata[e][o]&&null!=y.flowdata[e][o].tc&&(z=y.flowdata[e][o].tc),d.fillStyle=null==z?"#FFFFFF":z;let W=[a+u+C[0],n+m+C[1],r-a+C[2]-(p?1:0),c-n+C[3]];if(!b.createHookFunction("cellRenderBefore",y.flowdata[e][o],{r:e,c:o,start_r:W[1],start_c:W[0],end_r:W[3]+W[1],end_c:W[2]+W[0]},y.getSheetByIndex(),d))return;if(d.fillRect(W[0],W[1],W[2],W[3]),e+"_"+o in g){let t=g[e+"_"+o].v;d.fillStyle="#000000";let l=k();d.font=l;let i=a+4+u,n=(s.luckysheetrefreshfixed(),c+m-2);d.textBaseline="bottom",d.fillText(null==t?"":t,i,n)}if(null!=y.flowdata[e][o]&&null!=y.flowdata[e][o].ps){let e=8*y.zoomRatio,t=8*y.zoomRatio;d.beginPath(),d.moveTo(r+u-1-e,n+m),d.lineTo(r+u-1,n+m),d.lineTo(r+u-1,n+m+t),d.fillStyle="#FC6666",d.fill(),d.closePath()}let D=j(v,e,o,w,x);D.colLast&&A(D.rowIndex,D.colIndex,D.stc,D.edc,d,R,S,u,m,f,h),D.colIn&&!D.colLast||y.luckysheetcurrentisPivotTable||z||!y.showGridLines||(d.beginPath(),d.moveTo(r+u-2+_,n+m),d.lineTo(r+u-2+_,c+m),d.lineWidth=1,d.strokeStyle=T.strokeStyle,d.stroke(),d.closePath()),y.luckysheetcurrentisPivotTable||z||!y.showGridLines||(d.beginPath(),d.moveTo(a+u-1,c+m-2+_),d.lineTo(r+u-1,c+m-2+_),d.lineWidth=1,d.strokeStyle=T.strokeStyle,d.stroke(),d.closePath()),b.createHookFunction("cellRenderAfter",y.flowdata[e][o],{r:e,c:o,start_r:W[1],start_c:W[0],end_r:W[3]+W[1],end_c:W[2]+W[0]},y.getSheetByIndex(),d)},M=function(e,o,a,c,r,s,d,f,h,u,m,g,v,k,x,R,S,H,C,z){let W=y.flowdata[e][o],D=s-c-2,B=r-a-2,F=i.checkstatus(y.flowdata,e,o,"ht"),L=i.checkstatus(y.flowdata,e,o,"vt"),I=l.checksAF(e,o,h),M=t.checksCF(e,o,u),O=i.checkstatus(y.flowdata,e,o,"bg");null!=I&&null!=I[1]&&(O=I[1]),null!=M&&null!=M.cellColor&&(O=M.cellColor),f.fillStyle=null==O?"#FFFFFF":O;let $=i.borderfix(y.flowdata,e,o),X=[c+m+$[0],a+g+$[1],s-c+$[2]-(z?1:0),r-a+$[3]];if(!b.createHookFunction("cellRenderBefore",y.flowdata[e][o],{r:e,c:o,start_r:X[1],start_c:X[0],end_r:X[3]+X[1],end_c:X[2]+X[0]},y.getSheetByIndex(),f))return;f.fillRect(X[0],X[1],X[2],X[3]);let Y=y.dataVerification;if(null!=Y&&null!=Y[e+"_"+o]&&!n.validateCellData(d,Y[e+"_"+o])){let e=5*y.zoomRatio,t=5*y.zoomRatio;f.beginPath(),f.moveTo(c+m,a+g),f.lineTo(c+m+e,a+g),f.lineTo(c+m,a+g+t),f.fillStyle="#FC6666",f.fill(),f.closePath()}if(null!=W.ps){let e=8*y.zoomRatio,t=8*y.zoomRatio;f.beginPath(),f.moveTo(s+m-e,a+g),f.lineTo(s+m,a+g),f.lineTo(s+m,a+g+t),f.fillStyle="#FC6666",f.fill(),f.closePath()}if(1==W.qp&&_(W.v)){let e=6*y.zoomRatio,t=6*y.zoomRatio;f.beginPath(),f.moveTo(c+m+e-1,a+g),f.lineTo(c+m-1,a+g),f.lineTo(c+m-1,a+g+t),f.fillStyle="#487f1e",f.fill(),f.closePath()}let q=!0,V=j(k,e,o,x,R);if("1"==W.tb&&V.colIn)V.colLast?A(V.rowIndex,V.colIndex,V.stc,V.edc,f,S,H,m,g,h,u):q=!1;else if(null!=Y&&null!=Y[e+"_"+o]&&"checkbox"==Y[e+"_"+o].type){let t=c+m,l=a+g+1;f.save(),f.beginPath(),f.rect(t,l,D,B),f.clip(),f.scale(y.zoomRatio,y.zoomRatio);let n=p(d,f),r=n.width+14,s=n.actualBoundingBoxDescent+n.actualBoundingBoxAscent,h=t+2;"0"==F?h=t+D/2-r/2:"2"==F&&(h=t+D-2-r);let u=B>s?B:s,b=l+u-2;f.textBaseline="bottom";let v=b-13*y.zoomRatio;"0"==L?(b=l+u/2,f.textBaseline="middle",v=b-6*y.zoomRatio):"1"==L&&(b=l+2,f.textBaseline="top",v=b+1*y.zoomRatio),h/=y.zoomRatio,b/=y.zoomRatio,v/=y.zoomRatio,f.lineWidth=1,f.strokeStyle="#000",f.strokeRect(h,v,10,10),Y[e+"_"+o].checked&&(f.beginPath(),f.lineTo(h+1,v+6),f.lineTo(h+4,v+9),f.lineTo(h+9,v+2),f.stroke(),f.closePath()),f.fillStyle=i.checkstatus(y.flowdata,e,o,"fc"),f.fillText(null==d?"":d,h+14,b),f.restore()}else{if(null!=M&&null!=M.dataBar){let e=c+m+2,t=a+g+2,l=D-4,o=B-4,i=M.dataBar.valueType,n=M.dataBar.valueLen,r=M.dataBar.format;if("minus"==i){let i=M.dataBar.minusLen;if(r.length>1){let o=f.createLinearGradient(e+l*i*(1-n),t,e+l*i,t);o.addColorStop(0,"#ffffff"),o.addColorStop(1,"#ff0000"),f.fillStyle=o}else f.fillStyle="#ff0000";f.fillRect(e+l*i*(1-n),t,l*i*n,o),f.beginPath(),f.moveTo(e+l*i*(1-n),t),f.lineTo(e+l*i*(1-n),t+o),f.lineTo(e+l*i,t+o),f.lineTo(e+l*i,t),f.lineTo(e+l*i*(1-n),t),f.lineWidth=1,f.strokeStyle="#ff0000",f.stroke(),f.closePath()}else if("plus"==i){let i=M.dataBar.plusLen;if(1==i){if(r.length>1){let o=f.createLinearGradient(e,t,e+l*n,t);o.addColorStop(0,r[0]),o.addColorStop(1,r[1]),f.fillStyle=o}else f.fillStyle=r[0];f.fillRect(e,t,l*n,o),f.beginPath(),f.moveTo(e,t),f.lineTo(e,t+o),f.lineTo(e+l*n,t+o),f.lineTo(e+l*n,t),f.lineTo(e,t),f.lineWidth=1,f.strokeStyle=r[0],f.stroke(),f.closePath()}else{let a=M.dataBar.minusLen;if(r.length>1){let o=f.createLinearGradient(e+l*a,t,e+l*a+l*i*n,t);o.addColorStop(0,r[0]),o.addColorStop(1,r[1]),f.fillStyle=o}else f.fillStyle=r[0];f.fillRect(e+l*a,t,l*i*n,o),f.beginPath(),f.moveTo(e+l*a,t),f.lineTo(e+l*a,t+o),f.lineTo(e+l*a+l*i*n,t+o),f.lineTo(e+l*a+l*i*n,t),f.lineTo(e+l*a,t),f.lineWidth=1,f.strokeStyle=r[0],f.stroke(),f.closePath()}}}let t=c+m,l=a+g+1;f.save(),f.beginPath(),f.rect(t,l,D,B),f.clip(),f.scale(y.zoomRatio,y.zoomRatio);let n=P(W,f,{cellWidth:D,cellHeight:B,space_width:2,space_height:2,r:e,c:o});if(null!=M&&null!=M.icons&&"plain"==n.type){let e=M.icons.left,o=M.icons.top,i=n.values[0],a=t+i.left,c=l+i.top-n.textHeightAll;"0"==L?c=l+B/2-n.textHeightAll/2:"1"==L?c=l:"2"==L&&(c-=n.desc),c/=y.zoomRatio,a/=y.zoomRatio,f.drawImage(w,42*e,32*o,32,32,t/y.zoomRatio,c,n.textHeightAll/y.zoomRatio,n.textHeightAll/y.zoomRatio),"0"!=F&&"2"!=F&&(a+=n.textHeightAll/y.zoomRatio)}f.fillStyle=i.checkstatus(y.flowdata,e,o,"fc"),null!=I&&null!=I[0]&&(f.fillStyle=I[0]),null!=M&&null!=M.textColor&&(f.fillStyle=M.textColor),W.ct&&W.ct.fa&&W.ct.fa.indexOf("[Red]")>-1&&"n"==W.ct.t&&W.v<0&&(f.fillStyle="#ff0000"),G(n,f,{pos_x:t,pos_y:l}),f.restore()}q&&(y.luckysheetcurrentisPivotTable||O||!y.showGridLines||(f.beginPath(),f.moveTo(s+m-2+C,a+g),f.lineTo(s+m-2+C,r+g),f.lineWidth=1,f.strokeStyle=T.strokeStyle,f.stroke(),f.closePath())),y.luckysheetcurrentisPivotTable||O||!y.showGridLines||(f.beginPath(),f.moveTo(c+m-1,r+g-2+C),f.lineTo(s+m-1,r+g-2+C),f.lineWidth=1,f.strokeStyle=T.strokeStyle,f.stroke(),f.closePath()),b.createHookFunction("cellRenderAfter",y.flowdata[e][o],{r:e,c:o,start_r:X[1],start_c:X[0],end_r:X[3]+X[1],end_c:X[2]+X[0]},y.getSheetByIndex(),f)},A=function(e,o,n,a,c,r,s,d,f,h,u){let m;m=0==e?-r-1:y.visibledatarow[e-1]-r-1;let g,b=y.visibledatarow[e]-r;g=0==n?-s:y.visibledatacolumn[n-1]-s;let v=y.visibledatacolumn[a]-s,T=y.flowdata[e][o],w=v-g-2,k=b-m-2,x=g+d,R=m+f+1,S=B(T);c.font=S,c.save(),c.beginPath(),c.rect(x,R,w,k),c.clip(),c.scale(y.zoomRatio,y.zoomRatio);let _=P(T,c,{cellWidth:w,cellHeight:k,space_width:2,space_height:2,r:e,c:o}),p=l.checksAF(e,o,h),H=t.checksCF(e,o,u);c.fillStyle=i.checkstatus(y.flowdata,e,o,"fc"),null!=p&&null!=p[0]&&(c.fillStyle=p[0]),null!=H&&null!=H.textColor&&(c.fillStyle=H.textColor),G(_,c,{pos_x:x,pos_y:R}),c.restore()};function O(e,t,l,o,i,n){let a=y.flowdata;if("forward"==o&&l<0)return{success:!1,r:e,c:l};if("backward"==o&&l>a[e].length-1)return{success:!1,r:e,c:l};let c=a[e][l];if(null!=c&&(!S(c.v)||null!=c.mc))return{success:!1,r:e,c:l};let r=t-1<0?0:y.visibledatacolumn[t-1],s=y.visibledatacolumn[t],d=n-(s-r);"0"==i?(r-=d/2,s+=d/2):"1"==i?s+=d:"2"==i&&(r-=d);let f=l-1<0?0:y.visibledatacolumn[l-1],h=y.visibledatacolumn[l];return"forward"==o?r<f?O(e,t,l-1,o,i,n):r<h?{success:!0,r:e,c:l}:{success:!1,r:e,c:l}:"backward"==o?s>h?O(e,t,l+1,o,i,n):s>f?{success:!0,r:e,c:l}:{success:!1,r:e,c:l}:void 0}function j(e,t,l,o,i){let n,a,c,r,s=!1,d=!1;for(let o in e){for(let f in e[o]){n=o,a=f;let h=e[o][f];if(c=h.stc,r=h.edc,n==t&&l>=c&&l<=r&&(s=!0,l==r||l==i)){d=!0;break}}if(d)break}return{colIn:s,colLast:d,rowIndex:n,colIndex:a,stc:c,edc:r}}function G(e,t,l){if(null==e)return;let o=e.values,i=l.pos_x,n=l.pos_y;if(null!=o){0!=e.rotate&&"verticalWrap"!=e.type&&(t.save(),t.translate((i+e.textLeftAll)/y.zoomRatio,(n+e.textTopAll)/y.zoomRatio),t.rotate(-e.rotate*Math.PI/180),t.translate(-(e.textLeftAll+i)/y.zoomRatio,-(n+e.textTopAll)/y.zoomRatio));for(let e=0;e<o.length;e++){let l=o[e];!0===l.inline&&null!=l.style?(t.font=l.style.fontset,t.fillStyle=l.style.fc):t.font=l.style;let a="object"==typeof l.content?l.content.m:l.content;if(t.fillText(a,(i+l.left)/y.zoomRatio,(n+l.top)/y.zoomRatio),null!=l.cancelLine){let e=l.cancelLine;t.beginPath(),t.moveTo(Math.floor((i+e.startX)/y.zoomRatio)+.5,Math.floor((n+e.startY)/y.zoomRatio)+.5),t.lineTo(Math.floor((i+e.endX)/y.zoomRatio)+.5,Math.floor((n+e.endY)/y.zoomRatio)+.5),t.lineWidth=Math.floor(e.fs/9),t.strokeStyle=t.fillStyle,t.stroke(),t.closePath()}if(null!=l.underLine){let e=l.underLine;for(let l=0;l<e.length;l++){let o=e[l];t.beginPath(),t.moveTo(Math.floor((i+o.startX)/y.zoomRatio)+.5,Math.floor((n+o.startY)/y.zoomRatio)),t.lineTo(Math.floor((i+o.endX)/y.zoomRatio)+.5,Math.floor((n+o.endY)/y.zoomRatio)+.5),t.lineWidth=Math.floor(o.fs/9),t.strokeStyle=t.fillStyle,t.stroke(),t.closePath()}}}0!=e.rotate&&"verticalWrap"!=e.type&&t.restore()}}function X(e,t,l,o,i,n,a){t={0:"none",1:"Thin",2:"Hair",3:"Dotted",4:"Dashed",5:"DashDot",6:"DashDotDot",7:"Double",8:"Medium",9:"MediumDashed",10:"MediumDashDot",11:"MediumDashDotDot",12:"SlantedDashDot",13:"Thick"}[t.toString()];try{"Hair"==t?e.setLineDash([1,2]):t.indexOf("DashDotDot")>-1?e.setLineDash([2,2,5,2,2]):t.indexOf("DashDot")>-1?e.setLineDash([2,5,2]):t.indexOf("Dotted")>-1?e.setLineDash([2]):t.indexOf("Dashed")>-1?e.setLineDash([3]):e.setLineDash([0])}catch(e){console.log(e)}e.beginPath(),t.indexOf("Medium")>-1?("h"==l?(e.moveTo(o,i-.5),e.lineTo(n,a-.5)):(e.moveTo(o-.5,i),e.lineTo(n-.5,a)),e.lineWidth=2):"Thick"==t?(e.moveTo(o,i),e.lineTo(n,a),e.lineWidth=3):(e.moveTo(o,i),e.lineTo(n,a),e.lineWidth=1)}return{setLineDash:X,luckysheetDrawgridRowTitle:function(e,t,l){null==e&&(e=$("#luckysheet-cell-main").scrollTop()),null==t&&(t=y.luckysheetTableContentHW[1]),null==l&&(l=y.columnHeaderHeight);let o,i,n,a,c,r=$("#luckysheetTableContent").get(0).getContext("2d");r.save(),r.scale(y.devicePixelRatio,y.devicePixelRatio),r.clearRect(0,l,y.rowHeaderWidth-1,t),r.font=k(),r.textBaseline=T.textBaseline,r.fillStyle=T.fillStyle,o=x(y.visibledatarow,e),i=x(y.visibledatarow,e+t),-1==o&&(o=0),-1==i&&(i=y.visibledatarow.length-1),r.save(),r.beginPath(),r.rect(0,l-1,y.rowHeaderWidth-1,t-2),r.clip();for(let t=o;t<=i;t++){a=0==t?-e-1:y.visibledatarow[t-1]-e-1,n=y.visibledatarow[t]-e;let s=o==t?-2:0,d=i==t?-2:0;if(b.createHookFunction("rowTitleCellRenderBefore",t+1,{r:t,top:a+l+s,width:y.rowHeaderWidth-1,height:n-a+1+d-s},r)){if(null!=y.config.rowhidden&&null!=y.config.rowhidden[t]);else{r.fillStyle="#ffffff",r.fillRect(0,a+l+s,y.rowHeaderWidth-1,n-a+1+d-s),r.fillStyle="#000000",r.save(),r.scale(y.zoomRatio,y.zoomRatio);let e=p(t+1,r),o=(y.rowHeaderWidth-e.width)/2,i=a+(n-a)/2+l;r.fillText(t+1,o/y.zoomRatio,i/y.zoomRatio),r.restore()}r.beginPath(),r.moveTo(y.rowHeaderWidth-2+.5,a+l-2),r.lineTo(y.rowHeaderWidth-2+.5,n+l-2),r.lineWidth=1,r.strokeStyle=T.strokeStyle,r.stroke(),r.closePath(),null!=y.config.rowhidden&&null==y.config.rowhidden[t]&&null!=y.config.rowhidden[t+1]?(r.beginPath(),r.moveTo(-1,n+l-4+.5),r.lineTo(y.rowHeaderWidth-1,n+l-4+.5),r.closePath(),r.stroke()):null!=y.config.rowhidden&&null!=y.config.rowhidden[t]||(r.beginPath(),r.moveTo(-1,n+l-2+.5),r.lineTo(y.rowHeaderWidth-1,n+l-2+.5),r.closePath(),r.stroke()),null!=y.config.rowhidden&&null!=y.config.rowhidden[t-1]&&null!=c&&(r.beginPath(),r.moveTo(-1,c+l+.5),r.lineTo(y.rowHeaderWidth-1,c+l+.5),r.closePath(),r.stroke()),c=n,b.createHookFunction("rowTitleCellRenderAfter",t+1,{r:t,top:a+l+s,width:y.rowHeaderWidth-1,height:n-a+1+d-s},r)}}r.restore(),r.restore()},luckysheetDrawgridColumnTitle:function(e,t,l){null==e&&(e=$("#luckysheet-cell-main").scrollLeft()),null==t&&(t=y.luckysheetTableContentHW[0]),null==l&&(l=y.rowHeaderWidth);let o,i,n,a,c,r=$("#luckysheetTableContent").get(0).getContext("2d");r.save(),r.scale(y.devicePixelRatio,y.devicePixelRatio),r.clearRect(l,0,t,y.columnHeaderHeight-1),r.font=k(),r.textBaseline=T.textBaseline,r.fillStyle=T.fillStyle,o=x(y.visibledatacolumn,e),i=x(y.visibledatacolumn,e+t),-1==o&&(o=0),-1==i&&(i=y.visibledatacolumn.length-1),r.save(),r.beginPath(),r.rect(l-1,0,t,y.columnHeaderHeight-1),r.clip();for(let t=o;t<=i;t++){a=0==t?-e:y.visibledatacolumn[t-1]-e,n=y.visibledatacolumn[t]-e;let o=D(t);if(b.createHookFunction("columnTitleCellRenderBefore",o,{c:t,left:a+l-1,width:n-a,height:y.columnHeaderHeight-1},r)){if(null!=y.config.colhidden&&null!=y.config.colhidden[t]);else{r.fillStyle="#ffffff",r.fillRect(a+l-1,0,n-a,y.columnHeaderHeight-1),r.fillStyle="#000000",r.save(),r.scale(y.zoomRatio,y.zoomRatio);let e=p(o,r),t=Math.round(a+(n-a)/2+l-e.width/2),i=Math.round(y.columnHeaderHeight/2);r.fillText(o,t/y.zoomRatio,i/y.zoomRatio),r.restore()}null!=y.config.colhidden&&null==y.config.colhidden[t]&&null!=y.config.colhidden[t+1]?(r.beginPath(),r.moveTo(n+l-4+.5,0),r.lineTo(n+l-4+.5,y.columnHeaderHeight-2),r.lineWidth=1,r.strokeStyle=T.strokeStyle,r.closePath(),r.stroke()):null!=y.config.colhidden&&null!=y.config.colhidden[t]||(r.beginPath(),r.moveTo(n+l-2+.5,0),r.lineTo(n+l-2+.5,y.columnHeaderHeight-2),r.lineWidth=1,r.strokeStyle=T.strokeStyle,r.closePath(),r.stroke()),null!=y.config.colhidden&&null!=y.config.colhidden[t-1]&&null!=c&&(r.beginPath(),r.moveTo(c+l+.5,0),r.lineTo(c+l+.5,y.columnHeaderHeight-2),r.closePath(),r.stroke()),r.beginPath(),r.moveTo(a+l-1,y.columnHeaderHeight-2+.5),r.lineTo(n+l-1,y.columnHeaderHeight-2+.5),r.stroke(),r.closePath(),c=n,b.createHookFunction("columnTitleCellRenderAfter",o,{c:t,left:a+l-1,width:n-a,height:y.columnHeaderHeight-1},r)}}r.restore(),r.restore()},luckysheetDrawMain:function(o,n,a,c,r,s,d,f,h){if(null==y.flowdata)return;let u=y.getSheetByIndex();clearTimeout(y.measureTextCacheTimeOut),null==o&&(o=$("#luckysheet-cell-main").scrollLeft()),null==n&&(n=$("#luckysheet-cell-main").scrollTop()),null==a&&(a=y.luckysheetTableContentHW[0]),null==c&&(c=y.luckysheetTableContentHW[1]),null==r&&(r=y.rowHeaderWidth),null==s&&(s=y.columnHeaderHeight),null==d&&(d=0),null==f&&(f=0);let m,g,w,_,p,D,B,A,G=null;if(null==h)G=$("#luckysheetTableContent").get(0).getContext("2d");else if("object"==W(h))try{G=h.get(0).getContext("2d")}catch(e){G=h}else G=$("#"+h).get(0).getContext("2d");G.save(),G.scale(y.devicePixelRatio,y.devicePixelRatio),G.clearRect(0,0,y.luckysheetTableContentHW[0],y.luckysheetTableContentHW[1]),m=x(y.visibledatarow,n),g=x(y.visibledatarow,n+c),-1==m&&(m=0),m+=f,-1==g&&(g=y.visibledatarow.length-1),(g+=f)>=y.visibledatarow.length&&(g=y.visibledatarow.length-1),w=x(y.visibledatacolumn,o),_=x(y.visibledatacolumn,o+a),-1==w&&(w=0),w+=d,-1==_&&(_=y.visibledatacolumn.length-1),(_+=d)>=y.visibledatacolumn.length&&(_=y.visibledatacolumn.length-1),p=0==m?0:y.visibledatarow[m-1],D=y.visibledatarow[g],B=0==w?0:y.visibledatacolumn[w-1],A=y.visibledatacolumn[_],G.fillStyle="#ffffff",G.fillRect(r-1,s-1,A-o,D-n),G.font=k(),G.fillStyle=T.fillStyle;let Y=[],q={},V={};b.createHookFunction("cellAllRenderBefore",y.flowdata,u,G);for(let e=m;e<=g;e++){let t;t=0==e?-n-1:y.visibledatarow[e-1]-n-1;let l=y.visibledatarow[e]-n;if(null==y.config.rowhidden||null==y.config.rowhidden[e])for(let i=w;i<=_;i++){let n;n=0==i?-o:y.visibledatacolumn[i-1]-o;let a=y.visibledatacolumn[i]-o;if(null!=y.config.colhidden&&null!=y.config.colhidden[i])continue;let c=y.defaultcollen;if(null!=y.config.columnlen&&null!=y.config.columnlen[i]&&(c=y.config.columnlen[i]),null!=y.flowdata[e]&&null!=y.flowdata[e][i]){let o=y.flowdata[e][i];if("object"==W(o)&&"mc"in o){if(V[e+"_"+i]={start_r:t,start_c:n,end_r:l,end_c:a},!("rs"in o.mc)){let r="r"+o.mc.r+"c"+o.mc.c,s=Y[q[r]];null==s?(q[r]=Y.length,Y.push({r:e,c:i,start_c:n,start_r:t,end_r:l,end_c:a,firstcolumnlen:c})):(s.c==i&&(s.end_r+=l-t-1),s.r==e&&(s.end_c+=a-n,s.firstcolumnlen+=c));continue}q["r"+e+"c"+i]=Y.length}}Y.push({r:e,c:i,start_r:t,start_c:n,end_r:l,end_c:a,firstcolumnlen:c}),V[e+"_"+i]={start_r:t,start_c:n,end_r:l,end_c:a}}}let N=R(y.luckysheetfile[z(y.currentSheetIndex)].dynamicArray),E=l.getComputeMap(),J=t.getComputeMap(),K=function(e,t,l,o,n){let a={},c=y.flowdata;for(let r=o;r<=n;r++){if(null==c[r])continue;if(null!=y.cellOverflowMapCache[r]){a[r]=y.cellOverflowMapCache[r];continue}let o=!1;for(let n=0;n<c[r].length;n++){let s=c[r][n];if((null==y.config.colhidden||null==y.config.colhidden[n])&&null!=s&&(!S(s.v)||F(s))&&null==s.mc&&"1"==s.tb){let d=i.checkstatus(c,r,n,"ht"),f=P(s,e,{r:r,c:n}),h=0;null!=f&&(h=f.textWidthAll);let u,m,g=n-1<0?0:y.visibledatacolumn[n-1],b=y.visibledatacolumn[n];if(b-g<h){if("0"==d){let e=O(r,n,n-1,"forward",d,h),t=O(r,n,n+1,"backward",d,h);u=e.success?e.c:e.c+1,m=t.success?t.c:t.c-1}else if("1"==d){let e=O(r,n,n+1,"backward",d,h);u=n,m=e.success?e.c:e.c-1}else if("2"==d){let e=O(r,n,n-1,"forward",d,h);m=n,u=e.success?e.c:e.c+1}}else u=n,m=n;if((u<=l||m>=t)&&u<m){let e={r:r,stc:u,edc:m};null==a[r]&&(a[r]={}),a[r][n]=e,o=!0}}}o&&(y.cellOverflowMapCache[r]=a[r])}return a}(G,w,_,m,g),Q=[];for(let e=0;e<Y.length;e++){let t=Y[e],l=t.r,a=t.c,c=t.start_r,d=t.start_c,f=t.end_r,h=t.end_c;if(t.firstcolumnlen,null!=y.flowdata[l])if(null==y.flowdata[l][a])I(l,a,c,d,f,h,G,E,J,r,s,N,K,w,_,n,o,.5);else{let t=y.flowdata[l][a],u=null;if("object"==typeof t&&"mc"in t?Q.push(Y[e]):u=H(l,a),null==u||0==u.toString().length){I(l,a,c,d,f,h,G,E,J,r,s,N,K,w,_,n,o,.5);let e=i.borderfix(y.flowdata,l,a),t=[d+r+e[0],c+s+e[1],h-d-3+e[2],f-c-3-1+e[3]];L(l,a,t[0],t[1],"luckysheetTableContent",G)}else l+"_"+a in N&&(u=N[l+"_"+a].v),M(l,a,c,d,f,h,u,G,E,J,r,s,N,K,w,_,n,o,.5)}}for(let e=0;e<Q.length;e++){let t=Q[e],l=t.r,a=t.c,c=t.start_r,d=t.start_c,f=t.end_r-1,h=t.end_c-1,u=(t.firstcolumnlen,null),m=y.flowdata[l][a].mc;u=H(m.r,m.c),l=m.r,a=m.c;let g=y.flowdata[l][a];if(d=0==a?-o:y.visibledatacolumn[a-1]-o,c=0==l?-n-1:y.visibledatarow[l-1]-n-1,f=y.visibledatarow[l+g.mc.rs-1]-n,h=y.visibledatacolumn[a+g.mc.cs-1]-o,null==u||0==u.toString().length){I(l,a,c,d,f,h,G,E,J,r,s,N,K,w,_,n,o,.5,!0);let e=i.borderfix(y.flowdata,l,a),t=[d+r+e[0],c+s+e[1],h-d-3+e[2],f-c-3-1+e[3]];L(l,a,t[0],t[1],"luckysheetTableContent",G)}else l+"_"+a in N&&(u=N[l+"_"+a].v),M(l,a,c,d,f,h,u,G,E,J,r,s,N,K,w,_,n,o,.5,!0)}for(let t=m;t<=g;t++){let l;l=0==t?-n-1:y.visibledatarow[t-1]-n-1;let i=y.visibledatarow[t]-n;for(let n=w;n<=_;n++){let a;a=0==n?-o:y.visibledatacolumn[n-1]-o;let c=y.visibledatacolumn[n]-o;y.luckysheetcurrentisPivotTable&&e.drawPivotTable?((0==n||5==n)&&t<=11&&(G.beginPath(),G.moveTo(c-2+.5+r,l+s),G.lineTo(c-2+.5+r,i-2+.5+s),G.lineWidth=1,G.strokeStyle="#000000",G.closePath(),G.stroke()),(2==t||11==t)&&n<=5&&(G.beginPath(),G.moveTo(a-1+r,i-2+.5+s),G.lineTo(c-2+.5+r,i-2+.5+s),G.lineWidth=1,G.strokeStyle="#000000",G.closePath(),G.stroke()),6==t&&3==n&&(G.save(),G.font="bold 30px Arial",G.fillStyle="#626675",G.textAlign="center",G.fillText(v().pivotTable.title,a+(c-a)/2+4+r,l+(i-l)/2-1+s),G.restore())):y.luckysheetcurrentisPivotTable&&n<e.pivotTableBoundary[1]&&t<e.pivotTableBoundary[0]&&(G.beginPath(),G.moveTo(c-2+.5+r,l+s),G.lineTo(c-2+.5+r,i-2+.5+s),G.lineWidth=1,G.strokeStyle="#000000",G.closePath(),G.stroke(),G.beginPath(),G.moveTo(a-1+r,i-2+.5+s),G.lineTo(c-2+r,i-2+.5+s),G.lineWidth=1,G.strokeStyle="#000000",G.closePath(),G.stroke())}}if(null!=y.config.borderInfo&&y.config.borderInfo.length>0){let e=function(e,t,l,o,i,n,a,c,r){let s=e,d=o-2+.5+a,f=l+c-1,h=o-2+.5+a,u=i-2+.5+c;r.save(),X(r,s,"v",d,f,h,u),r.strokeStyle=t,r.stroke(),r.closePath(),r.restore()},t=function(e,t,l,o,i,n,a,c,r){let s=e,d=n-2+.5+a,f=l+c-1,h=n-2+.5+a,u=i-2+.5+c;r.save(),X(r,s,"v",d,f,h,u),r.strokeStyle=t,r.stroke(),r.closePath(),r.restore()},l=function(e,t,l,o,i,n,a,c,r){let s=e,d=o-2+.5+a,f=i-2+.5+c,h=n-2+.5+a,u=i-2+.5+c;r.save(),X(r,s,"h",d,f,h,u),r.strokeStyle=t,r.stroke(),r.closePath(),r.restore()},o=function(e,t,l,o,i,n,a,c,r){let s=e,d=o-2+.5+a,f=l-1+.5+c,h=n-2+.5+a,u=l-1+.5+c;r.save(),X(r,s,"h",d,f,h,u),r.strokeStyle=t,r.stroke(),r.closePath(),r.restore()},i=C(m,g,w,_);for(let n in i){let a=n.substr(0,n.indexOf("_")),c=n.substr(n.indexOf("_")+1);if(V[a+"_"+c]){let d=V[a+"_"+c].start_r,f=V[a+"_"+c].start_c,h=V[a+"_"+c].end_r,u=V[a+"_"+c].end_c,m=j(K,a,c,0,_),g=i[n].l;null==g||m.colIn&&m.stc!=c||e(g.style,g.color,d,f,h,u,r,s,G);let b=i[n].r;null==b||m.colIn&&!m.colLast||t(b.style,b.color,d,f,h,u,r,s,G);let y=i[n].t;null!=y&&o(y.style,y.color,d,f,h,u,r,s,G);let v=i[n].b;null!=v&&l(v.style,v.color,d,f,h,u,r,s,G)}}}_==y.visibledatacolumn.length-1&&G.clearRect(A-o+r-1,s-1,y.ch_width-y.visibledatacolumn[_],D-n),G.restore(),y.measureTextCacheTimeOut=setTimeout(()=>{y.measureTextCache={},y.measureTextCellInfoCache={},y.cellOverflowMapCache={}},100)}}});
//# sourceMappingURL=../sourcemaps/widgets/draw.js.map
