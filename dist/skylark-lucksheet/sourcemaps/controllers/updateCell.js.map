{"version":3,"sources":["controllers/updateCell.js"],"names":["define","pivotTable","cells","conditionformat","alternateformat","cellDatePickerCtrl","dataVerificationCtrl","m_protection","m_util","luckysheetConfigsetting","m_getdata","m_format","formula","m_cursorPos","cleargridelement","Store","checkProtectionLocked","checkProtectionCellHidden","chatatABC","isEditMode","getcellvalue","getInlineStringStyle","valueShowEs","luckysheetRangeLast","isInlineStringCell","getColumnAndRowSize","row_index","col_index","d","row","visibledatarow","row_pre","col","visibledatacolumn","col_pre","flowdata","margeset","mergeborer","column","luckysheetupdateCell","row_index1","col_index1","cover","isnotfocus","currentSheetIndex","$","blur","allowEdit","createHookFunction","luckysheet_select_save","saveParam","op","range","dataVerification","dataVerificationItem","type","dropdownListShow","size","is","remove","winH","window","height","winW","width","container_offset","container","offset","scrollLeft","scrollTop","isPivotRange","left","rowHeaderWidth","freezenverticaldata","top","infobarHeight","toolbarHeight","calculatebarHeight","columnHeaderHeight","freezenhorizontaldata","input_postition","min-width","min-height","max-width","max-height","sheetBarHeight","statisticBarHeight","inputContentScale","transform","zoomRatio","transform-origin","luckysheetCellUpdate","focus","select","removeAttr","css","background-color","padding","font-size","right","overflow-y","box-sizing","display","html","hide","addClass","value","isCenter","cell","htValue","leftOrigin","topOrigin","f","qp","style","getStyleByCell","get","cssText","backgroundColor","background","af_compute","getComputeMap","checksAF","cf_compute","checksCF","toString","length","substr","newLeft","ct","t","cellFocus","rangetosheet","createRangeHightlight","rangeResizeTo","setCenterInputPosition"],"mappings":"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","file":"../../controllers/updateCell.js","sourcesContent":["define([\n    '../methods/pivotTable_methods',\n    '../methods/cells',\n    '../methods/conditionformat_methods',\n    '../methods/alternateformat_methods',\n    '../widgets/cellDatePickerCtrl',\n    '../widgets/dataVerificationCtrl',\n    '../methods/protection_methods',\n    '../utils/util',\n    '../methods/luckysheetConfigsetting',\n    '../methods/getdata',\n    '../methods/format',\n    '../methods/formula_methods',\n    '../widgets/cursorPos',\n    '../widgets/cleargridelement',\n    '../store'\n], function (pivotTable, cells, conditionformat, alternateformat, cellDatePickerCtrl, dataVerificationCtrl, m_protection, m_util, luckysheetConfigsetting, m_getdata, m_format, formula, m_cursorPos, cleargridelement, Store) {\n    'use strict';\n    const {checkProtectionLocked, checkProtectionCellHidden} = m_protection;\n    const {chatatABC} = m_util;\n    const {isEditMode} = luckysheetConfigsetting;\n    const {getcellvalue, getInlineStringStyle} = m_getdata;\n    const {valueShowEs} = m_format;\n    const {luckysheetRangeLast} = m_cursorPos;\n    const {isInlineStringCell} = cells;\n    function luckysheetupdateCell(row_index1, col_index1, d, cover, isnotfocus) {\n        if (!checkProtectionLocked(row_index1, col_index1, Store.currentSheetIndex)) {\n            $('#luckysheet-functionbox-cell').blur();\n            return;\n        }\n        if (isEditMode() || Store.allowEdit === false) {\n            //此模式下禁用单元格编辑\n            return;\n        }    // 钩子函数\n        // 钩子函数\n        luckysheetConfigsetting.createHookFunction('cellEditBefore', Store.luckysheet_select_save);    // 编辑单元格时发送指令到后台，通知其他单元格更新为“正在输入”状态\n        // 编辑单元格时发送指令到后台，通知其他单元格更新为“正在输入”状态\n        Store.saveParam('mv', Store.currentSheetIndex, {\n            op: 'enterEdit',\n            range: Store.luckysheet_select_save\n        });    //数据验证\n        //数据验证\n        if (Store.dataVerification != null && Store.dataVerification[row_index1 + '_' + col_index1] != null) {\n            let dataVerificationItem = Store.dataVerification[row_index1 + '_' + col_index1];\n            if (dataVerificationItem.type == 'dropdown') {\n                dataVerificationCtrl.dropdownListShow();\n            } else if (dataVerificationItem.type == 'checkbox') {\n                return;\n            }\n        }\n        let size = getColumnAndRowSize(row_index1, col_index1, d);\n        let row = size.row, row_pre = size.row_pre, col = size.col, col_pre = size.col_pre, row_index = size.row_index, col_index = size.col_index;\n        if ($('#luckysheet-dropCell-icon').is(':visible')) {\n            $('#luckysheet-dropCell-icon').remove();\n        }\n        let winH = $(window).height(), winW = $(window).width();\n        let container_offset = $('#' + Store.container).offset();\n        let scrollLeft = $('#luckysheet-cell-main').scrollLeft();\n        let scrollTop = $('#luckysheet-cell-main').scrollTop();\n        if (pivotTable.isPivotRange(row_index, col_index)) {\n            return;\n        }\n        let left = col_pre + container_offset.left + Store.rowHeaderWidth - scrollLeft - 2;\n        if (Store.freezenverticaldata != null && col_index1 <= Store.freezenverticaldata[1]) {\n            left = col_pre + container_offset.left + Store.rowHeaderWidth - 2;\n        }\n        let top = row_pre + container_offset.top + Store.infobarHeight + Store.toolbarHeight + Store.calculatebarHeight + Store.columnHeaderHeight - scrollTop - 2;\n        if (Store.freezenhorizontaldata != null && row_index1 <= Store.freezenhorizontaldata[1]) {\n            top = row_pre + container_offset.top + Store.infobarHeight + Store.toolbarHeight + Store.calculatebarHeight + Store.columnHeaderHeight - 2;\n        }\n        let input_postition = {\n            'min-width': col - col_pre + 1 - 8,\n            'min-height': row - row_pre + 1 - 4,\n            'max-width': winW + scrollLeft - col_pre - 20 - Store.rowHeaderWidth,\n            'max-height': winH + scrollTop - row_pre - 20 - 15 - Store.toolbarHeight - Store.infobarHeight - Store.calculatebarHeight - Store.sheetBarHeight - Store.statisticBarHeight,\n            'left': left,\n            'top': top\n        };\n        let inputContentScale = {\n            'transform': 'scale(' + Store.zoomRatio + ')',\n            'transform-origin': 'left top',\n            'width': 100 / Store.zoomRatio + '%',\n            'height': 100 / Store.zoomRatio + '%'\n        };\n        Store.luckysheetCellUpdate = [\n            row_index,\n            col_index\n        ];\n        if (!isnotfocus) {\n            $('#luckysheet-rich-text-editor').focus().select();\n        }\n        $('#luckysheet-input-box').removeAttr('style').css({\n            'background-color': 'rgb(255, 255, 255)',\n            'padding': '0px 2px',\n            'font-size': '13px',\n            'right': 'auto',\n            'overflow-y': 'auto',\n            'box-sizing': 'initial',\n            'display': 'flex'\n        });\n        if (Store.freezenverticaldata != null || Store.freezenhorizontaldata != null) {\n            $('#luckysheet-input-box').css('z-index', 10002);\n        }\n        $('#luckysheet-input-box-index').html(chatatABC(col_index) + (row_index + 1)).hide();\n        $('#luckysheet-wa-functionbox-cancel, #luckysheet-wa-functionbox-confirm').addClass('luckysheet-wa-calculate-active');\n        let value = '', isCenter = false;\n        if (d[row_index] != null && d[row_index][col_index] != null) {\n            let cell = d[row_index][col_index];\n            let htValue = cell['ht'];\n            let leftOrigin = 'left', topOrigin = 'top';\n            if (htValue == '0') {\n                //0 center, 1 left, 2 right\n                input_postition = {\n                    'min-width': col - col_pre + 1 - 8,\n                    'min-height': row - row_pre + 1 - 4,\n                    // \"transform\":\"scale(\"+ Store.zoomRatio +\")\",\n                    // \"transform-origin\":\"center top\",\n                    'max-width': winW * 2 / 3,\n                    'max-height': winH + scrollTop - row_pre - 20 - 15 - Store.toolbarHeight - Store.infobarHeight - Store.calculatebarHeight - Store.sheetBarHeight - Store.statisticBarHeight,\n                    'left': col_pre + container_offset.left + Store.rowHeaderWidth - scrollLeft - 2,\n                    'top': row_pre + container_offset.top + Store.infobarHeight + Store.toolbarHeight + Store.calculatebarHeight + Store.columnHeaderHeight - scrollTop - 2\n                };\n                if (Store.zoomRatio < 1) {\n                    leftOrigin = 'center';\n                }\n                isCenter = true;\n            } else if (htValue == '2') {\n                input_postition = {\n                    'min-width': col - col_pre + 1 - 8,\n                    'min-height': row - row_pre + 1 - 4,\n                    // \"transform\":\"scale(\"+ Store.zoomRatio +\")\",\n                    // \"transform-origin\":\"right top\",\n                    'max-width': col + container_offset.left - scrollLeft - 8,\n                    'max-height': winH + scrollTop - row_pre - 20 - 15 - Store.toolbarHeight - Store.infobarHeight - Store.calculatebarHeight - Store.sheetBarHeight - Store.statisticBarHeight,\n                    'right': winW - (container_offset.left + (Store.rowHeaderWidth - 1) - scrollLeft) - col,\n                    'top': row_pre + container_offset.top + Store.infobarHeight + Store.toolbarHeight + Store.calculatebarHeight + Store.columnHeaderHeight - scrollTop - 2\n                };\n                if (Store.zoomRatio < 1) {\n                    leftOrigin = 'right';\n                }\n            }\n            if (cell['vt'] == '0') {\n                topOrigin = 'center';\n            } else if (cell['vt'] == '2') {\n                topOrigin = 'bottom';\n            }\n            inputContentScale['transform-origin'] = leftOrigin + ' ' + topOrigin;\n            if (!cover) {\n                if (isInlineStringCell(cell)) {\n                    value = getInlineStringStyle(row_index, col_index, d);\n                } else if (cell.f != null) {\n                    value = getcellvalue(row_index, col_index, d, 'f');\n                } else {\n                    value = valueShowEs(row_index, col_index, d);\n                    if (cell.qp == '1') {\n                        value = \"'\" + value;\n                    }\n                }\n            }\n            let style = cells.getStyleByCell(d, row_index, col_index);\n            style = $('#luckysheet-input-box').get(0).style.cssText + style;\n            $('#luckysheet-input-box').get(0).style.cssText = style;\n            if ($('#luckysheet-input-box').get(0).style.backgroundColor == 'rgba(0, 0, 0, 0)') {\n                $('#luckysheet-input-box').get(0).style.background = 'rgb(255,255,255)';\n            }\n        } else {\n            //交替颜色\n            let af_compute = alternateformat.getComputeMap();\n            var checksAF = alternateformat.checksAF(row_index, col_index, af_compute);    //条件格式\n            //条件格式\n            var cf_compute = conditionformat.getComputeMap();\n            var checksCF = conditionformat.checksCF(row_index, col_index, cf_compute);\n            if (checksCF != null && checksCF['cellColor'] != null) {\n                $('#luckysheet-input-box').get(0).style.background = checksCF['cellColor'];\n            } else if (checksAF != null) {\n                $('#luckysheet-input-box').get(0).style.background = checksAF[1];\n            }\n        }\n        if (input_postition['min-height'] > input_postition['max-height']) {\n            input_postition['min-height'] = input_postition['max-height'];\n        }\n        if (input_postition['min-width'] > input_postition['max-width']) {\n            input_postition['min-width'] = input_postition['max-width'];\n        }\n        if ((value == null || value.toString() == '') && !cover) {\n            value = '<br/>';\n        }\n        if (!checkProtectionCellHidden(row_index, col_index, Store.currentSheetIndex) && value.length > 0 && value.substr(0, 63) == '<span dir=\"auto\" class=\"luckysheet-formula-text-color\">=</span>') {\n            $('#luckysheet-rich-text-editor').html('');\n        } else {\n            $('#luckysheet-rich-text-editor').html(value);\n            if (!isnotfocus) {\n                luckysheetRangeLast($('#luckysheet-rich-text-editor')[0]);\n            }\n        }\n        if (isCenter) {\n            let width = $('#luckysheet-input-box').width();\n            if (width > input_postition['max-width']) {\n                width = input_postition['max-width'];\n            }\n            if (width < input_postition['min-width']) {\n                width = input_postition['min-width'];\n            }\n            let newLeft = input_postition['left'] - width / 2 + (col - col_pre) / 2;\n            if (newLeft < 2) {\n                newLeft = 2;\n            }\n            input_postition['left'] = newLeft - 2;\n        }\n        $('#luckysheet-input-box').css(input_postition);\n        $('#luckysheet-rich-text-editor').css(inputContentScale);    //日期\n        //日期\n        if (d[row_index1][col_index1] && d[row_index1][col_index1].ct && d[row_index1][col_index1].ct.t == 'd') {\n            cellDatePickerCtrl.cellFocus(row_index1, col_index1, d[row_index1][col_index1]);\n        }\n        formula.rangetosheet = Store.currentSheetIndex;\n        formula.createRangeHightlight();\n        formula.rangeResizeTo = $('#luckysheet-rich-text-editor');\n        cleargridelement();\n    }\n    function setCenterInputPosition(row_index, col_index, d) {\n        if (row_index == null || col_index == null) {\n            return;\n        }\n        let cell = d[row_index][col_index];\n        if (cell == null) {\n            return;\n        }\n        let htValue = cell['ht'];\n        if (cell != null && htValue != '0') {\n            //0 center, 1 left, 2 right\n            return;\n        }\n        let size = getColumnAndRowSize(row_index, col_index, d);\n        let row = size.row, row_pre = size.row_pre, col = size.col, col_pre = size.col_pre;\n        let winH = $(window).height(), winW = $(window).width();\n        let container_offset = $('#' + Store.container).offset();\n        let scrollLeft = $('#luckysheet-cell-main').scrollLeft();\n        let scrollTop = $('#luckysheet-cell-main').scrollTop();\n        let input_postition = {\n            'min-width': col - col_pre + 1 - 8,\n            'max-width': winW * 2 / 3,\n            'left': col_pre + container_offset.left + Store.rowHeaderWidth - scrollLeft - 2\n        };\n        let width = $('#luckysheet-input-box').width();\n        if (width > input_postition['max-width']) {\n            width = input_postition['max-width'];\n        }\n        if (width < input_postition['min-width']) {\n            width = input_postition['min-width'];\n        }\n        let newLeft = input_postition['left'] - width / 2 + (col - col_pre) / 2;\n        if (newLeft < 2) {\n            newLeft = 2;\n        }\n        input_postition['left'] = newLeft - 2;\n        $('#luckysheet-input-box').css(input_postition);\n    }\n    function getColumnAndRowSize(row_index, col_index, d) {\n        let row = Store.visibledatarow[row_index], row_pre = row_index - 1 == -1 ? 0 : Store.visibledatarow[row_index - 1];\n        let col = Store.visibledatacolumn[col_index], col_pre = col_index - 1 == -1 ? 0 : Store.visibledatacolumn[col_index - 1];\n        if (d == null) {\n            d = Store.flowdata;\n        }\n        let margeset = cells.mergeborer(d, row_index, col_index);\n        if (!!margeset) {\n            row = margeset.row[1];\n            row_pre = margeset.row[0];\n            row_index = margeset.row[2];\n            col = margeset.column[1];\n            col_pre = margeset.column[0];\n            col_index = margeset.column[2];\n        }\n        return {\n            row: row,\n            row_pre: row_pre,\n            row_index: row_index,\n            col: col,\n            col_pre: col_pre,\n            col_index: col_index\n        };\n    }\n    return {\n        luckysheetupdateCell: luckysheetupdateCell,\n        setCenterInputPosition: setCenterInputPosition,\n        getColumnAndRowSize: getColumnAndRowSize\n    };\n});"]}