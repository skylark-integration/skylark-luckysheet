{"version":3,"sources":["controllers/server.js"],"names":["define","pako","m_loading","m_refresh","editor","m_constant","sheetmanage","menuButton","m_filter","luckysheetFreezen","luckysheetPostil","imageCtrl","dataVerificationCtrl","hyperlinkCtrl","m_util","m_get","Store","m_select","locale","dayjs","json","showloading","hideloading","luckysheetrefreshgrid","jfrefreshgrid_rhcw","sheetHTML","luckyColor","createFilterOptions","getObjType","replaceHtml","getByteLen","getSheetIndex","collaborativeEditBox","server","gridKey","loadUrl","updateUrl","updateImageUrl","title","loadSheetUrl","retryTimer","allowUpdate","historyParam","data","sheetIndex","range","_this","this","r1","row","r2","c1","column","c2","v","saveParam","r","c","rowlen","collen","timeR","Math","floor","n","ceil","i","edr","str","v_row","push","type","index","value","params","undefined","d","t","op","pos","rc","cid","cur","k","msg","gzip","encodeURIComponent","JSON","stringify","to","websocket","send","wxErrorCount","openWebSocket","window","wxUrl","indexOf","WebSocket","onopen","console","info","success","setInterval","onmessage","result","Function","message","id","$","hide","cooperativeEdit","changeCollaborationSize","filter","checkoutData","item","parse","wsUpdateMsg","chang_data","username","length","some","value1","forEach","val","currentSheetIndex","multipleRangeShow","change_bottom","offsetHeight","css","bottom","items","onerror","refresh","wait","onclose","e","close","code","clearInterval","alert","contact","support","file","luckysheetfile","includes","flowdata","webWorkerFlowDataCache","ps","buildPs","setTimeout","Object","keys","merge_range","key","config","find","html","currentSheetItem","remove","append","frozenTofreezen","locale_freezen","freezen","horizontal","freezenRow","freezenhorizontaldata","createFreezenHorizontal","top","vertical","freezenColumn","freezenverticaldata","createFreezenVertical","left","createAssistCanvas","filter_select","images","allImagesShow","init","dataVerification","hyperlink","calcChain","a","splice","st_i","len","mc","borderInfo","addcol","concat","x","merge","addData","direction","extend","arr","join","colorset","color","active","name","style","copyindex","copyarrindex","copyjson","copyobject","insertAfter","deleIndex","luckysheetcurrentSheetitem","removeClass","indicator","nextAll","eq","prevAll","addClass","changeSheetExec","sheetDeleSave","order","reIndex","datav","show","chart","luckysheet","insertChartTosheet","dataSheetIndex","option","chartType","selfOption","defaultOption","chart_selection_color","chart_id","chart_selection_id","chartStyle","rangeConfigCheck","rangeRowCheck","rangeColCheck","chartMarkConfig","chartTitleConfig","winWidth","winHeight","scrollLeft1","scrollTop1","chartTheme","myWidth","myHeight","myLeft","myTop","myindexrank1","chartjson","vitem","saveChart","delChart","attr","multipleIndex","visibledatarow","row_pre","col","visibledatacolumn","col_pre","margeset","mergeborer","edit","typing","position","width","height","text","usernameTimeout","clearTimeout","itemHtml","appendTo","submitInterval","imagesubmitInterval","submitdatalimit","submitcompresslimit","checksubmit","submitTimeout","imageRequestTimeout","imageRequest","requestTimeOut","requestLock","requestlast","clone","add","isBefore","request","firstchange","cachelocaldata","cahce_key","post","compress","status","format","clearcachelocaldata","restorecachelocaldata","imageRequestLast","imageRequestLock","html2canvas","container","get","onrendered","canvas","old","newwidth","newheight","imageData","getContext","getImageData","cutW","cutH","newCanvas","putImageData","drawImage","base64","toDataURL","curindex","getCurSheetnoset","data1","img","localdata","matchOpt","drc","arc","sha","shc","shd","deleteRepeatOpt","Array","ditem","ret","setlocaldata","func","getlocaldata","clearlocaldata","updatedata","uLen","prevData","flag","localforage","setItem","then","removeItem","err","getItem","readValue","newdata","keepHighLightBox"],"mappings":"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","file":"../../controllers/server.js","sourcesContent":["define([\n    'skylark-pako',\n    '../global/loading',\n    '../global/refresh',\n    '../global/editor',\n    './constant',\n    './sheetmanage',\n    './menuButton',\n    './filter',\n    './freezen',\n    './postil',\n    './imageCtrl',\n    './dataVerificationCtrl',\n    './hyperlinkCtrl',\n    '../utils/util',\n    '../methods/get',\n    '../store',\n    './select',\n    '../locale/locale',\n    'skylark-moment',\n    '../global/json'\n], function (pako, m_loading, m_refresh, editor, m_constant, sheetmanage, menuButton, m_filter, luckysheetFreezen, luckysheetPostil, imageCtrl, dataVerificationCtrl, hyperlinkCtrl, m_util, m_get, Store, m_select, locale, dayjs, json) {\n    'use strict';\n    const {showloading, hideloading} = m_loading;\n    const {luckysheetrefreshgrid, jfrefreshgrid_rhcw} = m_refresh;\n    const {sheetHTML, luckyColor} = m_constant;\n    const {createFilterOptions} = m_filter;\n    const {getObjType, replaceHtml, getByteLen} = m_util;\n    const {getSheetIndex} = m_get;\n    const {collaborativeEditBox} = m_select;\n    const server = {\n        gridKey: null,\n        loadUrl: null,\n        updateUrl: null,\n        updateImageUrl: null,\n        title: null,\n        loadSheetUrl: null,\n        retryTimer: null,\n        allowUpdate: false,\n        //共享编辑模式\n        historyParam: function (data, sheetIndex, range) {\n            let _this = this;\n            let r1 = range.row[0], r2 = range.row[1];\n            let c1 = range.column[0], c2 = range.column[1];\n            if (r1 == r2 && c1 == c2) {\n                //单个单元格更新\n                let v = data[r1][c1];\n                _this.saveParam('v', sheetIndex, v, {\n                    'r': r1,\n                    'c': c1\n                });\n            } else {\n                //范围单元格更新\n                let rowlen = r2 - r1 + 1;\n                let collen = c2 - c1 + 1;\n                let timeR = Math.floor(1000 / collen);\n                let n = Math.ceil(rowlen / timeR);    //分批次更新，一次最多1000个单元格\n                //分批次更新，一次最多1000个单元格\n                for (let i = 0; i < n; i++) {\n                    let str = r1 + timeR * i;\n                    let edr;\n                    if (i == n - 1) {\n                        edr = r2;\n                    } else {\n                        edr = r1 + timeR * (i + 1) - 1;\n                    }\n                    let v = [];\n                    for (let r = str; r <= edr; r++) {\n                        let v_row = [];\n                        for (let c = c1; c <= c2; c++) {\n                            if (data[r] == null) {\n                                v_row.push(null);\n                            } else {\n                                v_row.push(data[r][c]);\n                            }\n                        }\n                        v.push(v_row);\n                    }\n                    _this.saveParam('rv', sheetIndex, v, {\n                        'range': {\n                            'row': [\n                                str,\n                                edr\n                            ],\n                            'column': [\n                                c1,\n                                c2\n                            ]\n                        }\n                    });\n                    if (i == n - 1) {\n                        _this.saveParam('rv_end', sheetIndex, null);\n                    }\n                }\n            }\n        },\n        saveParam: function (type, index, value, params) {\n            let _this = this;\n            if (!_this.allowUpdate) {\n                return;\n            }\n            if (value == undefined) {\n                value = null;\n            }\n            let d = {};\n            d.t = type;\n            d.i = index;\n            d.v = value;    //切换sheet页不发后台，TODO：改为发后台+后台不广播 \n            //切换sheet页不发后台，TODO：改为发后台+后台不广播 \n            if (type === 'shs') {\n                return;\n            }\n            if (type == 'rv') {\n                //单元格批量更新\n                d.range = params.range;\n            } else if (type == 'v' || type == 'fu' || type == 'fm') {\n                d.r = params.r;\n                d.c = params.c;\n            } else if (type == 'fc') {\n                d.op = params.op;\n                d.pos = params.pos;\n            } else if (type == 'drc' || type == 'arc' || type == 'h' || type == 'wh') {\n                d.rc = params.rc;\n            } else if (type == 'c') {\n                d.cid = params.cid;\n                d.op = params.op;\n            } else if (type == 'f') {\n                d.op = params.op;\n                d.pos = params.pos;\n            } else if (type == 's') {\n            } else if (type == 'sh') {\n                d.op = params.op;\n                if (params.cur != null) {\n                    d.cur = params.cur;\n                }\n            } else if (type == 'cg') {\n                d.k = params.k;\n            } else if (type == 'all') {\n                d.k = params.k;    // d.s = params.s;\n            }\n            // d.s = params.s;\n            let msg = pako.gzip(encodeURIComponent(JSON.stringify(d)), { to: 'string' });\n            if (_this.websocket != null) {\n                _this.websocket.send(msg);\n            }\n        },\n        websocket: null,\n        wxErrorCount: 0,\n        openWebSocket: function () {\n            let _this = this;\n            if ('WebSocket' in window) {\n                let wxUrl = _this.updateUrl + '?t=111&g=' + encodeURIComponent(_this.gridKey);\n                if (_this.updateUrl.indexOf('?') > -1) {\n                    wxUrl = _this.updateUrl + '&t=111&g=' + encodeURIComponent(_this.gridKey);\n                }\n                _this.websocket = new WebSocket(wxUrl);    //连接建立时触发\n                //连接建立时触发\n                _this.websocket.onopen = function () {\n                    console.info(locale().websocket.success);\n                    hideloading();\n                    _this.wxErrorCount = 0;    //防止websocket长时间不发送消息导致断连\n                    //防止websocket长时间不发送消息导致断连\n                    _this.retryTimer = setInterval(function () {\n                        _this.websocket.send('rub');\n                    }, 60000);\n                };    //客户端接收服务端数据时触发\n                //客户端接收服务端数据时触发\n                _this.websocket.onmessage = function (result) {\n                    Store.result = result;\n                    let data = new Function('return ' + result.data)();\n                    console.info(data);\n                    let type = data.type;\n                    let {message, id} = data;    // 用户退出时，关闭协同编辑时其提示框\n                    // 用户退出时，关闭协同编辑时其提示框\n                    if (message === '用户退出') {\n                        $('#luckysheet-multipleRange-show-' + id).hide();\n                        Store.cooperativeEdit.changeCollaborationSize = Store.cooperativeEdit.changeCollaborationSize.filter(value => {\n                            return value.id != id;\n                        });\n                        Store.cooperativeEdit.checkoutData = Store.cooperativeEdit.checkoutData.filter(value => {\n                            return value.id != id;\n                        });\n                    }\n                    if (type == 1) {\n                    } else if (type == 2) {\n                        //更新数据\n                        let item = JSON.parse(data.data);\n                        _this.wsUpdateMsg(item);\n                        let chang_data = JSON.parse(data.data);\n                        if (chang_data.k == 'columnlen') {\n                            collaborativeEditBox(chang_data.v, null);\n                        } else if (chang_data.k == 'rowlen') {\n                            collaborativeEditBox(null, chang_data.v);\n                        }\n                    } else if (type == 3) {\n                        //多人操作不同选区(\"t\": \"mv\")（用不同颜色显示其他人所操作的选区）\n                        let id = data.id;\n                        let username = data.username;\n                        let item = JSON.parse(data.data);\n                        let type = item.t, index = item.i, value = item.v;\n                        if (Store.cooperativeEdit.changeCollaborationSize.length === 0) {\n                            Store.cooperativeEdit.changeCollaborationSize.push({\n                                id: id,\n                                v: item.v[0],\n                                i: index\n                            });\n                        }\n                        let flag = Store.cooperativeEdit.changeCollaborationSize.some(value1 => {\n                            return value1.id == id;\n                        });\n                        if (flag) {\n                            Store.cooperativeEdit.changeCollaborationSize.forEach(val => {\n                                if (val.id == id) {\n                                    val.v = item.v[0];\n                                    val.i = index;\n                                }\n                            });\n                        } else {\n                            Store.cooperativeEdit.changeCollaborationSize.push({\n                                id: id,\n                                v: item.v[0],\n                                i: index\n                            });\n                        }\n                        if (getObjType(value) != 'array' && getObjType(value) !== 'object') {\n                            value = JSON.parse(value);\n                        }\n                        let r = 0;\n                        let c = 0;\n                        if (index == Store.currentSheetIndex) {\n                            //发送消息者在当前页面\n                            if (getObjType(value) === 'object' && value.op === 'enterEdit') {\n                                r = value.range[value.range.length - 1].row[0];\n                                c = value.range[value.range.length - 1].column[0];\n                                _this.multipleRangeShow(id, username, r, c, value.op);\n                            } else {\n                                r = value[value.length - 1].row[0];\n                                c = value[value.length - 1].column[0];\n                                _this.multipleRangeShow(id, username, r, c);\n                            }\n                        } else {\n                            if (getObjType(value) === 'object' && value.op === 'enterEdit') {\n                                r = value.range[value.range.length - 1].row[0];\n                                c = value.range[value.range.length - 1].column[0];\n                            } else {\n                                r = value[value.length - 1].row[0];\n                                c = value[value.length - 1].column[0];\n                            }\n                        }\n                        if (Store.cooperativeEdit.checkoutData.length === 0) {\n                            if (value.op) {\n                                Store.cooperativeEdit.checkoutData.push({\n                                    id,\n                                    username,\n                                    r,\n                                    c,\n                                    op: value.op,\n                                    index\n                                });\n                            } else {\n                                Store.cooperativeEdit.checkoutData.push({\n                                    id,\n                                    username,\n                                    r,\n                                    c,\n                                    index\n                                });\n                            }\n                        }\n                        let checkoutFlag = Store.cooperativeEdit.checkoutData.some(item => {\n                            return item.id == id;\n                        });\n                        if (checkoutFlag) {\n                            Store.cooperativeEdit.checkoutData.forEach(item => {\n                                if (item.id == id) {\n                                    item.username = username;\n                                    item.r = r;\n                                    item.c = c;\n                                    item.index = index;\n                                    if (value.op === 'enterEdit') {\n                                        item.op = value.op;\n                                    }\n                                }\n                            });\n                        } else {\n                            if (value.op === 'enterEdit') {\n                                Store.cooperativeEdit.checkoutData.push({\n                                    id,\n                                    username,\n                                    r,\n                                    c,\n                                    op: value.op,\n                                    index\n                                });\n                            } else {\n                                Store.cooperativeEdit.checkoutData.push({\n                                    id,\n                                    username,\n                                    r,\n                                    c,\n                                    index\n                                });\n                            }\n                        }    //其他客户端切换页面时\n                        //其他客户端切换页面时\n                        Store.cooperativeEdit.checkoutData.forEach(item => {\n                            if (item.index != Store.currentSheetIndex) {\n                                $('#luckysheet-multipleRange-show-' + item.id).hide();\n                                item.op == '';\n                            }\n                        });\n                        if ($('#luckysheet-multipleRange-show-' + id)[0]) {\n                            let change_bottom = $('#luckysheet-multipleRange-show-' + id)[0].offsetHeight - 1;\n                            $('#luckysheet-multipleRange-show-' + id + '>.username').css({ 'bottom': change_bottom + 'px' });\n                        }\n                    } else if (type == 4) {\n                        //批量指令更新\n                        // let items = JSON.parse(data.data);\n                        // After editing by multiple people, data.data may appear as an empty string\n                        let items = data.data === '' ? data.data : JSON.parse(data.data);\n                        for (let i = 0; i < items.length; i++) {\n                            _this.wsUpdateMsg(item[i]);\n                        }\n                    }\n                };    //通信发生错误时触发\n                //通信发生错误时触发\n                _this.websocket.onerror = function () {\n                    _this.wxErrorCount++;\n                    if (_this.wxErrorCount > 3) {\n                        showloading(locale().websocket.refresh);\n                    } else {\n                        showloading(locale().websocket.wait);\n                        _this.openWebSocket();\n                    }\n                };    //连接关闭时触发\n                //连接关闭时触发\n                _this.websocket.onclose = function (e) {\n                    console.info(locale().websocket.close);\n                    if (e.code === 1000) {\n                        clearInterval(_this.retryTimer);\n                        _this.retryTimer = null;\n                    } else {\n                        alert(locale().websocket.contact);\n                    }\n                };\n            } else {\n                alert(locale().websocket.support);\n            }\n        },\n        wsUpdateMsg: function (item) {\n            let type = item.t, index = item.i, value = item.v;\n            let file = Store.luckysheetfile[getSheetIndex(index)];\n            if ([\n                    'v',\n                    'rv',\n                    'cg',\n                    'all',\n                    'fc',\n                    'drc',\n                    'arc',\n                    'f',\n                    'fsc',\n                    'fsr',\n                    'sh',\n                    'c'\n                ].includes(type) && file == null) {\n                return;\n            }\n            if (type == 'v') {\n                //单个单元格数据更新\n                if (file.data == null || file.data.length == 0) {\n                    return;\n                }\n                let r = item.r, c = item.c;\n                file.data[r][c] = value;\n                if (index == Store.currentSheetIndex) {\n                    //更新数据为当前表格数据\n                    Store.flowdata = file.data;\n                    editor.webWorkerFlowDataCache(Store.flowdata);    //worker存数据\n                                                                      //如果更新的单元格有批注\n                    //worker存数据\n                    //如果更新的单元格有批注\n                    if (value != null && value.ps != null) {\n                        luckysheetPostil.buildPs(r, c, value.ps);\n                    } else {\n                        luckysheetPostil.buildPs(r, c, null);\n                    }\n                    setTimeout(function () {\n                        luckysheetrefreshgrid();\n                    }, 1);\n                }\n            } else if (type == 'rv') {\n                //范围单元格数据更新\n                if (Object.keys(item.range).length > 0) {\n                    Store.cooperativeEdit.merge_range = item.range;\n                    Store.cooperativeEdit.merge_range.v = item.v;\n                    collaborativeEditBox();\n                }\n                if (file.data == null || file.data.length == 0) {\n                    return;\n                }\n                let r1 = item.range.row[0], r2 = item.range.row[1];\n                let c1 = item.range.column[0], c2 = item.range.column[1];\n                for (let r = r1; r <= r2; r++) {\n                    for (let c = c1; c <= c2; c++) {\n                        file.data[r][c] = value[r - r1][c - c1];\n                    }\n                }\n                if (index == Store.currentSheetIndex) {\n                    //更新数据为当前表格数据\n                    Store.flowdata = file.data;\n                    editor.webWorkerFlowDataCache(Store.flowdata);    //worker存数据\n                                                                      //如果更新的单元格有批注\n                    //worker存数据\n                    //如果更新的单元格有批注\n                    for (let r = r1; r <= r2; r++) {\n                        for (let c = c1; c <= c2; c++) {\n                            if (value[r - r1][c - c1] != null && value[r - r1][c - c1].ps != null) {\n                                luckysheetPostil.buildPs(r, c, value[r - r1][c - c1].ps);\n                            } else {\n                                luckysheetPostil.buildPs(r, c, null);\n                            }\n                        }\n                    }\n                    setTimeout(function () {\n                        luckysheetrefreshgrid();\n                    }, 1);\n                }\n            } else if (type == 'cg') {\n                //config更新（rowhidden，rowlen，columnlen，merge，borderInfo）\n                let k = item.k;\n                if (k == 'borderInfo') {\n                    file['config']['borderInfo'] = value;\n                } else {\n                    if (!(k in file['config'])) {\n                        file['config'][k] = {};\n                    }\n                    for (let key in value) {\n                        file['config'][k][key] = value[key];\n                    }\n                }\n                if (index == Store.currentSheetIndex) {\n                    //更新数据为当前表格数据\n                    Store.config = file['config'];\n                    if (k == 'rowlen' || k == 'columnlen' || k == 'rowhidden') {\n                        jfrefreshgrid_rhcw(Store.flowdata.length, Store.flowdata[0].length);\n                    }\n                    setTimeout(function () {\n                        luckysheetrefreshgrid();\n                    }, 1);\n                }\n            } else if (type == 'all') {\n                //通用保存更新\n                let k = item.k;\n                file[k] = value;\n                if (k == 'name') {\n                    //工作表名\n                    $('#luckysheet-sheet-container-c #luckysheet-sheets-item' + index).find('span.luckysheet-sheets-item-name').html(value);\n                } else if (k == 'color') {\n                    //工作表颜色\n                    let currentSheetItem = $('#luckysheet-sheet-container-c #luckysheet-sheets-item' + index);\n                    currentSheetItem.find('.luckysheet-sheets-item-color').remove();\n                    if (value != null || value != '') {\n                        currentSheetItem.append('<div class=\"luckysheet-sheets-item-color\" style=\" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: ' + value + ';\"></div>');\n                    }\n                } else if (k == 'pivotTable') {\n                } else if (k == 'frozen') {\n                    //freezen row and column\n                    // tranform frozen\n                    luckysheetFreezen.frozenTofreezen();\n                    if (index == Store.currentSheetIndex) {\n                        const _locale = locale();\n                        const locale_freezen = _locale.freezen;\n                        if (file['freezen'].horizontal == null) {\n                            $('#luckysheet-freezen-btn-horizontal').html('<i class=\"fa fa-list-alt\"></i> ' + locale_freezen.freezenRow);\n                            luckysheetFreezen.freezenhorizontaldata = null;\n                            $('#luckysheet-freezebar-horizontal').hide();\n                        } else {\n                            luckysheetFreezen.createFreezenHorizontal(file['freezen'].horizontal.freezenhorizontaldata, file['freezen'].horizontal.top);\n                        }\n                        if (file['freezen'].vertical == null) {\n                            $('#luckysheet-freezen-btn-vertical').html('<i class=\"fa fa-indent\"></i> ' + locale_freezen.freezenColumn);\n                            luckysheetFreezen.freezenverticaldata = null;\n                            $('#luckysheet-freezebar-vertical').hide();\n                        } else {\n                            luckysheetFreezen.createFreezenVertical(file['freezen'].vertical.freezenverticaldata, file['freezen'].vertical.left);\n                        }\n                        luckysheetFreezen.createAssistCanvas();\n                    }\n                } else if (k == 'filter_select') {\n                    //筛选范围\n                    if (index == Store.currentSheetIndex) {\n                        createFilterOptions(value);\n                    }\n                } else if (k == 'filter') {\n                    //筛选保存\n                    if (index == Store.currentSheetIndex) {\n                        createFilterOptions(file.filter_select, value);\n                    }\n                } else if (k == 'luckysheet_conditionformat_save') {\n                    //条件格式\n                    if (index == Store.currentSheetIndex) {\n                        setTimeout(function () {\n                            luckysheetrefreshgrid();\n                        }, 1);\n                    }\n                } else if (k == 'luckysheet_alternateformat_save') {\n                    //交替颜色\n                    if (index == Store.currentSheetIndex) {\n                        setTimeout(function () {\n                            luckysheetrefreshgrid();\n                        }, 1);\n                    }\n                } else if (k == 'config') {\n                    //config\n                    if (index == Store.currentSheetIndex) {\n                        Store.config = value;\n                        jfrefreshgrid_rhcw(Store.flowdata.length, Store.flowdata[0].length);\n                    }\n                } else if (k == 'dynamicArray') {\n                    //动态数组\n                    if (index == Store.currentSheetIndex) {\n                        setTimeout(function () {\n                            luckysheetrefreshgrid();\n                        }, 1);\n                    }\n                } else if (k == 'images') {\n                    //图片\n                    if (index == Store.currentSheetIndex) {\n                        imageCtrl.images = value;\n                        imageCtrl.allImagesShow();\n                        imageCtrl.init();\n                    }\n                } else if (k == 'dataVerification') {\n                    //数据验证\n                    if (index == Store.currentSheetIndex) {\n                        dataVerificationCtrl.dataVerification = value;\n                        dataVerificationCtrl.init();\n                    }\n                } else if (k == 'hyperlink') {\n                    //链接\n                    if (index == Store.currentSheetIndex) {\n                        hyperlinkCtrl.hyperlink = value;\n                        hyperlinkCtrl.init();\n                    }\n                }\n            } else if (type == 'fc') {\n                //函数链calc\n                let op = item.op, pos = item.pos;\n                if (getObjType(value) != 'object') {\n                    value = new Function('return ' + value)();\n                }\n                let r = value.r, c = value.c;\n                let calcChain = file['calcChain'] == null ? [] : file['calcChain'];\n                if (op == 'add') {\n                    calcChain.push(value);\n                } else if (op == 'del') {\n                    for (let a = 0; a < calcChain.length; a++) {\n                        if (r == calcChain[a].r && c == calcChain[a].c && index == calcChain[a].index) {\n                            calcChain.splice(a, 1);\n                        }\n                    }\n                }    // else if(op == \"update\"){\n                     //     for(let a = 0; a < calcChain.length; a++){\n                     //         if(r == calcChain[a].r && c == calcChain[a].c && index == calcChain[a].index){\n                     //             calcChain[a].func = func;\n                     //         }\n                     //     }\n                     // }\n                // else if(op == \"update\"){\n                //     for(let a = 0; a < calcChain.length; a++){\n                //         if(r == calcChain[a].r && c == calcChain[a].c && index == calcChain[a].index){\n                //             calcChain[a].func = func;\n                //         }\n                //     }\n                // }\n                setTimeout(function () {\n                    luckysheetrefreshgrid();\n                }, 1);\n            } else if (type == 'drc') {\n                //删除行列\n                if (file.data == null || file.data.length == 0) {\n                    return;\n                }\n                let rc = item.rc, st_i = value.index, len = value.len, mc = value.mc, borderInfo = value.borderInfo;\n                let data = file.data;\n                if (rc == 'r') {\n                    file['row'] -= len;\n                    data.splice(st_i, len);    //空白行模板\n                    //空白行模板\n                    let row = [];\n                    for (let c = 0; c < data[0].length; c++) {\n                        row.push(null);\n                    }    //删除多少行，增加多少行空白行\n                    //删除多少行，增加多少行空白行\n                    for (let r = 0; r < len; r++) {\n                        data.push(row);\n                    }\n                } else {\n                    file['column'] -= len;    //空白列模板\n                    //空白列模板\n                    let addcol = [];\n                    for (let r = 0; r < len; r++) {\n                        addcol.push(null);\n                    }\n                    for (let i = 0; i < data.length; i++) {\n                        data[i].splice(st_i, len);\n                        data[i] = data[i].concat(addcol);\n                    }\n                }\n                for (let x in mc) {\n                    let r = mc[x].r, c = mc[x].c;\n                    data[r][c].mc = mc[x];\n                }\n                file['config'].merge = mc;\n                file['config'].borderInfo = borderInfo;\n                if (index == Store.currentSheetIndex) {\n                    Store.flowdata = data;\n                    editor.webWorkerFlowDataCache(Store.flowdata);    //worker存数据\n                    //worker存数据\n                    Store.config['merge'] = mc;\n                    Store.config['borderInfo'] = borderInfo;\n                    setTimeout(function () {\n                        luckysheetrefreshgrid();\n                    }, 1);\n                }\n            } else if (type == 'arc') {\n                //增加行列\n                if (file.data == null || file.data.length == 0) {\n                    return;\n                }\n                let rc = item.rc, st_i = value.index, len = value.len, addData = value.data, direction = value.direction, mc = value.mc, borderInfo = value.borderInfo;\n                let data = $.extend(true, [], file.data);\n                if (rc == 'r') {\n                    file['row'] += len;    //空行模板\n                    //空行模板\n                    let row = [];\n                    for (let c = 0; c < data[0].length; c++) {\n                        row.push(null);\n                    }\n                    let arr = [];\n                    for (let i = 0; i < len; i++) {\n                        if (addData[i] == null) {\n                            arr.push(JSON.stringify(row));\n                        } else {\n                            arr.push(JSON.stringify(addData[i]));\n                        }\n                    }\n                    if (direction == 'lefttop') {\n                        if (st_i == 0) {\n                            new Function('data', 'return ' + 'data.unshift(' + arr.join(',') + ')')(data);\n                        } else {\n                            new Function('data', 'return ' + 'data.splice(' + st_i + ', 0, ' + arr.join(',') + ')')(data);\n                        }\n                    } else {\n                        new Function('data', 'return ' + 'data.splice(' + (st_i + 1) + ', 0, ' + arr.join(',') + ')')(data);\n                    }\n                } else {\n                    file['column'] += len;\n                    for (let i = 0; i < data.length; i++) {\n                        data[i].splice(st_i, 0, addData[i]);\n                    }\n                }\n                for (let x in mc) {\n                    let r = mc[x].r, c = mc[x].c;\n                    data[r][c].mc = mc[x];\n                }\n                file.data = data;\n                file['config'].merge = mc;\n                file['config'].borderInfo = borderInfo;\n                if (index == Store.currentSheetIndex) {\n                    Store.flowdata = data;\n                    editor.webWorkerFlowDataCache(Store.flowdata);    //worker存数据\n                    //worker存数据\n                    Store.config['merge'] = mc;\n                    Store.config['borderInfo'] = borderInfo;\n                    setTimeout(function () {\n                        luckysheetrefreshgrid();\n                    }, 1);\n                }\n            } else if (type == 'f') {\n                //筛选\n                let op = item.op, pos = item.pos;\n                let filter = file.filter;\n                if (filter == null) {\n                    filter = {};\n                }\n                if (op == 'upOrAdd') {\n                    filter[pos] = value;\n                } else if (op == 'del') {\n                    delete filter[pos];\n                }\n                if (index == Store.currentSheetIndex) {\n                    createFilterOptions(file.filter_select, filter);\n                }\n            } else if (type == 'fsc') {\n                //清除筛选\n                file.filter = null;\n                file.filter_select = null;\n                if (index == Store.currentSheetIndex) {\n                    $('#luckysheet-filter-selected-sheet' + Store.currentSheetIndex + ', #luckysheet-filter-options-sheet' + Store.currentSheetIndex).remove();\n                    $('#luckysheet-filter-menu, #luckysheet-filter-submenu').hide();\n                }\n            } else if (type == 'fsr') {\n                //恢复筛选\n                file.filter = value.filter;\n                file.filter_select = value.filter_select;\n                if (index == Store.currentSheetIndex) {\n                    createFilterOptions(file.filter_select, file.filter);\n                }\n            } else if (type == 'sha') {\n                //新建sheet\n                Store.luckysheetfile.push(value);\n                let colorset = '';\n                if (value.color != null) {\n                    colorset = '<div class=\"luckysheet-sheets-item-color\" style=\" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: ' + value.color + ';\"></div>';\n                }\n                $('#luckysheet-sheet-container-c').append(replaceHtml(sheetHTML, {\n                    'index': value.index,\n                    'active': '',\n                    'name': value.name,\n                    'style': '',\n                    'colorset': colorset\n                }));\n                $('#luckysheet-cell-main').append('<div id=\"luckysheet-datavisual-selection-set-' + value.index + '\" class=\"luckysheet-datavisual-selection-set\"></div>');\n            } else if (type == 'shc') {\n                //复制sheet\n                let copyindex = value.copyindex, name = value.name;\n                let copyarrindex = getSheetIndex(copyindex);\n                let copyjson = $.extend(true, {}, Store.luckysheetfile[copyarrindex]);\n                copyjson.index = index;\n                copyjson.name = name;\n                Store.luckysheetfile.splice(copyarrindex + 1, 0, copyjson);\n                let copyobject = $('#luckysheet-sheets-item' + copyindex);\n                $('#luckysheet-sheet-container-c').append(replaceHtml(sheetHTML, {\n                    'index': copyjson.index,\n                    'active': '',\n                    'name': copyjson.name,\n                    'style': '',\n                    'colorset': ''\n                }));\n                $('#luckysheet-sheets-item' + copyjson.index).insertAfter(copyobject);\n                $('#luckysheet-cell-main').append('<div id=\"luckysheet-datavisual-selection-set-' + copyjson.index + '\" class=\"luckysheet-datavisual-selection-set\"></div>');\n            } else if (type == 'shd') {\n                //删除sheet\n                for (let i = 0; i < Store.luckysheetfile.length; i++) {\n                    if (Store.luckysheetfile[i].index == value.deleIndex) {\n                        // 如果删除的是当前sheet，则切换到前一个sheet页\n                        if (Store.currentSheetIndex === value.deleIndex) {\n                            const index = value.deleIndex;\n                            Store.luckysheetfile[sheetmanage.getSheetIndex(index)].hide = 1;\n                            let luckysheetcurrentSheetitem = $('#luckysheet-sheets-item' + index);\n                            luckysheetcurrentSheetitem.hide();\n                            $('#luckysheet-sheet-area div.luckysheet-sheets-item').removeClass('luckysheet-sheets-item-active');\n                            let indicator = luckysheetcurrentSheetitem.nextAll(':visible');\n                            if (luckysheetcurrentSheetitem.nextAll(':visible').length > 0) {\n                                indicator = indicator.eq(0).data('index');\n                            } else {\n                                indicator = luckysheetcurrentSheetitem.prevAll(':visible').eq(0).data('index');\n                            }\n                            $('#luckysheet-sheets-item' + indicator).addClass('luckysheet-sheets-item-active');\n                            sheetmanage.changeSheetExec(indicator);\n                        }\n                        server.sheetDeleSave.push(Store.luckysheetfile[i]);\n                        Store.luckysheetfile.splice(i, 1);\n                        break;\n                    }\n                }\n                $('#luckysheet-sheets-item' + value.deleIndex).remove();\n                $('#luckysheet-datavisual-selection-set-' + value.deleIndex).remove();\n            } else if (type == 'shr') {\n                //sheet位置\n                for (let x in value) {\n                    Store.luckysheetfile[getSheetIndex(x)].order = value[x];\n                }\n            } else if (type == 'shre') {\n                //删除sheet恢复操作\n                for (let i = 0; i < server.sheetDeleSave.length; i++) {\n                    if (server.sheetDeleSave[i].index == value.reIndex) {\n                        let datav = server.sheetDeleSave[i];\n                        Store.luckysheetfile.push(datav);\n                        let colorset = '';\n                        if (value.color != null) {\n                            colorset = '<div class=\"luckysheet-sheets-item-color\" style=\" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: ' + datav.color + ';\"></div>';\n                        }\n                        $('#luckysheet-sheet-container-c').append(replaceHtml(sheetHTML, {\n                            'index': datav.index,\n                            'active': '',\n                            'name': datav.name,\n                            'style': '',\n                            'colorset': colorset\n                        }));\n                        $('#luckysheet-cell-main').append('<div id=\"luckysheet-datavisual-selection-set-' + datav.index + '\" class=\"luckysheet-datavisual-selection-set\"></div>');\n                        break;\n                    }\n                }\n            } else if (type == 'sh') {\n                //隐藏sheet\n                let op = item.op, cur = item.cur;\n                if (op == 'hide') {\n                    file.hide = 1;\n                    $('#luckysheet-sheets-item' + index).hide();\n                    if (index == Store.currentSheetIndex) {\n                        $('#luckysheet-sheets-item' + cur).addClass('luckysheet-sheets-item-active');\n                        sheetmanage.changeSheetExec(cur);\n                    }\n                } else if (op == 'show') {\n                    file.hide = 0;\n                    $('#luckysheet-sheets-item' + index).show();\n                }\n            } else if (type == 'c') {\n                //图表操作 TODO\n                let op = item.op, cid = item.cid;\n                if (op == 'add') {\n                    //插入\n                    file.chart.push(value);\n                    luckysheet.insertChartTosheet(value.sheetIndex, value.dataSheetIndex, value.option, value.chartType, value.selfOption, value.defaultOption, value.row, value.column, value.chart_selection_color, value.chart_id, value.chart_selection_id, value.chartStyle, value.rangeConfigCheck, value.rangeRowCheck, value.rangeColCheck, value.chartMarkConfig, value.chartTitleConfig, value.winWidth, value.winHeight, value.scrollLeft1, value.scrollTop1, value.chartTheme, value.myWidth, value.myHeight, value.myLeft, value.myTop, value.myindexrank1, true);\n                } else if (op == 'xy' || op == 'wh' || op == 'update') {\n                    //移动 缩放 更新\n                    for (let i = 0; i < file.chart.length; i++) {\n                        let chartjson = file.chart[i];\n                        if (chartjson.chart_id == cid) {\n                            for (let item in chartjson) {\n                                for (let vitem in value) {\n                                    if (item == vitem) {\n                                        chartjson[item] = value[vitem];\n                                    }\n                                }\n                            }\n                            sheetmanage.saveChart(chartjson);\n                            return;\n                        }\n                    }\n                } else if (op == 'del') {\n                    //删除\n                    for (let i = 0; i < file.chart.length; i++) {\n                        let chartjson = file.chart[i];\n                        if (chartjson.chart_id == cid) {\n                            file.chart.splice(i, 1);\n                            $('#' + cid).remove();\n                            sheetmanage.delChart($('#' + cid).attr('chart_id'), $('#' + cid).attr('sheetIndex'));\n                            return;\n                        }\n                    }\n                }\n            } else if (type == 'na') {\n                //表格名称\n                $('#luckysheet_info_detail_input').val(value).css('width', getByteLen(value) * 10);\n            }\n        },\n        multipleIndex: 0,\n        multipleRangeShow: function (id, name, r, c, value) {\n            let _this = this;\n            let row = Store.visibledatarow[r], row_pre = r - 1 == -1 ? 0 : Store.visibledatarow[r - 1], col = Store.visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : Store.visibledatacolumn[c - 1];\n            let margeset = menuButton.mergeborer(Store.flowdata, r, c);\n            if (!!margeset) {\n                row = margeset.row[1];\n                row_pre = margeset.row[0];\n                col = margeset.column[1];\n                col_pre = margeset.column[0];\n            }    // 超出16个字符就显示...\n            // 超出16个字符就显示...\n            if (getByteLen(name) > 16) {\n                name = getByteLen(name, 16) + '...';\n            }    // 如果正在编辑，就显示“正在输入”\n            // 如果正在编辑，就显示“正在输入”\n            if (value === 'enterEdit') {\n                name += ' ' + locale().edit.typing;\n            }\n            if ($('#luckysheet-multipleRange-show-' + id).length > 0) {\n                $('#luckysheet-multipleRange-show-' + id).css({\n                    'position': 'absolute',\n                    'left': col_pre - 1,\n                    'width': col - col_pre - 1,\n                    'top': row_pre - 1,\n                    'height': row - row_pre - 1\n                });\n                $('#luckysheet-multipleRange-show-' + id + ' .username').text(name);\n                $('#luckysheet-multipleRange-show-' + id + ' .username').show();\n                if (Store.cooperativeEdit.usernameTimeout['user' + id] != null) {\n                    clearTimeout(Store.cooperativeEdit.usernameTimeout['user' + id]);\n                }\n                Store.cooperativeEdit.usernameTimeout['user' + id] = setTimeout(() => {\n                    clearTimeout(Store.cooperativeEdit.usernameTimeout['user' + id]);\n                    Store.cooperativeEdit.usernameTimeout['user' + id] = null;\n                }, 10 * 1000);\n            } else {\n                // let itemHtml = '<div id=\"luckysheet-multipleRange-show-'+ id +'\" data-color=\"'+ luckyColor[_this.multipleIndex] +'\" title=\"'+ name +'\" style=\"position: absolute;left: '+ (col_pre - 1) +'px;width: '+ (col - col_pre - 1) +'px;top: '+ (row_pre - 1) +'px;height: '+ (row - row_pre - 1) +'px;border: 1px solid '+ luckyColor[_this.multipleIndex] +';z-index: 15;\">'+\n                //                 '<div style=\"width: 100%;height: 100%;position: absolute;top: 0;right: 0;bottom: 0;left: 0;opacity: 0.03;background-color: '+ luckyColor[_this.multipleIndex] +'\"></div>'+\n                //                '</div>';\n                let itemHtml = `<div \n\t\t\t\t\t\t\t\tid=\"luckysheet-multipleRange-show-${ id }\"\n\t\t\t\t\t\t\t\tclass=\"luckysheet-multipleRange-show\"\n\t\t\t\t\t\t\t\tdata-color=\"${ luckyColor[_this.multipleIndex] }\" \n\t\t\t\t\t\t\t\ttitle=\"${ name }\" \n\t\t\t\t\t\t\t\tstyle=\"position: absolute;left: ${ col_pre - 1 }px;width: ${ col - col_pre - 1 }px;top: ${ row_pre - 1 }px;height: ${ row - row_pre - 1 }px;border: 1px solid ${ luckyColor[_this.multipleIndex] };z-index: 15;\">\n\n\t\t\t\t\t\t\t\t<div class=\"username\" style=\"height: 19px;line-height:19px;width: max-content;position: absolute;bottom: ${ row - row_pre - 1 }px;right: 0;background-color: ${ luckyColor[_this.multipleIndex] };color:#ffffff;padding:0 10px;\">\n\t\t\t\t\t\t\t\t${ name }\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t<div style=\"width: 100%;height: 100%;position: absolute;top: 0;right: 0;bottom: 0;left: 0;opacity: 0.03;background-color: ${ luckyColor[_this.multipleIndex] }\">\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t</div>`;    // 正在输入\n                // 正在输入\n                $(itemHtml).appendTo($('#luckysheet-cell-main #luckysheet-multipleRange-show'));\n                _this.multipleIndex++;    // 设定允许用户名消失的定时器，10秒后用户名可隐藏\n                                          // 10秒之类，用户操作界面不会隐藏用户名；10秒之后如果用户操作了界面，则隐藏用户名，没操作就不隐藏\n                // 设定允许用户名消失的定时器，10秒后用户名可隐藏\n                // 10秒之类，用户操作界面不会隐藏用户名；10秒之后如果用户操作了界面，则隐藏用户名，没操作就不隐藏\n                if (Store.cooperativeEdit.usernameTimeout['user' + id] != null) {\n                    clearTimeout(Store.cooperativeEdit.usernameTimeout['user' + id]);\n                }\n                Store.cooperativeEdit.usernameTimeout['user' + id] = setTimeout(() => {\n                    clearTimeout(Store.cooperativeEdit.usernameTimeout['user' + id]);\n                    Store.cooperativeEdit.usernameTimeout['user' + id] = null;\n                }, 10 * 1000);\n            }\n        },\n        sheetDeleSave: [],\n        //共享编辑模式下 删除的sheet保存下来，方便恢复时取值\n        submitInterval: 1000,\n        imagesubmitInterval: 5000,\n        submitdatalimit: 50,\n        submitcompresslimit: 1000,\n        checksubmit: function (data) {\n            let _this = this;    //clearTimeout(_this.requestTimeOut);\n            //clearTimeout(_this.requestTimeOut);\n            _this.submitTimeout();\n            clearTimeout(_this.imageRequestTimeout);\n            _this.imageRequestTimeout = setTimeout(function () {\n                _this.imageRequest();\n            }, _this.imagesubmitInterval);\n        },\n        submitTimeout: function () {\n            let _this = this;\n            clearTimeout(_this.requestTimeOut);    //console.log(_this.requestlast, dayjs(), (_this.requestlast!=null && _this.requestlast.add(10, 'seconds').isBefore(dayjs()) ) );\n            //console.log(_this.requestlast, dayjs(), (_this.requestlast!=null && _this.requestlast.add(10, 'seconds').isBefore(dayjs()) ) );\n            if (!_this.requestLock && (_this.requestlast != null && _this.requestlast.clone().add(1, 'seconds').isBefore(dayjs()))) {\n                _this.request();\n            }    // if(!_this.imageRequestLock && (_this.imageRequestLast==null || _this.imageRequestLast.clone().add(30, 'seconds').isBefore(dayjs()) ) ){\n                 // }\n            // if(!_this.imageRequestLock && (_this.imageRequestLast==null || _this.imageRequestLast.clone().add(30, 'seconds').isBefore(dayjs()) ) ){\n            // }\n            _this.requestTimeOut = setTimeout(function () {\n                _this.submitTimeout();\n            }, _this.submitInterval);\n        },\n        requestLock: false,\n        requestlast: null,\n        firstchange: true,\n        requestTimeOut: null,\n        request: function () {\n            let _this = this;\n            let key = this.gridKey;\n            let cahce_key = key + '__qkcache';\n            _this.cachelocaldata(function (cahce_key, params) {\n                if (params.length == 0) {\n                    return;\n                }\n                params = encodeURIComponent(JSON.stringify(params));\n                let compressBeginLen = params.length;\n                let iscommpress = false;    // if (compressBeginLen > _this.submitcompresslimit) {\n                                            //     params = pako.gzip(params, { to: \"string\" });\n                                            //     iscommpress = true;\n                                            // }\n                // if (compressBeginLen > _this.submitcompresslimit) {\n                //     params = pako.gzip(params, { to: \"string\" });\n                //     iscommpress = true;\n                // }\n                _this.requestLock = true;    //console.log(params);\n                                             // console.log(\"request\");\n                //console.log(params);\n                // console.log(\"request\");\n                if (_this.updateUrl != '') {\n                    $.post(_this.updateUrl, {\n                        compress: iscommpress,\n                        gridKey: _this.gridKey,\n                        data: params\n                    }, function (data) {\n                        let re = new Function('return ' + data)();\n                        if (re.status) {\n                            $('#luckysheet_info_detail_update').html('最近存档时间:' + dayjs().format('M-D H:m:s'));\n                            $('#luckysheet_info_detail_save').html('同步成功');\n                            _this.clearcachelocaldata();\n                        } else {\n                            $('#luckysheet_info_detail_save').html(\"<span style='color:#ff2121'>同步失败</span>\");\n                            _this.restorecachelocaldata();\n                        }\n                        _this.requestlast = dayjs();\n                        _this.requestLock = false;\n                    });\n                }\n            });\n        },\n        imageRequestLast: null,\n        imageRequestLock: false,\n        imageRequestTimeout: null,\n        imageRequest: function () {\n            let _this = this;\n            html2canvas($('#' + container).find('.luckysheet-grid-window').get(0), {\n                onrendered: function (canvas) {\n                    //let imgcut = $(\"#luckysheet-cell-main\").find(\".luckysheet-grid-window\");\n                    //document.body.appendChild(canvas);\n                    let old = $(canvas).appendTo('body');\n                    old.hide();\n                    let newwidth = old.width();\n                    let newheight = old.height();\n                    let imageData = old.get(0).getContext('2d').getImageData(0, 0, newwidth, newheight);\n                    let cutW = newwidth, cutH = newheight;\n                    if (cutW * 0.54 > cutH) {\n                        cutW = cutH / 0.54;\n                    } else {\n                        cutH = cutW * 0.54;\n                    }\n                    let newCanvas = $('<canvas>').attr('width', cutW).attr('height', cutH)[0];\n                    newCanvas.getContext('2d').putImageData(imageData, 0, 0);\n                    old.attr('width', 350);\n                    old.attr('height', 189);\n                    old.get(0).getContext('2d').drawImage(newCanvas, 0, 0, 350, 189);\n                    let base64 = old.get(0).toDataURL('image/jpeg', 0.9);    //console.log(base64);\n                                                                             //console.log(\"压缩：\", pako.gzip(base64, { to: \"string\" }));\n                                                                             //console.log(\"imageRequest\");\n                    //console.log(base64);\n                    //console.log(\"压缩：\", pako.gzip(base64, { to: \"string\" }));\n                    //console.log(\"imageRequest\");\n                    let curindex = luckysheet.sheetmanage.getCurSheetnoset();\n                    _this.imageRequestLock = true;    // let data1 = pako.gzip(encodeURIComponent(JSON.stringify({\"t\":\"thumb\", \"img\": base64, \"curindex\":curindex })), { to: \"string\" });\n                    // let data1 = pako.gzip(encodeURIComponent(JSON.stringify({\"t\":\"thumb\", \"img\": base64, \"curindex\":curindex })), { to: \"string\" });\n                    let data1 = encodeURIComponent(JSON.stringify({\n                        't': 'thumb',\n                        'img': base64,\n                        'curindex': curindex\n                    }));\n                    old.remove();    //console.log(\"缩略图\", _this.imageRequestLast,base64);\n                    //console.log(\"缩略图\", _this.imageRequestLast,base64);\n                    if (_this.updateImageUrl != '') {\n                        // $.post(_this.updateImageUrl, { compress: true, gridKey: _this.gridKey, data:data1  }, function (data) {\n                        $.post(_this.updateImageUrl, {\n                            compress: false,\n                            gridKey: _this.gridKey,\n                            data: data1\n                        }, function (data) {\n                            let re = new Function('return ' + data)();\n                            if (re.status) {\n                                imageRequestLast = dayjs();\n                            } else {\n                                $('#luckysheet_info_detail_save').html(\"<span style='color:#ff2121'>网络不稳定</span>\");\n                            }\n                            _this.imageRequestLock = true;\n                        });\n                    }\n                }\n            });\n        },\n        localdata: [],\n        matchOpt: function (v, d) {\n            for (let vitem in v) {\n                if (vitem == 't' && v['t'] in {\n                        'drc': 1,\n                        'arc': 1,\n                        'sha': 1,\n                        'shc': 1,\n                        'shd': 1\n                    }) {\n                    return false;\n                }\n                if (vitem == 'v') {\n                    continue;\n                }\n                if (!(vitem in d)) {\n                    return false;\n                }\n                if (d[vitem] != v[vitem]) {\n                    return false;\n                }\n            }\n            return true;\n        },\n        deleteRepeatOpt: function (data, value) {\n            //let d = $.extend(true, [], data); //原来\n            let d = data;\n            let _this = this;\n            if (value instanceof Array) {\n                for (let i = 0; i < value.length; i++) {\n                    let vitem = value[i];\n                    for (let a = 0; a < d.length; a++) {\n                        let ditem = data[i];    //let ditem = data[a];?\n                        //let ditem = data[a];?\n                        if (_this.matchOpt(vitem, ditem)) {\n                            delete d[a];\n                        }\n                    }\n                }\n            } else {\n                for (let a = 0; a < d.length; a++) {\n                    let ditem = d[a];\n                    if (_this.matchOpt(value, ditem)) {\n                        delete d[a];\n                    }\n                }\n            }\n            let ret = [];\n            for (let i = 0; i < d.length; i++) {\n                if (d[i] != null) {\n                    ret.push(d[i]);\n                }\n            }\n            return ret;\n        },\n        setlocaldata: function (value, func) {\n            let key = this.gridKey;    //store.push(key, data);\n            //store.push(key, data);\n            let _this = this;\n            _this.getlocaldata(function (data) {\n                if (data == null) {\n                    data = [];\n                }    //此处不去重，在request同步后台时统一循环一次去重\n                     //let data = _this.deleteRepeatOpt(data, value);\n                //此处不去重，在request同步后台时统一循环一次去重\n                //let data = _this.deleteRepeatOpt(data, value);\n                if (value instanceof Array) {\n                    data = data.concat(value);\n                } else {\n                    data.push(value);\n                }\n                _this.localdata = data;\n                func(_this.localdata);    //console.log(value);\n                                          // localforage.setItem(key, data).then(function () {\n                                          //     console.log(data);\n                                          //     func(data);\n                                          // }).catch(function (err) {\n                                          // });\n            });\n        },\n        //console.log(value);\n        // localforage.setItem(key, data).then(function () {\n        //     console.log(data);\n        //     func(data);\n        // }).catch(function (err) {\n        // });\n        getlocaldata: function (func) {\n            let key = this.gridKey;    //return store.get(key);\n            //return store.get(key);\n            func(this.localdata);    // localforage.getItem(key).then(function(readValue) {\n                                     //     func(readValue);\n                                     // });\n        },\n        // localforage.getItem(key).then(function(readValue) {\n        //     func(readValue);\n        // });\n        clearlocaldata: function (func) {\n            let key = this.gridKey;    //store.remove(key);\n            //store.remove(key);\n            this.localdata = [];\n            func();    // localforage.removeItem(key, function(err,value) {\n                       //     func();\n                       // });\n        },\n        // localforage.removeItem(key, function(err,value) {\n        //     func();\n        // });\n        cachelocaldata: function (func) {\n            let key = this.gridKey;\n            let _this = this;\n            let cahce_key = key + '__qkcache';    //store.remove(key);\n                                                  //console.log(key, cahce_key);\n                                                  //处理localdata去重\n            //store.remove(key);\n            //console.log(key, cahce_key);\n            //处理localdata去重\n            let updatedata = _this.localdata;\n            let uLen = updatedata.length;\n            if (uLen > 1) {\n                let prevData = [];\n                prevData[0] = updatedata[0];\n                for (let i = 1; i < uLen; i++) {\n                    let value = updatedata[i];\n                    let flag = true;\n                    for (let a = 0; a < prevData.length; a++) {\n                        let ditem = prevData[a];\n                        if (_this.matchOpt(value, ditem)) {\n                            prevData.splice(a, 1, value);\n                            flag = false;    //如果已匹配重复，则后续无需再加\n                            //如果已匹配重复，则后续无需再加\n                            break;\n                        }\n                    }\n                    if (flag) {\n                        prevData = prevData.concat(value);\n                    }\n                }\n                updatedata = prevData;\n            }\n            if (updatedata == null || updatedata.length == 0) {\n                return;\n            }    //console.log(key, cahce_key,updatedata);\n            //console.log(key, cahce_key,updatedata);\n            _this.clearlocaldata(function () {\n                localforage.setItem(cahce_key, updatedata).then(function () {\n                    func(cahce_key, updatedata);\n                });\n            });    // localforage.getItem(key).then(function(readValue) {\n                   //     let updatedata = readValue;\n                   //     if(readValue==null || readValue.length==0){\n                   //         return;\n                   //     }\n                   //     //console.log(key, cahce_key,updatedata);\n                   //     _this.clearlocaldata(function(){\n                   //         localforage.setItem(cahce_key, updatedata).then(function () {\n                   //             func(cahce_key, updatedata);\n                   //         });\n                   //     });\n                   // });\n        },\n        // localforage.getItem(key).then(function(readValue) {\n        //     let updatedata = readValue;\n        //     if(readValue==null || readValue.length==0){\n        //         return;\n        //     }\n        //     //console.log(key, cahce_key,updatedata);\n        //     _this.clearlocaldata(function(){\n        //         localforage.setItem(cahce_key, updatedata).then(function () {\n        //             func(cahce_key, updatedata);\n        //         });\n        //     });\n        // });\n        clearcachelocaldata: function (func) {\n            let key = this.gridKey;\n            let cahce_key = key + '__qkcache';    //store.remove(key);\n            //store.remove(key);\n            localforage.removeItem(cahce_key, function (err, value) {\n                if (func && typeof func == 'function') {\n                    func();\n                }\n            });\n        },\n        restorecachelocaldata: function (func) {\n            let key = this.gridKey;\n            let cahce_key = key + '__qkcache';\n            let _this = this;\n            localforage.getItem(cahce_key).then(function (readValue) {\n                let updatedata = readValue;\n                _this.getlocaldata(function (data) {\n                    if (data == null) {\n                        data = [];\n                    }\n                    let newdata = updatedata.concat(data);    //data.unshift(updatedata);\n                    //data.unshift(updatedata);\n                    _this.localdata = newdata;\n                    if (func instanceof Function) {\n                        func(_this.localdata);\n                    }    // localforage.setItem(key, newdata).then(function () {\n                         //     func(newdata);\n                         // }).catch(function (err) {\n                         // });\n                });\n            });\n        },\n        // localforage.setItem(key, newdata).then(function () {\n        //     func(newdata);\n        // }).catch(function (err) {\n        // });\n        keepHighLightBox: function () {\n            Store.cooperativeEdit.checkoutData.forEach(value => {\n                if (value.index == Store.currentSheetIndex) {\n                    if (value.op === 'enterEdit') {\n                        server.multipleRangeShow(value.id, value.username, value.r, value.c, value.op);\n                    } else {\n                        server.multipleRangeShow(value.id, value.username, value.r, value.c);\n                    }\n                }\n            });\n        }\n    };\n    return server;\n});"]}