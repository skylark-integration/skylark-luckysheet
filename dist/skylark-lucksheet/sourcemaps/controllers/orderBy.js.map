{"version":3,"sources":["controllers/orderBy.js"],"names":["define","m_constant","m_select","m_protection","m_util","m_getRowlen","luckysheetConfigsetting","cleargridelement","m_getdata","m_sort","tooltip","m_datecontroll","Store","locale","modelHTML","selectHightlightShow","checkProtectionAuthorityNormal","replaceHtml","chatatABC","rowlenByRange","isEditMode","getcellvalue","orderbydata","sortColumnSeletion","isdatatype","orderByInitial","_locale","$","mousedown","event","orderbyindex","click","luckysheet_sort_initial","currentSheetIndex","hide","locale_sort","sort","luckysheet_select_save","length","alert","noRangeError","info","last","r1","r2","c1","c2","content","hasTitle","asc","desc","addOthers","append","id","addclass","title","sortTitle","botton","confirm","close","option","i","data","t","is","c","v","flowdata","columnOperation","secondaryTitle","change","this","each","html","str","d","deepCopyFlowData","hasMc","r","data_row","mc","push","mergeError","toArray","reverse","find","val","concat","allParam","config","cfg","extend","RowlChange","refreshRange","row","column","remove","prop","sortRangeTitle","sortRangeTitleTo","$t","myh","outerHeight","myw","outerWidth","winw","window","width","winh","height","scrollLeft","document","scrollTop","css","left","top","show","setTimeout","flowrowdata1","flowrowdata2","hastitle"],"mappings":"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","file":"../../controllers/orderBy.js","sourcesContent":["define([\n    '../widgets/constant',\n    '../widgets/select',\n    '../methods/protection_methods',\n    '../utils/util',\n    '../methods/getRowlen',\n    '../methods/luckysheetConfigsetting',\n    '../widgets/cleargridelement',\n    '../methods/getdata',\n    '../controllers/sort',\n    '../widgets/tooltip',\n    '../methods/datecontroll',\n    '../store',\n    '../locale/locale'\n], function (m_constant, m_select, m_protection, m_util, m_getRowlen, luckysheetConfigsetting, cleargridelement, m_getdata, m_sort, tooltip, m_datecontroll, Store, locale) {\n    'use strict';\n    const {modelHTML} = m_constant;\n    const {selectHightlightShow} = m_select;\n    const {checkProtectionAuthorityNormal} = m_protection;\n    const {replaceHtml, chatatABC} = m_util;\n    const {rowlenByRange} = m_getRowlen;\n    const {isEditMode} = luckysheetConfigsetting;\n    const {getcellvalue} = m_getdata;\n    const {orderbydata, sortColumnSeletion} = m_sort;\n    const {isdatatype} = m_datecontroll;\n    function orderByInitial() {\n        const _locale = locale();    //菜单栏 排序按钮\n        //菜单栏 排序按钮\n        $('#luckysheetorderbyasc, #luckysheetorderbyasc_t').mousedown(function (event) {\n            cleargridelement(event);\n            sortColumnSeletion(Store.orderbyindex, true);\n            selectHightlightShow();\n        });\n        $('#luckysheetorderbydesc, #luckysheetorderbydesc_t').click(function (event) {\n            cleargridelement(event);\n            sortColumnSeletion(Store.orderbyindex, false);\n            selectHightlightShow();\n        });    //排序事件\n        //排序事件\n        let luckysheet_sort_initial = true;\n        $('#luckysheetorderby').click(function () {\n            if (!checkProtectionAuthorityNormal(Store.currentSheetIndex, 'sort')) {\n                return;\n            }\n            $('body .luckysheet-cols-menu').hide();\n            const locale_sort = _locale.sort;\n            if (Store.luckysheet_select_save.length > 1) {\n                if (isEditMode()) {\n                    alert(locale_sort.noRangeError);\n                } else {\n                    tooltip.info(locale_sort.noRangeError, '');\n                }\n                return;\n            }\n            let last = Store.luckysheet_select_save[0];\n            let r1 = last['row'][0], r2 = last['row'][1];\n            let c1 = last['column'][0], c2 = last['column'][1];\n            if (luckysheet_sort_initial) {\n                luckysheet_sort_initial = false;\n                let content = `<div style=\"overflow: hidden;\" class=\"luckysheet-sort-modal\"><div><label><input type=\"checkbox\" id=\"luckysheet-sort-haveheader\"/><span>${ locale_sort.hasTitle }</span></label></div><div style=\"overflow-y:auto;\" id=\"luckysheet-sort-dialog-tablec\"><table data-itemcount=\"0\" cellspacing=\"0\"> <tr><td>${ locale_sort.hasTitle } <select name=\"sort_0\"> <option value=\"1\">1</option> <option value=\"2\">2</option> <option value=\"3\">3</option> <option value=\"4\">4</option> </select> </td> <td> <div><label><input value=\"asc\" type=\"radio\" checked=\"checked\" name=\"sort_0\"><span>${ locale_sort.asc }A-Z</span></label></div> <div><label><input value=\"desc\" type=\"radio\" name=\"sort_0\"><span>${ locale_sort.desc }Z-A</span></label></div></td></tr></table></div><div style=\"background: #e5e5e5;border-top: 1px solid #f5f5f5; height: 1px; width: 100%;margin:2px 0px;margin-bottom:10px;\"></div> <div> <span style=\"font-weight: bold; text-decoration: underline;text-align:center;color: blue;cursor: pointer;\" class=\"luckysheet-sort-dialog-additem\">+ ${ locale_sort.addOthers }</span> </div> </div>`;\n                $('body').append(replaceHtml(modelHTML, {\n                    'id': 'luckysheet-sort-dialog',\n                    'addclass': '',\n                    'title': _locale.sort.sortTitle,\n                    'content': content,\n                    'botton': `<button id=\"luckysheet-sort-modal-confirm\" class=\"btn btn-primary\">${ locale_sort.confirm }</button><button class=\"btn btn-default luckysheet-model-close-btn\">${ locale_sort.close }</button>`\n                }));\n                $('#luckysheet-sort-dialog .luckysheet-sort-dialog-additem').click(function () {\n                    let last = Store.luckysheet_select_save[0];\n                    let r1 = last['row'][0], r2 = last['row'][1];\n                    let c1 = last['column'][0], c2 = last['column'][1];\n                    let option = '', i = $('#luckysheet-sort-dialog table').data('itemcount') + 1;\n                    let t = $('#luckysheet-sort-haveheader').is(':checked');\n                    for (let c = c1; c <= c2; c++) {\n                        if (t) {\n                            let v = getcellvalue(r1, c, Store.flowdata, 'm');\n                            if (v == null) {\n                                v = locale_sort.columnOperation + (c - c1 + 1);\n                            }\n                            option += '<option value=\"' + c + '\">' + v + '</option>';\n                        } else {\n                            option += '<option value=\"' + c + '\">' + chatatABC(c) + '</option>';\n                        }\n                    }\n                    $('#luckysheet-sort-dialog table').append(`\n                    <tr class=\"luckysheet-sort-dialog-tr\">\n                        <td><span class=\"luckysheet-sort-item-close\" onclick=\"$(this).parent().parent().remove();\"><i class=\"fa fa-times\"\n                                    aria-hidden=\"true\"></i></span>${ locale_sort.secondaryTitle } <select\n                                name=\"sort_${ i }\">${ option }</select> </td>\n                        <td>\n                            <div><label><input value=\"asc\" type=\"radio\" checked=\"checked\"\n                                        name=\"sort_${ i }\"><span>${ locale_sort.asc }A-Z</span></label></div>\n                            <div><label><input value=\"desc\" type=\"radio\" name=\"sort_${ i }\"><span>${ locale_sort.desc }Z-A</span></label>\n                            </div>\n                        </td>\n                    </tr>\n                `);\n                    $('#luckysheet-sort-dialog table').data('itemcount', i);\n                });\n                $('#luckysheet-sort-haveheader').change(function () {\n                    let last = Store.luckysheet_select_save[0];\n                    let r1 = last['row'][0], r2 = last['row'][1];\n                    let c1 = last['column'][0], c2 = last['column'][1];\n                    let t = $(this).is(':checked');\n                    let option = '';\n                    for (let c = c1; c <= c2; c++) {\n                        if (t) {\n                            let v = getcellvalue(r1, c, Store.flowdata, 'm');\n                            if (v == null) {\n                                v = locale_sort.columnOperation + (c - c1 + 1);\n                            }\n                            option += '<option value=\"' + c + '\">' + v + '</option>';\n                        } else {\n                            option += '<option value=\"' + c + '\">' + chatatABC(c) + '</option>';\n                        }\n                    }\n                    $('#luckysheet-sort-dialog tr select').each(function () {\n                        $(this).html(option);\n                    });\n                });    //Custom sort\n                //Custom sort\n                $('#luckysheet-sort-modal-confirm').click(function () {\n                    if (Store.luckysheet_select_save.length > 1) {\n                        if (isEditMode()) {\n                            alert(locale_sort.noRangeError);\n                        } else {\n                            tooltip.info(locale_sort.noRangeError, '');\n                        }\n                        return;\n                    }\n                    let d = Store.deepCopyFlowData(Store.flowdata);\n                    let last = Store.luckysheet_select_save[0];\n                    let r1 = last['row'][0], r2 = last['row'][1];\n                    let c1 = last['column'][0], c2 = last['column'][1];    //Data has header row\n                    //Data has header row\n                    let t = $('#luckysheet-sort-haveheader').is(':checked');\n                    let str;\n                    if (t) {\n                        str = r1 + 1;\n                    } else {\n                        str = r1;\n                    }\n                    let hasMc = false;    //Whether the sort selection has merged cells\n                    //Whether the sort selection has merged cells\n                    let data = [];\n                    for (let r = str; r <= r2; r++) {\n                        let data_row = [];\n                        for (let c = c1; c <= c2; c++) {\n                            if (d[r][c] != null && d[r][c].mc != null) {\n                                hasMc = true;\n                                break;\n                            }\n                            data_row.push(d[r][c]);\n                        }\n                        data.push(data_row);\n                    }\n                    if (hasMc) {\n                        if (isEditMode()) {\n                            alert(locale_sort.mergeError);\n                        } else {\n                            tooltip.info(locale_sort.mergeError, '');\n                        }\n                        return;\n                    }\n                    $($('#luckysheet-sort-dialog table tr').toArray().reverse()).each(function () {\n                        let i = $(this).find('select').val(), asc = $(this).find('input:radio:checked').val();\n                        i -= c1;\n                        if (asc == 'asc') {\n                            asc = true;\n                        } else {\n                            asc = false;\n                        }\n                        data = orderbydata([].concat(data), i, asc);\n                    });\n                    for (let r = str; r <= r2; r++) {\n                        for (let c = c1; c <= c2; c++) {\n                            d[r][c] = data[r - str][c - c1];\n                        }\n                    }\n                    let allParam = {};\n                    if (Store.config['rowlen'] != null) {\n                        let cfg = $.extend(true, {}, Store.config);\n                        cfg = rowlenByRange(d, str, r2, cfg);\n                        allParam = {\n                            'cfg': cfg,\n                            'RowlChange': true\n                        };\n                    }\n                    ///jfrefreshgrid(d, [{\n                    Store.refreshRange(d, [{\n                            'row': [\n                                str,\n                                r2\n                            ],\n                            'column': [\n                                c1,\n                                c2\n                            ]\n                        }], allParam);\n                    $('#luckysheet-sort-dialog').hide();\n                    $('#luckysheet-modal-dialog-mask').hide();\n                });\n            }\n            let option = '';\n            for (let c = c1; c <= c2; c++) {\n                option += '<option value=\"' + c + '\">' + chatatABC(c) + '</option>';\n            }\n            $('#luckysheet-sort-dialog select').html(option);\n            $('#luckysheet-sort-dialog .luckysheet-sort-dialog-tr').remove();\n            $('#luckysheet-sort-haveheader').prop('checked', false);\n            $('#luckysheet-sort-dialog input:radio:first').prop('checked', 'checked');\n            $('#luckysheet-sort-dialog .luckysheet-modal-dialog-title-text').html(locale_sort.sortRangeTitle + '<span>' + chatatABC(c1) + (r1 + 1) + '</span>' + locale_sort.sortRangeTitleTo + '<span>' + chatatABC(c2) + (r2 + 1) + '</span>');\n            let $t = $('#luckysheet-sort-dialog'), myh = $t.outerHeight(), myw = $t.outerWidth();\n            let winw = $(window).width(), winh = $(window).height();\n            let scrollLeft = $(document).scrollLeft(), scrollTop = $(document).scrollTop();\n            $('#luckysheet-sort-dialog-tablec').css('max-height', (winh - myh) / 2);\n            $('#luckysheet-sort-dialog').css({\n                'left': (winw + scrollLeft - myw) / 2,\n                'top': (winh + scrollTop - myh) / 2\n            }).show();\n            $('#luckysheet-modal-dialog-mask').show();\n            if (r1 < r2) {\n                setTimeout(function () {\n                    let flowrowdata1 = Store.flowdata[r1], flowrowdata2 = Store.flowdata[r1 + 1], hastitle = false;\n                    for (let i = c1; i <= c2; i++) {\n                        let isdatatype_r1 = isdatatype(flowrowdata1[i]), isdatatype_r2 = isdatatype(flowrowdata2[i]);\n                        if (isdatatype_r1 != isdatatype_r2) {\n                            hastitle = true;\n                        }\n                    }\n                    if (hastitle) {\n                        $('#luckysheet-sort-haveheader').prop('checked', true).change();\n                    }\n                }, 10);\n            }\n        });\n    }\n    return { orderByInitial: orderByInitial };\n});"]}