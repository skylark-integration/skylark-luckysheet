{"version":3,"sources":["controllers/postil.js"],"names":["define","m_location","m_cursorPos","m_set","m_get","m_util","cells","m_protection","Store","luckysheetConfigsetting","rowLocation","colLocation","mouseposition","luckysheetRangeLast","setluckysheet_scroll_status","getSheetIndex","getObjType","checkProtectionAuthorityNormal","defaultWidth","defaultHeight","currentObj","currentWinW","currentWinH","resize","resizeXY","move","moveXY","init","_this","this","$","off","on","event","currentSheetIndex","find","hasClass","stopPropagation","removeActivePs","addClass","show","css","which","closest","scrollWidth","scrollHeight","data","scrollTop","scrollLeft","mouse","pageX","pageY","x","y","position","width","height","left","top","offset","overshow","remove","target","length","offsetX","offsetY","freezenverticaldata","freezenhorizontaldata","row_index","col_index","margeset","mergeborer","flowdata","row","column","ps","postil","value","visibledatarow","row_pre","col","visibledatacolumn","col_pre","toX","toY","fromX","zoomRatio","fromY","size","getArrowCanvasSize","html","htmlEscape","appendTo","ctx","get","getContext","drawArrow","Math","abs","x1","x2","y1","y2","theta","headlen","color","angle","atan2","PI","angle1","angle2","topX","cos","topY","sin","botX","botY","save","beginPath","arrowX","arrowY","moveTo","lineTo","lineWidth","strokeStyle","stroke","fillStyle","fill","restore","buildAllPs","empty","r","c","buildPs","newPs","createHookFunction","focus","d","deepCopyFlowData","rc","isshow","push","ref","setTimeout","editPs","delPs","showHidePs","showHideAllPs","isAllShow","allPs","i","rowIndex","split","colIndex","id","attr","text","previousCell","extend","removeClass","hide","clearjfundo","jfundo","jfredo","type","curdata","sheetIndex","webWorkerFlowDataCache","luckysheetfile","allowUpdate","saveParam","refresh","positionSync","each","e","cell","replace","match","pos","originalText","console","log"],"mappings":"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","file":"../../controllers/postil.js","sourcesContent":["define([\n    '../methods/location',\n    '../widgets/cursorPos',\n    '../methods/set',\n    '../methods/get',\n    '../utils/util',\n    '../methods/cells',\n    '../methods/protection_methods',\n    '../store',\n    '../methods/luckysheetConfigsetting'\n], function (m_location, m_cursorPos, m_set, m_get, m_util, cells, m_protection, Store, luckysheetConfigsetting) {\n    'use strict';\n    const {rowLocation, colLocation, mouseposition} = m_location;\n    const {luckysheetRangeLast} = m_cursorPos;\n    const {setluckysheet_scroll_status} = m_set;\n    const {getSheetIndex} = m_get;\n    const {getObjType} = m_util;\n    const {checkProtectionAuthorityNormal} = m_protection;\n    //批注\n    const luckysheetPostil = {\n        defaultWidth: 144,\n        defaultHeight: 84,\n        currentObj: null,\n        currentWinW: null,\n        currentWinH: null,\n        resize: null,\n        resizeXY: null,\n        move: false,\n        moveXY: null,\n        init: function () {\n            let _this = this;\n            //点击批注框 聚焦\n            $('#luckysheet-postil-showBoxs').off('mousedown.showPs').on('mousedown.showPs', '.luckysheet-postil-show', function (event) {\n                if (!checkProtectionAuthorityNormal(Store.currentSheetIndex, 'editObjects', false)) {\n                    return;\n                }\n                _this.currentObj = $(this).find('.luckysheet-postil-show-main');\n                if ($(this).hasClass('luckysheet-postil-show-active')) {\n                    event.stopPropagation();\n                    return;\n                }\n                _this.removeActivePs();\n                $(this).addClass('luckysheet-postil-show-active');\n                $(this).find('.luckysheet-postil-dialog-resize').show();\n                $(this).find('.arrowCanvas').css('z-index', 200);\n                $(this).find('.luckysheet-postil-show-main').css('z-index', 200);\n                event.stopPropagation();\n            });\n            $('#luckysheet-postil-showBoxs').off('mouseup.showPs').on('mouseup.showPs', '.luckysheet-postil-show', function (event) {\n                if (event.which == '3') {\n                    event.stopPropagation();\n                }\n            }); \n            //批注框 改变大小\n            $('#luckysheet-postil-showBoxs').off('mousedown.resize').on('mousedown.resize', '.luckysheet-postil-show .luckysheet-postil-dialog-resize .luckysheet-postil-dialog-resize-item', function (event) {\n                if (!checkProtectionAuthorityNormal(Store.currentSheetIndex, 'editObjects', false)) {\n                    return;\n                }\n                _this.currentObj = $(this).closest('.luckysheet-postil-show-main');\n                _this.currentWinW = $('#luckysheet-cell-main')[0].scrollWidth;\n                _this.currentWinH = $('#luckysheet-cell-main')[0].scrollHeight;\n                _this.resize = $(this).data('type');\n                let scrollTop = $('#luckysheet-cell-main').scrollTop(), scrollLeft = $('#luckysheet-cell-main').scrollLeft();\n                let mouse = mouseposition(event.pageX, event.pageY);\n                let x = mouse[0] + scrollLeft;\n                let y = mouse[1] + scrollTop;\n                let position = _this.currentObj.position();\n                let width = _this.currentObj.width();\n                let height = _this.currentObj.height();\n                _this.resizeXY = [\n                    x,\n                    y,\n                    width,\n                    height,\n                    position.left + scrollLeft,\n                    position.top + scrollTop,\n                    scrollLeft,\n                    scrollTop\n                ];\n                setluckysheet_scroll_status(true);\n                if ($(this).closest('.luckysheet-postil-show').hasClass('luckysheet-postil-show-active')) {\n                    event.stopPropagation();\n                    return;\n                }\n                _this.removeActivePs();\n                $(this).closest('.luckysheet-postil-show').addClass('luckysheet-postil-show-active');\n                $(this).closest('.luckysheet-postil-show').find('.luckysheet-postil-dialog-resize').show();\n                $(this).closest('.luckysheet-postil-show').find('.arrowCanvas').css('z-index', 200);\n                $(this).closest('.luckysheet-postil-show').find('.luckysheet-postil-show-main').css('z-index', 200);\n                event.stopPropagation();\n            });\n            //批注框 移动\n            $('#luckysheet-postil-showBoxs').off('mousedown.move').on('mousedown.move', '.luckysheet-postil-show .luckysheet-postil-dialog-move .luckysheet-postil-dialog-move-item', function (event) {\n                if (!checkProtectionAuthorityNormal(Store.currentSheetIndex, 'editObjects', false)) {\n                    return;\n                }\n                _this.currentObj = $(this).closest('.luckysheet-postil-show-main');\n                _this.currentWinW = $('#luckysheet-cell-main')[0].scrollWidth;\n                _this.currentWinH = $('#luckysheet-cell-main')[0].scrollHeight;\n                _this.move = true;\n                let scrollTop = $('#luckysheet-cell-main').scrollTop(), scrollLeft = $('#luckysheet-cell-main').scrollLeft();\n                let offset = _this.currentObj.offset();\n                let position = _this.currentObj.position();\n                _this.moveXY = [\n                    event.pageX - offset.left,\n                    event.pageY - offset.top,\n                    position.left,\n                    position.top,\n                    scrollLeft,\n                    scrollTop\n                ];\n                setluckysheet_scroll_status(true);\n                if ($(this).closest('.luckysheet-postil-show').hasClass('luckysheet-postil-show-active')) {\n                    event.stopPropagation();\n                    return;\n                }\n                _this.removeActivePs();\n                $(this).closest('.luckysheet-postil-show').addClass('luckysheet-postil-show-active');\n                $(this).closest('.luckysheet-postil-show').find('.luckysheet-postil-dialog-resize').show();\n                $(this).closest('.luckysheet-postil-show').find('.arrowCanvas').css('z-index', 200);\n                $(this).closest('.luckysheet-postil-show').find('.luckysheet-postil-show-main').css('z-index', 200);\n                event.stopPropagation();\n            });\n        },\n        overshow: function (event) {\n            let _this = this;\n            $('#luckysheet-postil-overshow').remove();\n            if ($(event.target).closest('#luckysheet-cell-main').length == 0) {\n                return;\n            }\n            let mouse = mouseposition(event.pageX, event.pageY);\n            let scrollLeft = $('#luckysheet-cell-main').scrollLeft();\n            let scrollTop = $('#luckysheet-cell-main').scrollTop();\n            let x = mouse[0];\n            let y = mouse[1];\n            let offsetX = 0;\n            let offsetY = 0;\n            if (Store.freezenverticaldata != null && mouse[0] < Store.freezenverticaldata[0] - Store.freezenverticaldata[2]) {\n                offsetX = scrollLeft;\n            } else {\n                x += scrollLeft;\n            }\n            if (Store.freezenhorizontaldata != null && mouse[1] < Store.freezenhorizontaldata[0] - Store.freezenhorizontaldata[2]) {\n                offsetY = scrollTop;\n            } else {\n                y += scrollTop;\n            }\n            let row_index = rowLocation(y)[2];\n            let col_index = colLocation(x)[2];\n            let margeset = cells.mergeborer(Store.flowdata, row_index, col_index);\n            if (!!margeset) {\n                row_index = margeset.row[2];\n                col_index = margeset.column[2];\n            }\n            if (Store.flowdata[row_index] == null || Store.flowdata[row_index][col_index] == null || Store.flowdata[row_index][col_index].ps == null) {\n                return;\n            }\n            let postil = Store.flowdata[row_index][col_index].ps;\n            if (postil['isshow'] || $('#luckysheet-postil-show_' + row_index + '_' + col_index).length > 0) {\n                return;\n            }\n            let value = postil['value'] == null ? '' : postil['value'];\n            let row = Store.visibledatarow[row_index], row_pre = row_index - 1 == -1 ? 0 : Store.visibledatarow[row_index - 1];\n            let col = Store.visibledatacolumn[col_index], col_pre = col_index - 1 == -1 ? 0 : Store.visibledatacolumn[col_index - 1];\n            if (!!margeset) {\n                row = margeset.row[1];\n                row_pre = margeset.row[0];\n                col = margeset.column[1];\n                col_pre = margeset.column[0];\n            }\n            let toX = col + offsetX;\n            let toY = row_pre + offsetY;\n            let fromX = toX + 18 * Store.zoomRatio;\n            let fromY = toY - 18 * Store.zoomRatio;\n            if (fromY < 0) {\n                fromY = 2;\n            }\n            let width = _this.defaultWidth * Store.zoomRatio;\n            let height = _this.defaultHeight * Store.zoomRatio;\n            let size = _this.getArrowCanvasSize(fromX, fromY, toX, toY);\n            let html = '<div id=\"luckysheet-postil-overshow\">' + '<canvas class=\"arrowCanvas\" width=\"' + size[2] + '\" height=\"' + size[3] + '\" style=\"position:absolute;left:' + size[0] + 'px;top:' + size[1] + 'px;z-index:100;pointer-events:none;\"></canvas>' + '<div style=\"width:' + (width - 12) + 'px;min-height:' + (height - 12) + 'px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:' + fromX + 'px;top:' + fromY + 'px;z-index:100;\">' + _this.htmlEscape(value) + '</div>' + '</div>';\n            $(html).appendTo($('#luckysheet-cell-main'));\n            let ctx = $('#luckysheet-postil-overshow .arrowCanvas').get(0).getContext('2d');\n            _this.drawArrow(ctx, size[4], size[5], size[6], size[7]);\n        },\n        getArrowCanvasSize: function (fromX, fromY, toX, toY) {\n            let left = toX - 5;\n            if (fromX < toX) {\n                left = fromX - 5;\n            }\n            let top = toY - 5;\n            if (fromY < toY) {\n                top = fromY - 5;\n            }\n            let width = Math.abs(fromX - toX) + 10;\n            let height = Math.abs(fromY - toY) + 10;\n            let x1 = width - 5;\n            let x2 = 5;\n            if (fromX < toX) {\n                x1 = 5;\n                x2 = width - 5;\n            }\n            let y1 = height - 5;\n            let y2 = 5;\n            if (fromY < toY) {\n                y1 = 5;\n                y2 = height - 5;\n            }\n            return [\n                left,\n                top,\n                width,\n                height,\n                x1,\n                y1,\n                x2,\n                y2\n            ];\n        },\n        drawArrow: function (ctx, fromX, fromY, toX, toY, theta, headlen, width, color) {\n            theta = getObjType(theta) == 'undefined' ? 30 : theta;\n            headlen = getObjType(headlen) == 'undefined' ? 6 : headlen;\n            width = getObjType(width) == 'undefined' ? 1 : width;\n            color = getObjType(color) == 'undefined' ? '#000' : color;    // 计算各角度和对应的P2,P3坐标\n            // 计算各角度和对应的P2,P3坐标\n            let angle = Math.atan2(fromY - toY, fromX - toX) * 180 / Math.PI, angle1 = (angle + theta) * Math.PI / 180, angle2 = (angle - theta) * Math.PI / 180, topX = headlen * Math.cos(angle1), topY = headlen * Math.sin(angle1), botX = headlen * Math.cos(angle2), botY = headlen * Math.sin(angle2);\n            ctx.save();\n            ctx.beginPath();\n            let arrowX = fromX - topX, arrowY = fromY - topY;\n            ctx.moveTo(arrowX, arrowY);\n            ctx.moveTo(fromX, fromY);\n            ctx.lineTo(toX, toY);\n            ctx.lineWidth = width;\n            ctx.strokeStyle = color;\n            ctx.stroke();\n            arrowX = toX + topX;\n            arrowY = toY + topY;\n            ctx.moveTo(arrowX, arrowY);\n            ctx.lineTo(toX, toY);\n            arrowX = toX + botX;\n            arrowY = toY + botY;\n            ctx.lineTo(arrowX, arrowY);\n            ctx.fillStyle = color;\n            ctx.fill();\n            ctx.restore();\n        },\n        buildAllPs: function (data) {\n            let _this = this;\n            $('#luckysheet-cell-main #luckysheet-postil-showBoxs').empty();\n            for (let r = 0; r < data.length; r++) {\n                for (let c = 0; c < data[0].length; c++) {\n                    if (data[r][c] != null && data[r][c].ps != null) {\n                        let postil = data[r][c].ps;\n                        _this.buildPs(r, c, postil);\n                    }\n                }\n            }\n            _this.init();\n        },\n        buildPs: function (r, c, postil) {\n            if ($('#luckysheet-postil-show_' + r + '_' + c).length > 0) {\n                $('#luckysheet-postil-show_' + r + '_' + c).remove();\n            }\n            if (postil == null) {\n                return;\n            }\n            let _this = this;\n            let isshow = postil['isshow'] == null ? false : postil['isshow'];\n            if (isshow) {\n                let row = Store.visibledatarow[r], row_pre = r - 1 == -1 ? 0 : Store.visibledatarow[r - 1];\n                let col = Store.visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : Store.visibledatacolumn[c - 1];\n                let margeset = cells.mergeborer(Store.flowdata, r, c);\n                if (!!margeset) {\n                    row = margeset.row[1];\n                    row_pre = margeset.row[0];\n                    col = margeset.column[1];\n                    col_pre = margeset.column[0];\n                }\n                let toX = col;\n                let toY = row_pre;\n                let left = postil['left'] == null ? toX + 18 * Store.zoomRatio : postil['left'] * Store.zoomRatio;\n                let top = postil['top'] == null ? toY - 18 * Store.zoomRatio : postil['top'] * Store.zoomRatio;\n                let width = postil['width'] == null ? _this.defaultWidth * Store.zoomRatio : postil['width'] * Store.zoomRatio;\n                let height = postil['height'] == null ? _this.defaultHeight * Store.zoomRatio : postil['height'] * Store.zoomRatio;\n                let value = postil['value'] == null ? '' : postil['value'];\n                if (top < 0) {\n                    top = 2;\n                }\n                let size = _this.getArrowCanvasSize(left, top, toX, toY);\n                let html = '<div id=\"luckysheet-postil-show_' + r + '_' + c + '\" class=\"luckysheet-postil-show\">' + '<canvas class=\"arrowCanvas\" width=\"' + size[2] + '\" height=\"' + size[3] + '\" style=\"position:absolute;left:' + size[0] + 'px;top:' + size[1] + 'px;z-index:100;pointer-events:none;\"></canvas>' + '<div class=\"luckysheet-postil-show-main\" style=\"width:' + width + 'px;height:' + height + 'px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:' + left + 'px;top:' + top + 'px;box-sizing:border-box;z-index:100;\">' + '<div class=\"luckysheet-postil-dialog-move\">' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t\" data-type=\"t\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r\" data-type=\"r\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b\" data-type=\"b\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l\" data-type=\"l\"></div>' + '</div>' + '<div class=\"luckysheet-postil-dialog-resize\" style=\"display:none;\">' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt\" data-type=\"lt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt\" data-type=\"mt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm\" data-type=\"lm\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm\" data-type=\"rm\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt\" data-type=\"rt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb\" data-type=\"lb\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb\" data-type=\"mb\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb\" data-type=\"rb\"></div>' + '</div>' + '<div style=\"width:100%;height:100%;overflow:hidden;\">' + '<div class=\"formulaInputFocus\" style=\"width:' + (width - 12) + 'px;height:' + (height - 12) + 'px;line-height:20px;box-sizing:border-box;text-align: center;;word-break:break-all;\" spellcheck=\"false\" contenteditable=\"true\">' + _this.htmlEscape(value) + '</div>' + '</div>' + '</div>' + '</div>';\n                $(html).appendTo($('#luckysheet-cell-main #luckysheet-postil-showBoxs'));\n                let ctx = $('#luckysheet-postil-show_' + r + '_' + c + ' .arrowCanvas').get(0).getContext('2d');\n                _this.drawArrow(ctx, size[4], size[5], size[6], size[7]);\n            }\n        },\n        newPs: function (r, c) {\n            if (!checkProtectionAuthorityNormal(Store.currentSheetIndex, 'editObjects')) {\n                return;\n            }    // Hook function\n            // Hook function\n            if (!luckysheetConfigsetting.createHookFunction('commentInsertBefore', r, c)) {\n                return;\n            }\n            let _this = this;\n            let row = Store.visibledatarow[r], row_pre = r - 1 == -1 ? 0 : Store.visibledatarow[r - 1];\n            let col = Store.visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : Store.visibledatacolumn[c - 1];\n            let margeset = cells.mergeborer(Store.flowdata, r, c);\n            if (!!margeset) {\n                row = margeset.row[1];\n                row_pre = margeset.row[0];\n                col = margeset.column[1];\n                col_pre = margeset.column[0];\n            }\n            let toX = col;\n            let toY = row_pre;\n            let fromX = toX + 18 * Store.zoomRatio;\n            let fromY = toY - 18 * Store.zoomRatio;\n            if (fromY < 0) {\n                fromY = 2;\n            }\n            let width = _this.defaultWidth * Store.zoomRatio;\n            let height = _this.defaultHeight * Store.zoomRatio;\n            let size = _this.getArrowCanvasSize(fromX, fromY, toX, toY);\n            let html = '<div id=\"luckysheet-postil-show_' + r + '_' + c + '\" class=\"luckysheet-postil-show luckysheet-postil-show-active\">' + '<canvas class=\"arrowCanvas\" width=\"' + size[2] + '\" height=\"' + size[3] + '\" style=\"position:absolute;left:' + size[0] + 'px;top:' + size[1] + 'px;z-index:100;pointer-events:none;\"></canvas>' + '<div class=\"luckysheet-postil-show-main\" style=\"width:' + width + 'px;height:' + height + 'px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:' + fromX + 'px;top:' + fromY + 'px;box-sizing:border-box;z-index:100;\">' + '<div class=\"luckysheet-postil-dialog-move\">' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t\" data-type=\"t\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r\" data-type=\"r\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b\" data-type=\"b\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l\" data-type=\"l\"></div>' + '</div>' + '<div class=\"luckysheet-postil-dialog-resize\">' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt\" data-type=\"lt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt\" data-type=\"mt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm\" data-type=\"lm\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm\" data-type=\"rm\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt\" data-type=\"rt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb\" data-type=\"lb\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb\" data-type=\"mb\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb\" data-type=\"rb\"></div>' + '</div>' + '<div style=\"width:100%;height:100%;overflow:hidden;\">' + '<div class=\"formulaInputFocus\" style=\"width:132px;height:72px;line-height:20px;box-sizing:border-box;text-align: center;word-break:break-all;\" spellcheck=\"false\" contenteditable=\"true\">' + '</div>' + '</div>' + '</div>' + '</div>';\n            $(html).appendTo($('#luckysheet-cell-main #luckysheet-postil-showBoxs'));\n            let ctx = $('#luckysheet-postil-show_' + r + '_' + c + ' .arrowCanvas').get(0).getContext('2d');\n            _this.drawArrow(ctx, size[4], size[5], size[6], size[7]);\n            $('#luckysheet-postil-show_' + r + '_' + c + ' .formulaInputFocus').focus();\n            _this.init();\n            let d = Store.deepCopyFlowData(Store.flowdata);\n            let rc = [];\n            if (d[r][c] == null) {\n                d[r][c] = {};\n            }\n            d[r][c].ps = {\n                'left': null,\n                'top': null,\n                'width': null,\n                'height': null,\n                'value': '',\n                'isshow': false\n            };\n            rc.push(r + '_' + c);\n            _this.ref(d, rc);    // Hook function\n            // Hook function\n            setTimeout(() => {\n                luckysheetConfigsetting.createHookFunction('commentInsertAfter', r, c, d[r][c]);\n            }, 0);\n        },\n        editPs: function (r, c) {\n            let _this = this;\n            if (!checkProtectionAuthorityNormal(Store.currentSheetIndex, 'editObjects')) {\n                return;\n            }\n            if ($('#luckysheet-postil-show_' + r + '_' + c).length > 0) {\n                $('#luckysheet-postil-show_' + r + '_' + c).show();\n                $('#luckysheet-postil-show_' + r + '_' + c).addClass('luckysheet-postil-show-active');\n                $('#luckysheet-postil-show_' + r + '_' + c).find('.luckysheet-postil-dialog-resize').show();\n            } else {\n                let postil = Store.flowdata[r][c].ps;\n                let row = Store.visibledatarow[r], row_pre = r - 1 == -1 ? 0 : Store.visibledatarow[r - 1];\n                let col = Store.visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : Store.visibledatacolumn[c - 1];\n                let margeset = cells.mergeborer(Store.flowdata, r, c);\n                if (!!margeset) {\n                    row = margeset.row[1];\n                    row_pre = margeset.row[0];\n                    col = margeset.column[1];\n                    col_pre = margeset.column[0];\n                }\n                let toX = col;\n                let toY = row_pre;\n                let left = postil['left'] == null ? toX + 18 * Store.zoomRatio : postil['left'] * Store.zoomRatio;\n                let top = postil['top'] == null ? toY - 18 * Store.zoomRatio : postil['top'] * Store.zoomRatio;\n                let width = postil['width'] == null ? _this.defaultWidth * Store.zoomRatio : postil['width'] * Store.zoomRatio;\n                let height = postil['height'] == null ? _this.defaultHeight * Store.zoomRatio : postil['height'] * Store.zoomRatio;\n                let value = postil['value'] == null ? '' : postil['value'];\n                if (top < 0) {\n                    top = 2;\n                }\n                let size = _this.getArrowCanvasSize(left, top, toX, toY);\n                let html = '<div id=\"luckysheet-postil-show_' + r + '_' + c + '\" class=\"luckysheet-postil-show luckysheet-postil-show-active\">' + '<canvas class=\"arrowCanvas\" width=\"' + size[2] + '\" height=\"' + size[3] + '\" style=\"position:absolute;left:' + size[0] + 'px;top:' + size[1] + 'px;z-index:100;pointer-events:none;\"></canvas>' + '<div class=\"luckysheet-postil-show-main\" style=\"width:' + width + 'px;height:' + height + 'px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:' + left + 'px;top:' + top + 'px;box-sizing:border-box;z-index:100;\">' + '<div class=\"luckysheet-postil-dialog-move\">' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t\" data-type=\"t\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r\" data-type=\"r\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b\" data-type=\"b\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l\" data-type=\"l\"></div>' + '</div>' + '<div class=\"luckysheet-postil-dialog-resize\">' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt\" data-type=\"lt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt\" data-type=\"mt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm\" data-type=\"lm\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm\" data-type=\"rm\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt\" data-type=\"rt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb\" data-type=\"lb\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb\" data-type=\"mb\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb\" data-type=\"rb\"></div>' + '</div>' + '<div style=\"width:100%;height:100%;overflow:hidden;\">' + '<div class=\"formulaInputFocus\" style=\"width:' + (width - 12) + 'px;height:' + (height - 12) + 'px;line-height:20px;box-sizing:border-box;text-align: center;;word-break:break-all;\" spellcheck=\"false\" contenteditable=\"true\">' + _this.htmlEscape(value) + '</div>' + '</div>' + '</div>' + '</div>';\n                $(html).appendTo($('#luckysheet-cell-main #luckysheet-postil-showBoxs'));\n                let ctx = $('#luckysheet-postil-show_' + r + '_' + c + ' .arrowCanvas').get(0).getContext('2d');\n                _this.drawArrow(ctx, size[4], size[5], size[6], size[7]);\n            }\n            $('#luckysheet-postil-show_' + r + '_' + c + ' .formulaInputFocus').focus();\n            luckysheetRangeLast($('#luckysheet-postil-show_' + r + '_' + c + ' .formulaInputFocus').get(0));\n            _this.init();\n        },\n        delPs: function (r, c) {\n            if (!checkProtectionAuthorityNormal(Store.currentSheetIndex, 'editObjects')) {\n                return;\n            }    // Hook function\n            // Hook function\n            if (!luckysheetConfigsetting.createHookFunction('commentDeleteBefore', r, c, Store.flowdata[r][c])) {\n                return;\n            }\n            if ($('#luckysheet-postil-show_' + r + '_' + c).length > 0) {\n                $('#luckysheet-postil-show_' + r + '_' + c).remove();\n            }\n            let d = Store.deepCopyFlowData(Store.flowdata);\n            let rc = [];\n            delete d[r][c].ps;\n            rc.push(r + '_' + c);\n            this.ref(d, rc);    // Hook function\n            // Hook function\n            setTimeout(() => {\n                luckysheetConfigsetting.createHookFunction('commentDeleteAfter', r, c, Store.flowdata[r][c]);\n            }, 0);\n        },\n        showHidePs: function (r, c) {\n            let _this = this;\n            let postil = Store.flowdata[r][c].ps;\n            let isshow = postil['isshow'];\n            let d = Store.deepCopyFlowData(Store.flowdata);\n            let rc = [];\n            if (isshow) {\n                d[r][c].ps.isshow = false;\n                $('#luckysheet-postil-show_' + r + '_' + c).remove();\n            } else {\n                d[r][c].ps.isshow = true;\n                let row = Store.visibledatarow[r], row_pre = r - 1 == -1 ? 0 : Store.visibledatarow[r - 1];\n                let col = Store.visibledatacolumn[c], col_pre = c - 1 == -1 ? 0 : Store.visibledatacolumn[c - 1];\n                let margeset = cells.mergeborer(Store.flowdata, r, c);\n                if (!!margeset) {\n                    row = margeset.row[1];\n                    row_pre = margeset.row[0];\n                    col = margeset.column[1];\n                    col_pre = margeset.column[0];\n                }\n                let scrollLeft = $('#luckysheet-cell-main').scrollLeft();\n                let scrollTop = $('#luckysheet-cell-main').scrollTop();\n                let toX = col;\n                let toY = row_pre;\n                if (Store.freezenverticaldata != null && toX < Store.freezenverticaldata[0] - Store.freezenverticaldata[2]) {\n                    toX += scrollLeft;\n                }\n                if (Store.freezenhorizontaldata != null && toY < Store.freezenhorizontaldata[0] - Store.freezenhorizontaldata[2]) {\n                    toY += scrollTop;\n                }\n                let left = postil['left'] == null ? toX + 18 * Store.zoomRatio : postil['left'] * Store.zoomRatio;\n                let top = postil['top'] == null ? toY - 18 * Store.zoomRatio : postil['top'] * Store.zoomRatio;\n                let width = postil['width'] == null ? _this.defaultWidth * Store.zoomRatio : postil['width'] * Store.zoomRatio;\n                let height = postil['height'] == null ? _this.defaultHeight * Store.zoomRatio : postil['height'] * Store.zoomRatio;\n                let value = postil['value'] == null ? '' : postil['value'];\n                if (top < 0) {\n                    top = 2;\n                }\n                let size = _this.getArrowCanvasSize(left, top, toX, toY);\n                let html = '<div id=\"luckysheet-postil-show_' + r + '_' + c + '\" class=\"luckysheet-postil-show\">' + '<canvas class=\"arrowCanvas\" width=\"' + size[2] + '\" height=\"' + size[3] + '\" style=\"position:absolute;left:' + size[0] + 'px;top:' + size[1] + 'px;z-index:100;pointer-events:none;\"></canvas>' + '<div class=\"luckysheet-postil-show-main\" style=\"width:' + width + 'px;height:' + height + 'px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:' + left + 'px;top:' + top + 'px;box-sizing:border-box;z-index:100;\">' + '<div class=\"luckysheet-postil-dialog-move\">' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t\" data-type=\"t\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r\" data-type=\"r\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b\" data-type=\"b\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l\" data-type=\"l\"></div>' + '</div>' + '<div class=\"luckysheet-postil-dialog-resize\" style=\"display:none;\">' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt\" data-type=\"lt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt\" data-type=\"mt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm\" data-type=\"lm\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm\" data-type=\"rm\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt\" data-type=\"rt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb\" data-type=\"lb\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb\" data-type=\"mb\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb\" data-type=\"rb\"></div>' + '</div>' + '<div style=\"width:100%;height:100%;overflow:hidden;\">' + '<div class=\"formulaInputFocus\" style=\"width:' + (width - 12) + 'px;height:' + (height - 12) + 'px;line-height:20px;box-sizing:border-box;text-align: center;;word-break:break-all;\" spellcheck=\"false\" contenteditable=\"true\">' + _this.htmlEscape(value) + '</div>' + '</div>' + '</div>' + '</div>';\n                $(html).appendTo($('#luckysheet-cell-main #luckysheet-postil-showBoxs'));\n                let ctx = $('#luckysheet-postil-show_' + r + '_' + c + ' .arrowCanvas').get(0).getContext('2d');\n                _this.drawArrow(ctx, size[4], size[5], size[6], size[7]);\n                _this.init();\n            }\n            rc.push(r + '_' + c);\n            _this.ref(d, rc);\n        },\n        showHideAllPs: function () {\n            let _this = this;\n            let d = Store.deepCopyFlowData(Store.flowdata);\n            let isAllShow = true;\n            let allPs = [];\n            for (let r = 0; r < d.length; r++) {\n                for (let c = 0; c < d[0].length; c++) {\n                    if (d[r] != null && d[r][c] != null && d[r][c].ps != null) {\n                        allPs.push(r + '_' + c);\n                        if (!d[r][c].ps.isshow) {\n                            isAllShow = false;\n                        }\n                    }\n                }\n            }\n            let rc = [];\n            if (allPs.length > 0) {\n                if (isAllShow) {\n                    //全部显示，操作为隐藏所有批注\n                    $('#luckysheet-cell-main #luckysheet-postil-showBoxs').empty();\n                    for (let i = 0; i < allPs.length; i++) {\n                        let rowIndex = allPs[i].split('_')[0];\n                        let colIndex = allPs[i].split('_')[1];\n                        let postil = d[rowIndex][colIndex].ps;\n                        if (postil['isshow']) {\n                            d[rowIndex][colIndex].ps.isshow = false;\n                            rc.push(allPs[i]);\n                        }\n                    }\n                } else {\n                    //部分显示或全部隐藏，操作位显示所有批注\n                    for (let i = 0; i < allPs.length; i++) {\n                        let rowIndex = allPs[i].split('_')[0];\n                        let colIndex = allPs[i].split('_')[1];\n                        let postil = d[rowIndex][colIndex].ps;\n                        if (!postil['isshow']) {\n                            let row = Store.visibledatarow[rowIndex], row_pre = rowIndex - 1 == -1 ? 0 : Store.visibledatarow[rowIndex - 1];\n                            let col = Store.visibledatacolumn[colIndex], col_pre = colIndex - 1 == -1 ? 0 : Store.visibledatacolumn[colIndex - 1];\n                            let margeset = cells.mergeborer(Store.flowdata, rowIndex, colIndex);\n                            if (!!margeset) {\n                                row = margeset.row[1];\n                                row_pre = margeset.row[0];\n                                col = margeset.column[1];\n                                col_pre = margeset.column[0];\n                            }\n                            let scrollLeft = $('#luckysheet-cell-main').scrollLeft();\n                            let scrollTop = $('#luckysheet-cell-main').scrollTop();\n                            let toX = col;\n                            let toY = row_pre;\n                            if (Store.freezenverticaldata != null && toX < Store.freezenverticaldata[0] - Store.freezenverticaldata[2]) {\n                                toX += scrollLeft;\n                            }\n                            if (Store.freezenhorizontaldata != null && toY < Store.freezenhorizontaldata[0] - Store.freezenhorizontaldata[2]) {\n                                toY += scrollTop;\n                            }\n                            let left = postil['left'] == null ? toX + 18 * Store.zoomRatio : postil['left'] * Store.zoomRatio;\n                            let top = postil['top'] == null ? toY - 18 * Store.zoomRatio : postil['top'] * Store.zoomRatio;\n                            let width = postil['width'] == null ? _this.defaultWidth * Store.zoomRatio : postil['width'] * Store.zoomRatio;\n                            let height = postil['height'] == null ? _this.defaultHeight * Store.zoomRatio : postil['height'] * Store.zoomRatio;\n                            let value = postil['value'] == null ? '' : postil['value'];\n                            if (top < 0) {\n                                top = 2;\n                            }\n                            let size = _this.getArrowCanvasSize(left, top, toX, toY);\n                            let html = '<div id=\"luckysheet-postil-show_' + rowIndex + '_' + colIndex + '\" class=\"luckysheet-postil-show\">' + '<canvas class=\"arrowCanvas\" width=\"' + size[2] + '\" height=\"' + size[3] + '\" style=\"position:absolute;left:' + size[0] + 'px;top:' + size[1] + 'px;z-index:100;pointer-events:none;\"></canvas>' + '<div class=\"luckysheet-postil-show-main\" style=\"width:' + width + 'px;height:' + height + 'px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:' + left + 'px;top:' + top + 'px;box-sizing:border-box;z-index:100;\">' + '<div class=\"luckysheet-postil-dialog-move\">' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t\" data-type=\"t\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r\" data-type=\"r\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b\" data-type=\"b\"></div>' + '<div class=\"luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l\" data-type=\"l\"></div>' + '</div>' + '<div class=\"luckysheet-postil-dialog-resize\" style=\"display:none;\">' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt\" data-type=\"lt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt\" data-type=\"mt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm\" data-type=\"lm\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm\" data-type=\"rm\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt\" data-type=\"rt\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb\" data-type=\"lb\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb\" data-type=\"mb\"></div>' + '<div class=\"luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb\" data-type=\"rb\"></div>' + '</div>' + '<div style=\"width:100%;height:100%;overflow:hidden;\">' + '<div class=\"formulaInputFocus\" style=\"width:' + (width - 12) + 'px;height:' + (height - 12) + 'px;line-height:20px;box-sizing:border-box;text-align: center;;word-break:break-all;\" spellcheck=\"false\" contenteditable=\"true\">' + _this.htmlEscape(value) + '</div>' + '</div>' + '</div>' + '</div>';\n                            $(html).appendTo($('#luckysheet-cell-main #luckysheet-postil-showBoxs'));\n                            let ctx = $('#luckysheet-postil-show_' + rowIndex + '_' + colIndex + ' .arrowCanvas').get(0).getContext('2d');\n                            _this.drawArrow(ctx, size[4], size[5], size[6], size[7]);\n                            d[rowIndex][colIndex].ps.isshow = true;\n                            rc.push(allPs[i]);\n                        }\n                    }\n                }\n            }\n            _this.ref(d, rc);\n            _this.init();\n        },\n        removeActivePs: function () {\n            if ($('#luckysheet-postil-showBoxs .luckysheet-postil-show-active').length > 0) {\n                let id = $('#luckysheet-postil-showBoxs .luckysheet-postil-show-active').attr('id');\n                let r = id.split('luckysheet-postil-show_')[1].split('_')[0];\n                let c = id.split('luckysheet-postil-show_')[1].split('_')[1];\n                let value = $('#' + id).find('.formulaInputFocus').text();    // Hook function\n                // Hook function\n                if (!luckysheetConfigsetting.createHookFunction('commentUpdateBefore', r, c, value)) {\n                    return;\n                }\n                const previousCell = $.extend(true, {}, Store.flowdata[r][c]);\n                $('#' + id).removeClass('luckysheet-postil-show-active');\n                $('#' + id).find('.luckysheet-postil-dialog-resize').hide();\n                $('#' + id).find('.arrowCanvas').css('z-index', 100);\n                $('#' + id).find('.luckysheet-postil-show-main').css('z-index', 100);\n                let d = Store.deepCopyFlowData(Store.flowdata);\n                let rc = [];\n                d[r][c].ps.value = value;\n                rc.push(r + '_' + c);\n                this.ref(d, rc);\n                if (!d[r][c].ps.isshow) {\n                    $('#' + id).remove();\n                }    // Hook function\n                // Hook function\n                setTimeout(() => {\n                    luckysheetConfigsetting.createHookFunction('commentUpdateAfter', r, c, previousCell, d[r][c]);\n                }, 0);\n            }\n        },\n        ref: function (data, rc) {\n            if (Store.clearjfundo) {\n                Store.jfundo.length = 0;\n                Store.jfredo.push({\n                    'type': 'postil',\n                    'data': Store.flowdata,\n                    'curdata': data,\n                    'sheetIndex': Store.currentSheetIndex,\n                    'rc': rc\n                });\n            }    //flowdata\n            //flowdata\n            Store.flowdata = data;\n            Store.webWorkerFlowDataCache(Store.flowdata);    //worker存数据\n            //worker存数据\n            Store.luckysheetfile[getSheetIndex(Store.currentSheetIndex)].data = Store.flowdata;\n            //共享编辑模式\n            if (Store.allowUpdate) {\n                for (let i = 0; i < rc.length; i++) {\n                    let r = rc[i].split('_')[0];\n                    let c = rc[i].split('_')[1];\n                    Store.saveParam('v', Store.currentSheetIndex, Store.flowdata[r][c], {\n                        'r': r,\n                        'c': c\n                    });\n                }\n            } \n            //刷新表格\n            ///setTimeout(function () {\n            ///    luckysheetrefreshgrid();\n            ///}, 1);\n            Store.refresh();\n        },\n        positionSync: function () {\n            let _this = this;\n            $('#luckysheet-postil-showBoxs .luckysheet-postil-show').each(function (i, e) {\n                let id = $(e).attr('id');\n                let r = id.split('luckysheet-postil-show_')[1].split('_')[0];\n                let c = id.split('luckysheet-postil-show_')[1].split('_')[1];\n                let cell = Store.flowdata[r][c];\n                if (cell != null && cell.ps != null) {\n                    _this.buildPs(r, c, cell.ps);\n                } else {\n                    $('#' + id).hide();\n                }\n            });\n        },\n        htmlEscape: function (text) {\n            return text.replace(/[<>\"&]/g, function (match, pos, originalText) {\n                console.log(match, pos, originalText);\n                switch (match) {\n                case '<': {\n                        return '&lt';\n                    }\n                case '>': {\n                        return '&gt';\n                    }\n                case '&': {\n                        return '&amp';\n                    }\n                case '\"': {\n                        return '&quot;';\n                    }\n                }\n            });\n        }\n    };\n    return luckysheetPostil;\n});"]}