{"version":3,"sources":["controllers/zoom.js"],"names":["define","Store","locale","m_util","sheetmanage","m_resize","m_refresh","server","luckysheetPostil","imageCtrl","replaceHtml","changeSheetContainerSize","jfrefreshgrid_rhcw","luckysheetZoomTimeout","zoomChange","ratio","flowdata","length","clearTimeout","setTimeout","clearjfundo","jfredo","push","type","zoomRatio","curZoomRatio","sheetIndex","currentSheetIndex","currentSheet","getSheetByIndex","buildAllPs","data","images","allImagesShow","init","config","sheetViewZoom","curentsheetView","saveParam","k","zoomRefreshView","positionToRatio","pos","Math","round","zoomNumberDomBind","r","$","html","domPos","css","zoomSlierDomBind","zoomInitial","click","currentRatio","ceil","floor","mousedown","e","xoffset","this","offset","left","pageX","curentX","cursorLeft","parseFloat","document","off","on","event","moveX","stopPropagation"],"mappings":"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","file":"../../controllers/zoom.js","sourcesContent":["define([\n    '../store',\n    '../locale/locale',\n    '../utils/util',\n    './sheetmanage',\n    './resize',\n    '../global/refresh',\n    './server',\n    './postil',\n    './imageCtrl'\n], function (Store, locale, m_util, sheetmanage, m_resize, m_refresh, server, luckysheetPostil, imageCtrl) {\n    'use strict';\n    const {replaceHtml} = m_util;\n    const {changeSheetContainerSize} = m_resize;\n    const {jfrefreshgrid_rhcw} = m_refresh;\n    let luckysheetZoomTimeout = null;\n    function zoomChange(ratio) {\n        if (Store.flowdata == null || Store.flowdata.length == 0) {\n            return;\n        }\n        clearTimeout(luckysheetZoomTimeout);\n        luckysheetZoomTimeout = setTimeout(() => {\n            if (Store.clearjfundo) {\n                Store.jfredo.push({\n                    'type': 'zoomChange',\n                    'zoomRatio': Store.zoomRatio,\n                    'curZoomRatio': ratio,\n                    'sheetIndex': Store.currentSheetIndex\n                });\n            }\n            Store.zoomRatio = ratio;\n            let currentSheet = sheetmanage.getSheetByIndex();    //批注\n            //批注\n            luckysheetPostil.buildAllPs(currentSheet.data);    //图片\n            //图片\n            imageCtrl.images = currentSheet.images;\n            imageCtrl.allImagesShow();\n            imageCtrl.init();\n            if (currentSheet.config == null) {\n                currentSheet.config = {};\n            }\n            if (currentSheet.config.sheetViewZoom == null) {\n                currentSheet.config.sheetViewZoom = {};\n            }\n            let type = currentSheet.config.curentsheetView;\n            if (type == null) {\n                type = 'viewNormal';\n            }\n            currentSheet.config.sheetViewZoom[type + 'ZoomScale'] = ratio;\n            server.saveParam('all', Store.currentSheetIndex, Store.zoomRatio, { 'k': 'zoomRatio' });\n            server.saveParam('cg', Store.currentSheetIndex, currentSheet.config['sheetViewZoom'], { 'k': 'sheetViewZoom' });\n            zoomRefreshView();\n        }, 100);\n    }\n    function zoomRefreshView() {\n        // let $scrollLeft = $(\"#luckysheet-scrollbar-x\"), $scrollTop = $(\"#luckysheet-scrollbar-y\");\n        // let sl = $scrollLeft.scrollLeft(), st = $scrollTop.scrollTop();\n        // let wp = $scrollLeft.find(\"div\").width(), hp = $scrollTop.find(\"div\").height();\n        jfrefreshgrid_rhcw(Store.flowdata.length, Store.flowdata[0].length);\n        changeSheetContainerSize();    // let wc = $scrollLeft.find(\"div\").width(), hc = $scrollTop.find(\"div\").height();\n                                       // $scrollLeft.scrollLeft(sl+wc-wp);\n                                       // $scrollTop.scrollTop(st+hc-hp);\n    }\n    function zoomInitial() {\n        $('#luckysheet-zoom-minus').click(function () {\n            let currentRatio;\n            if (Store.zoomRatio == null) {\n                currentRatio = Store.zoomRatio = 1;\n            } else {\n                currentRatio = Math.ceil(Store.zoomRatio * 10) / 10;\n            }\n            currentRatio = currentRatio - 0.1;\n            if (currentRatio == Store.zoomRatio) {\n                currentRatio = currentRatio - 0.1;\n            }\n            if (currentRatio <= 0.1) {\n                currentRatio = 0.1;\n            }    // Store.zoomRatio = currentRatio;\n            // Store.zoomRatio = currentRatio;\n            zoomChange(currentRatio);\n            zoomNumberDomBind(currentRatio);\n        });\n        $('#luckysheet-zoom-plus').click(function () {\n            let currentRatio;\n            if (Store.zoomRatio == null) {\n                currentRatio = Store.zoomRatio = 1;\n            } else {\n                currentRatio = Math.floor(Store.zoomRatio * 10) / 10;\n            }\n            currentRatio = currentRatio + 0.1;\n            if (currentRatio == Store.zoomRatio) {\n                currentRatio = currentRatio + 0.1;\n            }\n            if (currentRatio >= 4) {\n                currentRatio = 4;\n            }    // Store.zoomRatio = currentRatio;\n            // Store.zoomRatio = currentRatio;\n            zoomChange(currentRatio);\n            zoomNumberDomBind(currentRatio);\n        });\n        $('#luckysheet-zoom-slider').mousedown(function (e) {\n            let xoffset = $(this).offset().left, pageX = e.pageX;\n            let currentRatio = positionToRatio(pageX - xoffset);    // Store.zoomRatio = currentRatio;\n            // Store.zoomRatio = currentRatio;\n            zoomChange(currentRatio);\n            zoomNumberDomBind(currentRatio);\n        });\n        $('#luckysheet-zoom-cursor').mousedown(function (e) {\n            let curentX = e.pageX, cursorLeft = parseFloat($('#luckysheet-zoom-cursor').css('left'));\n            $('#luckysheet-zoom-cursor').css('transition', 'none');\n            $(document).off('mousemove.zoomCursor').on('mousemove.zoomCursor', function (event) {\n                let moveX = event.pageX;\n                let offsetX = moveX - curentX;    // console.log(moveX, curentX, offsetX);\n                                                  // curentX = moveX;\n                                                  // let left = parseFloat($(\"#luckysheet-zoom-cursor\").css(\"left\"));\n                // console.log(moveX, curentX, offsetX);\n                // curentX = moveX;\n                // let left = parseFloat($(\"#luckysheet-zoom-cursor\").css(\"left\"));\n                let pos = cursorLeft + offsetX;\n                let currentRatio = positionToRatio(pos);\n                if (currentRatio > 4) {\n                    currentRatio = 4;\n                    pos = 100;\n                }\n                if (currentRatio < 0.1) {\n                    currentRatio = 0.1;\n                    pos = 0;\n                }    // Store.zoomRatio = currentRatio;\n                // Store.zoomRatio = currentRatio;\n                zoomChange(currentRatio);\n                let r = Math.round(currentRatio * 100) + '%';\n                $('#luckysheet-zoom-ratioText').html(r);\n                $('#luckysheet-zoom-cursor').css('left', pos - 4);\n            });\n            $(document).off('mouseup.zoomCursor').on('mouseup.zoomCursor', function (event) {\n                $(document).off('.zoomCursor');\n                $('#luckysheet-zoom-cursor').css('transition', 'all 0.3s');\n            });\n            e.stopPropagation();\n        }).click(function (e) {\n            e.stopPropagation();\n        });\n        $('#luckysheet-zoom-ratioText').click(function () {\n            // Store.zoomRatio = 1;\n            zoomChange(1);\n            zoomNumberDomBind(1);\n        });\n        zoomNumberDomBind(Store.zoomRatio);\n    }\n    function zoomSlierDown() {\n    }\n    function positionToRatio(pos) {\n        let ratio = 1;\n        if (pos < 50) {\n            ratio = Math.round((pos * 1.8 / 100 + 0.1) * 100) / 100;\n        } else if (pos > 50) {\n            ratio = Math.round(((pos - 50) * 6 / 100 + 1) * 100) / 100;\n        }\n        return ratio;\n    }\n    function zoomSlierDomBind(ratio) {\n        let domPos = 50;\n        if (ratio < 1) {\n            domPos = Math.round((ratio - 0.1) * 100 / 0.18) / 10;\n        } else if (ratio > 1) {\n            domPos = Math.round((ratio - 1) * 100 / 0.6) / 10 + 50;\n        }\n        $('#luckysheet-zoom-cursor').css('left', domPos - 4);\n    }\n    function zoomNumberDomBind(ratio) {\n        let r = Math.round(ratio * 100) + '%';\n        $('#luckysheet-zoom-ratioText').html(r);\n        zoomSlierDomBind(ratio);\n    }\n    return {\n        zoomChange: zoomChange,\n        zoomRefreshView: zoomRefreshView,\n        zoomInitial: zoomInitial,\n        zoomNumberDomBind: zoomNumberDomBind\n    };\n});"]}