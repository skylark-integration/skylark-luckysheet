/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../utils/util","../controllers/menuButton","./getdata","./location","./validate","../controllers/inlineString","../store"],function(t,e,n,l,s,a,u){"use strict";const{luckysheetfontformat:o}=t,{getcellvalue:i,checkstatusByCell:c}=n,{colLocationByIndex:h}=l,{hasChinaword:d,isRealNull:x,checkWordByteLength:g}=s,{isInlineStringCell:r}=a;function f(t,n,l){let s=u.measureTextCache[t+"_"+n.font];if(null!=l&&(s=u.measureTextCache[t+"_"+l]),null!=s)return s;{if(null!=l){n.font;n.font=l}let s=n.measureText(t),a={};if(a.width=s.width,null!=l&&(n.font=l),a.actualBoundingBoxDescent=s.actualBoundingBoxDescent,a.actualBoundingBoxAscent=s.actualBoundingBoxAscent,null==a.actualBoundingBoxDescent||null==a.actualBoundingBoxAscent||isNaN(a.actualBoundingBoxDescent)||isNaN(a.actualBoundingBoxAscent)){let l="M";d(t)&&(l="田");let s=.8*e.getTextSize(l,n.font)[1];"top"==n.textBaseline?(a.actualBoundingBoxDescent=s,a.actualBoundingBoxAscent=0):"middle"==n.textBaseline?(a.actualBoundingBoxDescent=s/2,a.actualBoundingBoxAscent=s/2):(a.actualBoundingBoxDescent=0,a.actualBoundingBoxAscent=s)}if("alphabetic"==n.textBaseline){let t="gjpqy",e="abcdABCD",s=u.measureTextCache[t+"_"+n.font];null!=l&&(s=u.measureTextCache[t+"_"+l]);let o=u.measureTextCache[e+"_"+n.font];null!=l&&(o=u.measureTextCache[e+"_"+l]),null==s&&(s=n.measureText(t)),null==o&&(o=n.measureText(e)),a.actualBoundingBoxDescent<=o.actualBoundingBoxDescent&&(a.actualBoundingBoxDescent=s.actualBoundingBoxDescent,null==a.actualBoundingBoxDescent&&(a.actualBoundingBoxDescent=0))}return a.width*=u.zoomRatio,a.actualBoundingBoxDescent*=u.zoomRatio,a.actualBoundingBoxAscent*=u.zoomRatio,u.measureTextCache[t+"_"+u.zoomRatio+"_"+n.font]=a,a}}function B(t,e,n){let l=n.cellWidth,s=n.cellHeight,a="",i="";null==l&&(a="onlyWidth",i="_");let h=u.measureTextCellInfoCache[n.r+"_"+n.c+i+a];if(null!=h)return h;let d=n.space_width,B=n.space_height;null==d&&(d=2),null==B&&(B=2);let M=c(t,"ht"),w=c(t,"vt"),m=c(t,"tb"),A=c(t,"tr"),T=c(t,"rt"),D=1,y=0;null==T&&("0"==A?T=0:"1"==A?T=45:"4"==A?T=90:"2"==A?T=135:"5"==A&&(T=180),null==T&&(T=0)),(T>180||T<0)&&(T=0),(T=parseInt(T))>90&&(T=90-T,D=0,y=1),e.textAlign="start";let I,v,L={values:[]},_="0",b="0",C=11,W=!1,H=[];if(r(t)){let e=t.ct.s,n=0;for(let t=0;t<e.length;t++){let l=e[t],s=o(l),a=l.fc,u=l.cl,i=l.un,c=l.v,h=l.fs,d=(c=c.replace(/\r\n/g,"_x000D_").replace(/&#13;&#10;/g,"_x000D_").replace(/\r/g,"_x000D_").replace(/\n/g,"_x000D_")).split("_x000D_");for(let t=0;t<d.length;t++){let e=d[t];if(""==e&&t!=d.length-1)H.push({fontset:s,fc:null==a?"#000":a,cl:null==u?0:u,un:null==i?0:i,wrap:!0,fs:null==h?11:h}),n++;else{let l=e.split("");for(let t=0;t<l.length;t++){let e=l[t];H.push({fontset:s,fc:null==a?"#000":a,cl:null==u?0:u,un:null==i?0:i,v:e,si:n,fs:null==h?11:h})}t!=d.length-1&&(H.push({fontset:s,fc:null==a?"#000":a,cl:null==u?0:u,un:null==i?0:i,wrap:!0,fs:null==h?11:h}),n++)}}n++}W=!0}else if(I=o(t),e.font=I,_=c(t,"cl"),b=c(t,"un"),C=c(t,"fs"),t instanceof Object?null==(v=t.m)&&(v=t.v):v=t,x(v))return null;if("3"==A){e.textBaseline="top";let t=0,n=0,u=0,o=0,i={},c=[];if(W){let t=null;for(let n=0;n<H.length;n++){let l=H[n],a=l.v,h=l.v;if(!0===l.wrap&&(a="M",h="",null!=t&&!0!==t.wrap&&n<H.length-1)){c.push(o),o=0,u+=1,t=l;continue}let x=f(a,e,l.fontset),g=x.width+d,r=x.actualBoundingBoxAscent+x.actualBoundingBoxDescent+B;o+=r,"2"!=m||l.wrap||o>s&&null!=i[u]&&(c.push(o-r),o=r,u+=1),n==H.length-1&&c.push(o),null==i[u]&&(i[u]=[]);let p={content:h,style:l,width:g,height:r,left:0,top:0,colIndex:u,asc:x.actualBoundingBoxAscent,desc:x.actualBoundingBoxDescent,inline:!0};!0===l.wrap&&(p.wrap=!0),i[u].push(p),console.log("normal",n,u,l,t,i),t=l}}else{let t=f(v,e),n=t.actualBoundingBoxDescent+t.actualBoundingBoxAscent,l=[];(v=v.toString()).length>1?l=v.split(""):l.push(v);let a=f(l[0],e).width;for(let e=0;e<l.length;e++){let h=a+d,x=n+B;o+=x,"2"==m&&o>s&&null!=i[u]&&(c.push(o-x),o=x,u+=1),e==l.length-1&&c.push(o),null==i[u]&&(i[u]=[]),i[u].push({content:l[e],style:I,width:h,height:x,left:0,top:0,colIndex:u,asc:t.actualBoundingBoxAscent,desc:t.actualBoundingBoxDescent})}}let h=[];for(let e=0;e<c.length;e++){let l=c[e],s=i[e],a=0;for(let t=0;t<s.length;t++){let e=s[t];a=Math.max(a,e.width)}h.push(a),t+=a,n=Math.max(n,l)}if(L.type="verticalWrap",L.textWidthAll=t,L.textHeightAll=n,"onlyWidth"==a)return L;let x=0;for(let e=0;e<c.length;e++){let n=c[e],a=h[e],u=i[e],o=0;for(let e=0;e<u.length;e++){let i=u[e],h=d+x;"0"==M?h=l/2+x-t/2+d*c.length:"2"==M&&(h=l+x-t+d);let g=s-B+o-n;"0"==w?g=s/2+o-n/2:"1"==w&&(g=B+o),o+=i.height,i.left=h,i.top=g,p(i,_,b,{width:a,height:i.height,left:h,top:g+i.height-B,asc:i.height,desc:0,fs:C}),L.values.push(i)}x+=a}}else{let t=function(t){return null!=t.measureText("田").actualBoundingBoxAscent}(e);if(e.textBaseline=t?"alphabetic":"bottom","2"==m||W){let n=0,u=0,o=0,i=0,c={};L.rotate=T,T=Math.abs(T);let h,x,r,A,y=0,P=1,X=null,Y=null;if(W)for(;P<=H.length;){let t=H.slice(y,P);if(!0===t[t.length-1].wrap){if(y=P,t.length>1)for(let e=0;e<t.length-1;e++){let n=t[e],l={content:n.v,style:n,width:n.measureText.width,height:n.measureText.actualBoundingBoxAscent+n.measureText.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:n.measureText.actualBoundingBoxAscent,desc:n.measureText.actualBoundingBoxDescent,inline:!0,fs:n.fs};c[i].push(l)}if(1==t.length||P==H.length){let n=t[0],l=f("M",e,n.fontset);null==c[i]&&(c[i]=[]),c[i].push({content:"",style:n,width:l.width,height:l.actualBoundingBoxAscent+l.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:l.actualBoundingBoxAscent,desc:l.actualBoundingBoxDescent,inline:!0,wrap:!0,fs:n.fs})}i+=1,P++;continue}let n=0,a=0;for(let l=0;l<t.length;l++){let s=t[l];null==s.measureText&&(s.measureText=f(s.v,e,s.fontset)),n+=s.measureText.width,a=Math.max(s.measureText.actualBoundingBoxAscent+s.measureText.actualBoundingBoxDescent)}let u=n*Math.cos(T*Math.PI/180)+a*Math.sin(T*Math.PI/180),o=n*Math.sin(T*Math.PI/180)+a*Math.cos(T*Math.PI/180),h=t[t.length-1];if(" "!=h.v&&2!=g(h.v)||(Y=P),0!=T)if(console.log(o,B,s,t,o+B>s),o+B>s&&null!=c[i]&&"2"==m&&P!=H.length)if(null!=Y&&Y<P){for(let e=0;e<Y-y;e++){let n=t[e];c[i].push({content:n.v,style:n,width:n.measureText.width,height:n.measureText.actualBoundingBoxAscent+n.measureText.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:n.measureText.actualBoundingBoxAscent,desc:n.measureText.actualBoundingBoxDescent,inline:!0,fs:n.fs})}y=Y,P=Y+1,i+=1,Y=null}else{y=P-1;for(let e=0;e<t.length-1;e++){let n=t[e];c[i].push({content:n.v,style:n,width:n.measureText.width,height:n.measureText.actualBoundingBoxAscent+n.measureText.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:n.measureText.actualBoundingBoxAscent,desc:n.measureText.actualBoundingBoxDescent,inline:!0,fs:n.fs})}i+=1}else{if(P==H.length){null==c[i]&&(c[i]=[]);for(let e=0;e<t.length;e++){let n=t[e];c[i].push({content:n.v,style:n,width:n.measureText.width,height:n.measureText.actualBoundingBoxAscent+n.measureText.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:n.measureText.actualBoundingBoxAscent,desc:n.measureText.actualBoundingBoxDescent,inline:!0,fs:n.fs})}break}null==c[i]&&(c[i]=[]),P++}else if(u+d>l&&null!=c[i]&&"2"==m&&P!=H.length)if(null!=Y&&Y<P){for(let e=0;e<Y-y;e++){let n=t[e];c[i].push({content:n.v,style:n,width:n.measureText.width,height:n.measureText.actualBoundingBoxAscent+n.measureText.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:n.measureText.actualBoundingBoxAscent,desc:n.measureText.actualBoundingBoxDescent,inline:!0,fs:n.fs})}y=Y,P=Y+1,i+=1,Y=null}else{y=P-1;for(let e=0;e<t.length-1;e++){let n=t[e];c[i].push({content:n.v,style:n,width:n.measureText.width,height:n.measureText.actualBoundingBoxAscent+n.measureText.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:n.measureText.actualBoundingBoxAscent,desc:n.measureText.actualBoundingBoxDescent,inline:!0,fs:n.fs})}i+=1}else{if(P==H.length){null==c[i]&&(c[i]=[]);for(let e=0;e<t.length;e++){let n=t[e];c[i].push({content:n.v,style:n,width:n.measureText.width,height:n.measureText.actualBoundingBoxAscent+n.measureText.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:n.measureText.actualBoundingBoxAscent,desc:n.measureText.actualBoundingBoxDescent,inline:!0,fs:n.fs})}break}null==c[i]&&(c[i]=[]),P++}}else for(v=v.toString();P<=v.length;){let t=v.substring(y,P),n=f(t,e),a=n.width,u=n.actualBoundingBoxAscent+n.actualBoundingBoxDescent,o=a*Math.cos(T*Math.PI/180)+u*Math.sin(T*Math.PI/180),p=a*Math.sin(T*Math.PI/180)+u*Math.cos(T*Math.PI/180),M=t.substr(t.length-1,1);if(" "!=M&&2!=g(M)||null!=A&&(X={index:P,str:h,width:r,height:x,asc:A.actualBoundingBoxAscent,desc:A.actualBoundingBoxDescent}),0!=T)if(p+B>s&&null!=c[i]&&P!=v.length)null!=X&&X.index<P?(y=X.index,P=X.index+1,c[i].push({content:X.str,style:I,width:X.width,height:X.height,left:0,top:0,splitIndex:i,asc:X.asc,desc:X.desc,fs:C}),i+=1,X=null):(y=P-1,c[i].push({content:h,style:I,left:0,top:0,splitIndex:i,height:x,width:r,asc:n.actualBoundingBoxAscent,desc:n.actualBoundingBoxDescent,fs:C}),i+=1);else{if(P==v.length){null==c[i]&&(c[i]=[]),c[i].push({content:t,style:I,left:0,top:0,splitIndex:i,height:u,width:a,asc:n.actualBoundingBoxAscent,desc:n.actualBoundingBoxDescent,fs:C});break}null==c[i]&&(c[i]=[]),P++}else if(o+d>l&&null!=c[i]&&P!=v.length)null!=X&&X.index<P?(y=X.index,P=X.index+1,c[i].push({content:X.str,style:I,width:X.width,height:X.height,left:0,top:0,splitIndex:i,asc:X.asc,desc:X.desc,fs:C}),i+=1,X=null):(X=null,y=P-1,c[i].push({content:h,style:I,width:r,height:x,left:0,top:0,splitIndex:i,asc:n.actualBoundingBoxAscent,desc:n.actualBoundingBoxDescent,fs:C}),i+=1);else{if(P==v.length){null==c[i]&&(c[i]=[]),c[i].push({content:t,style:I,width:a,height:u,left:0,top:0,splitIndex:i,asc:n.actualBoundingBoxAscent,desc:n.actualBoundingBoxDescent,fs:C});break}null==c[i]&&(c[i]=[]),P++}h=t,x=u,r=a,A=n}let k=[],R=0,z=Object.keys(c).length;for(let e=0;e<z;e++){let l=c[e];if(null==l)continue;let s=0,a=0,i=0,h=0,d=0,x=0;for(let e=0;e<l.length;e++){let n=l[e];s+=n.width,a=Math.max(a,n.height-(t?n.desc:0)),i=Math.max(i,t?n.desc:0),h=Math.max(h,n.asc),x++}d=a/2,R=Math.max(R,x),0!=T?(a+=d,o=Math.max(o,s),u+=a):(a+=d,n=Math.max(n,s),u+=a),k.push({width:s,height:a,desc:i,asc:h,lineHeight:d,wordCount:x})}let S=0,N=0,j=T*Math.PI/180,O=k[z-1],$=O.lineHeight,q=(u=u-$+O.desc)/Math.sin(j)+o*Math.cos(j),E=o*Math.sin(j),F=0;if(0!=T?(1==z?(n=o+u/Math.tan(j)*2,F=u/Math.tan(j)):n=o+u/Math.tan(j),L.textWidthAll=q,L.textHeightAll=E):(L.textWidthAll=n,L.textHeightAll=u),"onlyWidth"==a)return L;if(0!=T&&"1"==D){e.textAlign="end";for(let t=0;t<z;t++){let e=c[t];if(null==e)continue;let a=k[t];N=0;for(let t=e.length-1;t>=0;t--){let i,c,h=e[t];if(0!=T){let t,e=S+a.asc;if(t=S/Math.tan(j)-N+o,"0"==M){Math.sin(j);"0"==w?(i=t+l/2-n/2+$*Math.cos(j)/2,c=e+s/2-u/2-$*Math.cos(j)/2):"1"==w?(i=t+l/2-n/2,c=e-(u/2-E/2)):"2"==w&&(i=t+l/2-n/2+$*Math.cos(j),c=e+s-E/2-u/2-$*Math.cos(j))}else"1"==M?"0"==w?(i=t-E*Math.sin(j)/2+$*Math.cos(j)/2,c=e+s/2+E*Math.cos(j)/2-$*Math.cos(j)/2):"1"==w?(i=t-E*Math.sin(j),c=e+E*Math.cos(j)):"2"==w&&(i=t+$*Math.cos(j),c=e+s-$*Math.cos(j)):"2"==M&&("0"==w?(i=t+l-q/2-(o/2+u/2/Math.tan(j))+$*Math.cos(j)/2,c=e+s/2-u/2-$*Math.cos(j)/2):"1"==w?(i=t+l-n+F,c=e-u):"2"==w&&(i=t+l-q*Math.cos(j)+$*Math.cos(j),c=e+s-q*Math.sin(j)-$*Math.cos(j)))}h.left=i,h.top=c,p(h,_,b,{width:h.width,height:h.height,left:i-h.width,top:c,asc:a.asc,desc:a.desc,fs:h.fs}),L.values.push(h),N+=h.width}S+=a.height}}else for(let t=0;t<z;t++){let e=c[t];if(null==e)continue;let a=k[t];N=0;for(let t=0;t<e.length;t++){let o,i,c=e[t];if(0!=T){let t,e=S+a.asc;if(t=(u-S)/Math.tan(j)+N,"0"==M){Math.sin(j);"0"==w?(o=t+l/2-n/2-$*Math.cos(j)/2,i=e+s/2-u/2+$*Math.cos(j)/2):"1"==w?(o=t+l/2-n/2-$*Math.cos(j)/2,i=e-(u/2-E/2)+$*Math.cos(j)/2):"2"==w&&(o=t+l/2-n/2-$*Math.cos(j),i=e+s-E/2-u/2-$*Math.cos(j))}else"1"==M?"0"==w?(o=t-E*Math.sin(j)/2-$*Math.cos(j)/2,i=e-u+s/2-E*Math.cos(j)/2-$*Math.cos(j)/2):"1"==w?(o=t,i=e-u):"2"==w&&(o=t-E*Math.sin(j)-$*Math.cos(j),i=e-u+s-E*Math.cos(j)-$*Math.cos(j)):"2"==M&&("0"==w?(o=t+l-q/2-n/2-$*Math.cos(j)/2,i=e+s/2-u/2-$*Math.cos(j)/2):"1"==w?(o=t+l-q*Math.cos(j),i=e+E*Math.cos(j)):"2"==w&&(o=t+l-n-$*Math.cos(j)+F,i=e+s-$*Math.cos(j)));p(c,_,b,{width:c.width,height:c.height,left:o,top:i,asc:a.asc,desc:a.desc,fs:c.fs})}else o=d+N,"0"==M?o=l/2+N-a.width/2:"2"==M&&(o=l+N-a.width),i=s-B+S+a.asc-u,"0"==w?i=s/2+S-u/2+a.asc:"1"==w&&(i=B+S+a.asc),p(c,_,b,{width:c.width,height:c.height,left:o,top:i,asc:a.asc,desc:a.desc,fs:c.fs});c.left=o,c.top=i,L.values.push(c),N+=c.width}S+=a.height}L.type="plainWrap",0!=T&&("0"==M?"0"==w?(L.textLeftAll=l/2,L.textTopAll=s/2):"1"==w?(L.textLeftAll=l/2,L.textTopAll=E/2):"2"==w&&(L.textLeftAll=l/2,L.textTopAll=s-E/2):"1"==M?"0"==w?(L.textLeftAll=0,L.textTopAll=s/2):"1"==w?(L.textLeftAll=0,L.textTopAll=0):"2"==w&&(L.textLeftAll=0,L.textTopAll=s):"2"==M&&("0"==w?(L.textLeftAll=l-q/2,L.textTopAll=s/2):"1"==w?(L.textLeftAll=l,L.textTopAll=0):"2"==w&&(L.textLeftAll=l,L.textTopAll=s)))}else{let t=f(v,e),n=t.width,u=t.actualBoundingBoxDescent+t.actualBoundingBoxAscent;L.rotate=T;let o=(T=Math.abs(T))*Math.PI/180,i=n*Math.cos(o)+u*Math.sin(o),c=n*Math.sin(o)+u*Math.cos(o);if(L.textHeightAll=0!=T?c:c+u/2-t.actualBoundingBoxDescent-B,L.textWidthAll=i,"onlyWidth"==a)return L;let h=i,x=c,g=d+u*Math.sin(o)*D;"0"==M?g=l/2-h/2+u*Math.sin(o)*D:"2"==M&&(g=l-d-h+u*Math.sin(o)*D);let r=s-B-x+t.actualBoundingBoxAscent*Math.cos(o)+n*Math.sin(o)*D;"0"==w?r=s/2-x/2+t.actualBoundingBoxAscent*Math.cos(o)+n*Math.sin(o)*D:"1"==w&&(r=B+t.actualBoundingBoxAscent*Math.cos(o)+n*Math.sin(o)*D),L.type="plain";let m={content:v,style:I,width:h,height:x,left:g,top:r};p(m,_,b,{width:n,height:u,left:g,top:r,asc:t.actualBoundingBoxAscent,desc:t.actualBoundingBoxDescent,fs:C}),L.values.push(m),L.textLeftAll=g,L.textTopAll=r,L.asc=t.actualBoundingBoxAscent,L.desc=t.actualBoundingBoxDescent}}return L}function p(t,e,n,l){let s=l.left,a=l.top,u=l.width,o=(l.height,l.asc),i=l.desc,c=l.fs;if(!0!==t.wrap&&(1==t.inline&&null!=t.style&&(e=t.style.cl,n=t.style.un),"0"!=e&&(t.cancelLine={},t.cancelLine.startX=s,t.cancelLine.startY=a-o/2+1,t.cancelLine.endX=s+u,t.cancelLine.endY=a-o/2+1,t.cancelLine.fs=c),"0"!=n)){if(t.underLine=[],"1"==n||"2"==n){let e={};e.startX=s,e.startY=a,e.endX=s+u,e.endY=a,e.fs=c,t.underLine.push(e)}if("2"==n){let e={};e.startX=s,e.startY=a+i,e.endX=s+u,e.endY=a+i,e.fs=c,t.underLine.push(e)}if("3"==n||"4"==n){let e={};e.startX=s,e.startY=a+i,e.endX=s+u,e.endY=a+i,e.fs=c,t.underLine.push(e)}if("4"==n){let e={};e.startX=s,e.startY=a+i+2,e.endX=s+u,e.endY=a+i+2,e.fs=c,t.underLine.push(e)}}}return{rowlenByRange:function(t,e,n,l){let s=$.extend(!0,{},l);null==s.rowlen&&(s.rowlen={}),null==s.customHeight&&(s.customHeight={});let a=$("#luckysheetTableContent").get(0).getContext("2d");a.textBaseline="top";for(let l=e;l<=n;l++){if(null!=s.rowhidden&&null!=s.rowhidden[l])continue;let e=u.defaultrowlen;if(1!=s.customHeight[l]){delete s.rowlen[l];for(let n=0;n<t[l].length;n++){let s=t[l][n];if(null!=s&&null==s.mc&&null!=s&&(null!=s.v||r(s))){let t=B(s,a,{r:l,c:n,cellWidth:h(n)[1]-h(n)[0]-2}),u=0;null!=t&&(u=t.textHeightAll+2),u>e&&(e=u)}}(e/=u.zoomRatio)!=u.defaultrowlen&&(s.rowlen[l]=e)}}return s},computeRowlenArr:function(t,e){let n=[],l=0;for(let s=0;s<t;s++){let t=u.defaultrowlen;null!=e.rowlen&&null!=e.rowlen[s]&&(t=e.rowlen[s]),null==e.rowhidden||null==e.rowhidden[s]?(l+=t+1,n.push(l)):(t=e.rowhidden[s],n.push(l))}return n},getCellTextSplitArr:function t(e,n,l,s){for(let a=1;a<=e.length;a++){let u=e.substring(0,a);if(f(u,s).width>l)return a-1<=0?n:(n.push(e.substring(0,a-1)),t(e.substring(a-1),n,l,s));a==e.length&&n.push(u)}return n},getMeasureText:f,getCellTextInfo:B}});
//# sourceMappingURL=../sourcemaps/global/getRowlen.js.map
