/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../utils/util","../methods/get","../methods/set","../controllers/constant","../controllers/sheetmanage","../controllers/menuButton","../controllers/server","../controllers/freezen","../controllers/protection","../controllers/dataVerificationCtrl","../controllers/select","./validate","./datecontroll","../global/getRowlen","./getdata","./setdata","./format","./editor","./tooltip","./location","./cursorPos","./refresh","../controllers/inlineString","../function/func","../store","../locale/locale","./json","./method"],function(e,t,l,n,r,s,a,i,c,u,o,h,f,g,d,p,m,y,x,k,b,v,_,w,S,F,C,q){"use strict";const{replaceHtml:I,getObjType:R,chatatABC:N,ABCatNum:T,luckysheetfontformat:j}=e,{getSheetIndex:O,getRangetxt:A,getluckysheetfile:L}=t,{setluckysheetfile:z}=l,{luckyColor:M}=n,{checkProtectionLocked:E,checkProtectionCellHidden:D}=c,{seletedHighlistByindex:P,luckysheet_count_show:H}=o,{isRealNum:G,isRealNull:V,valueIsError:Z,isEditMode:U}=h,{isdatetime:B,isdatatype:W}=f,{getCellTextSplitArr:X,getCellTextInfo:J}=g,{getcellvalue:Y,getcellFormula:K,getInlineStringNoStyle:Q,getOrigincell:ee}=d,{setcellvalue:te}=p,{genarate:le,valueShowEs:ne}=m,{rowLocation:re,colLocation:se,colLocationByIndex:ae,mouseposition:ie}=k,{luckysheetRangeLast:ce}=b,{jfrefreshgrid:ue}=v,{isInlineStringCell:oe,convertSpanToShareString:he}=_,{luckysheet_compareWith:fe,luckysheet_getarraydata:ge,luckysheet_getcelldata:de,luckysheet_parseData:pe,luckysheet_getValue:me,luckysheet_indirect_check:ye,luckysheet_indirect_check_return:xe,luckysheet_offset_check:ke,luckysheet_calcADPMM:be,luckysheet_getSpecialReference:ve}=w;return{error:{v:"#VALUE!",n:"#NAME?",na:"#N/A",r:"#REF!",d:"#DIV/0!",nm:"#NUM!",nl:"#NULL!",sp:"#SPILL!"},errorInfo:function(e){return e},errorParamCheck:function(e,t,l){let n,require,r=F().formulaMore;return l<e.length?(n=e[l].type,require=e[l].require):(n=e[e.length-1].type,require=e[e.length-1].require),"o"!=require||null!=t&&""!=t?n.indexOf("all")>-1?[!0,r.tipSuccessText]:n.indexOf("range")>-1&&("object"==R(t)||"array"==R(t))?[!0,r.tipSuccessText]:n.indexOf("number")>-1&&(G(t)||"boolean"==R(t))?[!0,r.tipSuccessText]:n.indexOf("string")>-1&&"string"==R(t)?[!0,r.tipSuccessText]:n.indexOf("date")>-1&&B(t)?[!0,r.tipSuccessText]:[!1,r.tipParamErrorText]:[!0,r.tipSuccessText]},getPureValueByData:function(e){if(0==e.length)return[];let t=[];if("array"==R(e))if("array"==R(e[0]))for(let l=0;l<e.length;l++){let n=[];for(let t=0;t<e[0].length;t++){let r=e[l][t];"object"==R(r)?n.push(r.v):n.push(r)}t.push(n)}else for(let l=0;l<e.length;l++){let n=e[l];"object"==R(n)?t.push(n.v):t.push(n)}else{let l=e;"object"==R(l)?t.push(l.v):t.push(l)}return t},readCellDataToOneArray:function(e){let t=this;if(null==e)return[];if("object"!=R(e))return[e];let l=[],n=[];if(null==e||null==e.data)return null==e||V(e.v)?[]:[e.v];if(n=e.data,"array"==R(n))n=t.getPureValueByData(n);else{if("object"==R(n))return[n=n.v];/\{.*?\}/.test(n)&&(n=n.replace(/\{/g,"[").replace(/\}/g,"]")),n=new Function("return "+n)()}if("array"==R(n[0]))for(let e=0;e<n.length;e++)l=l.concat(n[e]);else l=n;return l},getValueByFuncData:function(e,t){if(null==e)return null;return"array"==R(e)?"avg"==t?luckysheet_function.AVERAGE.f.apply(luckysheet_function.AVERAGE,e):"sum"==t?luckysheet_function.SUM.f.apply(luckysheet_function.SUM,e):"object"==R(e[0])?luckysheet.mask.getValueByFormat(e[0]):e[0]:"object"==R(e)?luckysheet.mask.getValueByFormat(e):e},sparklinesColorMap:function(e,t){let l=this,n=null;null==t&&(t=5);if(e.length>t)for(let r=t;r<e.length;r++){let t=e[r],s=l.readCellDataToOneArray(t);for(let e=0;e<s.length;e++){let t=s[e];if(t.indexOf(":")>-1){n||(n={});let e=t.split(":");2==e.length?n[e[0]]=e[1]:e.length>1&&(n[e[0]+":"+e[1]]=e[2])}else n||(n=[]),n.push(t)}0}return n},colorList:["#2ec7c9","#fc5c5c","#5ab1ef","#ffb980","#d87a80","#8d98b3","#e5cf0d","#97b552","#95706d","#dc69aa","#07a2a4","#9a7fd1","#588dd5","#f5994e","#c05050","#59678c","#c9ab00","#7eb00a","#6f5553","#c14089"],classlist:{province:{11:"北京",12:"天津",13:"河北",14:"山西",15:"内蒙古",21:"辽宁",22:"吉林",23:"黑龙江",31:"上海",32:"江苏",33:"浙江",34:"安徽",35:"福建",36:"江西",37:"山东",41:"河南",42:"湖北",43:"湖南",44:"广东",45:"广西",46:"海南",50:"重庆",51:"四川",52:"贵州",53:"云南",54:"西藏",61:"陕西",62:"甘肃",63:"青海",64:"宁夏",65:"新疆",71:"台湾",81:"香港",82:"澳门",91:"国外"}},oldvalue:null,dontupdate:function(){let e=this;S.luckysheetCellUpdate.length=0,$("#luckysheet-functionbox-cell, #luckysheet-rich-text-editor").html(e.oldvalue),e.cancelNormalSelected(),e.rangetosheet!=S.currentSheetIndex&&r.changeSheetExec(e.rangetosheet)},fucntionboxshow:function(e,t){if(!D(e,t,S.currentSheetIndex))return void $("#luckysheet-functionbox-cell").html("");let l=S.flowdata,n="";if(null!=l[e]&&null!=l[e][t]){let r=$.extend(!0,{},l[e][t]);n=oe(r)?Q(e,t):null!=r.f?Y(e,t,l,"f"):ne(e,t,l)}this.oldvalue=n,$("#luckysheet-functionbox-cell").html(n)},cellOffset:function(e,t,l,n,r){let s,a=e.startCell,i=(e.rowl,e.coll,parseInt(a.replace(/[^0-9]/g,""))),c=T(a.replace(/[^A-Za-z]/g,"")),u=[],o=[];u[0]=i+t,o[0]=c+l,u[1]=u[0]+n-1,o[1]=o[0]+r-1,o[0]=N(o[0]),o[1]=N(o[1]);let h=o[0]+u[0],f=o[1]+u[1];return s=h==f?e.sheetName+"!"+h:e.sheetName+"!"+h+":"+f},parseDatetoNum:function(e){let t=this;if("object"==typeof e&&"number"==typeof e.v)e=e.v;else if("num"==W(e))e=parseFloat(e);else{if("date"!=W(e))return t.error.v;e=le(e)[2]}return e},getRangeArray:function(e){let t=[],l="General";if(1==e.length)for(let n=0;n<e[0].length;n++)if(null!=e[0][n]&&e[0][n].v){t.push(e[0][n].v);let r=e[0][n].ct.fa;l="General"==l?r:l}else t.push(null);else if(1==e[0].length)for(let n=0;n<e.length;n++)if(null!=e[n][0]&&e[n][0].v){t.push(e[n][0].v);let r=e[n][0].ct.fa;l="General"==l?r:l}else t.push(null);else for(let n=0;n<e.length;n++)for(let r=0;r<e[n].length;r++)if(null!=e[n][r]&&e[n][r].v){t.push(e[n][r].v);let s=e[n][r].ct.fa;l="General"==l?s:l}else t.push(null);return[e=t,l]},getRangeArrayTwo:function(e){let t=$.extend(!0,[],e);if(1==t.length)for(let e=0;e<t[0].length;e++)t[0][e]instanceof Object&&(null!=t[0][e]&&t[0][e]instanceof Object&&t[0][e].m?t[0][e]=t[0][e].m:null!=t[0][e]&&t[0][e]instanceof Object&&t[0][e].v?t[0][e]=t[0][e].v:t[0][e]=null);else if(1==t[0].length)for(let e=0;e<t.length;e++)t[e][0]instanceof Object&&(null!=t[e][0]&&t[e][0]instanceof Object&&t[e][0].m?t[e][0]=t[e][0].m:null!=t[e][0]&&t[e][0]instanceof Object&&t[e][0].v?t[e][0]=t[e][0].v:t[e][0]=null);else for(let e=0;e<t.length;e++)for(let l=0;l<t[e].length;l++)t[e][l]instanceof Object&&(null!=t[e][l]&&t[e][l]instanceof Object&&t[e][l].m?t[e][l]=t[e][l].m:null!=t[e][l]&&t[e][l]instanceof Object&&t[e][l].v?t[e][l]=t[e][l].v:t[e][l]=null);return t},isWildcard:function(e,t){let l=this;e=e.toString(),t=t.toString(),l.isCompareOperator(t).flag&&(t=l.isCompareOperator(t).num);let n="";for(let e=0;e<t.length;e++){let l=t.charAt(e);"*"==l?n+=".*":"?"==l?n+=".":"~"==l?"*"==t.charAt(e+1)?(n+="\\*",e++):"?"==t.charAt(e+1)?(n+="\\?",e++):n+="~":n+=l}let r=new RegExp("^"+n+"$","g");return!!e.match(r)},isCompareOperator:function(e){let t,l="",n="",r=(e=e.toString()).substr(0,1),s=e.substr(1,1),a=!1;return">"==r?"="==s?(l=e.substr(0,2),n=e.substr(2),a=!0):"="!=s&&(l=e.substr(0,1),n=e.substr(1),a=!0):"<"==r?"="==s||">"==s?(l=e.substr(0,2),n=e.substr(2),a=!0):"="!=s&&">"!=s&&(l=e.substr(0,1),n=e.substr(1),a=!0):"="==r&&"="!=s&&(l=e.substr(0,1),n=e.substr(1),a=!0),t={flag:a,ope:l,num:n}},acompareb:function(e,t){let l=this,n=!1;if(G(t))n=fe(e,"==",t);else if("string"==typeof t){if(-1!=t.indexOf("*")||-1!=t.indexOf("?"))return l.isWildcard(e,t);if(l.isCompareOperator(t).flag){let r=l.isCompareOperator(t).ope,s=l.isCompareOperator(t).num;n=fe(e,r,s)}else n=fe(e,"==",t)}return n},compareParams:function(e,t,l){let n=!1,r=toString.call(e),s=toString.call(t);if(">"==l&&e>t?n=!0:">="==l&&e>=t?n=!0:"<"==l&&e<t?n=!0:"<="==l&&e<=t?n=!0:"="==l&&e==t?n=!0:"<>"==l&&e!=t&&(n=!0),"[object Object]"==r&&"[object Object]"==s){let l=Object.getOwnPropertyNames(e),n=Object.getOwnPropertyNames(t);if(l.length!=n.length)return!1;for(let n=0;n<l.length;n++){let r=l[n];if(e[r]!==t[r])return!1}return!0}return"[object Array]"==r&&"[object Array]"==s?e.toString()==t.toString():n},parseDecimal:function(e){e=parseFloat(e);let t=parseInt(e,10);return 0==t?e:e%=t},getcellrange:function(e,t){if(null==e||0==e.length)return;let l="",n="",r=null,s=null,a=L();if(e.indexOf("!")>-1){if(e in this.cellTextToIndexList)return this.cellTextToIndexList[e];let t=e.split("!");l=t[0],n=t[1],"'"==(l=l.replace(/\\'/g,"'").replace(/''/g,"'")).substr(0,1)&&"'"==l.substr(l.length-1,1)&&(l=l.substring(1,l.length-1));for(let e in a)if(l==a[e].name){r=a[e].index,s=a[e].data;break}}else{let i=t;if(null==i&&(i=S.currentSheetIndex),e+"_"+i in this.cellTextToIndexList)return this.cellTextToIndexList[e+"_"+i];let c=O(i);l=a[c].name,r=a[c].index,s=S.flowdata,n=e}if(-1==n.indexOf(":")){let t=parseInt(n.replace(/[^0-9]/g,""))-1,l=T(n.replace(/[^A-Za-z]/g,""));if(isNaN(t)||isNaN(l))return null;{let n={row:[t,t],column:[l,l],sheetIndex:r};return this.addToCellIndexList(e,n),n}}{n=n.split(":");let t=[],l=[];if(t[0]=parseInt(n[0].replace(/[^0-9]/g,""))-1,t[1]=parseInt(n[1].replace(/[^0-9]/g,""))-1,isNaN(t[0])&&(t[0]=0),isNaN(t[1])&&(t[1]=s.length-1),t[0]>t[1])return null;if(l[0]=T(n[0].replace(/[^A-Za-z]/g,"")),l[1]=T(n[1].replace(/[^A-Za-z]/g,"")),isNaN(l[0])&&(l[0]=0),isNaN(l[1])&&(l[1]=s[0].length-1),l[0]>l[1])return null;let a={row:t,column:l,sheetIndex:r};return this.addToCellIndexList(e,a),a}},rangeHightlightHTML:'<div id="luckysheet-formula-functionrange-highlight-${id}" rangeindex="${id}"  class="luckysheet-selection-highlight luckysheet-formula-functionrange-highlight"><div data-type="top" class="luckysheet-selection-copy-top luckysheet-copy"></div><div data-type="right" class="luckysheet-selection-copy-right luckysheet-copy"></div><div data-type="bottom" class="luckysheet-selection-copy-bottom luckysheet-copy"></div><div data-type="left" class="luckysheet-selection-copy-left luckysheet-copy"></div><div class="luckysheet-selection-copy-hc"></div><div data-type="lt" class="luckysheet-selection-highlight-topleft luckysheet-highlight"></div><div data-type="rt" class="luckysheet-selection-highlight-topright luckysheet-highlight"></div><div data-type="lb" class="luckysheet-selection-highlight-bottomleft luckysheet-highlight"></div><div data-type="rb" class="luckysheet-selection-highlight-bottomright luckysheet-highlight"></div></div>',createRangeHightlight:function(){let e=this,t=$("#luckysheet-rich-text-editor").find("span.luckysheet-formula-functionrange-cell");$("#luckysheet-formula-functionrange .luckysheet-formula-functionrange-highlight").remove(),t.each(function(){let t=$(this).attr("rangeindex"),l=$(this).text();$("#luckysheet-formula-functionrange").append(I(e.rangeHightlightHTML,{id:t}));let n=e.getcellrange(l),r="luckysheet-formula-functionrange-highlight-"+t;null==n||(n.sheetIndex==S.currentSheetIndex||-1==n.sheetIndex&&e.rangetosheet==S.currentSheetIndex)&&($("#"+r).data("range",n).find(".luckysheet-copy").css({background:M[t]}).end().find(".luckysheet-highlight").css({background:M[t]}).end().find(".luckysheet-selection-copy-hc").css({background:M[t]}),P(r,n.row[0],n.row[1],n.column[0],n.column[1]))}),$("#luckysheet-formula-functionrange .luckysheet-formula-functionrange-highlight").show()},searchHTML:'<div id="luckysheet-formula-search-c" class="luckysheet-formula-search-c"></div>',helpHTML:'<div id="luckysheet-formula-help-c" class="luckysheet-formula-help-c"> <div class="luckysheet-formula-help-close" title="${helpClose}"><i class="fa fa-times" aria-hidden="true"></i></div> <div class="luckysheet-formula-help-collapse" title="${helpCollapse}"><i class="fa fa-angle-up" aria-hidden="true"></i></div> <div class="luckysheet-formula-help-title"><div class="luckysheet-formula-help-title-formula"> <span class="luckysheet-arguments-help-function-name">SUM</span> <span class="luckysheet-arguments-paren">(</span> <span class="luckysheet-arguments-parameter-holder"> <span class="luckysheet-arguments-help-parameter luckysheet-arguments-help-parameter-active" dir="auto">A2:A100</span>, <span class="luckysheet-arguments-help-parameter" dir="auto">101</span> </span> <span class="luckysheet-arguments-paren">)</span> </div></div> <div class="luckysheet-formula-help-content"> <div class="luckysheet-formula-help-content-example"> <div class="luckysheet-arguments-help-section-title">${helpExample}</div> <div class="luckysheet-arguments-help-formula"> <span class="luckysheet-arguments-help-function-name">SUM</span> <span class="luckysheet-arguments-paren">(</span> <span class="luckysheet-arguments-parameter-holder"> <span class="luckysheet-arguments-help-parameter luckysheet-arguments-help-parameter-active" dir="auto">A2:A100</span>, <span class="luckysheet-arguments-help-parameter" dir="auto">101</span> </span> <span class="luckysheet-arguments-paren">)</span> </div> </div> <div class="luckysheet-formula-help-content-detail"> <div class="luckysheet-arguments-help-section"> <div class="luckysheet-arguments-help-section-title luckysheet-arguments-help-parameter-name">${helpAbstract}</div> <span class="luckysheet-arguments-help-parameter-content">${helpAbstract}</span> </div> </div> <div class="luckysheet-formula-help-content-param"> ${param} </div> </div> <div class="luckysheet-formula-help-foot"></div></div>',getrangeseleciton:function(){let e=window.getSelection(),t=$(e.anchorNode),l=e.anchorOffset;if(t.parent().is("span")&&0!=l){let e=$.trim(t.text()),n="";if(0==e.length&&t.parent().prev().length>0){let l=t.parent().prev();return n=(e=$.trim(l.text())).substr(e.length-1,1),l}return n=e.substr(l-1,1),t.parent()}if(t.is("#luckysheet-rich-text-editor")||t.is("#luckysheet-functionbox-cell")){let e=$.trim(t.find("span").last().text());if(0==e.length&&t.find("span").length>1){let l=t.find("span");return e=$.trim(l.eq(l.length-2).text()),l}return t.find("span").last()}if((t.parent().is("#luckysheet-rich-text-editor")||t.parent().is("#luckysheet-functionbox-cell")||0==l)&&(0==l&&(t=t.parent()),t.prev().length>0)){let e=$.trim(t.prev().text());e.substr(e.length-1,1);return t.prev()}return null},searchFunctionPosition:function(e,t,l,n,r){let s=$(window).height(),a=$(window).width(),i=e.outerWidth(),c=e.outerHeight();null==r&&(r=!1);let u=l;u=l+i>a?l-i+t.outerWidth():l;let o=n;n+c>s?o=n-c:(o=n+t.outerHeight(),r||e.html(e.find(".luckysheet-formula-search-item").get().reverse())),o<0&&(o=0),u<0&&(u=0),e.css({top:o,left:u}).show()},searchFunctionCell:null,searchFunction:function(e){let t=S.functionlist,l=this.getrangeseleciton();if(this.searchFunctionCell=l,null==l||null==e)return;let n=e.text(),r=l.text().toUpperCase();if(!/^[a-zA-Z]|[a-zA-Z_]+$/.test(r)||"="!=n.substr(0,1))return;let s={f:[],s:[],t:[]},a=0;for(let e=0;e<t.length;e++){let l=t[e],n=l.n;if(n==r?(s.f.unshift(l),a++):n.substr(0,r.length)==r?(s.s.unshift(l),a++):n.indexOf(r)>-1&&(s.t.unshift(l),a++),a>=10)break}let i=s.t.concat(s.s.concat(s.f));if(i.length<=0)return;let c=this.searchFunctionHTML(i);$("#luckysheet-formula-search-c").html(c).show(),$("#luckysheet-formula-help-c").hide();let u=e.parent(),o=u.offset();this.searchFunctionPosition($("#luckysheet-formula-search-c"),u,o.left,o.top)},searchFunctionEnter:function(e){let t=e.data("func");this.searchFunctionCell.text(t).after('<span dir="auto" class="luckysheet-formula-text-color">(</span>'),this.setCaretPosition(this.searchFunctionCell.next().get(0),0,1),$("#luckysheet-formula-search-c").hide(),this.helpFunctionExe(this.searchFunctionCell.closest("div"),this.searchFunctionCell.next())},searchFunctionHTML:function(e){let t=this;0==$("#luckysheet-formula-search-c").length&&($("body").append(t.searchHTML),$("#luckysheet-formula-search-c").on("mouseover",".luckysheet-formula-search-item",function(){$("#luckysheet-formula-search-c").find(".luckysheet-formula-search-item").removeClass("luckysheet-formula-search-item-active"),$(this).addClass("luckysheet-formula-search-item-active")}).on("mouseout",".luckysheet-formula-search-item",function(){}).on("click",".luckysheet-formula-search-item",function(){null!=t.searchFunctionCell&&t.searchFunctionEnter($(this))}));let l='<div data-func="${n}" class="luckysheet-formula-search-item ${class}"><div class="luckysheet-formula-search-func">${n}</div><div class="luckysheet-formula-search-detail">${a}</div></div>',n="";for(let t=0;t<e.length;t++){let r=e[t];t==e.length-1?n+=I(l,{class:"luckysheet-formula-search-item-active",n:r.n,a:r.a}):n+=I(l,{class:"",n:r.n,a:r.a})}return n},functionlistPosition:{},helpFunction:function(e,t,l){let n=S.functionlist[this.functionlistPosition[$.trim(t).toUpperCase()]];if(null==n)return;let r=F().formulaMore;$("#luckysheet-formula-help-c .luckysheet-arguments-help-function-name").html(n.n),$("#luckysheet-formula-help-c .luckysheet-arguments-help-parameter-content").html(n.d);let s="",a="",i="";for(let e=0;e<n.p.length;e++){let t=n.p[e],l=t.name,c=t.name;"y"==t.repeat&&(l+=", ...",c+='<span class="luckysheet-arguments-help-argument-info">...-'+r.allowRepeatText+"</span>"),"o"==t.require&&(l="["+l+"]",c+='<span class="luckysheet-arguments-help-argument-info">-['+r.allowOptionText+"]</span>"),s+='<span class="luckysheet-arguments-help-parameter" dir="auto">'+l+"</span>, ",a+='<span class="luckysheet-arguments-help-parameter" dir="auto">'+t.example+"</span>, ",i+=I('<div class="luckysheet-arguments-help-section"><div class="luckysheet-arguments-help-section-title">${param}</div><span class="luckysheet-arguments-help-parameter-content">${content}</span></div>',{param:c,content:t.detail})}if(s=s.substr(0,s.length-2),a=a.substr(0,a.length-2),$("#luckysheet-formula-help-c .luckysheet-formula-help-title .luckysheet-arguments-parameter-holder").html(s),$("#luckysheet-formula-help-c .luckysheet-arguments-help-formula .luckysheet-arguments-parameter-holder").html(a),$("#luckysheet-formula-help-c .luckysheet-formula-help-content-param").html(i),null==l)$("#luckysheet-formula-help-c .luckysheet-formula-help-title-formula .luckysheet-arguments-help-function-name").css("font-weight","bold");else{$("#luckysheet-formula-help-c .luckysheet-formula-help-title-formula .luckysheet-arguments-help-function-name").css("font-weight","normal");let e=l>=n.p.length?n.p.length-1:l;$("#luckysheet-formula-help-c .luckysheet-formula-help-title .luckysheet-arguments-parameter-holder .luckysheet-arguments-help-parameter").removeClass("luckysheet-arguments-help-parameter-active"),$("#luckysheet-formula-help-c .luckysheet-formula-help-title .luckysheet-arguments-parameter-holder .luckysheet-arguments-help-parameter").eq(e).addClass("luckysheet-arguments-help-parameter-active"),$("#luckysheet-formula-help-c .luckysheet-arguments-help-formula .luckysheet-arguments-parameter-holder .luckysheet-arguments-help-parameter").removeClass("luckysheet-arguments-help-parameter-active"),$("#luckysheet-formula-help-c .luckysheet-arguments-help-formula .luckysheet-arguments-parameter-holder .luckysheet-arguments-help-parameter").eq(e).addClass("luckysheet-arguments-help-parameter-active"),$("#luckysheet-formula-help-c .luckysheet-formula-help-content-param .luckysheet-arguments-help-section").removeClass("luckysheet-arguments-help-parameter-active"),$("#luckysheet-formula-help-c .luckysheet-formula-help-content-param .luckysheet-arguments-help-section").eq(e).addClass("luckysheet-arguments-help-parameter-active")}let c=e.parent(),u=c.offset();this.searchFunctionPosition($("#luckysheet-formula-help-c"),c,u.left,u.top,!0)},helpFunctionExe:function(e,t){let l=this,n=S.functionlist,r=F().formulaMore;if(0==$("#luckysheet-formula-help-c").length){$("body").after(I(l.helpHTML,{helpClose:r.helpClose,helpCollapse:r.helpCollapse,helpExample:r.helpExample,helpAbstract:r.helpAbstract})),$("#luckysheet-formula-help-c .luckysheet-formula-help-close").click(function(){$("#luckysheet-formula-help-c").hide()}),$("#luckysheet-formula-help-c .luckysheet-formula-help-collapse").click(function(){let e=$("#luckysheet-formula-help-c .luckysheet-formula-help-content");e.slideToggle(100,function(){let e=l.rangeResizeTo.parent(),t=e.offset();l.searchFunctionPosition($("#luckysheet-formula-help-c"),e,t.left,t.top,!0)}),e.is(":hidden")?$(this).html('<i class="fa fa-angle-up" aria-hidden="true"></i>'):$(this).html('<i class="fa fa-angle-down" aria-hidden="true"></i>')});for(let e=0;e<n.length;e++)l.functionlistPosition[n[e].n]=e}if(!t)return;let s=t,a=(e.length,e.find("span")),i=t.index(),c=i;if(null==s)return;let u=null,o=null;if(a.eq(c).is(".luckysheet-formula-text-func"))u=a.eq(c).text();else{let e=null,t=[-1,-1];for(;--c>0;)if((e=a.eq(c)).is(".luckysheet-formula-text-func")||$.trim(e.text()).toUpperCase()in l.functionlistPosition){u=e.text(),o=null;let l=!0;for(let n=c;n<=i;n++)if(o||(o=0),!(n>=t[0]&&n<=t[1])){if((e=a.eq(n)).is(".luckysheet-formula-text-rpar")){t=[c,n],u=null,l=!1;break}e.is(".luckysheet-formula-text-comma")&&o++}if(l)break}}null!=u&&l.helpFunction(e,u,o)},rangeHightlightselected:function(e,t){let l=this,n=l.getrangeseleciton();if($("#luckysheet-formula-search-c, #luckysheet-formula-help-c").hide(),$("#luckysheet-formula-functionrange .luckysheet-formula-functionrange-highlight .luckysheet-selection-copy-hc").css("opacity","0.03"),$("#luckysheet-formula-search-c, #luckysheet-formula-help-c").hide(),l.helpFunctionExe(e,n),0==$(n).closest(".luckysheet-formula-functionrange-cell").length)return void l.searchFunction(e);let r=$(n).closest(".luckysheet-formula-functionrange-cell").attr("rangeindex");$("#"+("luckysheet-formula-functionrange-highlight-"+r)).find(".luckysheet-selection-copy-hc").css({opacity:"0.13"})},updatecell:function(e,t,l,n=!0){let s=this,a=$("#luckysheet-rich-text-editor"),i=a.text(),c=a.html();if(null!=s.rangetosheet&&s.rangetosheet!=S.currentSheetIndex&&r.changeSheetExec(s.rangetosheet),!E(e,t,S.currentSheetIndex))return;if(null!=u.dataVerification){let l=u.dataVerification[e+"_"+t];if(null!=l&&l.prohibitInput&&!u.validateCellData(i,l)){let e=u.getFailureText(l);return x.info(e,""),void s.cancelNormalSelected()}}let o=S.flowdata[e][t];const h=JSON.stringify(o);let f=oe(o),g="="!=i.slice(0,1)&&"<span"==c.substr(0,5),d=!1;if(!g&&i&&i.length>0){let e=i.replace(/\r\n/g,"_x000D_").replace(/&#13;&#10;/g,"_x000D_").replace(/\r/g,"_x000D_").replace(/\n/g,"_x000D_").split("_x000D_");e.length>1&&(d=!0,g=!0,i=e.join("\r\n"))}if(l||g||!f?g&&("object"!=R(o)&&(o={}),delete o.f,delete o.v,delete o.m,null==o.ct&&(o.ct={},o.ct.fa="General"),o.ct.t="inlineStr",o.ct.s=he(a.find("span")),d&&(o.ct.s=[{v:i}])):(delete o.ct.s,o.ct.t="g",o.ct.fa="General",l=""),l=l||a.text(),!q.createHookFunction("cellUpdateBefore",e,t,l,n))return void s.cancelNormalSelected();if(!g){if(V(l)&&!f){if(null==o||V(o.v)&&null==o.spl&&null==o.f)return void s.cancelNormalSelected()}else if(null!=o&&1!=o.qp){if("object"==R(o)&&(l==o.f||l==o.v||l==o.m))return void s.cancelNormalSelected();if(l==o)return void s.cancelNormalSelected()}"string"==R(l)&&"="==l.slice(0,1)&&l.length>1||"object"!=R(o)||null==o.ct||null==o.ct.fa||"@"==o.ct.fa||V(l)||(delete o.m,null!=o.f&&(delete o.f,delete o.spl))}window.luckysheet_getcelldata_cache=null;let p=!0,m=y.deepCopyFlowData(S.flowdata),k=null;if("object"==R(o)){if(!g)if("string"==R(l)&&"="==l.slice(0,1)&&l.length>1){let n=s.execfunction(l,e,t,void 0,!0);if(p=!1,(o=$.extend(!0,{},m[e][t])).v=n[1],o.f=n[2],4==n.length&&"sparklines"==n[3].type){delete o.m,delete o.v;let e=n[3].data;"array"==R(e)&&"object"!=R(e[0])?o.v=e[0]:o.spl=n[3].data}else 4==n.length&&"dynamicArrayItem"==n[3].type&&(k=n[3].data)}else if("object"==R(l)){let n=l.f;if("string"==R(n)&&"="==n.slice(0,1)&&n.length>1){let l=s.execfunction(n,e,t,void 0,!0);if(p=!1,(o=$.extend(!0,{},m[e][t])).v=l[1],o.f=l[2],4==l.length&&"sparklines"==l[3].type){delete o.m,delete o.v;let e=l[3].data;"array"==R(e)&&"object"!=R(e[0])?o.v=e[0]:o.spl=l[3].data}else 4==l.length&&"dynamicArrayItem"==l[3].type&&(k=l[3].data)}else for(let e in l)o[e]=l[e]}else s.delFunctionGroup(e,t),s.execFunctionGroup(e,t,l),p=!1,(o=$.extend(!0,{},m[e][t])).v=l,delete o.f,delete o.spl,1==o.qp&&"'"!=(""+l).substr(0,1)&&(o.qp=0,null!=o.ct&&(o.ct.fa="General",o.ct.t="n"));l=o}else if("string"==R(l)&&"="==l.slice(0,1)&&l.length>1){let n=s.execfunction(l,e,t,void 0,!0);if(p=!1,l={v:n[1],f:n[2]},4==n.length&&"sparklines"==n[3].type){let e=n[3].data;"array"==R(e)&&"object"!=R(e[0])?l.v=e[0]:l.spl=n[3].data}else 4==n.length&&"dynamicArrayItem"==n[3].type&&(k=n[3].data)}else if("object"==R(l)){let n=l.f;if("string"==R(n)&&"="==n.slice(0,1)&&n.length>1){let r=s.execfunction(n,e,t,void 0,!0);if(p=!1,l.v=r[1],l.f=r[2],4==r.length&&"sparklines"==r[3].type){let e=r[3].data;"array"==R(e)&&"object"!=R(e[0])?l.v=e[0]:l.spl=r[3].data}else 4==r.length&&"dynamicArrayItem"==r[3].type&&(k=r[3].data)}else{let e=o;null==l.v&&(l.v=e)}}else s.delFunctionGroup(e,t),s.execFunctionGroup(e,t,l),p=!1;te(e,t,m,l),s.cancelNormalSelected();let b=!1,v=$.extend(!0,{},L()[O(S.currentSheetIndex)].config);if(null==v.rowlen&&(v.rowlen={}),"2"==m[e][t].tb&&null!=m[e][t].v||oe(m[e][t])){let l=S.defaultrowlen,n=$("#luckysheetTableContent").get(0).getContext("2d");if(v.customHeight&&1==v.customHeight[e]);else{let r=ae(t)[1]-ae(t)[0]-2,s=J(m[e][t],n,{r:e,c:t,cellWidth:r}),a=l;null!=s&&(a=s.textHeightAll+2),a>l&&(v.rowlen[e]=a,b=!0)}}let _=null;k&&(_=$.extend(!0,[],this.insertUpdateDynamicArray(k)));let w={dynamicArray:_};if(b&&(w={cfg:v,dynamicArray:_,RowlChange:b}),setTimeout(()=>{q.createHookFunction("cellUpdated",e,t,JSON.parse(h),S.flowdata[e][t],n)},0),!n)return{data:m,allParam:w};ue(m,[{row:[e,e],column:[t,t]}],w,p),s.execFunctionGlobalData=null},cancelNormalSelected:function(){this.canceFunctionrangeSelected(),$("#luckysheet-formula-functionrange .luckysheet-formula-functionrange-highlight").remove(),$("#luckysheet-input-box").removeAttr("style"),$("#luckysheet-input-box-index").hide(),$("#luckysheet-wa-functionbox-cancel, #luckysheet-wa-functionbox-confirm").removeClass("luckysheet-wa-calculate-active"),this.rangestart=!1,this.rangedrag_column_start=!1,this.rangedrag_row_start=!1},canceFunctionrangeSelected:function(){$("#luckysheet-formula-functionrange-select").hide(),$("#luckysheet-row-count-show, #luckysheet-column-count-show").hide(),$("#luckysheet-formula-search-c, #luckysheet-formula-help-c").hide()},iscellformat:function(e){},iscelldata:function(e){let t,l=e.split("!"),n=/^(([a-zA-Z]+)|([$][a-zA-Z]+))(([0-9]+)|([$][0-9]+))$/g,r=/^(((([a-zA-Z]+)|([$][a-zA-Z]+))(([0-9]+)|([$][0-9]+)))|((([a-zA-Z]+)|([$][a-zA-Z]+))))$/g;if(-1==(t=l.length>1?l[1]:l[0]).indexOf(":")){let e=parseInt(t.replace(/[^0-9]/g,""))-1,l=T(t.replace(/[^A-Za-z]/g,""));return!(isNaN(e)||isNaN(l)||!t.toString().match(n))||!!isNaN(e)&&(isNaN(l),!1)}{r=/^(((([a-zA-Z]+)|([$][a-zA-Z]+))(([0-9]+)|([$][0-9]+)))|((([a-zA-Z]+)|([$][a-zA-Z]+)))|((([0-9]+)|([$][0-9]+s))))$/g,t=t.split(":");let e=[],l=[];return e[0]=parseInt(t[0].replace(/[^0-9]/g,""))-1,e[1]=parseInt(t[1].replace(/[^0-9]/g,""))-1,e[0]>e[1]?!1:(l[0]=T(t[0].replace(/[^A-Za-z]/g,"")),l[1]=T(t[1].replace(/[^A-Za-z]/g,"")),!(l[0]>l[1])&&!(!t[0].toString().match(r)||!t[1].toString().match(r)))}},operator:"==|!=|<>|<=|>=|=|+|-|>|<|/|*|%|&|^",operatorjson:null,functionCopy:function(e,t,l){let n=this;if(null==n.operatorjson){let e=n.operator.split("|"),t={};for(let l=0;l<e.length;l++)t[e[l].toString()]=1;n.operatorjson=t}null==t&&(t="down"),null==l&&(l=1),"="==e.substr(0,1)&&(e=e.substr(1));let r=e.split(""),s=0,a="",i="",c={bracket:0,comma:0,squote:0,dquote:0};for(;s<r.length;){let e=r[s];if("("==e&&0==c.dquote)c.bracket+=1,a.length>0?i+=a+"(":i+="(",a="";else if(")"==e&&0==c.dquote)c.bracket-=1,i+=n.functionCopy(a,t,l)+")",a="";else if('"'==e&&0==c.squote)c.dquote>0?(i+=a+'"',c.dquote-=1,a=""):(c.dquote+=1,a+='"');else if(","==e&&0==c.dquote)i+=n.functionCopy(a,t,l)+",",a="";else if("&"==e&&0==c.dquote)a.length>0?(i+=n.functionCopy(a,t,l)+"&",a=""):i+="&";else if(e in n.operatorjson&&0==c.dquote){let c="";s+1<r.length&&(c=r[s+1]);let u=s-1,o=null;if(u>=0)do{o=r[u--]}while(u>=0&&" "==o);e+c in n.operatorjson?(a.length>0?(i+=n.functionCopy(a,t,l)+e+c,a=""):i+=e+c,s++):!/[^0-9]/.test(c)&&"-"==e&&("("==o||null==o||","==o||" "==o||o in n.operatorjson)?a+=e:a.length>0?(i+=n.functionCopy(a,t,l)+e,a=""):i+=e}else a+=e;s==r.length-1&&(n.iscelldata($.trim(a))?"down"==t?i+=n.downparam($.trim(a),l):"up"==t?i+=n.upparam($.trim(a),l):"left"==t?i+=n.leftparam($.trim(a),l):"right"==t&&(i+=n.rightparam($.trim(a),l)):i+=$.trim(a)),s++}return i},isfreezonFuc:function(e){let t=e.replace(/[^0-9]/g,""),l=e.replace(/[^A-Za-z]/g,""),n=e.substr(e.indexOf(t)-1,1),r=e.substr(e.indexOf(l)-1,1),s=[!1,!1];return"$"==n&&(s[0]=!0),"$"==r&&(s[1]=!0),s},setfreezonFuceExe:function(e){let t=parseInt(e.replace(/[^0-9]/g,"")),l=T(e.replace(/[^A-Za-z]/g,""));return isNaN(t)||isNaN(l)?isNaN(t)?isNaN(l)?e:"$"+N(l):"$"+t:"$"+N(l)+"$"+t},setfreezonFuc:function(e){let t=this,l=t.getrangeseleciton();if(!t.iscelldata(l.text()))return;let n,r=l.text(),s=window.getSelection().anchorOffset,a=r.split("!"),i="";a.length>1?(n=a[1],i=a[0]+"!"):n=a[0];let c="",u="",o=n.indexOf(":");if(-1==o)u=(c=i+t.setfreezonFuceExe(n)).length;else if(n=n.split(":"),s>o){let e=i+n[0]+":"+t.setfreezonFuceExe(n[1]);c=e,u=e.length}else{let e=i+t.setfreezonFuceExe(n[0]);c=e+":"+n[1],u=e.length}l.text(i+c),t.setCaretPosition(l.get(0),0,u)},updateparam:function(e,t,l){let n,r=this,s=t.split("!"),a="";if(s.length>1?(n=s[1],a=s[0]+"!"):n=s[0],-1==n.indexOf(":")){let s=parseInt(n.replace(/[^0-9]/g,"")),i=T(n.replace(/[^A-Za-z]/g,"")),c=r.isfreezonFuc(n),u=c[0]?"$":"",o=c[1]?"$":"";return"u"!=e||c[0]?"r"!=e||c[1]?"l"!=e||c[1]?"d"!=e||c[0]||(s+=l):i-=l:i+=l:s-=l,s[0]<0||i[0]<0?r.error.r:isNaN(s)||isNaN(i)?isNaN(s)?isNaN(i)?t:a+o+N(i):a+u+s:a+o+N(i)+u+s}{n=n.split(":");let s=[],i=[];if(s[0]=parseInt(n[0].replace(/[^0-9]/g,"")),s[1]=parseInt(n[1].replace(/[^0-9]/g,"")),s[0]>s[1])return t;if(i[0]=T(n[0].replace(/[^A-Za-z]/g,"")),i[1]=T(n[1].replace(/[^A-Za-z]/g,"")),i[0]>i[1])return t;let c=r.isfreezonFuc(n[0]),u=r.isfreezonFuc(n[1]),o=c[0]?"$":"",h=c[1]?"$":"",f=u[0]?"$":"",g=u[1]?"$":"";return"u"==e?(c[0]||(s[0]-=l),u[0]||(s[1]-=l)):"r"==e?(c[1]||(i[0]+=l),u[1]||(i[1]+=l)):"l"==e?(c[1]||(i[0]-=l),u[1]||(i[1]-=l)):"d"==e&&(c[0]||(s[0]+=l),u[0]||(s[1]+=l)),s[0]<0||i[0]<0?r.error.r:isNaN(i[0])&&isNaN(i[1])?a+o+s[0]+":"+f+s[1]:isNaN(s[0])&&isNaN(s[1])?a+h+N(i[0])+":"+g+N(i[1]):a+h+N(i[0])+o+s[0]+":"+g+N(i[1])+f+s[1]}},downparam:function(e,t){return this.updateparam("d",e,t)},upparam:function(e,t){return this.updateparam("u",e,t)},leftparam:function(e,t){return this.updateparam("l",e,t)},rightparam:function(e,t){return this.updateparam("r",e,t)},functionStrChange:function(e,t,l,n,r,s){let a=this;if(null==a.operatorjson){let e=a.operator.split("|"),t={};for(let l=0;l<e.length;l++)t[e[l].toString()]=1;a.operatorjson=t}"="==e.substr(0,1)&&(e=e.substr(1));let i=e.split(""),c=0,u="",o="",h={bracket:0,comma:0,squote:0,dquote:0};for(;c<i.length;){let e=i[c];if("("==e&&0==h.dquote)h.bracket+=1,u.length>0?o+=u+"(":o+="(",u="";else if(")"==e&&0==h.dquote)h.bracket-=1,o+=a.functionStrChange(u,t,l,n,r,s)+")",u="";else if('"'==e&&0==h.squote)h.dquote>0?(o+=u+'"',h.dquote-=1,u=""):(h.dquote+=1,u+='"');else if(","==e&&0==h.dquote)o+=a.functionStrChange(u,t,l,n,r,s)+",",u="";else if("&"==e&&0==h.dquote)u.length>0?(o+=a.functionStrChange(u,t,l,n,r,s)+"&",u=""):o+="&";else if(e in a.operatorjson&&0==h.dquote){let h="";c+1<i.length&&(h=i[c+1]);let f=c-1,g=null;if(f>=0)do{g=i[f--]}while(f>=0&&" "==g);e+h in a.operatorjson?(u.length>0?(o+=a.functionStrChange(u,t,l,n,r,s)+e+h,u=""):o+=e+h,c++):!/[^0-9]/.test(h)&&"-"==e&&("("==g||null==g||","==g||" "==g||g in a.operatorjson)?u+=e:u.length>0?(o+=a.functionStrChange(u,t,l,n,r,s)+e,u=""):o+=e}else u+=e;c==i.length-1&&(a.iscelldata($.trim(u))?o+=a.functionStrChange_range($.trim(u),t,l,n,r,s):o+=$.trim(u)),c++}return o},functionStrChange_range:function(e,t,l,n,r,s){let a,i,c,u,o,h,f,g,d,p=this,m=e.split("!"),y="";if(m.length>1?(a=m[1],y=m[0]+"!"):a=m[0],-1==a.indexOf(":")){i=c=parseInt(a.replace(/[^0-9]/g,""))-1,u=o=T(a.replace(/[^A-Za-z]/g,""));let e=p.isfreezonFuc(a);h=f=e[0]?"$":"",g=d=e[1]?"$":""}else{if(a=a.split(":"),(i=parseInt(a[0].replace(/[^0-9]/g,""))-1)>(c=parseInt(a[1].replace(/[^0-9]/g,""))-1))return e;if((u=T(a[0].replace(/[^A-Za-z]/g,"")))>(o=T(a[1].replace(/[^A-Za-z]/g,""))))return e;let t=p.isfreezonFuc(a[0]);h=t[0]?"$":"",g=t[1]?"$":"";let l=p.isfreezonFuc(a[1]);f=l[0]?"$":"",d=l[1]?"$":""}if("del"==t){if("row"==l){if(i>=r&&c<=r+s-1)return p.error.r;i>r+s-1?i-=s:i>=r&&(i=r),c>r+s-1?c-=s:c>=r&&(c=r-1),i<0&&(i=0),c<i&&(c=i)}else if("col"==l){if(u>=r&&o<=r+s-1)return p.error.r;u>r+s-1?u-=s:u>=r&&(u=r),o>r+s-1?o-=s:o>=r&&(o=r-1),u<0&&(u=0),o<u&&(o=u)}return i==c&&u==o?isNaN(i)||isNaN(u)?isNaN(i)?isNaN(u)?e:y+g+N(u):y+h+(i+1):y+g+N(u)+h+(i+1):isNaN(u)&&isNaN(o)?y+h+(i+1)+":"+f+(c+1):isNaN(i)&&isNaN(c)?y+g+N(u)+":"+d+N(o):y+g+N(u)+h+(i+1)+":"+d+N(o)+f+(c+1)}if("add"==t)return"row"==l?"lefttop"==n?(i>=r&&(i+=s),c>=r&&(c+=s)):"rightbottom"==n&&(i>r&&(i+=s),c>r&&(c+=s)):"col"==l&&("lefttop"==n?(u>=r&&(u+=s),o>=r&&(o+=s)):"rightbottom"==n&&(u>r&&(u+=s),o>r&&(o+=s))),i==c&&u==o?isNaN(i)||isNaN(u)?isNaN(i)?isNaN(u)?e:y+g+N(u):y+h+(i+1):y+g+N(u)+h+(i+1):isNaN(u)&&isNaN(o)?y+h+(i+1)+":"+f+(c+1):isNaN(i)&&isNaN(c)?y+g+N(u)+":"+d+N(o):y+g+N(u)+h+(i+1)+":"+d+N(o)+f+(c+1)},israngeseleciton:function(e){let t=this;if(null==t.operatorjson){let e=t.operator.split("|"),l={};for(let t=0;t<e.length;t++)l[e[t].toString()]=1;t.operatorjson=l}null==e&&(e=!1);let l=window.getSelection(),n=$(l.anchorNode),r=l.anchorOffset;if(n.parent().is("span")&&0!=r){let l=$.trim(n.text()),s="";if(0==l.length&&n.parent().prev().length>0){let e=n.parent().prev();s=(l=$.trim(e.text())).substr(l.length-1,1),t.rangeSetValueTo=e}else s=l.substr(r-1,1),t.rangeSetValueTo=n.parent();if(e&&("("==s||","==s)||!e&&("("==s||","==s||"="==s||s in t.operatorjson||"&"==s))return!0}else if(n.is("#luckysheet-rich-text-editor")||n.is("#luckysheet-functionbox-cell")){let l,r=$.trim(n.find("span").last().text());if(t.rangeSetValueTo=n.find("span").last(),0==r.length&&n.find("span").length>1){let e=n.find("span");r=$.trim(e.eq(e.length-2).text()),t.rangeSetValueTo=e}if(l=r.substr(r.length-1,1),e&&("("==l||","==l)||!e&&("("==l||","==l||"="==l||l in t.operatorjson||"&"==l))return!0}else if((n.parent().is("#luckysheet-rich-text-editor")||n.parent().is("#luckysheet-functionbox-cell")||0==r)&&(0==r&&(n=n.parent()),n.prev().length>0)){let l=$.trim(n.prev().text()),r=l.substr(l.length-1,1);if(t.rangeSetValueTo=n.prev(),e&&("("==r||","==r)||!e&&("("==r||","==r||"="==r||r in t.operatorjson||"&"==r))return!0}return!1},rangechangeindex:null,rangestart:!1,rangetosheet:null,rangeSetValueTo:null,func_selectedrange:{},rangeSetValue:function(e,t){let l,n=this,r="",s=e.row[0],a=e.column[0];if(r=null!=S.config.merge&&s+"_"+a in S.config.merge?A(S.currentSheetIndex,{column:[a,a],row:[s,s]},n.rangetosheet):A(S.currentSheetIndex,e,n.rangetosheet),n.rangestart||n.rangedrag_column_start||n.rangedrag_row_start)if($("#luckysheet-search-formula-parm").is(":visible")||$("#luckysheet-search-formula-parm-select").is(":visible")){l=$("#luckysheet-rich-text-editor"),$("#luckysheet-search-formula-parm-select-input").val(r),$("#luckysheet-search-formula-parm .parmBox").eq(n.data_parm_index).find(".txt input").val(r);let e=de(r).data;if(e instanceof Array){let t=[];for(let l=0;l<e.length;l++)for(let n=0;n<e[l].length;n++)null==e[l][n]?t.push(null):t.push(e[l][n].v);$("#luckysheet-search-formula-parm .parmBox").eq(n.data_parm_index).find(".val").text(" = {"+t.join(",")+"}")}else $("#luckysheet-search-formula-parm .parmBox").eq(n.data_parm_index).find(".val").text(" = {"+e.v+"}");let t,s=!0,a=[],i=-1;if($("#luckysheet-search-formula-parm .parmBox").each(function(e,t){let l=$(t).find(".txt input").val();""==l&&"m"==$(t).find(".txt input").attr("data_parm_require")&&(s=!1),""!=l&&(i=e)}),-1==i)t="="+$("#luckysheet-search-formula-parm .luckysheet-modal-dialog-title-text").text()+"()";else if(0==i)t="="+$("#luckysheet-search-formula-parm .luckysheet-modal-dialog-title-text").text()+"("+$("#luckysheet-search-formula-parm .parmBox").eq(0).find(".txt input").val()+")";else{for(let e=0;e<=i;e++)a.push($("#luckysheet-search-formula-parm .parmBox").eq(e).find(".txt input").val());t="="+$("#luckysheet-search-formula-parm .luckysheet-modal-dialog-title-text").text()+"("+a.join(",")+")"}let c=n.functionHTMLGenerate(t);if($("#luckysheet-rich-text-editor").html(c),$("#luckysheet-functionbox-cell").html($("#luckysheet-rich-text-editor").html()),s){let e=$.trim(n.functionParserExe($("#luckysheet-rich-text-editor").text())),t=new Function("return "+e)();$("#luckysheet-search-formula-parm .result span").text(t)}}else{let e=window.getSelection().anchorNode,t=(l=$(e).closest("div")).find("span[rangeindex='"+n.rangechangeindex+"']").html(r);n.setCaretPosition(t.get(0),0,r.length)}else{let e='<span class="luckysheet-formula-functionrange-cell" rangeindex="'+n.functionHTMLIndex+'" dir="auto" style="color:'+M[n.functionHTMLIndex]+';">'+r+"</span>";$(e).insertAfter(n.rangeSetValueTo);n.rangechangeindex=n.functionHTMLIndex,l=$(n.rangeSetValueTo).closest("div"),n.setCaretPosition(l.find("span[rangeindex='"+n.rangechangeindex+"']").get(0),0,r.length),n.functionHTMLIndex++}"luckysheet-rich-text-editor"==l.attr("id")?$("#luckysheet-functionbox-cell").html($("#luckysheet-rich-text-editor").html()):$("#luckysheet-rich-text-editor").html($("#luckysheet-functionbox-cell").html())},rangedrag:function(e){let t=this,l=ie(e.pageX,e.pageY),n=l[0]+$("#luckysheet-cell-main").scrollLeft(),r=l[1]+$("#luckysheet-cell-main").scrollTop(),a=re(r),c=a[1],u=a[0],o=a[2],h=se(n),f=h[1],g=h[0],d=h[2],p=0,m=0,y=[];t.func_selectedrange.top>u?(p=u,m=t.func_selectedrange.top+t.func_selectedrange.height-u,y=[o,t.func_selectedrange.row[1]]):t.func_selectedrange.top==u?(p=u,m=t.func_selectedrange.top+t.func_selectedrange.height-u,y=[o,t.func_selectedrange.row[0]]):(p=t.func_selectedrange.top,m=c-t.func_selectedrange.top-1,y=[t.func_selectedrange.row[0],o]);let x=0,k=0,b=[];t.func_selectedrange.left>g?(x=g,k=t.func_selectedrange.left+t.func_selectedrange.width-g,b=[d,t.func_selectedrange.column[1]]):t.func_selectedrange.left==g?(x=g,k=t.func_selectedrange.left+t.func_selectedrange.width-g,b=[d,t.func_selectedrange.column[0]]):(x=t.func_selectedrange.left,k=f-t.func_selectedrange.left-1,b=[t.func_selectedrange.column[0],d]),y[0]=i.changeFreezenIndex(y[0],"h"),y[1]=i.changeFreezenIndex(y[1],"h"),b[0]=i.changeFreezenIndex(b[0],"v"),b[1]=i.changeFreezenIndex(b[1],"v");let v=s.mergeMoveMain(b,y,t.func_selectedrange,p,m,x,k);if(null!=v&&(b=v[0],y=v[1],p=v[2],m=v[3],x=v[4],k=v[5]),t.func_selectedrange.row=y,t.func_selectedrange.column=b,t.func_selectedrange.left_move=x,t.func_selectedrange.width_move=k,t.func_selectedrange.top_move=p,t.func_selectedrange.height_move=m,H(x,p,k,m,y,b),$("#luckysheet-formula-functionrange-select").css({left:x,width:k,top:p,height:m}).show(),$("#luckysheet-ifFormulaGenerator-multiRange-dialog").is(":visible")){let e=A(S.currentSheetIndex,{row:y,column:b},S.currentSheetIndex);$("#luckysheet-ifFormulaGenerator-multiRange-dialog input").val(e)}else t.rangeSetValue({row:y,column:b});i.scrollFreezen(y,b)},rangedrag_column_start:!1,rangedrag_row_start:!1,rangedrag_column:function(e){let t=this,l=ie(e.pageX,e.pageY),n=l[0]+$("#luckysheet-cell-main").scrollLeft(),r=(l[1],$("#luckysheet-cell-main").scrollTop(),S.visibledatarow),a=r.length-1,c=r[a],u=se(n),o=u[1],h=u[0],f=u[2],g=0,d=0,p=[];t.func_selectedrange.left>h?(g=h,d=t.func_selectedrange.left+t.func_selectedrange.width-h,p=[f,t.func_selectedrange.column[1]]):t.func_selectedrange.left==h?(g=h,d=t.func_selectedrange.left+t.func_selectedrange.width-h,p=[f,t.func_selectedrange.column[0]]):(g=t.func_selectedrange.left,d=o-t.func_selectedrange.left-1,p=[t.func_selectedrange.column[0],f]),p[0]=i.changeFreezenIndex(p[0],"v"),p[1]=i.changeFreezenIndex(p[1],"v");let m=s.mergeMoveMain(p,[0,a],t.func_selectedrange,0,c-0-1,g,d);null!=m&&(p=m[0],g=m[4],d=m[5]),t.func_selectedrange.column=p,t.func_selectedrange.left_move=g,t.func_selectedrange.width_move=d,H(g,0,d,c-0-1,[0,a],p),t.rangeSetValue({row:[null,null],column:p}),$("#luckysheet-formula-functionrange-select").css({left:g,width:d,top:0,height:c-0-1}).show(),i.scrollFreezen([0,a],p)},rangedrag_row:function(e){let t=this,l=ie(e.pageX,e.pageY),n=(l[0],$("#luckysheet-cell-main").scrollLeft(),l[1]+$("#luckysheet-cell-main").scrollTop()),r=re(n),a=r[1],c=r[0],u=r[2],o=S.visibledatacolumn,h=o.length-1,f=o[h],g=0,d=0,p=[];t.func_selectedrange.top>c?(g=c,d=t.func_selectedrange.top+t.func_selectedrange.height-c,p=[u,t.func_selectedrange.row[1]]):t.func_selectedrange.top==c?(g=c,d=t.func_selectedrange.top+t.func_selectedrange.height-c,p=[u,t.func_selectedrange.row[0]]):(g=t.func_selectedrange.top,d=a-t.func_selectedrange.top-1,p=[t.func_selectedrange.row[0],u]),p[0]=i.changeFreezenIndex(p[0],"h"),p[1]=i.changeFreezenIndex(p[1],"h");let m=s.mergeMoveMain([0,h],p,t.func_selectedrange,g,d,0,f-0-1);null!=m&&(p=m[1],g=m[2],d=m[3]),t.func_selectedrange.row=p,t.func_selectedrange.top_move=g,t.func_selectedrange.height_move=d,H(0,g,f-0-1,d,p,[0,h]),t.rangeSetValue({row:p,column:[null,null]}),$("#luckysheet-formula-functionrange-select").css({left:0,width:f-0-1,top:g,height:d}).show(),i.scrollFreezen(p,[0,h])},rangedragged:function(){},rangeResizeObj:null,rangeResize:null,rangeResizeIndex:null,rangeResizexy:null,rangeResizeWinH:null,rangeResizeWinW:null,rangeResizeTo:null,rangeResizeDraging:function(e,t,l,n,r,s,a,i){let c=$("#luckysheet-scrollbar-y").scrollTop(),u=$("#luckysheet-scrollbar-x").scrollLeft(),o=ie(e.pageX,e.pageY),h=o[0]+u,f=o[1]+c,g=re(f),d=g[1],p=g[0],m=(g[2],se(h)),y=m[1],x=m[0];m[2];if(h<0||f<0)return!1;let k=p-l[1],b=x-l[0],v=l[5],_=l[3],w=l[4],F=l[2];if("lt"==n||"lb"==n){if(l[0]+l[2]<x)return;w=x,F=l[2]-b,w>l[2]+l[4]-y+x?(w=l[2]+l[4]-y+x,F=l[2]-(l[2]+l[4]-y+x-l[0])):w<=0&&(w=0,F=l[2]+l[0])}if("rt"==n||"rb"==n){if(l[6]-l[2]>y)return;(F=l[2]+y-l[6])<y-x-1?F=y-x-1:F>=a-w&&(F=a-w)}if("lt"==n||"rt"==n){if(l[1]+l[3]<p)return;v=p,_=l[3]-k,v>l[3]+l[5]-d+p?(v=l[3]+l[5]-d+p,_=l[3]-(l[3]+l[5]-d+p-l[1])):v<=0&&(v=0,_=l[3]+l[1])}if("lb"==n||"rb"==n){if(l[7]-l[3]>d)return;(_=l[3]+d-l[7])<d-p-1?_=d-p-1:_>=i-v&&(_=i-v)}let C=this.rangeResizeIndex,q={top:v,left:w,height:_,width:F},I=this.getSelectedFromRange(q),R=A(S.currentSheetIndex,I,this.rangetosheet);this.rangeResizeTo.find("span[rangeindex='"+C+"']").html(R);ce(this.rangeResizeTo[0]),t.css(q).data("range",I)},getSelectedFromRange:function(e){let t=e.top+2,l=e.top+e.height-2,n=e.left+2,r=e.left+e.width-2;return{row:[re(t)[2],re(l)[2]],column:[se(n)[2],se(r)[2]]}},rangeResizeDragged:function(e,t,l,n,r,s){this.rangeResize=null,$("#luckysheet-formula-functionrange-highlight-"+this.rangeResizeIndex).find(".luckysheet-selection-copy-hc").css("opacity",.03)},rangeMovexy:null,rangeMove:!1,rangeMoveObj:null,rangeMoveIndex:null,rangeMoveRangedata:null,rangeMoveDraging:function(e,t,l,n,r,s){let a=ie(e.pageX,e.pageY),i=$("#luckysheet-scrollbar-x").scrollLeft(),c=$("#luckysheet-scrollbar-y").scrollTop(),u=a[0]+i,o=a[1]+c,h=$(window).height()+c-r-s,f=$(window).width()+i,g=t[0],d=t[1],p=l.row[0]-g+re(o)[2],m=l.row[1]-g+re(o)[2],y=l.column[0]-d+se(u)[2],x=l.column[1]-d+se(u)[2];(p<0||o<0)&&(p=0,m=l.row[1]-l.row[0]),(y<0||u<0)&&(y=0,x=l.column[1]-l.column[0]);let k=S.visibledatarow;(m>=k[k.length-1]||o>h)&&(p=k.length-1-l.row[1]+l.row[0],m=k.length-1);let b=S.visibledatacolumn;(x>=b[b.length-1]||u>f)&&(y=b.length-1-l.column[1]+l.column[0],x=b.length-1);let v=y-1==-1?0:b[y-1],_=b[x],w=p-1==-1?0:k[p-1],F=k[m],C=this.rangeMoveIndex,q={left:v,width:_-v-2,top:w,height:F-w-2,display:"block"},I=this.getSelectedFromRange(q),R=A(S.currentSheetIndex,I,this.rangetosheet);this.rangeResizeTo.find("span[rangeindex='"+C+"']").html(R);ce(this.rangeResizeTo[0]),this.rangeMoveRangedata=I,n.css(q)},rangeMoveDragged:function(e){this.rangeMove=!1,$("#luckysheet-formula-functionrange-highlight-"+this.rangeMoveIndex).data("range",this.rangeMoveRangedata).find(".luckysheet-selection-copy-hc").css("opacity",.03)},functionHTMLIndex:0,functionRangeIndex:null,findrangeindex:function(e,t){let l=/<span.*?>/g,n=e.replace(l,""),r=t.replace(l,"");n=n.split("</span>"),r=r.split("</span>"),n.pop(),r.pop();let s=this.functionRangeIndex,a=(r.length>n.length?n.length:r.length,r.length),i=n.length;if(a==i){let e=s[0],t=r[e],l=n[e];if(null==t)return r.length<=e?s=[r.length-1,r.length-1]:n.length<=e&&(s=[n.length-1,n.length-1]),s;if(t.length==l.length)return null!=r[e+1]&&null!=n[e+1]&&r[e+1].length<n[e+1].length&&(s[0]=s[0]+1,s[1]=1),s;if(t.length>l.length)return null!=t&&null!=n[e+1]&&'"'==n[e+1].substr(0,1)&&(t.indexOf("{")>-1||t.indexOf("}")>-1)&&(s[0]=s[0]+1,s[1]=1),s;if(t.length<l.length)return s[1]>l.length&&(s[1]=l.length),s}else{if(a>i){let e=s[0],t=r[e],l=n[e];if(null==l)if(n[e-1].indexOf("{")>-1){s[0]=s[0]-1;let t=n[e-1].search("{");s[1]=s[1]+t}else s[0]=0,s[1]=0;else{if(t.length==l.length)return null==n[e+1]||'"'!=n[e+1].substr(0,1)&&"{"!=n[e+1].substr(0,1)&&"}"!=n[e+1].substr(0,1)?null!=t&&t.length>2&&'"'==t.substr(0,1)&&'"'==t.substr(t.length-1,1)||(null!=n[e]&&'")'==n[e]?s[1]=1:null!=n[e]&&'"}'==n[e]?s[1]=1:null!=n[e]&&"{)"==n[e]?s[1]=1:s[1]=l.length):(s[0]=s[0]+1,s[1]=1),s;if(t.length>l.length)return null==n[e+1]||'"'!=n[e+1].substr(0,1)&&"{"!=n[e+1].substr(0,1)&&"}"!=n[e+1].substr(0,1)||(s[0]=s[0]+1,s[1]=1),s;if(t.length<l.length)return s}return s}if(a<i){let e=s[0],t=r[e],l=n[e];if(null==t)s[0]=n.length-1,s[1]=null!=l?l.length:1;else{if(t.length==l.length)return null==r[e+1]||'"'!=r[e+1].substr(0,1)&&"{"!=r[e+1].substr(0,1)&&"}"!=r[e+1].substr(0,1)?null==n[e+1]||'"'!=n[e+1].substr(0,1)||"{"!=n[e+1].substr(0,1)&&"}"!=n[e+1].substr(0,1)?null!=l&&'"'==l.substr(0,1)&&'"'==l.substr(l.length-1,1)&&'"'==t.substr(0,1)&&")"==t.substr(t.length-1,1)?s[1]=l.length:null!=l&&"{"==l.substr(0,1)&&"}"==l.substr(l.length-1,1)&&"{"==t.substr(0,1)&&")"==t.substr(t.length-1,1)?s[1]=l.length:(s[0]=s[0]+i-a,n.length>r.length?s[1]=n[e+1].length:s[1]=1):(s[0]=s[0]+1,s[1]=1):s[1]=l.length,s;if(t.length>l.length)return null!=t&&'"'==t.substr(0,1)?s[1]=l.length:null!=n[e+1]&&/{.*?}/.test(n[e+1])?(s[0]=s[0]+1,s[1]=n[e+1].length):null!=t&&'"'==n[e+1].substr(0,1)&&(t.indexOf("{")>-1||t.indexOf("}")>-1)?(s[0]=s[0]+1,s[1]=1):null!=t&&(t.indexOf("{")>-1||t.indexOf("}")>-1)||(s[0]=s[0]+i-a-1,s[1]=n[e-1].length),s;if(t.length<l.length)return s}return s}}return null},setCaretPosition:function(e,t,l){try{let n=e,r=document.createRange(),s=window.getSelection();r.setStart(n.childNodes[t],l),r.collapse(!0),s.removeAllRanges(),s.addRange(r),n.focus()}catch(e){ce(this.rangeResizeTo[0])}},functionRange:function(e,t,l){let n=this;if(window.getSelection){let r=window.getSelection(),s=n.findrangeindex(t,l);null==s?(r.selectAllChildren(e.get(0)),r.collapseToEnd()):n.setCaretPosition(e.find("span").get(s[0]),0,s[1])}else document.selection&&(n.functionRangeIndex.moveToElementText(e),n.functionRangeIndex.collapse(!1),n.functionRangeIndex.select())},functionInputHanddler:function(e,t,l){if(U())return;let n=this,r=e,s=t,a=s.html(),i=s.text();setTimeout(function(){let e=s.text();if(e.length>0&&"="==e.substr(0,1)&&(229!=l||1==e.length)){if(e=n.functionHTMLGenerate(e),a=n.functionHTMLGenerate(i),window.getSelection){let e=window.getSelection();if($(e.anchorNode).is("div")){let e=$("#luckysheet-rich-text-editor span").length;n.functionRangeIndex=[e-1,$("#luckysheet-rich-text-editor").find("span").eq(e-1).text().length]}else n.functionRangeIndex=[$(e.anchorNode).parent().index(),e.anchorOffset]}else{let e=document.selection.createRange();n.functionRangeIndex=e}s.html(e),n.functionRange(s,e,a),n.canceFunctionrangeSelected(),46!=l&&n.createRangeHightlight(),r.html(e),n.rangestart=!1,n.rangedrag_column_start=!1,n.rangedrag_row_start=!1,n.rangeHightlightselected(s,l)}else"="!=i.substr(0,1)&&("luckysheet-rich-text-editor"==r.attr("id")&&"<span"==r.html().substr(0,5)||r.html(e))},1)},functionHTMLGenerate:function(e){return 0==e.length||"="!=e.substr(0,1)?e:(this.functionHTMLIndex=0,'<span dir="auto" class="luckysheet-formula-text-color">=</span>'+this.functionHTML(e))},functionHTML:function(e){let t=this;if(null==t.operatorjson){let e=t.operator.split("|"),l={};for(let t=0;t<e.length;t++)l[e[t].toString()]=1;t.operatorjson=l}"="==e.substr(0,1)&&(e=e.substr(1));let l=e.split(""),n=0,r="",s="",a={bracket:0,comma:0,squote:0,dquote:0,braces:0};for(;n<l.length;){let e=l[n];if("("==e&&0==a.squote&&0==a.dquote&&0==a.braces)a.bracket+=1,r.length>0?s+='<span dir="auto" class="luckysheet-formula-text-func">'+r+'</span><span dir="auto" class="luckysheet-formula-text-lpar">(</span>':s+='<span dir="auto" class="luckysheet-formula-text-lpar">(</span>',r="";else if(")"==e&&0==a.squote&&0==a.dquote&&0==a.braces)a.bracket-=1,s+=t.functionHTML(r)+'<span dir="auto" class="luckysheet-formula-text-rpar">)</span>',r="";else if("{"==e&&0==a.squote&&0==a.dquote)r+="{",a.braces+=1;else if("}"==e&&0==a.squote&&0==a.dquote)r+="}",a.braces-=1;else if('"'==e&&0==a.squote)a.dquote>0?(r.length>0?s+=r+'"</span>':s+='"</span>',a.dquote-=1,r=""):(a.dquote+=1,r.length>0?s+=t.functionHTML(r)+'<span dir="auto" class="luckysheet-formula-text-string">"':s+='<span dir="auto" class="luckysheet-formula-text-string">"',r="");else if("'"==e&&0==a.dquote)r+="'",a.squote=0==a.squote?1:0;else if(","==e&&0==a.squote&&0==a.dquote&&0==a.braces)s+=t.functionHTML(r)+'<span dir="auto" class="luckysheet-formula-text-comma">,</span>',r="";else if("&"==e&&0==a.squote&&0==a.dquote&&0==a.braces)r.length>0?(s+=t.functionHTML(r)+'<span dir="auto" class="luckysheet-formula-text-calc">&</span>',r=""):s+='<span dir="auto" class="luckysheet-formula-text-calc">&</span>';else if(e in t.operatorjson&&0==a.squote&&0==a.dquote&&0==a.braces){let a="";n+1<l.length&&(a=l[n+1]);let i=n-1,c=null;if(i>=0)do{c=l[i--]}while(i>=0&&" "==c);e+a in t.operatorjson?(r.length>0?(s+=t.functionHTML(r)+'<span dir="auto" class="luckysheet-formula-text-calc">'+e+a+"</span>",r=""):s+='<span dir="auto" class="luckysheet-formula-text-calc">'+e+a+"</span>",n++):!/[^0-9]/.test(a)&&"-"==e&&("("==c||null==c||","==c||" "==c||c in t.operatorjson)?r+=e:r.length>0?(s+=t.functionHTML(r)+'<span dir="auto" class="luckysheet-formula-text-calc">'+e+"</span>",r=""):s+='<span dir="auto" class="luckysheet-formula-text-calc">'+e+"</span>"}else r+=e;if(n==l.length-1)if(t.iscelldata($.trim(r)))s+='<span class="luckysheet-formula-functionrange-cell" rangeindex="'+t.functionHTMLIndex+'" dir="auto" style="color:'+M[t.functionHTMLIndex]+';">'+r+"</span>",t.functionHTMLIndex++;else if(a.dquote>0)s+=r+"</span>";else if(-1==r.indexOf("</span>")&&r.length>0){let e=/{.*?}/;if(e.test($.trim(r))){let t=e.exec(r)[0],l=r.search(e),n="";l>0&&(n+='<span dir="auto" class="luckysheet-formula-text-color">'+r.substr(0,l)+"</span>"),n+='<span dir="auto" style="color:#959a05" class="luckysheet-formula-text-array">'+t+"</span>",l+t.length<r.length&&(n+='<span dir="auto" class="luckysheet-formula-text-color">'+r.substr(l+t.length,r.length)+"</span>"),s+=n}else s+='<span dir="auto" class="luckysheet-formula-text-color">'+r+"</span>"}n++}return s},getfunctionParam:function(e){let t=this;if(null==t.operatorjson){let e=t.operator.split("|"),l={};for(let t=0;t<e.length;t++)l[e[t].toString()]=1;t.operatorjson=l}"="==e.substr(0,1)&&(e=e.substr(1));let l=e.split(""),n=0,r="",s="",a={bracket:0,comma:0,squote:0,dquote:0,compare:0},i=null,c=[],u=[];for(;n<l.length;){let e=l[n];if("("==e&&0==a.dquote)r.length>0&&0==u.length?(i=r.toUpperCase(),u.push(1),r=""):0==u.length?(u.push(0),r=""):(u.push(0),r+=e);else if(")"==e&&0==a.dquote){u.pop();0==u.length?(c.push(r),r=""):r+=e}else if('"'==e)r+='"',a.dquote>0?(a.dquote-=1,r=""):a.dquote+=1;else if(","==e&&0==a.dquote)u.length<=1?(c.push(r),r=""):r+=",";else if(e in t.operatorjson&&0==a.dquote){let i="";n+1<l.length&&(i=l[n+1]);let c=n-1,u=null;if(c>=0)do{u=l[c--]}while(c>=0&&" "==u);!/[^0-9]/.test(i)&&"-"==e&&("("==u||null==u||","==u||" "==u||u in t.operatorjson)?0==a.dquote?r+=$.trim(e):r+=e:(s="",r="")}else 0==a.dquote?r+=$.trim(e):r+=e;n++}return{fn:i,param:c}},calPostfixExpression:function(e){if(0==e.length)return"";let t=[];for(let l=e.length-1;l>=0;l--){let n=e[l];if(n in this.operatorjson){let e=t.pop(),l="luckysheet_compareWith("+t.pop()+",'"+n+"', "+e+")";t.push(l)}else t.push(n)}return t.length>0?t[0]:""},checkBracketNum:function(e){let t=e.match(/\(/g),l=e.match(/\)/g),n=e.match(/(['"])(?:(?!\1).)*?\1/g),r=e.match(/(['"])(?:(?!\1).)*?\1/g),s=0,a=0;null!=t&&(s+=t.length),null!=l&&(a+=l.length);let i=0,c=0;if(null!=n)for(let e=0;e<n.length;e++){let t=n[e].match(/\(/g);null!=t&&(i+=t.length)}if(null!=r)for(let e=0;e<r.length;e++){let t=r[e].match(/\)/g);null!=t&&(c+=t.length)}return(s-=i)==(a-=c)},operatorPriority:{"^":0,"%":1,"*":1,"/":1,"+":2,"-":2},functionParserExe:function(e){return this.functionParser(e)},functionParser:function(e,t){let l=this;if(null==l.operatorjson){let e=l.operator.split("|"),t={};for(let l=0;l<e.length;l++)t[e[l].toString()]=1;l.operatorjson=t}if(null==e)return"";"=+"==e.substr(0,2)?e=e.substr(2):"="==e.substr(0,1)&&(e=e.substr(1));let n=e.split(""),r=0,s="",a="",i={bracket:0,comma:0,squote:0,dquote:0,compare:0,braces:0},c=[],u=[],o=[],h=-1;for(;r<n.length;){let e=n[r];if("("==e&&0==i.squote&&0==i.dquote&&0==i.braces)if(s.length>0&&0==o.length){if((s=s.toUpperCase()).indexOf(":")>-1){let e=s.split(":");a+="luckysheet_getSpecialReference(true,'"+$.trim(e[0]).replace(/'/g,"\\'")+"', luckysheet_function."+e[1]+".f(#lucky#"}else a+="luckysheet_function."+s+".f(";o.push(1),s=""}else 0==o.length?(a+="(",o.push(0),s=""):(o.push(0),s+=e);else if(")"==e&&0==i.squote&&0==i.dquote&&0==i.braces){o.pop();if(0==o.length){let e=l.functionParser(s,t);e.indexOf("#lucky#")>-1&&(e=e.replace(/#lucky#/g,"")+")"),a+=e+")",s=""}else s+=e}else if("{"==e&&0==i.squote&&0==i.dquote)s+="{",i.braces+=1;else if("}"==e&&0==i.squote&&0==i.dquote)s+="}",i.braces-=1;else if('"'==e&&0==i.squote)i.dquote>0?r<n.length-1&&'"'==n[r+1]?(r++,s+=""):(i.dquote-=1,s+='"'):(i.dquote+=1,s+='"');else if("'"==e&&0==i.dquote)if(s+="'",i.squote>0){if(h==r-1)return"";if(r<n.length-1&&"'"==n[r+1])r++,s+="'";else{if("'"==n[r-1])return"";i.squote-=1}}else i.squote+=1,h=r;else if(","==e&&0==i.squote&&0==i.dquote&&0==i.braces)if(o.length<=1){let e=l.functionParser(s,t);e.indexOf("#lucky#")>-1&&(e=e.replace(/#lucky#/g,"")+")"),a+=e+",",s=""}else s+=",";else if(e in l.operatorjson&&0==i.squote&&0==i.dquote&&0==i.braces){let i="",h=l.operatorPriority;if(r+1<n.length&&(i=n[r+1]),e+i in l.operatorjson){if(0==o.length){if($.trim(s).length>0?u.unshift(l.functionParser($.trim(s),t)):$.trim(a).length>0&&u.unshift($.trim(a)),c[0]in l.operatorjson){let e=h[c[0]];for(;c.length>0&&null!=e;)u.unshift(c.shift()),e=h[c[0]]}c.unshift(e+i),a="",s=""}else s+=e+i;r++}else if(0==o.length){if($.trim(s).length>0?u.unshift(l.functionParser($.trim(s),t)):$.trim(a).length>0&&u.unshift($.trim(a)),c[0]in l.operatorjson){let t=h[c[0]];t=null==t?1e3:t;let l=h[e];for(l=null==l?1e3:l;c.length>0&&l>=t;)u.unshift(c.shift()),t=null==(t=h[c[0]])?1e3:t}c.unshift(e),a="",s=""}else s+=e}else 0==i.dquote&&i.squote,s+=e;if(r==n.length-1){let e="",n=$.trim(s).replace(/'/g,"\\'");if(l.iscelldata(n)&&":"!=n.substr(0,1))e="luckysheet_getcelldata('"+n+"')","function"==typeof t&&t(n);else if(":"==n.substr(0,1))n=n.substr(1),l.iscelldata(n)&&(e="luckysheet_getSpecialReference(false,"+a+",'"+n+"')");else{s=$.trim(s);let t=/{.*?}/;if(t.test(s)&&'"'!=s.substr(0,1)&&'"'!=s.substr(s.length-1,1)){let l=t.exec(s)[0],n=s.search(t);n>0&&(e+=s.substr(0,n)),e+="luckysheet_getarraydata('"+l+"')",n+l.length<s.length&&(e+=s.substr(n+l.length,s.length))}else e=s}if(e.length>0&&u.unshift(e),c.length>0)for(a.length>0&&(u.unshift(a),a="");c.length>0;)u.unshift(c.shift());u.length>0?a=l.calPostfixExpression(u):a+=e}r++}return a},insertUpdateDynamicArray:function(e){let t=e.r,l=e.c,n=e.index;null==n&&(n=S.currentSheetIndex);let r=L()[O(n)].dynamicArray;null==r&&(r=[]);for(let s=0;s<r.length;s++){let a=r[s];if(a.r==t&&a.c==l&&a.index==n)return a.data=e.data,a.f=e.f,r}return r.push(e),r},addFunctionGroup:function(e,t,l,n){null==n&&(n=S.currentSheetIndex);let r=L(),s=r[O(n)];null==s.calcChain&&(s.calcChain=[]);let i={r:e,c:t,index:n,func:l};s.calcChain.push(i),a.saveParam("fc",n,JSON.stringify(i),{op:"add",pos:s.calcChain.length-1}),z(r)},getAllFunctionGroup:function(){let e=L(),t=[];for(let l=0;l<e.length;l++){let n=e[l],r=n.calcChain;if(r){let e=[];r.forEach((t,l)=>{"string"==typeof t?e.push(JSON.parse(t)):e.push(t)}),r=n.calcChain=e}let s=n.dynamicArray_compute;null==r&&(r=[]),null==s&&(s=[]),t=t.concat(r);for(let e=0;e<s.length;e++){let e=s[0];t.push({r:e.r,c:e.c,index:e.index})}}return t},getFunctionGroup:function(e){null==e&&(e=S.currentSheetIndex);let t=L()[O(e)];return null==t.calcChain?[]:t.calcChain},updateFunctionGroup:function(e,t,l){null==l&&(l=S.currentSheetIndex);let n=L(),r=n[O(l)].calcChain;if(null!=r)for(let n=0;n<r.length;n++){let s=r[n];if(s.r==e&&s.c==t&&s.index==l){a.saveParam("fc",l,JSON.stringify(s),{op:"update",pos:n});break}}z(n)},insertUpdateFunctionGroup:function(e,t,l){null==l&&(l=S.currentSheetIndex);let n=L(),r=n[O(l)],s=r.calcChain;null==s&&(s=[]);for(let n=0;n<s.length;n++){let r=s[n];if(r.r==e&&r.c==t&&r.index==l)return void a.saveParam("fc",l,JSON.stringify(r),{op:"update",pos:n})}let i={r:e,c:t,index:l};s.push(i),r.calcChain=s,a.saveParam("fc",l,JSON.stringify(i),{op:"add",pos:r.calcChain.length-1}),z(n)},isFunctionRangeSave:!1,isFunctionRangeSimple:function(e,t,l,n,r){if(null==e||0==e.length)return;let s=e.split(/==|!=|<>|<=|>=|[,()=+-\/*%&^><]/g);if(s.length>0)for(let e=0;e<s.length;e++){let a=s[e];a.length<=1||('"'==a.substr(0,1)&&'"'==a.substr(a.length-1,1)||this.isFunctionRangeSaveChange(a,t,l,n,r))}},isFunctionRangeSimple1:function(e,t,l,n,r){let s=this;if(null==s.operatorjson){let e=s.operator.split("|"),t={};for(let l=0;l<e.length;l++)t[e[l].toString()]=1;s.operatorjson=t}"="==e.substr(0,1)&&(e=e.substr(1));let a=e.split(""),i=0,c="",u="",o={bracket:0,comma:0,squote:0,dquote:0};L();for(;i<a.length;){let e=a[i];if("("==e&&0==o.dquote)o.bracket+=1,c.length>0?u+="luckysheet_function."+c.toUpperCase()+".f(":u+="(",c="";else if(")"==e&&0==o.dquote)o.bracket-=1,u+=s.isFunctionRangeSimple(c,t,l,n,r)+")",c="";else if(","==e&&0==o.dquote)u+=s.isFunctionRangeSimple(c,t,l,n,r)+",",c="";else if(e in s.operatorjson&&0==o.dquote){let o="";i+1<a.length&&(o=a[i+1]),e+o in s.operatorjson?(c.length>0?(u+=s.isFunctionRangeSimple(c,t,l,n,r)+e+o,c=""):u+=e+o,i++):c.length>0?(u+=s.isFunctionRangeSimple(c,t,l,n,r)+e,c=""):u+=e}else c+=e;i==a.length-1&&s.iscelldata($.trim(c))&&s.isFunctionRangeSaveChange(c,t,l,n,r),i++}return u},isFunctionRangeSelect:function(e,t,l,n,r){if(null==e||""==e)return;null==n&&(n=S.currentSheetIndex),null==r&&(r={});let s=this,a=e.toUpperCase(),i=a.indexOf("INDIRECT(")>-1||a.indexOf("OFFSET(")>-1||a.indexOf("INDEX(")>-1;if(e in this.formulaContainCellList){let a=this.formulaContainCellList[e];if(i){if(1==a.__LuckyisOff__)for(let e in a)"__LuckyisOff__"!=e&&this.isFunctionRangeSaveChange(e,t,l,n,r);else this.isFunctionRange(e,t,l,n,r,function(t){s.addToCellList(e,t)}),a.__LuckyisOff__=!0}else for(let e in a)"__LuckyisOff__"!=e&&this.isFunctionRangeSaveChange(e,t,l,n,r)}else i?this.isFunctionRange(e,t,l,n,r):this.isFunctionRangeSimple(e,t,l,n,r)},isFunctionRange:function(e,t,l,n,r,s){let a=this;if(null==a.operatorjson){let e=a.operator.split("|"),t={};for(let l=0;l<e.length;l++)t[e[l].toString()]=1;a.operatorjson=t}"="==e.substr(0,1)&&(e=e.substr(1));let i=e.split(""),c=0,u="",o="",h={bracket:0,comma:0,squote:0,dquote:0,compare:0,braces:0},f=[],g=[],d=[],p=-1;for(;c<i.length;){let e=i[c];if("("==e&&0==h.squote&&0==h.dquote&&0==h.braces)if(u.length>0&&0==d.length){if((u=u.toUpperCase()).indexOf(":")>-1){let e=u.split(":");o+="luckysheet_getSpecialReference(true,'"+$.trim(e[0]).replace(/'/g,"\\'")+"', luckysheet_function."+e[1]+".f(#lucky#"}else o+="luckysheet_function."+u+".f(";d.push(1),u=""}else 0==d.length?(o+="(",d.push(0),u=""):(d.push(0),u+=e);else if(")"==e&&0==h.squote&&0==h.dquote&&0==h.braces){d.pop();if(0==d.length){let e=a.isFunctionRange(u,t,l,n,r,s);e.indexOf("#lucky#")>-1&&(e=e.replace(/#lucky#/g,"")+")"),o+=e+")",u=""}else u+=e}else if("{"==e&&0==h.squote&&0==h.dquote)u+="{",h.braces+=1;else if("}"==e&&0==h.squote&&0==h.dquote)u+="}",h.braces-=1;else if('"'==e&&0==h.squote)h.dquote>0?c<i.length-1&&'"'==i[c+1]?(c++,u+=""):(h.dquote-=1,u+='"'):(h.dquote+=1,u+='"');else if("'"==e&&0==h.dquote)u+="'",h.squote>0?c<i.length-1&&"'"==i[c+1]?(c++,u+="'"):h.squote-=1:(h.squote+=1,p=c);else if(","==e&&0==h.squote&&0==h.dquote&&0==h.braces)if(d.length<=1){let e=a.isFunctionRange(u,t,l,n,r,s);e.indexOf("#lucky#")>-1&&(e=e.replace(/#lucky#/g,"")+")"),o+=e+",",u=""}else u+=",";else if(e in a.operatorjson&&0==h.squote&&0==h.dquote&&0==h.braces){let h="",p=a.operatorPriority;if(c+1<i.length&&(h=i[c+1]),e+h in a.operatorjson){if(0==d.length){if($.trim(u).length>0?g.unshift(a.isFunctionRange($.trim(u),t,l,n,r,s)):$.trim(o).length>0&&g.unshift($.trim(o)),f[0]in a.operatorjson){let e=p[f[0]];for(;f.length>0&&null!=e;)g.unshift(f.shift()),e=p[f[0]]}f.unshift(e+h),o="",u=""}else u+=e+h;c++}else if(0==d.length){if($.trim(u).length>0?g.unshift(a.isFunctionRange($.trim(u),t,l,n,r,s)):$.trim(o).length>0&&g.unshift($.trim(o)),f[0]in a.operatorjson){let t=p[f[0]];t=null==t?1e3:t;let l=p[e];for(l=null==l?1e3:l;f.length>0&&l>=t;)g.unshift(f.shift()),t=null==(t=p[f[0]])?1e3:t}f.unshift(e),o="",u=""}else u+=e}else 0==h.dquote&&0==h.squote?u+=$.trim(e):u+=e;if(c==i.length-1){let e="",s=$.trim(u).replace(/'/g,"\\'");if(a.iscelldata(s)&&":"!=s.substr(0,1))e="luckysheet_getcelldata('"+s+"')",a.isFunctionRangeSaveChange(u,t,l,n,r);else if(":"==s.substr(0,1))s=s.substr(1),a.iscelldata(s)&&(e="luckysheet_getSpecialReference(false,"+o+",'"+s+"')");else{u=$.trim(u);let t=/{.*?}/;if(t.test(u)&&'"'!=u.substr(0,1)&&'"'!=u.substr(u.length-1,1)){let l=t.exec(u)[0],n=u.search(t);n>0&&(e+=u.substr(0,n)),e+="luckysheet_getarraydata('"+l+"')",n+l.length<u.length&&(e+=u.substr(n+l.length,u.length))}else e=u}if(e.length>0&&g.unshift(e),f.length>0)for(o.length>0&&(g.unshift(o),o="");f.length>0;)g.unshift(f.shift());g.length>0?o=a.calPostfixExpression(g):o+=e}c++}return a.checkSpecialFunctionRange(o,t,l,n,r,s),o},isFunctionRangeSaveChange:function(e,t,l,n,r){let s=this;if(null!=t&&null!=l){let a=s.getcellrange($.trim(e),n);if(null==a)return;let i=a.row,c=a.column,u=a.sheetIndex;if(t+"_"+l in r&&(n==u||null==n)){let e=!1;for(let n=i[0];n<=i[1];n++)for(let s=c[0];s<=c[1];s++)n+"_"+s in r&&r[n+"_"+s].r==t&&r[n+"_"+s].c==l&&(e=!0);s.isFunctionRangeSave=e?s.isFunctionRangeSave||!0:s.isFunctionRangeSave||!1}else t>=i[0]&&t<=i[1]&&l>=c[0]&&l<=c[1]&&(n==u||null==n)?s.isFunctionRangeSave=s.isFunctionRangeSave||!0:s.isFunctionRangeSave=s.isFunctionRangeSave||!1}else s.isFunctionRangeSave=s.isFunctionRangeSave||!1},checkSpecialFunctionRange:function(e,t,l,n,r,s){if("luckysheet_getSpecialReference"==e.substr(0,30)||"luckysheet_function."==e.substr(0,20)){if("luckysheet_function."==e.substr(0,20)){let t=e.split(".")[1];if(null!=t&&"INDIRECT"!=(t=t.toUpperCase())&&"OFFSET"!=t&&"INDEX"!=t)return}try{S.calculateSheetIndex=n;let t=new Function("return "+e)();t instanceof Object&&null!=t.startCell&&(t=t.startCell);let l=$.trim(t);this.iscelldata(l)&&"function"==typeof s&&s(l)}catch(e){}}},execvertex:{},execFunctionGroupData:null,execFunctionExist:null,formulaContainSheetList:{},formulaContainCellList:{},cellTextToIndexList:{},addToCellList:function(e,t){null!=e&&0!=e.length&&null!=t&&0!=t.length&&(null==this.formulaContainCellList&&(this.formulaContainCellList={}),null==this.formulaContainCellList[e]&&(this.formulaContainCellList[e]={}),this.formulaContainCellList[e][t]=1)},addToCellIndexList:function(e,t){null!=e&&0!=e.length&&null!=t&&(null==this.cellTextToIndexList&&(this.cellTextToIndexList={}),e.indexOf("!")>-1?(e=e.replace(/\\'/g,"'").replace(/''/g,"'"),this.cellTextToIndexList[e]=t):this.cellTextToIndexList[e+"_"+t.sheetIndex]=t)},addToSheetIndexList:function(e,t,l){null!=e&&0!=e.length&&(null!=t&&0!=t.length||(t=S.currentSheetIndex),null!=l&&0!=l.length||(l=""),null==this.formulaContainSheetList&&(this.formulaContainSheetList={}),null==this.formulaContainSheetList[e]&&(this.formulaContainSheetList[e]={}),this.formulaContainSheetList[e][t]=l)},execFunctionGlobalData:{},execFunctionGroupForce:function(e){e?this.execFunctionGroup(void 0,void 0,void 0,void 0,void 0,!0):this.execFunctionGroup()},execFunctionGroup:function(e,t,l,n,r,s=!1){let a=this;if(null==r&&(r=S.flowdata),window.luckysheet_compareWith||(window.luckysheet_compareWith=fe,window.luckysheet_getarraydata=ge,window.luckysheet_getcelldata=de,window.luckysheet_parseData=pe,window.luckysheet_getValue=me,window.luckysheet_indirect_check=ye,window.luckysheet_indirect_check_return=xe,window.luckysheet_offset_check=ke,window.luckysheet_calcADPMM=be,window.luckysheet_getSpecialReference=ve),null==a.execFunctionGlobalData&&(a.execFunctionGlobalData={}),null==n&&(n=S.currentSheetIndex),null!=l){let r=[[{v:null}]];te(0,0,r,l),a.execFunctionGlobalData[e+"_"+t+"_"+n]=r[0][0]}let i=a.getAllFunctionGroup(),c={},u=L(),o={};for(let e=0;e<u.length;e++){let t=u[e];o[t.index]=t.data}let h={},f=[];if(null==a.execFunctionExist){h["r"+e+"c"+t+"i"+n]=1}else for(let e=0;e<a.execFunctionExist.length;e++){let t=a.execFunctionExist[e],l="r"+t.r+"c"+t.c+"i"+t.i;h[l]=1}let g={};for(let e=0;e<i.length;e++){let t=i[e],l="r"+t.r+"c"+t.c+"i"+t.index,n=K(t.r,t.c,t.index);if(null==n)continue;let r=n.toUpperCase(),s=[];if(r.indexOf("INDIRECT(")>-1||r.indexOf("OFFSET(")>-1||r.indexOf("INDEX(")>-1)this.isFunctionRange(n,null,null,t.index,null,function(e){let l=a.getcellrange($.trim(e),t.index);null!=l&&s.push(l)});else if('="'!=n.substr(0,2)||'"'!=n.substr(n.length-1,1)){let e=0,l=-1,r=-1,i=[],c=[],u=n.length;for(let t=0;t<u;t++){let s=n.charAt(t);"'"==s&&-1==r&&(-1==l?(e!=t&&i.push(...n.substring(e,t).split(/==|!=|<>|<=|>=|[,()=+-\/*%&\^><]/)),l=t,e=t):t<u-1&&"'"==n.charAt(t+1)?t++:(e=t+1,i.push(n.substring(l,e)),c.push(i.length-1),l=-1)),'"'==s&&-1==l&&(-1==r?(e!=t&&i.push(...n.substring(e,t).split(/==|!=|<>|<=|>=|[,()=+-\/*%&\^><]/)),r=t,e=t):t<u-1&&'"'==n.charAt(t+1)?t++:(e=t+1,i.push(n.substring(r,e)),r=-1))}e!=u&&i.push(...n.substring(e,u).split(/==|!=|<>|<=|>=|[,()=+-\/*%&\^><]/));for(let e=c.length-1;e>=0;e--)c[e]!=i.length-1&&(i[c[e]]=i[c[e]]+i[c[e]+1],i.splice(c[e]+1,1));for(let e=0;e<i.length;e++){let l=i[e];if(l.length<=1)continue;if('"'==l.substr(0,1)&&'"'==l.substr(l.length-1,1)&&!a.iscelldata(l))continue;let n=a.getcellrange($.trim(l),t.index);null!=n&&s.push(n)}}let u={formulaArray:s,calc_funcStr:n,key:l,r:t.r,c:t.c,index:t.index,parents:{},chidren:{},color:"w"};c[l]=u}Object.keys(c).forEach(e=>{let t=c[e];!function(e,t,l,n){for(let r=0;r<e.length;r++){let s=e[r],a="r"+s.row[0]+s.row[1]+"c"+s.column[0]+s.column[1]+"index"+s.sheetIndex;if(a in g)g[a].forEach(e=>{n(e.key,e.r,e.c,e.sheetIndex)});else{let e=[];for(let r=s.row[0];r<=s.row[1];r++)for(let a=s.column[0];a<=s.column[1];a++){let i="r"+r+"c"+a+"i"+s.sheetIndex;n(i,r,a,s.sheetIndex),(t&&i in t||l&&i in l)&&e.push({key:i,r:r,c:a,sheetIndex:s.sheetIndex})}(t||l)&&(g[a]=e)}}}(t.formulaArray,c,h,function(l){if(l in c){let n=c[l];t.chidren[l]=1,n.parents[e]=1}!s&&l in h&&f.push(t)}),s&&f.push(t)});let d=[],p=f,m={};for(;p.length>0;){let e=p.pop();if(null==e||e.key in m)continue;if("b"==e.color){d.push(e),m[e.key]=1;continue}let t=[];Object.keys(e.parents).forEach(e=>{let l=c[e];null!=l&&t.push(l)}),0,0==t.length?(d.push(e),m[e.key]=1):(e.color="b",p.push(e),p=p.concat(t))}d.reverse();for(let e=0;e<d.length;e++){let t=d[e];if(t.level==Math.max)continue;window.luckysheet_getcelldata_cache=null;let l=t.calc_funcStr,n=a.execfunction(l,t.r,t.c,t.index);a.groupValuesRefreshData.push({r:t.r,c:t.c,v:n[1],f:n[2],spe:n[3],index:t.index}),a.execFunctionGlobalData[t.r+"_"+t.c+"_"+t.index]={v:n[1],f:n[2]}}a.execFunctionExist=null},execFunctionGroup1:function(e,t,l,n,r,s=!1){let a=this;null==r&&(r=S.flowdata),window.luckysheet_compareWith||(window.luckysheet_compareWith=fe,window.luckysheet_getarraydata=ge,window.luckysheet_getcelldata=de,window.luckysheet_parseData=pe,window.luckysheet_getValue=me,window.luckysheet_indirect_check=ye,window.luckysheet_indirect_check_return=xe,window.luckysheet_offset_check=ke,window.luckysheet_calcADPMM=be,window.luckysheet_getSpecialReference=ve),null==a.execFunctionGlobalData&&(a.execFunctionGlobalData={});let i=L(),c=null==i[O(S.currentSheetIndex)].dynamicArray_compute?{}:i[O(S.currentSheetIndex)].dynamicArray_compute;if(null==n&&(n=S.currentSheetIndex),null!=l){let r=[[{v:null}]];te(0,0,r,l),a.execFunctionGlobalData[e+"_"+t+"_"+n]=r[0][0]}let u=a.getAllFunctionGroup(),o={},h=[],f=0;if(a.execvertex={},null==a.execFunctionExist)for(let l=0;l<u.length;l++){let r=u[l],g=i[O(r.index)];if(null==g)continue;let d=g.data[r.r][r.c],p=K(r.r,r.c,r.index);null!=d&&null!=d.f&&d.f==p&&(r instanceof Object||(r=new Function("return "+r)()),r.color="w",r.parent=null,r.chidren={},r.times=0,o["r"+r.r+"c"+r.c+"i"+r.index]=r,a.isFunctionRangeSave=!1,s?a.isFunctionRangeSave=!0:null!=e&&null!=t&&a.isFunctionRangeSelect(p,e,t,n,c),a.isFunctionRangeSave&&(h.push(r),a.execvertex["r"+r.r+"c"+r.c+"i"+r.index]=r,f++))}else for(let e=0;e<a.execFunctionExist.length;e++){let t=a.execFunctionExist[e];if(!("r"+t.r+"c"+t.c+"i"+t.i in o))for(let e=0;e<u.length;e++){let l=u[e],n=K(l.r,l.c,l.index);l.color="w",l.parent=null,l.chidren={},l.times=0,o["r"+l.r+"c"+l.c+"i"+l.index]=l,a.isFunctionRangeSave=!1,s?a.isFunctionRangeSave=!0:a.isFunctionRangeSelect(n,t.r,t.c,t.i,c),a.isFunctionRangeSave&&(h.push(l),a.execvertex["r"+l.r+"c"+l.c+"i"+l.index]=l,f++)}}for(;h.length>0;){let e=h.shift(),t={};a.getChildrenVertex(e,o,t);for(let l in o){let n=o[l];if(null==n)continue;let r="r"+e.r+"c"+e.c+"i"+e.index;if(l in t)continue;a.isFunctionRangeSave=!1;let s=K(n.r,n.c,n.index);a.isFunctionRangeSelect(s,e.r,e.c,e.index,c),a.isFunctionRangeSave&&(l in a.execvertex||(h.push(n),a.execvertex[l]=n),f++,a.execvertex[l].chidren[r]=1)}}a.groupValuesRefreshData=[];let g=0;for(;g<f;)for(let e in a.execvertex){let t=a.execvertex[e];"w"==t.color?a.functionDFS(t):"b"==t.color&&g++}a.execFunctionExist=null},getChildrenVertex:function(e,t,l){if(l["r"+e.r+"c"+e.c+"i"+e.index]=1,null!=e.chidren)for(let n in e.chidren)!t[n]||n in l||this.getChildrenVertex(t[n],t,l)},functionDFS:function(e){let t=this;e.color="g",e.times+=1;for(let l in e.chidren){let n=t.execvertex[l];"w"==n.color&&(n.parent="r"+e.r.toString()+"c"+e.c.toString()+"i"+e.index,t.functionDFS(n))}e.color="b",window.luckysheet_getcelldata_cache=null;let l=K(e.r,e.c,e.index),n=t.execfunction(l,e.r,e.c,e.index);t.groupValuesRefreshData.push({r:e.r,c:e.c,v:n[1],f:n[2],spe:n[3],index:e.index}),t.execFunctionGlobalData[e.r+"_"+e.c+"_"+e.index]={v:n[1],f:n[2]}},groupValuesRefreshData:[],groupValuesRefresh:function(){let e=this,t=L();if(e.groupValuesRefreshData.length>0){for(let l=0;l<e.groupValuesRefreshData.length;l++){let n=e.groupValuesRefreshData[l],r=t[O(n.index)],s=r.data;if(null==s)continue;let i={};null!=n.spe&&("sparklines"==n.spe.type?i.spl=n.spe.data:"dynamicArrayItem"==n.spe.type&&(r.dynamicArray=e.insertUpdateDynamicArray(n.spe.data))),i.v=n.v,i.f=n.f,te(n.r,n.c,s,i),a.saveParam("v",n.index,n.v,{r:n.r,c:n.c})}y.webWorkerFlowDataCache(S.flowdata),e.groupValuesRefreshData=[]}},delFunctionGroup:function(e,t,l){null==l&&(l=S.currentSheetIndex);let n=L(),r=n[O(l)],s=r.calcChain;if(null!=s)for(let n=0;n<s.length;n++){let r=s[n];if(r.r==e&&r.c==t&&r.index==l){s.splice(n,1),a.saveParam("fc",l,null,{op:"del",pos:n});break}}let i=r.dynamicArray;if(null!=i)for(let n=0;n<i.length;n++){let r=i[n];if(r.r==e&&r.c==t&&(null==r.index||r.index==l)){i.splice(n,1),a.saveParam("ac",l,null,{op:"del",pos:n});break}}z(n)},execfunction:function(e,t,l,n,r,s){let a=this,i=F().formulaMore;if(e.indexOf(a.error.r)>-1)return[!1,a.error.r,e];a.checkBracketNum(e)||(e+=")"),null==n&&(n=S.currentSheetIndex),S.calculateSheetIndex=n;let c=$.trim(a.functionParserExe(e));if("luckysheet_function."!=c.substr(0,20)&&"luckysheet_compareWith"!=c.substr(0,22)||(a.functionHTMLIndex=0),!a.testFunction(e,c)||""==c)return x.info("",i.execfunctionError),[!1,a.error.n,e];let u=null;window.luckysheetCurrentRow=t,window.luckysheetCurrentColumn=l,window.luckysheetCurrentIndex=n,window.luckysheetCurrentFunction=e;let o=null;try{if(c.indexOf("luckysheet_getcelldata")>-1){let n=c.split("luckysheet_getcelldata('");for(let r=1;r<n.length;r++){let s=n[r].split("')")[0],c=a.getcellrange(s);if(c.row[0]<0||c.column[0]<0)return[!0,a.error.r,e];if(c.sheetIndex==S.calculateSheetIndex&&t>=c.row[0]&&t<=c.row[1]&&l>=c.column[0]&&l<=c.column[1])return U()?alert(i.execfunctionSelfError):x.info("",i.execfunctionSelfErrorResult),[!1,0,e]}}"string"==typeof(u=new Function("return "+c)())&&(u=u.replace(/\x7F/g,'"')),c.indexOf("SPLINES")>-1&&(o=u,u="")}catch(e){let t=e;console.log(e,c),t=a.errorInfo(t),u=[a.error.n,t]}"object"==R(u)&&null!=u.startCell&&(u="array"==R(u.data)?a.error.v:"object"!=R(u.data)||V(u.data.v)?V(u.data)?0:u.cell>1||u.rowl>1?u.data:0:u.data.v);let h=null;if("array"==R(u)){let r=!1;"array"!=R(u[0])&&2==u.length&&(r=Z(u[0])),r?u=u[0]:"array"==R(u[0])&&1==u.length&&1==u[0].length?u=u[0][0]:(h={r:t,c:l,f:e,index:n,data:u},u="")}return window.luckysheetCurrentRow=null,window.luckysheetCurrentColumn=null,window.luckysheetCurrentIndex=null,window.luckysheetCurrentFunction=null,null!=t&&null!=l&&(r&&a.execFunctionGroup(t,l,u,n),s||a.insertUpdateFunctionGroup(t,l,n)),o?[!0,u,e,{type:"sparklines",data:o}]:h?[!0,u,e,{type:"dynamicArrayItem",data:h}]:[!0,u,e]},testFunction:function(e,t){return"="==e.substr(0,1)},execstringformula:function(e,t,l,n){return this.execfunction(e,t,l,n)},functionResizeData:{},functionResizeStatus:!1,functionResizeTimeout:null,data_parm_index:0}});
//# sourceMappingURL=../sourcemaps/global/formula.js.map
