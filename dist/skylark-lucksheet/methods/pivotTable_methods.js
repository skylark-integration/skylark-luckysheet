/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../methods/get","../utils/util","../methods/getdata","../methods/datecontroll","../methods/format","../methods/validate","../methods/array","../methods/analysis","../methods/luckysheetConfigsetting","./sheets","../methods/protection_methods","../store","../locale/locale","../vendors/numeral"],function(e,t,l,n,a,i,u,r,o,s,h,c,f,p){"use strict";const{getSheetIndex:d,getRangetxt:g}=e,{replaceHtml:m,getObjType:v,ABCatNum:y,numFormat:T,numfloatlen:b,showrightclickmenu:S,mouseclickposition:N}=t,{getdatabyselectionD:k,getcellvalue:A,datagridgrowth:x}=l,{isdatetime:D,diff:w,isdatatypemulti:I,isdatatype:P}=n,{genarate:_,update:C}=a,{isRealNull:E}=i,{checkProtectionAuthorityNormal:U}=h;o.isEditMode;return{pivotDatas:null,pivotSheetIndex:0,pivotDataSheetIndex:0,celldata:null,origindata:null,getCellData:function(e,t,l){let n,a=this;n=null!=e?e:c.currentSheetIndex;let i=d(n);"object"!=v(c.luckysheetfile[i].pivotTable)&&(c.luckysheetfile[i].pivotTable=new Function("return "+c.luckysheetfile[i].pivotTable)()),null!=c.luckysheetfile[i].pivotTable?(a.column=c.luckysheetfile[i].pivotTable.column,a.row=c.luckysheetfile[i].pivotTable.row,a.values=c.luckysheetfile[i].pivotTable.values,a.filter=c.luckysheetfile[i].pivotTable.filter,a.showType=c.luckysheetfile[i].pivotTable.showType,a.filterparm=c.luckysheetfile[i].pivotTable.filterparm,null!=c.luckysheetfile[i].pivotTable.drawPivotTable?a.drawPivotTable=c.luckysheetfile[i].pivotTable.drawPivotTable:a.drawPivotTable=!0,null!=c.luckysheetfile[i].pivotTable.pivotTableBoundary?a.pivotTableBoundary=c.luckysheetfile[i].pivotTable.pivotTableBoundary:a.pivotTableBoundary=[12,6],a.pivot_select_save=null!=l?l:c.luckysheetfile[i].pivotTable.pivot_select_save,a.pivotDataSheetIndex=null!=t?t:c.luckysheetfile[i].pivotTable.pivotDataSheetIndex):(a.column=null,a.row=null,a.values=null,a.filter=null,a.showType=null,a.filterparm=null,a.drawPivotTable=!0,a.pivotTableBoundary=[12,6],a.pivot_select_save=null!=l?l:c.luckysheet_select_save,a.pivotDataSheetIndex=null!=t?t:n);let u=d(a.pivotDataSheetIndex),r=c.luckysheetfile[u];null==r.data&&(r.data=s.buildGridData(r)),a.origindata=k(r.data,a.pivot_select_save);let o={};if(null!=a.filterparm)for(let e in a.filterparm)for(let t in a.filterparm[e])"rowhidden"===t&&null!=a.filterparm[e][t]&&(o=$.extend(!0,o,a.filterparm[e][t]));a.rowhidden=o,a.pivotSheetIndex=n;let h=[];for(let e=0;e<a.origindata.length;e++)null!=a.rowhidden&&null!=a.rowhidden[e]||h.push([].concat(a.origindata[e]));a.celldata=h,a.pivot_data_type={};for(let e=0;e<a.celldata[1].length;e++){let t=P(a.celldata[1][e]);a.pivot_data_type[e.toString()]=t}},pivot_data_type:{},pivot_select_save:null,column:null,row:null,values:null,filter:null,showType:null,rowhidden:null,selected:null,caljs:null,initial:!0,filterparm:null,luckysheet_pivotTable_select_state:!1,jgridCurrentPivotInput:null,movestate:!1,moveitemposition:[],movesave:{},getSumTypeName:function(e){let t="";const l=f().pivotTable;return"SUM"==e?t=l.valueStatisticsSUM:"COUNT"==e?t=l.valueStatisticsCOUNT:"COUNTA"==e?t=l.valueStatisticsCOUNTA:"COUNTUNIQUE"==e?t=l.valueStatisticsCOUNTUNIQUE:"AVERAGE"==e?t=l.valueStatisticsAVERAGE:"MAX"==e?t=l.valueStatisticsMAX:"MIN"==e?t=l.valueStatisticsMIN:"MEDIAN"==e?t=l.valueStatisticsMEDIAN:"PRODUCT"==e?t=l.valueStatisticsPRODUCT:"STDEV"==e?t=l.valueStatisticsSTDEV:"STDEVP"==e?t=l.valueStatisticsSTDEVP:"let"==e?t=l.valueStatisticslet:"VARP"==e&&(t=l.valueStatisticsVARP),t},setDatatojsfile:function(e,t,l){let n=this,a=d(n.pivotSheetIndex);null==c.luckysheetfile[a].pivotTable&&(c.luckysheetfile[a].pivotTable={}),null==l?(c.luckysheetfile[a].pivotTable[e]=t,n[e]=t):(null==c.luckysheetfile[a].pivotTable.filterparm&&(c.luckysheetfile[a].pivotTable.filterparm={}),null==c.luckysheetfile[a].pivotTable.filterparm[l.toString()]&&(c.luckysheetfile[a].pivotTable.filterparm[l.toString()]={}),c.luckysheetfile[a].pivotTable.filterparm[l.toString()][e]=t,null==n.filterparm&&(n.filterparm={}),null==n.filterparm[l.toString()]&&(n.filterparm[l.toString()]={}),n.filterparm[l.toString()][e]=t)},drawPivotTable:!0,pivotTableBoundary:[12,6],isPivotRange:function(e,t){let l=this;if(c.luckysheetcurrentisPivotTable)return e<l.pivotTableBoundary[0]&&t<l.pivotTableBoundary[1]},getPivotTableData:function(e){null==e&&(e=this.pivotSheetIndex);let t=d(e),l=c.luckysheetfile[t].pivotTable;return l="object"==v(l)?$.extend(!0,{},c.luckysheetfile[t].pivotTable):new Function("return "+l)()},addValuesToTitle:function(e,t){let l=e.length*t.length,n=e[0].length+1,a=[];if(0==e.length&&t.length>0){for(let e=0;e<t.length;e++)a.push(t[e].fullname);return a}if(0==t.length&&e.length>0)return e;for(let i=0;i<l;i++){a[i]=new Array(n);for(let l=0;l<n-1;l++)a[i][l]=e[Math.floor(i/t.length)][l];a[i][n-1]=t[i%t.length].fullname}return a},getComposeArray:function(e){if(0==e.length)return[];let t=[];for(let l=0;l<e.length;l++){let n="";for(let t=0;t<=l;t++)e[t]&&e[t].m?n+=e[t].m:n+=A(t,null,e);t.push(n)}return t},getnameArray:function(e,t){if(0==e.length)return[];if(0==t.length)return[];let l=[];for(let n=0;n<t.length;n++){let a;a=e[t[n].index]&&e[t[n].index].m?e[t[n].index].m:A(t[n].index,null,e),l.push(a)}return l},getTitleFromGroup:function(e,t,l){let n=this.orderbygroup(e,t,l);return this.generategrouparraymain(n,t)},orderbygroup:function(e,t,l){let n=this,a=[];if(0==e.length)return[];let i=null,u=(a=e).length,r=a.length,o=0;for(;0!=u;)if(u--,null!=(i=a[o++]).children&&i.children.length>0){i.children=n.orderbygroupchildren(i.children,t[i.index].orderby,t[i.index].order,l);for(let e=0;e<i.children.length;e++)a.push(i.children[e]),u++}return e.splice(0,r)},orderbygroupchildren:function(e,t,l,n){if(0==e.length)return[];let a=!1;null!=l&&"asc"!=l||(a=!0);const i=f().filter;let u=function(e,l){let a=null,u=null;if("self"==t||null==t){if(a=null==e.name?i.valueBlank:e.name.toString(),u=null==l.name?i.valueBlank:l.name.toString(),D(a)&&D(u))return w(a,u)}else a=parseFloat(n[e.orderby].result),u=parseFloat(n[l.orderby].result);return isNaN(a)||isNaN(u)?isNaN(a)&&isNaN(u)?a.localeCompare(u):isNaN(a)?1:isNaN(u)?-1:void 0:p(a).value()-p(u).value()},r=function(e,l){let a=null,u=null;if("self"==t||null==t){if(a=null==e.name?i.valueBlank:e.name.toString(),u=null==l.name?i.valueBlank:l.name.toString(),D(a)&&D(u))return w(a,u)}else a=parseFloat(n[e.orderby].result),u=parseFloat(n[l.orderby].result);return isNaN(a)||isNaN(u)?isNaN(a)&&isNaN(u)?u.localeCompare(a):isNaN(a)?-1:isNaN(u)?1:void 0:p(u).value()-p(a).value()};return a?e.sort(u):e.sort(r)},generategroupaddstatic:function(e,t){let l=[];const n=f().pivotTable;for(let a=0;a<e[0].length;a++)0==a?t==n.valueSum?l.push(t):l.push({name:t,issum:!0}):l.push("");return l},generategrouparraymain:function(e,t){let l=this,n=[];for(let a=0;a<e.length;a++){let i=e[a].name,u=l.generategrouparray(e[a].children,t,1);"1"!=t[0].stastic&&null!=t[0].stastic||u.push(l.generategroupaddstatic(u,i)),n=n.concat(u)}return n},generategrouparray:function(e,t,l){let n=this,a=[];for(let i=0;i<e.length;i++){let u,r=e[i].name;if(0==e[i].children||0==e[i].children.length)u=[r],a.push(u);else{u=n.generategrouparray(e[i].children,t,l+1);for(let e=0;e<u.length;e++)u[e].unshift(r);"1"!=t[l].stastic&&null!=t[l].stastic||u.push(n.generategroupaddstatic(u,r)),a=a.concat(u)}}return a},addStatisticsData:function(e,t,l,n){if(null==e[l]&&(e[l]={data:[],count:0,max:-1/0,min:1/0,counta:0,countunique:0,countuniquedata:{},sum:0,digitaldata:[],sumtype:t.sumtype,index:t.index,name:t.fullname,acc:0}),!0===I(n).num){let t=T(n);e[l].digitaldata.push(t),e[l].count+=1,e[l].sum+=t,t>e[l].max&&(e[l].max=t),t<e[l].min&&(e[l].min=t);let a=b(t);a>e[l].acc&&(e[l].acc=a)}""!=n&&(e[l].data.push(n),e[l].counta+=1,n in e[l].countuniquedata||(e[l].countuniquedata[n]=1,e[l].countunique+=1))},dataHandler:function(e,t,l,n,a){let i=this;const o=f(),s=o.filter,h=o.pivotTable;if(null==n&&(n="column"),0==e.length&&0==t.length&&0==l.length||0==a.length)return i.pivotDatas=[],[];let c={},p=a,d=[],g=[],m={},y=[],S=[],N={};for(let a=1;a<p.length;a++){let u=p[a],r=[],o=[],f=[],d=[];o=i.getnameArray(u,t),d=i.getnameArray(u,e),r=i.getComposeArray(o),f=i.getComposeArray(d),r.length>0&&r.unshift(h.valueSum),f.length>0&&f.unshift(h.valueSum);let v=m,y=g;for(let e=0;e<r.length;e++){let a=r[e],i=0==e?h.valueSum:o[e-1];if(null!=v[e.toString()]&&null!=v[e.toString()][a])y=y[v[e.toString()][a]].children;else{let u=0==e?"self":"self"==t[e-1].orderby||null==t[e-1].orderby?a:"column"==n?a+l[parseInt(t[e-1].orderby)].fullname:a+h.valueSum;null==i&&(i=s.valueBlank),y.push({name:i,fullname:a,index:e,orderby:u,children:[]}),null==v[e.toString()]&&(v[e.toString()]={}),null==v[e.toString()][a]&&(v[e.toString()][a]=y.length-1),y=y[y.length-1].children}}let T=N,b=S;for(let t=0;t<f.length;t++){let a=f[t],i=0==t?h.valueSum:d[t-1];if(null!=T[t.toString()]&&null!=T[t.toString()][a])b=b[T[t.toString()][a]].children;else{let u=0==t?"self":"self"==e[t-1].orderby||null==e[t-1].orderby?a:"column"==n?h.valueSum+a:l[parseInt(e[t-1].orderby)].fullname+a;null==i&&(i=s.valueBlank),b.push({name:i,fullname:a,index:t,orderby:u,children:[]}),null==T[t.toString()]&&(T[t.toString()]={}),null==T[t.toString()][a]&&(T[t.toString()][a]=b.length-1),b=b[b.length-1].children}}for(let e=0;e<l.length;e++){let t=A(l[e].index,null,u),a=[].concat(f),o=[].concat(r);"column"==n?a.length>0?(a.push(""),a=a.join(l[e].fullname+"|||").split("|||").slice(0,a.length-1)):a.push(l[e].fullname):o.length>0?(o.push(""),o=o.join(l[e].fullname+"|||").split("|||").slice(0,o.length-1)):o.push(l[e].fullname),0==a.length&&a.push(""),0==o.length&&o.push("");for(let n=0;n<o.length;n++)for(let u=0;u<a.length;u++){let r=o[n]+a[u];i.addStatisticsData(c,l[e],r,t)}}}for(let e in c){let t=c[e];if("SUM"==t.sumtype)t.result=t.sum;else if("COUNT"==t.sumtype)t.result=t.count;else if("COUNTA"==t.sumtype)t.result=t.counta;else if("COUNTUNIQUE"==t.sumtype)t.result=t.countunique;else if("AVERAGE"==t.sumtype)t.result=T(t.sum/t.count);else if("MAX"==t.sumtype)t.result=t.max;else if("MIN"==t.sumtype)t.result=t.min;else if("MEDIAN"==t.sumtype){let e=t.digitaldata.sort(function(e,t){return e-t}),l=e.length,n=parseInt(l/2);t.result=l%2==0?(e[n-1]+e[n])/2:e[n]}else if("PRODUCT"==t.sumtype)t.result=new Function("return "+t.digitaldata.join("*"))();else if("STDEV"==t.sumtype){let e=t.sum/t.count;t.result=r.STDEV(e,t.digitaldata)}else if("STDEVP"==t.sumtype){let e=t.sum/t.count;t.result=r.STDEVP(e,t.digitaldata)}else if("let"==t.sumtype){let e=t.sum/t.count;t.result=r.let(e,t.digitaldata)}else if("VARP"==t.sumtype){let e=t.sum/t.count;t.result=r.VARP(e,t.digitaldata)}let l=b(t.result);l>t.acc&&(t.acc=l),t.result=T(t.result,t.acc)}if(d=i.getTitleFromGroup(g,t,c),y=i.getTitleFromGroup(S,e,c),"column"==n)if(y.length>0&&y[0].length>0)y=i.addValuesToTitle(y,l);else for(let e=0;e<l.length;e++)y.push([l[e].fullname]);else if(d.length>0&&d[0].length>0)d=i.addValuesToTitle(d,l);else for(let e=0;e<l.length;e++)d.push([l[e].fullname]);let k=y;y=u.transpose(y,!1);let x=0==l.length?0:1,D=(0==y.length?x:y.length)+(0==d.length?x:d.length),w=(0==y.length?x:y[0].length)+(0==d.length?x:d[0].length),I=y.length,P=0==d.length?0:d[0].length,_=[];for(let e=0;e<D;e++){_[e]=new Array(w);for(let t=0;t<w;t++){let l=d[e-I];if(e<I&&t<P)_[e][t]="";else if(e<I&&t>=P)null!=y[e]?"object"==v(y[e][t-P])?_[e][t]=y[e][t-P].name+h.valueSum:_[e][t]=y[e][t-P]:_[e][t]="";else if(e>=I&&t<P)null!=l?"object"==v(l[t])?_[e][t]=l[t].name+h.valueSum:_[e][t]=l[t]:_[e][t]="";else{let n="";if(null!=l)if(l instanceof Array&&1!=l.length)for(let e=0;e<l.length;e++)"object"==v(l[e])?n+=l[e].name:n+=l[e];else n=l instanceof Array?l[0]:l;let a="",i=k[t-P];if(null!=i)if(i instanceof Array&&1!=i.length)for(let e=0;e<i.length;e++)"object"==v(i[e])?a+=i[e].name:a+=i[e];else a=i instanceof Array?i[0]:i;let u=n;""!=n&&""!=a?u=n+a:""==n&&(u=a),_[e][t]=null==c[u]?"":c[u].result}}}if(1==l.length&&e.length>0&&t.length>0)_[0][0]=l[0].fullname,_.splice(e.length,1);else if(1==l.length&&e.length>0){let t=_.splice(e.length,1),l=[];for(let e=0;e<_.length;e++){let n=[];e==_.length-1?n.push(t[0][0]):n.push("");for(let t=0;t<_[e].length-1;t++)n.push(_[e][t]);l.push(n)}_=l}return i.pivotDatas=_,_}}});
//# sourceMappingURL=../sourcemaps/methods/pivotTable_methods.js.map
