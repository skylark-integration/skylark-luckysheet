/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../utils/util","./cells","./getdata","./location","./validate","../store"],function(t,e,n,l,s,a){"use strict";const{luckysheetfontformat:u}=t,{getcellvalue:o}=n,{checkstatusByCell:i,isInlineStringCell:c}=e,{colLocationByIndex:h}=l,{hasChinaword:d,isRealNull:x,checkWordByteLength:g}=s;function r(t,n,l){let s=a.measureTextCache[t+"_"+n.font];if(null!=l&&(s=a.measureTextCache[t+"_"+l]),null!=s)return s;{if(null!=l){n.font;n.font=l}let s=n.measureText(t),u={};if(u.width=s.width,null!=l&&(n.font=l),u.actualBoundingBoxDescent=s.actualBoundingBoxDescent,u.actualBoundingBoxAscent=s.actualBoundingBoxAscent,null==u.actualBoundingBoxDescent||null==u.actualBoundingBoxAscent||isNaN(u.actualBoundingBoxDescent)||isNaN(u.actualBoundingBoxAscent)){let l="M";d(t)&&(l="田");let s=.8*e.getTextSize(l,n.font)[1];"top"==n.textBaseline?(u.actualBoundingBoxDescent=s,u.actualBoundingBoxAscent=0):"middle"==n.textBaseline?(u.actualBoundingBoxDescent=s/2,u.actualBoundingBoxAscent=s/2):(u.actualBoundingBoxDescent=0,u.actualBoundingBoxAscent=s)}if("alphabetic"==n.textBaseline){let t="gjpqy",e="abcdABCD",s=a.measureTextCache[t+"_"+n.font];null!=l&&(s=a.measureTextCache[t+"_"+l]);let o=a.measureTextCache[e+"_"+n.font];null!=l&&(o=a.measureTextCache[e+"_"+l]),null==s&&(s=n.measureText(t)),null==o&&(o=n.measureText(e)),u.actualBoundingBoxDescent<=o.actualBoundingBoxDescent&&(u.actualBoundingBoxDescent=s.actualBoundingBoxDescent,null==u.actualBoundingBoxDescent&&(u.actualBoundingBoxDescent=0))}return u.width*=a.zoomRatio,u.actualBoundingBoxDescent*=a.zoomRatio,u.actualBoundingBoxAscent*=a.zoomRatio,a.measureTextCache[t+"_"+a.zoomRatio+"_"+n.font]=u,u}}function f(t,e,n){let l=n.cellWidth,s=n.cellHeight,o="",h="";null==l&&(o="onlyWidth",h="_");let d=a.measureTextCellInfoCache[n.r+"_"+n.c+h+o];if(null!=d)return d;let f=n.space_width,p=n.space_height;null==f&&(f=2),null==p&&(p=2);let M=i(t,"ht"),w=i(t,"vt"),m=i(t,"tb"),A=i(t,"tr"),T=i(t,"rt"),D=1,y=0;null==T&&("0"==A?T=0:"1"==A?T=45:"4"==A?T=90:"2"==A?T=135:"5"==A&&(T=180),null==T&&(T=0)),(T>180||T<0)&&(T=0),(T=parseInt(T))>90&&(T=90-T,D=0,y=1),e.textAlign="start";let I,v,L={values:[]},_="0",b="0",C=11,W=!1,H=[];if(c(t)){let e=t.ct.s,n=0;for(let t=0;t<e.length;t++){let l=e[t],s=u(l),a=l.fc,o=l.cl,i=l.un,c=l.v,h=l.fs,d=(c=c.replace(/\r\n/g,"_x000D_").replace(/&#13;&#10;/g,"_x000D_").replace(/\r/g,"_x000D_").replace(/\n/g,"_x000D_")).split("_x000D_");for(let t=0;t<d.length;t++){let e=d[t];if(""==e&&t!=d.length-1)H.push({fontset:s,fc:null==a?"#000":a,cl:null==o?0:o,un:null==i?0:i,wrap:!0,fs:null==h?11:h}),n++;else{let l=e.split("");for(let t=0;t<l.length;t++){let e=l[t];H.push({fontset:s,fc:null==a?"#000":a,cl:null==o?0:o,un:null==i?0:i,v:e,si:n,fs:null==h?11:h})}t!=d.length-1&&(H.push({fontset:s,fc:null==a?"#000":a,cl:null==o?0:o,un:null==i?0:i,wrap:!0,fs:null==h?11:h}),n++)}}n++}W=!0}else if(I=u(t),e.font=I,_=i(t,"cl"),b=i(t,"un"),C=i(t,"fs"),t instanceof Object?null==(v=t.m)&&(v=t.v):v=t,x(v))return null;if("3"==A){e.textBaseline="top";let t=0,n=0,a=0,u=0,i={},c=[];if(W){let t=null;for(let n=0;n<H.length;n++){let l=H[n],o=l.v,h=l.v;if(!0===l.wrap&&(o="M",h="",null!=t&&!0!==t.wrap&&n<H.length-1)){c.push(u),u=0,a+=1,t=l;continue}let d=r(o,e,l.fontset),x=d.width+f,g=d.actualBoundingBoxAscent+d.actualBoundingBoxDescent+p;u+=g,"2"!=m||l.wrap||u>s&&null!=i[a]&&(c.push(u-g),u=g,a+=1),n==H.length-1&&c.push(u),null==i[a]&&(i[a]=[]);let B={content:h,style:l,width:x,height:g,left:0,top:0,colIndex:a,asc:d.actualBoundingBoxAscent,desc:d.actualBoundingBoxDescent,inline:!0};!0===l.wrap&&(B.wrap=!0),i[a].push(B),console.log("normal",n,a,l,t,i),t=l}}else{let t=r(v,e),n=t.actualBoundingBoxDescent+t.actualBoundingBoxAscent,l=[];(v=v.toString()).length>1?l=v.split(""):l.push(v);let o=r(l[0],e).width;for(let e=0;e<l.length;e++){let h=o+f,d=n+p;u+=d,"2"==m&&u>s&&null!=i[a]&&(c.push(u-d),u=d,a+=1),e==l.length-1&&c.push(u),null==i[a]&&(i[a]=[]),i[a].push({content:l[e],style:I,width:h,height:d,left:0,top:0,colIndex:a,asc:t.actualBoundingBoxAscent,desc:t.actualBoundingBoxDescent})}}let h=[];for(let e=0;e<c.length;e++){let l=c[e],s=i[e],a=0;for(let t=0;t<s.length;t++){let e=s[t];a=Math.max(a,e.width)}h.push(a),t+=a,n=Math.max(n,l)}if(L.type="verticalWrap",L.textWidthAll=t,L.textHeightAll=n,"onlyWidth"==o)return L;let d=0;for(let e=0;e<c.length;e++){let n=c[e],a=h[e],u=i[e],o=0;for(let e=0;e<u.length;e++){let i=u[e],h=f+d;"0"==M?h=l/2+d-t/2+f*c.length:"2"==M&&(h=l+d-t+f);let x=s-p+o-n;"0"==w?x=s/2+o-n/2:"1"==w&&(x=p+o),o+=i.height,i.left=h,i.top=x,B(i,_,b,{width:a,height:i.height,left:h,top:x+i.height-p,asc:i.height,desc:0,fs:C}),L.values.push(i)}d+=a}}else{let t=function(t){return null!=t.measureText("田").actualBoundingBoxAscent}(e);if(e.textBaseline=t?"alphabetic":"bottom","2"==m||W){let n=0,a=0,u=0,i=0,c={};L.rotate=T,T=Math.abs(T);let h,d,x,A,y=0,P=1,X=null,Y=null;if(W)for(;P<=H.length;){let t=H.slice(y,P);if(!0===t[t.length-1].wrap){if(y=P,t.length>1)for(let e=0;e<t.length-1;e++){let n=t[e],l={content:n.v,style:n,width:n.measureText.width,height:n.measureText.actualBoundingBoxAscent+n.measureText.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:n.measureText.actualBoundingBoxAscent,desc:n.measureText.actualBoundingBoxDescent,inline:!0,fs:n.fs};c[i].push(l)}if(1==t.length||P==H.length){let n=t[0],l=r("M",e,n.fontset);null==c[i]&&(c[i]=[]),c[i].push({content:"",style:n,width:l.width,height:l.actualBoundingBoxAscent+l.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:l.actualBoundingBoxAscent,desc:l.actualBoundingBoxDescent,inline:!0,wrap:!0,fs:n.fs})}i+=1,P++;continue}let n=0,a=0;for(let l=0;l<t.length;l++){let s=t[l];null==s.measureText&&(s.measureText=r(s.v,e,s.fontset)),n+=s.measureText.width,a=Math.max(s.measureText.actualBoundingBoxAscent+s.measureText.actualBoundingBoxDescent)}let u=n*Math.cos(T*Math.PI/180)+a*Math.sin(T*Math.PI/180),o=n*Math.sin(T*Math.PI/180)+a*Math.cos(T*Math.PI/180),h=t[t.length-1];if(" "!=h.v&&2!=g(h.v)||(Y=P),0!=T)if(console.log(o,p,s,t,o+p>s),o+p>s&&null!=c[i]&&"2"==m&&P!=H.length)if(null!=Y&&Y<P){for(let e=0;e<Y-y;e++){let n=t[e];c[i].push({content:n.v,style:n,width:n.measureText.width,height:n.measureText.actualBoundingBoxAscent+n.measureText.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:n.measureText.actualBoundingBoxAscent,desc:n.measureText.actualBoundingBoxDescent,inline:!0,fs:n.fs})}y=Y,P=Y+1,i+=1,Y=null}else{y=P-1;for(let e=0;e<t.length-1;e++){let n=t[e];c[i].push({content:n.v,style:n,width:n.measureText.width,height:n.measureText.actualBoundingBoxAscent+n.measureText.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:n.measureText.actualBoundingBoxAscent,desc:n.measureText.actualBoundingBoxDescent,inline:!0,fs:n.fs})}i+=1}else{if(P==H.length){null==c[i]&&(c[i]=[]);for(let e=0;e<t.length;e++){let n=t[e];c[i].push({content:n.v,style:n,width:n.measureText.width,height:n.measureText.actualBoundingBoxAscent+n.measureText.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:n.measureText.actualBoundingBoxAscent,desc:n.measureText.actualBoundingBoxDescent,inline:!0,fs:n.fs})}break}null==c[i]&&(c[i]=[]),P++}else if(u+f>l&&null!=c[i]&&"2"==m&&P!=H.length)if(null!=Y&&Y<P){for(let e=0;e<Y-y;e++){let n=t[e];c[i].push({content:n.v,style:n,width:n.measureText.width,height:n.measureText.actualBoundingBoxAscent+n.measureText.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:n.measureText.actualBoundingBoxAscent,desc:n.measureText.actualBoundingBoxDescent,inline:!0,fs:n.fs})}y=Y,P=Y+1,i+=1,Y=null}else{y=P-1;for(let e=0;e<t.length-1;e++){let n=t[e];c[i].push({content:n.v,style:n,width:n.measureText.width,height:n.measureText.actualBoundingBoxAscent+n.measureText.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:n.measureText.actualBoundingBoxAscent,desc:n.measureText.actualBoundingBoxDescent,inline:!0,fs:n.fs})}i+=1}else{if(P==H.length){null==c[i]&&(c[i]=[]);for(let e=0;e<t.length;e++){let n=t[e];c[i].push({content:n.v,style:n,width:n.measureText.width,height:n.measureText.actualBoundingBoxAscent+n.measureText.actualBoundingBoxDescent,left:0,top:0,splitIndex:i,asc:n.measureText.actualBoundingBoxAscent,desc:n.measureText.actualBoundingBoxDescent,inline:!0,fs:n.fs})}break}null==c[i]&&(c[i]=[]),P++}}else for(v=v.toString();P<=v.length;){let t=v.substring(y,P),n=r(t,e),a=n.width,u=n.actualBoundingBoxAscent+n.actualBoundingBoxDescent,o=a*Math.cos(T*Math.PI/180)+u*Math.sin(T*Math.PI/180),B=a*Math.sin(T*Math.PI/180)+u*Math.cos(T*Math.PI/180),M=t.substr(t.length-1,1);if(" "!=M&&2!=g(M)||null!=A&&(X={index:P,str:h,width:x,height:d,asc:A.actualBoundingBoxAscent,desc:A.actualBoundingBoxDescent}),0!=T)if(B+p>s&&null!=c[i]&&P!=v.length)null!=X&&X.index<P?(y=X.index,P=X.index+1,c[i].push({content:X.str,style:I,width:X.width,height:X.height,left:0,top:0,splitIndex:i,asc:X.asc,desc:X.desc,fs:C}),i+=1,X=null):(y=P-1,c[i].push({content:h,style:I,left:0,top:0,splitIndex:i,height:d,width:x,asc:n.actualBoundingBoxAscent,desc:n.actualBoundingBoxDescent,fs:C}),i+=1);else{if(P==v.length){null==c[i]&&(c[i]=[]),c[i].push({content:t,style:I,left:0,top:0,splitIndex:i,height:u,width:a,asc:n.actualBoundingBoxAscent,desc:n.actualBoundingBoxDescent,fs:C});break}null==c[i]&&(c[i]=[]),P++}else if(o+f>l&&null!=c[i]&&P!=v.length)null!=X&&X.index<P?(y=X.index,P=X.index+1,c[i].push({content:X.str,style:I,width:X.width,height:X.height,left:0,top:0,splitIndex:i,asc:X.asc,desc:X.desc,fs:C}),i+=1,X=null):(X=null,y=P-1,c[i].push({content:h,style:I,width:x,height:d,left:0,top:0,splitIndex:i,asc:n.actualBoundingBoxAscent,desc:n.actualBoundingBoxDescent,fs:C}),i+=1);else{if(P==v.length){null==c[i]&&(c[i]=[]),c[i].push({content:t,style:I,width:a,height:u,left:0,top:0,splitIndex:i,asc:n.actualBoundingBoxAscent,desc:n.actualBoundingBoxDescent,fs:C});break}null==c[i]&&(c[i]=[]),P++}h=t,d=u,x=a,A=n}let k=[],R=0,z=Object.keys(c).length;for(let e=0;e<z;e++){let l=c[e];if(null==l)continue;let s=0,o=0,i=0,h=0,d=0,x=0;for(let e=0;e<l.length;e++){let n=l[e];s+=n.width,o=Math.max(o,n.height-(t?n.desc:0)),i=Math.max(i,t?n.desc:0),h=Math.max(h,n.asc),x++}d=o/2,R=Math.max(R,x),0!=T?(o+=d,u=Math.max(u,s),a+=o):(o+=d,n=Math.max(n,s),a+=o),k.push({width:s,height:o,desc:i,asc:h,lineHeight:d,wordCount:x})}let N=0,S=0,j=T*Math.PI/180,O=k[z-1],$=O.lineHeight,q=(a=a-$+O.desc)/Math.sin(j)+u*Math.cos(j),E=u*Math.sin(j),F=0;if(0!=T?(1==z?(n=u+a/Math.tan(j)*2,F=a/Math.tan(j)):n=u+a/Math.tan(j),L.textWidthAll=q,L.textHeightAll=E):(L.textWidthAll=n,L.textHeightAll=a),"onlyWidth"==o)return L;if(0!=T&&"1"==D){e.textAlign="end";for(let t=0;t<z;t++){let e=c[t];if(null==e)continue;let o=k[t];S=0;for(let t=e.length-1;t>=0;t--){let i,c,h=e[t];if(0!=T){let t,e=N+o.asc;if(t=N/Math.tan(j)-S+u,"0"==M){Math.sin(j);"0"==w?(i=t+l/2-n/2+$*Math.cos(j)/2,c=e+s/2-a/2-$*Math.cos(j)/2):"1"==w?(i=t+l/2-n/2,c=e-(a/2-E/2)):"2"==w&&(i=t+l/2-n/2+$*Math.cos(j),c=e+s-E/2-a/2-$*Math.cos(j))}else"1"==M?"0"==w?(i=t-E*Math.sin(j)/2+$*Math.cos(j)/2,c=e+s/2+E*Math.cos(j)/2-$*Math.cos(j)/2):"1"==w?(i=t-E*Math.sin(j),c=e+E*Math.cos(j)):"2"==w&&(i=t+$*Math.cos(j),c=e+s-$*Math.cos(j)):"2"==M&&("0"==w?(i=t+l-q/2-(u/2+a/2/Math.tan(j))+$*Math.cos(j)/2,c=e+s/2-a/2-$*Math.cos(j)/2):"1"==w?(i=t+l-n+F,c=e-a):"2"==w&&(i=t+l-q*Math.cos(j)+$*Math.cos(j),c=e+s-q*Math.sin(j)-$*Math.cos(j)))}h.left=i,h.top=c,B(h,_,b,{width:h.width,height:h.height,left:i-h.width,top:c,asc:o.asc,desc:o.desc,fs:h.fs}),L.values.push(h),S+=h.width}N+=o.height}}else for(let t=0;t<z;t++){let e=c[t];if(null==e)continue;let u=k[t];S=0;for(let t=0;t<e.length;t++){let o,i,c=e[t];if(0!=T){let t,e=N+u.asc;if(t=(a-N)/Math.tan(j)+S,"0"==M){Math.sin(j);"0"==w?(o=t+l/2-n/2-$*Math.cos(j)/2,i=e+s/2-a/2+$*Math.cos(j)/2):"1"==w?(o=t+l/2-n/2-$*Math.cos(j)/2,i=e-(a/2-E/2)+$*Math.cos(j)/2):"2"==w&&(o=t+l/2-n/2-$*Math.cos(j),i=e+s-E/2-a/2-$*Math.cos(j))}else"1"==M?"0"==w?(o=t-E*Math.sin(j)/2-$*Math.cos(j)/2,i=e-a+s/2-E*Math.cos(j)/2-$*Math.cos(j)/2):"1"==w?(o=t,i=e-a):"2"==w&&(o=t-E*Math.sin(j)-$*Math.cos(j),i=e-a+s-E*Math.cos(j)-$*Math.cos(j)):"2"==M&&("0"==w?(o=t+l-q/2-n/2-$*Math.cos(j)/2,i=e+s/2-a/2-$*Math.cos(j)/2):"1"==w?(o=t+l-q*Math.cos(j),i=e+E*Math.cos(j)):"2"==w&&(o=t+l-n-$*Math.cos(j)+F,i=e+s-$*Math.cos(j)));B(c,_,b,{width:c.width,height:c.height,left:o,top:i,asc:u.asc,desc:u.desc,fs:c.fs})}else o=f+S,"0"==M?o=l/2+S-u.width/2:"2"==M&&(o=l+S-u.width),i=s-p+N+u.asc-a,"0"==w?i=s/2+N-a/2+u.asc:"1"==w&&(i=p+N+u.asc),B(c,_,b,{width:c.width,height:c.height,left:o,top:i,asc:u.asc,desc:u.desc,fs:c.fs});c.left=o,c.top=i,L.values.push(c),S+=c.width}N+=u.height}L.type="plainWrap",0!=T&&("0"==M?"0"==w?(L.textLeftAll=l/2,L.textTopAll=s/2):"1"==w?(L.textLeftAll=l/2,L.textTopAll=E/2):"2"==w&&(L.textLeftAll=l/2,L.textTopAll=s-E/2):"1"==M?"0"==w?(L.textLeftAll=0,L.textTopAll=s/2):"1"==w?(L.textLeftAll=0,L.textTopAll=0):"2"==w&&(L.textLeftAll=0,L.textTopAll=s):"2"==M&&("0"==w?(L.textLeftAll=l-q/2,L.textTopAll=s/2):"1"==w?(L.textLeftAll=l,L.textTopAll=0):"2"==w&&(L.textLeftAll=l,L.textTopAll=s)))}else{let t=r(v,e),n=t.width,a=t.actualBoundingBoxDescent+t.actualBoundingBoxAscent;L.rotate=T;let u=(T=Math.abs(T))*Math.PI/180,i=n*Math.cos(u)+a*Math.sin(u),c=n*Math.sin(u)+a*Math.cos(u);if(L.textHeightAll=0!=T?c:c+a/2-t.actualBoundingBoxDescent-p,L.textWidthAll=i,"onlyWidth"==o)return L;let h=i,d=c,x=f+a*Math.sin(u)*D;"0"==M?x=l/2-h/2+a*Math.sin(u)*D:"2"==M&&(x=l-f-h+a*Math.sin(u)*D);let g=s-p-d+t.actualBoundingBoxAscent*Math.cos(u)+n*Math.sin(u)*D;"0"==w?g=s/2-d/2+t.actualBoundingBoxAscent*Math.cos(u)+n*Math.sin(u)*D:"1"==w&&(g=p+t.actualBoundingBoxAscent*Math.cos(u)+n*Math.sin(u)*D),L.type="plain";let m={content:v,style:I,width:h,height:d,left:x,top:g};B(m,_,b,{width:n,height:a,left:x,top:g,asc:t.actualBoundingBoxAscent,desc:t.actualBoundingBoxDescent,fs:C}),L.values.push(m),L.textLeftAll=x,L.textTopAll=g,L.asc=t.actualBoundingBoxAscent,L.desc=t.actualBoundingBoxDescent}}return L}function B(t,e,n,l){let s=l.left,a=l.top,u=l.width,o=(l.height,l.asc),i=l.desc,c=l.fs;if(!0!==t.wrap&&(1==t.inline&&null!=t.style&&(e=t.style.cl,n=t.style.un),"0"!=e&&(t.cancelLine={},t.cancelLine.startX=s,t.cancelLine.startY=a-o/2+1,t.cancelLine.endX=s+u,t.cancelLine.endY=a-o/2+1,t.cancelLine.fs=c),"0"!=n)){if(t.underLine=[],"1"==n||"2"==n){let e={};e.startX=s,e.startY=a,e.endX=s+u,e.endY=a,e.fs=c,t.underLine.push(e)}if("2"==n){let e={};e.startX=s,e.startY=a+i,e.endX=s+u,e.endY=a+i,e.fs=c,t.underLine.push(e)}if("3"==n||"4"==n){let e={};e.startX=s,e.startY=a+i,e.endX=s+u,e.endY=a+i,e.fs=c,t.underLine.push(e)}if("4"==n){let e={};e.startX=s,e.startY=a+i+2,e.endX=s+u,e.endY=a+i+2,e.fs=c,t.underLine.push(e)}}}return{rowlenByRange:function(t,e,n,l){let s=$.extend(!0,{},l);null==s.rowlen&&(s.rowlen={}),null==s.customHeight&&(s.customHeight={});let u=$("#luckysheetTableContent").get(0).getContext("2d");u.textBaseline="top";for(let l=e;l<=n;l++){if(null!=s.rowhidden&&null!=s.rowhidden[l])continue;let e=a.defaultrowlen;if(1!=s.customHeight[l]){delete s.rowlen[l];for(let n=0;n<t[l].length;n++){let s=t[l][n];if(null!=s&&null==s.mc&&null!=s&&(null!=s.v||c(s))){let t=f(s,u,{r:l,c:n,cellWidth:h(n)[1]-h(n)[0]-2}),a=0;null!=t&&(a=t.textHeightAll+2),a>e&&(e=a)}}(e/=a.zoomRatio)!=a.defaultrowlen&&(s.rowlen[l]=e)}}return s},computeRowlenArr:function(t,e){let n=[],l=0;for(let s=0;s<t;s++){let t=a.defaultrowlen;null!=e.rowlen&&null!=e.rowlen[s]&&(t=e.rowlen[s]),null==e.rowhidden||null==e.rowhidden[s]?(l+=t+1,n.push(l)):(t=e.rowhidden[s],n.push(l))}return n},getCellTextSplitArr:function t(e,n,l,s){for(let a=1;a<=e.length;a++){let u=e.substring(0,a);if(r(u,s).width>l)return a-1<=0?n:(n.push(e.substring(0,a-1)),t(e.substring(a-1),n,l,s));a==e.length&&n.push(u)}return n},getMeasureText:r,getCellTextInfo:f}});
//# sourceMappingURL=../sourcemaps/methods/getRowlen.js.map
