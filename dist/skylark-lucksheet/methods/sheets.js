/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./getdata","./setdata","../utils/util","./get","./dynamicArray","./formula_methods","../locale/locale","./luckysheetConfigsetting","../store"],function(e,t,l,n,i,r,a,h,u){"use strict";const{getObjType:o,rgbTohex:c,textTrim:s}=l,{getSheetIndex:f}=n,{dynamicArrayCompute:d}=i,{getcellvalue:g,datagridgrowth:S,getcellFormula:x}=e,{setcellvalue:m}=t;return{generateRandomSheetIndex:function(e){null==e&&(e="Sheet");let t=window.navigator.userAgent.replace(/[^a-zA-Z0-9]/g,"").split(""),l="";for(let e=0;e<12;e++)l+=t[Math.round(Math.random()*(t.length-1))];return e+"_"+l+"_"+(new Date).getTime()},generateRandomSheetName:function(e,t){let l=e.length;const n=a().pivotTable.title;for(let t=0;t<e.length;t++)if(e[t].name.indexOf("Sheet")>-1||e[t].name.indexOf(n)>-1){let i=parseFloat(e[t].name.replace("Sheet","").replace(n,""));"NaN"!=i&&Math.ceil(i)>l&&(l=Math.ceil(i))}return t?n+(l+1):"Sheet"+(l+1)},generateCopySheetName:function(e,t){let l="",n=a().info;if(t.toString().indexOf("("+n.copy)>-1){let i=t.toString().indexOf("("+n.copy),r=t.toString().substring(0,i)+"("+n.copy,a=null;for(let t=0;t<e.length;t++){let l=e[t].name.toString(),n=l.indexOf(r);if(n>-1){let e=l.indexOf(")",n+r.length),t=l.substring(n+r.length,e);isRealNum(t)&&(null==a||parseInt(t)>a)&&(a=parseInt(t))}}l=null==a?r+"2)":r+ ++a+")"}else{let i=null,r=!1,a=t+"("+n.copy;for(let t=0;t<e.length;t++){let l=e[t].name.toString(),n=l.indexOf(a);if(n>-1){r=!0;let e=l.indexOf(")",n+a.length),t=l.substring(n+a.length,e);isRealNum(t)&&(null==i||parseInt(t)>i)&&(i=parseInt(t))}}r?null==i?l=t+"("+n.copy+"2)":(i++,l=t+"("+n.copy+i+")"):l=t+"("+n.copy+")"}return l},getSheetByIndex:function(e){return u.getSheetIndex(e)},getSheetByName:function(e){return u.getSheetByName(e)},getCurSheetnoset:function(){return u.getCurSheetnoset()},getCurSheet:function(){return u.getCurSheet()},hasSheet:function(e){return u.hasSheet(e)},getGridData:function(e){return u.getGridData(e)},buildGridData:function(e){let t=null==e.row?u.defaultrowNum:e.row,l=null==e.column?u.defaultcolumnNum:e.column,n=e.data&&e.data.length>0?e.data:S([],t,l),i=e.celldata;if(e.data&&e.data.length>0)for(let e=0;e<n.length;e++)for(let t=0;t<n[0].length;t++)m(e,t,n,n[e][t]);else if(i&&i.length>0)for(let e=0;e<i.length;e++){let t=i[e],l=t.r,r=t.c,a=t.v;l>=n.length&&(n=S(n,l-n.length+1,0)),r>=n[0].length&&(n=S(n,0,r-n[0].length+1)),m(l,r,n,a)}return h.autoFormatw=!1,h.accuracy=void 0,n},cutGridData:function(e){let t=0;for(let l=e.length-1;l>=0;l--){let n=!0;for(let t=0;t<e[0].length;t++){let e=g(l,t);if(null!=e&&$.trim(e).length>0){n=!1;break}}if(!n)break;t=l}return e.slice(0,t)},addGridData:function(e,t,l){let n=S([],t,l);if(null!=e)for(let t=0;t<e.length;t++){let l=e[t],i=l.r,r=l.c,a=l.v;i>=n.length&&(n=S(n,i-n.length+1,0)),r>=n[0].length&&(n=S(n,0,r-n[0].length+1)),m(i,r,n,a)}return n},sheetParamRestore:function(e,t){if(u.luckysheet_select_save=e.luckysheet_select_save,null!=u.luckysheet_select_save&&0!=u.luckysheet_select_save.length||(null!=t[0]&&null!=t[0][0]&&null!=t[0][0].mc?u.luckysheet_select_save=[{row:[0,t[0][0].mc.rs-1],column:[0,t[0][0].mc.cs-1]}]:u.luckysheet_select_save=[{row:[0,0],column:[0,0]}]),u.luckysheet_selection_range=null==e.luckysheet_selection_range?[]:e.luckysheet_selection_range,u.config=null==e.config?{}:e.config,u.zoomRatio=null==e.zoomRatio?1:e.zoomRatio,null!=e.defaultRowHeight?u.defaultrowlen=parseFloat(e.defaultRowHeight):u.defaultrowlen=h.defaultRowHeight,null!=e.defaultColWidth?u.defaultcollen=parseFloat(e.defaultColWidth):u.defaultcollen=h.defaultColWidth,null!=e.showGridLines){let t=e.showGridLines;u.showGridLines=0!=t&&0!=t}else u.showGridLines=!0},loadOtherFile:function(e){let t=this;for(let l=0;l<u.luckysheetfile.length;l++){let n=u.luckysheetfile[l];n.index!=e.index&&(null!=n.load&&"0"!=n.load||(n.data=t.buildGridData(n),n.load="1"))}},checkLoadSheetIndexToDataIndex:{},checkLoadSheetIndex:function(e){let t=r.getAllFunctionGroup(),l=e.chart,n=e.pivotTable,i=[],a={};if(e.index in this.checkLoadSheetIndexToDataIndex)return[];if(i.push(e.index),a[e.index.toString()]=1,this.checkLoadSheetIndexToDataIndex[e.index]=1,null!=t){let e={};for(let l=0;l<t.length;l++){let n=t[l],i=n.index,a=x(n.r,n.c,i);if(null==a){let e=u.luckysheetfile[this.getSheetIndex(i)];if(e.data=this.buildGridData(e),null==(a=x(n.r,n.c,i)))continue}if(-1==a.indexOf("!"))r.addToSheetIndexList(a,i);else if(null!=r.formulaContainSheetList&&null!=r.formulaContainSheetList[a])for(let t in r.formulaContainSheetList[a])e[t]=1;else r.functionParser(a,t=>{if(r.addToCellList(a,t),t.indexOf("!")>-1){let l=t.substr(0,t.indexOf("!")),n=this.getSheetByName(l);if(null!=n){let t=n.index;e[t]=1,r.addToSheetIndexList(a,t)}}}),null==r.formulaContainSheetList[a]&&r.addToSheetIndexList(a,i)}for(let t in e){let e=t;null==a[e.toString()]&&(i.push(e),a[e.toString()]=1,this.checkLoadSheetIndexToDataIndex[e]=1)}}if(null!=l)for(let e=0;e<l.length;e++){let t=l[e].dataSheetIndex;null!=t&&(null==a[t.toString()]&&(i.push(t),a[t.toString()]=1))}if(null!=n){let e=n.pivotDataSheetIndex;null!=e&&null==a[e.toString()]&&(i.push(e),a[e.toString()]=1)}return i},setCurSheet:function(e){u.setCurSheet(e)},getSheetIndex:function(e){return u.getSheetIndex(e)},delChart:function(e,t){let l=this.getSheetIndex(t),n=u.luckysheetfile[l];if(null==n.chart)n.chart=[];else for(let t=0;t<n.chart.length;t++)if(n.chart[t].chart_id==e){u.luckysheetfile[l].chart.splice(t,1);break}},saveChart:function(e){let t=this.getSheetIndex(e.sheetIndex),l=u.luckysheetfile[t];if(null==l.chart)l.chart=[],l.chart.push(e);else{for(let t=0;t<l.chart.length;t++)if(l.chart[t].chart_id==e.chart_id){let n=$.extend(!0,{},l.chart[t]);return void(l.chart[t]=$.extend(!0,{},n,e))}l.chart.push(e)}},getChart:function(e,t){let l=this.getSheetIndex(e),n=u.luckysheetfile[l];if(null==n.chart)return null;for(let e=0;e<n.chart.length;e++)if(n.chart[e].chart_id==t)return n.chart[e];return null},getRangetxt:function(e,t,l){let n="";null==l&&(l=u.currentSheetIndex),e!=l&&(n=u.luckysheetfile[this.getSheetIndex(e)].name+"!");let i=t.row[0],r=t.row[1],a=t.column[0],h=t.column[1];return null==i&&null==r?n+chatatABC(a)+":"+chatatABC(h):null==a&&null==h?n+(i+1)+":"+(r+1):a==h&&i==r?n+chatatABC(a)+(i+1):n+chatatABC(a)+(i+1)+":"+chatatABC(h)+(r+1)},getSheetName:function(e){return null==e&&(e=u.currentSheetIndex),u.luckysheetfile[this.getSheetIndex(e)].name},getSheetData:function(e){return null==e&&(e=u.currentSheetIndex),u.luckysheetfile[this.getSheetIndex(e)].data},getSheetConfig:function(e){let t=this;return null==e&&(e=u.currentSheetIndex),null==u.luckysheetfile[t.getSheetIndex(e)].config&&(u.luckysheetfile[t.getSheetIndex(e)].config={}),u.luckysheetfile[t.getSheetIndex(e)].config},CacheNotLoadControll:[],execCache:function(e){let t=this,l=e.t,n=e.i,i=e.v,a=u.luckysheetfile[t.getSheetIndex(n)];if("sha"==l)u.luckysheetfile.push(i);else if("shc"==l){let e=$.extend(!0,{},u.luckysheetfile[t.getSheetIndex(i.copyindex)]);e.index=n,u.luckysheetfile.push(e)}else if("shd"==l)u.luckysheetfile.splice(i.deleIndex,1);else if("shr"==l)for(let e in i)u.luckysheetfile[t.getSheetIndex(e)].order=i[e];if(null!=a&&"1"==a.load||l in{sha:0,shc:0,shd:0,shr:0})if("v"==l){let l=e.r,i=e.c,r=e.v;t.getSheetData(n);a.data[l][i]=r}else if("fc"==l){let t=e.op;e.pos;"object"!=o(i)&&(i=new Function("return "+i)());let l=i.r,a=i.c;"del"==t?r.delFunctionGroup(l,a,n):r.insertUpdateFunctionGroup(l,a,n)}else if("cg"==l){let l=i,r=e.k,a=t.getSheetConfig(n);r in a||(a[r]={});for(let e in l)a[r][e]=l[e];u.config=a}else if("f"==l){let t=i,l=e.op,n=e.pos,r=a.filter;null==r&&(r={}),"upOrAdd"==l?r[n]=t:"del"==l&&delete r[n]}else if("fsc"==l)a.filter=null,a.filter_select=null;else if("fsr"==l){let e=i;a.filter=e.filter,a.filter_select=e.filter_select}else if("sh"==l){let l=e.op,n=e.cur;if("hide"==l)a.status=0,u.luckysheetfile[t.getSheetIndex(n)].status=1;else if("show"==l){for(let e=0;e<u.luckysheetfile.length;e++)u.luckysheetfile[e].status=0;a.status=1}}else if("all"==l){let t=e.k;e.s&&"object"!=o(i)?a[t]=JSON.stringify(i):a[t]=i}else if("c"==l){let t=e.op,l=e.cid;if("add"==t)a.chart.push(i);else if("xy"==t||"wh"==t||"update"==t){for(let e=0;e<a.chart.length;e++)if(a.chart[e].chart_id==l){for(let t in a.chart[e])for(let l in i)t==l&&(a.chart[e][t]=i[l]);return}}else if("del"==t)for(let e=0;e<a.chart.length;e++)if(a.chart[e].chart_id==l)return void a.chart.splice(e,1)}else if("drc"==l){let t=e.rc,l=i.index,n=i.len,r=a.celldata;if("r"==t){for(let e=0;0==r.length;e++){let t=r[e];t.r>=l&&t.r<l+n?delete r[e]:t.r>=l+n&&(t.r-=n)}a.row-=n}else{for(let e=0;0==r.length;e++){let t=r[e];t.c>=l&&t.c<l+n?delete r[e]:t.c>=l+n&&(t.c-=n)}a.column-=n}let h,u,o,c=[];for(let e=0;e<r.length;e++)null!=r[e]&&c.push(r[e]);a.celldata=c,h="r"==t?"row":"column",luckysheetdeletetable(h,u=l,o=l+n-1,!0)}else if("arc"==l){let t,l=e.rc,n=i.index,r=i.len,h=a.celldata;if("r"==l){for(let e=0;e<h.length;e++){let t=h[e];t.r>n&&(t.r+=r)}a.row+=r}else{for(let e=0;e<h.length;e++){let t=h[e];t.c>n&&(t.c+=r)}a.column+=r}t="r"==l?"row":"column",luckysheetextendtable(t,n,r,!0)}else"na"==l?u.saveParam("na",null,i):"thumb"==l&&setTimeout(function(){t.imageRequest()},2e3);else t.CacheNotLoadControll.push(e)}}});
//# sourceMappingURL=../sourcemaps/methods/sheets.js.map
