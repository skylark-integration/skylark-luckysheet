/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../utils/util","./get","./set","./validate","./datecontroll","./getRowlen","./getdata","./setdata","./format","./location","./luckysheetConfigsetting","../function/func","../store","../locale/locale","./json"],function(e,t,n,l,i,r,u,s,c,o,a,f,h,g,p){"use strict";const{replaceHtml:d,getObjType:x,chatatABC:m,ABCatNum:y,luckysheetfontformat:b}=e,{getSheetIndex:k,getRangetxt:S,getluckysheetfile:_}=t,{setluckysheetfile:F}=n,{isRealNum:w,isRealNull:v,valueIsError:C}=l,R=a.isEditMode,{isdatetime:I,isdatatype:O}=i,{getCellTextSplitArr:q,getCellTextInfo:A}=r,{getcellvalue:j,getcellFormula:N,getInlineStringNoStyle:D,getOrigincell:T}=u,{setcellvalue:L}=s,{genarate:E,valueShowEs:P}=c,{rowLocation:G,colLocation:V,colLocationByIndex:z,mouseposition:Z}=o,{luckysheet_compareWith:M,luckysheet_getarraydata:U,luckysheet_getcelldata:B,luckysheet_parseData:W,luckysheet_getValue:J,luckysheet_indirect_check:X,luckysheet_indirect_check_return:H,luckysheet_offset_check:K,luckysheet_calcADPMM:Q,luckysheet_getSpecialReference:Y}=f;return{error:{v:"#VALUE!",n:"#NAME?",na:"#N/A",r:"#REF!",d:"#DIV/0!",nm:"#NUM!",nl:"#NULL!",sp:"#SPILL!"},errorInfo:function(e){return e},errorParamCheck:function(e,t,n){let l,require,i=g().formulaMore;return n<e.length?(l=e[n].type,require=e[n].require):(l=e[e.length-1].type,require=e[e.length-1].require),"o"!=require||null!=t&&""!=t?l.indexOf("all")>-1?[!0,i.tipSuccessText]:l.indexOf("range")>-1&&("object"==x(t)||"array"==x(t))?[!0,i.tipSuccessText]:l.indexOf("number")>-1&&(w(t)||"boolean"==x(t))?[!0,i.tipSuccessText]:l.indexOf("string")>-1&&"string"==x(t)?[!0,i.tipSuccessText]:l.indexOf("date")>-1&&I(t)?[!0,i.tipSuccessText]:[!1,i.tipParamErrorText]:[!0,i.tipSuccessText]},getPureValueByData:function(e){if(0==e.length)return[];let t=[];if("array"==x(e))if("array"==x(e[0]))for(let n=0;n<e.length;n++){let l=[];for(let t=0;t<e[0].length;t++){let i=e[n][t];"object"==x(i)?l.push(i.v):l.push(i)}t.push(l)}else for(let n=0;n<e.length;n++){let l=e[n];"object"==x(l)?t.push(l.v):t.push(l)}else{let n=e;"object"==x(n)?t.push(n.v):t.push(n)}return t},readCellDataToOneArray:function(e){let t=this;if(null==e)return[];if("object"!=x(e))return[e];let n=[],l=[];if(null==e||null==e.data)return null==e||v(e.v)?[]:[e.v];if(l=e.data,"array"==x(l))l=t.getPureValueByData(l);else{if("object"==x(l))return[l=l.v];/\{.*?\}/.test(l)&&(l=l.replace(/\{/g,"[").replace(/\}/g,"]")),l=new Function("return "+l)()}if("array"==x(l[0]))for(let e=0;e<l.length;e++)n=n.concat(l[e]);else n=l;return n},getValueByFuncData:function(e,t){if(null==e)return null;return"array"==x(e)?"avg"==t?luckysheet_function.AVERAGE.f.apply(luckysheet_function.AVERAGE,e):"sum"==t?luckysheet_function.SUM.f.apply(luckysheet_function.SUM,e):"object"==x(e[0])?luckysheet.mask.getValueByFormat(e[0]):e[0]:"object"==x(e)?luckysheet.mask.getValueByFormat(e):e},sparklinesColorMap:function(e,t){let n=this,l=null;null==t&&(t=5);if(e.length>t)for(let i=t;i<e.length;i++){let t=e[i],r=n.readCellDataToOneArray(t);for(let e=0;e<r.length;e++){let t=r[e];if(t.indexOf(":")>-1){l||(l={});let e=t.split(":");2==e.length?l[e[0]]=e[1]:e.length>1&&(l[e[0]+":"+e[1]]=e[2])}else l||(l=[]),l.push(t)}0}return l},colorList:["#2ec7c9","#fc5c5c","#5ab1ef","#ffb980","#d87a80","#8d98b3","#e5cf0d","#97b552","#95706d","#dc69aa","#07a2a4","#9a7fd1","#588dd5","#f5994e","#c05050","#59678c","#c9ab00","#7eb00a","#6f5553","#c14089"],classlist:{province:{11:"北京",12:"天津",13:"河北",14:"山西",15:"内蒙古",21:"辽宁",22:"吉林",23:"黑龙江",31:"上海",32:"江苏",33:"浙江",34:"安徽",35:"福建",36:"江西",37:"山东",41:"河南",42:"湖北",43:"湖南",44:"广东",45:"广西",46:"海南",50:"重庆",51:"四川",52:"贵州",53:"云南",54:"西藏",61:"陕西",62:"甘肃",63:"青海",64:"宁夏",65:"新疆",71:"台湾",81:"香港",82:"澳门",91:"国外"}},cellOffset:function(e,t,n,l,i){let r,u=e.startCell,s=(e.rowl,e.coll,parseInt(u.replace(/[^0-9]/g,""))),c=y(u.replace(/[^A-Za-z]/g,"")),o=[],a=[];o[0]=s+t,a[0]=c+n,o[1]=o[0]+l-1,a[1]=a[0]+i-1,a[0]=m(a[0]),a[1]=m(a[1]);let f=a[0]+o[0],h=a[1]+o[1];return r=f==h?e.sheetName+"!"+f:e.sheetName+"!"+f+":"+h},parseDatetoNum:function(e){let t=this;if("object"==typeof e&&"number"==typeof e.v)e=e.v;else if("num"==O(e))e=parseFloat(e);else{if("date"!=O(e))return t.error.v;e=E(e)[2]}return e},getRangeArray:function(e){let t=[],n="General";if(1==e.length)for(let l=0;l<e[0].length;l++)if(null!=e[0][l]&&e[0][l].v){t.push(e[0][l].v);let i=e[0][l].ct.fa;n="General"==n?i:n}else t.push(null);else if(1==e[0].length)for(let l=0;l<e.length;l++)if(null!=e[l][0]&&e[l][0].v){t.push(e[l][0].v);let i=e[l][0].ct.fa;n="General"==n?i:n}else t.push(null);else for(let l=0;l<e.length;l++)for(let i=0;i<e[l].length;i++)if(null!=e[l][i]&&e[l][i].v){t.push(e[l][i].v);let r=e[l][i].ct.fa;n="General"==n?r:n}else t.push(null);return[e=t,n]},getRangeArrayTwo:function(e){let t=$.extend(!0,[],e);if(1==t.length)for(let e=0;e<t[0].length;e++)t[0][e]instanceof Object&&(null!=t[0][e]&&t[0][e]instanceof Object&&t[0][e].m?t[0][e]=t[0][e].m:null!=t[0][e]&&t[0][e]instanceof Object&&t[0][e].v?t[0][e]=t[0][e].v:t[0][e]=null);else if(1==t[0].length)for(let e=0;e<t.length;e++)t[e][0]instanceof Object&&(null!=t[e][0]&&t[e][0]instanceof Object&&t[e][0].m?t[e][0]=t[e][0].m:null!=t[e][0]&&t[e][0]instanceof Object&&t[e][0].v?t[e][0]=t[e][0].v:t[e][0]=null);else for(let e=0;e<t.length;e++)for(let n=0;n<t[e].length;n++)t[e][n]instanceof Object&&(null!=t[e][n]&&t[e][n]instanceof Object&&t[e][n].m?t[e][n]=t[e][n].m:null!=t[e][n]&&t[e][n]instanceof Object&&t[e][n].v?t[e][n]=t[e][n].v:t[e][n]=null);return t},isWildcard:function(e,t){let n=this;e=e.toString(),t=t.toString(),n.isCompareOperator(t).flag&&(t=n.isCompareOperator(t).num);let l="";for(let e=0;e<t.length;e++){let n=t.charAt(e);"*"==n?l+=".*":"?"==n?l+=".":"~"==n?"*"==t.charAt(e+1)?(l+="\\*",e++):"?"==t.charAt(e+1)?(l+="\\?",e++):l+="~":l+=n}let i=new RegExp("^"+l+"$","g");return!!e.match(i)},isCompareOperator:function(e){let t,n="",l="",i=(e=e.toString()).substr(0,1),r=e.substr(1,1),u=!1;return">"==i?"="==r?(n=e.substr(0,2),l=e.substr(2),u=!0):"="!=r&&(n=e.substr(0,1),l=e.substr(1),u=!0):"<"==i?"="==r||">"==r?(n=e.substr(0,2),l=e.substr(2),u=!0):"="!=r&&">"!=r&&(n=e.substr(0,1),l=e.substr(1),u=!0):"="==i&&"="!=r&&(n=e.substr(0,1),l=e.substr(1),u=!0),t={flag:u,ope:n,num:l}},acompareb:function(e,t){let n=this,l=!1;if(w(t))l=M(e,"==",t);else if("string"==typeof t){if(-1!=t.indexOf("*")||-1!=t.indexOf("?"))return n.isWildcard(e,t);if(n.isCompareOperator(t).flag){let i=n.isCompareOperator(t).ope,r=n.isCompareOperator(t).num;l=M(e,i,r)}else l=M(e,"==",t)}return l},compareParams:function(e,t,n){let l=!1,i=toString.call(e),r=toString.call(t);if(">"==n&&e>t?l=!0:">="==n&&e>=t?l=!0:"<"==n&&e<t?l=!0:"<="==n&&e<=t?l=!0:"="==n&&e==t?l=!0:"<>"==n&&e!=t&&(l=!0),"[object Object]"==i&&"[object Object]"==r){let n=Object.getOwnPropertyNames(e),l=Object.getOwnPropertyNames(t);if(n.length!=l.length)return!1;for(let l=0;l<n.length;l++){let i=n[l];if(e[i]!==t[i])return!1}return!0}return"[object Array]"==i&&"[object Array]"==r?e.toString()==t.toString():l},parseDecimal:function(e){e=parseFloat(e);let t=parseInt(e,10);return 0==t?e:e%=t},getcellrange:function(e,t){if(null==e||0==e.length)return;let n="",l="",i=null,r=null,u=_();if(e.indexOf("!")>-1){if(e in this.cellTextToIndexList)return this.cellTextToIndexList[e];let t=e.split("!");n=t[0],l=t[1],"'"==(n=n.replace(/\\'/g,"'").replace(/''/g,"'")).substr(0,1)&&"'"==n.substr(n.length-1,1)&&(n=n.substring(1,n.length-1));for(let e in u)if(n==u[e].name){i=u[e].index,r=u[e].data;break}}else{let s=t;if(null==s&&(s=h.currentSheetIndex),e+"_"+s in this.cellTextToIndexList)return this.cellTextToIndexList[e+"_"+s];let c=k(s);n=u[c].name,i=u[c].index,r=h.flowdata,l=e}if(-1==l.indexOf(":")){let t=parseInt(l.replace(/[^0-9]/g,""))-1,n=y(l.replace(/[^A-Za-z]/g,""));if(isNaN(t)||isNaN(n))return null;{let l={row:[t,t],column:[n,n],sheetIndex:i};return this.addToCellIndexList(e,l),l}}{l=l.split(":");let t=[],n=[];if(t[0]=parseInt(l[0].replace(/[^0-9]/g,""))-1,t[1]=parseInt(l[1].replace(/[^0-9]/g,""))-1,isNaN(t[0])&&(t[0]=0),isNaN(t[1])&&(t[1]=r.length-1),t[0]>t[1])return null;if(n[0]=y(l[0].replace(/[^A-Za-z]/g,"")),n[1]=y(l[1].replace(/[^A-Za-z]/g,"")),isNaN(n[0])&&(n[0]=0),isNaN(n[1])&&(n[1]=r[0].length-1),n[0]>n[1])return null;let u={row:t,column:n,sheetIndex:i};return this.addToCellIndexList(e,u),u}},iscellformat:function(e){},iscelldata:function(e){let t,n=e.split("!"),l=/^(([a-zA-Z]+)|([$][a-zA-Z]+))(([0-9]+)|([$][0-9]+))$/g,i=/^(((([a-zA-Z]+)|([$][a-zA-Z]+))(([0-9]+)|([$][0-9]+)))|((([a-zA-Z]+)|([$][a-zA-Z]+))))$/g;if(-1==(t=n.length>1?n[1]:n[0]).indexOf(":")){let e=parseInt(t.replace(/[^0-9]/g,""))-1,n=y(t.replace(/[^A-Za-z]/g,""));return!(isNaN(e)||isNaN(n)||!t.toString().match(l))||!!isNaN(e)&&(isNaN(n),!1)}{i=/^(((([a-zA-Z]+)|([$][a-zA-Z]+))(([0-9]+)|([$][0-9]+)))|((([a-zA-Z]+)|([$][a-zA-Z]+)))|((([0-9]+)|([$][0-9]+s))))$/g,t=t.split(":");let e=[],n=[];return e[0]=parseInt(t[0].replace(/[^0-9]/g,""))-1,e[1]=parseInt(t[1].replace(/[^0-9]/g,""))-1,e[0]>e[1]?!1:(n[0]=y(t[0].replace(/[^A-Za-z]/g,"")),n[1]=y(t[1].replace(/[^A-Za-z]/g,"")),!(n[0]>n[1])&&!(!t[0].toString().match(i)||!t[1].toString().match(i)))}},getfunctionParam:function(e){let t=this;if(null==t.operatorjson){let e=t.operator.split("|"),n={};for(let t=0;t<e.length;t++)n[e[t].toString()]=1;t.operatorjson=n}"="==e.substr(0,1)&&(e=e.substr(1));let n=e.split(""),l=0,i="",r="",u={bracket:0,comma:0,squote:0,dquote:0,compare:0},s=null,c=[],o=[];for(;l<n.length;){let e=n[l];if("("==e&&0==u.dquote)i.length>0&&0==o.length?(s=i.toUpperCase(),o.push(1),i=""):0==o.length?(o.push(0),i=""):(o.push(0),i+=e);else if(")"==e&&0==u.dquote){o.pop();0==o.length?(c.push(i),i=""):i+=e}else if('"'==e)i+='"',u.dquote>0?(u.dquote-=1,i=""):u.dquote+=1;else if(","==e&&0==u.dquote)o.length<=1?(c.push(i),i=""):i+=",";else if(e in t.operatorjson&&0==u.dquote){let s="";l+1<n.length&&(s=n[l+1]);let c=l-1,o=null;if(c>=0)do{o=n[c--]}while(c>=0&&" "==o);!/[^0-9]/.test(s)&&"-"==e&&("("==o||null==o||","==o||" "==o||o in t.operatorjson)?0==u.dquote?i+=$.trim(e):i+=e:(r="",i="")}else 0==u.dquote?i+=$.trim(e):i+=e;l++}return{fn:s,param:c}},calPostfixExpression:function(e){if(0==e.length)return"";let t=[];for(let n=e.length-1;n>=0;n--){let l=e[n];if(l in this.operatorjson){let e=t.pop(),n="luckysheet_compareWith("+t.pop()+",'"+l+"', "+e+")";t.push(n)}else t.push(l)}return t.length>0?t[0]:""},checkBracketNum:function(e){let t=e.match(/\(/g),n=e.match(/\)/g),l=e.match(/(['"])(?:(?!\1).)*?\1/g),i=e.match(/(['"])(?:(?!\1).)*?\1/g),r=0,u=0;null!=t&&(r+=t.length),null!=n&&(u+=n.length);let s=0,c=0;if(null!=l)for(let e=0;e<l.length;e++){let t=l[e].match(/\(/g);null!=t&&(s+=t.length)}if(null!=i)for(let e=0;e<i.length;e++){let t=i[e].match(/\)/g);null!=t&&(c+=t.length)}return(r-=s)==(u-=c)},operatorPriority:{"^":0,"%":1,"*":1,"/":1,"+":2,"-":2},functionParserExe:function(e){return this.functionParser(e)},functionParser:function(e,t){let n=this;if(null==n.operatorjson){let e=n.operator.split("|"),t={};for(let n=0;n<e.length;n++)t[e[n].toString()]=1;n.operatorjson=t}if(null==e)return"";"=+"==e.substr(0,2)?e=e.substr(2):"="==e.substr(0,1)&&(e=e.substr(1));let l=e.split(""),i=0,r="",u="",s={bracket:0,comma:0,squote:0,dquote:0,compare:0,braces:0},c=[],o=[],a=[],f=-1;for(;i<l.length;){let e=l[i];if("("==e&&0==s.squote&&0==s.dquote&&0==s.braces)if(r.length>0&&0==a.length){if((r=r.toUpperCase()).indexOf(":")>-1){let e=r.split(":");u+="luckysheet_getSpecialReference(true,'"+$.trim(e[0]).replace(/'/g,"\\'")+"', luckysheet_function."+e[1]+".f(#lucky#"}else u+="luckysheet_function."+r+".f(";a.push(1),r=""}else 0==a.length?(u+="(",a.push(0),r=""):(a.push(0),r+=e);else if(")"==e&&0==s.squote&&0==s.dquote&&0==s.braces){a.pop();if(0==a.length){let e=n.functionParser(r,t);e.indexOf("#lucky#")>-1&&(e=e.replace(/#lucky#/g,"")+")"),u+=e+")",r=""}else r+=e}else if("{"==e&&0==s.squote&&0==s.dquote)r+="{",s.braces+=1;else if("}"==e&&0==s.squote&&0==s.dquote)r+="}",s.braces-=1;else if('"'==e&&0==s.squote)s.dquote>0?i<l.length-1&&'"'==l[i+1]?(i++,r+=""):(s.dquote-=1,r+='"'):(s.dquote+=1,r+='"');else if("'"==e&&0==s.dquote)if(r+="'",s.squote>0){if(f==i-1)return"";if(i<l.length-1&&"'"==l[i+1])i++,r+="'";else{if("'"==l[i-1])return"";s.squote-=1}}else s.squote+=1,f=i;else if(","==e&&0==s.squote&&0==s.dquote&&0==s.braces)if(a.length<=1){let e=n.functionParser(r,t);e.indexOf("#lucky#")>-1&&(e=e.replace(/#lucky#/g,"")+")"),u+=e+",",r=""}else r+=",";else if(e in n.operatorjson&&0==s.squote&&0==s.dquote&&0==s.braces){let s="",f=n.operatorPriority;if(i+1<l.length&&(s=l[i+1]),e+s in n.operatorjson){if(0==a.length){if($.trim(r).length>0?o.unshift(n.functionParser($.trim(r),t)):$.trim(u).length>0&&o.unshift($.trim(u)),c[0]in n.operatorjson){let e=f[c[0]];for(;c.length>0&&null!=e;)o.unshift(c.shift()),e=f[c[0]]}c.unshift(e+s),u="",r=""}else r+=e+s;i++}else if(0==a.length){if($.trim(r).length>0?o.unshift(n.functionParser($.trim(r),t)):$.trim(u).length>0&&o.unshift($.trim(u)),c[0]in n.operatorjson){let t=f[c[0]];t=null==t?1e3:t;let n=f[e];for(n=null==n?1e3:n;c.length>0&&n>=t;)o.unshift(c.shift()),t=null==(t=f[c[0]])?1e3:t}c.unshift(e),u="",r=""}else r+=e}else 0==s.dquote&&s.squote,r+=e;if(i==l.length-1){let e="",l=$.trim(r).replace(/'/g,"\\'");if(n.iscelldata(l)&&":"!=l.substr(0,1))e="luckysheet_getcelldata('"+l+"')","function"==typeof t&&t(l);else if(":"==l.substr(0,1))l=l.substr(1),n.iscelldata(l)&&(e="luckysheet_getSpecialReference(false,"+u+",'"+l+"')");else{r=$.trim(r);let t=/{.*?}/;if(t.test(r)&&'"'!=r.substr(0,1)&&'"'!=r.substr(r.length-1,1)){let n=t.exec(r)[0],l=r.search(t);l>0&&(e+=r.substr(0,l)),e+="luckysheet_getarraydata('"+n+"')",l+n.length<r.length&&(e+=r.substr(l+n.length,r.length))}else e=r}if(e.length>0&&o.unshift(e),c.length>0)for(u.length>0&&(o.unshift(u),u="");c.length>0;)o.unshift(c.shift());o.length>0?u=n.calPostfixExpression(o):u+=e}i++}return u},insertUpdateDynamicArray:function(e){let t=e.r,n=e.c,l=e.index;null==l&&(l=h.currentSheetIndex);let i=_()[k(l)].dynamicArray;null==i&&(i=[]);for(let r=0;r<i.length;r++){let u=i[r];if(u.r==t&&u.c==n&&u.index==l)return u.data=e.data,u.f=e.f,i}return i.push(e),i},addFunctionGroup:function(e,t,n,l){null==l&&(l=h.currentSheetIndex);let i=_(),r=i[k(l)];null==r.calcChain&&(r.calcChain=[]);let u={r:e,c:t,index:l,func:n};r.calcChain.push(u),h.saveParam("fc",l,JSON.stringify(u),{op:"add",pos:r.calcChain.length-1}),F(i)},getAllFunctionGroup:function(){let e=_(),t=[];for(let n=0;n<e.length;n++){let l=e[n],i=l.calcChain;if(i){let e=[];i.forEach((t,n)=>{"string"==typeof t?e.push(JSON.parse(t)):e.push(t)}),i=l.calcChain=e}let r=l.dynamicArray_compute;null==i&&(i=[]),null==r&&(r=[]),t=t.concat(i);for(let e=0;e<r.length;e++){let e=r[0];t.push({r:e.r,c:e.c,index:e.index})}}return t},getFunctionGroup:function(e){null==e&&(e=h.currentSheetIndex);let t=_()[k(e)];return null==t.calcChain?[]:t.calcChain},updateFunctionGroup:function(e,t,n){null==n&&(n=h.currentSheetIndex);let l=_(),i=l[k(n)].calcChain;if(null!=i)for(let l=0;l<i.length;l++){let r=i[l];if(r.r==e&&r.c==t&&r.index==n){h.saveParam("fc",n,JSON.stringify(r),{op:"update",pos:l});break}}F(l)},insertUpdateFunctionGroup:function(e,t,n){null==n&&(n=h.currentSheetIndex);let l=_(),i=l[k(n)],r=i.calcChain;null==r&&(r=[]);for(let l=0;l<r.length;l++){let i=r[l];if(i.r==e&&i.c==t&&i.index==n)return void h.saveParam("fc",n,JSON.stringify(i),{op:"update",pos:l})}let u={r:e,c:t,index:n};r.push(u),i.calcChain=r,h.saveParam("fc",n,JSON.stringify(u),{op:"add",pos:i.calcChain.length-1}),F(l)},isFunctionRangeSave:!1,isFunctionRangeSimple:function(e,t,n,l,i){if(null==e||0==e.length)return;let r=e.split(/==|!=|<>|<=|>=|[,()=+-\/*%&^><]/g);if(r.length>0)for(let e=0;e<r.length;e++){let u=r[e];u.length<=1||('"'==u.substr(0,1)&&'"'==u.substr(u.length-1,1)||this.isFunctionRangeSaveChange(u,t,n,l,i))}},isFunctionRangeSimple1:function(e,t,n,l,i){let r=this;if(null==r.operatorjson){let e=r.operator.split("|"),t={};for(let n=0;n<e.length;n++)t[e[n].toString()]=1;r.operatorjson=t}"="==e.substr(0,1)&&(e=e.substr(1));let u=e.split(""),s=0,c="",o="",a={bracket:0,comma:0,squote:0,dquote:0};_();for(;s<u.length;){let e=u[s];if("("==e&&0==a.dquote)a.bracket+=1,c.length>0?o+="luckysheet_function."+c.toUpperCase()+".f(":o+="(",c="";else if(")"==e&&0==a.dquote)a.bracket-=1,o+=r.isFunctionRangeSimple(c,t,n,l,i)+")",c="";else if(","==e&&0==a.dquote)o+=r.isFunctionRangeSimple(c,t,n,l,i)+",",c="";else if(e in r.operatorjson&&0==a.dquote){let a="";s+1<u.length&&(a=u[s+1]),e+a in r.operatorjson?(c.length>0?(o+=r.isFunctionRangeSimple(c,t,n,l,i)+e+a,c=""):o+=e+a,s++):c.length>0?(o+=r.isFunctionRangeSimple(c,t,n,l,i)+e,c=""):o+=e}else c+=e;s==u.length-1&&r.iscelldata($.trim(c))&&r.isFunctionRangeSaveChange(c,t,n,l,i),s++}return o},isFunctionRangeSelect:function(e,t,n,l,i){if(null==e||""==e)return;null==l&&(l=h.currentSheetIndex),null==i&&(i={});let r=this,u=e.toUpperCase(),s=u.indexOf("INDIRECT(")>-1||u.indexOf("OFFSET(")>-1||u.indexOf("INDEX(")>-1;if(e in this.formulaContainCellList){let u=this.formulaContainCellList[e];if(s){if(1==u.__LuckyisOff__)for(let e in u)"__LuckyisOff__"!=e&&this.isFunctionRangeSaveChange(e,t,n,l,i);else this.isFunctionRange(e,t,n,l,i,function(t){r.addToCellList(e,t)}),u.__LuckyisOff__=!0}else for(let e in u)"__LuckyisOff__"!=e&&this.isFunctionRangeSaveChange(e,t,n,l,i)}else s?this.isFunctionRange(e,t,n,l,i):this.isFunctionRangeSimple(e,t,n,l,i)},isFunctionRange:function(e,t,n,l,i,r){let u=this;if(null==u.operatorjson){let e=u.operator.split("|"),t={};for(let n=0;n<e.length;n++)t[e[n].toString()]=1;u.operatorjson=t}"="==e.substr(0,1)&&(e=e.substr(1));let s=e.split(""),c=0,o="",a="",f={bracket:0,comma:0,squote:0,dquote:0,compare:0,braces:0},h=[],g=[],p=[],d=-1;for(;c<s.length;){let e=s[c];if("("==e&&0==f.squote&&0==f.dquote&&0==f.braces)if(o.length>0&&0==p.length){if((o=o.toUpperCase()).indexOf(":")>-1){let e=o.split(":");a+="luckysheet_getSpecialReference(true,'"+$.trim(e[0]).replace(/'/g,"\\'")+"', luckysheet_function."+e[1]+".f(#lucky#"}else a+="luckysheet_function."+o+".f(";p.push(1),o=""}else 0==p.length?(a+="(",p.push(0),o=""):(p.push(0),o+=e);else if(")"==e&&0==f.squote&&0==f.dquote&&0==f.braces){p.pop();if(0==p.length){let e=u.isFunctionRange(o,t,n,l,i,r);e.indexOf("#lucky#")>-1&&(e=e.replace(/#lucky#/g,"")+")"),a+=e+")",o=""}else o+=e}else if("{"==e&&0==f.squote&&0==f.dquote)o+="{",f.braces+=1;else if("}"==e&&0==f.squote&&0==f.dquote)o+="}",f.braces-=1;else if('"'==e&&0==f.squote)f.dquote>0?c<s.length-1&&'"'==s[c+1]?(c++,o+=""):(f.dquote-=1,o+='"'):(f.dquote+=1,o+='"');else if("'"==e&&0==f.dquote)o+="'",f.squote>0?c<s.length-1&&"'"==s[c+1]?(c++,o+="'"):f.squote-=1:(f.squote+=1,d=c);else if(","==e&&0==f.squote&&0==f.dquote&&0==f.braces)if(p.length<=1){let e=u.isFunctionRange(o,t,n,l,i,r);e.indexOf("#lucky#")>-1&&(e=e.replace(/#lucky#/g,"")+")"),a+=e+",",o=""}else o+=",";else if(e in u.operatorjson&&0==f.squote&&0==f.dquote&&0==f.braces){let f="",d=u.operatorPriority;if(c+1<s.length&&(f=s[c+1]),e+f in u.operatorjson){if(0==p.length){if($.trim(o).length>0?g.unshift(u.isFunctionRange($.trim(o),t,n,l,i,r)):$.trim(a).length>0&&g.unshift($.trim(a)),h[0]in u.operatorjson){let e=d[h[0]];for(;h.length>0&&null!=e;)g.unshift(h.shift()),e=d[h[0]]}h.unshift(e+f),a="",o=""}else o+=e+f;c++}else if(0==p.length){if($.trim(o).length>0?g.unshift(u.isFunctionRange($.trim(o),t,n,l,i,r)):$.trim(a).length>0&&g.unshift($.trim(a)),h[0]in u.operatorjson){let t=d[h[0]];t=null==t?1e3:t;let n=d[e];for(n=null==n?1e3:n;h.length>0&&n>=t;)g.unshift(h.shift()),t=null==(t=d[h[0]])?1e3:t}h.unshift(e),a="",o=""}else o+=e}else 0==f.dquote&&0==f.squote?o+=$.trim(e):o+=e;if(c==s.length-1){let e="",r=$.trim(o).replace(/'/g,"\\'");if(u.iscelldata(r)&&":"!=r.substr(0,1))e="luckysheet_getcelldata('"+r+"')",u.isFunctionRangeSaveChange(o,t,n,l,i);else if(":"==r.substr(0,1))r=r.substr(1),u.iscelldata(r)&&(e="luckysheet_getSpecialReference(false,"+a+",'"+r+"')");else{o=$.trim(o);let t=/{.*?}/;if(t.test(o)&&'"'!=o.substr(0,1)&&'"'!=o.substr(o.length-1,1)){let n=t.exec(o)[0],l=o.search(t);l>0&&(e+=o.substr(0,l)),e+="luckysheet_getarraydata('"+n+"')",l+n.length<o.length&&(e+=o.substr(l+n.length,o.length))}else e=o}if(e.length>0&&g.unshift(e),h.length>0)for(a.length>0&&(g.unshift(a),a="");h.length>0;)g.unshift(h.shift());g.length>0?a=u.calPostfixExpression(g):a+=e}c++}return u.checkSpecialFunctionRange(a,t,n,l,i,r),a},isFunctionRangeSaveChange:function(e,t,n,l,i){let r=this;if(null!=t&&null!=n){let u=r.getcellrange($.trim(e),l);if(null==u)return;let s=u.row,c=u.column,o=u.sheetIndex;if(t+"_"+n in i&&(l==o||null==l)){let e=!1;for(let l=s[0];l<=s[1];l++)for(let r=c[0];r<=c[1];r++)l+"_"+r in i&&i[l+"_"+r].r==t&&i[l+"_"+r].c==n&&(e=!0);r.isFunctionRangeSave=e?r.isFunctionRangeSave||!0:r.isFunctionRangeSave||!1}else t>=s[0]&&t<=s[1]&&n>=c[0]&&n<=c[1]&&(l==o||null==l)?r.isFunctionRangeSave=r.isFunctionRangeSave||!0:r.isFunctionRangeSave=r.isFunctionRangeSave||!1}else r.isFunctionRangeSave=r.isFunctionRangeSave||!1},checkSpecialFunctionRange:function(e,t,n,l,i,r){if("luckysheet_getSpecialReference"==e.substr(0,30)||"luckysheet_function."==e.substr(0,20)){if("luckysheet_function."==e.substr(0,20)){let t=e.split(".")[1];if(null!=t&&"INDIRECT"!=(t=t.toUpperCase())&&"OFFSET"!=t&&"INDEX"!=t)return}try{h.calculateSheetIndex=l;let t=new Function("return "+e)();t instanceof Object&&null!=t.startCell&&(t=t.startCell);let n=$.trim(t);this.iscelldata(n)&&"function"==typeof r&&r(n)}catch(e){}}},execvertex:{},execFunctionGroupData:null,execFunctionExist:null,formulaContainSheetList:{},formulaContainCellList:{},cellTextToIndexList:{},addToCellList:function(e,t){null!=e&&0!=e.length&&null!=t&&0!=t.length&&(null==this.formulaContainCellList&&(this.formulaContainCellList={}),null==this.formulaContainCellList[e]&&(this.formulaContainCellList[e]={}),this.formulaContainCellList[e][t]=1)},addToCellIndexList:function(e,t){null!=e&&0!=e.length&&null!=t&&(null==this.cellTextToIndexList&&(this.cellTextToIndexList={}),e.indexOf("!")>-1?(e=e.replace(/\\'/g,"'").replace(/''/g,"'"),this.cellTextToIndexList[e]=t):this.cellTextToIndexList[e+"_"+t.sheetIndex]=t)},addToSheetIndexList:function(e,t,n){null!=e&&0!=e.length&&(null!=t&&0!=t.length||(t=h.currentSheetIndex),null!=n&&0!=n.length||(n=""),null==this.formulaContainSheetList&&(this.formulaContainSheetList={}),null==this.formulaContainSheetList[e]&&(this.formulaContainSheetList[e]={}),this.formulaContainSheetList[e][t]=n)},execFunctionGlobalData:{},execFunctionGroupForce:function(e){e?this.execFunctionGroup(void 0,void 0,void 0,void 0,void 0,!0):this.execFunctionGroup()},execFunctionGroup:function(e,t,n,l,i,r=!1){let u=this;if(null==i&&(i=h.flowdata),window.luckysheet_compareWith||(window.luckysheet_compareWith=M,window.luckysheet_getarraydata=U,window.luckysheet_getcelldata=B,window.luckysheet_parseData=W,window.luckysheet_getValue=J,window.luckysheet_indirect_check=X,window.luckysheet_indirect_check_return=H,window.luckysheet_offset_check=K,window.luckysheet_calcADPMM=Q,window.luckysheet_getSpecialReference=Y),null==u.execFunctionGlobalData&&(u.execFunctionGlobalData={}),null==l&&(l=h.currentSheetIndex),null!=n){let i=[[{v:null}]];L(0,0,i,n),u.execFunctionGlobalData[e+"_"+t+"_"+l]=i[0][0]}let s=u.getAllFunctionGroup(),c={},o=_(),a={};for(let e=0;e<o.length;e++){let t=o[e];a[t.index]=t.data}let f={},g=[];if(null==u.execFunctionExist){f["r"+e+"c"+t+"i"+l]=1}else for(let e=0;e<u.execFunctionExist.length;e++){let t=u.execFunctionExist[e],n="r"+t.r+"c"+t.c+"i"+t.i;f[n]=1}let p={};for(let e=0;e<s.length;e++){let t=s[e],n="r"+t.r+"c"+t.c+"i"+t.index,l=N(t.r,t.c,t.index);if(null==l)continue;let i=l.toUpperCase(),r=[];if(i.indexOf("INDIRECT(")>-1||i.indexOf("OFFSET(")>-1||i.indexOf("INDEX(")>-1)this.isFunctionRange(l,null,null,t.index,null,function(e){let n=u.getcellrange($.trim(e),t.index);null!=n&&r.push(n)});else if('="'!=l.substr(0,2)||'"'!=l.substr(l.length-1,1)){let e=0,n=-1,i=-1,s=[],c=[],o=l.length;for(let t=0;t<o;t++){let r=l.charAt(t);"'"==r&&-1==i&&(-1==n?(e!=t&&s.push(...l.substring(e,t).split(/==|!=|<>|<=|>=|[,()=+-\/*%&\^><]/)),n=t,e=t):t<o-1&&"'"==l.charAt(t+1)?t++:(e=t+1,s.push(l.substring(n,e)),c.push(s.length-1),n=-1)),'"'==r&&-1==n&&(-1==i?(e!=t&&s.push(...l.substring(e,t).split(/==|!=|<>|<=|>=|[,()=+-\/*%&\^><]/)),i=t,e=t):t<o-1&&'"'==l.charAt(t+1)?t++:(e=t+1,s.push(l.substring(i,e)),i=-1))}e!=o&&s.push(...l.substring(e,o).split(/==|!=|<>|<=|>=|[,()=+-\/*%&\^><]/));for(let e=c.length-1;e>=0;e--)c[e]!=s.length-1&&(s[c[e]]=s[c[e]]+s[c[e]+1],s.splice(c[e]+1,1));for(let e=0;e<s.length;e++){let n=s[e];if(n.length<=1)continue;if('"'==n.substr(0,1)&&'"'==n.substr(n.length-1,1)&&!u.iscelldata(n))continue;let l=u.getcellrange($.trim(n),t.index);null!=l&&r.push(l)}}let o={formulaArray:r,calc_funcStr:l,key:n,r:t.r,c:t.c,index:t.index,parents:{},chidren:{},color:"w"};c[n]=o}Object.keys(c).forEach(e=>{let t=c[e];!function(e,t,n,l){for(let i=0;i<e.length;i++){let r=e[i],u="r"+r.row[0]+r.row[1]+"c"+r.column[0]+r.column[1]+"index"+r.sheetIndex;if(u in p)p[u].forEach(e=>{l(e.key,e.r,e.c,e.sheetIndex)});else{let e=[];for(let i=r.row[0];i<=r.row[1];i++)for(let u=r.column[0];u<=r.column[1];u++){let s="r"+i+"c"+u+"i"+r.sheetIndex;l(s,i,u,r.sheetIndex),(t&&s in t||n&&s in n)&&e.push({key:s,r:i,c:u,sheetIndex:r.sheetIndex})}(t||n)&&(p[u]=e)}}}(t.formulaArray,c,f,function(n){if(n in c){let l=c[n];t.chidren[n]=1,l.parents[e]=1}!r&&n in f&&g.push(t)}),r&&g.push(t)});let d=[],x=g,m={};for(;x.length>0;){let e=x.pop();if(null==e||e.key in m)continue;if("b"==e.color){d.push(e),m[e.key]=1;continue}let t=[];Object.keys(e.parents).forEach(e=>{let n=c[e];null!=n&&t.push(n)}),0,0==t.length?(d.push(e),m[e.key]=1):(e.color="b",x.push(e),x=x.concat(t))}d.reverse();for(let e=0;e<d.length;e++){let t=d[e];if(t.level==Math.max)continue;window.luckysheet_getcelldata_cache=null;let n=t.calc_funcStr,l=u.execfunction(n,t.r,t.c,t.index);u.groupValuesRefreshData.push({r:t.r,c:t.c,v:l[1],f:l[2],spe:l[3],index:t.index}),u.execFunctionGlobalData[t.r+"_"+t.c+"_"+t.index]={v:l[1],f:l[2]}}u.execFunctionExist=null},execFunctionGroup1:function(e,t,n,l,i,r=!1){let u=this;null==i&&(i=h.flowdata),window.luckysheet_compareWith||(window.luckysheet_compareWith=M,window.luckysheet_getarraydata=U,window.luckysheet_getcelldata=B,window.luckysheet_parseData=W,window.luckysheet_getValue=J,window.luckysheet_indirect_check=X,window.luckysheet_indirect_check_return=H,window.luckysheet_offset_check=K,window.luckysheet_calcADPMM=Q,window.luckysheet_getSpecialReference=Y),null==u.execFunctionGlobalData&&(u.execFunctionGlobalData={});let s=_(),c=null==s[k(h.currentSheetIndex)].dynamicArray_compute?{}:s[k(h.currentSheetIndex)].dynamicArray_compute;if(null==l&&(l=h.currentSheetIndex),null!=n){let i=[[{v:null}]];L(0,0,i,n),u.execFunctionGlobalData[e+"_"+t+"_"+l]=i[0][0]}let o=u.getAllFunctionGroup(),a={},f=[],g=0;if(u.execvertex={},null==u.execFunctionExist)for(let n=0;n<o.length;n++){let i=o[n],h=s[k(i.index)];if(null==h)continue;let p=h.data[i.r][i.c],d=N(i.r,i.c,i.index);null!=p&&null!=p.f&&p.f==d&&(i instanceof Object||(i=new Function("return "+i)()),i.color="w",i.parent=null,i.chidren={},i.times=0,a["r"+i.r+"c"+i.c+"i"+i.index]=i,u.isFunctionRangeSave=!1,r?u.isFunctionRangeSave=!0:null!=e&&null!=t&&u.isFunctionRangeSelect(d,e,t,l,c),u.isFunctionRangeSave&&(f.push(i),u.execvertex["r"+i.r+"c"+i.c+"i"+i.index]=i,g++))}else for(let e=0;e<u.execFunctionExist.length;e++){let t=u.execFunctionExist[e];if(!("r"+t.r+"c"+t.c+"i"+t.i in a))for(let e=0;e<o.length;e++){let n=o[e],l=N(n.r,n.c,n.index);n.color="w",n.parent=null,n.chidren={},n.times=0,a["r"+n.r+"c"+n.c+"i"+n.index]=n,u.isFunctionRangeSave=!1,r?u.isFunctionRangeSave=!0:u.isFunctionRangeSelect(l,t.r,t.c,t.i,c),u.isFunctionRangeSave&&(f.push(n),u.execvertex["r"+n.r+"c"+n.c+"i"+n.index]=n,g++)}}for(;f.length>0;){let e=f.shift(),t={};u.getChildrenVertex(e,a,t);for(let n in a){let l=a[n];if(null==l)continue;let i="r"+e.r+"c"+e.c+"i"+e.index;if(n in t)continue;u.isFunctionRangeSave=!1;let r=N(l.r,l.c,l.index);u.isFunctionRangeSelect(r,e.r,e.c,e.index,c),u.isFunctionRangeSave&&(n in u.execvertex||(f.push(l),u.execvertex[n]=l),g++,u.execvertex[n].chidren[i]=1)}}u.groupValuesRefreshData=[];let p=0;for(;p<g;)for(let e in u.execvertex){let t=u.execvertex[e];"w"==t.color?u.functionDFS(t):"b"==t.color&&p++}u.execFunctionExist=null},getChildrenVertex:function(e,t,n){if(n["r"+e.r+"c"+e.c+"i"+e.index]=1,null!=e.chidren)for(let l in e.chidren)!t[l]||l in n||this.getChildrenVertex(t[l],t,n)},functionDFS:function(e){let t=this;e.color="g",e.times+=1;for(let n in e.chidren){let l=t.execvertex[n];"w"==l.color&&(l.parent="r"+e.r.toString()+"c"+e.c.toString()+"i"+e.index,t.functionDFS(l))}e.color="b",window.luckysheet_getcelldata_cache=null;let n=N(e.r,e.c,e.index),l=t.execfunction(n,e.r,e.c,e.index);t.groupValuesRefreshData.push({r:e.r,c:e.c,v:l[1],f:l[2],spe:l[3],index:e.index}),t.execFunctionGlobalData[e.r+"_"+e.c+"_"+e.index]={v:l[1],f:l[2]}},groupValuesRefreshData:[],groupValuesRefresh:function(){let e=this,t=_();if(e.groupValuesRefreshData.length>0){for(let n=0;n<e.groupValuesRefreshData.length;n++){let l=e.groupValuesRefreshData[n],i=t[k(l.index)],r=i.data;if(null==r)continue;let u={};null!=l.spe&&("sparklines"==l.spe.type?u.spl=l.spe.data:"dynamicArrayItem"==l.spe.type&&(i.dynamicArray=e.insertUpdateDynamicArray(l.spe.data))),u.v=l.v,u.f=l.f,L(l.r,l.c,r,u),h.saveParam("v",l.index,l.v,{r:l.r,c:l.c})}h.webWorkerFlowDataCache(h.flowdata),e.groupValuesRefreshData=[]}},delFunctionGroup:function(e,t,n){null==n&&(n=h.currentSheetIndex);let l=_(),i=l[k(n)],r=i.calcChain;if(null!=r)for(let l=0;l<r.length;l++){let i=r[l];if(i.r==e&&i.c==t&&i.index==n){r.splice(l,1),h.saveParam("fc",n,null,{op:"del",pos:l});break}}let u=i.dynamicArray;if(null!=u)for(let l=0;l<u.length;l++){let i=u[l];if(i.r==e&&i.c==t&&(null==i.index||i.index==n)){u.splice(l,1),h.saveParam("ac",n,null,{op:"del",pos:l});break}}F(l)},execfunction:function(e,t,n,l,i,r){let u=this,s=g().formulaMore;if(e.indexOf(u.error.r)>-1)return[!1,u.error.r,e];u.checkBracketNum(e)||(e+=")"),null==l&&(l=h.currentSheetIndex),h.calculateSheetIndex=l;let c=$.trim(u.functionParserExe(e));if("luckysheet_function."!=c.substr(0,20)&&"luckysheet_compareWith"!=c.substr(0,22)||(u.functionHTMLIndex=0),!u.testFunction(e,c)||""==c)return tooltip.info("",s.execfunctionError),[!1,u.error.n,e];let o=null;window.luckysheetCurrentRow=t,window.luckysheetCurrentColumn=n,window.luckysheetCurrentIndex=l,window.luckysheetCurrentFunction=e;let a=null;try{if(c.indexOf("luckysheet_getcelldata")>-1){let l=c.split("luckysheet_getcelldata('");for(let i=1;i<l.length;i++){let r=l[i].split("')")[0],c=u.getcellrange(r);if(c.row[0]<0||c.column[0]<0)return[!0,u.error.r,e];if(c.sheetIndex==h.calculateSheetIndex&&t>=c.row[0]&&t<=c.row[1]&&n>=c.column[0]&&n<=c.column[1])return R()?alert(s.execfunctionSelfError):tooltip.info("",s.execfunctionSelfErrorResult),[!1,0,e]}}"string"==typeof(o=new Function("return "+c)())&&(o=o.replace(/\x7F/g,'"')),c.indexOf("SPLINES")>-1&&(a=o,o="")}catch(e){let t=e;console.log(e,c),t=u.errorInfo(t),o=[u.error.n,t]}"object"==x(o)&&null!=o.startCell&&(o="array"==x(o.data)?u.error.v:"object"!=x(o.data)||v(o.data.v)?v(o.data)?0:o.cell>1||o.rowl>1?o.data:0:o.data.v);let f=null;if("array"==x(o)){let i=!1;"array"!=x(o[0])&&2==o.length&&(i=C(o[0])),i?o=o[0]:"array"==x(o[0])&&1==o.length&&1==o[0].length?o=o[0][0]:(f={r:t,c:n,f:e,index:l,data:o},o="")}return window.luckysheetCurrentRow=null,window.luckysheetCurrentColumn=null,window.luckysheetCurrentIndex=null,window.luckysheetCurrentFunction=null,null!=t&&null!=n&&(i&&u.execFunctionGroup(t,n,o,l),r||u.insertUpdateFunctionGroup(t,n,l)),a?[!0,o,e,{type:"sparklines",data:a}]:f?[!0,o,e,{type:"dynamicArrayItem",data:f}]:[!0,o,e]},testFunction:function(e,t){return"="==e.substr(0,1)},execstringformula:function(e,t,n,l){return this.execfunction(e,t,n,l)},functionResizeData:{},functionResizeStatus:!1,functionResizeTimeout:null,data_parm_index:0}});
//# sourceMappingURL=../sourcemaps/methods/formula_methods.js.map
