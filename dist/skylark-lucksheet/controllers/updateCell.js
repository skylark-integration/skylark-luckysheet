/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../methods/pivotTable_methods","../methods/cells","../methods/conditionformat_methods","../methods/alternateformat_methods","../widgets/cellDatePickerCtrl","../widgets/dataVerificationCtrl","../methods/protection_methods","../utils/util","../methods/luckysheetConfigsetting","../methods/getdata","../methods/format","../methods/formula_methods","../widgets/cursorPos","../widgets/cleargridelement","../store"],function(e,t,i,l,o,r,a,n,h,c,s,u,d,g,m){"use strict";const{checkProtectionLocked:f,checkProtectionCellHidden:w}=a,{chatatABC:b}=n,{isEditMode:x}=h,{getcellvalue:p,getInlineStringStyle:y}=c,{valueShowEs:k}=s,{luckysheetRangeLast:H}=d,{isInlineStringCell:v}=t;function _(e,i,l){let o=m.visibledatarow[e],r=e-1==-1?0:m.visibledatarow[e-1],a=m.visibledatacolumn[i],n=i-1==-1?0:m.visibledatacolumn[i-1];null==l&&(l=m.flowdata);let h=t.mergeborer(l,e,i);return h&&(o=h.row[1],r=h.row[0],e=h.row[2],a=h.column[1],n=h.column[0],i=h.column[2]),{row:o,row_pre:r,row_index:e,col:a,col_pre:n,col_index:i}}return{luckysheetupdateCell:function(a,n,c,s,d){if(!f(a,n,m.currentSheetIndex))return void $("#luckysheet-functionbox-cell").blur();if(x()||!1===m.allowEdit)return;if(h.createHookFunction("cellEditBefore",m.luckysheet_select_save),m.saveParam("mv",m.currentSheetIndex,{op:"enterEdit",range:m.luckysheet_select_save}),null!=m.dataVerification&&null!=m.dataVerification[a+"_"+n]){let e=m.dataVerification[a+"_"+n];if("dropdown"==e.type)r.dropdownListShow();else if("checkbox"==e.type)return}let C=_(a,n,c),z=C.row,S=C.row_pre,R=C.col,B=C.col_pre,I=C.row_index,P=C.col_index;$("#luckysheet-dropCell-icon").is(":visible")&&$("#luckysheet-dropCell-icon").remove();let T=$(window).height(),W=$(window).width(),E=$("#"+m.container).offset(),L=$("#luckysheet-cell-main").scrollLeft(),A=$("#luckysheet-cell-main").scrollTop();if(e.isPivotRange(I,P))return;let F=B+E.left+m.rowHeaderWidth-L-2;null!=m.freezenverticaldata&&n<=m.freezenverticaldata[1]&&(F=B+E.left+m.rowHeaderWidth-2);let V=S+E.top+m.infobarHeight+m.toolbarHeight+m.calculatebarHeight+m.columnHeaderHeight-A-2;null!=m.freezenhorizontaldata&&a<=m.freezenhorizontaldata[1]&&(V=S+E.top+m.infobarHeight+m.toolbarHeight+m.calculatebarHeight+m.columnHeaderHeight-2);let M={"min-width":R-B+1-8,"min-height":z-S+1-4,"max-width":W+L-B-20-m.rowHeaderWidth,"max-height":T+A-S-20-15-m.toolbarHeight-m.infobarHeight-m.calculatebarHeight-m.sheetBarHeight-m.statisticBarHeight,left:F,top:V},q={transform:"scale("+m.zoomRatio+")","transform-origin":"left top",width:100/m.zoomRatio+"%",height:100/m.zoomRatio+"%"};m.luckysheetCellUpdate=[I,P],d||$("#luckysheet-rich-text-editor").focus().select(),$("#luckysheet-input-box").removeAttr("style").css({"background-color":"rgb(255, 255, 255)",padding:"0px 2px","font-size":"13px",right:"auto","overflow-y":"auto","box-sizing":"initial",display:"flex"}),null==m.freezenverticaldata&&null==m.freezenhorizontaldata||$("#luckysheet-input-box").css("z-index",10002),$("#luckysheet-input-box-index").html(b(P)+(I+1)).hide(),$("#luckysheet-wa-functionbox-cancel, #luckysheet-wa-functionbox-confirm").addClass("luckysheet-wa-calculate-active");let D="",U=!1;if(null!=c[I]&&null!=c[I][P]){let e=c[I][P],i=e.ht,l="left",o="top";"0"==i?(M={"min-width":R-B+1-8,"min-height":z-S+1-4,"max-width":2*W/3,"max-height":T+A-S-20-15-m.toolbarHeight-m.infobarHeight-m.calculatebarHeight-m.sheetBarHeight-m.statisticBarHeight,left:B+E.left+m.rowHeaderWidth-L-2,top:S+E.top+m.infobarHeight+m.toolbarHeight+m.calculatebarHeight+m.columnHeaderHeight-A-2},m.zoomRatio<1&&(l="center"),U=!0):"2"==i&&(M={"min-width":R-B+1-8,"min-height":z-S+1-4,"max-width":R+E.left-L-8,"max-height":T+A-S-20-15-m.toolbarHeight-m.infobarHeight-m.calculatebarHeight-m.sheetBarHeight-m.statisticBarHeight,right:W-(E.left+(m.rowHeaderWidth-1)-L)-R,top:S+E.top+m.infobarHeight+m.toolbarHeight+m.calculatebarHeight+m.columnHeaderHeight-A-2},m.zoomRatio<1&&(l="right")),"0"==e.vt?o="center":"2"==e.vt&&(o="bottom"),q["transform-origin"]=l+" "+o,s||(v(e)?D=y(I,P,c):null!=e.f?D=p(I,P,c,"f"):(D=k(I,P,c),"1"==e.qp&&(D="'"+D)));let r=t.getStyleByCell(c,I,P);r=$("#luckysheet-input-box").get(0).style.cssText+r,$("#luckysheet-input-box").get(0).style.cssText=r,"rgba(0, 0, 0, 0)"==$("#luckysheet-input-box").get(0).style.backgroundColor&&($("#luckysheet-input-box").get(0).style.background="rgb(255,255,255)")}else{let e=l.getComputeMap();var j=l.checksAF(I,P,e),G=i.getComputeMap(),J=i.checksCF(I,P,G);null!=J&&null!=J.cellColor?$("#luckysheet-input-box").get(0).style.background=J.cellColor:null!=j&&($("#luckysheet-input-box").get(0).style.background=j[1])}if(M["min-height"]>M["max-height"]&&(M["min-height"]=M["max-height"]),M["min-width"]>M["max-width"]&&(M["min-width"]=M["max-width"]),null!=D&&""!=D.toString()||s||(D="<br/>"),!w(I,P,m.currentSheetIndex)&&D.length>0&&'<span dir="auto" class="luckysheet-formula-text-color">=</span>'==D.substr(0,63)?$("#luckysheet-rich-text-editor").html(""):($("#luckysheet-rich-text-editor").html(D),d||H($("#luckysheet-rich-text-editor")[0])),U){let e=$("#luckysheet-input-box").width();e>M["max-width"]&&(e=M["max-width"]),e<M["min-width"]&&(e=M["min-width"]);let t=M.left-e/2+(R-B)/2;t<2&&(t=2),M.left=t-2}$("#luckysheet-input-box").css(M),$("#luckysheet-rich-text-editor").css(q),c[a][n]&&c[a][n].ct&&"d"==c[a][n].ct.t&&o.cellFocus(a,n,c[a][n]),u.rangetosheet=m.currentSheetIndex,u.createRangeHightlight(),u.rangeResizeTo=$("#luckysheet-rich-text-editor"),g()},setCenterInputPosition:function(e,t,i){if(null==e||null==t)return;let l=i[e][t];if(null==l)return;let o=l.ht;if(null!=l&&"0"!=o)return;let r=_(e,t,i),a=(r.row,r.row_pre,r.col),n=r.col_pre,h=($(window).height(),$(window).width()),c=$("#"+m.container).offset(),s=$("#luckysheet-cell-main").scrollLeft(),u=($("#luckysheet-cell-main").scrollTop(),{"min-width":a-n+1-8,"max-width":2*h/3,left:n+c.left+m.rowHeaderWidth-s-2}),d=$("#luckysheet-input-box").width();d>u["max-width"]&&(d=u["max-width"]),d<u["min-width"]&&(d=u["min-width"]);let g=u.left-d/2+(a-n)/2;g<2&&(g=2),u.left=g-2,$("#luckysheet-input-box").css(u)},getColumnAndRowSize:_}});
//# sourceMappingURL=../sourcemaps/controllers/updateCell.js.map
