/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../global/validate","../global/cleargridelement","../global/getdata","../global/setdata","../global/createdom","../global/tooltip","../global/formula","../global/refresh","../global/rhchInit","../global/editor","../global/extend","../utils/util","./constant","./server","./luckysheetConfigsetting","./pivotTable","./resize","./postil","./imageCtrl","./dataVerificationCtrl","./hyperlinkCtrl","./freezen","./filter","./select","../store","../locale/locale","../expendPlugins/chart/plugin","./resize","./zoom","./menuButton","../global/method"],function(e,t,l,n,s,i,h,c,r,o,a,u,d,f,y,g,k,m,x,S,p,v,b,w,_,I,C,T,L,P,z){"use strict";const{isEditMode:F,isRealNum:O}=e,{getcellvalue:R,datagridgrowth:H,getcellFormula:N}=l,{setcellvalue:A}=n,{luckysheetrefreshgrid:D,jfrefreshgrid_rhcw:j}=c,{luckysheetextendtable:G,luckysheetdeletetable:M}=a,{replaceHtml:W,getObjType:B,chatatABC:E,arrayRemoveItem:q}=u,{sheetHTML:K,luckysheetlodingHTML:J}=d,{createFilterOptions:U,labelFilterOptionState:V}=b,{selectHightlightShow:Z,selectionCopyShow:Q}=w,{renderChartShow:X}=C,{changeSheetContainerSize:Y,menuToolBarWidth:ee}=T,{zoomNumberDomBind:te}=L;return{generateRandomSheetIndex:function(e){null==e&&(e="Sheet");let t=window.navigator.userAgent.replace(/[^a-zA-Z0-9]/g,"").split(""),l="";for(let e=0;e<12;e++)l+=t[Math.round(Math.random()*(t.length-1))];return e+"_"+l+"_"+(new Date).getTime()},generateRandomSheetName:function(e,t){let l=e.length;const n=I().pivotTable.title;for(let t=0;t<e.length;t++)if(e[t].name.indexOf("Sheet")>-1||e[t].name.indexOf(n)>-1){let s=parseFloat(e[t].name.replace("Sheet","").replace(n,""));"NaN"!=s&&Math.ceil(s)>l&&(l=Math.ceil(s))}return t?n+(l+1):"Sheet"+(l+1)},generateCopySheetName:function(e,t){let l="",n=I().info;if(t.toString().indexOf("("+n.copy)>-1){let s=t.toString().indexOf("("+n.copy),i=t.toString().substring(0,s)+"("+n.copy,h=null;for(let t=0;t<e.length;t++){let l=e[t].name.toString(),n=l.indexOf(i);if(n>-1){let e=l.indexOf(")",n+i.length),t=l.substring(n+i.length,e);O(t)&&(null==h||parseInt(t)>h)&&(h=parseInt(t))}}l=null==h?i+"2)":i+ ++h+")"}else{let s=null,i=!1,h=t+"("+n.copy;for(let t=0;t<e.length;t++){let l=e[t].name.toString(),n=l.indexOf(h);if(n>-1){i=!0;let e=l.indexOf(")",n+h.length),t=l.substring(n+h.length,e);O(t)&&(null==s||parseInt(t)>s)&&(s=parseInt(t))}}i?null==s?l=t+"("+n.copy+"2)":(s++,l=t+"("+n.copy+s+")"):l=t+"("+n.copy+")"}return l},getSheetByIndex:function(e){null==e&&(e=_.currentSheetIndex);let t=this.getSheetIndex(e);return _.luckysheetfile[t]},getSheetByName:function(e){if(null==e)return null;for(let t=0;t<_.luckysheetfile.length;t++){let l=_.luckysheetfile[t];if(l.name==e)return l}return null},getCurSheetnoset:function(){let e=0;for(let t=0;t<_.luckysheetfile.length;t++)if(1==_.luckysheetfile[t].status){e=_.luckysheetfile[t].index;break}return e},getCurSheet:function(){if(_.luckysheetfile.length){let e=!1,t=[];_.luckysheetfile.forEach(l=>{void 0===l.index&&(l.index=this.generateRandomSheetIndex()),t.includes(l.index)?l.index=this.generateRandomSheetIndex():t.push(l.index),void 0===l.status&&(l.status=0),1==l.status&&(e?l.status=0:e=!0)}),e||(_.luckysheetfile[0].status=1)}_.currentSheetIndex=_.luckysheetfile[0].index;for(let e=0;e<_.luckysheetfile.length;e++)if(1==_.luckysheetfile[e].status){_.currentSheetIndex=_.luckysheetfile[e].index;break}return _.currentSheetIndex},addNewSheet:function(e,l){if(F()||!1===_.allowEdit)return;let n=_.luckysheetfile.length,s=this.generateRandomSheetIndex(),i=this.generateRandomSheetName(_.luckysheetfile,l);$("#luckysheet-sheet-container-c").append(W(K,{index:s,active:"",name:i,style:"",colorset:""}));let h={name:i,color:"",status:"0",order:n,index:s,celldata:[],row:_.defaultrowNum,column:_.defaultcolumnNum,config:{},pivotTable:null,isPivotTable:!!l};if(_.luckysheetfile.push(h),$("#luckysheet-sheet-area div.luckysheet-sheets-item").removeClass("luckysheet-sheets-item-active"),$("#luckysheet-sheets-item"+s).addClass("luckysheet-sheets-item-active"),$("#luckysheet-cell-main").append('<div id="luckysheet-datavisual-selection-set-'+s+'" class="luckysheet-datavisual-selection-set"></div>'),t(e),f.saveParam("sha",null,$.extend(!0,{},h)),_.clearjfundo){_.jfundo.length=0;let e={type:"addSheet"};e.sheetconfig=$.extend(!0,{},h),e.index=s,e.currentSheetIndex=_.currentSheetIndex,_.jfredo.push(e)}this.changeSheetExec(s,l,!0)},setSheetHide:function(e){let t=this.getSheetIndex(e);_.luckysheetfile[t].hide=1;let l,n=$("#luckysheet-sheets-item"+e);if(n.hide(),$("#luckysheet-sheet-area div.luckysheet-sheets-item").removeClass("luckysheet-sheets-item-active"),y.showsheetbarConfig.sheet)l=n.nextAll(":visible"),l=n.nextAll(":visible").length>0?l.eq(0).data("index"):n.prevAll(":visible").eq(0).data("index");else{let e,n=[];_.luckysheetfile.forEach((e,t)=>{1!==e.hide&&n.push(t)});let s=n.length;e=1===s?n[0]:n[s-1]>t?n.find(e=>e>t):n[s-1],l=_.luckysheetfile[e].index}$("#luckysheet-sheets-item"+l).addClass("luckysheet-sheets-item-active"),this.changeSheetExec(l),f.saveParam("sh",n.data("index"),1,{op:"hide",cur:l})},setSheetShow:function(e){_.luckysheetfile[this.getSheetIndex(e)].hide=0,this.changeSheetExec(e),f.saveParam("sh",e,0,{op:"show",cur:null})},sheetMaxIndex:0,ordersheet:function(e){return function(t,l){return t[e]-l[e]}},getCurrentOrder:function(){let e={};return $("#luckysheet-sheet-area div.luckysheet-sheets-item").each(function(t){let l=$(this).data("index");for(let n=0;n<_.luckysheetfile.length;n++)if(_.luckysheetfile[n].index==l){e[l.toString()]=t;break}}),e},reOrderAllSheet:function(){let e={};$("#luckysheet-sheet-area div.luckysheet-sheets-item").each(function(t){let l=$(this).data("index");for(let n=0;n<_.luckysheetfile.length;n++)if(_.luckysheetfile[n].index==l){_.luckysheetfile[n].order=t,e[l.toString()]=t;break}}),f.saveParam("shr",null,e),_.luckysheetfile.sort((e,t)=>{let l=e.order,n=t.order;return null!=l&&null!=n?l-n:null!=l?-1:1})},createSheet:function(){let e=[];_.luckysheetfile.sort(this.ordersheet("order"));for(let t=0;t<_.luckysheetfile.length;t++){let l="",n=_.luckysheetfile[t].index,s="";null!=_.luckysheetfile[t].color&&(s='<div class="luckysheet-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: '+_.luckysheetfile[t].color+';"></div>'),_.currentSheetIndex==n?e.push(W(K,{index:n,active:"luckysheet-sheets-item-active",name:_.luckysheetfile[t].name,style:"",colorset:s})):(1==_.luckysheetfile[t].hide?e.push(W(K,{index:n,active:"",name:_.luckysheetfile[t].name,style:"display:none;",colorset:s})):e.push(W(K,{index:n,active:"",name:_.luckysheetfile[t].name,style:"",colorset:s})),l="style='display:none;'"),$("#luckysheet-cell-main").append("<div "+l+' id="luckysheet-datavisual-selection-set-'+n+'" class="luckysheet-datavisual-selection-set"></div>')}$("#luckysheet-sheet-container-c").append(e.join("")),this.locationSheet()},locationSheet:function(){let e=$("#luckysheet-sheet-container-c"),t=$("#"+_.container).width(),l=($("#luckysheet-sheet-container-c > div.luckysheet-sheets-item-active").eq(0),0),n=0;$("#luckysheet-sheet-container-c > div.luckysheet-sheets-item:visible").each(function(){$(this).hasClass("luckysheet-sheets-item-active")&&(l=n),n+=$(this).outerWidth()}),setTimeout(function(){e.scrollLeft(l-10),n>=.7*t&&y.showsheetbarConfig.sheet&&($("#luckysheet-sheet-area .luckysheet-sheets-scroll").css("display","inline-block"),$("#luckysheet-sheet-container .docs-sheet-fade-left").show())},1)},copySheet:function(e,l){if(F()||!1===_.allowEdit)return;let n=_.luckysheetfile.length,s=this.generateRandomSheetIndex(),i=this.getSheetIndex(e),h=$.extend(!0,{},_.luckysheetfile[i]);h.order=n,h.index=s,h.name=this.generateCopySheetName(_.luckysheetfile,h.name);let c="";null!=h.color&&(c='<div class="luckysheet-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: '+h.color+';"></div>');let r=$("#luckysheet-sheets-item"+e);if($("#luckysheet-sheet-container-c").append(W(K,{index:h.index,active:"",name:h.name,order:h.order,style:"",colorset:c})),$("#luckysheet-sheets-item"+h.index).insertAfter(r),_.luckysheetfile.splice(i+1,0,h),$("#luckysheet-sheet-area div.luckysheet-sheets-item").removeClass("luckysheet-sheets-item-active"),$("#luckysheet-sheets-item"+s).addClass("luckysheet-sheets-item-active"),$("#luckysheet-cell-main").append('<div id="luckysheet-datavisual-selection-set-'+s+'" class="luckysheet-datavisual-selection-set"></div>'),t(l),f.saveParam("shc",s,{copyindex:e,name:h.name}),this.changeSheetExec(s),this.reOrderAllSheet(),_.clearjfundo)_.jfredo.push({type:"copySheet",copyindex:e,index:h.index,sheetIndex:h.index});else if(_.jfredo.length>0){let e=_.jfredo[_.jfredo.length-1];"copySheet"==e.type&&(e.index=h.index,e.sheetIndex=h.index)}},hasSheet:function(e){return null!=e&&null!=(e=this.getSheetIndex(e))},createSheetbydata:function(e,l,n=!0){let s="";if(null!=e.color&&(s='<div class="luckysheet-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: '+e.color+';"></div>'),$("#luckysheet-sheet-container-c").append(W(K,{index:e.index,active:"",name:e.name,order:e.order,style:"",colorset:s})),n){let t=e.order;t>=_.luckysheetfile.length?(t=_.luckysheetfile.length-1,$("#luckysheet-sheets-item"+e.index).insertAfter($("#luckysheet-sheets-item"+_.luckysheetfile[t].index))):$("#luckysheet-sheets-item"+e.index).insertBefore($("#luckysheet-sheets-item"+_.luckysheetfile[t].index))}_.luckysheetfile.push(e),$("#luckysheet-sheet-area div.luckysheet-sheets-item").removeClass("luckysheet-sheets-item-active"),$("#luckysheet-sheets-item"+e.index).addClass("luckysheet-sheets-item-active"),$("#luckysheet-cell-main").append('<div id="luckysheet-datavisual-selection-set-'+e.index+'" class="luckysheet-datavisual-selection-set"></div>'),t(),null!=l?(f.saveParam("shre",null,{reIndex:e.index}),e.hide=0,f.saveParam("sh",e.index,0,{op:"show",cur:null})):f.saveParam("sha",null,e),this.changeSheetExec(e.index,e.isPivotTable,!0),this.reOrderAllSheet()},deleteSheet:function(e){if(!1===_.allowEdit)return;let t=this.getSheetIndex(e);this.setSheetHide(e),$("#luckysheet-sheets-item"+e).remove(),$("#luckysheet-datavisual-selection-set-"+e).remove();let l=_.luckysheetfile.splice(t,1);this.reOrderAllSheet(),f.saveParam("shd",null,{deleIndex:e}),_.clearjfundo&&(l[0].type="deleteSheet",_.jfredo.push(l[0]))},nulldata:null,getGridData:function(e){let t=[];for(let l=0;l<e.length;l++)for(let n=0;n<e[0].length;n++)null!=e[l][n]&&t.push({r:l,c:n,v:e[l][n]});return t},buildGridData:function(e){let t=null==e.row?_.defaultrowNum:e.row,l=null==e.column?_.defaultcolumnNum:e.column,n=e.data&&e.data.length>0?e.data:H([],t,l),s=e.celldata;if(e.data&&e.data.length>0)for(let e=0;e<n.length;e++)for(let t=0;t<n[0].length;t++)A(e,t,n,n[e][t]);else if(s&&s.length>0)for(let e=0;e<s.length;e++){let t=s[e],l=t.r,i=t.c,h=t.v;l>=n.length&&(n=H(n,l-n.length+1,0)),i>=n[0].length&&(n=H(n,0,i-n[0].length+1)),A(l,i,n,h)}return y.autoFormatw=!1,y.accuracy=void 0,n},cutGridData:function(e){let t=0;for(let l=e.length-1;l>=0;l--){let n=!0;for(let t=0;t<e[0].length;t++){let e=R(l,t);if(null!=e&&$.trim(e).length>0){n=!1;break}}if(!n)break;t=l}return e.slice(0,t)},addGridData:function(e,t,l){let n=H([],t,l);if(null!=e)for(let t=0;t<e.length;t++){let l=e[t],s=l.r,i=l.c,h=l.v;s>=n.length&&(n=H(n,s-n.length+1,0)),i>=n[0].length&&(n=H(n,0,i-n[0].length+1)),A(s,i,n,h)}return n},sheetParamRestore:function(e,t){if(_.luckysheet_select_save=e.luckysheet_select_save,null!=_.luckysheet_select_save&&0!=_.luckysheet_select_save.length||(null!=t[0]&&null!=t[0][0]&&null!=t[0][0].mc?_.luckysheet_select_save=[{row:[0,t[0][0].mc.rs-1],column:[0,t[0][0].mc.cs-1]}]:_.luckysheet_select_save=[{row:[0,0],column:[0,0]}]),_.luckysheet_selection_range=null==e.luckysheet_selection_range?[]:e.luckysheet_selection_range,_.config=null==e.config?{}:e.config,_.zoomRatio=null==e.zoomRatio?1:e.zoomRatio,null!=e.defaultRowHeight?_.defaultrowlen=parseFloat(e.defaultRowHeight):_.defaultrowlen=y.defaultRowHeight,null!=e.defaultColWidth?_.defaultcollen=parseFloat(e.defaultColWidth):_.defaultcollen=y.defaultColWidth,null!=e.showGridLines){let t=e.showGridLines;_.showGridLines=0!=t&&0!=t}else _.showGridLines=!0},initialjfFile:function(e,t){let l=this;l.getCurSheet();let n=_.luckysheetfile[l.getSheetIndex(_.currentSheetIndex)];l.nulldata=H([],_.defaultrowNum,_.defaultcolumnNum);let c=l.buildGridData(n),r=[];n.jfgird_select_save=n.jfgird_select_save||[],n.jfgird_select_save.forEach(e=>r.push({row:e.row,column:e.column})),n.luckysheet_select_save=r,this.sheetParamRestore(n,c);let o=_.luckysheet_select_save[0].row[1],a=_.luckysheet_select_save[0].column[1];if(_.luckysheet_select_save.length>1)for(let e=0;e<_.luckysheet_select_save.length;e++)_.luckysheet_select_save[e].row[1]>o&&(o=_.luckysheet_select_save[e].row[1]),_.luckysheet_select_save[e].column[1]>a&&(a=_.luckysheet_select_save[e].column[1]);P.fontInitial(_.fontList),n.data=c;let u=c.length;o>u-1&&(u=o+1);let d=c[0].length;a>d-1&&(d=a+1),"function"==typeof y.beforeCreateDom&&y.beforeCreateDom(luckysheet),"function"==typeof y.workbookCreateBefore&&y.workbookCreateBefore(luckysheet),s(d,u,c,e,t),setTimeout(function(){i.createHoverTip("#luckysheet_info_detail",".luckysheet_info_detail_back, .luckysheet_info_detail_input, .luckysheet_info_detail_update"),i.createHoverTip("#luckysheet-wa-editor",".luckysheet-toolbar-menu-button, .luckysheet-toolbar-button, .luckysheet-toolbar-combo-button"),_.luckysheetTableContentHW=[$("#luckysheet-cell-main").width()+_.rowHeaderWidth-_.cellMainSrollBarSize,$("#luckysheet-cell-main").height()+_.columnHeaderHeight-_.cellMainSrollBarSize],$("#luckysheetTableContent, #luckysheetTableContentF").attr({width:Math.ceil(_.luckysheetTableContentHW[0]*_.devicePixelRatio),height:Math.ceil(_.luckysheetTableContentHW[1]*_.devicePixelRatio)}).css({width:_.luckysheetTableContentHW[0],height:_.luckysheetTableContentHW[1]}).get(0).getContext("2d");let e=I().info,t=f.gridKey+"__qkcache",s=function(){n.load="1",l.createSheet();let t=function(){l.mergeCalculation(n.index),l.setSheetParam(!1),l.storeSheetParam(),l.restoreselect(),l.CacheNotLoadControll=[],l.restoreCache(),h.execFunctionGroupForce(y.forceCalculation),l.restoreSheetAll(_.currentSheetIndex),$("#luckysheet_info_detail_save").html(e.detailSave),n.isPivotTable?_.luckysheetcurrentisPivotTable=!0:(_.luckysheetcurrentisPivotTable=!1,$("#luckysheet-modal-dialog-slider-pivot").hide()),ee(),k(),null!=n.scrollLeft&&n.scrollLeft>0?$("#luckysheet-scrollbar-x").scrollLeft(n.scrollLeft):$("#luckysheet-scrollbar-x").scrollLeft(0),null!=n.scrollTop&&n.scrollTop>0?$("#luckysheet-scrollbar-y").scrollTop(n.scrollTop):$("#luckysheet-scrollbar-y").scrollTop(0),q(_.asyncLoad,"core"),y.pointEdit?setTimeout(function(){$("#luckysheetloadingdata").remove()},0):setTimeout(function(){$("#luckysheetloadingdata").fadeOut().remove()},500)},s=f.loadSheetUrl;if(""==s)l.loadOtherFile(n),t();else{let e=l.checkLoadSheetIndex(n),i=[];for(let t=0;t<e.length;t++){let l=e[t];l!=n.index&&i.push(l)}if(0===i.length)return void t();$.post(s,{gridKey:f.gridKey,index:i.join(",")},function(e){let s=new Function("return "+e)();for(let e in s){if(e==n.index)continue;let t=_.luckysheetfile[l.getSheetIndex(e)];null!=t.load&&"0"!=t.load||(t.celldata=s[e.toString()],t.data=l.buildGridData(t),t.load="1")}t()})}};try{localforage.getItem(t).then(function(e){null!=e&&(l.CacheNotLoadControll=e),f.clearcachelocaldata(function(){s()})})}catch(e){s(),console.log("缓存操作失败")}},1)},storeSheetParam:function(){let e=this.getSheetIndex(_.currentSheetIndex),t=_.luckysheetfile[e];t.config=_.config,t.visibledatarow=_.visibledatarow,t.visibledatacolumn=_.visibledatacolumn,t.ch_width=_.ch_width,t.rh_height=_.rh_height,t.luckysheet_select_save=$.extend(!0,[],_.luckysheet_select_save),t.luckysheet_selection_range=$.extend(!0,[],_.luckysheet_selection_range),$("#luckysheet-scrollbar-x")[0].scrollWidth>$("#luckysheet-scrollbar-x")[0].offsetWidth&&(t.scrollLeft=$("#luckysheet-scrollbar-x").scrollLeft()),$("#luckysheet-scrollbar-y")[0].scrollHeight>$("#luckysheet-scrollbar-y")[0].offsetHeight&&(t.scrollTop=$("#luckysheet-scrollbar-y").scrollTop()),t.zoomRatio=_.zoomRatio},setSheetParam:function(e=!0){let t=this.getSheetIndex(_.currentSheetIndex),l=_.luckysheetfile[t];_.flowdata=l.data,o.webWorkerFlowDataCache(_.flowdata),h.execFunctionGlobalData=null,window.luckysheet_getcelldata_cache=null,this.sheetParamRestore(l,_.flowdata),null==l.freezen?(v.freezenhorizontaldata=null,v.freezenverticaldata=null):(v.freezenhorizontaldata=null==l.freezen.horizontal?null:l.freezen.horizontal.freezenhorizontaldata,v.freezenverticaldata=null==l.freezen.vertical?null:l.freezen.vertical.freezenverticaldata),e&&r(_.flowdata.length,_.flowdata[0].length),m.buildAllPs(_.flowdata),x.currentImgId=null,x.images=l.images,x.allImagesShow(),x.init(),S.dataVerification=l.dataVerification,S.init(),p.hyperlink=l.hyperlink,p.init(),U(l.filter_select,l.filter)},restoreselect:function(){let e=this.getSheetIndex(_.currentSheetIndex),t=_.luckysheetfile[e];Z(!0),Q(),null!=t.scrollLeft&&t.scrollLeft>0?$("#luckysheet-scrollbar-x").scrollLeft(t.scrollLeft):$("#luckysheet-scrollbar-x").scrollLeft(0),null!=t.scrollTop&&t.scrollTop>0?$("#luckysheet-scrollbar-y").scrollTop(t.scrollTop):$("#luckysheet-scrollbar-y").scrollTop(0)},storeSheetParamALL:function(){this.storeSheetParam();let e=this.getSheetIndex(_.currentSheetIndex);_.luckysheetfile[e].data=_.flowdata,_.luckysheetfile[e].config=$.extend(!0,{},_.config)},mergeCalculationSheet:{},mergeCalculation:function(e){let t=_.luckysheetfile[this.getSheetIndex(e)],l=t.config,n=t.data;if(null==l)return;let s=l.merge;if(!(null==s||e in this.mergeCalculationSheet||!1===t.autoCalculationMerge)){this.mergeCalculationSheet[e]=1;for(let e in s){let t=parseInt(e.substr(0,e.indexOf("_"))),l=parseInt(e.substr(e.indexOf("_")+1)),i=s[e];null==n[t][l]&&(n[t][l]={}),n[t][l].mc={r:t,c:l,rs:i.rs,cs:i.cs};for(let e=t;e<t+i.rs;e++)for(let s=l;s<l+i.cs;s++)e==t&&s==l||(null==n[e][s]&&(n[e][s]={}),n[e][s].mc={r:t,c:l})}}},loadOtherFile:function(e){let t=this;for(let l=0;l<_.luckysheetfile.length;l++){let n=_.luckysheetfile[l];n.index!=e.index&&(null!=n.load&&"0"!=n.load||(n.data=t.buildGridData(n),n.load="1"))}},changeSheet:function(e,t,l){if(F())return;let n=this;if(e==_.currentSheetIndex)return;f.allowUpdate&&($("#luckysheet-cell-main #luckysheet-multipleRange-show").empty(),f.multipleIndex=0),z.createHookFunction("sheetActivate",e,t,l),$("#luckysheet-filter-selected-sheet"+_.currentSheetIndex+", #luckysheet-filter-options-sheet"+_.currentSheetIndex).hide(),$("#luckysheet-filter-selected-sheet"+e+", #luckysheet-filter-options-sheet"+e).show(),n.storeSheetParamALL(),n.setCurSheet(e);let s=_.luckysheetfile[n.getSheetIndex(e)];if(s.isPivotTable?(_.luckysheetcurrentisPivotTable=!0,t||g.changePivotTable(e)):(_.luckysheetcurrentisPivotTable=!1,$("#luckysheet-modal-dialog-slider-pivot").hide(),k(!1)),null!=s.load){let t=n.buildGridData(s);s.data=t,n.mergeCalculation(e),n.setSheetParam(!0),n.showSheet(),setTimeout(function(){h.execFunctionGroup(),D(),f.saveParam("shs",null,_.currentSheetIndex)},1)}else{let t=f.loadSheetUrl;if(""==t||_.luckysheetcurrentisPivotTable||l){let t=n.buildGridData(s);s.data=t,s.load="1",n.loadOtherFile(s),n.mergeCalculation(e),n.setSheetParam(),n.showSheet(),setTimeout(function(){n.restoreCache(),h.execFunctionGroupForce(y.forceCalculation),n.restoreSheetAll(_.currentSheetIndex),D()},1),f.saveParam("shs",null,_.currentSheetIndex)}else{$("#luckysheet-grid-window-1").append(J());let l=n.checkLoadSheetIndex(s);$.post(t,{gridKey:f.gridKey,index:l.join(",")},function(t){let l=new Function("return "+t)();s.celldata=l[e.toString()];let i=n.buildGridData(s);setTimeout(function(){$("#luckysheetloadingdata").fadeOut().remove()},500);for(let t in l){if(t==e)continue;let s=_.luckysheetfile[n.getSheetIndex(t)];null!=s.load&&"0"!=s.load||(s.celldata=l[t.toString()],s.data=n.buildGridData(s),s.load="1")}s.data=i,s.load="1",n.mergeCalculation(e),n.setSheetParam(),n.showSheet(),setTimeout(function(){n.restoreCache(),h.execFunctionGroupForce(y.forceCalculation),n.restoreSheetAll(_.currentSheetIndex),D()},1),f.saveParam("shs",null,_.currentSheetIndex)})}}$("#luckysheet-cell-main .luckysheet-datavisual-selection-set").hide(),$("#luckysheet-datavisual-selection-set-"+e).show(),X(e),v.initialFreezen(e),n.restoreselect()},checkLoadSheetIndexToDataIndex:{},checkLoadSheetIndex:function(e){let t=h.getAllFunctionGroup(),l=e.chart,n=e.pivotTable,s=[],i={};if(e.index in this.checkLoadSheetIndexToDataIndex)return[];if(s.push(e.index),i[e.index.toString()]=1,this.checkLoadSheetIndexToDataIndex[e.index]=1,null!=t){let e={};for(let l=0;l<t.length;l++){let n=t[l],s=n.index,i=N(n.r,n.c,s);if(null==i){let e=_.luckysheetfile[this.getSheetIndex(s)];if(e.data=this.buildGridData(e),null==(i=N(n.r,n.c,s)))continue}if(-1==i.indexOf("!"))h.addToSheetIndexList(i,s);else if(null!=h.formulaContainSheetList&&null!=h.formulaContainSheetList[i])for(let t in h.formulaContainSheetList[i])e[t]=1;else h.functionParser(i,t=>{if(h.addToCellList(i,t),t.indexOf("!")>-1){let l=t.substr(0,t.indexOf("!")),n=this.getSheetByName(l);if(null!=n){let t=n.index;e[t]=1,h.addToSheetIndexList(i,t)}}}),null==h.formulaContainSheetList[i]&&h.addToSheetIndexList(i,s)}for(let t in e){let e=t;null==i[e.toString()]&&(s.push(e),i[e.toString()]=1,this.checkLoadSheetIndexToDataIndex[e]=1)}}if(null!=l)for(let e=0;e<l.length;e++){let t=l[e].dataSheetIndex;null!=t&&(null==i[t.toString()]&&(s.push(t),i[t.toString()]=1))}if(null!=n){let e=n.pivotDataSheetIndex;null!=e&&null==i[e.toString()]&&(s.push(e),i[e.toString()]=1)}return s},showSheet:function(){$("#luckysheet-cell-flow_0").css({width:_.ch_width,top:"-1px"}),$("#luckysheet-sheettable_0").css({width:_.ch_width-1,height:_.rh_height}),$("#luckysheetrowHeader_0").css("height",_.rh_height),$("#luckysheet-cols-h-cells_0").css("width",_.ch_width),$("#luckysheet-scrollbar-x div").width(_.ch_width),$("#luckysheet-scrollbar-y div").height(_.rh_height+_.columnHeaderHeight-_.cellMainSrollBarSize-3);let e=this.getSheetIndex(_.currentSheetIndex),t=_.luckysheetfile[e];_.scrollRefreshSwitch=!1,null!=t.scrollLeft&&t.scrollLeft>0?$("#luckysheet-scrollbar-x").scrollLeft(t.scrollLeft*_.zoomRatio):$("#luckysheet-scrollbar-x").scrollLeft(0),null!=t.scrollTop&&t.scrollTop>0?$("#luckysheet-scrollbar-y").scrollTop(t.scrollTop*_.zoomRatio):$("#luckysheet-scrollbar-y").scrollTop(0),setTimeout(()=>{_.scrollRefreshSwitch=!0},0),te(_.zoomRatio)},setCurSheet:function(e){for(let t=0;t<_.luckysheetfile.length;t++)_.luckysheetfile[t].index==e?_.luckysheetfile[t].status=1:_.luckysheetfile[t].status=0;_.currentSheetIndex=e},getSheetIndex:function(e){for(let t=0;t<_.luckysheetfile.length;t++)if(_.luckysheetfile[t].index==e)return t;return null},changeSheetExec:function(e,l,n){let s=$("#luckysheet-sheets-item"+e);window.luckysheet_getcelldata_cache=null,$("#luckysheet-sheet-area div.luckysheet-sheets-item").removeClass("luckysheet-sheets-item-active"),s.addClass("luckysheet-sheets-item-active").show(),t(),this.changeSheet(e,l,n),$("#luckysheet-sheet-list, #luckysheet-rightclick-sheet-menu").hide(),h.rangestart&&h.createRangeHightlight(),this.sheetBarShowAndHide(e)},sheetArrowShowAndHide(){let e=$("#luckysheet-sheet-container").width(),t=0;$("#luckysheet-sheet-container-c > div.luckysheet-sheets-item:visible").each(function(){t+=$(this).outerWidth()}),t>=e?y.showsheetbarConfig.sheet&&($("#luckysheet-sheet-area .luckysheet-sheets-scroll").css("display","inline-block"),$("#luckysheet-sheet-container .docs-sheet-fade-left").show()):($("#luckysheet-sheet-area .luckysheet-sheets-scroll").css("display","none"),$("#luckysheet-sheet-container .docs-sheet-fade-left").hide())},sheetBarShowAndHide(e){let t=$("#luckysheet-sheet-container-c");if(null!=e){let l=$("#luckysheet-sheets-item"+e);t.scrollLeft(l.offset().left)}let l=t.width(),n=t[0].scrollWidth,s=t.scrollLeft();s<=0?$("#luckysheet-sheet-container .docs-sheet-fade-left").hide():$("#luckysheet-sheet-container .docs-sheet-fade-left").show(),l+s>=n?$("#luckysheet-sheet-container .docs-sheet-fade-right").hide():$("#luckysheet-sheet-container .docs-sheet-fade-right").show()},delChart:function(e,t){let l=this.getSheetIndex(t),n=_.luckysheetfile[l];if(null==n.chart)n.chart=[];else for(let t=0;t<n.chart.length;t++)if(n.chart[t].chart_id==e){_.luckysheetfile[l].chart.splice(t,1);break}},saveChart:function(e){let t=this.getSheetIndex(e.sheetIndex),l=_.luckysheetfile[t];if(null==l.chart)l.chart=[],l.chart.push(e);else{for(let t=0;t<l.chart.length;t++)if(l.chart[t].chart_id==e.chart_id){let n=$.extend(!0,{},l.chart[t]);return void(l.chart[t]=$.extend(!0,{},n,e))}l.chart.push(e)}},getChart:function(e,t){let l=this.getSheetIndex(e),n=_.luckysheetfile[l];if(null==n.chart)return null;for(let e=0;e<n.chart.length;e++)if(n.chart[e].chart_id==t)return n.chart[e];return null},getRangetxt:function(e,t,l){let n="";null==l&&(l=_.currentSheetIndex),e!=l&&(n=_.luckysheetfile[this.getSheetIndex(e)].name+"!");let s=t.row[0],i=t.row[1],h=t.column[0],c=t.column[1];return null==s&&null==i?n+E(h)+":"+E(c):null==h&&null==c?n+(s+1)+":"+(i+1):h==c&&s==i?n+E(h)+(s+1):n+E(h)+(s+1)+":"+E(c)+(i+1)},getSheetName:function(e){return null==e&&(e=_.currentSheetIndex),_.luckysheetfile[this.getSheetIndex(e)].name},getSheetMerge:function(){return null==_.config.merge?null:_.config.merge},getSheetData:function(e){return null==e&&(e=_.currentSheetIndex),_.luckysheetfile[this.getSheetIndex(e)].data},getSheetConfig:function(e){let t=this;return null==e&&(e=_.currentSheetIndex),null==_.luckysheetfile[t.getSheetIndex(e)].config&&(_.luckysheetfile[t.getSheetIndex(e)].config={}),_.luckysheetfile[t.getSheetIndex(e)].config},restoreFilter:function(e){let t=this.getSheetIndex(e),l=_.luckysheetfile[t];if("string"==B(l.filter_select)&&(l.filter_select=JSON.parse(l.filter_select)),null==l.filter_select||null==l.filter_select.row||null==l.filter_select.column)return;U(l.filter_select),"object"!=B(l.filter)&&null!=l.filter&&"string"==B(l.filter)&&(l.filter=JSON.parse(l.filter));let n={};null!=l.config&&null!=l.config.rowhidden&&(n=l.config.rowhidden),$("#luckysheet-filter-options-sheet"+e+" .luckysheet-filter-options").each(function(e){if(null==l.filter)return!1;let t=$(this),s=l.filter[e];if(null==s)return!0;"object"!=B(s)&&(s=JSON.parse(s)),V(t,s.optionstate,s.rowhidden,s.caljs,!1,s.st_r,s.ed_r,s.cindex,s.st_c,s.ed_c),n=$.extend(!0,n,s.rowhidden)}),null==l.config&&(l.config={}),l.config.rowhidden=n,_.config=l.config,j(_.flowdata.length,_.flowdata[0].length,!1)},restorePivot:function(e){let t=this.getSheetIndex(e);_.luckysheetfile[t].isPivotTable&&(g.getCellData(e),g.initialPivotManage(!0),g.refreshPivotTable(!1))},restoreSheetAll:function(e){this.restorePivot(e),this.restoreFilter(e),this.restoreFreezen(e)},restoreFreezen:function(e){v.initialFreezen(e)},restoreCache:function(){let e=this,t=e.CacheNotLoadControll;if(e.CacheNotLoadControll=[],0!=t.length)for(let l=0;l<t.length;l++){let n=t[l];e.execCache(n)}},CacheNotLoadControll:[],execCache:function(e){let t=this,l=e.t,n=e.i,s=e.v,i=_.luckysheetfile[t.getSheetIndex(n)];if("sha"==l)_.luckysheetfile.push(s);else if("shc"==l){let e=$.extend(!0,{},_.luckysheetfile[t.getSheetIndex(s.copyindex)]);e.index=n,_.luckysheetfile.push(e)}else if("shd"==l)_.luckysheetfile.splice(s.deleIndex,1);else if("shr"==l)for(let e in s)_.luckysheetfile[t.getSheetIndex(e)].order=s[e];if(null!=i&&"1"==i.load||l in{sha:0,shc:0,shd:0,shr:0})if("v"==l){let l=e.r,s=e.c,h=e.v;t.getSheetData(n);i.data[l][s]=h}else if("fc"==l){let t=e.op;e.pos;"object"!=B(s)&&(s=new Function("return "+s)());let l=s.r,i=s.c;"del"==t?h.delFunctionGroup(l,i,n):h.insertUpdateFunctionGroup(l,i,n)}else if("cg"==l){let l=s,i=e.k,h=t.getSheetConfig(n);i in h||(h[i]={});for(let e in l)h[i][e]=l[e];_.config=h}else if("f"==l){let t=s,l=e.op,n=e.pos,h=i.filter;null==h&&(h={}),"upOrAdd"==l?h[n]=t:"del"==l&&delete h[n]}else if("fsc"==l)i.filter=null,i.filter_select=null;else if("fsr"==l){let e=s;i.filter=e.filter,i.filter_select=e.filter_select}else if("sh"==l){let l=e.op,n=e.cur;if("hide"==l)i.status=0,_.luckysheetfile[t.getSheetIndex(n)].status=1;else if("show"==l){for(let e=0;e<_.luckysheetfile.length;e++)_.luckysheetfile[e].status=0;i.status=1}}else if("all"==l){let t=e.k;e.s&&"object"!=B(s)?i[t]=JSON.stringify(s):i[t]=s}else if("c"==l){let t=e.op,l=e.cid;if("add"==t)i.chart.push(s);else if("xy"==t||"wh"==t||"update"==t){for(let e=0;e<i.chart.length;e++)if(i.chart[e].chart_id==l){for(let t in i.chart[e])for(let l in s)t==l&&(i.chart[e][t]=s[l]);return}}else if("del"==t)for(let e=0;e<i.chart.length;e++)if(i.chart[e].chart_id==l)return void i.chart.splice(e,1)}else if("drc"==l){let t=e.rc,l=s.index,n=s.len,h=i.celldata;if("r"==t){for(let e=0;0==h.length;e++){let t=h[e];t.r>=l&&t.r<l+n?delete h[e]:t.r>=l+n&&(t.r-=n)}i.row-=n}else{for(let e=0;0==h.length;e++){let t=h[e];t.c>=l&&t.c<l+n?delete h[e]:t.c>=l+n&&(t.c-=n)}i.column-=n}let c,r,o,a=[];for(let e=0;e<h.length;e++)null!=h[e]&&a.push(h[e]);i.celldata=a,M(c="r"==t?"row":"column",r=l,o=l+n-1,!0)}else if("arc"==l){let t,l=e.rc,n=s.index,h=s.len,c=i.celldata;if("r"==l){for(let e=0;e<c.length;e++){let t=c[e];t.r>n&&(t.r+=h)}i.row+=h}else{for(let e=0;e<c.length;e++){let t=c[e];t.c>n&&(t.c+=h)}i.column+=h}G(t="r"==l?"row":"column",n,h,!0)}else"na"==l?f.saveParam("na",null,s):"thumb"==l&&setTimeout(function(){t.imageRequest()},2e3);else t.CacheNotLoadControll.push(e)}}});
//# sourceMappingURL=../sourcemaps/controllers/sheetmanage.js.map
