/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./sheetmanage","./server","./pivotTable","./conditionformat","./postil","./imageCtrl","./dataVerificationCtrl","./hyperlinkCtrl","./zoom","./filter","../global/formula","../global/json","../global/cleargridelement","../global/refresh","../methods/get","../store","./select","../global/method","../global/api"],function(e,t,a,l,r,n,i,c,o,s,d,h,f,u,g,y,p,m,x){"use strict";const{zoomRefreshView:k,zoomNumberDomBind:I}=o,{createFilter:w,createFilterOptions:v,labelFilterOptionState:C}=s,{jfrefreshgrid:b,jfrefreshgridall:_,jfrefreshrange:S,jfrefreshgrid_rhcw:V,jfrefreshgrid_adRC:P,jfrefreshgrid_deleteCell:D,jfrefreshgrid_pastcut:R,luckysheetrefreshgrid:j}=u,{getSheetIndex:z}=g,{selectHightlightShow:T}=p,{refreshMenuButtonFocus:A}=x;function F(e,t="redo"){if(null==e)return;let a=e.data;"undo"==t&&(a=e.curdata);for(let t=0;t<e.range.length;t++){let l=e.range[t].row[0],r=e.range[t].row[1],n=e.range[t].column[0],i=e.range[t].column[1];for(let t=l;t<r+1;t++)for(let l=n;l<i+1&&!(t>a.length-1);l++)null==a[t][l]||null==a[t][l].f||""==a[t][l].f?d.delFunctionGroup(t,l,e.sheetIndex):null!=a[t][l]&&null!=a[t][l].f&&a[t][l].f.length>0&&d.insertUpdateFunctionGroup(t,l,e.sheetIndex)}}return{redo:function(o){if(0==y.jfredo.length)return;let s=y.jfredo.pop();if(y.jfundo.push(s),y.clearjfundo=!1,e.hasSheet(s.sheetIndex)&&y.currentSheetIndex!=s.sheetIndex&&e.changeSheetExec(s.sheetIndex),"datachange"==s.type){F(s);let e={cfg:s.config,RowlChange:s.RowlChange,cdformat:s.cdformat,dataVerification:s.dataVerification,dynamicArray:s.dynamicArray};b(s.data,s.range,e)}else if("pasteCut"==s.type){let e={sheetIndex:s.source.sheetIndex,data:s.source.curData,curData:s.source.data,config:s.source.curConfig,curConfig:s.source.config,cdformat:s.source.curCdformat,curCdformat:s.source.cdformat,dataVerification:s.source.curDataVerification,curDataVerification:s.source.dataVerification,range:s.source.range},t={sheetIndex:s.target.sheetIndex,data:s.target.curData,curData:s.target.data,config:s.target.curConfig,curConfig:s.target.config,cdformat:s.target.curCdformat,curCdformat:s.target.cdformat,dataVerification:s.target.curDataVerification,curDataVerification:s.target.dataVerification,range:s.target.range};R(e,t,s.RowlChange)}else if("rangechange"==s.type)F(s),S(s.data,s.range,s.cdformat);else if("resize"==s.type){y.config=s.config,y.luckysheetfile[z(s.sheetIndex)].config=y.config,"resizeR"==s.ctrlType?t.saveParam("cg",s.sheetIndex,s.config.rowlen,{k:"rowlen"}):"resizeC"==s.ctrlType&&t.saveParam("cg",s.sheetIndex,s.config.columnlen,{k:"columnlen"});let e=$.extend(!0,{},s.images);y.luckysheetfile[z(s.sheetIndex)].images=e,t.saveParam("all",s.sheetIndex,e,{k:"images"}),n.images=e,n.allImagesShow(),V(y.flowdata.length,y.flowdata[0].length)}else if("cellRowChange"==s.type)_(s.data[0].length,s.data.length,s.data,s.config,s.range,s.ctrlType,s.ctrlValue,s.cdformat);else if("extend"==s.type)_(s.data[0].length,s.data.length,s.data,s.config,s.range,"dele",s.ctrlValue);else if("dele"==s.type){let e=$.extend(!0,{},s.ctrlValue);e.restore=!0,_(s.data[0].length,s.data.length,s.data,s.config,s.range,"extend",e)}else if("addRC"==s.type){let e=$.extend(!0,{},s.ctrlValue);"rightbottom"==e.direction&&(e.index=e.index+1),P(s.data,s.config,"delRC",e,s.calc,s.filterObj,s.cf,s.af,s.freezen,s.dataVerification,s.hyperlink)}else if("delRC"==s.type){let e=$.extend(!0,{},s.ctrlValue);e.restore=!0,e.direction="lefttop",P(s.data,s.config,"addRC",e,s.calc,s.filterObj,s.cf,s.af,s.freezen,s.dataVerification,s.hyperlink)}else if("deleteCell"==s.type)D(s.data,s.config,s.ctrl,s.calc,s.filterObj,s.cf,s.dataVerification,s.hyperlink);else if("showHidRows"==s.type)y.config=s.config,y.luckysheetfile[z(s.sheetIndex)].config=s.config,t.saveParam("cg",s.sheetIndex,s.config.rowhidden,{k:"rowhidden"}),V(y.flowdata.length,y.flowdata[0].length);else if("showHidCols"==s.type)y.config=s.config,y.luckysheetfile[z(s.sheetIndex)].config=s.config,t.saveParam("cg",s.sheetIndex,s.config.colhidden,{k:"colhidden"}),V(y.flowdata.length,y.flowdata[0].length);else if("datachangeAll"==s.type)d.execFunctionGroup(),_(s.data[0].length,s.data.length,s.data,null,s.range,"datachangeAll",s.ctrlValue);else if("datachangeAll_filter_clear"==s.type)v(s.filter_save),$("#luckysheet-filter-options-sheet"+y.currentSheetIndex+" .luckysheet-filter-options").each(function(e){let t=$(this),a=s.optiongroups[e];C(t,a.optionstate,a.rowhidden,a.caljs,!1,a.st_r,a.ed_r,a.cindex,a.st_c,a.ed_c)}),t.saveParam("fsr",y.currentSheetIndex,{filter:s.optiongroups,filter_select:s.filter_save}),y.config=s.config,y.luckysheetfile[z(y.currentSheetIndex)].config=y.config,null==y.config.rowhidden&&(y.config.rowhidden={}),t.saveParam("cg",y.currentSheetIndex,y.config.rowhidden,{k:"rowhidden"}),V(y.flowdata.length,y.flowdata[0].length),$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide();else if("datachangeAll_filter"==s.type){let e=$("#luckysheet-filter-options-sheet"+y.currentSheetIndex+" .luckysheet-filter-options").eq(s.optionsindex),a=e.data("str"),l=e.data("edr"),r=e.data("cindex"),n=e.data("stc"),i=e.data("edc");C(e,h.hasKey(s.rowhidenPre),s.rowhidenPre,s.caljs,!0,a,l,r,n,i),y.config=s.config,y.luckysheetfile[z(y.currentSheetIndex)].config=y.config,null==y.config.rowhidden&&(y.config.rowhidden={}),t.saveParam("cg",y.currentSheetIndex,y.config.rowhidden,{k:"rowhidden"}),V(y.flowdata.length,y.flowdata[0].length),$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide()}else if("filtershow"==s.type)$("#luckysheet-filter-selected-sheet"+s.sheetIndex+", #luckysheet-filter-options-sheet"+s.sheetIndex).remove(),t.allowUpdate&&t.saveParam("all",s.sheetIndex,null,{k:"filter_select"});else if("pivotTable_change"==s.type)y.luckysheetfile[z(s.sheetIndex)].pivotTable=s.pivotTable,a.getCellData(s.sheetIndex),a.initialPivotManage(!0),a.refreshPivotTable();else if("addSheet"==s.type)e.deleteSheet(s.index),e.changeSheetExec(s.currentSheetIndex),$("#luckysheet-input-box").removeAttr("style"),$("#luckysheet-sheet-list, #luckysheet-rightclick-sheet-menu").hide();else if("copySheet"==s.type)e.deleteSheet(s.index),e.changeSheetExec(s.copyindex);else if("deleteSheet"==s.type){let t=!1;for(let e=0;e<y.luckysheetfile.length;e++)y.luckysheetfile[e].name==s.name&&(t=!0);t||(e.createSheetbydata(s,"isrenew"),$("#luckysheet-input-box").removeAttr("style"),$("#luckysheet-sheet-list, #luckysheet-rightclick-sheet-menu").hide())}else if("sheetName"==s.type)y.luckysheetfile[z(s.sheetIndex)].name=s.oldtxt,$("#luckysheet-sheets-item"+s.sheetIndex).find(".luckysheet-sheets-item-name").html(s.oldtxt),t.saveParam("all",s.sheetIndex,s.oldtxt,{k:"name"});else if("sheetColor"==s.type){y.luckysheetfile[z(s.sheetIndex)].color=s.oldcolor;let e=$("#luckysheet-sheets-item"+s.sheetIndex);e.find(".luckysheet-sheets-item-color").remove(),null!=s.oldcolor&&e.append('<div class="luckysheet-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: '+s.oldcolor+';"></div>'),t.saveParam("all",s.sheetIndex,s.oldcolor,{k:"color"})}else if("mergeChange"==s.type){let e={cfg:s.config};b(s.data,s.range,e)}else if("updateDataVerification"==s.type)i.ref(s.currentDataVerification,s.historyDataVerification,s.sheetIndex);else if("updateDataVerificationOfCheckbox"==s.type)i.refOfCheckbox(s.currentDataVerification,s.historyDataVerification,s.sheetIndex,s.data,s.range);else if("updateHyperlink"==s.type)c.ref(s.currentHyperlink,s.historyHyperlink,s.sheetIndex,s.data,s.range);else if("updateCF"==s.type){let e=s.data.historyRules;for(let a=0;a<e.length;a++){let l=e[a].sheetIndex;y.luckysheetfile[z(l)].luckysheet_conditionformat_save=e[a].luckysheet_conditionformat_save,t.allowUpdate&&t.saveParam("all",l,e[a].luckysheet_conditionformat_save,{k:"luckysheet_conditionformat_save"})}l.ref()}else if("updateAF"==s.type){let e=s.data.historyRules,t=z(s.sheetIndex);y.luckysheetfile[t].luckysheet_alternateformat_save=$.extend(!0,[],e),setTimeout(function(){j()},1)}else if("borderChange"==s.type)null==s.config.borderInfo?t.saveParam("cg",s.sheetIndex,[],{k:"borderInfo"}):t.saveParam("cg",s.sheetIndex,s.config.borderInfo,{k:"borderInfo"}),y.config=s.config,y.luckysheetfile[z(s.sheetIndex)].config=y.config,setTimeout(function(){j()},1);else if("postil"==s.type){r.ref(s.data,s.rc);for(let e=0;e<s.rc.length;e++){let t=s.rc[e].split("_")[0],a=s.rc[e].split("_")[1];null!=s.data[t][a]&&null!=s.data[t][a].ps?r.buildPs(t,a,s.data[t][a].ps):r.buildPs(t,a,null)}}else"imageCtrl"==s.type?(n.images=$.extend(!0,{},s.images),n.allImagesShow(),n.ref()):"zoomChange"==s.type&&(y.zoomRatio=s.zoomRatio,t.saveParam("all",s.currentSheetIndex,s.zoomRatio,{k:"zoomRatio"}),I(),k());f(o),s.range&&(y.luckysheet_select_save=s.range,T()),y.clearjfundo=!0,A();let u={...s,...{data:s.curdata,curdata:s.data}};m.createHookFunction("updated",u)},undo:function(){if(0==y.jfundo.length)return;let o=y.jfundo.pop();if(y.jfredo.push(o),y.clearjfundo=!1,e.hasSheet(o.sheetIndex)&&y.currentSheetIndex!=o.sheetIndex&&e.changeSheetExec(o.sheetIndex),"datachange"==o.type){d.execFunctionGroup();let e={cfg:o.curConfig,RowlChange:o.RowlChange,cdformat:o.curCdformat,dataVerification:o.curDataVerification,dynamicArray:o.curDynamicArray};F(o,"undo"),b(o.curdata,o.range,e)}else if("pasteCut"==o.type)R(o.source,o.target,o.RowlChange);else if("rangechange"==o.type)F(o,"undo"),S(o.curdata,o.range,o.curCdformat);else if("resize"==o.type){y.config=o.curconfig,y.luckysheetfile[z(o.sheetIndex)].config=y.config,"resizeR"==o.ctrlType?t.saveParam("cg",o.sheetIndex,o.curconfig.rowlen,{k:"rowlen"}):"resizeC"==o.ctrlType&&t.saveParam("cg",o.sheetIndex,o.curconfig.columnlen,{k:"columnlen"});let e=$.extend(!0,{},o.curImages);y.luckysheetfile[z(o.sheetIndex)].images=e,t.saveParam("all",o.sheetIndex,e,{k:"images"}),n.images=e,n.allImagesShow(),V(y.flowdata.length,y.flowdata[0].length)}else if("cellRowChange"==o.type)_(o.curdata[0].length,o.curdata.length,o.curdata,o.curconfig,o.currange,o.ctrlType,o.ctrlValue,o.curCdformat);else if("extend"==o.type)_(o.curdata[0].length,o.curdata.length,o.curdata,o.curconfig,o.currange,o.ctrlType,o.ctrlValue);else if("dele"==o.type){$.extend(!0,{},o.ctrlValue).restore=!0,_(o.curdata[0].length,o.curdata.length,o.curdata,o.curconfig,o.currange,o.ctrlType,o.ctrlValue)}else if("addRC"==o.type)P(o.curData,o.curConfig,"addRC",o.ctrlValue,o.curCalc,o.curFilterObj,o.curCf,o.curAf,o.curFreezen,o.curDataVerification,o.curHyperlink);else if("delRC"==o.type)P(o.curData,o.curConfig,"delRC",o.ctrlValue,o.curCalc,o.curFilterObj,o.curCf,o.curAf,o.curFreezen,o.curDataVerification,o.curHyperlink);else if("deleteCell"==o.type)D(o.curData,o.curConfig,o.ctrl,o.curCalc,o.curFilterObj,o.curCf,o.curDataVerification,o.curHyperlink);else if("showHidRows"==o.type)y.config=o.curconfig,y.luckysheetfile[z(o.sheetIndex)].config=o.curconfig,t.saveParam("cg",o.sheetIndex,o.curconfig.rowhidden,{k:"rowhidden"}),V(y.flowdata.length,y.flowdata[0].length);else if("showHidCols"==o.type)y.config=o.curconfig,y.luckysheetfile[z(o.sheetIndex)].config=o.curconfig,t.saveParam("cg",o.sheetIndex,o.curconfig.colhidden,{k:"colhidden"}),V(y.flowdata.length,y.flowdata[0].length);else if("datachangeAll"==o.type)d.execFunctionGroup(),_(o.curdata[0].length,o.curdata.length,o.curdata,null,o.currange,"datachangeAll",o.ctrlValue);else if("datachangeAll_filter_clear"==o.type)t.saveParam("fsc",y.currentSheetIndex,null),y.config=o.curconfig,y.luckysheetfile[z(y.currentSheetIndex)].config=y.config,t.saveParam("cg",y.currentSheetIndex,{},{k:"rowhidden"}),V(y.flowdata.length,y.flowdata[0].length),$("#luckysheet-filter-menu .luckysheet-filter-selected-input").hide().find("input").val(),$("#luckysheet-filter-selected span").data("type","0").data("type",null).text("æ— "),$("#luckysheet-filter-selected-sheet"+y.currentSheetIndex+", #luckysheet-filter-options-sheet"+y.currentSheetIndex).remove(),$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide();else if("datachangeAll_filter"==o.type){let e=$("#luckysheet-filter-options-sheet"+y.currentSheetIndex+" .luckysheet-filter-options").eq(o.optionsindex),a=e.data("str"),l=e.data("edr"),r=e.data("cindex"),n=e.data("stc"),i=e.data("edc");C(e,h.hasKey(o.rowhidden),o.rowhidden,o.caljs,!0,a,l,r,n,i),y.config=o.curconfig,y.luckysheetfile[z(y.currentSheetIndex)].config=y.config,t.saveParam("cg",y.currentSheetIndex,y.config.rowhidden,{k:"rowhidden"}),V(y.flowdata.length,y.flowdata[0].length),$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide()}else if("filtershow"==o.type)y.luckysheet_select_save=[o.filter_save],y.filterchage=!1,w(),y.filterchage=!0,t.saveParam("all",o.sheetIndex,o.filter_save,{k:"filter_select"});else if("pivotTable_change"==o.type)y.luckysheetfile[z(o.sheetIndex)].pivotTable=o.pivotTablecur,a.getCellData(o.sheetIndex),a.initialPivotManage(!0),a.refreshPivotTable();else if("addSheet"==o.type)e.createSheetbydata(o.sheetconfig),$("#luckysheet-input-box").removeAttr("style"),$("#luckysheet-sheet-list, #luckysheet-rightclick-sheet-menu").hide();else if("copySheet"==o.type)e.copySheet(o.copyindex);else if("deleteSheet"==o.type)e.deleteSheet(o.index),0==o.order?e.changeSheetExec(y.luckysheetfile[0].index):e.changeSheetExec(y.luckysheetfile[o.order-1].index),$("#luckysheet-input-box").removeAttr("style"),$("#luckysheet-sheet-list, #luckysheet-rightclick-sheet-menu").hide();else if("sheetName"==o.type)y.luckysheetfile[z(o.sheetIndex)].name=o.txt,$("#luckysheet-sheets-item"+o.sheetIndex).find(".luckysheet-sheets-item-name").html(o.txt),t.saveParam("all",o.sheetIndex,o.txt,{k:"name"});else if("sheetColor"==o.type){y.luckysheetfile[z(o.sheetIndex)].color=o.color;let e=$("#luckysheet-sheets-item"+o.sheetIndex);e.find(".luckysheet-sheets-item-color").remove(),null!=o.color&&e.append('<div class="luckysheet-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: '+o.color+';"></div>'),t.saveParam("all",o.sheetIndex,o.color,{k:"color"})}else if("mergeChange"==o.type){let e={cfg:o.curConfig};b(o.curData,o.range,e)}else if("updateDataVerification"==o.type)i.ref(o.historyDataVerification,o.currentDataVerification,o.sheetIndex);else if("updateDataVerificationOfCheckbox"==o.type)i.refOfCheckbox(o.historyDataVerification,o.currentDataVerification,o.sheetIndex,o.curData,o.range);else if("updateHyperlink"==o.type)c.ref(o.historyHyperlink,o.currentHyperlink,o.sheetIndex,o.curData,o.range);else if("updateCF"==o.type){let e=o.data.currentRules;for(let a=0;a<e.length;a++){let l=e[a].sheetIndex;y.luckysheetfile[z(l)].luckysheet_conditionformat_save=e[a].luckysheet_conditionformat_save,t.allowUpdate&&t.saveParam("all",l,e[a].luckysheet_conditionformat_save,{k:"luckysheet_conditionformat_save"})}l.ref()}else if("updateAF"==o.type){let e=o.data.currentRules,t=z(o.sheetIndex);y.luckysheetfile[t].luckysheet_alternateformat_save=$.extend(!0,[],e),setTimeout(function(){j()},1)}else if("borderChange"==o.type)t.saveParam("cg",o.sheetIndex,o.curconfig.borderInfo,{k:"borderInfo"}),y.config=o.curconfig,y.luckysheetfile[z(o.sheetIndex)].config=y.config,setTimeout(function(){j()},1);else if("postil"==o.type){r.ref(o.curdata,o.rc);for(let e=0;e<o.rc.length;e++){let t=o.rc[e].split("_")[0],a=o.rc[e].split("_")[1];null!=o.curdata[t][a]&&null!=o.curdata[t][a].ps?r.buildPs(t,a,o.curdata[t][a].ps):r.buildPs(t,a,null)}}else"imageCtrl"==o.type?(n.images=$.extend(!0,{},o.curImages),n.allImagesShow(),n.ref()):"zoomChange"==o.type&&(y.zoomRatio=o.curZoomRatio,t.saveParam("all",o.currentSheetIndex,o.curZoomRatio,{k:"zoomRatio"}),I(),k());o.range&&(y.luckysheet_select_save=o.range,T()),y.clearjfundo=!0,A()}}});
//# sourceMappingURL=../sourcemaps/controllers/controlHistory.js.map
