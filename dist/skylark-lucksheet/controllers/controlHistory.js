/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./sheetmanage","./pivotTable","./conditionformat","./postil","../widgets/imageCtrl","../widgets/dataVerificationCtrl","../widgets/hyperlinkCtrl","./zoom","./filter","./formula","../methods/json","../widgets/cleargridelement","../methods/get","../store","../widgets/select","../methods/luckysheetConfigsetting"],function(e,t,r,a,l,i,n,c,o,s,d,h,f,u,g,y){"use strict";const{zoomRefreshView:p,zoomNumberDomBind:m}=c,{createFilter:k,createFilterOptions:x,labelFilterOptionState:I}=o,{getSheetIndex:w}=f,{selectHightlightShow:C}=g;function v(e,t="redo"){if(null==e)return;let r=e.data;"undo"==t&&(r=e.curdata);for(let t=0;t<e.range.length;t++){let a=e.range[t].row[0],l=e.range[t].row[1],i=e.range[t].column[0],n=e.range[t].column[1];for(let t=a;t<l+1;t++)for(let a=i;a<n+1&&!(t>r.length-1);a++)null==r[t][a]||null==r[t][a].f||""==r[t][a].f?s.delFunctionGroup(t,a,e.sheetIndex):null!=r[t][a]&&null!=r[t][a].f&&r[t][a].f.length>0&&s.insertUpdateFunctionGroup(t,a,e.sheetIndex)}}return{redo:function(c){if(0==u.jfredo.length)return;let o=u.jfredo.pop();if(u.jfundo.push(o),u.clearjfundo=!1,u.hasSheet(o.sheetIndex)&&u.currentSheetIndex!=o.sheetIndex&&u.changeSheet(o.sheetIndex),"datachange"==o.type){v(o);let e={cfg:o.config,RowlChange:o.RowlChange,cdformat:o.cdformat,dataVerification:o.dataVerification,dynamicArray:o.dynamicArray};u.refreshGrid(o.data,o.range,e)}else if("pasteCut"==o.type){let e={sheetIndex:o.source.sheetIndex,data:o.source.curData,curData:o.source.data,config:o.source.curConfig,curConfig:o.source.config,cdformat:o.source.curCdformat,curCdformat:o.source.cdformat,dataVerification:o.source.curDataVerification,curDataVerification:o.source.dataVerification,range:o.source.range},t={sheetIndex:o.target.sheetIndex,data:o.target.curData,curData:o.target.data,config:o.target.curConfig,curConfig:o.target.config,cdformat:o.target.curCdformat,curCdformat:o.target.cdformat,dataVerification:o.target.curDataVerification,curDataVerification:o.target.dataVerification,range:o.target.range};u.refreshGrid_pastcut(e,t,o.RowlChange)}else if("rangechange"==o.type)v(o),u.refreshRange(o.data,o.range,o.cdformat);else if("resize"==o.type){u.config=o.config,u.luckysheetfile[w(o.sheetIndex)].config=u.config,"resizeR"==o.ctrlType?u.saveParam("cg",o.sheetIndex,o.config.rowlen,{k:"rowlen"}):"resizeC"==o.ctrlType&&u.saveParam("cg",o.sheetIndex,o.config.columnlen,{k:"columnlen"});let e=$.extend(!0,{},o.images);u.luckysheetfile[w(o.sheetIndex)].images=e,u.saveParam("all",o.sheetIndex,e,{k:"images"}),l.images=e,l.allImagesShow(),u.refreshGrid_rhcw(u.flowdata.length,u.flowdata[0].length)}else if("cellRowChange"==o.type)u.refreshGridAll(o.data[0].length,o.data.length,o.data,o.config,o.range,o.ctrlType,o.ctrlValue,o.cdformat);else if("extend"==o.type)u.refreshGridAll(o.data[0].length,o.data.length,o.data,o.config,o.range,"dele",o.ctrlValue);else if("dele"==o.type){let e=$.extend(!0,{},o.ctrlValue);e.restore=!0,u.refreshGridAll(o.data[0].length,o.data.length,o.data,o.config,o.range,"extend",e)}else if("addRC"==o.type){let e=$.extend(!0,{},o.ctrlValue);"rightbottom"==e.direction&&(e.index=e.index+1),u.refreshGrid_adRC(o.data,o.config,"delRC",e,o.calc,o.filterObj,o.cf,o.af,o.freezen,o.dataVerification,o.hyperlink)}else if("delRC"==o.type){let e=$.extend(!0,{},o.ctrlValue);e.restore=!0,e.direction="lefttop",u.refreshGrid_adRC(o.data,o.config,"addRC",e,o.calc,o.filterObj,o.cf,o.af,o.freezen,o.dataVerification,o.hyperlink)}else if("deleteCell"==o.type)u.refreshGrid_deleteCell(o.data,o.config,o.ctrl,o.calc,o.filterObj,o.cf,o.dataVerification,o.hyperlink);else if("showHidRows"==o.type)u.config=o.config,u.luckysheetfile[w(o.sheetIndex)].config=o.config,u.saveParam("cg",o.sheetIndex,o.config.rowhidden,{k:"rowhidden"}),u.refreshGrid_rhcw(u.flowdata.length,u.flowdata[0].length);else if("showHidCols"==o.type)u.config=o.config,u.luckysheetfile[w(o.sheetIndex)].config=o.config,u.saveParam("cg",o.sheetIndex,o.config.colhidden,{k:"colhidden"}),u.refreshGrid_rhcw(u.flowdata.length,u.flowdata[0].length);else if("datachangeAll"==o.type)s.execFunctionGroup(),u.refreshGridAll(o.data[0].length,o.data.length,o.data,null,o.range,"datachangeAll",o.ctrlValue);else if("datachangeAll_filter_clear"==o.type)x(o.filter_save),$("#luckysheet-filter-options-sheet"+u.currentSheetIndex+" .luckysheet-filter-options").each(function(e){let t=$(this),r=o.optiongroups[e];I(t,r.optionstate,r.rowhidden,r.caljs,!1,r.st_r,r.ed_r,r.cindex,r.st_c,r.ed_c)}),u.saveParam("fsr",u.currentSheetIndex,{filter:o.optiongroups,filter_select:o.filter_save}),u.config=o.config,u.luckysheetfile[w(u.currentSheetIndex)].config=u.config,null==u.config.rowhidden&&(u.config.rowhidden={}),u.saveParam("cg",u.currentSheetIndex,u.config.rowhidden,{k:"rowhidden"}),u.refreshGrid_rhcw(u.flowdata.length,u.flowdata[0].length),$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide();else if("datachangeAll_filter"==o.type){let e=$("#luckysheet-filter-options-sheet"+u.currentSheetIndex+" .luckysheet-filter-options").eq(o.optionsindex),t=e.data("str"),r=e.data("edr"),a=e.data("cindex"),l=e.data("stc"),i=e.data("edc");I(e,d.hasKey(o.rowhidenPre),o.rowhidenPre,o.caljs,!0,t,r,a,l,i),u.config=o.config,u.luckysheetfile[w(u.currentSheetIndex)].config=u.config,null==u.config.rowhidden&&(u.config.rowhidden={}),u.saveParam("cg",u.currentSheetIndex,u.config.rowhidden,{k:"rowhidden"}),u.refreshGrid_rhcw(u.flowdata.length,u.flowdata[0].length),$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide()}else if("filtershow"==o.type)$("#luckysheet-filter-selected-sheet"+o.sheetIndex+", #luckysheet-filter-options-sheet"+o.sheetIndex).remove(),u.allowUpdate&&u.saveParam("all",o.sheetIndex,null,{k:"filter_select"});else if("pivotTable_change"==o.type)u.luckysheetfile[w(o.sheetIndex)].pivotTable=o.pivotTable,t.getCellData(o.sheetIndex),t.initialPivotManage(!0),t.refreshPivotTable();else if("addSheet"==o.type)e.deleteSheet(o.index),u.changeSheet(o.currentSheetIndex),$("#luckysheet-input-box").removeAttr("style"),$("#luckysheet-sheet-list, #luckysheet-rightclick-sheet-menu").hide();else if("copySheet"==o.type)e.deleteSheet(o.index),u.changeSheet(o.copyindex);else if("deleteSheet"==o.type){let t=!1;for(let e=0;e<u.luckysheetfile.length;e++)u.luckysheetfile[e].name==o.name&&(t=!0);t||(e.createSheetbydata(o,"isrenew"),$("#luckysheet-input-box").removeAttr("style"),$("#luckysheet-sheet-list, #luckysheet-rightclick-sheet-menu").hide())}else if("sheetName"==o.type)u.luckysheetfile[w(o.sheetIndex)].name=o.oldtxt,$("#luckysheet-sheets-item"+o.sheetIndex).find(".luckysheet-sheets-item-name").html(o.oldtxt),u.saveParam("all",o.sheetIndex,o.oldtxt,{k:"name"});else if("sheetColor"==o.type){u.luckysheetfile[w(o.sheetIndex)].color=o.oldcolor;let e=$("#luckysheet-sheets-item"+o.sheetIndex);e.find(".luckysheet-sheets-item-color").remove(),null!=o.oldcolor&&e.append('<div class="luckysheet-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: '+o.oldcolor+';"></div>'),u.saveParam("all",o.sheetIndex,o.oldcolor,{k:"color"})}else if("mergeChange"==o.type){let e={cfg:o.config};u.refreshGrid(o.data,o.range,e)}else if("updateDataVerification"==o.type)i.ref(o.currentDataVerification,o.historyDataVerification,o.sheetIndex);else if("updateDataVerificationOfCheckbox"==o.type)i.refOfCheckbox(o.currentDataVerification,o.historyDataVerification,o.sheetIndex,o.data,o.range);else if("updateHyperlink"==o.type)n.ref(o.currentHyperlink,o.historyHyperlink,o.sheetIndex,o.data,o.range);else if("updateCF"==o.type){let e=o.data.historyRules;for(let t=0;t<e.length;t++){let r=e[t].sheetIndex;u.luckysheetfile[w(r)].luckysheet_conditionformat_save=e[t].luckysheet_conditionformat_save,u.allowUpdate&&u.saveParam("all",r,e[t].luckysheet_conditionformat_save,{k:"luckysheet_conditionformat_save"})}r.ref()}else if("updateAF"==o.type){let e=o.data.historyRules,t=w(o.sheetIndex);u.luckysheetfile[t].luckysheet_alternateformat_save=$.extend(!0,[],e),u.refresh()}else if("borderChange"==o.type)null==o.config.borderInfo?u.saveParam("cg",o.sheetIndex,[],{k:"borderInfo"}):u.saveParam("cg",o.sheetIndex,o.config.borderInfo,{k:"borderInfo"}),u.config=o.config,u.luckysheetfile[w(o.sheetIndex)].config=u.config,u.refresh();else if("postil"==o.type){a.ref(o.data,o.rc);for(let e=0;e<o.rc.length;e++){let t=o.rc[e].split("_")[0],r=o.rc[e].split("_")[1];null!=o.data[t][r]&&null!=o.data[t][r].ps?a.buildPs(t,r,o.data[t][r].ps):a.buildPs(t,r,null)}}else"imageCtrl"==o.type?(l.images=$.extend(!0,{},o.images),l.allImagesShow(),l.ref()):"zoomChange"==o.type&&(u.zoomRatio=o.zoomRatio,u.saveParam("all",o.currentSheetIndex,o.zoomRatio,{k:"zoomRatio"}),m(),p());h(c),o.range&&(u.luckysheet_select_save=o.range,C()),u.clearjfundo=!0,refreshMenuButtonFocus();let f={...o,...{data:o.curdata,curdata:o.data}};y.createHookFunction("updated",f)},undo:function(){if(0==u.jfundo.length)return;let c=u.jfundo.pop();if(u.jfredo.push(c),u.clearjfundo=!1,u.hasSheet(c.sheetIndex)&&u.currentSheetIndex!=c.sheetIndex&&u.changeSheet(c.sheetIndex),"datachange"==c.type){s.execFunctionGroup();let e={cfg:c.curConfig,RowlChange:c.RowlChange,cdformat:c.curCdformat,dataVerification:c.curDataVerification,dynamicArray:c.curDynamicArray};v(c,"undo"),u.refreshGrid(c.curdata,c.range,e)}else if("pasteCut"==c.type)u.refreshGrid_pastcut(c.source,c.target,c.RowlChange);else if("rangechange"==c.type)v(c,"undo"),u.refreshRange(c.curdata,c.range,c.curCdformat);else if("resize"==c.type){u.config=c.curconfig,u.luckysheetfile[w(c.sheetIndex)].config=u.config,"resizeR"==c.ctrlType?u.saveParam("cg",c.sheetIndex,c.curconfig.rowlen,{k:"rowlen"}):"resizeC"==c.ctrlType&&u.saveParam("cg",c.sheetIndex,c.curconfig.columnlen,{k:"columnlen"});let e=$.extend(!0,{},c.curImages);u.luckysheetfile[w(c.sheetIndex)].images=e,u.saveParam("all",c.sheetIndex,e,{k:"images"}),l.images=e,l.allImagesShow(),u.refreshGrid_rhcw(u.flowdata.length,u.flowdata[0].length)}else if("cellRowChange"==c.type)u.refreshGridAll(c.curdata[0].length,c.curdata.length,c.curdata,c.curconfig,c.currange,c.ctrlType,c.ctrlValue,c.curCdformat);else if("extend"==c.type)u.rrefreshGridAll(c.curdata[0].length,c.curdata.length,c.curdata,c.curconfig,c.currange,c.ctrlType,c.ctrlValue);else if("dele"==c.type){$.extend(!0,{},c.ctrlValue).restore=!0,u.rrefreshGridAll(c.curdata[0].length,c.curdata.length,c.curdata,c.curconfig,c.currange,c.ctrlType,c.ctrlValue)}else if("addRC"==c.type)u.refreshGrid_adRC(c.curData,c.curConfig,"addRC",c.ctrlValue,c.curCalc,c.curFilterObj,c.curCf,c.curAf,c.curFreezen,c.curDataVerification,c.curHyperlink);else if("delRC"==c.type)u.refreshGrid_adRC(c.curData,c.curConfig,"delRC",c.ctrlValue,c.curCalc,c.curFilterObj,c.curCf,c.curAf,c.curFreezen,c.curDataVerification,c.curHyperlink);else if("deleteCell"==c.type)u.refreshGrid_deleteCell(c.curData,c.curConfig,c.ctrl,c.curCalc,c.curFilterObj,c.curCf,c.curDataVerification,c.curHyperlink);else if("showHidRows"==c.type)u.config=c.curconfig,u.luckysheetfile[w(c.sheetIndex)].config=c.curconfig,u.saveParam("cg",c.sheetIndex,c.curconfig.rowhidden,{k:"rowhidden"}),u.refreshGrid_rhcw(u.flowdata.length,u.flowdata[0].length);else if("showHidCols"==c.type)u.config=c.curconfig,u.luckysheetfile[w(c.sheetIndex)].config=c.curconfig,u.saveParam("cg",c.sheetIndex,c.curconfig.colhidden,{k:"colhidden"}),u.refreshGrid_rhcw(u.flowdata.length,u.flowdata[0].length);else if("datachangeAll"==c.type)s.execFunctionGroup(),u.refreshGridAll(c.curdata[0].length,c.curdata.length,c.curdata,null,c.currange,"datachangeAll",c.ctrlValue);else if("datachangeAll_filter_clear"==c.type)u.saveParam("fsc",u.currentSheetIndex,null),u.config=c.curconfig,u.luckysheetfile[w(u.currentSheetIndex)].config=u.config,u.saveParam("cg",u.currentSheetIndex,{},{k:"rowhidden"}),u.refreshGrid_rhcw(u.flowdata.length,u.flowdata[0].length),$("#luckysheet-filter-menu .luckysheet-filter-selected-input").hide().find("input").val(),$("#luckysheet-filter-selected span").data("type","0").data("type",null).text("无"),$("#luckysheet-filter-selected-sheet"+u.currentSheetIndex+", #luckysheet-filter-options-sheet"+u.currentSheetIndex).remove(),$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide();else if("datachangeAll_filter"==c.type){let e=$("#luckysheet-filter-options-sheet"+u.currentSheetIndex+" .luckysheet-filter-options").eq(c.optionsindex),t=e.data("str"),r=e.data("edr"),a=e.data("cindex"),l=e.data("stc"),i=e.data("edc");I(e,d.hasKey(c.rowhidden),c.rowhidden,c.caljs,!0,t,r,a,l,i),u.config=c.curconfig,u.luckysheetfile[w(u.currentSheetIndex)].config=u.config,u.saveParam("cg",u.currentSheetIndex,u.config.rowhidden,{k:"rowhidden"}),u.refreshGrid_rhcw(u.flowdata.length,u.flowdata[0].length),$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide()}else if("filtershow"==c.type)u.luckysheet_select_save=[c.filter_save],u.filterchage=!1,k(),u.filterchage=!0,u.saveParam("all",c.sheetIndex,c.filter_save,{k:"filter_select"});else if("pivotTable_change"==c.type)u.luckysheetfile[w(c.sheetIndex)].pivotTable=c.pivotTablecur,t.getCellData(c.sheetIndex),t.initialPivotManage(!0),t.refreshPivotTable();else if("addSheet"==c.type)e.createSheetbydata(c.sheetconfig),$("#luckysheet-input-box").removeAttr("style"),$("#luckysheet-sheet-list, #luckysheet-rightclick-sheet-menu").hide();else if("copySheet"==c.type)e.copySheet(c.copyindex);else if("deleteSheet"==c.type)e.deleteSheet(c.index),0==c.order?u.changeSheet(u.luckysheetfile[0].index):u.changeSheet(u.luckysheetfile[c.order-1].index),$("#luckysheet-input-box").removeAttr("style"),$("#luckysheet-sheet-list, #luckysheet-rightclick-sheet-menu").hide();else if("sheetName"==c.type)u.luckysheetfile[w(c.sheetIndex)].name=c.txt,$("#luckysheet-sheets-item"+c.sheetIndex).find(".luckysheet-sheets-item-name").html(c.txt),u.saveParam("all",c.sheetIndex,c.txt,{k:"name"});else if("sheetColor"==c.type){u.luckysheetfile[w(c.sheetIndex)].color=c.color;let e=$("#luckysheet-sheets-item"+c.sheetIndex);e.find(".luckysheet-sheets-item-color").remove(),null!=c.color&&e.append('<div class="luckysheet-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: '+c.color+';"></div>'),u.saveParam("all",c.sheetIndex,c.color,{k:"color"})}else if("mergeChange"==c.type){let e={cfg:c.curConfig};u.refreshGrid(c.curData,c.range,e)}else if("updateDataVerification"==c.type)i.ref(c.historyDataVerification,c.currentDataVerification,c.sheetIndex);else if("updateDataVerificationOfCheckbox"==c.type)i.refOfCheckbox(c.historyDataVerification,c.currentDataVerification,c.sheetIndex,c.curData,c.range);else if("updateHyperlink"==c.type)n.ref(c.historyHyperlink,c.currentHyperlink,c.sheetIndex,c.curData,c.range);else if("updateCF"==c.type){let e=c.data.currentRules;for(let t=0;t<e.length;t++){let r=e[t].sheetIndex;u.luckysheetfile[w(r)].luckysheet_conditionformat_save=e[t].luckysheet_conditionformat_save,u.allowUpdate&&u.saveParam("all",r,e[t].luckysheet_conditionformat_save,{k:"luckysheet_conditionformat_save"})}r.ref()}else if("updateAF"==c.type){let e=c.data.currentRules,t=w(c.sheetIndex);u.luckysheetfile[t].luckysheet_alternateformat_save=$.extend(!0,[],e),u.refresh()}else if("borderChange"==c.type)u.saveParam("cg",c.sheetIndex,c.curconfig.borderInfo,{k:"borderInfo"}),u.config=c.curconfig,u.luckysheetfile[w(c.sheetIndex)].config=u.config,setTimeout(function(){luckysheetrefreshgrid()},1);else if("postil"==c.type){a.ref(c.curdata,c.rc);for(let e=0;e<c.rc.length;e++){let t=c.rc[e].split("_")[0],r=c.rc[e].split("_")[1];null!=c.curdata[t][r]&&null!=c.curdata[t][r].ps?a.buildPs(t,r,c.curdata[t][r].ps):a.buildPs(t,r,null)}}else"imageCtrl"==c.type?(l.images=$.extend(!0,{},c.curImages),l.allImagesShow(),l.ref()):"zoomChange"==c.type&&(u.zoomRatio=c.curZoomRatio,u.saveParam("all",c.currentSheetIndex,c.curZoomRatio,{k:"zoomRatio"}),m(),p());c.range&&(u.luckysheet_select_save=c.range,C()),u.clearjfundo=!0,refreshMenuButtonFocus()}}});
//# sourceMappingURL=../sourcemaps/controllers/controlHistory.js.map
