/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../utils/util","../methods/get","../widgets/constant","../widgets/select","../methods/luckysheetConfigsetting","../methods/format","../methods/setdata","../widgets/tooltip","../methods/func_methods","../store","../locale/locale"],function(e,l,t,c,s,a,r,n,h,o,i){"use strict";const{replaceHtml:u,chatatABC:p}=e,{getSheetIndex:d}=l,{modelHTML:k,keycode:y}=t,{selectHightlightShow:f}=c,{isEditMode:v}=s,{valueShowEs:g}=a,{setcellvalue:b}=r;return{createDialog:function(e){$("#luckysheet-modal-dialog-mask").hide(),$("#luckysheet-search-replace").remove();const l=i(),t=l.findAndReplace,c=l.button;let s='<div class="tabBox"><span id="searchTab">'+t.find+'</span><span id="replaceTab">'+t.replace+'</span></div><div class="ctBox"><div class="inputBox"><div class="textboxs" id="searchInput">'+t.findTextbox+'：<input class="formulaInputFocus" spellcheck="false" value=""/></div><div class="textboxs" id="replaceInput">'+t.replaceTextbox+'：<input class="formulaInputFocus" spellcheck="false" value=""/></div><div class="checkboxs"><div id="regCheck"><input type="checkbox"/><span>'+t.regexTextbox+'</span></div><div id="wordCheck"><input type="checkbox"/><span>'+t.wholeTextbox+'</span></div><div id="caseCheck"><input type="checkbox"/><span>'+t.distinguishTextbox+'</span></div></div></div><div class="btnBox"><button id="replaceAllBtn" class="btn btn-default">'+t.allReplaceBtn+'</button><button id="replaceBtn" class="btn btn-default">'+t.replaceBtn+'</button><button id="searchAllBtn" class="btn btn-default">'+t.allFindBtn+'</button><button id="searchNextBtn" class="btn btn-default">'+t.findBtn+"</button></div></div>";$("body").append(u(k,{id:"luckysheet-search-replace",addclass:"luckysheet-search-replace",title:"",content:s,botton:'<button class="btn btn-default luckysheet-model-close-btn">'+c.close+"</button>",style:"z-index:100003",close:c.close}));let a=$("#luckysheet-search-replace").find(".luckysheet-modal-dialog-content").css("min-width",500).end(),r=a.outerHeight(),n=a.outerWidth(),h=$(window).width(),o=$(window).height(),p=$(document).scrollLeft(),d=$(document).scrollTop();$("#luckysheet-search-replace").css({left:(h+p-n)/2,top:(o+d-r)/3}).show(),"0"==e?($("#luckysheet-search-replace #searchTab").addClass("on").siblings().removeClass("on"),$("#luckysheet-search-replace #replaceInput").hide(),$("#luckysheet-search-replace #replaceAllBtn").hide(),$("#luckysheet-search-replace #replaceBtn").hide()):"1"==e&&($("#luckysheet-search-replace #replaceTab").addClass("on").siblings().removeClass("on"),$("#luckysheet-search-replace #replaceInput").show(),$("#luckysheet-search-replace #replaceAllBtn").show(),$("#luckysheet-search-replace #replaceBtn").show())},init:function(){let e=this;$(document).off("click.SRtabBoxspan").on("click.SRtabBoxspan","#luckysheet-search-replace .tabBox span",function(){$(this).addClass("on").siblings().removeClass("on");let e=$(this).attr("id");"searchTab"==e?($("#luckysheet-search-replace #replaceInput").hide(),$("#luckysheet-search-replace #replaceAllBtn").hide(),$("#luckysheet-search-replace #replaceBtn").hide(),$("#luckysheet-search-replace #searchInput input").focus()):"replaceTab"==e&&($("#luckysheet-search-replace #replaceInput").show(),$("#luckysheet-search-replace #replaceAllBtn").show(),$("#luckysheet-search-replace #replaceBtn").show(),$("#luckysheet-search-replace #replaceInput input").focus())}),$(document).off("keyup.SRsearchInput").on("keyup.SRsearchInput","#luckysheet-search-replace #searchInput input",function(l){l.keyCode==y.ENTER&&e.searchNext()}),$(document).off("click.SRsearchNextBtn").on("click.SRsearchNextBtn","#luckysheet-search-replace #searchNextBtn",function(){e.searchNext()}),$(document).off("click.SRsearchAllBtn").on("click.SRsearchAllBtn","#luckysheet-search-replace #searchAllBtn",function(){e.searchAll()}),$(document).off("click.SRsearchAllboxItem").on("click.SRsearchAllboxItem","#luckysheet-search-replace #searchAllbox .boxItem",function(){$(this).addClass("on").siblings().removeClass("on");let e=$(this).attr("data-row"),l=$(this).attr("data-col"),t=$(this).attr("data-sheetIndex");t!=o.currentSheetIndex&&o.changeSheet(t),o.luckysheet_select_save=[{row:[e,e],column:[l,l]}],f();let c=$("#luckysheet-cell-main").scrollLeft(),s=$("#luckysheet-cell-main").scrollTop(),a=$("#luckysheet-cell-main").height(),r=$("#luckysheet-cell-main").width(),n=o.visibledatarow[e],h=e-1==-1?0:o.visibledatarow[e-1],i=o.visibledatacolumn[l],u=l-1==-1?0:o.visibledatacolumn[l-1];i-c-r+20>0?$("#luckysheet-scrollbar-x").scrollLeft(i-r+20):u-c-20<0&&$("#luckysheet-scrollbar-x").scrollLeft(u-20),n-s-a+20>0?$("#luckysheet-scrollbar-y").scrollTop(n-a+20):h-s-20<0&&$("#luckysheet-scrollbar-y").scrollTop(h-20)}),$(document).off("click.SRreplaceBtn").on("click.SRreplaceBtn","#luckysheet-search-replace #replaceBtn",function(){e.replace()}),$(document).off("click.SRreplaceAllBtn").on("click.SRreplaceAllBtn","#luckysheet-search-replace #replaceAllBtn",function(){e.replaceAll()})},searchNext:function(){let e=$("#luckysheet-search-replace #searchInput input").val();if(""==e||null==e)return;const l=i().findAndReplace;let t;t=0==o.luckysheet_select_save.length||1==o.luckysheet_select_save.length&&o.luckysheet_select_save[0].row[0]==o.luckysheet_select_save[0].row[1]&&o.luckysheet_select_save[0].column[0]==o.luckysheet_select_save[0].column[1]?[{row:[0,o.flowdata.length-1],column:[0,o.flowdata[0].length-1]}]:$.extend(!0,[],o.luckysheet_select_save);let c=this.getSearchIndexArr(e,t);if(0==c.length)return void(v()?alert(l.noFindTip):n.info(l.noFindTip,""));let s=0;if(0==o.luckysheet_select_save.length||1==o.luckysheet_select_save.length&&o.luckysheet_select_save[0].row[0]==o.luckysheet_select_save[0].row[1]&&o.luckysheet_select_save[0].column[0]==o.luckysheet_select_save[0].column[1]){if(0==o.luckysheet_select_save.length)s=0;else for(let e=0;e<c.length;e++)if(c[e].r==o.luckysheet_select_save[0].row[0]&&c[e].c==o.luckysheet_select_save[0].column[0]){s=e==c.length-1?0:e+1;break}o.luckysheet_select_save=[{row:[c[s].r,c[s].r],column:[c[s].c,c[s].c]}]}else{let e=t[t.length-1].row_focus,l=t[t.length-1].column_focus;for(let t=0;t<c.length;t++)if(c[t].r==e&&c[t].c==l){s=t==c.length-1?0:t+1;break}for(let e=0;e<t.length;e++){let l=t[e].row[0],a=t[e].row[1],r=t[e].column[0],n=t[e].column[1];if(c[s].r>=l&&c[s].r<=a&&c[s].c>=r&&c[s].c<=n){let l=t[e];l.row_focus=c[s].r,l.column_focus=c[s].c,t.splice(e,1),t.push(l);break}}o.luckysheet_select_save=t}f();let a=$("#luckysheet-cell-main").scrollLeft(),r=$("#luckysheet-cell-main").scrollTop(),h=$("#luckysheet-cell-main").height(),u=$("#luckysheet-cell-main").width(),p=o.visibledatarow[c[s].r],d=c[s].r-1==-1?0:o.visibledatarow[c[s].r-1],k=o.visibledatacolumn[c[s].c],y=c[s].c-1==-1?0:o.visibledatacolumn[c[s].c-1];k-a-u+20>0?$("#luckysheet-scrollbar-x").scrollLeft(k-u+20):y-a-20<0&&$("#luckysheet-scrollbar-x").scrollLeft(y-20),p-r-h+20>0?$("#luckysheet-scrollbar-y").scrollTop(p-h+20):d-r-20<0&&$("#luckysheet-scrollbar-y").scrollTop(d-20),$("#searchAllbox").is(":visible")&&$("#luckysheet-search-replace #searchAllbox .boxItem").removeClass("on")},searchAll:function(){const e=i().findAndReplace;$("#luckysheet-search-replace #searchAllbox").remove();let l,t=$("#luckysheet-search-replace #searchInput input").val();if(""==t||null==t)return;l=0==o.luckysheet_select_save.length||1==o.luckysheet_select_save.length&&o.luckysheet_select_save[0].row[0]==o.luckysheet_select_save[0].row[1]&&o.luckysheet_select_save[0].column[0]==o.luckysheet_select_save[0].column[1]?[{row:[0,o.flowdata.length-1],column:[0,o.flowdata[0].length-1]}]:$.extend(!0,[],o.luckysheet_select_save);let c=this.getSearchIndexArr(t,l);if(0==c.length)return void(v()?alert(e.noFindTip):n.info(e.noFindTip,""));let s="";for(let e=0;e<c.length;e++){let l=g(c[e].r,c[e].c,o.flowdata).toString();l.indexOf("</")>-1&&l.indexOf(">")>-1?s+='<div class="boxItem" data-row="'+c[e].r+'" data-col="'+c[e].c+'" data-sheetIndex="'+o.currentSheetIndex+'"><span>'+o.luckysheetfile[d(o.currentSheetIndex)].name+"</span><span>"+p(c[e].c)+(c[e].r+1)+"</span><span>"+l+"</span></div>":s+='<div class="boxItem" data-row="'+c[e].r+'" data-col="'+c[e].c+'" data-sheetIndex="'+o.currentSheetIndex+'"><span>'+o.luckysheetfile[d(o.currentSheetIndex)].name+"</span><span>"+p(c[e].c)+(c[e].r+1)+'</span><span title="'+l+'">'+l+"</span></div>"}$('<div id="searchAllbox"><div class="boxTitle"><span>'+e.searchTargetSheet+"</span><span>"+e.searchTargetCell+"</span><span>"+e.searchTargetValue+'</span></div><div class="boxMain">'+s+"</div></div>").appendTo($("#luckysheet-search-replace")),$("#luckysheet-search-replace #searchAllbox .boxItem").eq(0).addClass("on").siblings().removeClass("on"),o.luckysheet_select_save=[{row:[c[0].r,c[0].r],column:[c[0].c,c[0].c]}],f()},getSearchIndexArr:function(e,l){let t=[],c={},s=!1;$("#luckysheet-search-replace #regCheck input[type='checkbox']").is(":checked")&&(s=!0);let a=!1;$("#luckysheet-search-replace #wordCheck input[type='checkbox']").is(":checked")&&(a=!0);let r=!1;$("#luckysheet-search-replace #caseCheck input[type='checkbox']").is(":checked")&&(r=!0);for(let n=0;n<l.length;n++){let i=l[n].row[0],u=l[n].row[1],p=l[n].column[0],d=l[n].column[1];for(let l=i;l<=u;l++)for(let n=p;n<=d;n++){if(null!=o.flowdata[l][n]){let i=g(l,n,o.flowdata);if(0==i&&(i=i.toString()),null!=i&&""!=i)if(i=i.toString(),a)if(r)e==i&&(l+"_"+n in c||(c[l+"_"+n]=0,t.push({r:l,c:n})));else{e.toLowerCase()==i.toLowerCase()&&(l+"_"+n in c||(c[l+"_"+n]=0,t.push({r:l,c:n})))}else if(s){let s;(s=r?new RegExp(h.getRegExpStr(e),"g"):new RegExp(h.getRegExpStr(e),"ig")).test(i)&&(l+"_"+n in c||(c[l+"_"+n]=0,t.push({r:l,c:n})))}else if(r){new RegExp(h.getRegExpStr(e),"g").test(i)&&(l+"_"+n in c||(c[l+"_"+n]=0,t.push({r:l,c:n})))}else{new RegExp(h.getRegExpStr(e),"ig").test(i)&&(l+"_"+n in c||(c[l+"_"+n]=0,t.push({r:l,c:n})))}}}}return t},replace:function(){const e=i().findAndReplace;if(!o.allowEdit)return void n.info(e.modeTip,"");let l,t=$("#luckysheet-search-replace #searchInput input").val();if(""==t||null==t)return void(v()?alert(e.searchInputTip):n.info(e.searchInputTip,""));l=0==o.luckysheet_select_save.length||1==o.luckysheet_select_save.length&&o.luckysheet_select_save[0].row[0]==o.luckysheet_select_save[0].row[1]&&o.luckysheet_select_save[0].column[0]==o.luckysheet_select_save[0].column[1]?[{row:[0,o.flowdata.length-1],column:[0,o.flowdata[0].length-1]}]:$.extend(!0,[],o.luckysheet_select_save);let c=this.getSearchIndexArr(t,l);if(0==c.length)return void(v()?alert(e.noReplceTip):n.info(e.noReplceTip,""));let s=null,a=o.luckysheet_select_save[o.luckysheet_select_save.length-1],r=a.row_focus,u=a.column_focus;for(let e=0;e<c.length;e++)if(c[e].r==r&&c[e].c==u){s=e;break}if(null==s){if(0==c.length)return void(v()?alert(e.noMatchTip):n.info(e.noMatchTip,""));s=0}let p=!1;$("#luckysheet-search-replace #regCheck input[type='checkbox']").is(":checked")&&(p=!0);let d=!1;$("#luckysheet-search-replace #wordCheck input[type='checkbox']").is(":checked")&&(d=!0);let k=!1;$("#luckysheet-search-replace #caseCheck input[type='checkbox']").is(":checked")&&(k=!0);let y,_,x=$("#luckysheet-search-replace #replaceInput input").val(),m=o.deepCopyFlowData(o.flowdata);if(d){y=c[s].r,_=c[s].c,b(y,_,m,x)}else{let e;e=k?new RegExp(h.getRegExpStr(t),"g"):new RegExp(h.getRegExpStr(t),"ig"),y=c[s].r,_=c[s].c;let l=g(y,_,m).toString().replace(e,x);b(y,_,m,l)}o.luckysheet_select_save=[{row:[y,y],column:[_,_]}],$("#luckysheet-search-replace #searchAllbox").is(":visible")&&$("#luckysheet-search-replace #searchAllbox").hide(),o.refeshRange(m,o.luckysheet_select_save),f();let w=$("#luckysheet-cell-main").scrollLeft(),T=$("#luckysheet-cell-main").scrollTop(),I=$("#luckysheet-cell-main").height(),R=$("#luckysheet-cell-main").width(),S=o.visibledatarow[y],A=y-1==-1?0:o.visibledatarow[y-1],B=o.visibledatacolumn[_],C=_-1==-1?0:o.visibledatacolumn[_-1];B-w-R+20>0?$("#luckysheet-scrollbar-x").scrollLeft(B-R+20):C-w-20<0&&$("#luckysheet-scrollbar-x").scrollLeft(C-20),S-T-I+20>0?$("#luckysheet-scrollbar-y").scrollTop(S-I+20):A-T-20<0&&$("#luckysheet-scrollbar-y").scrollTop(A-20)},replaceAll:function(){const e=i().findAndReplace;if(!o.allowEdit)return void n.info(e.modeTip,"");let l,t=$("#luckysheet-search-replace #searchInput input").val();if(""==t||null==t)return void(v()?alert(e.searchInputTip):n.info(e.searchInputTip,""));l=0==o.luckysheet_select_save.length||1==o.luckysheet_select_save.length&&o.luckysheet_select_save[0].row[0]==o.luckysheet_select_save[0].row[1]&&o.luckysheet_select_save[0].column[0]==o.luckysheet_select_save[0].column[1]?[{row:[0,o.flowdata.length-1],column:[0,o.flowdata[0].length-1]}]:$.extend(!0,[],o.luckysheet_select_save);let c=this.getSearchIndexArr(t,l);if(0==c.length)return void(v()?alert(e.noReplceTip):n.info(e.noReplceTip,""));let s=!1;$("#luckysheet-search-replace #regCheck input[type='checkbox']").is(":checked")&&(s=!0);let a=!1;$("#luckysheet-search-replace #wordCheck input[type='checkbox']").is(":checked")&&(a=!0);let r=!1;$("#luckysheet-search-replace #caseCheck input[type='checkbox']").is(":checked")&&(r=!0);let p=$("#luckysheet-search-replace #replaceInput input").val(),d=o.deepCopyFlowData(o.flowdata);if(a)for(let e=0;e<c.length;e++){let t=c[e].r,s=c[e].c;b(t,s,d,p),l.push({row:[t,t],column:[s,s]})}else{let e;e=r?new RegExp(h.getRegExpStr(t),"g"):new RegExp(h.getRegExpStr(t),"ig");for(let t=0;t<c.length;t++){let s=c[t].r,a=c[t].c,r=g(s,a,d).toString().replace(e,p);b(s,a,d,r),l.push({row:[s,s],column:[a,a]})}}$("#luckysheet-search-replace #searchAllbox").is(":visible")&&$("#luckysheet-search-replace #searchAllbox").hide(),o.refreshRange(d,l),o.luckysheet_select_save=$.extend(!0,[],l),f();let k=u(e.successTip,{xlength:c.length});v()?alert(k):n.info(k,"")}}});
//# sourceMappingURL=../sourcemaps/controllers/searchReplace.js.map
