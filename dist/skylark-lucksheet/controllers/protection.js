/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../store","../locale/locale","../widgets/constant","../methods/get","../methods/set","../methods/protection_methods","../widgets/resize","../widgets/dataVerificationCtrl","../utils/util","../widgets/select","../widgets/tooltip"],function(e,t,o,l,n,i,c,s,a,r,d){"use strict";const{modelHTML:u}=o,{getSheetIndex:h}=l,{setluckysheet_scroll_status:p}=n,{replaceHtml:k,transformRangeToAbsolute:g,openSelfModel:m}=a,{selectionCopyShow:y}=r;let v=!1,f=!1,w=[],R=!0,b=null,I=null,x=null,P=!0,C={};const A=["selectLockedCells","selectunLockedCells","formatCells","formatColumns","formatRows","insertColumns","insertRows","insertHyperlinks","deleteColumns","deleteRows","sort","filter","usePivotTablereports","editObjects","editScenarios"];function T(e){const o=t(),l=o.protection,n=o.button;let i=e.name,c=e.sqref,s=e.password,a="";null!=s&&s.length>0&&(a='<i class="icon iconfont luckysheet-iconfont-bianji2" title="'+l.rangeItemHasPassword+'"></i>');let r=`\n        <div class="luckysheet-protection-rangeItem" title="${l.rangeItemDblclick}">\n            <div class="luckysheet-protection-rangeItem-del" title="${n.delete}">\n                <i class="icon iconfont luckysheet-iconfont-shanchu"></i>\n            </div>\n            <div class="luckysheet-protection-rangeItem-name" title="${i}">\n                ${i}${a}\n            </div>\n            <div class="luckysheet-protection-rangeItem-range" title="${c}">\n                ${c}\n            </div>\n            <div class="luckysheet-protection-rangeItem-update" title="${n.update}">\n                <i class="icon iconfont luckysheet-iconfont-bianji"></i>\n            </div>\n        </div>\n    `;$("#luckysheet-protection-rangeItem-container").append(r)}function N(e){if(f)return;f=!0;let o=t(),l=o.protection;const n=o.button;$("body").append(k(u,{id:"luckysheet-protection-rangeItem-dialog",addclass:"luckysheet-protection-rangeItem-dialog",title:l.allowRangeTitle,content:`\n            <div class="luckysheet-protection-rangeItem-content">\n                <div class="luckysheet-slider-protection-row">\n                    <div class="luckysheet-slider-protection-column luckysheet-protection-column-3x">\n                        ${l.allowRangeAddTitle}\n                    </div>\n                    <div class="luckysheet-slider-protection-column luckysheet-protection-column-7x" style="left:30%">\n                        <input class="luckysheet-protection-rangeItemiInput" id="protection-allowRangeAdd-title"  placeHolder="${l.allowRangeAddtitleDefault}">\n                    </div>\n                </div>\n                <div class="luckysheet-slider-protection-row">\n                    <div class="luckysheet-slider-protection-column luckysheet-protection-column-3x">\n                        ${l.allowRangeAddSqrf}\n                    </div>\n                    <div class="luckysheet-slider-protection-column luckysheet-protection-column-7x" style="left:30%">\n                        <div id="protection-allowRangeAdd-range" class="range">\n                            <input class="formulaInputFocus" spellcheck="false" placeHolder="${l.selectCellRangeHolder}">\n                            <i class="fa fa-table" aria-hidden="true" title="${l.selectCellRange}"></i>\n                        </div>\n                    </div>\n                </div>\n                <div class="luckysheet-slider-protection-row">\n                    <div class="luckysheet-slider-protection-column luckysheet-protection-column-3x">\n                        ${l.allowRangeAddTitlePassword}\n                    </div>\n                    <div class="luckysheet-slider-protection-column luckysheet-protection-column-7x" style="left:30%">\n                        <input class="luckysheet-protection-rangeItemiInput" id="protection-allowRangeAdd-password"  placeHolder="${l.enterPassword}">\n                    </div>\n                </div>\n                <div class="luckysheet-slider-protection-row">\n                    <div class="luckysheet-slider-protection-column luckysheet-protection-column-3x">\n                        ${l.allowRangeAddTitleHint}\n                    </div>\n                    <div class="luckysheet-slider-protection-column luckysheet-protection-column-7x" style="left:30%">\n                        <textarea class="luckysheet-protection-rangeItemTextarea" id="protection-allowRangeAdd-hint"  placeHolder="${l.allowRangeAddTitleHintTitle}"></textarea>\n                    </div>\n                </div>\n            </div>\n        `,botton:`<button id="luckysheet-protection-rangeItem-confirm" class="btn btn-primary">${n.insert}</button>\n                    <button class="btn btn-default luckysheet-model-close-btn">${n.cancel}</button>`,style:"z-index:100003"}))}function H(e){null==e&&(e={});for(let t=0;t<A.length;t++){let o=A[t],l="luckysheet-protection-check-"+o,n=e[o];null==n&&(n=0),null==n&&o in{selectLockedCells:1,selectunLockedCells:1}&&(n=1),$("#"+l).prop("checked",1==n)}null!=e.password&&e.password.length>0?"None"==e.algorithmName||null==e.algorithmName?$("#protection-password").val(e.password):$("#protection-password").val("••••••••"):$("#protection-password").val("");let t=e.sheet;null==e.sheet&&(t=0),$("#protection-swichProtectionState").prop("checked",1==t);let o=e.hintText;null==o&&(o=""),$("#protection-hint").val(o),w=[],$("#luckysheet-protection-rangeItem-container").empty();let l=e.allowRangeList;if(null!=l&&l.length>0)for(let e=0;e<l.length;e++){let t=l[e];T(t),w.push(t)}}function V(){$("#luckysheet-protection-rangeItem-dialog").hide(),$("#luckysheet-modal-dialog-slider-protection").hide(),c()}return Object.assign({openProtectionModal:function(o){if(v||(function(e){const o=t(),l=o.protection,n=o.button;let i="";for(let e=0;e<A.length;e++){let t=A[e];i+=`\n            <div class="luckysheet-slider-protection-row" style="height:18px;">\n                <div class="luckysheet-slider-protection-column luckysheet-protection-column-10x">\n                <label for="luckysheet-protection-check-${t}"><input id="luckysheet-protection-check-${t}" name="luckysheet-protection-check-${t}" type="checkbox">${l[t]}</label>\n                </div>\n            </div>\n        `}const c=`\n    <div id="luckysheet-modal-dialog-slider-protection" class="luckysheet-modal-dialog-slider luckysheet-modal-dialog-slider-pivot" style="display:none;">\n        <div class="luckysheet-modal-dialog-slider-title"> <span>${l.protectiontTitle}</span> <span id="luckysheet-modal-dialog-protection-close" title="${n.close}"><i class="fa fa-times" aria-hidden="true"></i></span> </div>\n        <div class="luckysheet-modal-dialog-slider-content">\n            <div class="luckysheet-slider-protection-config" style="top:10px;height:115px">\n                <div class="luckysheet-slider-protection-row">\n                    <div class="luckysheet-slider-protection-column luckysheet-protection-column-10x">\n                    <label for="protection-swichProtectionState"><input id="protection-swichProtectionState" name="protection-swichProtectionState" type="checkbox">${l.swichProtectionTip}</label>\n                    </div>\n                </div>\n                <div class="luckysheet-slider-protection-row" style="height:23px;">\n                    <div class="luckysheet-slider-protection-column" style="width:98%;">\n                        <input class="luckysheet-protection-input" id="protection-password"  placeHolder="${l.enterPassword}">\n                    </div>\n                </div>\n                <div class="luckysheet-slider-protection-row" style="height:47px;margin-top:4px;">\n                    <div class="luckysheet-slider-protection-column" style="width:98%;">\n                        <textarea class="luckysheet-protection-textarea" id="protection-hint"  placeHolder="${l.enterHintTitle}"></textarea>\n                    </div>\n                </div>\n            </div>\n            <div class="luckysheet-slider-protection-config" style="top:130px;height:290px;border-top:1px solid #c5c5c5">\n                <div class="luckysheet-slider-protection-row" style="height:20px;">\n                    ${l.authorityTitle}\n                </div>\n                ${i}\n            </div>\n            <div class="luckysheet-slider-protection-config" style="top:440px;bottom:45px;border-top:1px solid #c5c5c5">\n                <div class="luckysheet-slider-protection-row" style="height:25px;">\n                    <div class="luckysheet-slider-protection-column luckysheet-protection-column-7x" style="left:0px;line-height: 25px;">\n                        ${l.allowRangeTitle}\n                    </div>\n                    <div class="luckysheet-slider-protection-column luckysheet-protection-column-3x" style="left:70%;">\n                        <div class="luckysheet-slider-protection-ok luckysheet-slider-protection-addRange" id="luckysheet-slider-protection-addRange">\n                            ${l.allowRangeAdd}\n                        </div>\n                    </div>\n                </div>\n\n                <div id="luckysheet-protection-rangeItem-container" class="luckysheet-slider-protection-row" style="top:25px;bottom:0px;position:absolute">\n                   \n                </div>\n            </div>\n            <div class="luckysheet-slider-protection-config" style="bottom:0px;height:45px">\n                <div class="luckysheet-slider-protection-column luckysheet-protection-column-5x" style="left:0px;">\n                    <div class="luckysheet-slider-protection-ok" id="luckysheet-slider-protection-ok">\n                        ${n.confirm}\n                    </div>\n                </div>\n                <div class="luckysheet-slider-protection-column luckysheet-protection-column-5x" style="left:50%;">\n                    <div class="luckysheet-slider-protection-cancel" id="luckysheet-slider-protection-cancel">\n                        ${n.cancel}\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n    `;$("body").append(c),$("body").append(k(u,{id:"luckysheet-protection-sheet-validation",addclass:"luckysheet-protection-sheet-validation",title:l.validationTitle,content:`\n            <div class="luckysheet-slider-protection-row">\n                <div class="luckysheet-slider-protection-column luckysheet-protection-column-10x">\n                    ${l.validationTips}\n                </div>\n            </div>\n            <div class="luckysheet-slider-protection-row" style="margin-top:20px">\n                <div class="luckysheet-slider-protection-column luckysheet-protection-column-10x">\n                    <input type="password" class="luckysheet-protection-rangeItemiInput" placeHolder="${l.validationInputHint}">\n                </div>\n            </div>\n        `,botton:`<button id="luckysheet-protection-sheet-validation-confirm" class="btn btn-primary">${n.confirm}</button>\n                    <button class="btn btn-default luckysheet-model-close-btn">${n.cancel}</button>`,style:"z-index:100003"}))}(),function(o){const l=t(),n=l.protection,i=l.button;$("#luckysheet-slider-protection-ok").click(function(){let e=$("#protection-password").val(),t=$("#protection-swichProtectionState").is(":checked"),o=$("#protection-hint").val(),l=x,n={};null!=l&&null!=l.config&&null!=l.config.authority&&(n=l.config.authority);let i={};"••••••••"!=e?(i.password=e,i.algorithmName="None",i.saltValue=null):null!=n?(i.algorithmName=n.algorithmName,i.saltValue=n.saltValue,i.password=n.password):(i.algorithmName="None",i.saltValue=null,i.password=""),i.hintText=o,i.sheet=1==t?1:0;for(let e=0;e<A.length;e++){let t=A[e],o=$("#luckysheet-protection-check-"+t).is(":checked");i[t]=1==o?1:0}i.allowRangeList=w,w=[],P=!0,null==l.config&&(l.config={}),l.config.authority=i,C={},V()}),$("#luckysheet-slider-protection-cancel, #luckysheet-modal-dialog-protection-close").click(function(){V()}),$("#luckysheet-slider-protection-addRange").click(function(){N(),R=!0,$("#luckysheet-protection-rangeItem-confirm").html(i.insert),m("luckysheet-protection-rangeItem-dialog"),$("#protection-allowRangeAdd-title").val("Default"+w.length),$("#protection-allowRangeAdd-range input").val(""),$("#protection-allowRangeAdd-password").val(""),$("#protection-allowRangeAdd-hint").val("")}),$(document).off("click.luckysheetProtection.rangeItemUpdate").on("click.luckysheetProtection.rangeItemUpdate","#luckysheet-protection-rangeItem-container .luckysheet-protection-rangeItem-update",function(e){N(),R=!1,$("#luckysheet-protection-rangeItem-confirm").html(i.update),m("luckysheet-protection-rangeItem-dialog");let t=$(e.target).closest(".luckysheet-protection-rangeItem"),o=$("#luckysheet-protection-rangeItem-container").find("> div.luckysheet-protection-rangeItem").index(t),l=w[o];b=o,$("#protection-allowRangeAdd-title").val(l.name),$("#protection-allowRangeAdd-range input").val(l.sqref),"None"==l.algorithmName?$("#protection-allowRangeAdd-password").val(l.password):$("#protection-allowRangeAdd-password").val("••••••••"),$("#protection-allowRangeAdd-hint").val(l.hintText)}),$(document).off("click.luckysheetProtection.rangeItemDelete").on("click.luckysheetProtection.rangeItemDelete","#luckysheet-protection-rangeItem-container .luckysheet-protection-rangeItem-del",function(e){let t=$(e.target).closest(".luckysheet-protection-rangeItem"),o=$("#luckysheet-protection-rangeItem-container").find("> div.luckysheet-protection-rangeItem").index(t);w[o],w.splice(o,1),t.remove()}),$(document).off("click.luckysheetProtection.rangeItemConfirm").on("click.luckysheetProtection.rangeItemConfirm","#luckysheet-protection-rangeItem-confirm",function(){let e=$("#protection-allowRangeAdd-title").val(),t=$("#protection-allowRangeAdd-range input").val(),o=$("#protection-allowRangeAdd-password").val(),l=$("#protection-allowRangeAdd-hint").val();if(0==e.length)return void alert(n.rangeItemErrorTitleNull);let i=s.getRangeByTxt(t);if(0!=t.length)if(0!=i.length){if(t=g(t),R){let n={name:e,password:o,hintText:l,algorithmName:"None",saltValue:null,checkRangePasswordUrl:null,sqref:t};T(n),w.push(n)}else{let i=b,c=w[i];c.name=e,c.sqref=t,c.hintText=l,"••••••••"!=o&&(c.password=o,c.algorithmName="None");let s=$("#luckysheet-protection-rangeItem-container").find("> div.luckysheet-protection-rangeItem").eq(i),a=s.find(".luckysheet-protection-rangeItem-name"),r="";null!=o&&o.length>0&&(r='<i class="icon iconfont luckysheet-iconfont-bianji2" title="'+n.rangeItemHasPassword+'"></i>'),a.html(e+r).attr("title",e),s.find(".luckysheet-protection-rangeItem-range").html(t).attr("title",t)}$("#luckysheet-protection-rangeItem-dialog").hide(),$("#luckysheet-modal-dialog-mask").hide()}else alert(n.rangeItemErrorRange);else alert(n.rangeItemErrorRangeNull)}),$(document).off("click.luckysheetProtection.validationConfirm").on("click.luckysheetProtection.validationConfirm","#luckysheet-protection-sheet-validation-confirm",function(e){let t=$("#luckysheet-protection-sheet-validation"),o=I;if(null==o)return H(I),t.hide(),$("#luckysheet-modal-dialog-mask").hide(),$("#luckysheet-modal-dialog-slider-protection").show(),void c();let l=t.find("input").val();if(null!=l&&0!=l.length){if(null!=o.algorithmName&&"None"!=o.algorithmName)if(null!=o.saltValue&&o.saltValue.length>0){var i=CryptoApi.getHasher(o.algorithmName);l=CryptoApi.hmac(o.saltValue,l,i)}else l=CryptoApi.hash(o.algorithmName,l);l==o.password?(H(I),t.hide(),$("#luckysheet-modal-dialog-mask").hide(),$("#luckysheet-modal-dialog-slider-protection").show(),c(),P=!1):alert(n.checkPasswordWrongalert)}else alert(n.checkPasswordNullalert)}),$("#luckysheet-protection-check-selectLockedCells").change(function(){let e=$("#luckysheet-protection-check-selectLockedCells"),t=$("#luckysheet-protection-check-selectunLockedCells"),o=e.is(":checked");t.is(":checked"),o&&t.prop("checked",!0)}),$("#luckysheet-protection-check-selectunLockedCells").change(function(){let e=$("#luckysheet-protection-check-selectLockedCells"),t=$("#luckysheet-protection-check-selectunLockedCells");e.is(":checked"),t.is(":checked")||e.prop("checked",!1)}),$(document).off("click.luckysheetProtection.dvRange").on("click.luckysheetProtection.dvRange","#protection-allowRangeAdd-range .fa-table",function(t){$("#luckysheet-protection-rangeItem-dialog").hide();let o=$(this).siblings("input").val().trim();s.rangeDialog("0",o),s.selectRange=[];let l=s.getRangeByTxt(o);if(l.length>0)for(let t=0;t<l.length;t++){let o=l[t].row[0],n=l[t].row[1],i=l[t].column[0],c=l[t].column[1],a=e.visibledatarow[n],r=o-1==-1?0:e.visibledatarow[o-1],d=e.visibledatacolumn[c],u=i-1==-1?0:e.visibledatacolumn[i-1];s.selectRange.push({left:u,width:d-u-1,top:r,height:a-r-1,left_move:u,width_move:d-u-1,top_move:r,height_move:a-r-1,row:[o,n],column:[i,c],row_focus:o,column_focus:i})}y(s.selectRange)}),$(document).off("click.luckysheetProtection.dvRange2").on("click.luckysheetProtection.dvRange2","#luckysheet-protection-rangeItem-dialog .show-box-item-dropdown .range .fa-table",function(t){$("#luckysheet-protection-rangeItem-dialog").hide();let o=$(this).siblings("input").val().trim();s.rangeDialog("1",o),s.selectRange=[];let l=s.getRangeByTxt(o);if(l.length>0)for(let t=0;t<l.length;t++){let o=l[t].row[0],n=l[t].row[1],i=l[t].column[0],c=l[t].column[1],a=e.visibledatarow[n],r=o-1==-1?0:e.visibledatarow[o-1],d=e.visibledatacolumn[c],u=i-1==-1?0:e.visibledatacolumn[i-1];s.selectRange.push({left:u,width:d-u-1,top:r,height:a-r-1,left_move:u,width_move:d-u-1,top_move:r,height_move:a-r-1,row:[o,n],column:[i,c],row_focus:o,column_focus:i})}y(s.selectRange)}),$(document).off("click.luckysheetProtection.dvRangeConfirm").on("click.luckysheetProtection.dvRangeConfirm","#luckysheet-dataVerificationRange-dialog-confirm",function(e){let t=$(this).parents("#luckysheet-dataVerificationRange-dialog").find("input").val(),o=$("#protection-allowRangeAdd-range input"),l=o.val();","==l.substr(l.length-1,1)?o.val(l+t):o.val(t),$("#luckysheet-dataVerificationRange-dialog").hide(),$("#luckysheet-modal-dialog-mask").show(),$("#luckysheet-protection-rangeItem-dialog").show(),y([])}),$(document).off("click.luckysheetProtection.dvRangeClose").on("click.dvRangeClose","#luckysheet-dataVerificationRange-dialog-close",function(e){$("#luckysheet-dataVerificationRange-dialog").hide(),$("#luckysheet-modal-dialog-mask").show(),$("#luckysheet-protection-rangeItem-dialog").show(),y([])}),$(document).on("click.luckysheetProtection.luckysheetProtection","#luckysheet-dataVerificationRange-dialog .luckysheet-modal-dialog-title-close",function(e){$("#luckysheet-dataVerificationRange-dialog").hide(),$("#luckysheet-modal-dialog-mask").show(),$("#luckysheet-protection-rangeItem-dialog").show(),y([])})}(),v=!0),x=o,null!=o&&null!=o.config&&null!=o.config.authority){let e=o.config.authority;if(P&&1==e.sheet&&null!=e.password&&e.password.length>0)return I=e,$("#luckysheet-protection-sheet-validation input").val(""),void m("luckysheet-protection-sheet-validation");H(e)}else $("#luckysheet-protection-check-selectLockedCells").prop("checked",!0),$("#luckysheet-protection-check-selectunLockedCells").prop("checked",!0);$("#luckysheet-modal-dialog-slider-protection").show(),c()},closeProtectionModal:V},i)});
//# sourceMappingURL=../sourcemaps/controllers/protection.js.map
