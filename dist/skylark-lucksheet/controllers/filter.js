/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../methods/get","../methods/validate","../widgets/tooltip","../methods/getRowlen","../widgets/select","./sheetMove","../locale/locale","../store","../methods/cells","../methods/conditionformat_methods","../methods/alternateformat_methods","../methods/protection_methods","../utils/util","../widgets/cleargridelement","../methods/sort_methods","../methods/json","../methods/format","../methods/luckysheetConfigsetting"],function(e,t,l,c,n,i,s,a,o,u,r,d,h,f,y,k,p,m){"use strict";const{getSheetIndex:v}=e,{isRealNull:b}=t,{isEditMode:x}=m,{rowlenByRange:w}=c,{selectHightlightShow:g}=n,{luckysheetMoveEndCell:B}=i,{checkProtectionAuthorityNormal:S}=d,{rgbTohex:C,showrightclickmenu:I}=h,{orderbydata:_,orderbydata1D:j}=y,{update:T,genarate:N}=p;function O(e,t,l,c,n,i,s,o,u,r){if(t?(e.addClass("luckysheet-filter-options-active").data("rowhidden",JSON.stringify(l)).data("caljs",JSON.stringify(c)).html('<i class="fa fa-filter luckysheet-mousedown-cancel" aria-hidden="true"></i>'),null!=c&&(e.data("byconditionvalue",c.value).data("byconditiontype",c.type).data("byconditiontext",c.text),null!=c.value1&&e.data("byconditionvalue1",c.value1),null!=c.value2&&e.data("byconditionvalue2",c.value2))):(e.removeClass("luckysheet-filter-options-active").data("rowhidden","").data("caljs","").html('<i class="fa fa-caret-down luckysheet-mousedown-cancel" aria-hidden="true"></i>'),e.data("byconditionvalue","null").data("byconditiontype","0").data("byconditiontext","æ— ").data("byconditionvalue1","").data("byconditionvalue2","")),n){let e=a.luckysheetfile[v(a.currentSheetIndex)];if(null==e.filter&&(e.filter={}),t){let n={caljs:c,rowhidden:l,optionstate:t,str:i,edr:s,cindex:o,stc:u,edc:r};e.filter[o-u]=n}else delete e.filter[o-u];a.saveParam("all",a.currentSheetIndex,e.filter,{k:"filter"})}}function F(e,t,c,n,i,o){let u=a.deepCopyFlowData(a.flowdata),r=!1,d=[];for(let l=e+=1;l<=c;l++){let e=[];for(let c=t;c<=n;c++){if(null!=u[l][c]&&null!=u[l][c].mc){r=!0;break}e.push(u[l][c])}d.push(e)}if(r){const e=s().filter;return void(x()?alert(e.mergeError):l.info(e.mergeError,""))}d=_(d,i-t,o);for(let l=e;l<=c;l++)for(let c=t;c<=n;c++)u[l][c]=d[l-e][c-t];let h={};if(null!=a.config.rowlen){let t=$.extend(!0,{},a.config);h={cfg:t=w(u,e,c,t),RowlChange:!0}}a.refreshGrid(u,[{row:[e,c],column:[t,n]}],h)}function q(){if(!S(a.currentSheetIndex,"filter"))return;if(a.luckysheet_select_save.length>1){$("#luckysheet-rightclick-menu").hide(),$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide(),$("#"+a.container).attr("tabindex",0).focus();const e=s().splitText;return void(x()?alert(e.tipNoMulti):l.info(e.tipNoMulti,""))}if(a.luckysheetfile[v(a.currentSheetIndex)].isPivotTable)return;$("#luckysheet-filter-selected-sheet"+a.currentSheetIndex+", #luckysheet-filter-options-sheet"+a.currentSheetIndex).remove();let e=a.luckysheet_select_save[0];if(e.row[0]==e.row[1]&&e.column[0]==e.column[1]){let t,l,c=e.row[1];for(let e=0;e<a.flowdata[c].length;e++){let n=a.flowdata[c][e];if(null==n||b(n.v)){if(null!=t){l=e-1;break}}else null==t&&(t=e)}null==l&&(l=a.flowdata[c].length-1),a.luckysheet_select_save=[{row:[c,c],column:[t,l]}],g(),a.luckysheet_shiftpositon=$.extend(!0,{},e),B("down","range")}else e.row[1]-e.row[0]<2&&(a.luckysheet_shiftpositon=$.extend(!0,{},e),B("down","range"));a.luckysheet_filter_save=$.extend(!0,{},a.luckysheet_select_save[0]),L(a.luckysheet_filter_save),a.saveParam("all",a.currentSheetIndex,a.luckysheet_filter_save,{k:"filter_select"}),a.filterchage&&a.jfredo.push({type:"filtershow",data:[],curdata:[],sheetIndex:a.currentSheetIndex,filter_save:a.luckysheet_filter_save})}function L(e,t){if($("#luckysheet-filter-selected-sheet"+a.currentSheetIndex).remove(),$("#luckysheet-filter-options-sheet"+a.currentSheetIndex).remove(),null==e||"{}"==JSON.stringify(e))return;let l=e.row[0],c=e.row[1],n=e.column[0],i=e.column[1],s=a.visibledatarow[c],o=l-1==-1?0:a.visibledatarow[l-1],u=a.visibledatacolumn[i],r=n-1==-1?0:a.visibledatacolumn[n-1],d='<div id="luckysheet-filter-selected-sheet'+a.currentSheetIndex+'" class="luckysheet-cell-selected luckysheet-filter-selected"  style="left:'+r+"px;width:"+(u-r-1)+"px;top:"+o+"px;height:"+(s-o-1)+'px;display:block;border-color:#897BFF;z-index:20;background:none;"></div>';$("#luckysheet-cell-main").append(d);let h="";for(let e=n;e<=i;e++)if(null==t||null==t[e-n])h+='<div data-rowhidden="" data-str="'+l+'" data-edr="'+c+'" data-cindex="'+e+'" data-stc="'+n+'" data-edc="'+i+'" class="luckysheet-filter-options" style="left:'+(a.visibledatacolumn[e]-20)+"px;top:"+o+'px;display:block;"><i class="fa fa-caret-down" aria-hidden="true"></i></div>';else{let s;if(null!=t[e-n].caljs){let l,c;l=null!=t[e-n].caljs.value1?'data-byconditionvalue1="'+t[e-n].caljs.value1+'" ':"",c=null!=t[e-n].caljs.value2?'data-byconditionvalue2="'+t[e-n].caljs.value2+'" ':"",s='data-caljs="'+JSON.stringify(t[e-n].caljs)+'" data-byconditionvalue="'+t[e-n].caljs.value+'" data-byconditiontype="'+t[e-n].caljs.type+'" data-byconditiontext="'+t[e-n].caljs.text+'" '+l+c}else s="";h+='<div data-rowhidden="'+JSON.stringify(t[e-n].rowhidden).replace(/\"/g,"'")+'" '+s+' data-str="'+l+'" data-edr="'+c+'" data-cindex="'+e+'" data-stc="'+n+'" data-edc="'+i+'" class="luckysheet-filter-options luckysheet-filter-options-active" style="left:'+(a.visibledatacolumn[e]-20)+"px;top:"+o+'px;display:block;"><i class="fa fa-filter luckysheet-mousedown-cancel" aria-hidden="true"></i></div>'}$("#luckysheet-cell-main").append('<div id="luckysheet-filter-options-sheet'+a.currentSheetIndex+'" class="luckysheet-filter-options-c">'+h+"</div>"),$("#luckysheet-rightclick-menu").hide(),$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide(),$("#luckysheet-cell-main").scrollTop()>e.top_move&&$("#luckysheet-scrollbar-y").scrollTop(e.top_move),a.luckysheetfile[v(a.currentSheetIndex)].filter_select=e}return{labelFilterOptionState:O,orderbydatafiler:F,createFilter:q,createFilterOptions:L,initialFilterHandler:function(){let e=null;const t=s(),l=t.filter,c=t.button;$("#luckysheetfilter").click(q);let n=null,i=null;$(".luckysheet-cols-menu .luckysheet-cols-submenu").hover(function(){let e=$(this),t=e.attr("id"),l=$("#"+t+"_sub"),c=e.parent(),n=$(window).width(),s=$(window).height(),a=c.width(),o=l.height()+25,u=l.width()+5,r=e.offset(),d=r.top,h=r.left+a;h+u>n&&(h=r.left-u),d+o>s&&(d=s-o),l.css({top:d,left:h}).show(),i=e},function(){let e=$(this).attr("id"),t=$("#"+e+"_sub");n=setTimeout(function(){t.hide()},200)}),$(".luckysheet-rightgclick-menu-sub").hover(function(){i.addClass("luckysheet-cols-menuitem-hover"),clearTimeout(n)},function(){i.removeClass("luckysheet-cols-menuitem-hover"),$(this).hide()}),$("#luckysheet-filter-menu").mouseover(function(){clearTimeout(e),e=setTimeout(function(){$("#luckysheet-filter-submenu").hide()},500)}),$("#luckysheet-filter-submenu").mouseover(function(){clearTimeout(e)}).find(".luckysheet-cols-menuitem").click(function(e){$("#luckysheet-filter-selected span").html($(this).find(".luckysheet-cols-menuitem-content").text()).data("value",$(this).data("value")),$("#luckysheet-filter-menu .luckysheet-filter-selected-input").hide();let t=$(this).data("type"),l=$(this).attr("data-value");"2"==t?($("#luckysheet-filter-selected span").data("type","2"),$("#luckysheet-filter-menu .luckysheet-filter-selected-input2").show(),$("#luckysheet-filter-menu .luckysheet-filter-selected-input input").prop("type","number")):"0"==t?$("#luckysheet-filter-selected span").data("type","0"):($("#luckysheet-filter-selected span").data("type","1"),$("#luckysheet-filter-menu .luckysheet-filter-selected-input").eq(0).show(),"dateequal"==l||"datelessthan"==l||"datemorethan"==l?$("#luckysheet-filter-menu .luckysheet-filter-selected-input input").prop("type","date"):"morethan"==l||"moreequalthan"==l||"lessthan"==l||"lessequalthan"==l||"equal"==l||"noequal"==l?$("#luckysheet-filter-menu .luckysheet-filter-selected-input input").prop("type","number"):$("#luckysheet-filter-menu .luckysheet-filter-selected-input input").prop("type","text")),$("#luckysheet-filter-byvalue").next().slideUp(),$("#luckysheet-filter-submenu").hide()}),$("#luckysheet-filter-bycondition, #luckysheet-filter-byvalue").click(function(){let e=$(this);e.next().slideToggle(200),setTimeout(function(){"luckysheet-filter-bycondition"==e.attr("id")&&$("#luckysheet-filter-bycondition").next().is(":visible")&&$("#luckysheet-filter-selected span").text()!=l.filiterInputNone&&$("#luckysheet-filter-byvalue").next().slideUp(200),e.is($("#luckysheet-filter-bycondition"))&&$("#luckysheet-filter-bycondition").next().is(":hidden")&&$("#luckysheet-filter-byvalue").next().is(":hidden")&&$("#luckysheet-filter-byvalue").next().slideDown(200)},300)}),$("#luckysheet-filter-selected").click(function(){let t=$(this).offset(),l=$("#luckysheet-filter-submenu");l.hide();let c=$(window).height(),n=$(window).width(),i=l.width(),s=(l.height(),t.top),a=t.left,o=c-t.top-20;t.left+i>n&&(a=t.left-i),t.top>c/2&&((s=c-t.top)<0&&(s=0),o=t.top-20),l.css({top:s,left:a,height:o}).show(),clearTimeout(e)}),$("#luckysheet-cell-main").on("click",".luckysheet-filter-options",function(e){if(!S(a.currentSheetIndex,"filter"))return;let t=$(e.currentTarget),c=t.offset(),n=$("#luckysheet-filter-menu"),i=$(window).height(),s=($(window).width(),t.data("str")),o=t.data("edr"),u=t.data("cindex"),r=t.data("stc"),d=t.data("edc"),h=""==t.data("rowhidden")?{}:JSON.parse(t.data("rowhidden").replace(/\'/g,'"'));$("body .luckysheet-cols-menu").hide(),$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide(),$("#luckysheet-filter-byvalue-input").val(""),$("#luckysheet-filter-bycondition").next().hide(),$("#luckysheet-filter-byvalue").next().show(),n.data("str",s),n.data("edr",o),n.data("cindex",u),n.data("stc",r),n.data("edc",d),$("#luckysheet-filter-menu .luckysheet-filter-selected-input").hide().find("input").val(),$("#luckysheet-filter-selected span").data("type","0").data("type",null).text(l.filiterInputNone);let f=t.data("byconditiontype");if($("#luckysheet-filter-selected span").data("value",t.data("byconditionvalue")).data("type",f).text(t.data("byconditiontext")),"2"==f){let e=$("#luckysheet-filter-menu .luckysheet-filter-selected-input2").show().find("input");e.eq(0).val(t.data("byconditionvalue1")),e.eq(1).val(t.data("byconditionvalue2"))}else"1"==f&&$("#luckysheet-filter-menu .luckysheet-filter-selected-input").eq(0).show().find("input").val(t.data("byconditionvalue1"));$("#luckysheet-filter-orderby-asc").off("click").on("click",function(){F(s,r,o,d,u,!0)}),$("#luckysheet-filter-orderby-desc").off("click").on("click",function(){F(s,r,o,d,u,!1)}),$("#luckysheet-filter-byvalue-select").empty().html('<div style="width:100%;text-align:center;position:relative;top:45%;font-size:14px;"><div class="luckysheetLoaderGif"></div><span>'+l.filiterMoreDataTip+"</span></div>");let y={};return $("#luckysheet-filter-options-sheet"+a.currentSheetIndex+" .luckysheet-filter-options").not(this).each(function(){let e=$(this).data("rowhidden");if(""==e)return!0;e=JSON.parse(e.replace(/\'/g,'"'));for(let t in e)y[t]=0}),a.flowdata,setTimeout(function(){let e={},t={},n={},r={};for(let l=s+1;l<=o;l++){if(l in y)continue;if(null==a.flowdata[l])continue;let c=a.flowdata[l][u];if(null==c||b(c.v)||null==c.ct||"d"!=c.ct.t){let e,t;null==c||b(c.v)?(e=null,t=null):(e=c.v,t=c.m),e in n||(n[e]={}),t in n[e]||(n[e][t]=0),n[e][t]++,l in h&&(r[e+"#$$$#"+t]=0)}else{let n=T("YYYY-MM-DD",c.v),i=n.split("-")[0],s=n.split("-")[1],a=n.split("-")[2];i in e||(e[i]={}),s in e[i]||(e[i][s]={}),a in e[i][s]||(e[i][s][a]=0),e[i][s][a]++,l in h&&(t[i]=0,t[s]=0,t[a]=0)}}let d=[];if(JSON.stringify(e).length>2)for(let c in e){let n,i=0,s="";for(let n in e[c]){let a,o=0,u="";for(let l in e[c][n]){let i,s,a=e[c][n][l];o+=a,i=Number(n)<10?"0"+Number(n):n,s=Number(l)<10?"0"+Number(l):l,u+=c in t&&n in t&&l in t?'<div class="day luckysheet-mousedown-cancel cf" data-check="false" title="'+c+"-"+i+"-"+s+'"><input class="luckysheet-mousedown-cancel" type="checkbox"/><label class="luckysheet-mousedown-cancel">'+l+'</label><span class="count luckysheet-mousedown-cancel">( '+a+" )</span></div>":'<div class="day luckysheet-mousedown-cancel cf" data-check="true" title="'+c+"-"+i+"-"+s+'"><input class="luckysheet-mousedown-cancel" type="checkbox" checked="checked"/><label class="luckysheet-mousedown-cancel">'+l+'</label><span class="count luckysheet-mousedown-cancel">( '+a+" )</span></div>"}i+=o,a=Number(n)<10?"0"+Number(n):n,s+=c in t&&n in t?'<div class="monthBox luckysheet-mousedown-cancel"><div class="month luckysheet-mousedown-cancel cf" data-check="false" title="'+c+"-"+a+'"><i class="fa fa-caret-right luckysheet-mousedown-cancel" aria-hidden="true"></i><input class="luckysheet-mousedown-cancel" type="checkbox"/><label class="luckysheet-mousedown-cancel">'+n+l.filiterMonthText+'</label><span class="count luckysheet-mousedown-cancel">( '+o+' )</span></div><div class="dayList luckysheet-mousedown-cancel">'+u+"</div></div>":'<div class="monthBox luckysheet-mousedown-cancel"><div class="month luckysheet-mousedown-cancel cf" data-check="true" title="'+c+"-"+a+'"><i class="fa fa-caret-right luckysheet-mousedown-cancel" aria-hidden="true"></i><input class="luckysheet-mousedown-cancel" type="checkbox" checked="checked"/><label class="luckysheet-mousedown-cancel">'+n+l.filiterMonthText+'</label><span class="count luckysheet-mousedown-cancel">( '+o+' )</span></div><div class="dayList luckysheet-mousedown-cancel">'+u+"</div></div>"}n=c in t?'<div class="yearBox luckysheet-mousedown-cancel"><div class="year luckysheet-mousedown-cancel cf" data-check="false" title="'+c+'"><i class="fa fa-caret-right luckysheet-mousedown-cancel" aria-hidden="true"></i><input class="luckysheet-mousedown-cancel" type="checkbox"/><label class="luckysheet-mousedown-cancel">'+c+l.filiterYearText+'</label><span class="count luckysheet-mousedown-cancel">( '+i+' )</span></div><div class="monthList luckysheet-mousedown-cancel">'+s+"</div></div>":'<div class="yearBox luckysheet-mousedown-cancel"><div class="year luckysheet-mousedown-cancel cf" data-check="true" title="'+c+'"><i class="fa fa-caret-right luckysheet-mousedown-cancel" aria-hidden="true"></i><input class="luckysheet-mousedown-cancel" type="checkbox" checked="checked"/><label class="luckysheet-mousedown-cancel">'+c+l.filiterYearText+'</label><span class="count luckysheet-mousedown-cancel">( '+i+' )</span></div><div class="monthList luckysheet-mousedown-cancel">'+s+"</div></div>",d.unshift(n)}if(JSON.stringify(n).length>2){let e=Object.keys(n);e=j(e,!0);for(let t=0;t<e.length;t++){let c=e[t];for(let e in n[c]){let t,i;t=c+"#$$$#"+e=="null#$$$#null"?l.valueBlank:e,i=c+"#$$$#"+e in r?'<div class="textBox luckysheet-mousedown-cancel cf" data-check="false" data-filter="'+c+"#$$$#"+e+'" title="'+t+'"><input class="luckysheet-mousedown-cancel" type="checkbox"/><label class="luckysheet-mousedown-cancel">'+t+'</label><span class="luckysheet-mousedown-cancel count">( '+n[c][e]+" )</span></div>":'<div class="textBox luckysheet-mousedown-cancel cf" data-check="true" data-filter="'+c+"#$$$#"+e+'" title="'+t+'"><input class="luckysheet-mousedown-cancel" type="checkbox" checked="checked"/><label class="luckysheet-mousedown-cancel">'+t+'</label><span class="luckysheet-mousedown-cancel count">( '+n[c][e]+" )</span></div>",d.push(i)}}}$("#luckysheet-filter-byvalue-select").html("<div class='ListBox luckysheet-mousedown-cancel' style='min-height: 100px; max-height: "+(i-c.top-350)+"px; overflow-y: auto; overflow-x: hidden;'><table cellspacing='0' style='width:100%;' class='luckysheet-mousedown-cancel'>"+d.join("")+"</table></div>")},1),I(n,c.left,c.top+20),e.stopPropagation(),!1}),$("#luckysheet-filter-orderby-color").hover(function(){let e=$("#luckysheet-filter-menu"),t=e.data("str"),n=e.data("edr"),i=e.data("cindex"),s=(e.data("stc"),e.data("edc"),{}),d={},h=r.getComputeMap(),f=u.getComputeMap();for(let e=t+1;e<=n;e++){let t=a.flowdata[e][i],l=o.checkstatus(a.flowdata,e,i,"bg");null==l&&(l="#ffffff");let c=r.checksAF(e,i,h);null!=c&&(l=c[1]);let n=u.checksCF(e,i,f);null!=n&&null!=n.cellColor&&(l=n.cellColor),l.indexOf("rgb")>-1&&(l=C(l)),4==l.length&&(l=l.substr(0,1)+l.substr(1,1).repeat(2)+l.substr(2,1).repeat(2)+l.substr(3,1).repeat(2));let y=o.checkstatus(a.flowdata,e,i,"fc");null!=c&&(y=c[0]),null!=n&&null!=n.textColor&&(y=n.textColor),y.indexOf("rgb")>-1&&(y=C(y)),4==y.length&&(y=y.substr(0,1)+y.substr(1,1).repeat(2)+y.substr(2,1).repeat(2)+y.substr(3,1).repeat(2)),null!=a.config&&null!=a.config.rowhidden&&e in a.config.rowhidden?(s[l]=1,null==t||b(t.v)||(d[y]=1)):(s[l]=0,null==t||b(t.v)||(d[y]=0))}let y="";if(JSON.stringify(s).length>2&&Object.keys(s).length>1){let e="";for(let t in s)0==s[t]?e+='<div class="item luckysheet-mousedown-cancel"><label class="luckysheet-mousedown-cancel" style="background-color: '+t+'" title="'+t+'"></label><input class="luckysheet-mousedown-cancel" type="checkbox" checked="checked"/></div>':e+='<div class="item luckysheet-mousedown-cancel"><label class="luckysheet-mousedown-cancel" style="background-color: '+t+'" title="'+t+'"></label><input class="luckysheet-mousedown-cancel" type="checkbox"/></div>';y='<div id="filterBgColor" class="box luckysheet-mousedown-cancel"><div class="title luckysheet-mousedown-cancel">'+l.filiterByColorTip+'</div><div style="max-height:128px;overflow:auto;" class="luckysheet-mousedown-cancel">'+e+"</div></div>"}let k,p="";if(JSON.stringify(d).length>2&&Object.keys(d).length>1){let e="";for(let t in d)0==d[t]?e+='<div class="item luckysheet-mousedown-cancel"><label class="luckysheet-mousedown-cancel" style="background-color: '+t+'" title="'+t+'"></label><input class="luckysheet-mousedown-cancel" type="checkbox" checked="checked"/></div>':e+='<div class="item luckysheet-mousedown-cancel"><label class="luckysheet-mousedown-cancel" style="background-color: '+t+'" title="'+t+'"></label><input class="luckysheet-mousedown-cancel" type="checkbox"/></div>';p='<div id="filterFcColor" class="box luckysheet-mousedown-cancel"><div class="title luckysheet-mousedown-cancel">'+l.filiterByTextColorTip+'</div><div style="max-height:128px;overflow:auto;" class="luckysheet-mousedown-cancel">'+e+"</div></div>"}k=""==y&&""==p?'<div class="luckysheet-mousedown-cancel" style="padding: 10px 30px;text-align: center;">'+l.filterContainerOneColorTip+"</div>":y+p+'<div class="luckysheet-mousedown-cancel"><button id="luckysheet-filter-orderby-color-confirm" class="btn btn-primary luckysheet-mousedown-cancel" style="margin: 5px 20px;width: 70px;">'+c.confirm+"</button></div>",$("#luckysheet-filter-orderby-color-submenu").remove(),$("body").append('<div id="luckysheet-filter-orderby-color-submenu" class="luckysheet-cols-menu luckysheet-mousedown-cancel">'+k+"</div>");let m=$("#luckysheet-filter-orderby-color-submenu").end(),v=$(this).parent(),x=$(window).width(),w=$(window).height(),g=v.width(),B=m.height()+25,S=m.width()+5,I=$(this).offset(),_=I.top,j=I.left+g;j+S>x&&(j=I.left-S),_+B>w&&(_=w-B),$("#luckysheet-filter-orderby-color-submenu").css({top:_,left:j}).show()},function(){n=setTimeout(function(){$("#luckysheet-filter-orderby-color-submenu").hide()},200)}),$(document).on("mouseover mouseleave","#luckysheet-filter-orderby-color-submenu",function(e){"mouseover"===e.type?clearTimeout(n):$(this).hide()}),$(document).on("click","#luckysheet-filter-orderby-color-submenu .item label",function(){$(this).siblings("input[type='checkbox']").click()}),$(document).off("click.orderbyColorConfirm").on("click.orderbyColorConfirm","#luckysheet-filter-orderby-color-submenu #luckysheet-filter-orderby-color-confirm",function(){let e,t,l={},c={};$("#luckysheet-filter-orderby-color-submenu .item").each(function(e,t){if($(t).find("input[type='checkbox']").is(":checked")){let e=$(this).find("label").attr("title"),t=$(this).closest(".box").attr("id");"filterBgColor"==t?l[e]=0:"filterFcColor"==t&&(c[e]=0)}}),e=$("#luckysheet-filter-orderby-color-submenu #filterBgColor").length>0,t=$("#luckysheet-filter-orderby-color-submenu #filterFcColor").length>0;let n=$("#luckysheet-filter-menu"),i=n.data("str"),s=n.data("edr"),d=n.data("cindex"),h=n.data("stc"),y=n.data("edc"),p={};$("#luckysheet-filter-options-sheet"+a.currentSheetIndex+" .luckysheet-filter-options").not($("#luckysheet-filter-options-sheet"+a.currentSheetIndex+" .luckysheet-filter-options").eq(d-h).get(0)).each(function(){let e=$(this).data("rowhidden");if(""==e)return!0;e=JSON.parse(e);for(let t in e)p[t]=0});let m={},x={},w=r.getComputeMap(),g=u.getComputeMap();for(let n=i+1;n<=s;n++){if(n in p)continue;if(null==a.flowdata[n])continue;let i=a.flowdata[n][d],s=o.checkstatus(a.flowdata,n,d,"bg"),h=r.checksAF(n,d,w);null!=h&&(s=h[1]);let f=u.checksCF(n,d,g);null!=f&&null!=f.cellColor&&(s=f.cellColor),(s=null==s?"#ffffff":s).indexOf("rgb")>-1&&(s=C(s)),4==s.length&&(s=s.substr(0,1)+s.substr(1,1).repeat(2)+s.substr(2,1).repeat(2)+s.substr(3,1).repeat(2));let y=o.checkstatus(a.flowdata,n,d,"fc");null!=h&&(y=h[0]),null!=f&&null!=f.textColor&&(y=f.textColor),y.indexOf("rgb")>-1&&(y=C(y)),4==y.length&&(y=y.substr(0,1)+y.substr(1,1).repeat(2)+y.substr(2,1).repeat(2)+y.substr(3,1).repeat(2)),e&&t?s in l||y in c&&null!=i&&!b(i.v)||(m[n]=0):e?s in l||(m[n]=0):t&&(y in c&&null!=i&&!b(i.v)||(m[n]=0))}let B=$("#luckysheet-filter-options-sheet"+a.currentSheetIndex+" .luckysheet-filter-options").eq(d-h),S=Object.keys(m).length>0,I=$.extend(!0,p,m),_=k.parseJsonParm(B.data("rowhidden"));O(B,S,m,x,!0,i,s,d,h,y);let j=$.extend(!0,{},a.config);if(j.rowhidden=I,a.clearjfundo){let e={type:"datachangeAll_filter"};e.sheetIndex=a.currentSheetIndex,e.config=$.extend(!0,{},a.config),e.curconfig=j,e.optionstate=S,e.optionsindex=d-h,e.rowhidden=$.extend(!0,{},m),e.rowhidenPre=$.extend(!0,{},_),null!=x&&(e.caljs=x),a.jfundo.length=0,a.jfredo.push(e)}a.config=j,a.luckysheetfile[v(a.currentSheetIndex)].config=a.config,a.saveParam("cg",a.currentSheetIndex,j.rowhidden,{k:"rowhidden"}),a.refreshGrid_rhcw(a.flowdata.length,a.flowdata[0].length),$("#luckysheet-filter-menu, #luckysheet-filter-submenu, #luckysheet-filter-orderby-color-submenu").hide(),f()}),$(document).off("click.filterCheckbox1").on("click.filterCheckbox1","#luckysheet-filter-byvalue-select .textBox",function(){"true"==$(this).attr("data-check")?($(this).attr("data-check","false"),$(this).find("input[type='checkbox']").removeAttr("checked")):($(this).attr("data-check","true"),$(this).find("input[type='checkbox']").prop("checked",!0))}),$(document).off("click.filterCheckbox2").on("click.filterCheckbox2","#luckysheet-filter-byvalue-select .year",function(){"true"==$(this).attr("data-check")?($(this).attr("data-check","false"),$(this).parents(".yearBox").find(".month").attr("data-check","false"),$(this).parents(".yearBox").find(".day").attr("data-check","false"),$(this).parents(".yearBox").find("input[type='checkbox']").removeAttr("checked")):($(this).attr("data-check","true"),$(this).parents(".yearBox").find(".month").attr("data-check","true"),$(this).parents(".yearBox").find(".day").attr("data-check","true"),$(this).parents(".yearBox").find("input[type='checkbox']").prop("checked",!0))}),$(document).off("click.filterCheckbox3").on("click.filterCheckbox3","#luckysheet-filter-byvalue-select .month",function(){"true"==$(this).attr("data-check")?($(this).attr("data-check","false"),$(this).parents(".monthBox").find(".day").attr("data-check","false"),$(this).parents(".monthBox").find("input[type='checkbox']").removeAttr("checked")):($(this).attr("data-check","true"),$(this).parents(".monthBox").find(".day").attr("data-check","true"),$(this).parents(".monthBox").find("input[type='checkbox']").prop("checked",!0));let e=!0;$(this).parents(".yearBox").find(".day").each(function(t,l){"true"==$(l).attr("data-check")||(e=!1)}),e?($(this).parents(".yearBox").find(".year").attr("data-check","true"),$(this).parents(".yearBox").find(".year input[type='checkbox']").prop("checked",!0)):($(this).parents(".yearBox").find(".year").attr("data-check","false"),$(this).parents(".yearBox").find(".year input[type='checkbox']").removeAttr("checked"))}),$(document).off("click.filterCheckbox4").on("click.filterCheckbox4","#luckysheet-filter-byvalue-select .day",function(){"true"==$(this).attr("data-check")?($(this).attr("data-check","false"),$(this).find("input[type='checkbox']").removeAttr("checked")):($(this).attr("data-check","true"),$(this).find("input[type='checkbox']").prop("checked",!0));let e=!0;$(this).parents(".monthBox").find(".day").each(function(t,l){"true"==$(l).attr("data-check")||(e=!1)}),e?($(this).parents(".monthBox").find(".month").attr("data-check","true"),$(this).parents(".monthBox").find(".month input[type='checkbox']").prop("checked",!0)):($(this).parents(".monthBox").find(".month").attr("data-check","false"),$(this).parents(".monthBox").find(".month input[type='checkbox']").removeAttr("checked"));let t=!0;$(this).parents(".yearBox").find(".day").each(function(e,l){"true"==$(l).attr("data-check")||(t=!1)}),t?($(this).parents(".yearBox").find(".year").attr("data-check","true"),$(this).parents(".yearBox").find(".year input[type='checkbox']").prop("checked",!0)):($(this).parents(".yearBox").find(".year").attr("data-check","false"),$(this).parents(".yearBox").find(".year input[type='checkbox']").removeAttr("checked"))}),$(document).off("click.filterYearDropdown").on("click.filterYearDropdown","#luckysheet-filter-byvalue-select .yearBox .fa-caret-right",function(e){let t=$(this).parents(".luckysheet-mousedown-cancel");t.hasClass("year")&&$(this).parents(".yearBox").find(".monthList").slideToggle(),t.hasClass("month")&&$(this).parents(".monthBox").find(".dayList").slideToggle(),e.stopPropagation()}),$("#luckysheet-filter-byvalue-btn-all").click(function(){$("#luckysheet-filter-byvalue-select .ListBox input[type='checkbox']").prop("checked",!0),$("#luckysheet-filter-byvalue-select .ListBox input[type='checkbox']").parents(".luckysheet-mousedown-cancel").attr("data-check","true")}),$("#luckysheet-filter-byvalue-btn-clear").click(function(){$("#luckysheet-filter-byvalue-select .ListBox input[type='checkbox']").removeAttr("checked"),$("#luckysheet-filter-byvalue-select .ListBox input[type='checkbox']").parents(".luckysheet-mousedown-cancel").attr("data-check","false")}),$("#luckysheet-filter-byvalue-btn-contra").click(function(){$("#luckysheet-filter-byvalue-select .ListBox input[type='checkbox']").each(function(e,t){$(t).is(":checked")?($(t).removeAttr("checked"),$(t).parents(".luckysheet-mousedown-cancel").attr("data-check","false")):($(t).prop("checked",!0),$(t).parents(".luckysheet-mousedown-cancel").attr("data-check","true"))}),$("#luckysheet-filter-byvalue-select .ListBox .monthBox").each(function(e,t){let l=!0;$(t).find(".day input[type='checkbox']").each(function(e,t){$(t).is(":checked")||(l=!1)}),l?($(t).find(".month input[type='checkbox']").prop("checked",!0),$(t).attr("data-check","true")):($(t).find(".month input[type='checkbox']").removeAttr("checked"),$(t).attr("data-check","false"))}),$("#luckysheet-filter-byvalue-select .ListBox .yearBox").each(function(e,t){let l=!0;$(t).find(".day input[type='checkbox']").each(function(e,t){$(t).is(":checked")||(l=!1)}),l?($(t).find(".year input[type='checkbox']").prop("checked",!0),$(t).attr("data-check","true")):($(t).find(".year input[type='checkbox']").removeAttr("checked"),$(t).attr("data-check","false"))})}),$("#luckysheet-filter-initial").click(function(){if(!S(a.currentSheetIndex,"filter"))return;$("#luckysheet-filter-menu .luckysheet-filter-selected-input").hide().find("input").val(),$("#luckysheet-filter-selected span").data("type","0").data("type",null).text(l.conditionNone);let e={type:"datachangeAll_filter_clear"};e.sheetIndex=a.currentSheetIndex,e.config=$.extend(!0,{},a.config),a.config.rowhidden={},e.curconfig=$.extend(!0,{},a.config),e.filter_save=$.extend(!0,{},a.luckysheet_filter_save);let t=[];$("#luckysheet-filter-options-sheet"+a.currentSheetIndex+" .luckysheet-filter-options").each(function(){let e=$(this),l=e.hasClass("luckysheet-filter-options-active"),c=k.parseJsonParm(e.data("rowhidden")),n=k.parseJsonParm(e.data("caljs"));t.push({optionstate:l,rowhidden:c,caljs:n,str:e.data("str"),edr:e.data("edr"),cindex:e.data("cindex"),stc:e.data("stc"),edc:e.data("edc")})}),e.optiongroups=t,a.jfundo.length=0,a.jfredo.push(e),$("#luckysheet-filter-selected-sheet"+a.currentSheetIndex+", #luckysheet-filter-options-sheet"+a.currentSheetIndex).remove(),$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide(),a.luckysheetfile[v(a.currentSheetIndex)].filter=null,a.luckysheetfile[v(a.currentSheetIndex)].filter_select=null,a.saveParam("fsc",a.currentSheetIndex,null),a.luckysheetfile[v(a.currentSheetIndex)].config=a.config,a.saveParam("cg",a.currentSheetIndex,{},{k:"rowhidden"}),a.refreshGrid_rhcw(a.flowdata.length,a.flowdata[0].length)}),$("#luckysheet-filter-byvalue-input").on("input propertychange",function(){let e=$(this).val().toString();$("#luckysheet-filter-byvalue-select .ListBox .luckysheet-mousedown-cancel").show(),""!=e&&$("#luckysheet-filter-byvalue-select .ListBox input[type='checkbox']").each(function(t,l){if($(l).closest(".day").length>0){let t=$(l).siblings("label").text().toString(),c=$(l).closest(".monthBox").find(".month label").text().toString();-1==($(l).closest(".yearBox").find(".year label").text().toString()+"-"+c+"-"+t).indexOf(e)&&($(l).closest(".day").hide(),0==$(l).closest(".dayList").find(".day:visible").length&&$(l).closest(".monthBox").find(".month").hide(),0==$(l).closest(".monthList").find(".day:visible").length&&$(l).closest(".yearBox").find(".year").hide())}$(l).closest(".textBox").length>0&&-1==$(l).siblings("label").text().toString().indexOf(e)&&$(l).parents(".textBox").hide()})}),$("#luckysheet-filter-cancel").click(function(){$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide()}),$("#luckysheet-filter-confirm").click(function(){let e=$("#luckysheet-filter-menu"),t=e.data("str"),c=e.data("edr"),n=e.data("cindex"),i=e.data("stc"),s=e.data("edc"),o={};$("#luckysheet-filter-options-sheet"+a.currentSheetIndex+" .luckysheet-filter-options").not($("#luckysheet-filter-options-sheet"+a.currentSheetIndex+" .luckysheet-filter-options").eq(n-i).get(0)).each(function(){let e=$(this).data("rowhidden");if(""==e)return!0;e=JSON.parse(e.replace(/\'/g,'"'));for(let t in e)o[t]=0});let u={},r={},d={};if($("#luckysheet-filter-bycondition").next().is(":visible")&&$("#luckysheet-filter-byvalue").next().is(":hidden")&&"null"!=$("#luckysheet-filter-selected span").data("value")){let e=$("#luckysheet-filter-selected span"),l=e.data("type"),i=e.data("value");if(d.value=i,d.text=e.text(),"0"==l)d.type="0";else if("2"==l){let e=$("#luckysheet-filter-menu .luckysheet-filter-selected-input2 input");d.type="2",d.value1=e.eq(0).val(),d.value2=e.eq(1).val()}else d.type="1",d.value1=$("#luckysheet-filter-menu .luckysheet-filter-selected-input").eq(0).find("input").val();for(let e=t+1;e<=c;e++){if(e in o)continue;if(null==a.flowdata[e])continue;let t=a.flowdata[e][n];if("cellnull"==i)null==t||b(t.v)||(r[e]=0);else if("cellnonull"==i)(null==t||b(t.v))&&(r[e]=0);else if("textinclude"==i){let l=d.value1;null==t||b(t.v)?r[e]=0:-1==t.m.indexOf(l)&&(r[e]=0)}else if("textnotinclude"==i){let l=d.value1;null==t||b(t.v)||t.m.indexOf(l)>-1&&(r[e]=0)}else if("textstart"==i){let l=d.value1,c=l.length;null==t||b(t.v)?r[e]=0:t.m.substr(0,c)!=l&&(r[e]=0)}else if("textend"==i){let l=d.value1,c=l.length;null==t||b(t.v)?r[e]=0:(c>t.m.length||t.m.substr(t.m.length-c,c)!=l)&&(r[e]=0)}else if("textequal"==i){let l=d.value1;null==t||b(t.v)?r[e]=0:t.m!=l&&(r[e]=0)}else if("dateequal"==i){let l=N(d.value1)[2];null==t||b(t.v)?r[e]=0:null!=t.ct&&"d"==t.ct.t?parseInt(t.v)!=l&&(r[e]=0):r[e]=0}else if("datelessthan"==i){let l=N(d.value1)[2];null==t||b(t.v)?r[e]=0:null!=t.ct&&"d"==t.ct.t?parseInt(t.v)>=l&&(r[e]=0):r[e]=0}else if("datemorethan"==i){let l=N(d.value1)[2];null==t||b(t.v)?r[e]=0:null!=t.ct&&"d"==t.ct.t?parseInt(t.v)<=l&&(r[e]=0):r[e]=0}else if("morethan"==i){let l=parseFloat(d.value1);null==t||b(t.v)?r[e]=0:null!=t.ct&&"n"==t.ct.t?t.v<=l&&(r[e]=0):r[e]=0}else if("moreequalthan"==i){let l=parseFloat(d.value1);null==t||b(t.v)?r[e]=0:null!=t.ct&&"n"==t.ct.t?t.v<l&&(r[e]=0):r[e]=0}else if("lessthan"==i){let l=parseFloat(d.value1);null==t||b(t.v)?r[e]=0:null!=t.ct&&"n"==t.ct.t?t.v>=l&&(r[e]=0):r[e]=0}else if("lessequalthan"==i){let l=parseFloat(d.value1);null==t||b(t.v)?r[e]=0:null!=t.ct&&"n"==t.ct.t?t.v>l&&(r[e]=0):r[e]=0}else if("equal"==i){let l=parseFloat(d.value1);null==t||b(t.v)?r[e]=0:null!=t.ct&&"n"==t.ct.t?t.v!=l&&(r[e]=0):r[e]=0}else if("noequal"==i){let l=parseFloat(d.value1);null==t||b(t.v)?r[e]=0:null!=t.ct&&"n"==t.ct.t?t.v==l&&(r[e]=0):r[e]=0}else if("include"==i){let l,c,n=parseFloat(d.value1),i=parseFloat(d.value2);n<i?(l=n,c=i):(c=n,l=i),null==t||b(t.v)?r[e]=0:null!=t.ct&&"n"==t.ct.t?(t.v<l||t.v>c)&&(r[e]=0):r[e]=0}else if("noinclude"==i){let l,c,n=parseFloat(d.value1),i=parseFloat(d.value2);n<i?(l=n,c=i):(c=n,l=i),null==t||b(t.v)?r[e]=0:null!=t.ct&&"n"==t.ct.t?t.v>=l&&t.v<=c&&(r[e]=0):r[e]=0}}}else{$("#luckysheet-filter-byvalue-select .ListBox input[type='checkbox']").each(function(e,t){if($(t).is(":visible")&&$(t).is(":checked"))return!0;if($(t).closest(".day").length>0){let e=$(t).siblings("label").text();Number(e)<10&&(e="0"+Number(e));let c=$(t).closest(".monthBox").find(".month label").text().replace(l.filiterMonthText,"");Number(c)<10&&(c="0"+Number(c));let n=$(t).closest(".yearBox").find(".year label").text().replace(l.filiterYearText,""),i=l.filterDateFormatTip+"#$$$#"+n+"-"+c+"-"+e;u[i]="1"}if($(t).closest(".textBox").length>0){let e=$(t).closest(".textBox").data("filter");u[e]="1"}});for(let e=t+1;e<=c;e++){if(e in o)continue;if(null==a.flowdata[e])continue;let t,c=a.flowdata[e][n];if(null==c||b(c.v))t="null#$$$#null";else if(null!=c.ct&&"d"==c.ct.t){let e=T("YYYY-MM-DD",c.v);t=l.filterDateFormatTip+"#$$$#"+e}else t=c.v+"#$$$#"+c.m;t in u&&(r[e]=0)}}let h=$("#luckysheet-filter-options-sheet"+a.currentSheetIndex+" .luckysheet-filter-options").eq(n-i),y=$("#luckysheet-filter-byvalue-select .ListBox input[type='checkbox']:visible:checked").length<$("#luckysheet-filter-byvalue-select .ListBox input[type='checkbox']:visible").length||$("#luckysheet-filter-byvalue-input").val().length>0||$("#luckysheet-filter-bycondition").next().is(":visible")&&$("#luckysheet-filter-byvalue").next().is(":hidden")&&"null"!=$("#luckysheet-filter-selected span").data("value"),p=$.extend(!0,o,r),m=k.parseJsonParm(h.data("rowhidden"));O(h,y,r,d,!0,t,c,n,i,s);let x=$.extend(!0,{},a.config);if(x.rowhidden=p,a.clearjfundo){let e={type:"datachangeAll_filter"};e.sheetIndex=a.currentSheetIndex,e.config=$.extend(!0,{},a.config),e.curconfig=x,e.optionstate=y,e.optionsindex=n-i,e.rowhidden=$.extend(!0,{},r),e.rowhidenPre=$.extend(!0,{},m),null!=d&&(e.caljs=d),a.jfundo.length=0,a.jfredo.push(e)}a.config=x,a.luckysheetfile[v(a.currentSheetIndex)].config=a.config,a.saveParam("cg",a.currentSheetIndex,x.rowhidden,{k:"rowhidden"}),a.refreshGrid_rhcw(a.flowdata.length,a.flowdata[0].length),$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide(),f()})}}});
//# sourceMappingURL=../sourcemaps/controllers/filter.js.map
