/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../global/location","../global/editor","../global/formula","../global/cursorPos","../global/refresh","../methods/set","../methods/get","../utils/util","./freezen","./menuButton","./protection","./server","../store","../global/method"],function(e,t,l,i,s,o,a,d,c,h,r,p,n,u){"use strict";const{rowLocation:m,colLocation:v,mouseposition:y}=e,{luckysheetRangeLast:g}=i,{luckysheetrefreshgrid:k}=s,{setluckysheet_scroll_status:w}=o,{getSheetIndex:f}=a,{getObjType:z}=d,{checkProtectionAuthorityNormal:b}=r;return{defaultWidth:144,defaultHeight:84,currentObj:null,currentWinW:null,currentWinH:null,resize:null,resizeXY:null,move:!1,moveXY:null,init:function(){let e=this;$("#luckysheet-postil-showBoxs").off("mousedown.showPs").on("mousedown.showPs",".luckysheet-postil-show",function(t){b(n.currentSheetIndex,"editObjects",!1)&&(e.currentObj=$(this).find(".luckysheet-postil-show-main"),$(this).hasClass("luckysheet-postil-show-active")?t.stopPropagation():(e.removeActivePs(),$(this).addClass("luckysheet-postil-show-active"),$(this).find(".luckysheet-postil-dialog-resize").show(),$(this).find(".arrowCanvas").css("z-index",200),$(this).find(".luckysheet-postil-show-main").css("z-index",200),t.stopPropagation()))}),$("#luckysheet-postil-showBoxs").off("mouseup.showPs").on("mouseup.showPs",".luckysheet-postil-show",function(e){"3"==e.which&&e.stopPropagation()}),$("#luckysheet-postil-showBoxs").off("mousedown.resize").on("mousedown.resize",".luckysheet-postil-show .luckysheet-postil-dialog-resize .luckysheet-postil-dialog-resize-item",function(t){if(!b(n.currentSheetIndex,"editObjects",!1))return;e.currentObj=$(this).closest(".luckysheet-postil-show-main"),e.currentWinW=$("#luckysheet-cell-main")[0].scrollWidth,e.currentWinH=$("#luckysheet-cell-main")[0].scrollHeight,e.resize=$(this).data("type");let l=$("#luckysheet-cell-main").scrollTop(),i=$("#luckysheet-cell-main").scrollLeft(),s=y(t.pageX,t.pageY),o=s[0]+i,a=s[1]+l,d=e.currentObj.position(),c=e.currentObj.width(),h=e.currentObj.height();e.resizeXY=[o,a,c,h,d.left+i,d.top+l,i,l],w(!0),$(this).closest(".luckysheet-postil-show").hasClass("luckysheet-postil-show-active")?t.stopPropagation():(e.removeActivePs(),$(this).closest(".luckysheet-postil-show").addClass("luckysheet-postil-show-active"),$(this).closest(".luckysheet-postil-show").find(".luckysheet-postil-dialog-resize").show(),$(this).closest(".luckysheet-postil-show").find(".arrowCanvas").css("z-index",200),$(this).closest(".luckysheet-postil-show").find(".luckysheet-postil-show-main").css("z-index",200),t.stopPropagation())}),$("#luckysheet-postil-showBoxs").off("mousedown.move").on("mousedown.move",".luckysheet-postil-show .luckysheet-postil-dialog-move .luckysheet-postil-dialog-move-item",function(t){if(!b(n.currentSheetIndex,"editObjects",!1))return;e.currentObj=$(this).closest(".luckysheet-postil-show-main"),e.currentWinW=$("#luckysheet-cell-main")[0].scrollWidth,e.currentWinH=$("#luckysheet-cell-main")[0].scrollHeight,e.move=!0;let l=$("#luckysheet-cell-main").scrollTop(),i=$("#luckysheet-cell-main").scrollLeft(),s=e.currentObj.offset(),o=e.currentObj.position();e.moveXY=[t.pageX-s.left,t.pageY-s.top,o.left,o.top,i,l],w(!0),$(this).closest(".luckysheet-postil-show").hasClass("luckysheet-postil-show-active")?t.stopPropagation():(e.removeActivePs(),$(this).closest(".luckysheet-postil-show").addClass("luckysheet-postil-show-active"),$(this).closest(".luckysheet-postil-show").find(".luckysheet-postil-dialog-resize").show(),$(this).closest(".luckysheet-postil-show").find(".arrowCanvas").css("z-index",200),$(this).closest(".luckysheet-postil-show").find(".luckysheet-postil-show-main").css("z-index",200),t.stopPropagation())})},overshow:function(e){if($("#luckysheet-postil-overshow").remove(),0==$(e.target).closest("#luckysheet-cell-main").length)return;let t=y(e.pageX,e.pageY),l=$("#luckysheet-cell-main").scrollLeft(),i=$("#luckysheet-cell-main").scrollTop(),s=t[0],o=t[1],a=0,d=0;null!=c.freezenverticaldata&&t[0]<c.freezenverticaldata[0]-c.freezenverticaldata[2]?a=l:s+=l,null!=c.freezenhorizontaldata&&t[1]<c.freezenhorizontaldata[0]-c.freezenhorizontaldata[2]?d=i:o+=i;let r=m(o)[2],p=v(s)[2],u=h.mergeborer(n.flowdata,r,p);if(u&&(r=u.row[2],p=u.column[2]),null==n.flowdata[r]||null==n.flowdata[r][p]||null==n.flowdata[r][p].ps)return;let g=n.flowdata[r][p].ps;if(g.isshow||$("#luckysheet-postil-show_"+r+"_"+p).length>0)return;let k=null==g.value?"":g.value,w=n.visibledatarow[r],f=r-1==-1?0:n.visibledatarow[r-1],z=n.visibledatacolumn[p],b=p-1==-1?0:n.visibledatacolumn[p-1];u&&(w=u.row[1],f=u.row[0],z=u.column[1],b=u.column[0]);let x=z+a,_=f+d,C=x+18*n.zoomRatio,R=_-18*n.zoomRatio;R<0&&(R=2);let P=this.defaultWidth*n.zoomRatio,I=this.defaultHeight*n.zoomRatio,A=this.getArrowCanvasSize(C,R,x,_),T='<div id="luckysheet-postil-overshow"><canvas class="arrowCanvas" width="'+A[2]+'" height="'+A[3]+'" style="position:absolute;left:'+A[0]+"px;top:"+A[1]+'px;z-index:100;pointer-events:none;"></canvas><div style="width:'+(P-12)+"px;min-height:"+(I-12)+"px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:"+C+"px;top:"+R+'px;z-index:100;">'+this.htmlEscape(k)+"</div></div>";$(T).appendTo($("#luckysheet-cell-main"));let F=$("#luckysheet-postil-overshow .arrowCanvas").get(0).getContext("2d");this.drawArrow(F,A[4],A[5],A[6],A[7])},getArrowCanvasSize:function(e,t,l,i){let s=l-5;e<l&&(s=e-5);let o=i-5;t<i&&(o=t-5);let a=Math.abs(e-l)+10,d=Math.abs(t-i)+10,c=a-5,h=5;e<l&&(c=5,h=a-5);let r=d-5,p=5;return t<i&&(r=5,p=d-5),[s,o,a,d,c,r,h,p]},drawArrow:function(e,t,l,i,s,o,a,d,c){o="undefined"==z(o)?30:o,a="undefined"==z(a)?6:a,d="undefined"==z(d)?1:d,c="undefined"==z(c)?"#000":c;let h=180*Math.atan2(l-s,t-i)/Math.PI,r=(h+o)*Math.PI/180,p=(h-o)*Math.PI/180,n=a*Math.cos(r),u=a*Math.sin(r),m=a*Math.cos(p),v=a*Math.sin(p);e.save(),e.beginPath();let y=t-n,g=l-u;e.moveTo(y,g),e.moveTo(t,l),e.lineTo(i,s),e.lineWidth=d,e.strokeStyle=c,e.stroke(),y=i+n,g=s+u,e.moveTo(y,g),e.lineTo(i,s),y=i+m,g=s+v,e.lineTo(y,g),e.fillStyle=c,e.fill(),e.restore()},buildAllPs:function(e){let t=this;$("#luckysheet-cell-main #luckysheet-postil-showBoxs").empty();for(let l=0;l<e.length;l++)for(let i=0;i<e[0].length;i++)if(null!=e[l][i]&&null!=e[l][i].ps){let s=e[l][i].ps;t.buildPs(l,i,s)}t.init()},buildPs:function(e,t,l){if($("#luckysheet-postil-show_"+e+"_"+t).length>0&&$("#luckysheet-postil-show_"+e+"_"+t).remove(),null==l)return;let i=this;if(null!=l.isshow&&l.isshow){let s=n.visibledatarow[e],o=e-1==-1?0:n.visibledatarow[e-1],a=n.visibledatacolumn[t],d=t-1==-1?0:n.visibledatacolumn[t-1],c=h.mergeborer(n.flowdata,e,t);c&&(s=c.row[1],o=c.row[0],a=c.column[1],d=c.column[0]);let r=a,p=o,u=null==l.left?r+18*n.zoomRatio:l.left*n.zoomRatio,m=null==l.top?p-18*n.zoomRatio:l.top*n.zoomRatio,v=null==l.width?i.defaultWidth*n.zoomRatio:l.width*n.zoomRatio,y=null==l.height?i.defaultHeight*n.zoomRatio:l.height*n.zoomRatio,g=null==l.value?"":l.value;m<0&&(m=2);let k=i.getArrowCanvasSize(u,m,r,p),w='<div id="luckysheet-postil-show_'+e+"_"+t+'" class="luckysheet-postil-show"><canvas class="arrowCanvas" width="'+k[2]+'" height="'+k[3]+'" style="position:absolute;left:'+k[0]+"px;top:"+k[1]+'px;z-index:100;pointer-events:none;"></canvas><div class="luckysheet-postil-show-main" style="width:'+v+"px;height:"+y+"px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:"+u+"px;top:"+m+'px;box-sizing:border-box;z-index:100;"><div class="luckysheet-postil-dialog-move"><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t" data-type="t"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r" data-type="r"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b" data-type="b"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l" data-type="l"></div></div><div class="luckysheet-postil-dialog-resize" style="display:none;"><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt" data-type="lt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt" data-type="mt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm" data-type="lm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm" data-type="rm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt" data-type="rt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb" data-type="lb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb" data-type="mb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb" data-type="rb"></div></div><div style="width:100%;height:100%;overflow:hidden;"><div class="formulaInputFocus" style="width:'+(v-12)+"px;height:"+(y-12)+'px;line-height:20px;box-sizing:border-box;text-align: center;;word-break:break-all;" spellcheck="false" contenteditable="true">'+i.htmlEscape(g)+"</div></div></div></div>";$(w).appendTo($("#luckysheet-cell-main #luckysheet-postil-showBoxs"));let f=$("#luckysheet-postil-show_"+e+"_"+t+" .arrowCanvas").get(0).getContext("2d");i.drawArrow(f,k[4],k[5],k[6],k[7])}},newPs:function(e,l){if(!b(n.currentSheetIndex,"editObjects"))return;if(!u.createHookFunction("commentInsertBefore",e,l))return;let i=n.visibledatarow[e],s=e-1==-1?0:n.visibledatarow[e-1],o=n.visibledatacolumn[l],a=l-1==-1?0:n.visibledatacolumn[l-1],d=h.mergeborer(n.flowdata,e,l);d&&(i=d.row[1],s=d.row[0],o=d.column[1],a=d.column[0]);let c=o,r=s,p=c+18*n.zoomRatio,m=r-18*n.zoomRatio;m<0&&(m=2);let v=this.defaultWidth*n.zoomRatio,y=this.defaultHeight*n.zoomRatio,g=this.getArrowCanvasSize(p,m,c,r),k='<div id="luckysheet-postil-show_'+e+"_"+l+'" class="luckysheet-postil-show luckysheet-postil-show-active"><canvas class="arrowCanvas" width="'+g[2]+'" height="'+g[3]+'" style="position:absolute;left:'+g[0]+"px;top:"+g[1]+'px;z-index:100;pointer-events:none;"></canvas><div class="luckysheet-postil-show-main" style="width:'+v+"px;height:"+y+"px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:"+p+"px;top:"+m+'px;box-sizing:border-box;z-index:100;"><div class="luckysheet-postil-dialog-move"><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t" data-type="t"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r" data-type="r"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b" data-type="b"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l" data-type="l"></div></div><div class="luckysheet-postil-dialog-resize"><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt" data-type="lt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt" data-type="mt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm" data-type="lm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm" data-type="rm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt" data-type="rt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb" data-type="lb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb" data-type="mb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb" data-type="rb"></div></div><div style="width:100%;height:100%;overflow:hidden;"><div class="formulaInputFocus" style="width:132px;height:72px;line-height:20px;box-sizing:border-box;text-align: center;word-break:break-all;" spellcheck="false" contenteditable="true"></div></div></div></div>';$(k).appendTo($("#luckysheet-cell-main #luckysheet-postil-showBoxs"));let w=$("#luckysheet-postil-show_"+e+"_"+l+" .arrowCanvas").get(0).getContext("2d");this.drawArrow(w,g[4],g[5],g[6],g[7]),$("#luckysheet-postil-show_"+e+"_"+l+" .formulaInputFocus").focus(),this.init();let f=t.deepCopyFlowData(n.flowdata),z=[];null==f[e][l]&&(f[e][l]={}),f[e][l].ps={left:null,top:null,width:null,height:null,value:"",isshow:!1},z.push(e+"_"+l),this.ref(f,z),setTimeout(()=>{u.createHookFunction("commentInsertAfter",e,l,f[e][l])},0)},editPs:function(e,t){let l=this;if(b(n.currentSheetIndex,"editObjects")){if($("#luckysheet-postil-show_"+e+"_"+t).length>0)$("#luckysheet-postil-show_"+e+"_"+t).show(),$("#luckysheet-postil-show_"+e+"_"+t).addClass("luckysheet-postil-show-active"),$("#luckysheet-postil-show_"+e+"_"+t).find(".luckysheet-postil-dialog-resize").show();else{let i=n.flowdata[e][t].ps,s=n.visibledatarow[e],o=e-1==-1?0:n.visibledatarow[e-1],a=n.visibledatacolumn[t],d=t-1==-1?0:n.visibledatacolumn[t-1],c=h.mergeborer(n.flowdata,e,t);c&&(s=c.row[1],o=c.row[0],a=c.column[1],d=c.column[0]);let r=a,p=o,u=null==i.left?r+18*n.zoomRatio:i.left*n.zoomRatio,m=null==i.top?p-18*n.zoomRatio:i.top*n.zoomRatio,v=null==i.width?l.defaultWidth*n.zoomRatio:i.width*n.zoomRatio,y=null==i.height?l.defaultHeight*n.zoomRatio:i.height*n.zoomRatio,g=null==i.value?"":i.value;m<0&&(m=2);let k=l.getArrowCanvasSize(u,m,r,p),w='<div id="luckysheet-postil-show_'+e+"_"+t+'" class="luckysheet-postil-show luckysheet-postil-show-active"><canvas class="arrowCanvas" width="'+k[2]+'" height="'+k[3]+'" style="position:absolute;left:'+k[0]+"px;top:"+k[1]+'px;z-index:100;pointer-events:none;"></canvas><div class="luckysheet-postil-show-main" style="width:'+v+"px;height:"+y+"px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:"+u+"px;top:"+m+'px;box-sizing:border-box;z-index:100;"><div class="luckysheet-postil-dialog-move"><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t" data-type="t"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r" data-type="r"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b" data-type="b"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l" data-type="l"></div></div><div class="luckysheet-postil-dialog-resize"><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt" data-type="lt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt" data-type="mt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm" data-type="lm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm" data-type="rm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt" data-type="rt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb" data-type="lb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb" data-type="mb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb" data-type="rb"></div></div><div style="width:100%;height:100%;overflow:hidden;"><div class="formulaInputFocus" style="width:'+(v-12)+"px;height:"+(y-12)+'px;line-height:20px;box-sizing:border-box;text-align: center;;word-break:break-all;" spellcheck="false" contenteditable="true">'+l.htmlEscape(g)+"</div></div></div></div>";$(w).appendTo($("#luckysheet-cell-main #luckysheet-postil-showBoxs"));let f=$("#luckysheet-postil-show_"+e+"_"+t+" .arrowCanvas").get(0).getContext("2d");l.drawArrow(f,k[4],k[5],k[6],k[7])}$("#luckysheet-postil-show_"+e+"_"+t+" .formulaInputFocus").focus(),g($("#luckysheet-postil-show_"+e+"_"+t+" .formulaInputFocus").get(0)),l.init()}},delPs:function(e,l){if(!b(n.currentSheetIndex,"editObjects"))return;if(!u.createHookFunction("commentDeleteBefore",e,l,n.flowdata[e][l]))return;$("#luckysheet-postil-show_"+e+"_"+l).length>0&&$("#luckysheet-postil-show_"+e+"_"+l).remove();let i=t.deepCopyFlowData(n.flowdata),s=[];delete i[e][l].ps,s.push(e+"_"+l),this.ref(i,s),setTimeout(()=>{u.createHookFunction("commentDeleteAfter",e,l,n.flowdata[e][l])},0)},showHidePs:function(e,l){let i=this,s=n.flowdata[e][l].ps,o=s.isshow,a=t.deepCopyFlowData(n.flowdata),d=[];if(o)a[e][l].ps.isshow=!1,$("#luckysheet-postil-show_"+e+"_"+l).remove();else{a[e][l].ps.isshow=!0;let t=n.visibledatarow[e],o=e-1==-1?0:n.visibledatarow[e-1],d=n.visibledatacolumn[l],r=l-1==-1?0:n.visibledatacolumn[l-1],p=h.mergeborer(n.flowdata,e,l);p&&(t=p.row[1],o=p.row[0],d=p.column[1],r=p.column[0]);let u=$("#luckysheet-cell-main").scrollLeft(),m=$("#luckysheet-cell-main").scrollTop(),v=d,y=o;null!=c.freezenverticaldata&&v<c.freezenverticaldata[0]-c.freezenverticaldata[2]&&(v+=u),null!=c.freezenhorizontaldata&&y<c.freezenhorizontaldata[0]-c.freezenhorizontaldata[2]&&(y+=m);let g=null==s.left?v+18*n.zoomRatio:s.left*n.zoomRatio,k=null==s.top?y-18*n.zoomRatio:s.top*n.zoomRatio,w=null==s.width?i.defaultWidth*n.zoomRatio:s.width*n.zoomRatio,f=null==s.height?i.defaultHeight*n.zoomRatio:s.height*n.zoomRatio,z=null==s.value?"":s.value;k<0&&(k=2);let b=i.getArrowCanvasSize(g,k,v,y),x='<div id="luckysheet-postil-show_'+e+"_"+l+'" class="luckysheet-postil-show"><canvas class="arrowCanvas" width="'+b[2]+'" height="'+b[3]+'" style="position:absolute;left:'+b[0]+"px;top:"+b[1]+'px;z-index:100;pointer-events:none;"></canvas><div class="luckysheet-postil-show-main" style="width:'+w+"px;height:"+f+"px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:"+g+"px;top:"+k+'px;box-sizing:border-box;z-index:100;"><div class="luckysheet-postil-dialog-move"><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t" data-type="t"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r" data-type="r"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b" data-type="b"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l" data-type="l"></div></div><div class="luckysheet-postil-dialog-resize" style="display:none;"><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt" data-type="lt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt" data-type="mt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm" data-type="lm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm" data-type="rm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt" data-type="rt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb" data-type="lb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb" data-type="mb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb" data-type="rb"></div></div><div style="width:100%;height:100%;overflow:hidden;"><div class="formulaInputFocus" style="width:'+(w-12)+"px;height:"+(f-12)+'px;line-height:20px;box-sizing:border-box;text-align: center;;word-break:break-all;" spellcheck="false" contenteditable="true">'+i.htmlEscape(z)+"</div></div></div></div>";$(x).appendTo($("#luckysheet-cell-main #luckysheet-postil-showBoxs"));let _=$("#luckysheet-postil-show_"+e+"_"+l+" .arrowCanvas").get(0).getContext("2d");i.drawArrow(_,b[4],b[5],b[6],b[7]),i.init()}d.push(e+"_"+l),i.ref(a,d)},showHideAllPs:function(){let e=this,l=t.deepCopyFlowData(n.flowdata),i=!0,s=[];for(let e=0;e<l.length;e++)for(let t=0;t<l[0].length;t++)null!=l[e]&&null!=l[e][t]&&null!=l[e][t].ps&&(s.push(e+"_"+t),l[e][t].ps.isshow||(i=!1));let o=[];if(s.length>0)if(i){$("#luckysheet-cell-main #luckysheet-postil-showBoxs").empty();for(let e=0;e<s.length;e++){let t=s[e].split("_")[0],i=s[e].split("_")[1];l[t][i].ps.isshow&&(l[t][i].ps.isshow=!1,o.push(s[e]))}}else for(let t=0;t<s.length;t++){let i=s[t].split("_")[0],a=s[t].split("_")[1],d=l[i][a].ps;if(!d.isshow){let r=n.visibledatarow[i],p=i-1==-1?0:n.visibledatarow[i-1],u=n.visibledatacolumn[a],m=a-1==-1?0:n.visibledatacolumn[a-1],v=h.mergeborer(n.flowdata,i,a);v&&(r=v.row[1],p=v.row[0],u=v.column[1],m=v.column[0]);let y=$("#luckysheet-cell-main").scrollLeft(),g=$("#luckysheet-cell-main").scrollTop(),k=u,w=p;null!=c.freezenverticaldata&&k<c.freezenverticaldata[0]-c.freezenverticaldata[2]&&(k+=y),null!=c.freezenhorizontaldata&&w<c.freezenhorizontaldata[0]-c.freezenhorizontaldata[2]&&(w+=g);let f=null==d.left?k+18*n.zoomRatio:d.left*n.zoomRatio,z=null==d.top?w-18*n.zoomRatio:d.top*n.zoomRatio,b=null==d.width?e.defaultWidth*n.zoomRatio:d.width*n.zoomRatio,x=null==d.height?e.defaultHeight*n.zoomRatio:d.height*n.zoomRatio,_=null==d.value?"":d.value;z<0&&(z=2);let C=e.getArrowCanvasSize(f,z,k,w),R='<div id="luckysheet-postil-show_'+i+"_"+a+'" class="luckysheet-postil-show"><canvas class="arrowCanvas" width="'+C[2]+'" height="'+C[3]+'" style="position:absolute;left:'+C[0]+"px;top:"+C[1]+'px;z-index:100;pointer-events:none;"></canvas><div class="luckysheet-postil-show-main" style="width:'+b+"px;height:"+x+"px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:"+f+"px;top:"+z+'px;box-sizing:border-box;z-index:100;"><div class="luckysheet-postil-dialog-move"><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t" data-type="t"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r" data-type="r"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b" data-type="b"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l" data-type="l"></div></div><div class="luckysheet-postil-dialog-resize" style="display:none;"><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt" data-type="lt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt" data-type="mt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm" data-type="lm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm" data-type="rm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt" data-type="rt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb" data-type="lb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb" data-type="mb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb" data-type="rb"></div></div><div style="width:100%;height:100%;overflow:hidden;"><div class="formulaInputFocus" style="width:'+(b-12)+"px;height:"+(x-12)+'px;line-height:20px;box-sizing:border-box;text-align: center;;word-break:break-all;" spellcheck="false" contenteditable="true">'+e.htmlEscape(_)+"</div></div></div></div>";$(R).appendTo($("#luckysheet-cell-main #luckysheet-postil-showBoxs"));let P=$("#luckysheet-postil-show_"+i+"_"+a+" .arrowCanvas").get(0).getContext("2d");e.drawArrow(P,C[4],C[5],C[6],C[7]),l[i][a].ps.isshow=!0,o.push(s[t])}}e.ref(l,o),e.init()},removeActivePs:function(){if($("#luckysheet-postil-showBoxs .luckysheet-postil-show-active").length>0){let e=$("#luckysheet-postil-showBoxs .luckysheet-postil-show-active").attr("id"),l=e.split("luckysheet-postil-show_")[1].split("_")[0],i=e.split("luckysheet-postil-show_")[1].split("_")[1],s=$("#"+e).find(".formulaInputFocus").text();if(!u.createHookFunction("commentUpdateBefore",l,i,s))return;const o=$.extend(!0,{},n.flowdata[l][i]);$("#"+e).removeClass("luckysheet-postil-show-active"),$("#"+e).find(".luckysheet-postil-dialog-resize").hide(),$("#"+e).find(".arrowCanvas").css("z-index",100),$("#"+e).find(".luckysheet-postil-show-main").css("z-index",100);let a=t.deepCopyFlowData(n.flowdata),d=[];a[l][i].ps.value=s,d.push(l+"_"+i),this.ref(a,d),a[l][i].ps.isshow||$("#"+e).remove(),setTimeout(()=>{u.createHookFunction("commentUpdateAfter",l,i,o,a[l][i])},0)}},ref:function(e,l){if(n.clearjfundo&&(n.jfundo.length=0,n.jfredo.push({type:"postil",data:n.flowdata,curdata:e,sheetIndex:n.currentSheetIndex,rc:l})),n.flowdata=e,t.webWorkerFlowDataCache(n.flowdata),n.luckysheetfile[f(n.currentSheetIndex)].data=n.flowdata,p.allowUpdate)for(let e=0;e<l.length;e++){let t=l[e].split("_")[0],i=l[e].split("_")[1];p.saveParam("v",n.currentSheetIndex,n.flowdata[t][i],{r:t,c:i})}setTimeout(function(){k()},1)},positionSync:function(){let e=this;$("#luckysheet-postil-showBoxs .luckysheet-postil-show").each(function(t,l){let i=$(l).attr("id"),s=i.split("luckysheet-postil-show_")[1].split("_")[0],o=i.split("luckysheet-postil-show_")[1].split("_")[1],a=n.flowdata[s][o];null!=a&&null!=a.ps?e.buildPs(s,o,a.ps):$("#"+i).hide()})},htmlEscape:function(e){return e.replace(/[<>"&]/g,function(e,t,l){switch(console.log(e,t,l),e){case"<":return"&lt";case">":return"&gt";case"&":return"&amp";case'"':return"&quot;"}})}}});
//# sourceMappingURL=../sourcemaps/controllers/postil.js.map
