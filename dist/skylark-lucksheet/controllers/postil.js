/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../methods/location","../widgets/cursorPos","../methods/set","../methods/get","../utils/util","../methods/cells","../methods/protection_methods","../store","../methods/luckysheetConfigsetting"],function(e,t,i,l,s,o,a,d,c){"use strict";const{rowLocation:h,colLocation:r,mouseposition:p}=e,{luckysheetRangeLast:n}=t,{setluckysheet_scroll_status:u}=i,{getSheetIndex:m}=l,{getObjType:v}=s,{checkProtectionAuthorityNormal:y}=a;return{defaultWidth:144,defaultHeight:84,currentObj:null,currentWinW:null,currentWinH:null,resize:null,resizeXY:null,move:!1,moveXY:null,init:function(){let e=this;$("#luckysheet-postil-showBoxs").off("mousedown.showPs").on("mousedown.showPs",".luckysheet-postil-show",function(t){y(d.currentSheetIndex,"editObjects",!1)&&(e.currentObj=$(this).find(".luckysheet-postil-show-main"),$(this).hasClass("luckysheet-postil-show-active")?t.stopPropagation():(e.removeActivePs(),$(this).addClass("luckysheet-postil-show-active"),$(this).find(".luckysheet-postil-dialog-resize").show(),$(this).find(".arrowCanvas").css("z-index",200),$(this).find(".luckysheet-postil-show-main").css("z-index",200),t.stopPropagation()))}),$("#luckysheet-postil-showBoxs").off("mouseup.showPs").on("mouseup.showPs",".luckysheet-postil-show",function(e){"3"==e.which&&e.stopPropagation()}),$("#luckysheet-postil-showBoxs").off("mousedown.resize").on("mousedown.resize",".luckysheet-postil-show .luckysheet-postil-dialog-resize .luckysheet-postil-dialog-resize-item",function(t){if(!y(d.currentSheetIndex,"editObjects",!1))return;e.currentObj=$(this).closest(".luckysheet-postil-show-main"),e.currentWinW=$("#luckysheet-cell-main")[0].scrollWidth,e.currentWinH=$("#luckysheet-cell-main")[0].scrollHeight,e.resize=$(this).data("type");let i=$("#luckysheet-cell-main").scrollTop(),l=$("#luckysheet-cell-main").scrollLeft(),s=p(t.pageX,t.pageY),o=s[0]+l,a=s[1]+i,c=e.currentObj.position(),h=e.currentObj.width(),r=e.currentObj.height();e.resizeXY=[o,a,h,r,c.left+l,c.top+i,l,i],u(!0),$(this).closest(".luckysheet-postil-show").hasClass("luckysheet-postil-show-active")?t.stopPropagation():(e.removeActivePs(),$(this).closest(".luckysheet-postil-show").addClass("luckysheet-postil-show-active"),$(this).closest(".luckysheet-postil-show").find(".luckysheet-postil-dialog-resize").show(),$(this).closest(".luckysheet-postil-show").find(".arrowCanvas").css("z-index",200),$(this).closest(".luckysheet-postil-show").find(".luckysheet-postil-show-main").css("z-index",200),t.stopPropagation())}),$("#luckysheet-postil-showBoxs").off("mousedown.move").on("mousedown.move",".luckysheet-postil-show .luckysheet-postil-dialog-move .luckysheet-postil-dialog-move-item",function(t){if(!y(d.currentSheetIndex,"editObjects",!1))return;e.currentObj=$(this).closest(".luckysheet-postil-show-main"),e.currentWinW=$("#luckysheet-cell-main")[0].scrollWidth,e.currentWinH=$("#luckysheet-cell-main")[0].scrollHeight,e.move=!0;let i=$("#luckysheet-cell-main").scrollTop(),l=$("#luckysheet-cell-main").scrollLeft(),s=e.currentObj.offset(),o=e.currentObj.position();e.moveXY=[t.pageX-s.left,t.pageY-s.top,o.left,o.top,l,i],u(!0),$(this).closest(".luckysheet-postil-show").hasClass("luckysheet-postil-show-active")?t.stopPropagation():(e.removeActivePs(),$(this).closest(".luckysheet-postil-show").addClass("luckysheet-postil-show-active"),$(this).closest(".luckysheet-postil-show").find(".luckysheet-postil-dialog-resize").show(),$(this).closest(".luckysheet-postil-show").find(".arrowCanvas").css("z-index",200),$(this).closest(".luckysheet-postil-show").find(".luckysheet-postil-show-main").css("z-index",200),t.stopPropagation())})},overshow:function(e){if($("#luckysheet-postil-overshow").remove(),0==$(e.target).closest("#luckysheet-cell-main").length)return;let t=p(e.pageX,e.pageY),i=$("#luckysheet-cell-main").scrollLeft(),l=$("#luckysheet-cell-main").scrollTop(),s=t[0],a=t[1],c=0,n=0;null!=d.freezenverticaldata&&t[0]<d.freezenverticaldata[0]-d.freezenverticaldata[2]?c=i:s+=i,null!=d.freezenhorizontaldata&&t[1]<d.freezenhorizontaldata[0]-d.freezenhorizontaldata[2]?n=l:a+=l;let u=h(a)[2],m=r(s)[2],v=o.mergeborer(d.flowdata,u,m);if(v&&(u=v.row[2],m=v.column[2]),null==d.flowdata[u]||null==d.flowdata[u][m]||null==d.flowdata[u][m].ps)return;let y=d.flowdata[u][m].ps;if(y.isshow||$("#luckysheet-postil-show_"+u+"_"+m).length>0)return;let k=null==y.value?"":y.value,g=d.visibledatarow[u],w=u-1==-1?0:d.visibledatarow[u-1],f=d.visibledatacolumn[m],z=m-1==-1?0:d.visibledatacolumn[m-1];v&&(g=v.row[1],w=v.row[0],f=v.column[1],z=v.column[0]);let b=f+c,x=w+n,_=b+18*d.zoomRatio,C=x-18*d.zoomRatio;C<0&&(C=2);let R=this.defaultWidth*d.zoomRatio,P=this.defaultHeight*d.zoomRatio,I=this.getArrowCanvasSize(_,C,b,x),A='<div id="luckysheet-postil-overshow"><canvas class="arrowCanvas" width="'+I[2]+'" height="'+I[3]+'" style="position:absolute;left:'+I[0]+"px;top:"+I[1]+'px;z-index:100;pointer-events:none;"></canvas><div style="width:'+(R-12)+"px;min-height:"+(P-12)+"px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:"+_+"px;top:"+C+'px;z-index:100;">'+this.htmlEscape(k)+"</div></div>";$(A).appendTo($("#luckysheet-cell-main"));let F=$("#luckysheet-postil-overshow .arrowCanvas").get(0).getContext("2d");this.drawArrow(F,I[4],I[5],I[6],I[7])},getArrowCanvasSize:function(e,t,i,l){let s=i-5;e<i&&(s=e-5);let o=l-5;t<l&&(o=t-5);let a=Math.abs(e-i)+10,d=Math.abs(t-l)+10,c=a-5,h=5;e<i&&(c=5,h=a-5);let r=d-5,p=5;return t<l&&(r=5,p=d-5),[s,o,a,d,c,r,h,p]},drawArrow:function(e,t,i,l,s,o,a,d,c){o="undefined"==v(o)?30:o,a="undefined"==v(a)?6:a,d="undefined"==v(d)?1:d,c="undefined"==v(c)?"#000":c;let h=180*Math.atan2(i-s,t-l)/Math.PI,r=(h+o)*Math.PI/180,p=(h-o)*Math.PI/180,n=a*Math.cos(r),u=a*Math.sin(r),m=a*Math.cos(p),y=a*Math.sin(p);e.save(),e.beginPath();let k=t-n,g=i-u;e.moveTo(k,g),e.moveTo(t,i),e.lineTo(l,s),e.lineWidth=d,e.strokeStyle=c,e.stroke(),k=l+n,g=s+u,e.moveTo(k,g),e.lineTo(l,s),k=l+m,g=s+y,e.lineTo(k,g),e.fillStyle=c,e.fill(),e.restore()},buildAllPs:function(e){let t=this;$("#luckysheet-cell-main #luckysheet-postil-showBoxs").empty();for(let i=0;i<e.length;i++)for(let l=0;l<e[0].length;l++)if(null!=e[i][l]&&null!=e[i][l].ps){let s=e[i][l].ps;t.buildPs(i,l,s)}t.init()},buildPs:function(e,t,i){if($("#luckysheet-postil-show_"+e+"_"+t).length>0&&$("#luckysheet-postil-show_"+e+"_"+t).remove(),null==i)return;let l=this;if(null!=i.isshow&&i.isshow){let s=d.visibledatarow[e],a=e-1==-1?0:d.visibledatarow[e-1],c=d.visibledatacolumn[t],h=t-1==-1?0:d.visibledatacolumn[t-1],r=o.mergeborer(d.flowdata,e,t);r&&(s=r.row[1],a=r.row[0],c=r.column[1],h=r.column[0]);let p=c,n=a,u=null==i.left?p+18*d.zoomRatio:i.left*d.zoomRatio,m=null==i.top?n-18*d.zoomRatio:i.top*d.zoomRatio,v=null==i.width?l.defaultWidth*d.zoomRatio:i.width*d.zoomRatio,y=null==i.height?l.defaultHeight*d.zoomRatio:i.height*d.zoomRatio,k=null==i.value?"":i.value;m<0&&(m=2);let g=l.getArrowCanvasSize(u,m,p,n),w='<div id="luckysheet-postil-show_'+e+"_"+t+'" class="luckysheet-postil-show"><canvas class="arrowCanvas" width="'+g[2]+'" height="'+g[3]+'" style="position:absolute;left:'+g[0]+"px;top:"+g[1]+'px;z-index:100;pointer-events:none;"></canvas><div class="luckysheet-postil-show-main" style="width:'+v+"px;height:"+y+"px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:"+u+"px;top:"+m+'px;box-sizing:border-box;z-index:100;"><div class="luckysheet-postil-dialog-move"><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t" data-type="t"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r" data-type="r"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b" data-type="b"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l" data-type="l"></div></div><div class="luckysheet-postil-dialog-resize" style="display:none;"><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt" data-type="lt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt" data-type="mt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm" data-type="lm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm" data-type="rm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt" data-type="rt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb" data-type="lb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb" data-type="mb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb" data-type="rb"></div></div><div style="width:100%;height:100%;overflow:hidden;"><div class="formulaInputFocus" style="width:'+(v-12)+"px;height:"+(y-12)+'px;line-height:20px;box-sizing:border-box;text-align: center;;word-break:break-all;" spellcheck="false" contenteditable="true">'+l.htmlEscape(k)+"</div></div></div></div>";$(w).appendTo($("#luckysheet-cell-main #luckysheet-postil-showBoxs"));let f=$("#luckysheet-postil-show_"+e+"_"+t+" .arrowCanvas").get(0).getContext("2d");l.drawArrow(f,g[4],g[5],g[6],g[7])}},newPs:function(e,t){if(!y(d.currentSheetIndex,"editObjects"))return;if(!c.createHookFunction("commentInsertBefore",e,t))return;let i=d.visibledatarow[e],l=e-1==-1?0:d.visibledatarow[e-1],s=d.visibledatacolumn[t],a=t-1==-1?0:d.visibledatacolumn[t-1],h=o.mergeborer(d.flowdata,e,t);h&&(i=h.row[1],l=h.row[0],s=h.column[1],a=h.column[0]);let r=s,p=l,n=r+18*d.zoomRatio,u=p-18*d.zoomRatio;u<0&&(u=2);let m=this.defaultWidth*d.zoomRatio,v=this.defaultHeight*d.zoomRatio,k=this.getArrowCanvasSize(n,u,r,p),g='<div id="luckysheet-postil-show_'+e+"_"+t+'" class="luckysheet-postil-show luckysheet-postil-show-active"><canvas class="arrowCanvas" width="'+k[2]+'" height="'+k[3]+'" style="position:absolute;left:'+k[0]+"px;top:"+k[1]+'px;z-index:100;pointer-events:none;"></canvas><div class="luckysheet-postil-show-main" style="width:'+m+"px;height:"+v+"px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:"+n+"px;top:"+u+'px;box-sizing:border-box;z-index:100;"><div class="luckysheet-postil-dialog-move"><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t" data-type="t"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r" data-type="r"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b" data-type="b"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l" data-type="l"></div></div><div class="luckysheet-postil-dialog-resize"><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt" data-type="lt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt" data-type="mt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm" data-type="lm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm" data-type="rm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt" data-type="rt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb" data-type="lb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb" data-type="mb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb" data-type="rb"></div></div><div style="width:100%;height:100%;overflow:hidden;"><div class="formulaInputFocus" style="width:132px;height:72px;line-height:20px;box-sizing:border-box;text-align: center;word-break:break-all;" spellcheck="false" contenteditable="true"></div></div></div></div>';$(g).appendTo($("#luckysheet-cell-main #luckysheet-postil-showBoxs"));let w=$("#luckysheet-postil-show_"+e+"_"+t+" .arrowCanvas").get(0).getContext("2d");this.drawArrow(w,k[4],k[5],k[6],k[7]),$("#luckysheet-postil-show_"+e+"_"+t+" .formulaInputFocus").focus(),this.init();let f=d.deepCopyFlowData(d.flowdata),z=[];null==f[e][t]&&(f[e][t]={}),f[e][t].ps={left:null,top:null,width:null,height:null,value:"",isshow:!1},z.push(e+"_"+t),this.ref(f,z),setTimeout(()=>{c.createHookFunction("commentInsertAfter",e,t,f[e][t])},0)},editPs:function(e,t){let i=this;if(y(d.currentSheetIndex,"editObjects")){if($("#luckysheet-postil-show_"+e+"_"+t).length>0)$("#luckysheet-postil-show_"+e+"_"+t).show(),$("#luckysheet-postil-show_"+e+"_"+t).addClass("luckysheet-postil-show-active"),$("#luckysheet-postil-show_"+e+"_"+t).find(".luckysheet-postil-dialog-resize").show();else{let l=d.flowdata[e][t].ps,s=d.visibledatarow[e],a=e-1==-1?0:d.visibledatarow[e-1],c=d.visibledatacolumn[t],h=t-1==-1?0:d.visibledatacolumn[t-1],r=o.mergeborer(d.flowdata,e,t);r&&(s=r.row[1],a=r.row[0],c=r.column[1],h=r.column[0]);let p=c,n=a,u=null==l.left?p+18*d.zoomRatio:l.left*d.zoomRatio,m=null==l.top?n-18*d.zoomRatio:l.top*d.zoomRatio,v=null==l.width?i.defaultWidth*d.zoomRatio:l.width*d.zoomRatio,y=null==l.height?i.defaultHeight*d.zoomRatio:l.height*d.zoomRatio,k=null==l.value?"":l.value;m<0&&(m=2);let g=i.getArrowCanvasSize(u,m,p,n),w='<div id="luckysheet-postil-show_'+e+"_"+t+'" class="luckysheet-postil-show luckysheet-postil-show-active"><canvas class="arrowCanvas" width="'+g[2]+'" height="'+g[3]+'" style="position:absolute;left:'+g[0]+"px;top:"+g[1]+'px;z-index:100;pointer-events:none;"></canvas><div class="luckysheet-postil-show-main" style="width:'+v+"px;height:"+y+"px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:"+u+"px;top:"+m+'px;box-sizing:border-box;z-index:100;"><div class="luckysheet-postil-dialog-move"><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t" data-type="t"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r" data-type="r"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b" data-type="b"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l" data-type="l"></div></div><div class="luckysheet-postil-dialog-resize"><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt" data-type="lt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt" data-type="mt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm" data-type="lm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm" data-type="rm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt" data-type="rt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb" data-type="lb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb" data-type="mb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb" data-type="rb"></div></div><div style="width:100%;height:100%;overflow:hidden;"><div class="formulaInputFocus" style="width:'+(v-12)+"px;height:"+(y-12)+'px;line-height:20px;box-sizing:border-box;text-align: center;;word-break:break-all;" spellcheck="false" contenteditable="true">'+i.htmlEscape(k)+"</div></div></div></div>";$(w).appendTo($("#luckysheet-cell-main #luckysheet-postil-showBoxs"));let f=$("#luckysheet-postil-show_"+e+"_"+t+" .arrowCanvas").get(0).getContext("2d");i.drawArrow(f,g[4],g[5],g[6],g[7])}$("#luckysheet-postil-show_"+e+"_"+t+" .formulaInputFocus").focus(),n($("#luckysheet-postil-show_"+e+"_"+t+" .formulaInputFocus").get(0)),i.init()}},delPs:function(e,t){if(!y(d.currentSheetIndex,"editObjects"))return;if(!c.createHookFunction("commentDeleteBefore",e,t,d.flowdata[e][t]))return;$("#luckysheet-postil-show_"+e+"_"+t).length>0&&$("#luckysheet-postil-show_"+e+"_"+t).remove();let i=d.deepCopyFlowData(d.flowdata),l=[];delete i[e][t].ps,l.push(e+"_"+t),this.ref(i,l),setTimeout(()=>{c.createHookFunction("commentDeleteAfter",e,t,d.flowdata[e][t])},0)},showHidePs:function(e,t){let i=this,l=d.flowdata[e][t].ps,s=l.isshow,a=d.deepCopyFlowData(d.flowdata),c=[];if(s)a[e][t].ps.isshow=!1,$("#luckysheet-postil-show_"+e+"_"+t).remove();else{a[e][t].ps.isshow=!0;let s=d.visibledatarow[e],c=e-1==-1?0:d.visibledatarow[e-1],h=d.visibledatacolumn[t],r=t-1==-1?0:d.visibledatacolumn[t-1],p=o.mergeborer(d.flowdata,e,t);p&&(s=p.row[1],c=p.row[0],h=p.column[1],r=p.column[0]);let n=$("#luckysheet-cell-main").scrollLeft(),u=$("#luckysheet-cell-main").scrollTop(),m=h,v=c;null!=d.freezenverticaldata&&m<d.freezenverticaldata[0]-d.freezenverticaldata[2]&&(m+=n),null!=d.freezenhorizontaldata&&v<d.freezenhorizontaldata[0]-d.freezenhorizontaldata[2]&&(v+=u);let y=null==l.left?m+18*d.zoomRatio:l.left*d.zoomRatio,k=null==l.top?v-18*d.zoomRatio:l.top*d.zoomRatio,g=null==l.width?i.defaultWidth*d.zoomRatio:l.width*d.zoomRatio,w=null==l.height?i.defaultHeight*d.zoomRatio:l.height*d.zoomRatio,f=null==l.value?"":l.value;k<0&&(k=2);let z=i.getArrowCanvasSize(y,k,m,v),b='<div id="luckysheet-postil-show_'+e+"_"+t+'" class="luckysheet-postil-show"><canvas class="arrowCanvas" width="'+z[2]+'" height="'+z[3]+'" style="position:absolute;left:'+z[0]+"px;top:"+z[1]+'px;z-index:100;pointer-events:none;"></canvas><div class="luckysheet-postil-show-main" style="width:'+g+"px;height:"+w+"px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:"+y+"px;top:"+k+'px;box-sizing:border-box;z-index:100;"><div class="luckysheet-postil-dialog-move"><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t" data-type="t"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r" data-type="r"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b" data-type="b"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l" data-type="l"></div></div><div class="luckysheet-postil-dialog-resize" style="display:none;"><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt" data-type="lt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt" data-type="mt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm" data-type="lm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm" data-type="rm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt" data-type="rt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb" data-type="lb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb" data-type="mb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb" data-type="rb"></div></div><div style="width:100%;height:100%;overflow:hidden;"><div class="formulaInputFocus" style="width:'+(g-12)+"px;height:"+(w-12)+'px;line-height:20px;box-sizing:border-box;text-align: center;;word-break:break-all;" spellcheck="false" contenteditable="true">'+i.htmlEscape(f)+"</div></div></div></div>";$(b).appendTo($("#luckysheet-cell-main #luckysheet-postil-showBoxs"));let x=$("#luckysheet-postil-show_"+e+"_"+t+" .arrowCanvas").get(0).getContext("2d");i.drawArrow(x,z[4],z[5],z[6],z[7]),i.init()}c.push(e+"_"+t),i.ref(a,c)},showHideAllPs:function(){let e=this,t=d.deepCopyFlowData(d.flowdata),i=!0,l=[];for(let e=0;e<t.length;e++)for(let s=0;s<t[0].length;s++)null!=t[e]&&null!=t[e][s]&&null!=t[e][s].ps&&(l.push(e+"_"+s),t[e][s].ps.isshow||(i=!1));let s=[];if(l.length>0)if(i){$("#luckysheet-cell-main #luckysheet-postil-showBoxs").empty();for(let e=0;e<l.length;e++){let i=l[e].split("_")[0],o=l[e].split("_")[1];t[i][o].ps.isshow&&(t[i][o].ps.isshow=!1,s.push(l[e]))}}else for(let i=0;i<l.length;i++){let a=l[i].split("_")[0],c=l[i].split("_")[1],h=t[a][c].ps;if(!h.isshow){let r=d.visibledatarow[a],p=a-1==-1?0:d.visibledatarow[a-1],n=d.visibledatacolumn[c],u=c-1==-1?0:d.visibledatacolumn[c-1],m=o.mergeborer(d.flowdata,a,c);m&&(r=m.row[1],p=m.row[0],n=m.column[1],u=m.column[0]);let v=$("#luckysheet-cell-main").scrollLeft(),y=$("#luckysheet-cell-main").scrollTop(),k=n,g=p;null!=d.freezenverticaldata&&k<d.freezenverticaldata[0]-d.freezenverticaldata[2]&&(k+=v),null!=d.freezenhorizontaldata&&g<d.freezenhorizontaldata[0]-d.freezenhorizontaldata[2]&&(g+=y);let w=null==h.left?k+18*d.zoomRatio:h.left*d.zoomRatio,f=null==h.top?g-18*d.zoomRatio:h.top*d.zoomRatio,z=null==h.width?e.defaultWidth*d.zoomRatio:h.width*d.zoomRatio,b=null==h.height?e.defaultHeight*d.zoomRatio:h.height*d.zoomRatio,x=null==h.value?"":h.value;f<0&&(f=2);let _=e.getArrowCanvasSize(w,f,k,g),C='<div id="luckysheet-postil-show_'+a+"_"+c+'" class="luckysheet-postil-show"><canvas class="arrowCanvas" width="'+_[2]+'" height="'+_[3]+'" style="position:absolute;left:'+_[0]+"px;top:"+_[1]+'px;z-index:100;pointer-events:none;"></canvas><div class="luckysheet-postil-show-main" style="width:'+z+"px;height:"+b+"px;color:#000;padding:5px;border:1px solid #000;background-color:rgb(255,255,225);position:absolute;left:"+w+"px;top:"+f+'px;box-sizing:border-box;z-index:100;"><div class="luckysheet-postil-dialog-move"><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-t" data-type="t"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-r" data-type="r"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-b" data-type="b"></div><div class="luckysheet-postil-dialog-move-item luckysheet-postil-dialog-move-item-l" data-type="l"></div></div><div class="luckysheet-postil-dialog-resize" style="display:none;"><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lt" data-type="lt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mt" data-type="mt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lm" data-type="lm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rm" data-type="rm"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rt" data-type="rt"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-lb" data-type="lb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-mb" data-type="mb"></div><div class="luckysheet-postil-dialog-resize-item luckysheet-postil-dialog-resize-item-rb" data-type="rb"></div></div><div style="width:100%;height:100%;overflow:hidden;"><div class="formulaInputFocus" style="width:'+(z-12)+"px;height:"+(b-12)+'px;line-height:20px;box-sizing:border-box;text-align: center;;word-break:break-all;" spellcheck="false" contenteditable="true">'+e.htmlEscape(x)+"</div></div></div></div>";$(C).appendTo($("#luckysheet-cell-main #luckysheet-postil-showBoxs"));let R=$("#luckysheet-postil-show_"+a+"_"+c+" .arrowCanvas").get(0).getContext("2d");e.drawArrow(R,_[4],_[5],_[6],_[7]),t[a][c].ps.isshow=!0,s.push(l[i])}}e.ref(t,s),e.init()},removeActivePs:function(){if($("#luckysheet-postil-showBoxs .luckysheet-postil-show-active").length>0){let e=$("#luckysheet-postil-showBoxs .luckysheet-postil-show-active").attr("id"),t=e.split("luckysheet-postil-show_")[1].split("_")[0],i=e.split("luckysheet-postil-show_")[1].split("_")[1],l=$("#"+e).find(".formulaInputFocus").text();if(!c.createHookFunction("commentUpdateBefore",t,i,l))return;const s=$.extend(!0,{},d.flowdata[t][i]);$("#"+e).removeClass("luckysheet-postil-show-active"),$("#"+e).find(".luckysheet-postil-dialog-resize").hide(),$("#"+e).find(".arrowCanvas").css("z-index",100),$("#"+e).find(".luckysheet-postil-show-main").css("z-index",100);let o=d.deepCopyFlowData(d.flowdata),a=[];o[t][i].ps.value=l,a.push(t+"_"+i),this.ref(o,a),o[t][i].ps.isshow||$("#"+e).remove(),setTimeout(()=>{c.createHookFunction("commentUpdateAfter",t,i,s,o[t][i])},0)}},ref:function(e,t){if(d.clearjfundo&&(d.jfundo.length=0,d.jfredo.push({type:"postil",data:d.flowdata,curdata:e,sheetIndex:d.currentSheetIndex,rc:t})),d.flowdata=e,d.webWorkerFlowDataCache(d.flowdata),d.luckysheetfile[m(d.currentSheetIndex)].data=d.flowdata,d.allowUpdate)for(let e=0;e<t.length;e++){let i=t[e].split("_")[0],l=t[e].split("_")[1];d.saveParam("v",d.currentSheetIndex,d.flowdata[i][l],{r:i,c:l})}d.refresh()},positionSync:function(){let e=this;$("#luckysheet-postil-showBoxs .luckysheet-postil-show").each(function(t,i){let l=$(i).attr("id"),s=l.split("luckysheet-postil-show_")[1].split("_")[0],o=l.split("luckysheet-postil-show_")[1].split("_")[1],a=d.flowdata[s][o];null!=a&&null!=a.ps?e.buildPs(s,o,a.ps):$("#"+l).hide()})},htmlEscape:function(e){return e.replace(/[<>"&]/g,function(e,t,i){switch(console.log(e,t,i),e){case"<":return"&lt";case">":return"&gt";case"&":return"&amp";case'"':return"&quot;"}})}}});
//# sourceMappingURL=../sourcemaps/controllers/postil.js.map
