/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-pako","../global/loading","../global/refresh","../global/editor","./constant","./sheetmanage","./menuButton","./filter","./freezen","./postil","./imageCtrl","./dataVerificationCtrl","./hyperlinkCtrl","../utils/util","../methods/get","../store","./select","../locale/locale","skylark-moment","../global/json"],function(e,t,l,i,n,o,a,r,c,s,u,h,d,f,m,p,g,k,y,v){"use strict";const{showloading:w,hideloading:x}=t,{luckysheetrefreshgrid:b,jfrefreshgrid_rhcw:I}=l,{sheetHTML:S,luckyColor:T}=n,{createFilterOptions:E}=r,{getObjType:C,replaceHtml:_,getByteLen:z}=f,{getSheetIndex:R}=m,{collaborativeEditBox:q}=g,O={gridKey:null,loadUrl:null,updateUrl:null,updateImageUrl:null,title:null,loadSheetUrl:null,retryTimer:null,allowUpdate:!1,historyParam:function(e,t,l){let i=this,n=l.row[0],o=l.row[1],a=l.column[0],r=l.column[1];if(n==o&&a==r){let l=e[n][a];i.saveParam("v",t,l,{r:n,c:a})}else{let l=o-n+1,c=r-a+1,s=Math.floor(1e3/c),u=Math.ceil(l/s);for(let l=0;l<u;l++){let c,h=n+s*l;c=l==u-1?o:n+s*(l+1)-1;let d=[];for(let t=h;t<=c;t++){let l=[];for(let i=a;i<=r;i++)null==e[t]?l.push(null):l.push(e[t][i]);d.push(l)}i.saveParam("rv",t,d,{range:{row:[h,c],column:[a,r]}}),l==u-1&&i.saveParam("rv_end",t,null)}}},saveParam:function(t,l,i,n){let o=this;if(!o.allowUpdate)return;void 0==i&&(i=null);let a={};if(a.t=t,a.i=l,a.v=i,"shs"===t)return;"rv"==t?a.range=n.range:"v"==t||"fu"==t||"fm"==t?(a.r=n.r,a.c=n.c):"fc"==t?(a.op=n.op,a.pos=n.pos):"drc"==t||"arc"==t||"h"==t||"wh"==t?a.rc=n.rc:"c"==t?(a.cid=n.cid,a.op=n.op):"f"==t?(a.op=n.op,a.pos=n.pos):"s"==t||("sh"==t?(a.op=n.op,null!=n.cur&&(a.cur=n.cur)):"cg"==t?a.k=n.k:"all"==t&&(a.k=n.k));let r=e.gzip(encodeURIComponent(JSON.stringify(a)),{to:"string"});null!=o.websocket&&o.websocket.send(r)},websocket:null,wxErrorCount:0,openWebSocket:function(){let e=this;if("WebSocket"in window){let t=e.updateUrl+"?t=111&g="+encodeURIComponent(e.gridKey);e.updateUrl.indexOf("?")>-1&&(t=e.updateUrl+"&t=111&g="+encodeURIComponent(e.gridKey)),e.websocket=new WebSocket(t),e.websocket.onopen=function(){console.info(k().websocket.success),x(),e.wxErrorCount=0,e.retryTimer=setInterval(function(){e.websocket.send("rub")},6e4)},e.websocket.onmessage=function(t){p.result=t;let l=new Function("return "+t.data)();console.info(l);let i=l.type,{message:n,id:o}=l;if("用户退出"===n&&($("#luckysheet-multipleRange-show-"+o).hide(),p.cooperativeEdit.changeCollaborationSize=p.cooperativeEdit.changeCollaborationSize.filter(e=>e.id!=o),p.cooperativeEdit.checkoutData=p.cooperativeEdit.checkoutData.filter(e=>e.id!=o)),1==i);else if(2==i){let t=JSON.parse(l.data);e.wsUpdateMsg(t);let i=JSON.parse(l.data);"columnlen"==i.k?q(i.v,null):"rowlen"==i.k&&q(null,i.v)}else if(3==i){let t=l.id,i=l.username,n=JSON.parse(l.data),o=(n.t,n.i),a=n.v;0===p.cooperativeEdit.changeCollaborationSize.length&&p.cooperativeEdit.changeCollaborationSize.push({id:t,v:n.v[0],i:o}),p.cooperativeEdit.changeCollaborationSize.some(e=>e.id==t)?p.cooperativeEdit.changeCollaborationSize.forEach(e=>{e.id==t&&(e.v=n.v[0],e.i=o)}):p.cooperativeEdit.changeCollaborationSize.push({id:t,v:n.v[0],i:o}),"array"!=C(a)&&"object"!==C(a)&&(a=JSON.parse(a));let r=0,c=0;if(o==p.currentSheetIndex?"object"===C(a)&&"enterEdit"===a.op?(r=a.range[a.range.length-1].row[0],c=a.range[a.range.length-1].column[0],e.multipleRangeShow(t,i,r,c,a.op)):(r=a[a.length-1].row[0],c=a[a.length-1].column[0],e.multipleRangeShow(t,i,r,c)):"object"===C(a)&&"enterEdit"===a.op?(r=a.range[a.range.length-1].row[0],c=a.range[a.range.length-1].column[0]):(r=a[a.length-1].row[0],c=a[a.length-1].column[0]),0===p.cooperativeEdit.checkoutData.length&&(a.op?p.cooperativeEdit.checkoutData.push({id:t,username:i,r:r,c:c,op:a.op,index:o}):p.cooperativeEdit.checkoutData.push({id:t,username:i,r:r,c:c,index:o})),p.cooperativeEdit.checkoutData.some(e=>e.id==t)?p.cooperativeEdit.checkoutData.forEach(e=>{e.id==t&&(e.username=i,e.r=r,e.c=c,e.index=o,"enterEdit"===a.op&&(e.op=a.op))}):"enterEdit"===a.op?p.cooperativeEdit.checkoutData.push({id:t,username:i,r:r,c:c,op:a.op,index:o}):p.cooperativeEdit.checkoutData.push({id:t,username:i,r:r,c:c,index:o}),p.cooperativeEdit.checkoutData.forEach(e=>{e.index!=p.currentSheetIndex&&($("#luckysheet-multipleRange-show-"+e.id).hide(),e.op)}),$("#luckysheet-multipleRange-show-"+t)[0]){let e=$("#luckysheet-multipleRange-show-"+t)[0].offsetHeight-1;$("#luckysheet-multipleRange-show-"+t+">.username").css({bottom:e+"px"})}}else if(4==i){let t=""===l.data?l.data:JSON.parse(l.data);for(let l=0;l<t.length;l++)e.wsUpdateMsg(item[l])}},e.websocket.onerror=function(){e.wxErrorCount++,e.wxErrorCount>3?w(k().websocket.refresh):(w(k().websocket.wait),e.openWebSocket())},e.websocket.onclose=function(t){console.info(k().websocket.close),1e3===t.code?(clearInterval(e.retryTimer),e.retryTimer=null):alert(k().websocket.contact)}}else alert(k().websocket.support)},wsUpdateMsg:function(e){let t=e.t,l=e.i,n=e.v,a=p.luckysheetfile[R(l)];if(!["v","rv","cg","all","fc","drc","arc","f","fsc","fsr","sh","c"].includes(t)||null!=a)if("v"==t){if(null==a.data||0==a.data.length)return;let t=e.r,o=e.c;a.data[t][o]=n,l==p.currentSheetIndex&&(p.flowdata=a.data,i.webWorkerFlowDataCache(p.flowdata),null!=n&&null!=n.ps?s.buildPs(t,o,n.ps):s.buildPs(t,o,null),setTimeout(function(){b()},1))}else if("rv"==t){if(Object.keys(e.range).length>0&&(p.cooperativeEdit.merge_range=e.range,p.cooperativeEdit.merge_range.v=e.v,q()),null==a.data||0==a.data.length)return;let t=e.range.row[0],o=e.range.row[1],r=e.range.column[0],c=e.range.column[1];for(let e=t;e<=o;e++)for(let l=r;l<=c;l++)a.data[e][l]=n[e-t][l-r];if(l==p.currentSheetIndex){p.flowdata=a.data,i.webWorkerFlowDataCache(p.flowdata);for(let e=t;e<=o;e++)for(let l=r;l<=c;l++)null!=n[e-t][l-r]&&null!=n[e-t][l-r].ps?s.buildPs(e,l,n[e-t][l-r].ps):s.buildPs(e,l,null);setTimeout(function(){b()},1)}}else if("cg"==t){let t=e.k;if("borderInfo"==t)a.config.borderInfo=n;else{t in a.config||(a.config[t]={});for(let e in n)a.config[t][e]=n[e]}l==p.currentSheetIndex&&(p.config=a.config,"rowlen"!=t&&"columnlen"!=t&&"rowhidden"!=t||I(p.flowdata.length,p.flowdata[0].length),setTimeout(function(){b()},1))}else if("all"==t){let t=e.k;if(a[t]=n,"name"==t)$("#luckysheet-sheet-container-c #luckysheet-sheets-item"+l).find("span.luckysheet-sheets-item-name").html(n);else if("color"==t){let e=$("#luckysheet-sheet-container-c #luckysheet-sheets-item"+l);e.find(".luckysheet-sheets-item-color").remove(),null==n&&""==n||e.append('<div class="luckysheet-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: '+n+';"></div>')}else if("pivotTable"==t);else if("frozen"==t){if(c.frozenTofreezen(),l==p.currentSheetIndex){const e=k().freezen;null==a.freezen.horizontal?($("#luckysheet-freezen-btn-horizontal").html('<i class="fa fa-list-alt"></i> '+e.freezenRow),c.freezenhorizontaldata=null,$("#luckysheet-freezebar-horizontal").hide()):c.createFreezenHorizontal(a.freezen.horizontal.freezenhorizontaldata,a.freezen.horizontal.top),null==a.freezen.vertical?($("#luckysheet-freezen-btn-vertical").html('<i class="fa fa-indent"></i> '+e.freezenColumn),c.freezenverticaldata=null,$("#luckysheet-freezebar-vertical").hide()):c.createFreezenVertical(a.freezen.vertical.freezenverticaldata,a.freezen.vertical.left),c.createAssistCanvas()}}else"filter_select"==t?l==p.currentSheetIndex&&E(n):"filter"==t?l==p.currentSheetIndex&&E(a.filter_select,n):"luckysheet_conditionformat_save"==t?l==p.currentSheetIndex&&setTimeout(function(){b()},1):"luckysheet_alternateformat_save"==t?l==p.currentSheetIndex&&setTimeout(function(){b()},1):"config"==t?l==p.currentSheetIndex&&(p.config=n,I(p.flowdata.length,p.flowdata[0].length)):"dynamicArray"==t?l==p.currentSheetIndex&&setTimeout(function(){b()},1):"images"==t?l==p.currentSheetIndex&&(u.images=n,u.allImagesShow(),u.init()):"dataVerification"==t?l==p.currentSheetIndex&&(h.dataVerification=n,h.init()):"hyperlink"==t&&l==p.currentSheetIndex&&(d.hyperlink=n,d.init())}else if("fc"==t){let t=e.op;e.pos;"object"!=C(n)&&(n=new Function("return "+n)());let i=n.r,o=n.c,r=null==a.calcChain?[]:a.calcChain;if("add"==t)r.push(n);else if("del"==t)for(let e=0;e<r.length;e++)i==r[e].r&&o==r[e].c&&l==r[e].index&&r.splice(e,1);setTimeout(function(){b()},1)}else if("drc"==t){if(null==a.data||0==a.data.length)return;let t=e.rc,o=n.index,r=n.len,c=n.mc,s=n.borderInfo,u=a.data;if("r"==t){a.row-=r,u.splice(o,r);let e=[];for(let t=0;t<u[0].length;t++)e.push(null);for(let t=0;t<r;t++)u.push(e)}else{a.column-=r;let e=[];for(let t=0;t<r;t++)e.push(null);for(let t=0;t<u.length;t++)u[t].splice(o,r),u[t]=u[t].concat(e)}for(let e in c){let t=c[e].r,l=c[e].c;u[t][l].mc=c[e]}a.config.merge=c,a.config.borderInfo=s,l==p.currentSheetIndex&&(p.flowdata=u,i.webWorkerFlowDataCache(p.flowdata),p.config.merge=c,p.config.borderInfo=s,setTimeout(function(){b()},1))}else if("arc"==t){if(null==a.data||0==a.data.length)return;let t=e.rc,o=n.index,r=n.len,c=n.data,s=n.direction,u=n.mc,h=n.borderInfo,d=$.extend(!0,[],a.data);if("r"==t){a.row+=r;let e=[];for(let t=0;t<d[0].length;t++)e.push(null);let t=[];for(let l=0;l<r;l++)null==c[l]?t.push(JSON.stringify(e)):t.push(JSON.stringify(c[l]));"lefttop"==s?0==o?new Function("data","return data.unshift("+t.join(",")+")")(d):new Function("data","return data.splice("+o+", 0, "+t.join(",")+")")(d):new Function("data","return data.splice("+(o+1)+", 0, "+t.join(",")+")")(d)}else{a.column+=r;for(let e=0;e<d.length;e++)d[e].splice(o,0,c[e])}for(let e in u){let t=u[e].r,l=u[e].c;d[t][l].mc=u[e]}a.data=d,a.config.merge=u,a.config.borderInfo=h,l==p.currentSheetIndex&&(p.flowdata=d,i.webWorkerFlowDataCache(p.flowdata),p.config.merge=u,p.config.borderInfo=h,setTimeout(function(){b()},1))}else if("f"==t){let t=e.op,i=e.pos,o=a.filter;null==o&&(o={}),"upOrAdd"==t?o[i]=n:"del"==t&&delete o[i],l==p.currentSheetIndex&&E(a.filter_select,o)}else if("fsc"==t)a.filter=null,a.filter_select=null,l==p.currentSheetIndex&&($("#luckysheet-filter-selected-sheet"+p.currentSheetIndex+", #luckysheet-filter-options-sheet"+p.currentSheetIndex).remove(),$("#luckysheet-filter-menu, #luckysheet-filter-submenu").hide());else if("fsr"==t)a.filter=n.filter,a.filter_select=n.filter_select,l==p.currentSheetIndex&&E(a.filter_select,a.filter);else if("sha"==t){p.luckysheetfile.push(n);let e="";null!=n.color&&(e='<div class="luckysheet-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: '+n.color+';"></div>'),$("#luckysheet-sheet-container-c").append(_(S,{index:n.index,active:"",name:n.name,style:"",colorset:e})),$("#luckysheet-cell-main").append('<div id="luckysheet-datavisual-selection-set-'+n.index+'" class="luckysheet-datavisual-selection-set"></div>')}else if("shc"==t){let e=n.copyindex,t=n.name,i=R(e),o=$.extend(!0,{},p.luckysheetfile[i]);o.index=l,o.name=t,p.luckysheetfile.splice(i+1,0,o);let a=$("#luckysheet-sheets-item"+e);$("#luckysheet-sheet-container-c").append(_(S,{index:o.index,active:"",name:o.name,style:"",colorset:""})),$("#luckysheet-sheets-item"+o.index).insertAfter(a),$("#luckysheet-cell-main").append('<div id="luckysheet-datavisual-selection-set-'+o.index+'" class="luckysheet-datavisual-selection-set"></div>')}else if("shd"==t){for(let e=0;e<p.luckysheetfile.length;e++)if(p.luckysheetfile[e].index==n.deleIndex){if(p.currentSheetIndex===n.deleIndex){const e=n.deleIndex;p.luckysheetfile[o.getSheetIndex(e)].hide=1;let t=$("#luckysheet-sheets-item"+e);t.hide(),$("#luckysheet-sheet-area div.luckysheet-sheets-item").removeClass("luckysheet-sheets-item-active");let l=t.nextAll(":visible");l=t.nextAll(":visible").length>0?l.eq(0).data("index"):t.prevAll(":visible").eq(0).data("index"),$("#luckysheet-sheets-item"+l).addClass("luckysheet-sheets-item-active"),o.changeSheetExec(l)}O.sheetDeleSave.push(p.luckysheetfile[e]),p.luckysheetfile.splice(e,1);break}$("#luckysheet-sheets-item"+n.deleIndex).remove(),$("#luckysheet-datavisual-selection-set-"+n.deleIndex).remove()}else if("shr"==t)for(let e in n)p.luckysheetfile[R(e)].order=n[e];else if("shre"==t){for(let e=0;e<O.sheetDeleSave.length;e++)if(O.sheetDeleSave[e].index==n.reIndex){let t=O.sheetDeleSave[e];p.luckysheetfile.push(t);let l="";null!=n.color&&(l='<div class="luckysheet-sheets-item-color" style=" position: absolute; width: 100%; height: 3px; bottom: 0px; left: 0px; background-color: '+t.color+';"></div>'),$("#luckysheet-sheet-container-c").append(_(S,{index:t.index,active:"",name:t.name,style:"",colorset:l})),$("#luckysheet-cell-main").append('<div id="luckysheet-datavisual-selection-set-'+t.index+'" class="luckysheet-datavisual-selection-set"></div>');break}}else if("sh"==t){let t=e.op,i=e.cur;"hide"==t?(a.hide=1,$("#luckysheet-sheets-item"+l).hide(),l==p.currentSheetIndex&&($("#luckysheet-sheets-item"+i).addClass("luckysheet-sheets-item-active"),o.changeSheetExec(i))):"show"==t&&(a.hide=0,$("#luckysheet-sheets-item"+l).show())}else if("c"==t){let t=e.op,l=e.cid;if("add"==t)a.chart.push(n),luckysheet.insertChartTosheet(n.sheetIndex,n.dataSheetIndex,n.option,n.chartType,n.selfOption,n.defaultOption,n.row,n.column,n.chart_selection_color,n.chart_id,n.chart_selection_id,n.chartStyle,n.rangeConfigCheck,n.rangeRowCheck,n.rangeColCheck,n.chartMarkConfig,n.chartTitleConfig,n.winWidth,n.winHeight,n.scrollLeft1,n.scrollTop1,n.chartTheme,n.myWidth,n.myHeight,n.myLeft,n.myTop,n.myindexrank1,!0);else if("xy"==t||"wh"==t||"update"==t)for(let e=0;e<a.chart.length;e++){let t=a.chart[e];if(t.chart_id==l){for(let e in t)for(let l in n)e==l&&(t[e]=n[l]);return void o.saveChart(t)}}else if("del"==t)for(let e=0;e<a.chart.length;e++){if(a.chart[e].chart_id==l)return a.chart.splice(e,1),$("#"+l).remove(),void o.delChart($("#"+l).attr("chart_id"),$("#"+l).attr("sheetIndex"))}}else"na"==t&&$("#luckysheet_info_detail_input").val(n).css("width",10*z(n))},multipleIndex:0,multipleRangeShow:function(e,t,l,i,n){let o=this,r=p.visibledatarow[l],c=l-1==-1?0:p.visibledatarow[l-1],s=p.visibledatacolumn[i],u=i-1==-1?0:p.visibledatacolumn[i-1],h=a.mergeborer(p.flowdata,l,i);if(h&&(r=h.row[1],c=h.row[0],s=h.column[1],u=h.column[0]),z(t)>16&&(t=z(t,16)+"..."),"enterEdit"===n&&(t+=" "+k().edit.typing),$("#luckysheet-multipleRange-show-"+e).length>0)$("#luckysheet-multipleRange-show-"+e).css({position:"absolute",left:u-1,width:s-u-1,top:c-1,height:r-c-1}),$("#luckysheet-multipleRange-show-"+e+" .username").text(t),$("#luckysheet-multipleRange-show-"+e+" .username").show(),null!=p.cooperativeEdit.usernameTimeout["user"+e]&&clearTimeout(p.cooperativeEdit.usernameTimeout["user"+e]),p.cooperativeEdit.usernameTimeout["user"+e]=setTimeout(()=>{clearTimeout(p.cooperativeEdit.usernameTimeout["user"+e]),p.cooperativeEdit.usernameTimeout["user"+e]=null},1e4);else{let l=`<div \n\t\t\t\t\t\t\t\tid="luckysheet-multipleRange-show-${e}"\n\t\t\t\t\t\t\t\tclass="luckysheet-multipleRange-show"\n\t\t\t\t\t\t\t\tdata-color="${T[o.multipleIndex]}" \n\t\t\t\t\t\t\t\ttitle="${t}" \n\t\t\t\t\t\t\t\tstyle="position: absolute;left: ${u-1}px;width: ${s-u-1}px;top: ${c-1}px;height: ${r-c-1}px;border: 1px solid ${T[o.multipleIndex]};z-index: 15;">\n\n\t\t\t\t\t\t\t\t<div class="username" style="height: 19px;line-height:19px;width: max-content;position: absolute;bottom: ${r-c-1}px;right: 0;background-color: ${T[o.multipleIndex]};color:#ffffff;padding:0 10px;">\n\t\t\t\t\t\t\t\t${t}\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t<div style="width: 100%;height: 100%;position: absolute;top: 0;right: 0;bottom: 0;left: 0;opacity: 0.03;background-color: ${T[o.multipleIndex]}">\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t</div>`;$(l).appendTo($("#luckysheet-cell-main #luckysheet-multipleRange-show")),o.multipleIndex++,null!=p.cooperativeEdit.usernameTimeout["user"+e]&&clearTimeout(p.cooperativeEdit.usernameTimeout["user"+e]),p.cooperativeEdit.usernameTimeout["user"+e]=setTimeout(()=>{clearTimeout(p.cooperativeEdit.usernameTimeout["user"+e]),p.cooperativeEdit.usernameTimeout["user"+e]=null},1e4)}},sheetDeleSave:[],submitInterval:1e3,imagesubmitInterval:5e3,submitdatalimit:50,submitcompresslimit:1e3,checksubmit:function(e){let t=this;t.submitTimeout(),clearTimeout(t.imageRequestTimeout),t.imageRequestTimeout=setTimeout(function(){t.imageRequest()},t.imagesubmitInterval)},submitTimeout:function(){let e=this;clearTimeout(e.requestTimeOut),!e.requestLock&&null!=e.requestlast&&e.requestlast.clone().add(1,"seconds").isBefore(y())&&e.request(),e.requestTimeOut=setTimeout(function(){e.submitTimeout()},e.submitInterval)},requestLock:!1,requestlast:null,firstchange:!0,requestTimeOut:null,request:function(){let e=this;this.gridKey;e.cachelocaldata(function(t,l){if(0==l.length)return;(l=encodeURIComponent(JSON.stringify(l))).length;e.requestLock=!0,""!=e.updateUrl&&$.post(e.updateUrl,{compress:!1,gridKey:e.gridKey,data:l},function(t){new Function("return "+t)().status?($("#luckysheet_info_detail_update").html("最近存档时间:"+y().format("M-D H:m:s")),$("#luckysheet_info_detail_save").html("同步成功"),e.clearcachelocaldata()):($("#luckysheet_info_detail_save").html("<span style='color:#ff2121'>同步失败</span>"),e.restorecachelocaldata()),e.requestlast=y(),e.requestLock=!1})})},imageRequestLast:null,imageRequestLock:!1,imageRequestTimeout:null,imageRequest:function(){let e=this;html2canvas($("#"+container).find(".luckysheet-grid-window").get(0),{onrendered:function(t){let l=$(t).appendTo("body");l.hide();let i=l.width(),n=l.height(),o=l.get(0).getContext("2d").getImageData(0,0,i,n),a=i,r=n;.54*a>r?a=r/.54:r=.54*a;let c=$("<canvas>").attr("width",a).attr("height",r)[0];c.getContext("2d").putImageData(o,0,0),l.attr("width",350),l.attr("height",189),l.get(0).getContext("2d").drawImage(c,0,0,350,189);let s=l.get(0).toDataURL("image/jpeg",.9),u=luckysheet.sheetmanage.getCurSheetnoset();e.imageRequestLock=!0;let h=encodeURIComponent(JSON.stringify({t:"thumb",img:s,curindex:u}));l.remove(),""!=e.updateImageUrl&&$.post(e.updateImageUrl,{compress:!1,gridKey:e.gridKey,data:h},function(t){new Function("return "+t)().status?imageRequestLast=y():$("#luckysheet_info_detail_save").html("<span style='color:#ff2121'>网络不稳定</span>"),e.imageRequestLock=!0})}})},localdata:[],matchOpt:function(e,t){for(let l in e){if("t"==l&&e.t in{drc:1,arc:1,sha:1,shc:1,shd:1})return!1;if("v"!=l){if(!(l in t))return!1;if(t[l]!=e[l])return!1}}return!0},deleteRepeatOpt:function(e,t){let l=e,i=this;if(t instanceof Array)for(let n=0;n<t.length;n++){let o=t[n];for(let t=0;t<l.length;t++){let a=e[n];i.matchOpt(o,a)&&delete l[t]}}else for(let e=0;e<l.length;e++){let n=l[e];i.matchOpt(t,n)&&delete l[e]}let n=[];for(let e=0;e<l.length;e++)null!=l[e]&&n.push(l[e]);return n},setlocaldata:function(e,t){this.gridKey;let l=this;l.getlocaldata(function(i){null==i&&(i=[]),e instanceof Array?i=i.concat(e):i.push(e),l.localdata=i,t(l.localdata)})},getlocaldata:function(e){this.gridKey;e(this.localdata)},clearlocaldata:function(e){this.gridKey;this.localdata=[],e()},cachelocaldata:function(e){let t=this,l=this.gridKey+"__qkcache",i=t.localdata,n=i.length;if(n>1){let e=[];e[0]=i[0];for(let l=1;l<n;l++){let n=i[l],o=!0;for(let l=0;l<e.length;l++){let i=e[l];if(t.matchOpt(n,i)){e.splice(l,1,n),o=!1;break}}o&&(e=e.concat(n))}i=e}null!=i&&0!=i.length&&t.clearlocaldata(function(){localforage.setItem(l,i).then(function(){e(l,i)})})},clearcachelocaldata:function(e){let t=this.gridKey+"__qkcache";localforage.removeItem(t,function(t,l){e&&"function"==typeof e&&e()})},restorecachelocaldata:function(e){let t=this.gridKey+"__qkcache",l=this;localforage.getItem(t).then(function(t){let i=t;l.getlocaldata(function(t){null==t&&(t=[]);let n=i.concat(t);l.localdata=n,e instanceof Function&&e(l.localdata)})})},keepHighLightBox:function(){p.cooperativeEdit.checkoutData.forEach(e=>{e.index==p.currentSheetIndex&&("enterEdit"===e.op?O.multipleRangeShow(e.id,e.username,e.r,e.c,e.op):O.multipleRangeShow(e.id,e.username,e.r,e.c))})}};return O});
//# sourceMappingURL=../sourcemaps/controllers/server.js.map
