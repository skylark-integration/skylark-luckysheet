/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["./mobile","../methods/luckysheetConfigsetting","./freezen","./pivotTable","./dropCell","./postil","../widgets/imageCtrl","../widgets/hyperlinkCtrl","../widgets/dataVerificationCtrl","./menuButton","./conditionformat","./alternateformat","./ifFormulaGenerator","./sheetmanage","./updateCell","../methods/sheetSearch","../widgets/resize","./sheetMove","../widgets/select","./selection","./controlHistory","./splitColumn","../widgets/cursorPos","../widgets/constant","../methods/protection_methods","./cellFormat","../utils/util","../methods/get","../methods/location","../methods/getRowlen","../methods/validate","../methods/count","../methods/cells","../utils/browser","./formula","../widgets/extend","./scroll","../methods/getdata","../widgets/tooltip","../methods/format","../widgets/method","../methods/border","../widgets/draw","../locale/locale","../store","../expendPlugins/chart/plugin"],function(e,t,l,c,o,s,r,a,n,i,u,h,d,m,y,f,g,k,_,p,w,v,b,z,C,R,x,S,M,T,I,H,X,A,L,P,W,F,j,O,B,D,Y,E,q,N){"use strict";const{luckysheetupdateCell:U}=y,{luckysheet_searcharray:V}=f,{luckysheetMoveHighlightCell:K}=k,{selectHightlightShow:G,selectIsOverlap:Q,selectionCopyShow:J,luckysheet_count_show:Z,selectHelpboxFill:ee}=_,{hideMenuByCancel:te}=b,{luckysheetdefaultstyle:le}=z,{checkProtectionLockedRangeList:ce,checkProtectionAllSelected:oe,checkProtectionSelectLockedOrUnLockedCells:se,checkProtectionNotEnable:re,checkProtectionAuthorityNormal:ae}=C,{openCellFormatModel:ne}=R,{replaceHtml:ie,getObjType:ue,chatatABC:he,ArrayUnique:de,showrightclickmenu:me,luckysheetactiveCell:ye,luckysheetContainerFocus:fe,$$:ge}=x,{getSheetIndex:ke,getRangetxt:_e}=S,{rowLocation:pe,colLocation:we,mouseposition:ve}=M,{rowlenByRange:be}=T,{isRealNull:$e,hasPartMC:ze}=I,{isEditMode:Ce}=t,{countfunc:Re}=H,{luckysheetextendtable:xe}=P,{getdatabyselection:Se,datagridgrowth:Me}=F,{genarate:Te}=O,{getBorderInfoCompute:Ie}=D,{luckysheetDrawMain:He}=Y,{createLuckyChart:Xe,hideAllNeedRangeShow:Ae}=N;return function(){A.detectOS();A.mobilecheck()&&e(),Date.now||(Date.now=function(){return(new Date).getTime()}),function(){for(var e=["webkit","moz"],t=0;t<e.length&&!window.requestAnimationFrame;++t){var l=e[t];window.requestAnimationFrame=window[l+"RequestAnimationFrame"],window.cancelAnimationFrame=window[l+"CancelAnimationFrame"]||window[l+"CancelRequestAnimationFrame"]}if(/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)||!window.requestAnimationFrame||!window.cancelAnimationFrame){var c=0;window.requestAnimationFrame=function(e){var t=Date.now(),l=Math.max(c+16,t);return setTimeout(function(){e(c=l)},l-t)},window.cancelAnimationFrame=clearTimeout}}(),$("#luckysheet-sheet-container-c").mousewheel(function(e,t){let l=e.deltaFactor<40?1:e.deltaFactor<80?2:3,c=$(this).scrollLeft();0!=e.deltaY?e.deltaY<0?c+=10*l:c-=10*l:0!=e.deltaX&&(e.deltaX>0?c+=10*l:c-=10*l),$(this).scrollLeft(c),e.preventDefault()}),$("#luckysheet-cell-main").scroll(function(){}).mousewheel(function(e,t){e.preventDefault()});const y=E(),f=y.drag,k=y.info;let _;$("#luckysheet-grid-window-1").mousewheel(function(e,t){let l=$("#luckysheet-scrollbar-x").scrollLeft(),c=$("#luckysheet-scrollbar-y").scrollTop(),o=q.visibledatacolumn,s=q.visibledatarow;null!=q.freezenhorizontaldata&&(s=q.freezenhorizontaldata[3]),null!=q.freezenverticaldata&&(o=q.freezenverticaldata[3]),clearTimeout(_),null!=q.visibledatacolumn_unique?o=q.visibledatacolumn_unique:(o=de(o),q.visibledatacolumn_unique=o),null!=q.visibledatarow_unique?s=q.visibledatarow_unique:(s=de(s),q.visibledatarow_unique=s);V(o,l);let r=V(s,c);null!=q.freezenhorizontaldata&&(r=V(s,c+q.freezenhorizontaldata[0]));let a=0,n=e.deltaFactor<40?1:e.deltaFactor<80?2:3;if(0!=e.deltaY){let t,l=Math.round(n/q.zoomRatio);l=l<1?1:l,e.deltaY<0?(t=r+l)>=s.length&&(t=s.length-1):(t=r-l)<0&&(t=0),a=0==t?0:s[t-1],null!=q.freezenhorizontaldata&&(a-=q.freezenhorizontaldata[0]),$("#luckysheet-scrollbar-y").scrollTop(a)}else if(0!=e.deltaX){e.deltaX>0?l+=20*q.zoomRatio:l-=20*q.zoomRatio,$("#luckysheet-scrollbar-x").scrollLeft(l)}_=setTimeout(()=>{q.visibledatacolumn_unique=null,q.visibledatarow_unique=null},500)}),$("#luckysheet-scrollbar-x").scroll(function(){W()}).mousewheel(function(e,t){e.preventDefault()}),$("#luckysheet-scrollbar-y").scroll(function(){W()}).mousewheel(function(e,t){e.preventDefault()}),$(window).resize(function(){document.getElementById(q.container)&&g()}),$("#luckysheet-rich-text-editor").mouseup(function(e){i.inputMenuButtonFocus(e.target)}),$("#luckysheet-cell-main, #luckysheetTableContent").mousedown(function(e){if($(e.target).hasClass("luckysheet-mousedown-cancel"))return;!function(){let e=ge(".luckysheet-multipleRange-show");void 0===e.length&&(e=[e]);e.forEach(e=>{const t=e.id.replace("luckysheet-multipleRange-show-","");null===q.cooperativeEdit.usernameTimeout["user"+t]&&(ge(".username",e).style.display="none")})}(),$("#luckysheet-cell-selected").find(".luckysheet-cs-fillhandle").css("cursor","default").end().find(".luckysheet-cs-draghandle").css("cursor","default"),$("#luckysheet-cell-main, #luckysheetTableContent, #luckysheet-sheettable_0").css("cursor","default"),s.removeActivePs(),($("#luckysheet-modal-dialog-activeImage").is(":visible")||$("#luckysheet-modal-dialog-cropping").is(":visible"))&&r.cancelActiveImgItem();let o=ve(e.pageX,e.pageY);if(o[0]>=q.cellmainWidth-q.cellMainSrollBarSize||o[1]>=q.cellmainHeight-q.cellMainSrollBarSize)return;let y=o[0]+$("#luckysheet-cell-main").scrollLeft(),f=o[1]+$("#luckysheet-cell-main").scrollTop();null!=q.freezenverticaldata&&o[0]<q.freezenverticaldata[0]-q.freezenverticaldata[2]&&(y=o[0]+q.freezenverticaldata[2]),null!=q.freezenhorizontaldata&&o[1]<q.freezenhorizontaldata[0]-q.freezenhorizontaldata[2]&&(f=o[1]+q.freezenhorizontaldata[2]);let g=m.getSheetByIndex(),k=$("#luckysheetTableContent").get(0).getContext("2d"),_=pe(f),p=_[1],w=_[0],v=_[2],b=we(y),z=b[1],C=b[0],R=b[2],x=v,S=R,M=X.mergeborer(q.flowdata,v,R);if(M&&(p=M.row[1],w=M.row[0],v=M.row[2],x=M.row[3],z=M.column[1],C=M.column[0],R=M.column[2],S=M.column[3]),!t.createHookFunction("cellMousedownBefore",q.flowdata[v][R],{r:v,c:R,start_r:w,start_c:C,end_r:p,end_c:z},g,k))return;if(n.cellFocus(v,R,!0),C<$("#luckysheet-cell-main").scrollLeft()&&$("#luckysheet-scrollbar-x").scrollLeft(C),w<$("#luckysheet-cell-main").scrollTop()&&$("#luckysheet-scrollbar-y").scrollTop(w),"3"==e.which){$("#luckysheet-dataVerification-showHintBox").hide();let e=!1;for(let t=0;t<q.luckysheet_select_save.length;t++)if(null!=q.luckysheet_select_save[t].row&&v>=q.luckysheet_select_save[t].row[0]&&v<=q.luckysheet_select_save[t].row[1]&&R>=q.luckysheet_select_save[t].column[0]&&R<=q.luckysheet_select_save[t].column[1]){e=!0;break}if(e)return}if(null!=q.flowdata[v]&&null!=q.flowdata[v][R]&&null!=q.flowdata[v][R].dd&&null!=t.fireMousedown&&"function"==ue(t.fireMousedown))return void t.fireMousedown(q.flowdata[v][R].dd);if(a.hyperlink&&a.hyperlink[v+"_"+R]&&"3"!=e.which)return void a.cellFocus(v,R);q.luckysheet_scroll_status=!0;let T=$("#luckysheet-input-box");if(parseInt(T.css("top"))>0){if(L.rangestart||L.rangedrag_column_start||L.rangedrag_row_start||L.israngeseleciton()){let t=[v,x],l=[R,S],c=C,o=z-C-1,s=w,r=p-w-1;if(e.shiftKey){let e=L.func_selectedrange,t=0,l=0,c=[];e.top>w?(t=w,l=e.top+e.height-w,e.row[1]>e.row_focus&&(e.row[1]=e.row_focus),c=[v,e.row[1]]):e.top==w?(t=w,l=e.top+e.height-w,c=[v,e.row[0]]):(t=e.top,l=p-e.top-1,e.row[0]<e.row_focus&&(e.row[0]=e.row_focus),c=[e.row[0],v]);let o=0,s=0,r=[];e.left>C?(o=C,s=e.left+e.width-C,e.column[1]>e.column_focus&&(e.column[1]=e.column_focus),r=[R,e.column[1]]):e.left==C?(o=C,s=e.left+e.width-C,r=[R,e.column[0]]):(o=e.left,s=z-e.left-1,e.column[0]<e.column_focus&&(e.column[0]=e.column_focus),r=[e.column[0],R]);let a=X.mergeMoveMain(r,c,e,t,l,o,s);null!=a&&(r=a[0],c=a[1],t=a[2],l=a[3],o=a[4],s=a[5]),Z(o,t,s,l,c,r),e.row=c,e.column=r,e.left_move=o,e.width_move=s,e.top_move=t,e.height_move=l,L.func_selectedrange=e}else if(e.ctrlKey&&","!=$("#luckysheet-rich-text-editor").find("span").last().text()){let e=$("#luckysheet-rich-text-editor").text();if(e.length>0){let t=e.substr(e.length-1,1);","!=t&&"="!=t&&"("!=t&&(e+=",")}if(e.length>0&&"="==e.substr(0,1)){if(e=L.functionHTMLGenerate(e),window.getSelection){let e=window.getSelection();L.functionRangeIndex=[$(e.anchorNode).parent().index(),e.anchorOffset]}else{let e=document.selection.createRange();L.functionRangeIndex=e}$("#luckysheet-rich-text-editor").html(e),L.canceFunctionrangeSelected(),L.createRangeHightlight()}L.rangestart=!1,L.rangedrag_column_start=!1,L.rangedrag_row_start=!1,$("#luckysheet-functionbox-cell").html(e),L.rangeHightlightselected($("#luckysheet-rich-text-editor")),L.israngeseleciton(),L.func_selectedrange={left:c,width:o,top:s,height:r,left_move:c,width_move:o,top_move:s,height_move:r,row:t,column:l,row_focus:v,column_focus:R}}else L.func_selectedrange={left:c,width:o,top:s,height:r,left_move:c,width_move:o,top_move:s,height_move:r,row:t,column:l,row_focus:v,column_focus:R};return L.rangeSetValue({row:t,column:l}),L.rangestart=!0,L.rangedrag_column_start=!1,L.rangedrag_row_start=!1,$("#luckysheet-formula-functionrange-select").css({left:c,width:o,top:s,height:r}).show(),$("#luckysheet-formula-help-c").hide(),Z(c,s,o,r,t,l),void setTimeout(function(){let e,t=window.getSelection().anchorNode;$("#luckysheet-search-formula-parm").is(":visible")||$("#luckysheet-search-formula-parm-select").is(":visible")?(e=$("#luckysheet-rich-text-editor"),L.rangechangeindex=L.data_parm_index):e=$(t).closest("div");let l=e.find("span[rangeindex='"+L.rangechangeindex+"']");L.setCaretPosition(l.get(0),0,l.html().length)},1)}L.updatecell(q.luckysheetCellUpdate[0],q.luckysheetCellUpdate[1]),q.luckysheet_select_status=!0,$("#luckysheet-info").is(":visible")&&(q.luckysheet_select_status=!1)}else se(v,R,q.currentSheetIndex)&&(q.luckysheet_select_status=!0);if($("#luckysheet-multiRange-dialog").is(":visible")){if(u.selectStatus=!0,q.luckysheet_select_status=!1,e.shiftKey){let e=u.selectRange[u.selectRange.length-1],t=0,l=0,c=[];e.top>w?(t=w,l=e.top+e.height-w,e.row[1]>e.row_focus&&(e.row[1]=e.row_focus),c=[v,e.row[1]]):e.top==w?(t=w,l=e.top+e.height-w,c=[v,e.row[0]]):(t=e.top,l=p-e.top-1,e.row[0]<e.row_focus&&(e.row[0]=e.row_focus),c=[e.row[0],v]);let o=0,s=0,r=[];e.left>C?(o=C,s=e.left+e.width-C,e.column[1]>e.column_focus&&(e.column[1]=e.column_focus),r=[R,e.column[1]]):e.left==C?(o=C,s=e.left+e.width-C,r=[R,e.column[0]]):(o=e.left,s=z-e.left-1,e.column[0]<e.column_focus&&(e.column[0]=e.column_focus),r=[e.column[0],R]);let a=X.mergeMoveMain(r,c,e,t,l,o,s);null!=a&&(r=a[0],c=a[1],t=a[2],l=a[3],o=a[4],s=a[5]),e.row=c,e.column=r,e.left_move=o,e.width_move=s,e.top_move=t,e.height_move=l,u.selectRange[u.selectRange.length-1]=e}else e.ctrlKey?u.selectRange.push({left:C,width:z-C-1,top:w,height:p-w-1,left_move:C,width_move:z-C-1,top_move:w,height_move:p-w-1,row:[v,x],column:[R,S],row_focus:v,column_focus:R}):(u.selectRange=[],u.selectRange.push({left:C,width:z-C-1,top:w,height:p-w-1,left_move:C,width_move:z-C-1,top_move:w,height_move:p-w-1,row:[v,x],column:[R,S],row_focus:v,column_focus:R}));J(u.selectRange);let t=u.getTxtByRange(u.selectRange);$("#luckysheet-multiRange-dialog input").val(t)}else if(u.selectStatus=!1,u.selectRange=[],$("#luckysheet-singleRange-dialog").is(":visible")){q.luckysheet_select_status=!1,J([{row:[v,v],column:[R,R]}]);let e=_e(q.currentSheetIndex,{row:[v,v],column:[R,R]},q.currentSheetIndex);$("#luckysheet-singleRange-dialog input").val(e)}else{if($("#luckysheet-dataVerificationRange-dialog").is(":visible")){if(n.selectStatus=!0,q.luckysheet_select_status=!1,e.shiftKey){let e=n.selectRange[n.selectRange.length-1],t=0,l=0,c=[];e.top>w?(t=w,l=e.top+e.height-w,e.row[1]>e.row_focus&&(e.row[1]=e.row_focus),c=[v,e.row[1]]):e.top==w?(t=w,l=e.top+e.height-w,c=[v,e.row[0]]):(t=e.top,l=p-e.top-1,e.row[0]<e.row_focus&&(e.row[0]=e.row_focus),c=[e.row[0],v]);let o=0,s=0,r=[];e.left>C?(o=C,s=e.left+e.width-C,e.column[1]>e.column_focus&&(e.column[1]=e.column_focus),r=[R,e.column[1]]):e.left==C?(o=C,s=e.left+e.width-C,r=[R,e.column[0]]):(o=e.left,s=z-e.left-1,e.column[0]<e.column_focus&&(e.column[0]=e.column_focus),r=[e.column[0],R]);let a=X.mergeMoveMain(r,c,e,t,l,o,s);null!=a&&(r=a[0],c=a[1],t=a[2],l=a[3],o=a[4],s=a[5]),e.row=c,e.column=r,e.left_move=o,e.width_move=s,e.top_move=t,e.height_move=l,n.selectRange[n.selectRange.length-1]=e}else n.selectRange=[],n.selectRange.push({left:C,width:z-C-1,top:w,height:p-w-1,left_move:C,width_move:z-C-1,top_move:w,height_move:p-w-1,row:[v,x],column:[R,S],row_focus:v,column_focus:R});J(n.selectRange);let t=n.getTxtByRange(n.selectRange);return L.rangetosheet!=q.currentSheetIndex&&(t=q.luckysheetfile[ke(q.currentSheetIndex)].name+"!"+t),void $("#luckysheet-dataVerificationRange-dialog input").val(t)}if(n.selectStatus=!1,n.selectRange=[],d.singleRangeFocus&&$("#luckysheet-ifFormulaGenerator-dialog .singRange").click(),$("#luckysheet-ifFormulaGenerator-singleRange-dialog").is(":visible")){q.luckysheet_select_status=!1,L.rangestart=!1,$("#luckysheet-formula-functionrange-select").css({left:C,width:z-C-1,top:w,height:p-w-1}).show(),$("#luckysheet-formula-help-c").hide();let e=_e(q.currentSheetIndex,{row:[v,v],column:[R,R]},q.currentSheetIndex);$("#luckysheet-ifFormulaGenerator-singleRange-dialog input").val(e)}else{if($("#luckysheet-ifFormulaGenerator-multiRange-dialog").is(":visible")){q.luckysheet_select_status=!1,L.func_selectedrange={left:C,width:z-C-1,top:w,height:p-w-1,left_move:C,width_move:z-C-1,top_move:w,height_move:p-w-1,row:[v,v],column:[R,R],row_focus:v,column_focus:R},L.rangestart=!0,$("#luckysheet-formula-functionrange-select").css({left:C,width:z-C-1,top:w,height:p-w-1}).show(),$("#luckysheet-formula-help-c").hide();let e=_e(q.currentSheetIndex,{row:[v,v],column:[R,R]},q.currentSheetIndex);return $("#luckysheet-ifFormulaGenerator-multiRange-dialog input").val(e),$("#luckysheet-row-count-show").hide(),void $("#luckysheet-column-count-show").hide()}if(q.luckysheet_select_status){if(e.shiftKey){let e=$.extend(!0,{},q.luckysheet_select_save[q.luckysheet_select_save.length-1]),t=0,l=0,o=[];e.top>w?(t=w,l=e.top+e.height-w,e.row[1]>e.row_focus&&(e.row[1]=e.row_focus),o=[v,e.row[1]]):e.top==w?(t=w,l=e.top+e.height-w,o=[v,e.row[0]]):(t=e.top,l=p-e.top-1,e.row[0]<e.row_focus&&(e.row[0]=e.row_focus),o=[e.row[0],v]);let s=0,r=0,a=[];e.left>C?(s=C,r=e.left+e.width-C,e.column[1]>e.column_focus&&(e.column[1]=e.column_focus),a=[R,e.column[1]]):e.left==C?(s=C,r=e.left+e.width-C,a=[R,e.column[0]]):(s=e.left,r=z-e.left-1,e.column[0]<e.column_focus&&(e.column[0]=e.column_focus),a=[e.column[0],R]);let n=X.mergeMoveMain(a,o,e,t,l,s,r);null!=n&&(a=n[0],o=n[1],t=n[2],l=n[3],s=n[4],r=n[5]),e.row=o,e.column=a,e.left_move=s,e.width_move=r,e.top_move=t,e.height_move=l,q.luckysheet_select_save[q.luckysheet_select_save.length-1]=e,$("#luckysheet-alternateformat-rangeDialog").is(":visible")&&$("#luckysheet-alternateformat-rangeDialog input").val(_e(q.currentSheetIndex,q.luckysheet_select_save)),c.luckysheet_pivotTable_select_state&&$("#luckysheet-pivotTable-range-selection-input").val(q.luckysheetfile[ke(q.currentSheetIndex)].name+"!"+he(q.luckysheet_select_save[0].column[0])+(q.luckysheet_select_save[0].row[0]+1)+":"+he(q.luckysheet_select_save[0].column[1])+(q.luckysheet_select_save[0].row[1]+1))}else e.ctrlKey?q.luckysheet_select_save.push({left:C,width:z-C-1,top:w,height:p-w-1,left_move:C,width_move:z-C-1,top_move:w,height_move:p-w-1,row:[v,x],column:[R,S],row_focus:v,column_focus:R}):(q.luckysheet_select_save.length=0,q.luckysheet_select_save.push({left:C,width:z-C-1,top:w,height:p-w-1,left_move:C,width_move:z-C-1,top_move:w,height_move:p-w-1,row:[v,x],column:[R,S],row_focus:v,column_focus:R}),i.menuButtonFocus(q.flowdata,v,R),L.fucntionboxshow(v,R));G(),null==q.freezenhorizontaldata&&null==q.freezenverticaldata||l.scrollAdaptOfselect(),A.mobilecheck()||ye(),q.saveParam("mv",q.currentSheetIndex,q.luckysheet_select_save)}h.rangefocus&&(h.rangefocus=!1,$("#luckysheet-alternateformat-range .fa-table").click()),$("#luckysheet-row-count-show, #luckysheet-column-count-show").hide(),Ce()||Ae(),c.pivotclick(v,R,q.currentSheetIndex),fe(),t.createHookFunction("cellMousedown",q.flowdata[v][R],{r:v,c:R,start_r:w,start_c:C,end_r:p,end_c:z},g,k)}}}).mouseup(function(e){if("3"==e.which){if(!q.allowEdit)return;if(Ce())return;let l=e.pageX,c=e.pageY,o=(q.flowdata,q.luckysheet_select_save[0]);const s=t.cellRightClickConfig;if($("#luckysheet-cols-rows-data").show(),$("#luckysheet-cols-rows-handleincell").show(),$("#luckysheet-cols-rows-add, #luckysheet-cols-rows-shift").hide(),ge("#luckysheet-cols-rows-data .luckysheet-menuseparator").style.display="block",ge("#luckysheet-cols-rows-handleincell .luckysheet-menuseparator").style.display="block",null!=o.row&&0==o.row[0]&&o.row[1]==q.flowdata.length-1){if(!(s.copy||s.copyAs||s.paste||s.insertColumn||s.deleteColumn||s.hideColumn||s.columnWidth||s.clear||s.matrix||s.sort||s.filter||s.chart||s.image||s.link||s.data||s.cellFormat))return;q.luckysheetRightHeadClickIs="column",$("#luckysheet-rightclick-menu .luckysheet-cols-rows-shift-word").text(E().rightclick.column),$("#luckysheet-rightclick-menu .luckysheet-cols-rows-shift-size").text(E().rightclick.width),$("#luckysheet-rightclick-menu .luckysheet-cols-rows-shift-left").text(E().rightclick.left),$("#luckysheet-rightclick-menu .luckysheet-cols-rows-shift-right").text(E().rightclick.right),$("#luckysheet-cols-rows-add").show(),$("#luckysheet-cols-rows-shift").hide(),$("#luckysheet-cols-rows-handleincell").hide(),q.luckysheet_cols_menu_status=!0,ge("#luckysheet-cols-rows-add .luckysheet-menuseparator").style.display="block",ge("#luckysheet-top-left-add-selected").style.display=s.insertColumn?"block":"none",ge("#luckysheet-bottom-right-add-selected").style.display=s.insertColumn?"block":"none",ge("#luckysheet-del-selected").style.display=s.deleteColumn?"block":"none",ge("#luckysheet-hide-selected").style.display=s.hideColumn?"block":"none",ge("#luckysheet-show-selected").style.display=s.hideColumn?"block":"none",ge("#luckysheet-column-row-width-selected").style.display=s.columnWidth?"block":"none",s.copy||s.copyAs||s.paste||(ge("#luckysheet-cols-rows-add .luckysheet-menuseparator").style.display="none",s.insertColumn||s.deleteColumn||s.hideColumn||s.columnWidth||(ge("#luckysheet-cols-rows-data .luckysheet-menuseparator").style.display="none")),s.insertColumn||s.deleteColumn||s.hideColumn||s.columnWidth||(ge("#luckysheet-cols-rows-add .luckysheet-menuseparator").style.display="none");let e=$.extend(!0,{},q.config);null==e.columnlen&&(e.columnlen={});let t=null==e.columnlen[q.luckysheet_select_save[0].column[0]]?q.defaultcollen:e.columnlen[q.luckysheet_select_save[0].column[0]],l=!0;for(let c=0;c<q.luckysheet_select_save.length;c++){let o=q.luckysheet_select_save[c],s=o.column[0],r=o.column[1];for(let c=s;c<=r;c++){if((null==e.columnlen[c]?q.defaultcollen:e.columnlen[c])!=t){l=!1;break}}}l?$("#luckysheet-cols-rows-add").find("input[type='number'].rcsize").val(t):$("#luckysheet-cols-rows-add").find("input[type='number'].rcsize").val("")}else if(null!=o.column&&0==o.column[0]&&o.column[1]==q.flowdata[0].length-1){if(!(s.copy||s.copyAs||s.paste||s.insertRow||s.deleteRow||s.hideRow||s.rowHeight||s.clear||s.matrix||s.sort||s.filter||s.chart||s.image||s.link||s.data||s.cellFormat))return;q.luckysheetRightHeadClickIs="row",$("#luckysheet-rightclick-menu .luckysheet-cols-rows-shift-word").text(E().rightclick.row),$("#luckysheet-rightclick-menu .luckysheet-cols-rows-shift-size").text(E().rightclick.height),$("#luckysheet-rightclick-menu .luckysheet-cols-rows-shift-left").text(E().rightclick.top),$("#luckysheet-rightclick-menu .luckysheet-cols-rows-shift-right").text(E().rightclick.bottom),$("#luckysheet-cols-rows-add").show(),$("#luckysheet-cols-rows-shift").hide(),$("#luckysheet-cols-rows-handleincell").hide(),q.luckysheet_cols_menu_status=!0,ge("#luckysheet-cols-rows-add .luckysheet-menuseparator").style.display="block",ge("#luckysheet-top-left-add-selected").style.display=s.insertRow?"block":"none",ge("#luckysheet-bottom-right-add-selected").style.display=s.insertRow?"block":"none",ge("#luckysheet-del-selected").style.display=s.deleteRow?"block":"none",ge("#luckysheet-hide-selected").style.display=s.hideRow?"block":"none",ge("#luckysheet-show-selected").style.display=s.hideRow?"block":"none",ge("#luckysheet-column-row-width-selected").style.display=s.rowHeight?"block":"none",s.copy||s.copyAs||s.paste||(ge("#luckysheet-cols-rows-add .luckysheet-menuseparator").style.display="none",s.insertRow||s.deleteRow||s.hideRow||s.rowHeight||(ge("#luckysheet-cols-rows-data .luckysheet-menuseparator").style.display="none")),s.insertRow||s.deleteRow||s.hideRow||s.rowHeight||(ge("#luckysheet-cols-rows-add .luckysheet-menuseparator").style.display="none");let e=$.extend(!0,{},q.config);null==e.rowlen&&(e.rowlen={});let t=null==e.rowlen[q.luckysheet_select_save[0].row[0]]?q.defaultrowlen:e.rowlen[q.luckysheet_select_save[0].row[0]],l=!0;for(let c=0;c<q.luckysheet_select_save.length;c++){let o=q.luckysheet_select_save[c],s=o.row[0],r=o.row[1];for(let c=s;c<=r;c++){if((null==e.rowlen[c]?q.defaultrowlen:e.rowlen[c])!=t){l=!1;break}}}l?$("#luckysheet-cols-rows-add").find("input[type='number'].rcsize").val(t):$("#luckysheet-cols-rows-add").find("input[type='number'].rcsize").val("")}else{if(!(s.copy||s.copyAs||s.paste||s.insertRow||s.insertColumn||s.deleteRow||s.deleteColumn||s.deleteCell||s.clear||s.matrix||s.sort||s.filter||s.chart||s.image||s.link||s.data||s.cellFormat))return;s.copy||s.copyAs||s.paste||(ge("#luckysheet-cols-rows-handleincell .luckysheet-menuseparator").style.display="none",s.insertRow||s.insertColumn||s.deleteRow||s.deleteColumn||s.deleteCell||(ge("#luckysheet-cols-rows-data .luckysheet-menuseparator").style.display="none")),s.insertRow||s.insertColumn||s.deleteRow||s.deleteColumn||s.deleteCell||(ge("#luckysheet-cols-rows-handleincell .luckysheet-menuseparator").style.display="none")}s.clear||s.matrix||s.sort||s.filter||s.chart||s.image||s.link||s.data||s.cellFormat||(ge("#luckysheet-cols-rows-data .luckysheet-menuseparator").style.display="none"),me($("#luckysheet-rightclick-menu"),l,c)}q.saveParam("mv",q.currentSheetIndex,q.luckysheet_select_save)}).dblclick(function(e){if($(e.target).hasClass("luckysheet-mousedown-cancel"))return;if(!q.allowEdit)return;if(parseInt($("#luckysheet-input-box").css("top"))>0)return;let t=ve(e.pageX,e.pageY);if(t[0]>=q.cellmainWidth-q.cellMainSrollBarSize||t[1]>=q.cellmainHeight-q.cellMainSrollBarSize)return;let l=$("#luckysheet-cell-main").scrollLeft(),o=$("#luckysheet-cell-main").scrollTop(),s=t[0]+l,r=t[1]+o;null!=q.freezenverticaldata&&t[0]<q.freezenverticaldata[0]-q.freezenverticaldata[2]&&(s=t[0]+q.freezenverticaldata[2]),null!=q.freezenhorizontaldata&&t[1]<q.freezenhorizontaldata[0]-q.freezenhorizontaldata[2]&&(r=t[1]+q.freezenhorizontaldata[2]);let a=pe(r)[2],n=we(s)[2],u=X.mergeborer(q.flowdata,a,n);if(u&&(a=u.row[2],n=u.column[2]),c.isPivotRange(a,n)){if(!(null!=c.filter&&0!=c.filter.length||null!=c.row&&0!=c.row.length||null!=c.column&&0!=c.column.length||null!=c.values&&0!=c.values.length))return;if(null==c.values||0==c.values.length)return;if(0==a||0==n)return;if(null!=c.column&&c.column.length>0)if(c.values.length>=2&&"column"==c.showType){if(a<=c.column.length||n>=c.pivotDatas[0].length-c.values.length)return}else if(a<=c.column.length-1||n>=c.pivotDatas[0].length-1)return;if(null!=c.row&&c.row.length>0)if(c.values.length>=2&&"row"==c.showType){if(n<=c.row.length||a>=c.pivotDatas.length-c.values.length)return}else if(n<=c.row.length-1||a>=c.pivotDatas.length-1)return;return m.addNewSheet(e),void c.drillDown(a,n)}if($("#luckysheet-search-formula-parm").is(":visible")||$("#luckysheet-search-formula-parm-select").is(":visible"))$("#luckysheet-cell-selected").hide();else{if($("#luckysheet-conditionformat-dialog").is(":visible")||$("#luckysheet-administerRule-dialog").is(":visible")||$("#luckysheet-newConditionRule-dialog").is(":visible")||$("#luckysheet-editorConditionRule-dialog").is(":visible")||$("#luckysheet-singleRange-dialog").is(":visible")||$("#luckysheet-multiRange-dialog").is(":visible"))return;if($("#luckysheet-modal-dialog-slider-alternateformat").is(":visible")||$("#luckysheet-alternateformat-rangeDialog").is(":visible"))return;{i.luckysheetPaintModelOn&&i.cancelPaintModel();let e=q.luckysheet_select_save[0].column_focus,t=q.luckysheet_select_save[0].row_focus;e===n&&t===a||(a=t,n=e),U(a,n,q.flowdata),G()}}}),document.getElementById("luckysheet-cell-main").addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation();let l=e.dataTransfer.files;if(1==l.length&&l[0].type.indexOf("image")>-1){if(!ae(q.currentSheetIndex,"editObjects"))return;let e=new FileReader;e.readAsDataURL(l[0]),e.onload=function(e){let t=e.target.result;r.inserImg(t)}}!function(e){if(t&&t.hook&&t.hook.cellDragStop){let l=ve(e.pageX,e.pageY),c=l[0]+$("#luckysheet-cell-main").scrollLeft(),o=l[1]+$("#luckysheet-cell-main").scrollTop(),s=pe(o),r=s[1],a=s[0],n=s[2],i=we(c),u=i[1],h=i[0],d=i[2],y=X.mergeborer(q.flowdata,n,d);y&&(r=y.row[1],a=y.row[0],n=y.row[2],u=y.column[1],h=y.column[0],d=y.column[2]);let f=m.getSheetByIndex(),g=$("#luckysheetTableContent").get(0).getContext("2d");t.createHookFunction("cellDragStop",q.flowdata[n][d],{r:n,c:d,start_r:a,start_c:h,end_r:r,end_c:u},f,g,e)}}(e)},!1),document.getElementById("luckysheet-cell-main").addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation()},!1),$(document).on("mousemove.luckysheetEvent",function(e){if(s.overshow(e),a.overshow(e),window.cancelAnimationFrame(q.jfautoscrollTimeout),t&&t.hook&&t.hook.sheetMousemove){let o=ve(e.pageX,e.pageY),s=o[0]+$("#luckysheet-cell-main").scrollLeft(),r=o[1]+$("#luckysheet-cell-main").scrollTop(),a=pe(r),n=a[1],i=a[0],u=a[2],h=we(s),d=h[1],y=h[0],f=h[2],g=X.mergeborer(q.flowdata,u,f);g&&(n=g.row[1],i=g.row[0],u=g.row[2],d=g.column[1],y=g.column[0],f=g.column[2]);let k=m.getSheetByIndex(),_={functionResizeStatus:L.functionResizeStatus,horizontalmoveState:!!l.horizontalmovestate,verticalmoveState:!!l.verticalmovestate,pivotTableMoveState:!!c&&c.movestate,sheetMoveStatus:q.luckysheet_sheet_move_status,scrollStatus:!!q.luckysheet_scroll_status,selectStatus:!!q.luckysheet_select_status,rowsSelectedStatus:!!q.luckysheet_rows_selected_status,colsSelectedStatus:!!q.luckysheet_cols_selected_status,cellSelectedMove:!!q.luckysheet_cell_selected_move,cellSelectedExtend:!!q.luckysheet_cell_selected_extend,colsChangeSize:!!q.luckysheet_cols_change_size,rowsChangeSize:!!q.luckysheet_rows_change_size,chartMove:!!q.chartparam.luckysheetCurrentChartMove,chartResize:!!q.chartparam.luckysheetCurrentChartResize,rangeResize:!!L.rangeResize,rangeMove:!!L.rangeMove},p=$("#luckysheetTableContent").get(0).getContext("2d");q.flowdata&&q.flowdata[u]&&t.createHookFunction("sheetMousemove",q.flowdata[u][f],{r:u,c:f,start_r:i,start_c:y,end_r:n,end_c:d},k,_,p)}if(L.functionResizeStatus){let t=e.pageY-L.functionResizeData.y,l=L.functionResizeData.calculatebarHeight+t,c=Math.round($(window).height()/2);if(l<=28){if(l<=20)return;l=28}else if(l>=c){if(l>=c+8)return;l=c}q.calculatebarHeight=l,$("#luckysheet-wa-calculate").css("height",q.calculatebarHeight-2),$("#luckysheet-wa-calculate-size").css({background:"#5e5e5e",cursor:"ns-resize"}),clearTimeout(L.functionResizeTimeout),L.functionResizeTimeout=setTimeout(function(){g()},15)}else if(l.horizontalmovestate){let t=ve(e.pageX,e.pageY),c=$("#luckysheet-cell-main").scrollLeft(),o=$("#luckysheet-cell-main").scrollTop(),s=(t[0],t[1]+o),r=pe(s),a=r[1],n=r[0],i=r[2],u=t[1]+q.columnHeaderHeight;u<q.columnHeaderHeight&&(u=q.columnHeaderHeight),u>l.windowHeight-4&&(u=l.windowHeight-4),$("#luckysheet-freezebar-horizontal").find(".luckysheet-freezebar-horizontal-handle").css({top:u}),u+o-q.columnHeaderHeight>=n+(a-n)/2?(u=a-2-o+q.columnHeaderHeight,q.freezenhorizontaldata=[a,i+1,o,l.cutVolumn(q.visibledatarow,i+1),u]):(u=n-2-o+q.columnHeaderHeight,q.freezenhorizontaldata=[n,i,o,l.cutVolumn(q.visibledatarow,i),u]),$("#luckysheet-freezebar-horizontal").find(".luckysheet-freezebar-horizontal-drop").css({top:u}),l.saveFreezen(q.freezenhorizontaldata,u,null,null)}else if(l.verticalmovestate){let t=ve(e.pageX,e.pageY),c=$("#luckysheet-cell-main").scrollLeft(),o=$("#luckysheet-cell-main").scrollTop(),s=t[0]+c,r=(t[1],we(s)),a=r[1],n=r[0],i=r[2],u=t[0]+q.rowHeaderWidth;u<q.rowHeaderWidth&&(u=q.rowHeaderWidth),u>l.windowWidth-4&&(u=l.windowWidth-4),$("#luckysheet-freezebar-vertical").find(".luckysheet-freezebar-vertical-handle").css({left:u}),u+c-q.rowHeaderWidth>=n+(a-n)/2?(u=a-2-c+q.rowHeaderWidth,q.freezenverticaldata=[a,i+1,c,l.cutVolumn(q.visibledatacolumn,i+1),u]):(u=n-2-c+q.rowHeaderWidth,q.freezenverticaldata=[n,i,c,l.cutVolumn(q.visibledatacolumn,i),u]),$("#luckysheet-freezebar-vertical").find(".luckysheet-freezebar-vertical-drop").css({left:u}),l.saveFreezen(null,null,q.freezenverticaldata,u),g()}else if(c&&c.movestate){let t=e.pageX,l=e.pageY;$("#luckysheet-modal-dialog-slider-pivot-move").css({left:t-c.movesave.width/2,top:l-c.movesave.height})}else if(q.luckysheet_sheet_move_status){let t=$("#luckysheet-sheet-container-c").scrollLeft(),l=e.pageX+t;if(Math.abs(e.pageX-q.luckysheet_sheet_move_data.pageX)<3)return;let c=$("#luckysheet-sheet-container").width(),o=l-q.luckysheet_sheet_move_data.curleft-$("#luckysheet-sheet-container").offset().left;q.luckysheet_sheet_move_data.activeobject.css({left:o});let s=V(q.luckysheet_sheet_move_data.widthlist,o+q.luckysheet_sheet_move_data.curleft);q.luckysheet_sheet_move_data.cursorobject.css({cursor:"move"}),o-t<=6&&$("#luckysheet-sheets-leftscroll").click(),o-t>=c-40&&$("#luckysheet-sheets-rightscroll").click(),s!=q.luckysheet_sheet_move_data.curindex&&(-1==s&&o>0?(s=q.luckysheet_sheet_move_data.widthlist.length-1,$("#luckysheet-sheets-item-clone").insertAfter($("#luckysheet-sheet-area div.luckysheet-sheets-item:visible").eq(s))):-1==s&&o<=0?$("#luckysheet-sheets-item-clone").insertBefore($("#luckysheet-sheet-area div.luckysheet-sheets-item:visible").eq(0)):$("#luckysheet-sheets-item-clone").insertAfter($("#luckysheet-sheet-area div.luckysheet-sheets-item:visible").eq(s)),q.luckysheet_sheet_move_data.widthlist=[],$("#luckysheet-sheet-area div.luckysheet-sheets-item:visible").each(function(e){0==e?q.luckysheet_sheet_move_data.widthlist.push(parseInt($(this).outerWidth())):q.luckysheet_sheet_move_data.widthlist.push(parseInt($(this).outerWidth())+q.luckysheet_sheet_move_data.widthlist[e-1])}),q.luckysheet_sheet_move_data.curindex=$("#luckysheet-sheet-area div.luckysheet-sheets-item:visible").index($("#luckysheet-sheets-item-clone")))}else if(q.luckysheet_model_move_state){let t=$(document).scrollTop(),l=$(document).scrollLeft(),c=e.pageY+t,o=e.pageX+l,s=$(window).height(),r=$(window).width(),a=q.luckysheet_model_move_obj.height(),n=q.luckysheet_model_move_obj.width(),i=c-q.luckysheet_model_xy[1],u=o-q.luckysheet_model_xy[0];i<0&&(i=0),i+a+62>s&&(i=s-a-62),u<0&&(u=0),u+n+86>r&&(u=r-n-86),q.luckysheet_model_move_obj.css({top:i,left:u}),e.preventDefault()}else if(q.luckysheet_scroll_status||q.luckysheet_select_status||q.luckysheet_rows_selected_status||q.luckysheet_cols_selected_status||q.luckysheet_cell_selected_move||q.luckysheet_cell_selected_extend||q.luckysheet_cols_change_size||q.luckysheet_rows_change_size||q.chartparam.luckysheetCurrentChartMove||q.chartparam.luckysheetCurrentChartResize||L.rangeResize||L.rangeMove){q.luckysheet_select_status&&(clearTimeout(q.countfuncTimeout),q.countfuncTimeout=setTimeout(function(){Re()},500)),q.jfautoscrollTimeout=window.requestAnimationFrame(function t(){if(q.luckysheet_scroll_status&&!q.luckysheet_cols_change_size&&!q.luckysheet_rows_change_size){let t=ve(e.pageX,e.pageY),l=$("#luckysheet-scrollbar-x").scrollLeft(),c=$("#luckysheet-scrollbar-y").scrollTop(),o=t[0],s=t[1],r=$("#luckysheet-cell-main").height()-20*q.zoomRatio,a=$("#luckysheet-cell-main").width()-60*q.zoomRatio;if(s<0||s>r){let e;e=s<0?c+s/2:c+(s-r)/2,$("#luckysheet-scrollbar-y").scrollTop(e)}if(o<0||o>a){let e;e=o<0?l+o/2:l+(o-a)/2,$("#luckysheet-scrollbar-x").scrollLeft(e)}}if(q.luckysheet_select_status){let t=ve(e.pageX,e.pageY),o=t[0]+$("#luckysheet-cell-main").scrollLeft(),s=t[1]+$("#luckysheet-cell-main").scrollTop(),r=pe(s),a=r[1],n=r[0],i=r[2],u=we(o),h=u[1],d=u[0],m=u[2];if(!se(i,m,q.currentSheetIndex))return;let y=$.extend(!0,{},q.luckysheet_select_save[q.luckysheet_select_save.length-1]),f=0,g=0,k=[];y.top>n?(f=n,g=y.top+y.height-n,y.row[1]>y.row_focus&&(y.row[1]=y.row_focus),k=[i,y.row[1]]):y.top==n?(f=n,g=y.top+y.height-n,k=[i,y.row[0]]):(f=y.top,g=a-y.top-1,y.row[0]<y.row_focus&&(y.row[0]=y.row_focus),k=[y.row[0],i]);let _=0,p=0,w=[];y.left>d?(_=d,p=y.left+y.width-d,y.column[1]>y.column_focus&&(y.column[1]=y.column_focus),w=[m,y.column[1]]):y.left==d?(_=d,p=y.left+y.width-d,w=[m,y.column[0]]):(_=y.left,p=h-y.left-1,y.column[0]<y.column_focus&&(y.column[0]=y.column_focus),w=[y.column[0],m]);let v=X.mergeMoveMain(w,k,y,f,g,_,p);null!=v&&(w=v[0],k=v[1],f=v[2],g=v[3],_=v[4],p=v[5]),y.row=k,y.column=w,y.left_move=_,y.width_move=p,y.top_move=f,y.height_move=g,q.luckysheet_select_save[q.luckysheet_select_save.length-1]=y,G(),l.scrollFreezen(),$("#luckysheet-alternateformat-rangeDialog").is(":visible")&&$("#luckysheet-alternateformat-rangeDialog input").val(_e(q.currentSheetIndex,q.luckysheet_select_save[q.luckysheet_select_save.length-1])),c.luckysheet_pivotTable_select_state&&$("#luckysheet-pivotTable-range-selection-input").val(q.luckysheetfile[ke(q.currentSheetIndex)].name+"!"+he(q.luckysheet_select_save[0].column[0])+(q.luckysheet_select_save[0].row[0]+1)+":"+he(q.luckysheet_select_save[0].column[1])+(q.luckysheet_select_save[0].row[1]+1))}else if(u.selectStatus){let t=ve(e.pageX,e.pageY),l=t[0]+$("#luckysheet-cell-main").scrollLeft(),c=t[1]+$("#luckysheet-cell-main").scrollTop(),o=pe(c),s=o[1],r=o[0],a=o[2],n=we(l),i=n[1],h=n[0],d=n[2],m=u.selectRange[u.selectRange.length-1],y=0,f=0,g=[];m.top>r?(y=r,f=m.top+m.height-r,m.row[1]>m.row_focus&&(m.row[1]=m.row_focus),g=[a,m.row[1]]):m.top==r?(y=r,f=m.top+m.height-r,g=[a,m.row[0]]):(y=m.top,f=s-m.top-1,m.row[0]<m.row_focus&&(m.row[0]=m.row_focus),g=[m.row[0],a]);let k=0,_=0,p=[];m.left>h?(k=h,_=m.left+m.width-h,m.column[1]>m.column_focus&&(m.column[1]=m.column_focus),p=[d,m.column[1]]):m.left==h?(k=h,_=m.left+m.width-h,p=[d,m.column[0]]):(k=m.left,_=i-m.left-1,m.column[0]<m.column_focus&&(m.column[0]=m.column_focus),p=[m.column[0],d]);let w=X.mergeMoveMain(p,g,m,y,f,k,_);null!=w&&(p=w[0],g=w[1],y=w[2],f=w[3],k=w[4],_=w[5]),m.row=g,m.column=p,m.left_move=k,m.width_move=_,m.top_move=y,m.height_move=f,u.selectRange[u.selectRange.length-1]=m,J(u.selectRange);let v=u.getTxtByRange(u.selectRange);$("#luckysheet-multiRange-dialog input").val(v)}else if(n.selectStatus){let t=ve(e.pageX,e.pageY),l=t[0]+$("#luckysheet-cell-main").scrollLeft(),c=t[1]+$("#luckysheet-cell-main").scrollTop(),o=pe(c),s=o[1],r=o[0],a=o[2],i=we(l),u=i[1],h=i[0],d=i[2],m=n.selectRange[n.selectRange.length-1],y=0,f=0,g=[];m.top>r?(y=r,f=m.top+m.height-r,m.row[1]>m.row_focus&&(m.row[1]=m.row_focus),g=[a,m.row[1]]):m.top==r?(y=r,f=m.top+m.height-r,g=[a,m.row[0]]):(y=m.top,f=s-m.top-1,m.row[0]<m.row_focus&&(m.row[0]=m.row_focus),g=[m.row[0],a]);let k=0,_=0,p=[];m.left>h?(k=h,_=m.left+m.width-h,m.column[1]>m.column_focus&&(m.column[1]=m.column_focus),p=[d,m.column[1]]):m.left==h?(k=h,_=m.left+m.width-h,p=[d,m.column[0]]):(k=m.left,_=u-m.left-1,m.column[0]<m.column_focus&&(m.column[0]=m.column_focus),p=[m.column[0],d]);let w=X.mergeMoveMain(p,g,m,y,f,k,_);null!=w&&(p=w[0],g=w[1],y=w[2],f=w[3],k=w[4],_=w[5]),m.row=g,m.column=p,m.left_move=k,m.width_move=_,m.top_move=y,m.height_move=f,n.selectRange[n.selectRange.length-1]=m,J(n.selectRange);let v=n.getTxtByRange(n.selectRange);L.rangetosheet!=q.currentSheetIndex&&(v=q.luckysheetfile[ke(q.currentSheetIndex)].name+"!"+v),$("#luckysheet-dataVerificationRange-dialog input").val(v)}else if(L.rangestart)L.rangedrag(e);else if(L.rangedrag_row_start)L.rangedrag_row(e);else if(L.rangedrag_column_start)L.rangedrag_column(e);else if(q.luckysheet_rows_selected_status){let t=ve(e.pageX,e.pageY)[1]+$("#luckysheet-rows-h").scrollTop();if(t<0)return!1;let l=pe(t),c=l[1],o=l[0],s=l[2],r=q.visibledatacolumn.length-1,a=(q.visibledatacolumn[r],$.extend(!0,{},q.luckysheet_select_save[q.luckysheet_select_save.length-1])),n=0,i=0,u=[];a.top>o?(n=o,i=a.top+a.height-o,a.row[1]>a.row_focus&&(a.row[1]=a.row_focus),u=[s,a.row[1]]):a.top==o?(n=o,i=a.top+a.height-o,u=[s,a.row[0]]):(n=a.top,i=c-a.top-1,a.row[0]<a.row_focus&&(a.row[0]=a.row_focus),u=[a.row[0],s]),a.row=u,a.top_move=n,a.height_move=i,q.luckysheet_select_save[q.luckysheet_select_save.length-1]=a,G(),clearTimeout(q.countfuncTimeout),q.countfuncTimeout=setTimeout(function(){Re()},500)}else if(q.luckysheet_cols_selected_status){let t=ve(e.pageX,e.pageY)[0]+$("#luckysheet-cols-h-c").scrollLeft();if(t<0)return!1;let l=q.visibledatarow.length-1,c=(q.visibledatarow[l],we(t)),o=c[1],s=c[0],r=c[2],a=$.extend(!0,{},q.luckysheet_select_save[q.luckysheet_select_save.length-1]),n=0,i=0,u=[];a.left>s?(n=s,i=a.left+a.width-s,a.column[1]>a.column_focus&&(a.column[1]=a.column_focus),u=[r,a.column[1]]):a.left==s?(n=s,i=a.left+a.width-s,u=[r,a.column[0]]):(n=a.left,i=o-a.left-1,a.column[0]<a.column_focus&&(a.column[0]=a.column_focus),u=[a.column[0],r]),a.column=u,a.left_move=n,a.width_move=i,q.luckysheet_select_save[q.luckysheet_select_save.length-1]=a,G(),clearTimeout(q.countfuncTimeout),q.countfuncTimeout=setTimeout(function(){Re()},500)}else if(q.luckysheet_cell_selected_move){let t=ve(e.pageX,e.pageY),l=$("#luckysheet-cell-main").scrollLeft(),c=$("#luckysheet-cell-main").scrollTop(),o=t[0]+l,s=t[1]+c,r=$(window).height()+c-q.sheetBarHeight-q.statisticBarHeight,a=$(window).width()+l,n=pe(s),i=n[1],u=n[0],h=n[2],d=we(o),m=d[1],y=d[0],f=d[2],g=q.luckysheet_cell_selected_move_index[0],k=q.luckysheet_cell_selected_move_index[1],_=q.luckysheet_select_save[0].row[0]-g+h,p=q.luckysheet_select_save[0].row[1]-g+h,w=q.luckysheet_select_save[0].column[0]-k+f,v=q.luckysheet_select_save[0].column[1]-k+f;(_<0||s<0)&&(_=0,p=q.luckysheet_select_save[0].row[1]-q.luckysheet_select_save[0].row[0]),(w<0||o<0)&&(w=0,v=q.luckysheet_select_save[0].column[1]-q.luckysheet_select_save[0].column[0]),(p>=q.visibledatarow[q.visibledatarow.length-1]||s>r)&&(_=q.visibledatarow.length-1-q.luckysheet_select_save[0].row[1]+q.luckysheet_select_save[0].row[0],p=q.visibledatarow.length-1),(v>=q.visibledatacolumn[q.visibledatacolumn.length-1]||o>a)&&(w=q.visibledatacolumn.length-1-q.luckysheet_select_save[0].column[1]+q.luckysheet_select_save[0].column[0],v=q.visibledatacolumn.length-1),y=w-1==-1?0:q.visibledatacolumn[w-1],m=q.visibledatacolumn[v],u=_-1==-1?0:q.visibledatarow[_-1],i=q.visibledatarow[p],$("#luckysheet-cell-selected-move").css({left:y,width:m-y-2,top:u,height:i-u-2,display:"block"})}else if(q.luckysheet_cell_selected_extend){let t=ve(e.pageX,e.pageY),l=$("#luckysheet-cell-main").scrollLeft()-5,c=$("#luckysheet-cell-main").scrollTop()-5,o=t[0]+l,s=t[1]+c,r=$(window).height()+c-q.sheetBarHeight-q.statisticBarHeight,a=$(window).width()+l,n=pe(s),i=n[1],u=n[0],h=n[2],d=we(o),m=d[1],y=d[0],f=d[2],g=q.luckysheet_cell_selected_extend_index[0],k=q.luckysheet_cell_selected_extend_index[1],_=q.luckysheet_select_save[0].row[0],p=q.luckysheet_select_save[0].row[1],w=q.luckysheet_select_save[0].column[0],v=q.luckysheet_select_save[0].column[1];(_<0||s<0)&&(_=0,p=q.luckysheet_select_save[0].row[1]-q.luckysheet_select_save[0].row[0]),(w<0||o<0)&&(w=0,v=q.luckysheet_select_save[0].column[1]-q.luckysheet_select_save[0].column[0]),(p>=q.visibledatarow[q.visibledatarow.length-1]||s>r)&&(_=q.visibledatarow.length-1-q.luckysheet_select_save[0].row[1]+q.luckysheet_select_save[0].row[0],p=q.visibledatarow.length-1),(v>=q.visibledatacolumn[q.visibledatacolumn.length-1]||o>a)&&(w=q.visibledatacolumn.length-1-q.luckysheet_select_save[0].column[1]+q.luckysheet_select_save[0].column[0],v=q.visibledatacolumn.length-1);let b=q.luckysheet_select_save[0].top_move,z=q.luckysheet_select_save[0].height_move,C=q.luckysheet_select_save[0].left_move,R=q.luckysheet_select_save[0].width_move;Math.abs(g-h)>Math.abs(k-f)?h>=_&&h<=p||(q.luckysheet_select_save[0].top_move>=u?(b=u,z=q.luckysheet_select_save[0].top_move+q.luckysheet_select_save[0].height_move-u):(b=q.luckysheet_select_save[0].top_move,z=i-q.luckysheet_select_save[0].top_move-1)):f>=w&&f<=v||(q.luckysheet_select_save[0].left_move>=y?(C=y,R=q.luckysheet_select_save[0].left_move+q.luckysheet_select_save[0].width_move-y):(C=q.luckysheet_select_save[0].left_move,R=m-q.luckysheet_select_save[0].left_move-1)),$("#luckysheet-cell-selected-extend").css({left:C,width:R,top:b,height:z,display:"block"})}else if(q.luckysheet_cols_change_size){let t=ve(e.pageX,e.pageY),l=$("#luckysheet-cols-h-c").scrollLeft(),c=t[0]+l,o=$(window).width(),s=q.visibledatarow.length-1,r=(q.visibledatarow[s],we(c));r[1],r[0],r[2],c+3-q.luckysheet_cols_change_size_start[0]>30&&c<o+l-100&&($("#luckysheet-change-size-line").css({left:c}),$("#luckysheet-cols-change-size").css({left:c-2}))}else if(q.luckysheet_rows_change_size){let t=ve(e.pageX,e.pageY),l=$("#luckysheet-rows-h").scrollTop(),c=t[1]+l,o=$(window).height(),s=pe(c);s[1],s[0],s[2],c+3-q.luckysheet_rows_change_size_start[0]>19&&c<o+l-200&&($("#luckysheet-change-size-line").css({top:c}),$("#luckysheet-rows-change-size").css({top:c}))}else if(q.chartparam.luckysheetCurrentChartMove){const t=ve(e.pageX,e.pageY),c=t[0]+$("#luckysheet-cell-main").scrollLeft(),o=t[1]+$("#luckysheet-cell-main").scrollTop(),s=q.chartparam.luckysheetCurrentChartMoveObj.height(),r=q.chartparam.luckysheetCurrentChartMoveObj.width();let a=o-q.chartparam.luckysheetCurrentChartMoveXy[1],n=c-q.chartparam.luckysheetCurrentChartMoveXy[0];if(a<0&&(a=0),a+s+42+6>q.chartparam.luckysheetCurrentChartMoveWinH&&(a=q.chartparam.luckysheetCurrentChartMoveWinH-s-42-6),n<0&&(n=0),n+r+22+36>q.chartparam.luckysheetCurrentChartMoveWinW&&(n=q.chartparam.luckysheetCurrentChartMoveWinW-r-22-36),q.chartparam.luckysheetCurrentChartMoveObj.css({top:a,left:n}),null!=q.freezenhorizontaldata||null!=q.freezenverticaldata){l.scrollAdapt();const t=q.chartparam.luckysheetCurrentChartMoveObj.offset(),c=q.chartparam.luckysheetCurrentChartMoveObj.position();q.chartparam.luckysheetCurrentChartMoveXy=[e.pageX-t.left,e.pageY-t.top,c.left,c.top,$("#luckysheet-scrollbar-x").scrollLeft(),$("#luckysheet-scrollbar-y").scrollTop()]}}else if(q.chartparam.luckysheetCurrentChartResize){const t=$("#luckysheet-cell-main").scrollTop(),l=$("#luckysheet-cell-main").scrollLeft(),c=ve(e.pageX,e.pageY),o=c[0]+l,s=c[1]+t;if(o<0||s<0)return!1;q.chartparam.luckysheetCurrentChartResizeObj.height(),q.chartparam.luckysheetCurrentChartResizeObj.width();const r=s-q.chartparam.luckysheetCurrentChartResizeXy[1],a=o-q.chartparam.luckysheetCurrentChartResizeXy[0];let n=q.chartparam.luckysheetCurrentChartResizeXy[5],i=q.chartparam.luckysheetCurrentChartResizeXy[3],u=q.chartparam.luckysheetCurrentChartResizeXy[4],h=q.chartparam.luckysheetCurrentChartResizeXy[2];"lm"!=q.chartparam.luckysheetCurrentChartResize&&"lt"!=q.chartparam.luckysheetCurrentChartResize&&"lb"!=q.chartparam.luckysheetCurrentChartResize||(u=o,h=q.chartparam.luckysheetCurrentChartResizeXy[2]-a,u>q.chartparam.luckysheetCurrentChartResizeXy[2]+q.chartparam.luckysheetCurrentChartResizeXy[4]-60?(u=q.chartparam.luckysheetCurrentChartResizeXy[2]+q.chartparam.luckysheetCurrentChartResizeXy[4]-60,h=q.chartparam.luckysheetCurrentChartResizeXy[2]-(q.chartparam.luckysheetCurrentChartResizeXy[2]+q.chartparam.luckysheetCurrentChartResizeXy[4]-60-q.chartparam.luckysheetCurrentChartResizeXy[0])):u<=0&&(u=0,h=q.chartparam.luckysheetCurrentChartResizeXy[2]+q.chartparam.luckysheetCurrentChartResizeXy[0])),"rm"!=q.chartparam.luckysheetCurrentChartResize&&"rt"!=q.chartparam.luckysheetCurrentChartResize&&"rb"!=q.chartparam.luckysheetCurrentChartResize||((h=q.chartparam.luckysheetCurrentChartResizeXy[2]+a)<60?h=60:h>=q.chartparam.luckysheetCurrentChartResizeWinW-q.chartparam.luckysheetCurrentChartResizeXy[4]-22-36&&(h=q.chartparam.luckysheetCurrentChartResizeWinW-q.chartparam.luckysheetCurrentChartResizeXy[4]-22-36)),"mt"!=q.chartparam.luckysheetCurrentChartResize&&"lt"!=q.chartparam.luckysheetCurrentChartResize&&"rt"!=q.chartparam.luckysheetCurrentChartResize||(n=s,i=q.chartparam.luckysheetCurrentChartResizeXy[3]-r,n>q.chartparam.luckysheetCurrentChartResizeXy[3]+q.chartparam.luckysheetCurrentChartResizeXy[5]-60?(n=q.chartparam.luckysheetCurrentChartResizeXy[3]+q.chartparam.luckysheetCurrentChartResizeXy[5]-60,i=q.chartparam.luckysheetCurrentChartResizeXy[3]-(q.chartparam.luckysheetCurrentChartResizeXy[3]+q.chartparam.luckysheetCurrentChartResizeXy[5]-60-q.chartparam.luckysheetCurrentChartResizeXy[1])):n<=0&&(n=0,i=q.chartparam.luckysheetCurrentChartResizeXy[3]+q.chartparam.luckysheetCurrentChartResizeXy[1])),"mb"!=q.chartparam.luckysheetCurrentChartResize&&"lb"!=q.chartparam.luckysheetCurrentChartResize&&"rb"!=q.chartparam.luckysheetCurrentChartResize||((i=q.chartparam.luckysheetCurrentChartResizeXy[3]+r)<60?i=60:i>=q.chartparam.luckysheetCurrentChartResizeWinH-q.chartparam.luckysheetCurrentChartResizeXy[5]-42-6&&(i=q.chartparam.luckysheetCurrentChartResizeWinH-q.chartparam.luckysheetCurrentChartResizeXy[5]-42-6));const d={top:n,left:u,height:i,width:h};q.chartparam.luckysheetCurrentChartResizeObj.css(d),q.resizeChart(q.chartparam.luckysheetCurrentChart)}else if(r.move){let t=ve(e.pageX,e.pageY),l=t[0]+$("#luckysheet-cell-main").scrollLeft(),c=t[1]+$("#luckysheet-cell-main").scrollTop(),o=r.images[r.currentImgId];o.isFixedPos&&(l=e.pageX,c=e.pageY);let s=$("#luckysheet-modal-dialog-activeImage").height(),a=$("#luckysheet-modal-dialog-activeImage").width(),n=c-r.moveXY[1],i=l-r.moveXY[0],u=0,h=r.currentWinH-s-42-6,d=0,m=r.currentWinW-a-22-36;o.isFixedPos&&(h=(u=q.infobarHeight+q.toolbarHeight+q.calculatebarHeight+q.columnHeaderHeight)+q.cellmainHeight-q.cellMainSrollBarSize-s,m=(d=q.rowHeaderWidth)+q.cellmainWidth-q.cellMainSrollBarSize-a),n<u&&(n=u),n>h&&(n=h),i<d&&(i=d),i>m&&(i=m),$("#luckysheet-modal-dialog-activeImage").css({left:i,top:n})}else if(r.resize){let t=ve(e.pageX,e.pageY),l=$("#luckysheet-cell-main").scrollLeft(),c=$("#luckysheet-cell-main").scrollTop(),o=t[0]+l,s=t[1]+c;if(o<0||s<0)return!1;let a=r.resizeXY,n=s-a[1],i=o-a[0],u=a[5],h=a[3],d=a[4],m=a[2],y=r.resize,f=r.images[r.currentImgId];if(f.isFixedPos){let e=q.infobarHeight+q.toolbarHeight+q.calculatebarHeight+q.columnHeaderHeight,t=q.rowHeaderWidth;"lt"==y?((d=a[4]-a[6]+i)<t&&(d=t),d>a[4]-a[6]+a[2]-1&&(d=a[4]-a[6]+a[2]-1),m=a[4]-a[6]+a[2]-d,h=Math.round(m*(a[3]/a[2])),(u=a[5]-a[7]+a[3]-h)<e&&(u=e,h=a[5]-a[7]+a[3]-u,m=Math.round(h*(a[2]/a[3])),d=a[4]-a[6]+a[2]-m),u>a[5]-a[7]+a[3]-1&&(u=a[5]-a[7]+a[3]-1,h=a[5]-a[7]+a[3]-u,m=Math.round(h*(a[2]/a[3])),d=a[4]-a[6]+a[2]-m)):"lm"==y?((d=a[4]-a[6]+i)<t&&(d=t),d>a[4]-a[6]+a[2]-1&&(d=a[4]-a[6]+a[2]-1),m=a[4]-a[6]+a[2]-d,u=a[5]-a[7],h=a[3]):"lb"==y?((d=a[4]-a[6]+i)<t&&(d=t),d>a[4]-a[6]+a[2]-1&&(d=a[4]-a[6]+a[2]-1),m=a[4]-a[6]+a[2]-d,h=Math.round(m*(a[3]/a[2])),u=a[5]-a[7],h<1&&(h=1,m=Math.round(h*(a[2]/a[3])),d=a[4]-a[6]+a[2]-m),h>e+q.cellmainHeight-q.cellMainSrollBarSize-u&&(h=e+q.cellmainHeight-q.cellMainSrollBarSize-u,m=Math.round(h*(a[2]/a[3])),d=a[4]-a[6]+a[2]-m)):"rt"==y?(d=a[4]-a[6],(m=a[2]+i)<1&&(m=1),m>t+q.cellmainWidth-q.cellMainSrollBarSize-d&&(m=t+q.cellmainWidth-q.cellMainSrollBarSize-d),h=Math.round(m*(a[3]/a[2])),(u=a[5]-a[7]+a[3]-h)<e&&(u=e,h=a[5]-a[7]+a[3]-u,m=Math.round(h*(a[2]/a[3]))),u>a[5]-a[7]+a[3]-1&&(u=a[5]-a[7]+a[3]-1,h=a[5]-a[7]+a[3]-u,m=Math.round(h*(a[2]/a[3])))):"rm"==y?(d=a[4]-a[6],(m=a[2]+i)<1&&(m=1),m>t+q.cellmainWidth-q.cellMainSrollBarSize-d&&(m=t+q.cellmainWidth-q.cellMainSrollBarSize-d),u=a[5]-a[7],h=a[3]):"rb"==y?(d=a[4]-a[6],(m=a[2]+i)<1&&(m=1),m>t+q.cellmainWidth-q.cellMainSrollBarSize-d&&(m=t+q.cellmainWidth-q.cellMainSrollBarSize-d),h=Math.round(m*(a[3]/a[2])),u=a[5]-a[7],h<1&&(h=1,m=Math.round(h*(a[2]/a[3]))),h>e+q.cellmainHeight-q.cellMainSrollBarSize-u&&(h=e+q.cellmainHeight-q.cellMainSrollBarSize-u,m=Math.round(h*(a[2]/a[3])))):"mt"==y?(d=a[4]-a[6],m=a[2],(u=a[5]-a[7]+n)<e&&(u=e),u>a[5]-a[7]+a[3]-1&&(u=a[5]-a[7]+a[3]-1),h=a[5]-a[7]+a[3]-u):"mb"==y&&(d=a[4]-a[6],m=a[2],u=a[5]-a[7],(h=a[3]+n)<1&&(h=1),h>e+q.cellmainHeight-q.cellMainSrollBarSize-u&&(h=e+q.cellmainHeight-q.cellMainSrollBarSize-u))}else"lt"==y?(d=o,m=a[2]-i,d>a[2]+a[4]-1?(d=a[2]+a[4]-1,m=a[2]+a[0]-(a[2]+a[4]-1)):d<=0&&(d=0,m=a[2]+a[0]),h=Math.round(m*(a[3]/a[2])),(u=a[3]+a[1]-h)>a[3]+a[5]-1?(u=a[3]+a[5]-1,h=a[3]+a[1]-(a[3]+a[5]-1),m=Math.round(h*(a[2]/a[3])),d=a[2]+a[0]-m):u<=0&&(u=0,h=a[3]+a[1],m=Math.round(h*(a[2]/a[3])),d=a[2]+a[0]-m)):"lm"==y?(d=o,m=a[2]-i,d>a[2]+a[4]-1?(d=a[2]+a[4]-1,m=a[2]+a[0]-(a[2]+a[4]-1)):d<=0&&(d=0,m=a[2]+a[0])):"lb"==y?(d=o,m=a[2]-i,d>a[2]+a[4]-1?(d=a[2]+a[4]-1,m=a[2]+a[0]-(a[2]+a[4]-1)):d<=0&&(d=0,m=a[2]+a[0]),(h=Math.round(m*(a[3]/a[2])))<1?(h=1,m=Math.round(h*(a[2]/a[3])),d=a[2]+a[0]-m):h>=r.currentWinH-a[5]-42-6&&(h=r.currentWinH-a[5]-42-6,m=Math.round(h*(a[2]/a[3])),d=a[2]+a[0]-m)):"rt"==y?((m=a[2]+i)<1?m=1:m>=r.currentWinW-a[4]-22-36&&(m=r.currentWinW-a[4]-22-36),h=Math.round(m*(a[3]/a[2])),(u=a[3]+a[1]-h)>a[3]+a[5]-1?(u=a[3]+a[5]-1,h=a[3]+a[1]-(a[3]+a[5]-1),m=Math.round(h*(a[2]/a[3]))):u<=0&&(u=0,h=a[3]+a[1],m=Math.round(h*(a[2]/a[3])))):"rm"==y?(m=a[2]+i)<1?m=1:m>=r.currentWinW-a[4]-22-36&&(m=r.currentWinW-a[4]-22-36):"rb"==y?((m=a[2]+i)<1?m=1:m>=r.currentWinW-a[4]-22-36&&(m=r.currentWinW-a[4]-22-36),(h=Math.round(m*(a[3]/a[2])))<1?(h=1,m=Math.round(h*(a[2]/a[3]))):h>=r.currentWinH-a[5]-42-6&&(h=r.currentWinH-a[5]-42-6,m=Math.round(h*(a[2]/a[3])))):"mt"==y?(u=s,h=a[3]-n,u>a[3]+a[5]-1?(u=a[3]+a[5]-1,h=a[3]+a[1]-(a[3]+a[5]-1)):u<=0&&(u=0,h=a[3]+a[1])):"mb"==y&&((h=a[3]+n)<1?h=1:h>=r.currentWinH-a[5]-42-6&&(h=r.currentWinH-a[5]-42-6));$("#luckysheet-modal-dialog-activeImage").css({width:m,height:h,left:d,top:u});let g=m/f.crop.width,k=h/f.crop.height,_=Math.round(f.default.width*g),p=Math.round(f.default.height*k),w=Math.round(f.crop.offsetLeft*g),v=Math.round(f.crop.offsetTop*k);$("#luckysheet-modal-dialog-activeImage .luckysheet-modal-dialog-content").css({"background-size":_+"px "+p+"px","background-position":-w+"px "+-v+"px"})}else if(r.cropChange){let t=ve(e.pageX,e.pageY),l=t[0]+$("#luckysheet-cell-main").scrollLeft(),c=t[1]+$("#luckysheet-cell-main").scrollTop();if(l<0||c<0)return!1;let o,s,a,n,i=r.cropChangeXY,u=c-i[1],h=l-i[0],d=r.images[r.currentImgId],m=r.cropChange;"lt"==m?((a=d.crop.offsetLeft+h)<0&&(a=0),a>d.crop.width+d.crop.offsetLeft-1&&(a=d.crop.width+d.crop.offsetLeft-1),o=d.crop.width+d.crop.offsetLeft-a,(n=d.crop.offsetTop+u)<0&&(n=0),n>d.crop.height+d.crop.offsetTop-1&&(n=d.crop.height+d.crop.offsetTop-1),s=d.crop.height+d.crop.offsetTop-n):"lm"==m?((a=d.crop.offsetLeft+h)<0&&(a=0),a>d.crop.width+d.crop.offsetLeft-1&&(a=d.crop.width+d.crop.offsetLeft-1),o=d.crop.width+d.crop.offsetLeft-a,n=d.crop.offsetTop,s=d.crop.height):"lb"==m?((a=d.crop.offsetLeft+h)<0&&(a=0),a>d.crop.width+d.crop.offsetLeft-1&&(a=d.crop.width+d.crop.offsetLeft-1),o=d.crop.width+d.crop.offsetLeft-a,n=d.crop.offsetTop,(s=d.crop.height+u)<1&&(s=1),s>d.default.height-n&&(s=d.default.height-n)):"rt"==m?(a=d.crop.offsetLeft,(o=d.crop.width+h)<1&&(o=1),o>d.default.width-a&&(o=d.default.width-a),(n=d.crop.offsetTop+u)<0&&(n=0),n>d.crop.height+d.crop.offsetTop-1&&(n=d.crop.height+d.crop.offsetTop-1),s=d.crop.height+d.crop.offsetTop-n):"rm"==m?(a=d.crop.offsetLeft,(o=d.crop.width+h)<1&&(o=1),o>d.default.width-a&&(o=d.default.width-a),n=d.crop.offsetTop,s=d.crop.height):"rb"==m?(a=d.crop.offsetLeft,(o=d.crop.width+h)<1&&(o=1),o>d.default.width-a&&(o=d.default.width-a),n=d.crop.offsetTop,(s=d.crop.height+u)<1&&(s=1),s>d.default.height-n&&(s=d.default.height-n)):"mt"==m?(a=d.crop.offsetLeft,o=d.crop.width,(n=d.crop.offsetTop+u)<0&&(n=0),n>d.crop.height+d.crop.offsetTop-1&&(n=d.crop.height+d.crop.offsetTop-1),s=d.crop.height+d.crop.offsetTop-n):"mb"==m&&(a=d.crop.offsetLeft,o=d.crop.width,n=d.crop.offsetTop,(s=d.crop.height+u)<1&&(s=1),s>d.default.height-n&&(s=d.default.height-n));let y=d.default.left+a,f=d.default.top+n;d.isFixedPos&&(y=d.fixedLeft+a,f=d.fixedTop+n),$("#luckysheet-modal-dialog-cropping").show().css({width:o,height:s,left:y,top:f}),$("#luckysheet-modal-dialog-cropping .cropping-mask").css({width:d.default.width,height:d.default.height,"background-image":"url("+d.src+")",left:-a,top:-n}),$("#luckysheet-modal-dialog-cropping .cropping-content").css({"background-image":"url("+d.src+")","background-size":d.default.width+"px "+d.default.height+"px","background-position":-a+"px "+-n+"px"}),r.cropChangeObj={width:o,height:s,offsetLeft:a,offsetTop:n}}else if(s.move){let t=ve(e.pageX,e.pageY),l=t[0]+$("#luckysheet-cell-main").scrollLeft(),c=t[1]+$("#luckysheet-cell-main").scrollTop(),o=s.currentObj.outerHeight(),r=s.currentObj.outerWidth(),a=c-s.moveXY[1],n=l-s.moveXY[0];a<0&&(a=0),a+o+42+6>s.currentWinH&&(a=s.currentWinH-o-42-6),n<0&&(n=0),n+r+22+36>s.currentWinW&&(n=s.currentWinW-r-22-36),s.currentObj.css({left:n,top:a})}else if(s.resize){let t=ve(e.pageX,e.pageY),l=t[0]+$("#luckysheet-cell-main").scrollLeft(),c=t[1]+$("#luckysheet-cell-main").scrollTop();if(l<0||c<0)return!1;let o=s.resizeXY,r=c-o[1],a=l-o[0],n=o[5],i=o[3],u=o[4],h=o[2],d=s.resize;"lm"!=d&&"lt"!=d&&"lb"!=d||(u=l,h=o[2]-a,u>o[2]+o[4]-60?(u=o[2]+o[4]-60,h=o[2]-(o[2]+o[4]-60-o[0])):u<=0&&(u=0,h=o[2]+o[0])),"rm"!=d&&"rt"!=d&&"rb"!=d||((h=o[2]+a)<60?h=60:h>=s.currentWinW-o[4]-22-36&&(h=s.currentWinW-o[4]-22-36)),"mt"!=d&&"lt"!=d&&"rt"!=d||(n=c,i=o[3]-r,n>o[3]+o[5]-60?(n=o[3]+o[5]-60,i=o[3]-(o[3]+o[5]-60-o[1])):n<=0&&(n=0,i=o[3]+o[1])),"mb"!=d&&"lb"!=d&&"rb"!=d||((i=o[3]+r)<60?i=60:i>=s.currentWinH-o[5]-42-6&&(i=s.currentWinH-o[5]-42-6)),s.currentObj.css({width:h,height:i,left:u,top:n})}else L.rangeResize?L.rangeResizeDraging(e,L.rangeResizeObj,L.rangeResizexy,L.rangeResize,L.rangeResizeWinW,L.rangeResizeWinH,q.ch_width,q.rh_height):L.rangeMove?L.rangeMoveDraging(e,L.rangeMovexy,L.rangeMoveObj.data("range"),L.rangeMoveObj,q.sheetBarHeight,q.statisticBarHeight):q.chart_selection.rangeResize?q.chart_selection.rangeResizeDraging(e,q.sheetBarHeight,q.statisticBarHeight):q.chart_selection.rangeMove&&q.chart_selection.rangeMoveDraging(e,q.sheetBarHeight,q.statisticBarHeight);q.jfautoscrollTimeout=window.requestAnimationFrame(t)})}}),$(document).on("mouseup.luckysheetEvent",function(e){if(t&&t.hook&&t.hook.sheetMouseup){let o=ve(e.pageX,e.pageY),s=o[0]+$("#luckysheet-cell-main").scrollLeft(),r=o[1]+$("#luckysheet-cell-main").scrollTop(),a=pe(r),n=a[1],i=a[0],u=a[2],h=we(s),d=h[1],y=h[0],f=h[2],g=X.mergeborer(q.flowdata,u,f);g&&(n=g.row[1],i=g.row[0],u=g.row[2],d=g.column[1],y=g.column[0],f=g.column[2]);let k=m.getSheetByIndex(),_={functionResizeStatus:L.functionResizeStatus,horizontalmoveState:!!l.horizontalmovestate,verticalmoveState:!!l.verticalmovestate,pivotTableMoveState:!!c&&c.movestate,sheetMoveStatus:q.luckysheet_sheet_move_status,scrollStatus:!!q.luckysheet_scroll_status,selectStatus:!!q.luckysheet_select_status,rowsSelectedStatus:!!q.luckysheet_rows_selected_status,colsSelectedStatus:!!q.luckysheet_cols_selected_status,cellSelectedMove:!!q.luckysheet_cell_selected_move,cellSelectedExtend:!!q.luckysheet_cell_selected_extend,colsChangeSize:!!q.luckysheet_cols_change_size,rowsChangeSize:!!q.luckysheet_rows_change_size,chartMove:!!q.chartparam.luckysheetCurrentChartMove,chartResize:!!q.chartparam.luckysheetCurrentChartResize,rangeResize:!!L.rangeResize,rangeMove:!!L.rangeMove},p=$("#luckysheetTableContent").get(0).getContext("2d");t.createHookFunction("sheetMouseup",q.flowdata[u][f],{r:u,c:f,start_r:i,start_c:y,end_r:n,end_c:d},k,_,p)}if(q.luckysheet_select_status&&(clearTimeout(q.countfuncTimeout),q.countfuncTimeout=setTimeout(function(){Re()},0),i.luckysheetPaintModelOn&&(p.pasteHandlerOfPaintModel(q.luckysheet_copy_save),i.luckysheetPaintSingle&&i.cancelPaintModel())),q.luckysheet_select_status=!1,window.cancelAnimationFrame(q.jfautoscrollTimeout),q.luckysheet_scroll_status=!1,$("#luckysheet-cell-selected").find(".luckysheet-cs-fillhandle").css("cursor","crosshair").end().find(".luckysheet-cs-draghandle").css("cursor","move"),$("#luckysheet-cell-main, #luckysheetTableContent, #luckysheet-sheettable_0").css("cursor","default"),q.luckysheet_rows_selected_status=!1,q.luckysheet_cols_selected_status=!1,q.luckysheet_model_move_state=!1,L.functionResizeStatus&&(L.functionResizeStatus=!1,$("#luckysheet-wa-calculate-size").removeAttr("style")),l.horizontalmovestate&&(l.horizontalmovestate=!1,$("#luckysheet-freezebar-horizontal").removeClass("luckysheet-freezebar-active"),$("#luckysheet-freezebar-horizontal").find(".luckysheet-freezebar-horizontal-handle").css("cursor","-webkit-grab"),q.freezenhorizontaldata[4]<=q.columnHeaderHeight&&l.cancelFreezenHorizontal(),l.createAssistCanvas(),luckysheetrefreshgrid()),l.verticalmovestate&&(l.verticalmovestate=!1,$("#luckysheet-freezebar-vertical").removeClass("luckysheet-freezebar-active"),$("#luckysheet-freezebar-vertical").find(".luckysheet-freezebar-vertical-handle").css("cursor","-webkit-grab"),q.freezenverticaldata[4]<=q.rowHeaderWidth&&l.cancelFreezenVertical(),l.createAssistCanvas(),luckysheetrefreshgrid()),c&&c.movestate&&($("#luckysheet-modal-dialog-slider-pivot-move").remove(),c.movestate=!1,$("#luckysheet-modal-dialog-pivotTable-list, #luckysheet-modal-dialog-config-filter, #luckysheet-modal-dialog-config-row, #luckysheet-modal-dialog-config-column, #luckysheet-modal-dialog-config-value").css("cursor","default"),"luckysheet-modal-dialog-pivotTable-list"!=c.movesave.containerid)){0==$(e.target).closest(".luckysheet-modal-dialog-slider-config-list").length&&("luckysheet-modal-dialog-config-value"==c.movesave.containerid&&c.resetOrderby(c.movesave.obj),c.movesave.obj.remove(),c.showvaluecolrow(),$("#luckysheet-modal-dialog-pivotTable-list").find(".luckysheet-modal-dialog-slider-list-item").each(function(){$(this).find(".luckysheet-slider-list-item-selected").find("i").remove()}),$("#luckysheet-modal-dialog-config-filter, #luckysheet-modal-dialog-config-row, #luckysheet-modal-dialog-config-column, #luckysheet-modal-dialog-config-value").find(".luckysheet-modal-dialog-slider-config-item").each(function(){let e=$(this).data("index");$("#luckysheet-modal-dialog-pivotTable-list").find(".luckysheet-modal-dialog-slider-list-item").each(function(){let t=$(this).find(".luckysheet-slider-list-item-selected");$(this).data("index")==e&&0==t.find("i").length&&t.append('<i class="fa fa-check luckysheet-mousedown-cancel"></i>')})}),c.refreshPivotTable())}if(q.luckysheet_sheet_move_status&&(q.luckysheet_sheet_move_status=!1,q.luckysheet_sheet_move_data.activeobject.insertBefore($("#luckysheet-sheets-item-clone")),q.luckysheet_sheet_move_data.activeobject.removeAttr("style"),$("#luckysheet-sheets-item-clone").remove(),q.luckysheet_sheet_move_data.cursorobject.css({cursor:"pointer"}),q.luckysheet_sheet_move_data={},m.reOrderAllSheet()),clearTimeout(q.chartparam.luckysheetCurrentChartMoveTimeout),q.chartparam.luckysheetCurrentChartMove&&(q.chartparam.luckysheetCurrentChartMove=!1,q.chartparam.luckysheetInsertChartTosheetChange)){var a=q.chartparam.luckysheetCurrentChartMoveObj.css("top"),n=q.chartparam.luckysheetCurrentChartMoveObj.css("left"),h=$("#luckysheet-cell-main").scrollLeft(),d=$("#luckysheet-cell-main").scrollTop(),y=q.chartparam.luckysheetCurrentChartMoveXy[2],g=q.chartparam.luckysheetCurrentChartMoveXy[3],k=q.chartparam.luckysheetCurrentChartMoveXy[4],_=q.chartparam.luckysheetCurrentChartMoveXy[5],w=q.chartparam.luckysheetCurrentChartMoveObj.find(".luckysheet-modal-dialog-content").attr("id");q.jfredo.push({type:"moveChart",chart_id:w,sheetIndex:q.currentSheetIndex,myTop:a,myLeft:n,scrollTop:d,scrollLeft:h,x:y,y:g,scrollTop1:_,scrollLeft1:k})}if(q.chartparam.luckysheetCurrentChartResize&&(q.chartparam.luckysheetCurrentChartResize=null,q.chartparam.luckysheetInsertChartTosheetChange)){var v=q.chartparam.luckysheetCurrentChartResizeObj.height(),b=q.chartparam.luckysheetCurrentChartResizeObj.width(),z=(h=$("#luckysheet-cell-main").scrollLeft(),d=$("#luckysheet-cell-main").scrollTop(),a=q.chartparam.luckysheetCurrentChartMoveObj.css("top"),n=q.chartparam.luckysheetCurrentChartMoveObj.css("left"),w=q.chartparam.luckysheetCurrentChartResizeObj.find(".luckysheet-modal-dialog-content").attr("id"),q.chartparam.luckysheetCurrentChartResizeXy[2]),C=q.chartparam.luckysheetCurrentChartResizeXy[3];y=q.chartparam.luckysheetCurrentChartResizeXy[4],g=q.chartparam.luckysheetCurrentChartResizeXy[5],k=q.chartparam.luckysheetCurrentChartResizeXy[6],_=q.chartparam.luckysheetCurrentChartResizeXy[7];q.jfredo.push({type:"resizeChart",chart_id:w,sheetIndex:q.currentSheetIndex,myTop:a,myLeft:n,myHeight:v,myWidth:b,scrollTop:d,scrollLeft:h,x:y,y:g,myWidth1:z,myHeight1:C,scrollTop1:_,scrollLeft1:k})}if(L.rangeResize&&L.rangeResizeDragged(e,L.rangeResizeObj,L.rangeResize,L.rangeResizexy,L.rangeResizeWinW,L.rangeResizeWinH),r.move&&r.moveImgItem(),r.resize&&r.resizeImgItem(),r.cropChange&&r.cropChangeImgItem(),s.move){s.move=!1;let e=s.currentObj.closest(".luckysheet-postil-show").attr("id"),t=e.split("luckysheet-postil-show_")[1].split("_")[0],l=e.split("luckysheet-postil-show_")[1].split("_")[1],c=q.deepCopyFlowData(q.flowdata),o=[];c[t][l].ps.left=s.currentObj.position().left,c[t][l].ps.top=s.currentObj.position().top,c[t][l].ps.value=s.currentObj.find(".formulaInputFocus").text(),o.push(t+"_"+l),s.ref(c,o),$("#"+e).remove(),c[t][l].ps.isshow?(s.buildPs(t,l,c[t][l].ps),$("#"+e).addClass("luckysheet-postil-show-active"),$("#"+e).find(".luckysheet-postil-dialog-resize").show()):s.editPs(t,l)}if(s.resize){s.resize=null;let e=s.currentObj.closest(".luckysheet-postil-show").attr("id"),t=e.split("luckysheet-postil-show_")[1].split("_")[0],l=e.split("luckysheet-postil-show_")[1].split("_")[1],c=q.deepCopyFlowData(q.flowdata),o=[];c[t][l].ps.left=s.currentObj.position().left,c[t][l].ps.top=s.currentObj.position().top,c[t][l].ps.width=s.currentObj.outerWidth(),c[t][l].ps.height=s.currentObj.outerHeight(),c[t][l].ps.value=s.currentObj.find(".formulaInputFocus").text(),o.push(t+"_"+l),s.ref(c,o),$("#"+e).remove(),c[t][l].ps.isshow?(s.buildPs(t,l,c[t][l].ps),$("#"+e).addClass("luckysheet-postil-show-active"),$("#"+e).find(".luckysheet-postil-dialog-resize").show()):s.editPs(t,l)}if(q.luckysheet_rows_change_size){q.luckysheet_rows_change_size=!1,$("#luckysheet-change-size-line").hide(),$("#luckysheet-rows-change-size").css("opacity",0),$("#luckysheet-sheettable, #luckysheet-rows-h, #luckysheet-rows-h canvas").css("cursor","default");let t=ve(e.pageX,e.pageY),l=$("#luckysheet-rows-h").scrollTop(),c=t[1]+l,o=$(window).height(),s=pe(c),a=(s[1],s[0],s[2],c+3-q.luckysheet_rows_change_size_start[0]);c+3-q.luckysheet_rows_change_size_start[0]<19&&(a=19),c>=o-200+l&&(a=o-200-q.luckysheet_rows_change_size_start[0]+l);let n=$.extend(!0,{},q.config);null==n.rowlen&&(n.rowlen={}),null==n.customHeight&&(n.customHeight={}),n.customHeight[q.luckysheet_rows_change_size_start[1]]=1;const i=q.luckysheet_rows_change_size_start[1];let u=!1;q.luckysheet_select_save.length>0&&q.luckysheet_select_save.filter(e=>e.row_select).some(e=>(i>=e.row[0]&&i<=e.row[1]&&(u=!0),u)),u?q.luckysheet_select_save.filter(e=>e.row_select).forEach(e=>{for(let t=e.row[0];t<=e.row[1];t++)n.rowlen[t]=Math.ceil(a/q.zoomRatio)}):n.rowlen[q.luckysheet_rows_change_size_start[1]]=Math.ceil(a/q.zoomRatio);let h=r.moveChangeSize("row",q.luckysheet_rows_change_size_start[1],a);q.clearjfundo&&(q.jfundo.length=0,q.jfredo.push({type:"resize",ctrlType:"resizeR",sheetIndex:q.currentSheetIndex,config:$.extend(!0,{},q.config),curconfig:$.extend(!0,{},n),images:$.extend(!0,{},r.images),curImages:$.extend(!0,{},h)})),q.config=n,q.luckysheetfile[ke(q.currentSheetIndex)].config=q.config,q.saveParam("cg",q.currentSheetIndex,n.rowlen,{k:"rowlen"}),q.luckysheetfile[ke(q.currentSheetIndex)].images=h,q.saveParam("all",q.currentSheetIndex,h,{k:"images"}),r.images=h,r.allImagesShow(),q.refreshGrid_rhcw(q.flowdata.length,null)}if(q.luckysheet_cols_change_size){q.luckysheet_cols_change_size=!1,$("#luckysheet-change-size-line").hide(),$("#luckysheet-cols-change-size").css("opacity",0),$("#luckysheet-sheettable, #luckysheet-cols-h-c, .luckysheet-cols-h-cells, .luckysheet-cols-h-cells canvas").css("cursor","default");let t=ve(e.pageX,e.pageY),l=$("#luckysheet-cols-h-c").scrollLeft(),c=t[0]+l,o=$(window).width(),s=q.visibledatarow.length-1,a=(q.visibledatarow[s],we(c)),n=(a[1],a[0],a[2],c+3-q.luckysheet_cols_change_size_start[0]),i=q.defaultcollen;if(null!=q.config.columnlen&&null!=q.config.columnlen[q.luckysheet_cols_change_size_start[1]]&&(i=q.config.columnlen[q.luckysheet_cols_change_size_start[1]]),Math.abs(n-i)<3)return;c+3-q.luckysheet_cols_change_size_start[0]<30&&(n=30),c>=o-100+l&&(n=o-100-q.luckysheet_cols_change_size_start[0]+l);let u=$.extend(!0,{},q.config);null==u.columnlen&&(u.columnlen={}),null==u.customWidth&&(u.customWidth={}),u.customWidth[q.luckysheet_cols_change_size_start[1]]=1;const h=q.luckysheet_cols_change_size_start[1];let d=!1;q.luckysheet_select_save.length>0&&q.luckysheet_select_save.filter(e=>e.column_select).some(e=>(h>=e.column[0]&&h<=e.column[1]&&(d=!0),d)),d?q.luckysheet_select_save.filter(e=>e.column_select).forEach(e=>{for(let t=e.column[0];t<=e.column[1];t++)u.columnlen[t]=Math.ceil(n/q.zoomRatio)}):u.columnlen[q.luckysheet_cols_change_size_start[1]]=Math.ceil(n/q.zoomRatio);let m=r.moveChangeSize("column",q.luckysheet_cols_change_size_start[1],n);q.clearjfundo&&(q.jfundo.length=0,q.jfredo.push({type:"resize",ctrlType:"resizeC",sheetIndex:q.currentSheetIndex,config:$.extend(!0,{},q.config),curconfig:$.extend(!0,{},u),images:$.extend(!0,{},r.images),curImages:$.extend(!0,{},m)})),q.config=u,q.luckysheetfile[ke(q.currentSheetIndex)].config=q.config,q.saveParam("cg",q.currentSheetIndex,u.columnlen,{k:"columnlen"}),q.luckysheetfile[ke(q.currentSheetIndex)].images=m,q.saveParam("all",q.currentSheetIndex,m,{k:"images"}),r.images=m,r.allImagesShow(),q.refreshGrid_rhcw(null,q.flowdata[0].length),q.refresh()}if(L.rangeMove&&L.rangeMoveDragged(L.rangeMoveObj),q.luckysheet_cell_selected_move){$("#luckysheet-cell-selected-move").hide(),q.luckysheet_cell_selected_move=!1;let t=ve(e.pageX,e.pageY);if(!ce(q.luckysheet_select_save,q.currentSheetIndex))return;let l=$("#luckysheet-cell-main").scrollLeft(),c=$("#luckysheet-cell-main").scrollTop(),o=t[0]+l,s=t[1]+c,r=$(window).height()+c-q.sheetBarHeight-q.statisticBarHeight,a=$(window).width()+l,n=pe(s)[2],i=we(o)[2],h=q.luckysheet_cell_selected_move_index[0],d=q.luckysheet_cell_selected_move_index[1];if(n==h&&i==d)return;let m=q.deepCopyFlowData(q.flowdata),y=q.luckysheet_select_save[q.luckysheet_select_save.length-1],g=Se(y),k=$.extend(!0,{},q.config);if(null==k.merge&&(k.merge={}),null==k.rowlen&&(k.rowlen={}),ze(k,y.row[0],y.row[1],y.column[0],y.column[1]))return void(Ce()?alert(f.noMerge):j.info('<i class="fa fa-exclamation-triangle"></i>',f.noMerge));let _=y.row[0]-h+n,p=y.row[1]-h+n,w=y.column[0]-d+i,v=y.column[1]-d+i;if(!ce([{row:[_,p],column:[w,v]}],q.currentSheetIndex))return;if((_<0||s<0)&&(_=0,p=y.row[1]-y.row[0]),(w<0||o<0)&&(w=0,v=y.column[1]-y.column[0]),(p>=q.visibledatarow[q.visibledatarow.length-1]||s>r)&&(_=q.visibledatarow.length-1-y.row[1]+y.row[0],p=q.visibledatarow.length-1),(v>=q.visibledatacolumn[q.visibledatacolumn.length-1]||o>a)&&(w=q.visibledatacolumn.length-1-y.column[1]+y.column[0],v=q.visibledatacolumn.length-1),ze(k,_,p,w,v))return void(Ce()?alert(f.noMerge):j.info('<i class="fa fa-exclamation-triangle"></i>',f.noMerge));let b=Ie(q.currentSheetIndex),z=null;for(let e=y.row[0];e<=y.row[1];e++){e in k.rowlen&&(z=!0);for(let t=y.column[0];t<=y.column[1];t++){let l=m[e][t];"object"==ue(l)&&"mc"in l&&l.mc.r+"_"+l.mc.c in k.merge&&delete k.merge[l.mc.r+"_"+l.mc.c],m[e][t]=null}}if(k.borderInfo&&k.borderInfo.length>0){let e=[];for(let t=0;t<k.borderInfo.length;t++){let l=k.borderInfo[t].rangeType;if("range"==l){let l=k.borderInfo[t].range,c=[];for(let e=0;e<l.length;e++)c=c.concat(u.CFSplitRange(l[e],{row:y.row,column:y.column},{row:[_,p],column:[w,v]},"restPart"));k.borderInfo[t].range=c,e.push(k.borderInfo[t])}else if("cell"==l){let l=k.borderInfo[t].value.row_index,c=k.borderInfo[t].value.col_index;l>=y.row[0]&&l<=y.row[1]&&c>=y.column[0]&&c<=y.column[1]||e.push(k.borderInfo[t])}}k.borderInfo=e}let C={};for(let e=0;e<g.length;e++)for(let t=0;t<g[0].length;t++){if(b[e+y.row[0]+"_"+(t+y.column[0])]){let l={rangeType:"cell",value:{row_index:e+_,col_index:t+w,l:b[e+y.row[0]+"_"+(t+y.column[0])].l,r:b[e+y.row[0]+"_"+(t+y.column[0])].r,t:b[e+y.row[0]+"_"+(t+y.column[0])].t,b:b[e+y.row[0]+"_"+(t+y.column[0])].b}};null==k.borderInfo&&(k.borderInfo=[]),k.borderInfo.push(l)}let l="";if(null!=g[e]&&null!=g[e][t]&&(l=g[e][t]),"object"==ue(l)&&"mc"in l){let c=$.extend(!0,{},l.mc);"rs"in l.mc?(C[c.r+"_"+c.c]=[e+_,t+w],l.mc.r=e+_,l.mc.c=t+w,k.merge[e+_+"_"+(t+w)]=l.mc):(l.mc.r=C[c.r+"_"+c.c][0],l.mc.c=C[c.r+"_"+c.c][1])}m[e+_][t+w]=l}z&&(k=be(m,y.row[0],y.row[1],k),k=be(m,_,p,k));let R,x,S=$.extend(!0,[],q.luckysheetfile[ke(q.currentSheetIndex)].luckysheet_conditionformat_save);if(null!=S&&S.length>0)for(let e=0;e<S.length;e++){let t=S[e].cellrange,l=[];for(let e=0;e<t.length;e++){let c=u.CFSplitRange(t[e],{row:y.row,column:y.column},{row:[_,p],column:[w,v]},"allPart");l=l.concat(c)}S[e].cellrange=l}R=q.luckysheet_select_save[0].row_focus==q.luckysheet_select_save[0].row[0]?_:p,x=q.luckysheet_select_save[0].column_focus==q.luckysheet_select_save[0].column[0]?w:v;let M=[];M.push({row:y.row,column:y.column}),M.push({row:[_,p],column:[w,v]}),y.row=[_,p],y.column=[w,v],y.row_focus=R,y.column_focus=x;let T={cfg:k,RowlChange:z,cdformat:S};q.refreshGrid(m,M,T),G(),$("#luckysheet-sheettable").css("cursor","default"),clearTimeout(q.countfuncTimeout),q.countfuncTimeout=setTimeout(function(){Re()},500)}if(q.chart_selection.rangeMove&&q.chart_selection.rangeMoveDragged(),q.chart_selection.rangeResize&&q.chart_selection.rangeResizeDragged(),q.luckysheet_cell_selected_extend){if(q.luckysheet_cell_selected_extend=!1,$("#luckysheet-cell-selected-extend").hide(),!ce(q.luckysheet_select_save,q.currentSheetIndex))return;let t=ve(e.pageX,e.pageY),l=$("#luckysheet-cell-main").scrollLeft(),s=$("#luckysheet-cell-main").scrollTop(),r=t[0]+l-5,a=t[1]+s-5,n=$(window).height()+s-q.sheetBarHeight-q.statisticBarHeight,i=$(window).width()+l,u=pe(a),h=(u[1],u[0]),d=u[2],m=we(r),y=(m[1],m[0]),g=m[2],k=q.luckysheet_cell_selected_extend_index[0],_=q.luckysheet_cell_selected_extend_index[1],p=q.luckysheet_select_save[q.luckysheet_select_save.length-1],w=p.row[0],v=p.row[1],b=p.column[0],z=p.column[1];(w<0||a<0)&&(w=0,v=p.row[1]-p.row[0]),(b<0||r<0)&&(b=0,z=p.column[1]-p.column[0]),(v>=q.visibledatarow[q.visibledatarow.length-1]||a>n)&&(w=q.visibledatarow.length-1-p.row[1]+p.row[0],v=q.visibledatarow.length-1),(z>=q.visibledatacolumn[q.visibledatacolumn.length-1]||r>i)&&(b=q.visibledatacolumn.length-1-p.column[1]+p.column[0],z=q.visibledatacolumn.length-1),o.copyRange={row:$.extend(!0,[],p.row),column:$.extend(!0,[],p.column)};let C=o.typeItemHide();if(C[0]||C[1]||C[2]||C[3]||C[4]||C[5]||C[6]?o.applyType="1":o.applyType="0",Math.abs(k-d)>Math.abs(_-g)){if(d>=w&&d<=v)return;if(q.luckysheet_select_save[0].top_move>=h){if(o.applyRange={row:[d,p.row[0]-1],column:p.column},o.direction="up",w-=p.row[0]-d,c.isPivotRange(w,z))return void j.info(f.affectPivot,"")}else if(o.applyRange={row:[p.row[1]+1,d],column:p.column},o.direction="down",v+=d-p.row[1],c.isPivotRange(v,z))return void j.info(f.affectPivot,"")}else{if(g>=b&&g<=z)return;if(q.luckysheet_select_save[0].left_move>=y){if(o.applyRange={row:p.row,column:[g,p.column[0]-1]},o.direction="left",b-=p.column[0]-g,c.isPivotRange(v,b))return void j.info(f.affectPivot,"")}else if(o.applyRange={row:p.row,column:[p.column[1]+1,g]},o.direction="right",z+=g-p.column[1],c.isPivotRange(v,z))return void j.info(f.affectPivot,"")}if(null!=q.config.merge){let e=!1;for(let t=p.row[0];t<=p.row[1];t++)for(let l=p.column[0];l<=p.column[1];l++){let c=q.flowdata[t][l];if(null!=c&&null!=c.mc){e=!0;break}}if(e)return void(Ce()?alert(f.noMerge):j.info(f.noMerge,""));for(let t=w;t<=v;t++)for(let l=b;l<=z;l++){let c=q.flowdata[t][l];if(null!=c&&null!=c.mc){e=!0;break}}if(e)return void(Ce()?alert(f.noMerge):j.info(f.noMerge,""))}p.row=[w,v],p.column=[b,z],o.update(),o.createIcon(),$("#luckysheet-cell-selected-move").hide(),$("#luckysheet-sheettable").css("cursor","default"),clearTimeout(q.countfuncTimeout),q.countfuncTimeout=setTimeout(function(){Re()},500)}}),$(".luckysheet-grid-container, #luckysheet-rightclick-menu").on("contextmenu",function(e){e.preventDefault()}),$("#luckysheet-cell-main div.luckysheet-cs-draghandle").mousedown(function(e){if(Ce()||!1===q.allowEdit)return;$("#luckysheet-cell-selected").find(".luckysheet-cs-fillhandle").css("cursor","move").end().find(".luckysheet-cs-draghandle").css("cursor","move"),$("#luckysheet-cell-main, #luckysheetTableContent, #luckysheet-sheettable_0").css("cursor","move"),q.luckysheet_cell_selected_move=!0,q.luckysheet_scroll_status=!0;let t=ve(e.pageX,e.pageY),l=t[0]+$("#luckysheet-cell-main").scrollLeft(),c=t[1]+$("#luckysheet-cell-main").scrollTop(),o=pe(c),s=o[0],r=o[1],a=o[2],n=we(l),i=n[0],u=n[1],h=n[2];q.luckysheet_cell_selected_move_index=[a,h],$("#luckysheet-cell-selected-move").css({left:i,width:u-i-1,top:s,height:r-s-1,display:"block"}),e.stopPropagation()}),$("#luckysheet-cell-main div.luckysheet-cs-fillhandle").mousedown(function(e){Ce()||!1===q.allowEdit||($("#luckysheet-cell-selected").find(".luckysheet-cs-fillhandle").css("cursor","crosshair").end().find(".luckysheet-cs-draghandle").css("cursor","crosshair"),$("#luckysheet-cell-main, #luckysheetTableContent, #luckysheet-sheettable_0").css("cursor","crosshair"),q.luckysheet_cell_selected_extend_time=setTimeout(function(){q.luckysheet_cell_selected_extend=!0,q.luckysheet_scroll_status=!0;let t=ve(e.pageX,e.pageY),l=t[0]+$("#luckysheet-cell-main").scrollLeft()-5,c=t[1]+$("#luckysheet-cell-main").scrollTop()-5,o=pe(c),s=o[0],r=o[1],a=o[2],n=we(l),i=n[0],u=n[1],h=n[2];q.luckysheet_cell_selected_extend_index=[a,h],$("#luckysheet-cell-selected-extend").css({left:i,width:u-i-1,top:s,height:r-s-1,display:"block"})},100),e.stopPropagation())}).click(function(){clearTimeout(q.luckysheet_cell_selected_extend_time),event.stopPropagation()}).dblclick(function(){let e=q.luckysheet_select_save[0],t=e.row[0],l=e.row[1],s=e.column[0],r=e.column[1];if(c.isPivotRange(t,s))return;let a=!1,n=0;for(let e=l+1;e<q.flowdata.length;e++)if(s-1>=0&&r+1<q.flowdata[0].length){let t=q.flowdata[e][s-1],c=q.flowdata[e][r+1];if(e==l+1){if((null==t||$e(t.v))&&(null==c||$e(c.v))){a=!1;break}a=!0,n++}else{if((null==t||$e(t.v))&&(null==c||$e(c.v)))break;n++}}else if(s-1>=0){let t=q.flowdata[e][s-1];if(e==l+1){if(null==t||$e(t.v)){a=!1;break}a=!0,n++}else{if(null==t||$e(t.v))break;n++}}else if(r+1<q.flowdata[0].length){let t=q.flowdata[e][r+1];if(e==l+1){if(null==t||$e(t.v)){a=!1;break}a=!0,n++}else{if(null==t||$e(t.v))break;n++}}if(!a||0==n)return void event.stopPropagation();o.copyRange={row:[t,l],column:[s,r]};let i=o.typeItemHide();i[0]||i[1]||i[2]||i[3]||i[4]||i[5]||i[6]?o.applyType="1":o.applyType="0",o.applyRange={row:[l+1,l+n],column:[s,r]},o.direction="down",q.luckysheet_select_save=[{row:[t,l+n],column:[s,r]}],o.update(),o.createIcon(),$("#luckysheet-cell-selected-move").hide(),$("#luckysheet-sheettable").css("cursor","default"),clearTimeout(q.countfuncTimeout),q.countfuncTimeout=setTimeout(function(){Re()},500),event.stopPropagation()}),$("#luckysheet-bottom-add-row, #luckysheet-bottom-add-row-input, #luckysheet-bottom-return-top").on("mousedown dblclick mouseup",function(e){e.stopPropagation()}),$("#luckysheet-bottom-add-row").on("click",function(e){$("#luckysheet-rightclick-menu").hide(),fe();$(this);let t=$("#luckysheet-bottom-add-row-input").val();""==t&&(t=100),isNaN(parseInt(t))?Ce()?alert(k.tipInputNumber):j.info("error",k.tipInputNumber):(t=parseInt(t))<1||t>100?Ce()?alert(k.tipInputNumberLimit):j.info("error",k.tipInputNumberLimit):xe("row",q.flowdata.length-1,t)}),$("#luckysheet-bottom-return-top").on("click",function(e){$("#luckysheet-scrollbar-y").scrollTop(0)}),$("#luckysheet-copy-btn, #luckysheet-cols-copy-btn, #luckysheet-paste-btn-title").click(function(e){if($(this).parent().hide(),null!=q.config.merge){let e=!1;for(let t=0;t<q.luckysheet_select_save.length;t++){let l=q.luckysheet_select_save[t].row[0],c=q.luckysheet_select_save[t].row[1],o=q.luckysheet_select_save[t].column[0],s=q.luckysheet_select_save[t].column[1];if(e=ze(q.config,l,c,o,s))break}if(e)return void(Ce()?alert(f.noPartMerge):j.info(f.noPartMerge,""))}let t=q.luckysheetfile[ke(q.currentSheetIndex)].luckysheet_conditionformat_save;if(q.luckysheet_select_save.length>1&&null!=t&&t.length>0){let e=!1,t=u.getComputeMap();e:for(let l=0;l<q.luckysheet_select_save.length&&!e;l++){let c=q.luckysheet_select_save[l].row[0],o=q.luckysheet_select_save[l].row[1],s=q.luckysheet_select_save[l].column[0],r=q.luckysheet_select_save[l].column[1];for(let l=c;l<=o;l++)for(let c=s;c<=r;c++)if(null!=u.checksCF(l,c,t)){e=!0;continue e}}if(e)return void(Ce()?alert(f.noMulti):j.info(f.noMulti,""))}if(q.luckysheet_select_save.length>1){let e=!0,t=q.luckysheet_select_save[0].row[0],l=q.luckysheet_select_save[0].row[1],c=!0,o=q.luckysheet_select_save[0].column[0],s=q.luckysheet_select_save[0].column[1];for(let r=1;r<q.luckysheet_select_save.length;r++)q.luckysheet_select_save[r].row[0]==t&&q.luckysheet_select_save[r].row[1]==l||(e=!1),q.luckysheet_select_save[r].column[0]==o&&q.luckysheet_select_save[r].column[1]==s||(c=!1);if(!e&&!c||Q())return void(Ce()?alert(f.noMulti):j.info(f.noMulti,""))}p.copy(e)}),$("#luckysheet-copy-paste, #luckysheet-cols-paste-btn, #luckysheet-paste-btn-title").click(function(e){p.paste(e,"btn"),$(this).parent().hide()}),$("#luckysheet-chart-btn-title").click(function(){Xe()}),$("#luckysheetdatavisual").click(function(){Xe(),$("#luckysheet-rightclick-menu").hide()}),$("#luckysheet-pivot-btn-title").click(function(e){ae(q.currentSheetIndex,"usePivotTablereports")&&c.createPivotTable(e)}),$("#luckysheet-chart-btn-screenshot").click(function(){const e=y.screenshot;if(0==q.luckysheet_select_save.length)return void(Ce()?alert(e.screenshotTipNoSelection):j.info(e.screenshotTipTitle,e.screenshotTipNoSelection));if(q.luckysheet_select_save.length>1)return void(Ce()?alert(e.screenshotTipHasMulti):j.info(e.screenshotTipTitle,e.screenshotTipHasMulti));if(null!=q.config.merge){let t=!1;for(let e=0;e<q.luckysheet_select_save.length;e++){let l=q.luckysheet_select_save[e].row[0],c=q.luckysheet_select_save[e].row[1],o=q.luckysheet_select_save[e].column[0],s=q.luckysheet_select_save[e].column[1];if(t=ze(q.config,l,c,o,s))break}if(t)return void(Ce()?alert(e.screenshotTipHasMerge):j.info(e.screenshotTipTitle,e.screenshotTipHasMerge))}let t,l,c,o,s=q.luckysheet_select_save[0].row[0],r=q.luckysheet_select_save[0].row[1],a=q.luckysheet_select_save[0].column[0],n=q.luckysheet_select_save[0].column[1];s-1<0?(t=0,l=q.visibledatarow[r]):(t=q.visibledatarow[s-1],l=q.visibledatarow[r]-q.visibledatarow[s-1]),a-1<0?(c=0,o=q.visibledatacolumn[n]):(c=q.visibledatacolumn[a-1],o=q.visibledatacolumn[n]-q.visibledatacolumn[a-1]);let i=$("<canvas>").attr({width:Math.ceil(o*devicePixelRatio),height:Math.ceil(l*devicePixelRatio)}).css({width:o,height:l});He(c,t,o,l,1,1,null,null,i);let u=i.get(0).getContext("2d");u.beginPath(),u.moveTo(0,0),u.lineTo(0,q.devicePixelRatio*l),u.lineWidth=2*q.devicePixelRatio,u.strokeStyle=le.strokeStyle,u.stroke(),u.closePath(),u.beginPath(),u.moveTo(0,0),u.lineTo(q.devicePixelRatio*o,0),u.lineWidth=2*q.devicePixelRatio,u.strokeStyle=le.strokeStyle,u.stroke(),u.closePath();let h=new Image,d=i.get(0).toDataURL("image/png");h.src=d,o>l?h.style.width="100%":h.style.height="100%";let m=$(window).height()-200;j.screenshot(e.screenshotTipSuccess,'<div id="luckysheet-confirm-screenshot-save" style="height:'+m+'px;overflow:auto;"></div>',d),$("#luckysheet-confirm-screenshot-save").append(h),i.remove()}),$(document).on("click.luckysheetEvent","a.download",function(){let e=$("#luckysheet-confirm-screenshot-save img").attr("src");const t=y.screenshot;let l=atob(e.split(",")[1]),c=l.length,o=new Uint8Array(c);for(let e=0;e<c;e++)o[e]=l.charCodeAt(e);let s,r=new Blob([o]),a=document.createElement("a");a.setAttribute("href",URL.createObjectURL(r)),a.setAttribute("download",t.screenshotImageName+".png"),a.style.display="none",document.body.appendChild(a),a.click(),a.addEventListener("click",s=function(){requestAnimationFrame(function(){URL.revokeObjectURL(a.href)}),a.removeAttribute("href"),a.removeEventListener("click",s)}),document.body.removeChild(a)}),$("#luckysheet-splitColumn-btn-title").click(function(){if(!re(q.currentSheetIndex))return;if(null==q.luckysheet_select_save||0==q.luckysheet_select_save.length)return;const e=y.splitText;q.luckysheet_select_save.length>1?j.info(e.tipNoMulti,""):q.luckysheet_select_save[0].column[0]==q.luckysheet_select_save[0].column[1]?(v.createDialog(),v.init()):j.info(e.tipNoMultiColumn,"")}),$("#luckysheet-insertImg-btn-title").click(function(){ae(q.currentSheetIndex,"editObjects")&&$("#luckysheet-imgUpload").click()}),$("#luckysheetInsertImage").click(function(){ae(q.currentSheetIndex,"editObjects")&&($("#luckysheet-imgUpload").click(),$("#luckysheet-rightclick-menu").hide())}),$("#luckysheet-imgUpload").click(function(e){e.stopPropagation()}),$("#luckysheet-imgUpload").on("change",function(e){if(!ae(q.currentSheetIndex,"editObjects",!1))return;let t=e.currentTarget.files[0],l=new FileReader;l.readAsDataURL(t),l.onload=function(e){let t=e.target.result;r.inserImg(t),$("#luckysheet-imgUpload").val("")}}),$("#luckysheet-insertLink-btn-title").click(function(){re(q.currentSheetIndex)&&null!=q.luckysheet_select_save&&0!=q.luckysheet_select_save.length&&(a.createDialog(),a.init())}),$("#luckysheetInsertLink").click(function(){$("#luckysheet-insertLink-btn-title").click(),$("#luckysheet-rightclick-menu").hide()}),$("#luckysheet-dataVerification-btn-title").click(function(){re(q.currentSheetIndex)&&null!=q.luckysheet_select_save&&0!=q.luckysheet_select_save.length&&(n.createDialog(),n.init())}),$("#luckysheetDataVerification").click(function(){$("#luckysheet-dataVerification-btn-title").click(),$("#luckysheet-rightclick-menu").hide()}),$("#luckysheetCellFormatRightClickMenu").click(function(){ne()}),$("#luckysheet-freezen-btn-horizontal").click(function(){$.trim($(this).text())==E().freezen.freezenCancel?(l.saveFrozen("freezenCancel"),null!=q.freezenverticaldata&&(l.cancelFreezenVertical(),l.createAssistCanvas(),luckysheetrefreshgrid()),null!=q.freezenhorizontaldata&&(l.cancelFreezenHorizontal(),l.createAssistCanvas(),luckysheetrefreshgrid()),l.scrollAdapt()):(l.saveFrozen("freezenRow"),null!=q.freezenverticaldata&&(l.cancelFreezenVertical(),l.createAssistCanvas(),luckysheetrefreshgrid()),null==q.freezenhorizontaldata&&(l.createFreezenHorizontal(),l.createAssistCanvas()))}),$("#luckysheet-freezen-btn-vertical").click(function(){null!=q.freezenverticaldata?(l.saveFrozen("freezenCancel"),l.cancelFreezenVertical(),luckysheetrefreshgrid()):(l.saveFrozen("freezenColumn"),l.createFreezenVertical()),l.createAssistCanvas()}),$("#luckysheet-rightclick-menu input").on("keydown",function(e){e.stopPropagation()}),$("#luckysheet-modal-dialog-mask").on("click dbclick mousedown mousemove mouseup",function(e){e.stopPropagation(),e.preventDefault()});$(document).on("visibilitychange.luckysheetEvent webkitvisibilitychange.luckysheetEvent msvisibilitychange.luckysheetEvent",function(){(document.hidden||document.webkitHidden||document.msHidden)&&(q.iscopyself=!1)}).on("mouseleave.luckysheetEvent",function(){q.iscopyself=!1}).on("mousedown.luckysheetEvent",function(e){s.removeActivePs(),te(e),$(e.target).closest("#luckysheet-wa-editor").length>0&&parseInt($("#luckysheet-input-box").css("top"))>0&&(console.log(e),L.updatecell(q.luckysheetCellUpdate[0],q.luckysheetCellUpdate[1]),K("down",0,"rangeOfSelect"))}),$("#luckysheet-left-top").click(function(e){oe(q.currentSheetIndex)&&($("#luckysheet-wa-functionbox-confirm").click(),q.luckysheet_select_status=!1,q.luckysheet_select_save=[{row:[0,q.flowdata.length-1],column:[0,q.flowdata[0].length-1],row_focus:0,column_focus:0,row_select:!0,column_select:!0}],G(),clearTimeout(q.countfuncTimeout),q.countfuncTimeout=setTimeout(function(){Re()},500),q.saveParam("mv",q.currentSheetIndex,q.luckysheet_select_save),e.stopPropagation())}),$("#luckysheet-icon-undo").click(function(e){w.redo(e)}),$("#luckysheet-icon-redo").click(function(e){w.undo(e)}),$(document).on("mousedown.luckysheetEvent","div.luckysheet-modal-dialog",function(e){if(!$(e.target).is(".luckysheet-modal-dialog"))return;q.luckysheet_model_move_state=!0,q.luckysheet_model_move_obj=$(e.currentTarget);let t=q.luckysheet_model_move_obj.offset();q.luckysheet_model_xy=[e.pageX-t.left,e.pageY-t.top]}),$(document).on("click.luckysheetEvent",".luckysheet-modal-dialog-title-close, .luckysheet-model-close-btn",function(e){($("#textcolorselect").is(":visible")||$("#cellcolorselect").is(":visible"))&&$("#luckysheet-conditionformat-dialog").show(),$(e.currentTarget).parents(".luckysheet-modal-dialog").hide(),$("#luckysheet-modal-dialog-mask").hide(),$(this).parents(".luckysheet-modal-dialog").hasClass("luckysheet-search-formula")&&(L.dontupdate(),K("down",0,"rangeOfSelect")),$(this).parents(".luckysheet-modal-dialog").hasClass("luckysheet-search-formula-parm")&&(L.dontupdate(),K("down",0,"rangeOfSelect")),$(this).parents(".luckysheet-modal-dialog").hasClass("luckysheet-search-formula-parm-select")&&(L.dontupdate(),K("down",0,"rangeOfSelect")),fe()}),$("#luckysheet_info_detail_title").click(function(){window.open(t.myFolderUrl,"_self")}),$("#luckysheet-chart-rangeShow").on("mousedown.chartRangeShowMove",".luckysheet-chart-rangeShow-move",function(e){q.chart_selection.rangeMove=!0,q.luckysheet_scroll_status=!0,q.chart_selection.rangeMoveObj=$(this).parent();let t=q.currentChart,l=$(this).parent().attr("id");if("luckysheet-chart-rangeShow-content"==l){let e=t.rangeArray[0].row[0]+t.rangeSplitArray.content.row[0],l=t.rangeArray[0].column[0]+t.rangeSplitArray.content.column[0];q.chart_selection.rangeMoveIndex=[e,l]}else if("luckysheet-chart-rangeShow-rowtitle"==l){let e=t.rangeArray[0].row[0]+t.rangeSplitArray.rowtitle.row[0],l=t.rangeArray[0].column[0]+t.rangeSplitArray.rowtitle.column[0];q.chart_selection.rangeMoveIndex=[e,l]}else if("luckysheet-chart-rangeShow-coltitle"==l){let e=t.rangeArray[0].row[0]+t.rangeSplitArray.coltitle.row[0],l=t.rangeArray[0].column[0]+t.rangeSplitArray.coltitle.column[0];q.chart_selection.rangeMoveIndex=[e,l]}let c=ve(e.pageX,e.pageY),o=c[0]+$("#luckysheet-cell-main").scrollLeft(),s=c[1]+$("#luckysheet-cell-main").scrollTop(),r=$(this).data("type");"top"==r?s+=3:"right"==r?o-=3:"bottom"==r?s-=3:"left"==r&&(o+=3);let a=pe(s)[2],n=we(o)[2];q.chart_selection.rangeMovexy=[a,n],e.stopPropagation()}),$("#luckysheet-chart-rangeShow").on("mousedown.chartRangeShowResize",".luckysheet-chart-rangeShow-resize",function(e){q.chart_selection.rangeResize=$(this).data("type"),q.luckysheet_scroll_status=!0,q.chart_selection.rangeResizeObj=$(this).parent();let t,l,c,o,s=q.currentChart,r=$(this).parent().attr("id");if("luckysheet-chart-rangeShow-content"==r)s.rangeRowCheck.exits?(t=s.rangeArray[0].row[0]+s.rangeSplitArray.content.row[0],l=s.rangeArray[0].row[0]+s.rangeSplitArray.content.row[1]):(t=s.rangeSplitArray.content.row[0],l=s.rangeSplitArray.content.row[0]),s.rangeColCheck.exits?(c=s.rangeArray[0].column[0]+s.rangeSplitArray.content.column[0],o=s.rangeArray[0].column[0]+s.rangeSplitArray.content.column[1]):(c=s.rangeSplitArray.content.column[0],o=s.rangeSplitArray.content.column[1]),q.chart_selection.rangeResizeIndex={row:[t,l],column:[c,o]};else if("luckysheet-chart-rangeShow-rowtitle"==r){let e=s.rangeArray[0].row[0]+s.rangeSplitArray.rowtitle.row[0],t=s.rangeArray[0].row[0]+s.rangeSplitArray.rowtitle.row[1],l=s.rangeArray[0].column[0]+s.rangeSplitArray.rowtitle.column[0],c=s.rangeArray[0].column[0]+s.rangeSplitArray.rowtitle.column[1];q.chart_selection.rangeResizeIndex={row:[e,t],column:[l,c]}}else if("luckysheet-chart-rangeShow-coltitle"==r){let e=s.rangeArray[0].row[0]+s.rangeSplitArray.coltitle.row[0],t=s.rangeArray[0].row[0]+s.rangeSplitArray.coltitle.row[1],l=s.rangeArray[0].column[0]+s.rangeSplitArray.coltitle.column[0],c=s.rangeArray[0].column[0]+s.rangeSplitArray.coltitle.column[1];q.chart_selection.rangeResizeIndex={row:[e,t],column:[l,c]}}let a=ve(e.pageX,e.pageY),n=a[0]+$("#luckysheet-cell-main").scrollLeft(),i=a[1]+$("#luckysheet-cell-main").scrollTop();"lt"==q.chart_selection.rangeResize?(n+=3,i+=3):"lb"==q.chart_selection.rangeResize?(n+=3,i-=3):"rt"==q.chart_selection.rangeResize?(n-=3,i+=3):"rb"==q.chart_selection.rangeResize&&(n-=3,i-=3);let u=pe(i)[2],h=we(n)[2];q.chart_selection.rangeResizexy=[u,h],e.stopPropagation()}),$("#luckysheet-wa-calculate-size").mousedown(function(e){let t=e.pageY;L.functionResizeData.y=t,L.functionResizeStatus=!0,L.functionResizeData.calculatebarHeight=q.calculatebarHeight,null!=L.rangetosheet&&L.updatecell(q.luckysheetCellUpdate[0],q.luckysheetCellUpdate[1])}),i.initialMenuButton();document.getElementById("testdpidiv").offsetWidth,q.devicePixelRatio,document.getElementById("testdpidiv").offsetHeight,q.devicePixelRatio;$(document).on("paste.luckysheetEvent",function(e){if(!Ce())if(p.isPasteAction){$("#luckysheet-rich-text-editor").blur(),p.isPasteAction=!1;let l=window.clipboardData;l||(l=e.originalEvent.clipboardData);let c=l.getData("text/html")||l.getData("text/plain"),o=!0;if(c.indexOf("luckysheet_copy_action_table")>-1&&null!=q.luckysheet_copy_save.copyRange&&q.luckysheet_copy_save.copyRange.length>0){let e=[],t=new RegExp("<tr.*?>(.*?)</tr>","g"),l=new RegExp("<td.*?>(.*?)</td>","g"),s=c.match(t);for(let t=0;t<s.length;t++){let c=[],o=s[t].match(l);if(null!=o)for(let e=0;e<o.length;e++){let t=o[e].replace(/<td.*?>/g,"").replace(/<\/td>/g,"");c.push(t)}e.push(c)}let r,a=q.luckysheet_copy_save.copyRange[0].row[0],n=q.luckysheet_copy_save.copyRange[0].row[1],i=q.luckysheet_copy_save.copyRange[0].column[0],u=q.luckysheet_copy_save.copyRange[0].column[1],h=q.luckysheet_copy_save.dataSheetIndex;r=h==q.currentSheetIndex?q.deepCopyFlowData(q.flowdata):q.luckysheetfile[ke(h)].data;for(let t=a;t<=n&&!(t-a>e.length-1);t++)for(let l=i;l<=u;l++){let c,s=r[t][l];if((null==s||null==s.mc||null!=s.mc.rs)&&(null==(c=null!=s?null!=s.ct&&s.ct.fa.indexOf("w")>-1?r[t][l].v:r[t][l].m:"")&&(c=""),e[t-a][l-i]!=c)){o=!1;break}}}const s=E().fontjson;if(!t.createHookFunction("rangePasteBefore",q.luckysheet_select_save,c))return;if(c.indexOf("luckysheet_copy_action_table")>-1&&null!=q.luckysheet_copy_save.copyRange&&q.luckysheet_copy_save.copyRange.length>0&&o)q.luckysheet_paste_iscut?(q.luckysheet_paste_iscut=!1,p.pasteHandlerOfCutPaste(q.luckysheet_copy_save),p.clearcopy(e)):p.pasteHandlerOfCopyPaste(q.luckysheet_copy_save);else if(c.indexOf("luckysheet_copy_action_image")>-1)r.pasteImgItem();else if(c.indexOf("table")>-1){$("#luckysheet-copy-content").html(c);let e=new Array($("#luckysheet-copy-content").find("table tr").length),t=0;$("#luckysheet-copy-content").find("table tr").eq(0).find("td").each(function(){let e=parseInt($(this).attr("colspan"));isNaN(e)&&(e=1),t+=e});for(let l=0;l<e.length;l++)e[l]=new Array(t);let l=0,o={};$("#luckysheet-copy-content").find("table tr").each(function(){let c=0;$(this).find("td").each(function(){let r=$(this),a={},n=r.text();if(0==$.trim(n).length)a.v=null,a.m="";else{let e=Te(r.text());a.v=e[2],a.ct=e[1],a.m=e[0]}let u=r.css("background-color");"rgba(0, 0, 0, 0)"==u&&(u=null),a.bg=u;let h=r.css("font-weight");a.bl=400==h||"normal"==h?0:1;let d=r.css("font-style");a.it="normal"==d?0:1;let m=r.css("font-family").split(",");for(let e=0;e<m.length;e++){let t=$.trim(m[e].toLowerCase());if(null!=(t=s[t])){a.ff=t;break}a.ff=0}let y=Math.floor(72*parseInt(r.css("font-size"))/96)+1;a.fs=y;let f=r.css("color");a.fc=f;let g=r.css("text-align");a.ht="center"==g?0:"right"==g?2:1;let k=r.css("vertical-align");for(a.vt="middle"==k?0:"top"==k||"text-top"==k?1:2;c<t&&null!=e[l][c];)c++;if(c==t)return!0;if(null==e[l][c]){e[l][c]=a;let t=parseInt(r.attr("rowspan")),s=parseInt(r.attr("colspan"));isNaN(t)&&(t=1),isNaN(s)&&(s=1);let n=q.luckysheet_select_save[0].row[0]+l,u=q.luckysheet_select_save[0].column[0]+c;for(let a=0;a<t;a++)for(let h=0;h<s;h++){if(0==a){let e=r.css("border-top");if(null!=e&&e.length>0&&"0px"!=e.substr(0,3).toLowerCase()){let e=r.css("border-top-width"),t=r.css("border-top-style"),s=r.css("border-top-color"),n=i.getQKBorder(e,t,s);null==o[l+a+"_"+(c+h)]&&(o[l+a+"_"+(c+h)]={}),o[l+a+"_"+(c+h)].t={style:n[0],color:n[1]}}}if(a==t-1){let e=r.css("border-bottom");if(null!=e&&e.length>0&&"0px"!=e.substr(0,3).toLowerCase()){let e=r.css("border-bottom-width"),t=r.css("border-bottom-style"),s=r.css("border-bottom-color"),n=i.getQKBorder(e,t,s);null==o[l+a+"_"+(c+h)]&&(o[l+a+"_"+(c+h)]={}),o[l+a+"_"+(c+h)].b={style:n[0],color:n[1]}}}if(0==h){let e=r.css("border-left");if(null!=e&&e.length>0&&"0px"!=e.substr(0,3).toLowerCase()){let e=r.css("border-left-width"),t=r.css("border-left-style"),s=r.css("border-left-color"),n=i.getQKBorder(e,t,s);null==o[l+a+"_"+(c+h)]&&(o[l+a+"_"+(c+h)]={}),o[l+a+"_"+(c+h)].l={style:n[0],color:n[1]}}}if(h==s-1){let e=r.css("border-right");if(null!=e&&e.length>0&&"0px"!=e.substr(0,3).toLowerCase()){let e=r.css("border-right-width"),t=r.css("border-right-style"),s=r.css("border-right-color"),n=i.getQKBorder(e,t,s);null==o[l+a+"_"+(c+h)]&&(o[l+a+"_"+(c+h)]={}),o[l+a+"_"+(c+h)].r={style:n[0],color:n[1]}}}0==a&&0==h||(e[l+a][c+h]={mc:{r:n,c:u}})}if(t>1||s>1){let o={rs:t,cs:s,r:n,c:u};e[l][c].mc=o}}return++c==t||void 0}),l++}),q.luckysheet_selection_range=[],p.pasteHandler(e,o),$("#luckysheet-copy-content").empty()}else{if(1==l.files.length&&l.files[0].type.indexOf("image")>-1){let e=new FileReader;return e.readAsDataURL(l.files[0]),void(e.onload=function(e){let t=e.target.result;r.inserImg(t)})}c=l.getData("text/plain"),p.pasteHandler(c)}}else if($(e.target).closest("#luckysheet-rich-text-editor").length>0){e.preventDefault();let t=window.clipboardData;t||(t=e.originalEvent.clipboardData);let l=t.getData("text/plain");document.execCommand("insertText",!1,l)}}),t.enablePage&&$("#luckysheet-bottom-page-next").click(function(){let e=t.pageInfo.queryExps,l=t.pageInfo.reportId,c=t.pageInfo.fields,o=t.pageInfo.mobile,s=t.pageInfo.frezon,r=t.pageInfo.currentPage,a=(t.pageInfo.totalPage,t.pageInfo.pageUrl);B.addDataAjax({queryExps:e,reportId:l,fields:c,mobile:o,frezon:s,pageIndex:r,currentPage:r},q.currentSheetIndex,a,function(){if(t.pageInfo.currentPage++,t.pageInfo.totalPage==t.pageInfo.currentPage){$("#luckysheet-bottom-page-next").hide();let e=ie(k.pageInfoFull,{total:t.total,totalPage:t.pageInfo.totalPage});$("#luckysheet-bottom-page-info").html(e)}else{let e=ie(k.pageInfo,{total:t.total,totalPage:t.pageInfo.totalPage,currentPage:t.pageInfo.currentPage});$("#luckysheet-bottom-page-info").html(e)}})}).mousedown(function(e){e.stopPropagation()}),$("#luckysheet-bottom-bottom-top").click(function(){$("#luckysheet-scrollbar-y").scrollTop(0)}).mousedown(function(e){e.stopPropagation()})}});
//# sourceMappingURL=../sourcemaps/controllers/handler.js.map
