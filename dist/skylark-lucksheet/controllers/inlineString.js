/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../global/getdata","../global/cursorPos","../locale/locale","../store"],function(t,e,n,l){"use strict";const{getFontStyleByCell:s,textTrim:i}=t,{selectTextContent:r,selectTextContentCross:o,selectTextContentCollapse:f}=e,c={"font-weight":1,"font-style":1,"font-family":1,"text-decoration":1,"border-bottom":1,"font-size":1,color:1};function a(t){if(null==t||0==t.length)return{};let e=t.split(";");const l=n(),s=l.fontarray,r=l.fontjson;let o={ff:s[0],fc:"#000000",fs:10,cl:0,un:0,bl:0,it:0};return e.forEach(t=>{t=t.toLowerCase();let e=i(t.substr(0,t.indexOf(":"))),n=i(t.substr(t.indexOf(":")+1));if("font-weight"==e&&(o.bl="bold"==n?1:0),"font-style"==e&&(o.it="italic"==n?1:0),"font-family"==e){let t=r[n];o.ff=null==t?n:t}"font-size"==e&&(o.fs=parseInt(n)),"color"==e&&(o.fc=n),"text-decoration"==e&&(o.cl=1),"border-bottom"==e&&(o.un=1),"lucky-strike"==e&&(o.cl=n),"lucky-underline"==e&&(o.un=n)}),o}const u={bl:"font-weight",it:"font-style",ff:"font-family",fs:"font-size",fc:"color",cl:"text-decoration",un:"border-bottom"};function g(t,e){let n=t.split(";");if(null==e||0==e.length)return t;if(t.indexOf(e)>-1)for(let t=0;t<n.length;t++){let l=n[t];l=l.toLowerCase();let s=i(l.substr(0,l.indexOf(":"))),r=i(l.substr(l.indexOf(":")+1));if(s==e)return r}return""}function d(t,e,n){let l={};if(l[e]=n,"un"==e){let e=g(t,"color");""==e&&(e="#000000");let n=g(t,"font-size");""==n&&(n=11),n=parseInt(n),l._fontSize=n,l._color=e}let r=s(l,void 0,void 0,!1),o=i(r.substr(0,r.indexOf(":"))),f=i(r.substr(r.indexOf(":")+1));return f=f.substr(0,f.length-1),t=function(t,e,n){let l=t.split(";"),s="";if(null==e||0==e.length)return t;if(t.indexOf(e)>-1)for(let t=0;t<l.length;t++){let r=l[t];r=r.toLowerCase();let o=i(r.substr(0,r.indexOf(":"))),f=i(r.substr(r.indexOf(":")+1));o==e?s+=o+":"+n+";":o.length>0&&(s+=o+":"+f+";")}else e.length>0&&(s=t+=e+":"+n+";");return s}(t=function(t,e){let n=t.split(";"),l="",s=e;if(null==e||0==e.length)return t;if(e in u&&(e=u[e]),t.indexOf(e)>-1)for(let t=0;t<n.length;t++){let r=n[t];r=r.toLowerCase();let o=i(r.substr(0,r.indexOf(":"))),f=i(r.substr(r.indexOf(":")+1));o==e||"cl"==s&&"lucky-strike"==o||"un"==s&&"lucky-underline"==o||o.length>0&&(l+=o+":"+f+";")}else l=t;return l}(t,e),o,f)}function p(t,e,n=!0){let l=t.split(";"),s=e.split(";"),r="",o={};for(let t=0;t<l.length;t++){let e=l[t],f=!0;e=e.toLowerCase();let a=i(e.substr(0,e.indexOf(":"))),u=i(e.substr(e.indexOf(":")+1));if(!n||a in c){for(let t=0;t<s.length;t++){let e=s[t];e=e.toLowerCase();let n=i(e.substr(0,e.indexOf(":"))),l=i(e.substr(e.indexOf(":")+1));a!=n||(r+=n+":"+l+";",f=!1)}f&&(r+=a+":"+u+";"),o[a]=1}}for(let t=0;t<s.length;t++){let e=s[t];e=e.toLowerCase();let l=i(e.substr(0,e.indexOf(":"))),f=i(e.substr(e.indexOf(":")+1));(!n||l in c)&&(l in o||(r+=l+":"+f+";"))}return r}return{inlineStyleAffectAttribute:{bl:1,it:1,ff:1,cl:1,un:1,fs:1,fc:1},inlineStyleAffectCssName:c,isInlineStringCell:function(t){return t&&null!=t.ct&&"inlineStr"==t.ct.t&&null!=t.ct.s&&t.ct.s.length>0},isInlineStringCT:function(t){return null!=t&&"inlineStr"==t.t&&null!=t.s&&t.s.length>0},updateInlineStringFormat:function(t,e,n,s){var i,f=window.getSelection();let c,a=(i="None"==f.type?l.inlineStringEditRange:f.getRangeAt(0)).commonAncestorContainer;c="luckysheet-rich-text-editor"==a.id?$(a):$(a).closest("#luckysheet-rich-text-editor");let u=$(a).closest("#luckysheet-functionbox-cell");if(0==c.length&&0==u.length&&null!=l.inlineStringEditRange&&(c="luckysheet-rich-text-editor"==(a=(i=l.inlineStringEditRange).commonAncestorContainer).id?$(a):$(a).closest("#luckysheet-rich-text-editor"),u=$(a).closest("#luckysheet-functionbox-cell")),!0===i.collapsed)return;let g=i.endContainer,h=i.startContainer,y=i.endOffset,x=i.startOffset;if(c.length>0){if(h===g){let t,l=h.parentNode,s=!1,i=l.innerHTML;"<span"!=c.html().substr(0,5)&&(s=!0);let o="",f="",a="",u=0,g=x,b=y,T=i.length;o=i.substring(u,g),f=i.substring(g,b),a=i.substring(b,T);let C="";if(""!=o){let t=l.style.cssText;if(s){let e=$(l).closest("#luckysheet-input-box").get(0);null!=e&&(t=p(e.style.cssText,t))}C+="<span style='"+t+"'>"+o+"</span>"}if(""!=f){let t=d(l.style.cssText,e,n);if(s){let e=$(l).closest("#luckysheet-input-box").get(0);null!=e&&(t=p(e.style.cssText,t))}C+="<span style='"+t+"'>"+f+"</span>"}if(""!=a){let t=l.style.cssText;if(s){let e=$(l).closest("#luckysheet-input-box").get(0);null!=e&&(t=p(e.style.cssText,t))}C+="<span style='"+t+"'>"+a+"</span>"}"SPAN"==h.parentNode.tagName?(t=c.find("span").index(l),$(l).replaceWith(C)):(t=0,$(l).html(C));let O=0;O=u==g?t:t+1,r(c.find("span").get(O))}else if("SPAN"==h.parentNode.tagName&&"SPAN"==g.parentNode.tagName){let t,l,s=h.parentNode,i=g.parentNode;t=c.find("span").index(s),l=c.find("span").index(i);let r=s.innerHTML,f=i.innerHTML,a="",u="",p="",b="",T=0,C=x,O=y,m=f.length;a=r.substring(T,C),u=r.substring(C,r.length),p=f.substring(0,O),b=f.substring(O,m);let S,k,N=c.find("span"),L=(N.slice(t,l+1),"");for(let e=0;e<t;e++){let t=N.get(e),n=t.innerHTML;L+="<span style='"+t.style.cssText+"'>"+n+"</span>"}if(""!=a&&(L+="<span style='"+s.style.cssText+"'>"+a+"</span>"),""!=u&&(L+="<span style='"+d(s.style.cssText,e,n)+"'>"+u+"</span>"),t<l)for(let e=t+1;e<l;e++){let t=N.get(e),n=t.innerHTML;L+="<span style='"+t.style.cssText+"'>"+n+"</span>"}""!=p&&(L+="<span style='"+d(i.style.cssText,e,n)+"'>"+p+"</span>"),""!=b&&(L+="<span style='"+i.style.cssText+"'>"+b+"</span>");for(let t=l+1;t<N.length;t++){let e=N.get(t),n=e.innerHTML;L+="<span style='"+e.style.cssText+"'>"+n+"</span>"}c.html(L),T==C?(S=t,k=l):(S=t+1,k=l+1),N=c.find("span"),o(N.get(S),N.get(k))}}else u.length},enterKeyControll:function(t){var e=window.getSelection();if("None"==e.type)return;var n=e.getRangeAt(0);let l,i=n.commonAncestorContainer;l="luckysheet-rich-text-editor"==i.id?$(i):$(i).closest("#luckysheet-rich-text-editor");let r=$(i).closest("#luckysheet-functionbox-cell"),o=(n.endContainer,n.startContainer),c=(n.endOffset,n.startOffset);if(l.length>0){let e=o.parentNode;"luckysheet-rich-text-editor"==o.id&&(0==(e=$(o).find("span")).length&&(o.innerHTML="<span></span>",e=$(o).find("span")),c=(e=e.get(e.length-1)).innerHTML.length),!1===n.collapsed&&n.deleteContents();let i,r,a=e.innerHTML,u="",g="",d=0,p=c;if(u=a.substring(d,p),g=a.substring(p,a.length),"SPAN"==o.parentNode.tagName){let t=l.find("span");if((i=t.index(e))==t.length-1&&""==g){let n=t[i].innerHTML;r="\n"==n.substr(n.length-1,1)?"<span style='"+e.style.cssText+"'>"+u+"\n</span>":"<span style='"+e.style.cssText+"'>"+u+"\n\n</span>"}else r="<span style='"+e.style.cssText+"'>"+u+"\n"+g+"</span>";$(e).replaceWith(r)}else{let n=s(t);if(r=""==g?"<span style='"+n+"'>"+u+"\n\n</span>":"<span style='"+n+"'>"+u+"\n"+g+"</span>","luckysheet-rich-text-editor"==o.id){$(e).replaceWith(r);let t=l.find("span");i=t.length-1,c=t.get(i).innerHTML.length-1}else $(e).html(r),i=0}f(l.find("span").get(i),c+1)}else r.length},updateInlineStringFormatOutside:function(t,e,n){if(null==t.ct)return;let l=t.ct.s;if(null!=l)for(let t=0;t<l.length;t++)l[t][e]=n},convertSpanToShareString:function(t){let e,n=[],l=null;for(let s=0;s<t.length;s++){let i=t.get(s),r=a(i.style.cssText),o=JSON.stringify(r),f=i.innerText;f=f.replace(/\n/g,"\r\n"),o==l?e.v+=f:(r.v=f,n.push(r),l=o,e=r)}return n},convertCssToStyleList:a}});
//# sourceMappingURL=../sourcemaps/controllers/inlineString.js.map
