/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../utils/util","../methods/cells","../widgets/cursorPos","../locale/locale","../store"],function(e,t,n,s,l){"use strict";const{textTrim:i}=e,{getFontStyleByCell:r,isInlineStringCell:o,isInlineStringCT:f}=t,{selectTextContent:a,selectTextContentCross:c,selectTextContentCollapse:u}=n,g={"font-weight":1,"font-style":1,"font-family":1,"text-decoration":1,"border-bottom":1,"font-size":1,color:1},{convertCssToStyleList:d,convertSpanToShareString:p}=e;const h={bl:"font-weight",it:"font-style",ff:"font-family",fs:"font-size",fc:"color",cl:"text-decoration",un:"border-bottom"};function y(e,t){let n=e.split(";");if(null==t||0==t.length)return e;if(e.indexOf(t)>-1)for(let e=0;e<n.length;e++){let s=n[e];s=s.toLowerCase();let l=i(s.substr(0,s.indexOf(":"))),r=i(s.substr(s.indexOf(":")+1));if(l==t)return r}return""}function x(e,t,n){let s={};if(s[t]=n,"un"==t){let t=y(e,"color");""==t&&(t="#000000");let n=y(e,"font-size");""==n&&(n=11),n=parseInt(n),s._fontSize=n,s._color=t}let l=r(s,void 0,void 0,!1),o=i(l.substr(0,l.indexOf(":"))),f=i(l.substr(l.indexOf(":")+1));return f=f.substr(0,f.length-1),e=function(e,t,n){let s=e.split(";"),l="";if(null==t||0==t.length)return e;if(e.indexOf(t)>-1)for(let e=0;e<s.length;e++){let r=s[e];r=r.toLowerCase();let o=i(r.substr(0,r.indexOf(":"))),f=i(r.substr(r.indexOf(":")+1));o==t?l+=o+":"+n+";":o.length>0&&(l+=o+":"+f+";")}else t.length>0&&(l=e+=t+":"+n+";");return l}(e=function(e,t){let n=e.split(";"),s="",l=t;if(null==t||0==t.length)return e;if(t in h&&(t=h[t]),e.indexOf(t)>-1)for(let e=0;e<n.length;e++){let r=n[e];r=r.toLowerCase();let o=i(r.substr(0,r.indexOf(":"))),f=i(r.substr(r.indexOf(":")+1));o==t||"cl"==l&&"lucky-strike"==o||"un"==l&&"lucky-underline"==o||o.length>0&&(s+=o+":"+f+";")}else s=e;return s}(e,t),o,f)}function b(e,t,n=!0){let s=e.split(";"),l=t.split(";"),r="",o={};for(let e=0;e<s.length;e++){let t=s[e],f=!0;t=t.toLowerCase();let a=i(t.substr(0,t.indexOf(":"))),c=i(t.substr(t.indexOf(":")+1));if(!n||a in g){for(let e=0;e<l.length;e++){let t=l[e];t=t.toLowerCase();let n=i(t.substr(0,t.indexOf(":"))),s=i(t.substr(t.indexOf(":")+1));a!=n||(r+=n+":"+s+";",f=!1)}f&&(r+=a+":"+c+";"),o[a]=1}}for(let e=0;e<l.length;e++){let t=l[e];t=t.toLowerCase();let s=i(t.substr(0,t.indexOf(":"))),f=i(t.substr(t.indexOf(":")+1));(!n||s in g)&&(s in o||(r+=s+":"+f+";"))}return r}return{inlineStyleAffectAttribute:{bl:1,it:1,ff:1,cl:1,un:1,fs:1,fc:1},inlineStyleAffectCssName:g,isInlineStringCell:o,isInlineStringCT:f,updateInlineStringFormat:function(e,t,n,s){var i,r=window.getSelection();let o,f=(i="None"==r.type?l.inlineStringEditRange:r.getRangeAt(0)).commonAncestorContainer;o="luckysheet-rich-text-editor"==f.id?$(f):$(f).closest("#luckysheet-rich-text-editor");let u=$(f).closest("#luckysheet-functionbox-cell");if(0==o.length&&0==u.length&&null!=l.inlineStringEditRange&&(o="luckysheet-rich-text-editor"==(f=(i=l.inlineStringEditRange).commonAncestorContainer).id?$(f):$(f).closest("#luckysheet-rich-text-editor"),u=$(f).closest("#luckysheet-functionbox-cell")),!0===i.collapsed)return;let g=i.endContainer,d=i.startContainer,p=i.endOffset,h=i.startOffset;if(o.length>0){if(d===g){let e,s=d.parentNode,l=!1,i=s.innerHTML;"<span"!=o.html().substr(0,5)&&(l=!0);let r="",f="",c="",u=0,g=h,y=p,T=i.length;r=i.substring(u,g),f=i.substring(g,y),c=i.substring(y,T);let C="";if(""!=r){let e=s.style.cssText;if(l){let t=$(s).closest("#luckysheet-input-box").get(0);null!=t&&(e=b(t.style.cssText,e))}C+="<span style='"+e+"'>"+r+"</span>"}if(""!=f){let e=x(s.style.cssText,t,n);if(l){let t=$(s).closest("#luckysheet-input-box").get(0);null!=t&&(e=b(t.style.cssText,e))}C+="<span style='"+e+"'>"+f+"</span>"}if(""!=c){let e=s.style.cssText;if(l){let t=$(s).closest("#luckysheet-input-box").get(0);null!=t&&(e=b(t.style.cssText,e))}C+="<span style='"+e+"'>"+c+"</span>"}"SPAN"==d.parentNode.tagName?(e=o.find("span").index(s),$(s).replaceWith(C)):(e=0,$(s).html(C));let S=0;S=u==g?e:e+1,a(o.find("span").get(S))}else if("SPAN"==d.parentNode.tagName&&"SPAN"==g.parentNode.tagName){let e,s,l=d.parentNode,i=g.parentNode;e=o.find("span").index(l),s=o.find("span").index(i);let r=l.innerHTML,f=i.innerHTML,a="",u="",y="",b="",T=0,C=h,S=p,m=f.length;a=r.substring(T,C),u=r.substring(C,r.length),y=f.substring(0,S),b=f.substring(S,m);let O,L,N=o.find("span"),$=(N.slice(e,s+1),"");for(let t=0;t<e;t++){let e=N.get(t),n=e.innerHTML;$+="<span style='"+e.style.cssText+"'>"+n+"</span>"}if(""!=a&&($+="<span style='"+l.style.cssText+"'>"+a+"</span>"),""!=u&&($+="<span style='"+x(l.style.cssText,t,n)+"'>"+u+"</span>"),e<s)for(let t=e+1;t<s;t++){let e=N.get(t),n=e.innerHTML;$+="<span style='"+e.style.cssText+"'>"+n+"</span>"}""!=y&&($+="<span style='"+x(i.style.cssText,t,n)+"'>"+y+"</span>"),""!=b&&($+="<span style='"+i.style.cssText+"'>"+b+"</span>");for(let e=s+1;e<N.length;e++){let t=N.get(e),n=t.innerHTML;$+="<span style='"+t.style.cssText+"'>"+n+"</span>"}o.html($),T==C?(O=e,L=s):(O=e+1,L=s+1),N=o.find("span"),c(N.get(O),N.get(L))}}else u.length},enterKeyControll:function(e){var t=window.getSelection();if("None"==t.type)return;var n=t.getRangeAt(0);let s,l=n.commonAncestorContainer;s="luckysheet-rich-text-editor"==l.id?$(l):$(l).closest("#luckysheet-rich-text-editor");let i=$(l).closest("#luckysheet-functionbox-cell"),o=(n.endContainer,n.startContainer),f=(n.endOffset,n.startOffset);if(s.length>0){let t=o.parentNode;"luckysheet-rich-text-editor"==o.id&&(0==(t=$(o).find("span")).length&&(o.innerHTML="<span></span>",t=$(o).find("span")),f=(t=t.get(t.length-1)).innerHTML.length),!1===n.collapsed&&n.deleteContents();let l,i,a=t.innerHTML,c="",g="",d=0,p=f;if(c=a.substring(d,p),g=a.substring(p,a.length),"SPAN"==o.parentNode.tagName){let e=s.find("span");if((l=e.index(t))==e.length-1&&""==g){let n=e[l].innerHTML;i="\n"==n.substr(n.length-1,1)?"<span style='"+t.style.cssText+"'>"+c+"\n</span>":"<span style='"+t.style.cssText+"'>"+c+"\n\n</span>"}else i="<span style='"+t.style.cssText+"'>"+c+"\n"+g+"</span>";$(t).replaceWith(i)}else{let n=r(e);if(i=""==g?"<span style='"+n+"'>"+c+"\n\n</span>":"<span style='"+n+"'>"+c+"\n"+g+"</span>","luckysheet-rich-text-editor"==o.id){$(t).replaceWith(i);let e=s.find("span");l=e.length-1,f=e.get(l).innerHTML.length-1}else $(t).html(i),l=0}u(s.find("span").get(l),f+1)}else i.length},updateInlineStringFormatOutside:function(e,t,n){if(null==e.ct)return;let s=e.ct.s;if(null!=s)for(let e=0;e<s.length;e++)s[e][t]=n},convertSpanToShareString:p,convertCssToStyleList:d}});
//# sourceMappingURL=../sourcemaps/controllers/inlineString.js.map
