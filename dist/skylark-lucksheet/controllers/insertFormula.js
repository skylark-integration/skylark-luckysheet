/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../function/func","../global/formula","../global/validate","./constant","./select","../utils/util","../store","../locale/locale"],function(e,t,a,l,o,n,s,i){"use strict";const{luckysheet_getcelldata:r}=e,{isRealNum:c,isRealNull:u}=a,{modelHTML:m}=l,{luckysheet_count_show:p}=o,{replaceHtml:f,getObjType:h}=n;return{init:function(){let e=this,a=i(),l=a.formulaMore,o=a.button;$(document).off("keyup.fxSFLI").on("keyup.fxSFLI","#searchFormulaListInput",function(){$("#formulaTypeList").empty();let t=$(this).val().toUpperCase(),a=s.functionlist;if(""==t)e.formulaListByType($("#formulaTypeSelect option:selected").val());else for(let e=0;e<a.length;e++)/^[a-zA-Z]+$/.test(t)?"-1"!=a[e].n.indexOf(t)&&$('<div class="listBox" name="'+a[e].n+'"><span>'+a[e].n+"</span><span>"+a[e].a+"</span></div>").appendTo($("#formulaTypeList")):"-1"!=a[e].a.indexOf(t)&&$('<div class="listBox" name="'+a[e].n+'"><span>'+a[e].n+"</span><span>"+a[e].a+"</span></div>").appendTo($("#formulaTypeList"));$("#formulaTypeList .listBox:first-child").addClass("on")}),$(document).off("change.fxFormulaTS").on("change.fxFormulaTS","#formulaTypeSelect",function(){let t=$("#formulaTypeSelect option:selected").val();e.formulaListByType(t)}),$(document).off("click.fxListbox").on("click.fxListbox","#formulaTypeList .listBox",function(){$(this).addClass("on").siblings().removeClass("on")}),$(document).off("click.fxFormulaCf").on("click.fxFormulaCf","#luckysheet-search-formula-confirm",function(){let t=$("#luckysheet-search-formula .listBox.on").attr("name"),a='<span dir="auto" class="luckysheet-formula-text-color">=</span><span dir="auto" class="luckysheet-formula-text-color">'+t.toUpperCase()+'</span><span dir="auto" class="luckysheet-formula-text-color">(</span><span dir="auto" class="luckysheet-formula-text-color">)</span>';$("#luckysheet-rich-text-editor").html(a),$("#luckysheet-functionbox-cell").html($("#luckysheet-rich-text-editor").html()),e.formulaParmDialog(t)}),$(document).off("focus.fxParamInput").on("focus.fxParamInput","#luckysheet-search-formula-parm .parmBox input",function(){let a=$(this).parents(".parmBox").index();t.data_parm_index=a;let o,n,i=$(this).parents("#luckysheet-search-formula-parm").find(".luckysheet-modal-dialog-title-text").text(),r=s.luckysheet_function[i].p.length;a>=r?(o=s.luckysheet_function[i].p[r-1].detail,n=s.luckysheet_function[i].p[r-1].repeat):(o=s.luckysheet_function[i].p[a].detail,n=s.luckysheet_function[i].p[a].repeat),e.parmTxtShow($(this).val()),e.functionStrCompute(),$("#luckysheet-search-formula-parm .parmDetailsBox").empty();let c=$(this).parents(".parmBox").find(".name").text();if($("<span>"+c+":</span><span>"+o+"</span>").appendTo($("#luckysheet-search-formula-parm .parmDetailsBox")),"y"==n){let e=$("#luckysheet-search-formula-parm .parmBox").length;e<5&&a==e-1&&$('<div class="parmBox"><div class="name">'+l.valueTitle+(e+1)+'</div><div class="txt"><input class="formulaInputFocus" /><i class="fa fa-table" aria-hidden="true" title="'+l.tipSelectDataRange+'"></i></div><div class="val">=</div></div>').appendTo($("#luckysheet-search-formula-parm .parmListBox"))}}),$(document).off("blur.fxParamInput").on("blur.fxParamInput","#luckysheet-search-formula-parm .parmBox input",function(){let a=$(this).val();null!=t.getfunctionParam(a).fn||t.iscelldata(a)||!c(a)&&""!=a&&a.length<=2&&0!=a.indexOf('"')&&0!=a.lastIndexOf('"')&&(a='"'+a+'"',$(this).val(a),e.parmTxtShow(a),e.functionStrCompute())}),$(document).off("keyup.fxParamInput").on("keyup.fxParamInput","#luckysheet-search-formula-parm .parmBox input",function(){e.parmTxtShow($(this).val()),e.functionStrCompute()}),$(document).off("click.fxParamI").on("click.fxParamI","#luckysheet-search-formula-parm .parmBox i",function(){t.data_parm_index=$(this).parents(".parmBox").index(),$("#luckysheet-search-formula-parm").hide(),$("#luckysheet-modal-dialog-mask").hide(),$("#luckysheet-search-formula-parm-select").remove(),""==$(this).parents(".parmBox").find(".txt input").val()?$("body").append(f(m,{id:"luckysheet-search-formula-parm-select",addclass:"luckysheet-search-formula-parm-select",title:l.tipSelectDataRange,content:"<input id='luckysheet-search-formula-parm-select-input' class='luckysheet-datavisual-range-container' style='font-size: 14px;padding:5px;max-width:none;' spellcheck='false' aria-label='"+l.tipDataRangeTile+"' readonly='true' placeholder='"+l.tipDataRangeTile+"'>",botton:'<button id="luckysheet-search-formula-parm-select-confirm" class="btn btn-primary">'+o.confirm+"</button>",style:"z-index:100003"})):$("body").append(f(m,{id:"luckysheet-search-formula-parm-select",addclass:"luckysheet-search-formula-parm-select",title:l.tipSelectDataRange,content:"<input id='luckysheet-search-formula-parm-select-input' class='luckysheet-datavisual-range-container' style='font-size: 14px;padding:5px;max-width:none;' spellcheck='false' aria-label='"+l.tipDataRangeTile+"' readonly='true' value='"+$(this).parents(".parmBox").find(".txt input").val()+"'>",botton:'<button id="luckysheet-search-formula-parm-select-confirm" class="btn btn-primary">'+o.confirm+"</button>",style:"z-index:100003"}));let a=$("#luckysheet-search-formula-parm-select").find(".luckysheet-modal-dialog-content").css("min-width",300).end(),n=a.outerHeight(),s=a.outerWidth(),i=$(window).width(),r=$(window).height(),c=$(document).scrollLeft(),u=$(document).scrollTop();$("#luckysheet-search-formula-parm-select").css({left:(i+c-s)/2,top:(r+u-n)/3}).show(),e.parmTxtShow($(this).parents(".parmBox").find(".txt input").val())}),$(document).off("click.fxParamCf").on("click.fxParamCf","#luckysheet-search-formula-parm-confirm",function(){$("#luckysheet-wa-functionbox-confirm").click()}),$(document).off("click.fxParamSelectCf").on("click.fxParamSelectCf","#luckysheet-search-formula-parm-select-confirm",function(){let e=$("#luckysheet-search-formula-parm-select-input").attr("data_parm_index");$("#luckysheet-search-formula-parm-select").hide(),$("#luckysheet-search-formula-parm").show(),$("#luckysheet-search-formula-parm .parmBox").eq(e).find(".txt input").focus()})},formulaListDialog:function(){let e=i(),t=e.formulaMore,a=e.button;$("#luckysheet-modal-dialog-mask").show(),$("#luckysheet-search-formula").remove(),$("body").append(f(m,{id:"luckysheet-search-formula",addclass:"luckysheet-search-formula",title:"",content:"<div class='inpbox'><label for='searchFormulaListInput'>"+t.findFunctionTitle+"：</label><input class='formulaInputFocus' id='searchFormulaListInput' placeholder='"+t.tipInputFunctionName+"' spellcheck='false'/></div><div class='selbox'><label>"+t.selectCategory+"：</label><select id='formulaTypeSelect'><option value='0'>"+t.Math+"</option><option value='1'>"+t.Statistical+"</option><option value='2'>"+t.Lookup+"</option><option value='3'>"+t.luckysheet+"</option><option value='4'>"+t.dataMining+"</option><option value='5'>"+t.Database+"</option><option value='6'>"+t.Date+"</option><option value='7'>"+t.Filter+"</option><option value='8'>"+t.Financial+"</option><option value='9'>"+t.Engineering+"</option><option value='10'>"+t.Logical+"</option><option value='11'>"+t.Operator+"</option><option value='12'>"+t.Text+"</option><option value='13'>"+t.Parser+"</option><option value='14'>"+t.Array+"</option><option value='-1'>"+t.other+"</option></select></div><div class='listbox'><label>"+t.selectFunctionTitle+"：</label><div id='formulaTypeList'></div></div>",botton:'<button id="luckysheet-search-formula-confirm" class="btn btn-primary">'+a.confirm+'</button><button class="btn btn-default luckysheet-model-close-btn">'+a.cancel+"</button>",style:"z-index:100003"}));let l=$("#luckysheet-search-formula").find(".luckysheet-modal-dialog-content").css("min-width",300).end(),o=l.outerHeight(),n=l.outerWidth(),s=$(window).width(),r=$(window).height(),c=$(document).scrollLeft(),u=$(document).scrollTop();$("#luckysheet-search-formula").css({left:(s+c-n)/2,top:(r+u-o)/3,"user-select":"none"}).show(),this.formulaListByType("0"),$("#searchFormulaListInput").focus()},formulaListByType:function(e){$("#formulaTypeList").empty();let t=s.functionlist;for(let a=0;a<t.length;a++)("-1"==e&&t[a].t>14||t[a].t==e)&&$('<div class="listBox" name="'+t[a].n+'"><span>'+t[a].n+"</span><span>"+t[a].a+"</span></div>").appendTo($("#formulaTypeList"));$("#formulaTypeList .listBox:first-child").addClass("on")},formulaParmDialog:function(e,a){let l="",o="",n="",c=i(),p=c.formulaMore,d=c.button,y=s.functionlist;for(let t=0;t<y.length;t++)if(y[t].n==e.toUpperCase()){l=y[t].n;for(let e=0;e<y[t].p.length;e++)null==a?n+='<div class="parmBox"><div class="name">'+y[t].p[e].name+'</div><div class="txt"><input class="formulaInputFocus" spellcheck="false"/><i class="fa fa-table" aria-hidden="true" title="'+p.tipSelectDataRange+'"></i></div><div class="val">=</div></div>':(null==a[e]&&(a[e]=""),n+='<div class="parmBox"><div class="name">'+y[t].p[e].name+'</div><div class="txt"><input class="formulaInputFocus" value="'+a[e]+'" spellcheck="false"/><i class="fa fa-table" aria-hidden="true" title="'+p.tipSelectDataRange+'"></i></div><div class="val">=</div></div>');o='<div><div class="parmListBox">'+n+'</div><div class="formulaDetails">'+y[t].d+'</div><div class="parmDetailsBox"></div><div class="result">'+p.calculationResult+" = <span></span></div></div>"}$("#luckysheet-search-formula").hide(),$("#luckysheet-modal-dialog-mask").hide(),$("#luckysheet-search-formula-parm").remove(),$("body").append(f(m,{id:"luckysheet-search-formula-parm",addclass:"luckysheet-search-formula-parm",title:l,content:o,botton:'<button id="luckysheet-search-formula-parm-confirm" class="btn btn-primary">'+d.confirm+'</button><button class="btn btn-default luckysheet-model-close-btn">'+d.cancel+"</button>",style:"z-index:100003"}));let x=$("#luckysheet-search-formula-parm").find(".luckysheet-modal-dialog-content").css("min-width",300).end(),k=x.outerHeight(),v=x.outerWidth(),g=$(window).width(),b=$(window).height(),w=$(document).scrollLeft(),B=$(document).scrollTop();$("#luckysheet-search-formula-parm").css({left:(g+w-v)/2,top:(b+B-k)/3}).show(),$("#luckysheet-search-formula-parm .parmBox:eq(0) input").focus(),$("#luckysheet-search-formula-parm .parmBox").each(function(e,a){let l=$(a).find(".txt input").val();if(null==t.getfunctionParam(l).fn)if(t.iscelldata(l)){let t=r(l).data;if("array"==h(t)){let a=[];for(let e=0;e<t.length;e++)for(let l=0;l<t[e].length;l++){let o=t[e][l];null==o||u(o.v)?a.push(null):a.push(o.v)}$("#luckysheet-search-formula-parm .parmBox").eq(e).find(".val").text(" = {"+a.join(",")+"}")}else $("#luckysheet-search-formula-parm .parmBox").eq(e).find(".val").text(" = {"+t.v+"}")}else $("#luckysheet-search-formula-parm .parmBox").eq(e).find(".val").text(" = {"+l+"}");else $("#luckysheet-search-formula-parm .parmBox").eq(e).find(".val").text(" = {"+new Function("return "+$.trim(t.functionParserExe("="+l)))()+"}")}),$("#luckysheet-formula-functionrange .luckysheet-formula-functionrange-highlight").remove(),t.data_parm_index=0,t.rangestart=!0},parmTxtShow:function(e){if(null==t.getfunctionParam(e).fn)if(t.iscelldata(e)){let a=t.getcellrange(e),l=a.row[0],o=a.row[1],n=a.column[0],i=a.column[1],c=s.visibledatarow[o],m=l-1==-1?0:s.visibledatarow[l-1],f=s.visibledatacolumn[i],d=n-1==-1?0:s.visibledatacolumn[n-1];$("#luckysheet-formula-functionrange-select").css({left:d,width:f-d-1,top:m,height:c-m-1}).show(),$("#luckysheet-formula-help-c").hide(),p(d,m,f-d-1,c-m-1,a.row,a.column);let y=r(e).data;if("array"==h(y)){let e=[];for(let t=0;t<y.length;t++)for(let a=0;a<y[t].length;a++){let l=y[t][a];null==l||u(l.v)?e.push(null):e.push(l.v)}$("#luckysheet-search-formula-parm .parmBox").eq(t.data_parm_index).find(".val").text(" = {"+e.join(",")+"}")}else $("#luckysheet-search-formula-parm .parmBox").eq(t.data_parm_index).find(".val").text(" = {"+y.v+"}")}else $("#luckysheet-search-formula-parm .parmBox").eq(t.data_parm_index).find(".val").text(" = {"+e+"}"),$("#luckysheet-formula-functionrange-select").hide();else{let a;for(let l=0;l<t.getfunctionParam(e).param.length;l++)if(t.iscelldata(t.getfunctionParam(e).param[l])){a=t.getfunctionParam(e).param[l];break}let l=t.getcellrange(a),o=l.row[0],n=l.row[1],i=l.column[0],r=l.column[1],c=s.visibledatarow[n],u=o-1==-1?0:s.visibledatarow[o-1],m=s.visibledatacolumn[r],f=i-1==-1?0:s.visibledatacolumn[i-1];$("#luckysheet-formula-functionrange-select").css({left:f,width:m-f-1,top:u,height:c-u-1}).show(),$("#luckysheet-formula-help-c").hide(),p(f,u,m-f-1,c-u-1,l.row,l.column),$("#luckysheet-search-formula-parm .parmBox").eq(t.data_parm_index).find(".val").text(" = {"+new Function("return "+$.trim(t.functionParserExe("="+e)))()+"}")}},functionStrCompute:function(){let e,a=!0,l=[],o=-1,n=$("#luckysheet-search-formula-parm").find(".luckysheet-modal-dialog-title-text").text(),i=s.luckysheet_function[n].p;if($("#luckysheet-search-formula-parm .parmBox").each(function(e,t){let l,n=$(t).find(".txt input").val();l=e<i.length?i[e].require:i[i.length-1].require,""==n&&"m"==l&&(a=!1),""!=n&&(o=e)}),-1==o)e="="+$("#luckysheet-search-formula-parm .luckysheet-modal-dialog-title-text").text()+"()";else if(0==o)e="="+$("#luckysheet-search-formula-parm .luckysheet-modal-dialog-title-text").text()+"("+$("#luckysheet-search-formula-parm .parmBox").eq(0).find(".txt input").val()+")";else{for(let e=0;e<=o;e++)l.push($("#luckysheet-search-formula-parm .parmBox").eq(e).find(".txt input").val());e="="+$("#luckysheet-search-formula-parm .luckysheet-modal-dialog-title-text").text()+"("+l.join(",")+")"}let r=t.functionHTMLGenerate(e);if($("#luckysheet-rich-text-editor").html(r),$("#luckysheet-functionbox-cell").html($("#luckysheet-rich-text-editor").html()),a){let e=$.trim(t.functionParserExe($("#luckysheet-rich-text-editor").text())),a=null;try{a=new Function("return "+e)()}catch(e){a=t.error.n}$("#luckysheet-search-formula-parm .result span").text(a)}}}});
//# sourceMappingURL=../sourcemaps/controllers/insertFormula.js.map
