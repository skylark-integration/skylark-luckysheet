/**
 * skylark-lucksheet - A version of lucksheet.js that ported to running on skylarkjs.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["../utils/util","../methods/get","../methods/set","../widgets/constant","../methods/freezen_methods","../methods/protection_methods","../widgets/dataVerificationCtrl","../widgets/select","../methods/validate","../methods/datecontroll","../methods/getRowlen","../methods/getdata","../methods/setdata","../methods/format","../widgets/tooltip","../methods/location","../widgets/cursorPos","../methods/luckysheetConfigsetting","../methods/formula_methods","../function/func","../store","../locale/locale","../methods/json","../methods/cells"],function(e,t,l,n,a,s,r,c,u,i,o,h,f,g,d,p,m,y,k,x,v,b,_,w){"use strict";const{replaceHtml:S,getObjType:N,chatatABC:q,ABCatNum:I,luckysheetfontformat:F}=e,{getSheetIndex:T,getRangetxt:C,getluckysheetfile:M}=t,{setluckysheetfile:z}=l,{luckyColor:H}=n,{checkProtectionLocked:R,checkProtectionCellHidden:L}=s,{seletedHighlistByindex:j,luckysheet_count_show:A}=c,{isRealNum:O,isRealNull:P,valueIsError:E}=u,V=y.isEditMode,{isdatetime:D,isdatatype:G}=i,{getCellTextSplitArr:B,getCellTextInfo:Z}=o,{getcellvalue:U,getcellFormula:W,getInlineStringNoStyle:X,getOrigincell:Y}=h,{setcellvalue:J}=f,{genarate:K,valueShowEs:Q}=g,{rowLocation:ee,colLocation:te,colLocationByIndex:le,mouseposition:ne}=p,{luckysheetRangeLast:ae,setCaretPosition:se}=m,{convertSpanToShareString:re}=e,{isInlineStringCell:ce}=w,{luckysheet_compareWith:ue,luckysheet_getarraydata:ie,luckysheet_getcelldata:oe,luckysheet_parseData:he,luckysheet_getValue:fe,luckysheet_indirect_check:ge,luckysheet_indirect_check_return:de,luckysheet_offset_check:pe,luckysheet_calcADPMM:me,luckysheet_getSpecialReference:ye}=x;return Object.assign(k,{oldvalue:null,dontupdate:function(){let e=this;v.luckysheetCellUpdate.length=0,$("#luckysheet-functionbox-cell, #luckysheet-rich-text-editor").html(e.oldvalue),e.cancelNormalSelected(),e.rangetosheet!=v.currentSheetIndex&&v.changeSheet(e.rangetosheet)},fucntionboxshow:function(e,t){if(!L(e,t,v.currentSheetIndex))return void $("#luckysheet-functionbox-cell").html("");let l=this,n=v.flowdata,a="";if(null!=n[e]&&null!=n[e][t]){let s=$.extend(!0,{},n[e][t]);a=ce(s)?X(e,t):null!=s.f?l.functionHTMLGenerate(U(e,t,n,"f")):Q(e,t,n)}l.oldvalue=a,$("#luckysheet-functionbox-cell").html(a)},rangeHightlightHTML:'<div id="luckysheet-formula-functionrange-highlight-${id}" rangeindex="${id}"  class="luckysheet-selection-highlight luckysheet-formula-functionrange-highlight"><div data-type="top" class="luckysheet-selection-copy-top luckysheet-copy"></div><div data-type="right" class="luckysheet-selection-copy-right luckysheet-copy"></div><div data-type="bottom" class="luckysheet-selection-copy-bottom luckysheet-copy"></div><div data-type="left" class="luckysheet-selection-copy-left luckysheet-copy"></div><div class="luckysheet-selection-copy-hc"></div><div data-type="lt" class="luckysheet-selection-highlight-topleft luckysheet-highlight"></div><div data-type="rt" class="luckysheet-selection-highlight-topright luckysheet-highlight"></div><div data-type="lb" class="luckysheet-selection-highlight-bottomleft luckysheet-highlight"></div><div data-type="rb" class="luckysheet-selection-highlight-bottomright luckysheet-highlight"></div></div>',createRangeHightlight:function(){let e=this,t=$("#luckysheet-rich-text-editor").find("span.luckysheet-formula-functionrange-cell");$("#luckysheet-formula-functionrange .luckysheet-formula-functionrange-highlight").remove(),t.each(function(){let t=$(this).attr("rangeindex"),l=$(this).text();$("#luckysheet-formula-functionrange").append(S(e.rangeHightlightHTML,{id:t}));let n=e.getcellrange(l),a="luckysheet-formula-functionrange-highlight-"+t;null==n||(n.sheetIndex==v.currentSheetIndex||-1==n.sheetIndex&&e.rangetosheet==v.currentSheetIndex)&&($("#"+a).data("range",n).find(".luckysheet-copy").css({background:H[t]}).end().find(".luckysheet-highlight").css({background:H[t]}).end().find(".luckysheet-selection-copy-hc").css({background:H[t]}),j(a,n.row[0],n.row[1],n.column[0],n.column[1]))}),$("#luckysheet-formula-functionrange .luckysheet-formula-functionrange-highlight").show()},searchHTML:'<div id="luckysheet-formula-search-c" class="luckysheet-formula-search-c"></div>',helpHTML:'<div id="luckysheet-formula-help-c" class="luckysheet-formula-help-c"> <div class="luckysheet-formula-help-close" title="${helpClose}"><i class="fa fa-times" aria-hidden="true"></i></div> <div class="luckysheet-formula-help-collapse" title="${helpCollapse}"><i class="fa fa-angle-up" aria-hidden="true"></i></div> <div class="luckysheet-formula-help-title"><div class="luckysheet-formula-help-title-formula"> <span class="luckysheet-arguments-help-function-name">SUM</span> <span class="luckysheet-arguments-paren">(</span> <span class="luckysheet-arguments-parameter-holder"> <span class="luckysheet-arguments-help-parameter luckysheet-arguments-help-parameter-active" dir="auto">A2:A100</span>, <span class="luckysheet-arguments-help-parameter" dir="auto">101</span> </span> <span class="luckysheet-arguments-paren">)</span> </div></div> <div class="luckysheet-formula-help-content"> <div class="luckysheet-formula-help-content-example"> <div class="luckysheet-arguments-help-section-title">${helpExample}</div> <div class="luckysheet-arguments-help-formula"> <span class="luckysheet-arguments-help-function-name">SUM</span> <span class="luckysheet-arguments-paren">(</span> <span class="luckysheet-arguments-parameter-holder"> <span class="luckysheet-arguments-help-parameter luckysheet-arguments-help-parameter-active" dir="auto">A2:A100</span>, <span class="luckysheet-arguments-help-parameter" dir="auto">101</span> </span> <span class="luckysheet-arguments-paren">)</span> </div> </div> <div class="luckysheet-formula-help-content-detail"> <div class="luckysheet-arguments-help-section"> <div class="luckysheet-arguments-help-section-title luckysheet-arguments-help-parameter-name">${helpAbstract}</div> <span class="luckysheet-arguments-help-parameter-content">${helpAbstract}</span> </div> </div> <div class="luckysheet-formula-help-content-param"> ${param} </div> </div> <div class="luckysheet-formula-help-foot"></div></div>',getrangeseleciton:function(){let e=window.getSelection(),t=$(e.anchorNode),l=e.anchorOffset;if(t.parent().is("span")&&0!=l){let e=$.trim(t.text()),n="";if(0==e.length&&t.parent().prev().length>0){let l=t.parent().prev();return n=(e=$.trim(l.text())).substr(e.length-1,1),l}return n=e.substr(l-1,1),t.parent()}if(t.is("#luckysheet-rich-text-editor")||t.is("#luckysheet-functionbox-cell")){let e=$.trim(t.find("span").last().text());if(0==e.length&&t.find("span").length>1){let l=t.find("span");return e=$.trim(l.eq(l.length-2).text()),l}return t.find("span").last()}if((t.parent().is("#luckysheet-rich-text-editor")||t.parent().is("#luckysheet-functionbox-cell")||0==l)&&(0==l&&(t=t.parent()),t.prev().length>0)){let e=$.trim(t.prev().text());e.substr(e.length-1,1);return t.prev()}return null},searchFunctionPosition:function(e,t,l,n,a){let s=$(window).height(),r=$(window).width(),c=e.outerWidth(),u=e.outerHeight();null==a&&(a=!1);let i=l;i=l+c>r?l-c+t.outerWidth():l;let o=n;n+u>s?o=n-u:(o=n+t.outerHeight(),a||e.html(e.find(".luckysheet-formula-search-item").get().reverse())),o<0&&(o=0),i<0&&(i=0),e.css({top:o,left:i}).show()},searchFunctionCell:null,searchFunction:function(e){let t=v.functionlist,l=this.getrangeseleciton();if(this.searchFunctionCell=l,null==l||null==e)return;let n=e.text(),a=l.text().toUpperCase();if(!/^[a-zA-Z]|[a-zA-Z_]+$/.test(a)||"="!=n.substr(0,1))return;let s={f:[],s:[],t:[]},r=0;for(let e=0;e<t.length;e++){let l=t[e],n=l.n;if(n==a?(s.f.unshift(l),r++):n.substr(0,a.length)==a?(s.s.unshift(l),r++):n.indexOf(a)>-1&&(s.t.unshift(l),r++),r>=10)break}let c=s.t.concat(s.s.concat(s.f));if(c.length<=0)return;let u=this.searchFunctionHTML(c);$("#luckysheet-formula-search-c").html(u).show(),$("#luckysheet-formula-help-c").hide();let i=e.parent(),o=i.offset();this.searchFunctionPosition($("#luckysheet-formula-search-c"),i,o.left,o.top)},searchFunctionEnter:function(e){let t=e.data("func");this.searchFunctionCell.text(t).after('<span dir="auto" class="luckysheet-formula-text-color">(</span>'),this.setCaretPosition(this.searchFunctionCell.next().get(0),0,1),$("#luckysheet-formula-search-c").hide(),this.helpFunctionExe(this.searchFunctionCell.closest("div"),this.searchFunctionCell.next())},searchFunctionHTML:function(e){let t=this;0==$("#luckysheet-formula-search-c").length&&($("body").append(t.searchHTML),$("#luckysheet-formula-search-c").on("mouseover",".luckysheet-formula-search-item",function(){$("#luckysheet-formula-search-c").find(".luckysheet-formula-search-item").removeClass("luckysheet-formula-search-item-active"),$(this).addClass("luckysheet-formula-search-item-active")}).on("mouseout",".luckysheet-formula-search-item",function(){}).on("click",".luckysheet-formula-search-item",function(){null!=t.searchFunctionCell&&t.searchFunctionEnter($(this))}));let l='<div data-func="${n}" class="luckysheet-formula-search-item ${class}"><div class="luckysheet-formula-search-func">${n}</div><div class="luckysheet-formula-search-detail">${a}</div></div>',n="";for(let t=0;t<e.length;t++){let a=e[t];t==e.length-1?n+=S(l,{class:"luckysheet-formula-search-item-active",n:a.n,a:a.a}):n+=S(l,{class:"",n:a.n,a:a.a})}return n},functionlistPosition:{},helpFunction:function(e,t,l){let n=v.functionlist[this.functionlistPosition[$.trim(t).toUpperCase()]];if(null==n)return;let a=b().formulaMore;$("#luckysheet-formula-help-c .luckysheet-arguments-help-function-name").html(n.n),$("#luckysheet-formula-help-c .luckysheet-arguments-help-parameter-content").html(n.d);let s="",r="",c="";for(let e=0;e<n.p.length;e++){let t=n.p[e],l=t.name,u=t.name;"y"==t.repeat&&(l+=", ...",u+='<span class="luckysheet-arguments-help-argument-info">...-'+a.allowRepeatText+"</span>"),"o"==t.require&&(l="["+l+"]",u+='<span class="luckysheet-arguments-help-argument-info">-['+a.allowOptionText+"]</span>"),s+='<span class="luckysheet-arguments-help-parameter" dir="auto">'+l+"</span>, ",r+='<span class="luckysheet-arguments-help-parameter" dir="auto">'+t.example+"</span>, ",c+=S('<div class="luckysheet-arguments-help-section"><div class="luckysheet-arguments-help-section-title">${param}</div><span class="luckysheet-arguments-help-parameter-content">${content}</span></div>',{param:u,content:t.detail})}if(s=s.substr(0,s.length-2),r=r.substr(0,r.length-2),$("#luckysheet-formula-help-c .luckysheet-formula-help-title .luckysheet-arguments-parameter-holder").html(s),$("#luckysheet-formula-help-c .luckysheet-arguments-help-formula .luckysheet-arguments-parameter-holder").html(r),$("#luckysheet-formula-help-c .luckysheet-formula-help-content-param").html(c),null==l)$("#luckysheet-formula-help-c .luckysheet-formula-help-title-formula .luckysheet-arguments-help-function-name").css("font-weight","bold");else{$("#luckysheet-formula-help-c .luckysheet-formula-help-title-formula .luckysheet-arguments-help-function-name").css("font-weight","normal");let e=l>=n.p.length?n.p.length-1:l;$("#luckysheet-formula-help-c .luckysheet-formula-help-title .luckysheet-arguments-parameter-holder .luckysheet-arguments-help-parameter").removeClass("luckysheet-arguments-help-parameter-active"),$("#luckysheet-formula-help-c .luckysheet-formula-help-title .luckysheet-arguments-parameter-holder .luckysheet-arguments-help-parameter").eq(e).addClass("luckysheet-arguments-help-parameter-active"),$("#luckysheet-formula-help-c .luckysheet-arguments-help-formula .luckysheet-arguments-parameter-holder .luckysheet-arguments-help-parameter").removeClass("luckysheet-arguments-help-parameter-active"),$("#luckysheet-formula-help-c .luckysheet-arguments-help-formula .luckysheet-arguments-parameter-holder .luckysheet-arguments-help-parameter").eq(e).addClass("luckysheet-arguments-help-parameter-active"),$("#luckysheet-formula-help-c .luckysheet-formula-help-content-param .luckysheet-arguments-help-section").removeClass("luckysheet-arguments-help-parameter-active"),$("#luckysheet-formula-help-c .luckysheet-formula-help-content-param .luckysheet-arguments-help-section").eq(e).addClass("luckysheet-arguments-help-parameter-active")}let u=e.parent(),i=u.offset();this.searchFunctionPosition($("#luckysheet-formula-help-c"),u,i.left,i.top,!0)},helpFunctionExe:function(e,t){let l=this,n=v.functionlist,a=b().formulaMore;if(0==$("#luckysheet-formula-help-c").length){$("body").after(S(l.helpHTML,{helpClose:a.helpClose,helpCollapse:a.helpCollapse,helpExample:a.helpExample,helpAbstract:a.helpAbstract})),$("#luckysheet-formula-help-c .luckysheet-formula-help-close").click(function(){$("#luckysheet-formula-help-c").hide()}),$("#luckysheet-formula-help-c .luckysheet-formula-help-collapse").click(function(){let e=$("#luckysheet-formula-help-c .luckysheet-formula-help-content");e.slideToggle(100,function(){let e=l.rangeResizeTo.parent(),t=e.offset();l.searchFunctionPosition($("#luckysheet-formula-help-c"),e,t.left,t.top,!0)}),e.is(":hidden")?$(this).html('<i class="fa fa-angle-up" aria-hidden="true"></i>'):$(this).html('<i class="fa fa-angle-down" aria-hidden="true"></i>')});for(let e=0;e<n.length;e++)l.functionlistPosition[n[e].n]=e}if(!t)return;let s=t,r=(e.length,e.find("span")),c=t.index(),u=c;if(null==s)return;let i=null,o=null;if(r.eq(u).is(".luckysheet-formula-text-func"))i=r.eq(u).text();else{let e=null,t=[-1,-1];for(;--u>0;)if((e=r.eq(u)).is(".luckysheet-formula-text-func")||$.trim(e.text()).toUpperCase()in l.functionlistPosition){i=e.text(),o=null;let l=!0;for(let n=u;n<=c;n++)if(o||(o=0),!(n>=t[0]&&n<=t[1])){if((e=r.eq(n)).is(".luckysheet-formula-text-rpar")){t=[u,n],i=null,l=!1;break}e.is(".luckysheet-formula-text-comma")&&o++}if(l)break}}null!=i&&l.helpFunction(e,i,o)},rangeHightlightselected:function(e,t){let l=this,n=l.getrangeseleciton();if($("#luckysheet-formula-search-c, #luckysheet-formula-help-c").hide(),$("#luckysheet-formula-functionrange .luckysheet-formula-functionrange-highlight .luckysheet-selection-copy-hc").css("opacity","0.03"),$("#luckysheet-formula-search-c, #luckysheet-formula-help-c").hide(),l.helpFunctionExe(e,n),0==$(n).closest(".luckysheet-formula-functionrange-cell").length)return void l.searchFunction(e);let a=$(n).closest(".luckysheet-formula-functionrange-cell").attr("rangeindex");$("#"+("luckysheet-formula-functionrange-highlight-"+a)).find(".luckysheet-selection-copy-hc").css({opacity:"0.13"})},updatecell:function(e,t,l,n=!0){let a=this,s=$("#luckysheet-rich-text-editor"),c=s.text(),u=s.html();if(null!=a.rangetosheet&&a.rangetosheet!=v.currentSheetIndex&&v.changeSheet(a.rangetosheet),!R(e,t,v.currentSheetIndex))return;if(null!=v.dataVerification){let l=v.dataVerification[e+"_"+t];if(null!=l&&l.prohibitInput&&!r.validateCellData(c,l)){let e=r.getFailureText(l);return d.info(e,""),void a.cancelNormalSelected()}}let i=v.flowdata[e][t];const o=JSON.stringify(i);let h=ce(i),f="="!=c.slice(0,1)&&"<span"==u.substr(0,5),g=!1;if(!f&&c&&c.length>0){let e=c.replace(/\r\n/g,"_x000D_").replace(/&#13;&#10;/g,"_x000D_").replace(/\r/g,"_x000D_").replace(/\n/g,"_x000D_").split("_x000D_");e.length>1&&(g=!0,f=!0,c=e.join("\r\n"))}if(l||f||!h?f&&("object"!=N(i)&&(i={}),delete i.f,delete i.v,delete i.m,null==i.ct&&(i.ct={},i.ct.fa="General"),i.ct.t="inlineStr",i.ct.s=re(s.find("span")),g&&(i.ct.s=[{v:c}])):(delete i.ct.s,i.ct.t="g",i.ct.fa="General",l=""),l=l||s.text(),!y.createHookFunction("cellUpdateBefore",e,t,l,n))return void a.cancelNormalSelected();if(!f){if(P(l)&&!h){if(null==i||P(i.v)&&null==i.spl&&null==i.f)return void a.cancelNormalSelected()}else if(null!=i&&1!=i.qp){if("object"==N(i)&&(l==i.f||l==i.v||l==i.m))return void a.cancelNormalSelected();if(l==i)return void a.cancelNormalSelected()}"string"==N(l)&&"="==l.slice(0,1)&&l.length>1||"object"!=N(i)||null==i.ct||null==i.ct.fa||"@"==i.ct.fa||P(l)||(delete i.m,null!=i.f&&(delete i.f,delete i.spl))}window.luckysheet_getcelldata_cache=null;let p=!0,m=v.deepCopyFlowData(v.flowdata),k=null;if("object"==N(i)){if(!f)if("string"==N(l)&&"="==l.slice(0,1)&&l.length>1){let n=a.execfunction(l,e,t,void 0,!0);if(p=!1,(i=$.extend(!0,{},m[e][t])).v=n[1],i.f=n[2],4==n.length&&"sparklines"==n[3].type){delete i.m,delete i.v;let e=n[3].data;"array"==N(e)&&"object"!=N(e[0])?i.v=e[0]:i.spl=n[3].data}else 4==n.length&&"dynamicArrayItem"==n[3].type&&(k=n[3].data)}else if("object"==N(l)){let n=l.f;if("string"==N(n)&&"="==n.slice(0,1)&&n.length>1){let l=a.execfunction(n,e,t,void 0,!0);if(p=!1,(i=$.extend(!0,{},m[e][t])).v=l[1],i.f=l[2],4==l.length&&"sparklines"==l[3].type){delete i.m,delete i.v;let e=l[3].data;"array"==N(e)&&"object"!=N(e[0])?i.v=e[0]:i.spl=l[3].data}else 4==l.length&&"dynamicArrayItem"==l[3].type&&(k=l[3].data)}else for(let e in l)i[e]=l[e]}else a.delFunctionGroup(e,t),a.execFunctionGroup(e,t,l),p=!1,(i=$.extend(!0,{},m[e][t])).v=l,delete i.f,delete i.spl,1==i.qp&&"'"!=(""+l).substr(0,1)&&(i.qp=0,null!=i.ct&&(i.ct.fa="General",i.ct.t="n"));l=i}else if("string"==N(l)&&"="==l.slice(0,1)&&l.length>1){let n=a.execfunction(l,e,t,void 0,!0);if(p=!1,l={v:n[1],f:n[2]},4==n.length&&"sparklines"==n[3].type){let e=n[3].data;"array"==N(e)&&"object"!=N(e[0])?l.v=e[0]:l.spl=n[3].data}else 4==n.length&&"dynamicArrayItem"==n[3].type&&(k=n[3].data)}else if("object"==N(l)){let n=l.f;if("string"==N(n)&&"="==n.slice(0,1)&&n.length>1){let s=a.execfunction(n,e,t,void 0,!0);if(p=!1,l.v=s[1],l.f=s[2],4==s.length&&"sparklines"==s[3].type){let e=s[3].data;"array"==N(e)&&"object"!=N(e[0])?l.v=e[0]:l.spl=s[3].data}else 4==s.length&&"dynamicArrayItem"==s[3].type&&(k=s[3].data)}else{let e=i;null==l.v&&(l.v=e)}}else a.delFunctionGroup(e,t),a.execFunctionGroup(e,t,l),p=!1;J(e,t,m,l),a.cancelNormalSelected();let x=!1,b=$.extend(!0,{},M()[T(v.currentSheetIndex)].config);if(null==b.rowlen&&(b.rowlen={}),"2"==m[e][t].tb&&null!=m[e][t].v||ce(m[e][t])){let l=v.defaultrowlen,n=$("#luckysheetTableContent").get(0).getContext("2d");if(b.customHeight&&1==b.customHeight[e]);else{let a=le(t)[1]-le(t)[0]-2,s=Z(m[e][t],n,{r:e,c:t,cellWidth:a}),r=l;null!=s&&(r=s.textHeightAll+2),r>l&&(b.rowlen[e]=r,x=!0)}}let _=null;k&&(_=$.extend(!0,[],this.insertUpdateDynamicArray(k)));let w={dynamicArray:_};if(x&&(w={cfg:b,dynamicArray:_,RowlChange:x}),setTimeout(()=>{y.createHookFunction("cellUpdated",e,t,JSON.parse(o),v.flowdata[e][t],n)},0),!n)return{data:m,allParam:w};v.refreshRange(m,[{row:[e,e],column:[t,t]}],w,p),a.execFunctionGlobalData=null},cancelNormalSelected:function(){this.canceFunctionrangeSelected(),$("#luckysheet-formula-functionrange .luckysheet-formula-functionrange-highlight").remove(),$("#luckysheet-input-box").removeAttr("style"),$("#luckysheet-input-box-index").hide(),$("#luckysheet-wa-functionbox-cancel, #luckysheet-wa-functionbox-confirm").removeClass("luckysheet-wa-calculate-active"),this.rangestart=!1,this.rangedrag_column_start=!1,this.rangedrag_row_start=!1},canceFunctionrangeSelected:function(){$("#luckysheet-formula-functionrange-select").hide(),$("#luckysheet-row-count-show, #luckysheet-column-count-show").hide(),$("#luckysheet-formula-search-c, #luckysheet-formula-help-c").hide()},operator:"==|!=|<>|<=|>=|=|+|-|>|<|/|*|%|&|^",operatorjson:null,functionCopy:function(e,t,l){let n=this;if(null==n.operatorjson){let e=n.operator.split("|"),t={};for(let l=0;l<e.length;l++)t[e[l].toString()]=1;n.operatorjson=t}null==t&&(t="down"),null==l&&(l=1),"="==e.substr(0,1)&&(e=e.substr(1));let a=e.split(""),s=0,r="",c="",u={bracket:0,comma:0,squote:0,dquote:0};for(;s<a.length;){let e=a[s];if("("==e&&0==u.dquote)u.bracket+=1,r.length>0?c+=r+"(":c+="(",r="";else if(")"==e&&0==u.dquote)u.bracket-=1,c+=n.functionCopy(r,t,l)+")",r="";else if('"'==e&&0==u.squote)u.dquote>0?(c+=r+'"',u.dquote-=1,r=""):(u.dquote+=1,r+='"');else if(","==e&&0==u.dquote)c+=n.functionCopy(r,t,l)+",",r="";else if("&"==e&&0==u.dquote)r.length>0?(c+=n.functionCopy(r,t,l)+"&",r=""):c+="&";else if(e in n.operatorjson&&0==u.dquote){let u="";s+1<a.length&&(u=a[s+1]);let i=s-1,o=null;if(i>=0)do{o=a[i--]}while(i>=0&&" "==o);e+u in n.operatorjson?(r.length>0?(c+=n.functionCopy(r,t,l)+e+u,r=""):c+=e+u,s++):!/[^0-9]/.test(u)&&"-"==e&&("("==o||null==o||","==o||" "==o||o in n.operatorjson)?r+=e:r.length>0?(c+=n.functionCopy(r,t,l)+e,r=""):c+=e}else r+=e;s==a.length-1&&(n.iscelldata($.trim(r))?"down"==t?c+=n.downparam($.trim(r),l):"up"==t?c+=n.upparam($.trim(r),l):"left"==t?c+=n.leftparam($.trim(r),l):"right"==t&&(c+=n.rightparam($.trim(r),l)):c+=$.trim(r)),s++}return c},isfreezonFuc:function(e){let t=e.replace(/[^0-9]/g,""),l=e.replace(/[^A-Za-z]/g,""),n=e.substr(e.indexOf(t)-1,1),a=e.substr(e.indexOf(l)-1,1),s=[!1,!1];return"$"==n&&(s[0]=!0),"$"==a&&(s[1]=!0),s},setfreezonFuceExe:function(e){let t=parseInt(e.replace(/[^0-9]/g,"")),l=I(e.replace(/[^A-Za-z]/g,""));return isNaN(t)||isNaN(l)?isNaN(t)?isNaN(l)?e:"$"+q(l):"$"+t:"$"+q(l)+"$"+t},setfreezonFuc:function(e){let t=this,l=t.getrangeseleciton();if(!t.iscelldata(l.text()))return;let n,a=l.text(),s=window.getSelection().anchorOffset,r=a.split("!"),c="";r.length>1?(n=r[1],c=r[0]+"!"):n=r[0];let u="",i="",o=n.indexOf(":");if(-1==o)i=(u=c+t.setfreezonFuceExe(n)).length;else if(n=n.split(":"),s>o){let e=c+n[0]+":"+t.setfreezonFuceExe(n[1]);u=e,i=e.length}else{let e=c+t.setfreezonFuceExe(n[0]);u=e+":"+n[1],i=e.length}l.text(c+u),t.setCaretPosition(l.get(0),0,i)},updateparam:function(e,t,l){let n,a=this,s=t.split("!"),r="";if(s.length>1?(n=s[1],r=s[0]+"!"):n=s[0],-1==n.indexOf(":")){let s=parseInt(n.replace(/[^0-9]/g,"")),c=I(n.replace(/[^A-Za-z]/g,"")),u=a.isfreezonFuc(n),i=u[0]?"$":"",o=u[1]?"$":"";return"u"!=e||u[0]?"r"!=e||u[1]?"l"!=e||u[1]?"d"!=e||u[0]||(s+=l):c-=l:c+=l:s-=l,s[0]<0||c[0]<0?a.error.r:isNaN(s)||isNaN(c)?isNaN(s)?isNaN(c)?t:r+o+q(c):r+i+s:r+o+q(c)+i+s}{n=n.split(":");let s=[],c=[];if(s[0]=parseInt(n[0].replace(/[^0-9]/g,"")),s[1]=parseInt(n[1].replace(/[^0-9]/g,"")),s[0]>s[1])return t;if(c[0]=I(n[0].replace(/[^A-Za-z]/g,"")),c[1]=I(n[1].replace(/[^A-Za-z]/g,"")),c[0]>c[1])return t;let u=a.isfreezonFuc(n[0]),i=a.isfreezonFuc(n[1]),o=u[0]?"$":"",h=u[1]?"$":"",f=i[0]?"$":"",g=i[1]?"$":"";return"u"==e?(u[0]||(s[0]-=l),i[0]||(s[1]-=l)):"r"==e?(u[1]||(c[0]+=l),i[1]||(c[1]+=l)):"l"==e?(u[1]||(c[0]-=l),i[1]||(c[1]-=l)):"d"==e&&(u[0]||(s[0]+=l),i[0]||(s[1]+=l)),s[0]<0||c[0]<0?a.error.r:isNaN(c[0])&&isNaN(c[1])?r+o+s[0]+":"+f+s[1]:isNaN(s[0])&&isNaN(s[1])?r+h+q(c[0])+":"+g+q(c[1]):r+h+q(c[0])+o+s[0]+":"+g+q(c[1])+f+s[1]}},downparam:function(e,t){return this.updateparam("d",e,t)},upparam:function(e,t){return this.updateparam("u",e,t)},leftparam:function(e,t){return this.updateparam("l",e,t)},rightparam:function(e,t){return this.updateparam("r",e,t)},functionStrChange:function(e,t,l,n,a,s){let r=this;if(null==r.operatorjson){let e=r.operator.split("|"),t={};for(let l=0;l<e.length;l++)t[e[l].toString()]=1;r.operatorjson=t}"="==e.substr(0,1)&&(e=e.substr(1));let c=e.split(""),u=0,i="",o="",h={bracket:0,comma:0,squote:0,dquote:0};for(;u<c.length;){let e=c[u];if("("==e&&0==h.dquote)h.bracket+=1,i.length>0?o+=i+"(":o+="(",i="";else if(")"==e&&0==h.dquote)h.bracket-=1,o+=r.functionStrChange(i,t,l,n,a,s)+")",i="";else if('"'==e&&0==h.squote)h.dquote>0?(o+=i+'"',h.dquote-=1,i=""):(h.dquote+=1,i+='"');else if(","==e&&0==h.dquote)o+=r.functionStrChange(i,t,l,n,a,s)+",",i="";else if("&"==e&&0==h.dquote)i.length>0?(o+=r.functionStrChange(i,t,l,n,a,s)+"&",i=""):o+="&";else if(e in r.operatorjson&&0==h.dquote){let h="";u+1<c.length&&(h=c[u+1]);let f=u-1,g=null;if(f>=0)do{g=c[f--]}while(f>=0&&" "==g);e+h in r.operatorjson?(i.length>0?(o+=r.functionStrChange(i,t,l,n,a,s)+e+h,i=""):o+=e+h,u++):!/[^0-9]/.test(h)&&"-"==e&&("("==g||null==g||","==g||" "==g||g in r.operatorjson)?i+=e:i.length>0?(o+=r.functionStrChange(i,t,l,n,a,s)+e,i=""):o+=e}else i+=e;u==c.length-1&&(r.iscelldata($.trim(i))?o+=r.functionStrChange_range($.trim(i),t,l,n,a,s):o+=$.trim(i)),u++}return o},functionStrChange_range:function(e,t,l,n,a,s){let r,c,u,i,o,h,f,g,d,p=this,m=e.split("!"),y="";if(m.length>1?(r=m[1],y=m[0]+"!"):r=m[0],-1==r.indexOf(":")){c=u=parseInt(r.replace(/[^0-9]/g,""))-1,i=o=I(r.replace(/[^A-Za-z]/g,""));let e=p.isfreezonFuc(r);h=f=e[0]?"$":"",g=d=e[1]?"$":""}else{if(r=r.split(":"),(c=parseInt(r[0].replace(/[^0-9]/g,""))-1)>(u=parseInt(r[1].replace(/[^0-9]/g,""))-1))return e;if((i=I(r[0].replace(/[^A-Za-z]/g,"")))>(o=I(r[1].replace(/[^A-Za-z]/g,""))))return e;let t=p.isfreezonFuc(r[0]);h=t[0]?"$":"",g=t[1]?"$":"";let l=p.isfreezonFuc(r[1]);f=l[0]?"$":"",d=l[1]?"$":""}if("del"==t){if("row"==l){if(c>=a&&u<=a+s-1)return p.error.r;c>a+s-1?c-=s:c>=a&&(c=a),u>a+s-1?u-=s:u>=a&&(u=a-1),c<0&&(c=0),u<c&&(u=c)}else if("col"==l){if(i>=a&&o<=a+s-1)return p.error.r;i>a+s-1?i-=s:i>=a&&(i=a),o>a+s-1?o-=s:o>=a&&(o=a-1),i<0&&(i=0),o<i&&(o=i)}return c==u&&i==o?isNaN(c)||isNaN(i)?isNaN(c)?isNaN(i)?e:y+g+q(i):y+h+(c+1):y+g+q(i)+h+(c+1):isNaN(i)&&isNaN(o)?y+h+(c+1)+":"+f+(u+1):isNaN(c)&&isNaN(u)?y+g+q(i)+":"+d+q(o):y+g+q(i)+h+(c+1)+":"+d+q(o)+f+(u+1)}if("add"==t)return"row"==l?"lefttop"==n?(c>=a&&(c+=s),u>=a&&(u+=s)):"rightbottom"==n&&(c>a&&(c+=s),u>a&&(u+=s)):"col"==l&&("lefttop"==n?(i>=a&&(i+=s),o>=a&&(o+=s)):"rightbottom"==n&&(i>a&&(i+=s),o>a&&(o+=s))),c==u&&i==o?isNaN(c)||isNaN(i)?isNaN(c)?isNaN(i)?e:y+g+q(i):y+h+(c+1):y+g+q(i)+h+(c+1):isNaN(i)&&isNaN(o)?y+h+(c+1)+":"+f+(u+1):isNaN(c)&&isNaN(u)?y+g+q(i)+":"+d+q(o):y+g+q(i)+h+(c+1)+":"+d+q(o)+f+(u+1)},israngeseleciton:function(e){let t=this;if(null==t.operatorjson){let e=t.operator.split("|"),l={};for(let t=0;t<e.length;t++)l[e[t].toString()]=1;t.operatorjson=l}null==e&&(e=!1);let l=window.getSelection(),n=$(l.anchorNode),a=l.anchorOffset;if(n.parent().is("span")&&0!=a){let l=$.trim(n.text()),s="";if(0==l.length&&n.parent().prev().length>0){let e=n.parent().prev();s=(l=$.trim(e.text())).substr(l.length-1,1),t.rangeSetValueTo=e}else s=l.substr(a-1,1),t.rangeSetValueTo=n.parent();if(e&&("("==s||","==s)||!e&&("("==s||","==s||"="==s||s in t.operatorjson||"&"==s))return!0}else if(n.is("#luckysheet-rich-text-editor")||n.is("#luckysheet-functionbox-cell")){let l,a=$.trim(n.find("span").last().text());if(t.rangeSetValueTo=n.find("span").last(),0==a.length&&n.find("span").length>1){let e=n.find("span");a=$.trim(e.eq(e.length-2).text()),t.rangeSetValueTo=e}if(l=a.substr(a.length-1,1),e&&("("==l||","==l)||!e&&("("==l||","==l||"="==l||l in t.operatorjson||"&"==l))return!0}else if((n.parent().is("#luckysheet-rich-text-editor")||n.parent().is("#luckysheet-functionbox-cell")||0==a)&&(0==a&&(n=n.parent()),n.prev().length>0)){let l=$.trim(n.prev().text()),a=l.substr(l.length-1,1);if(t.rangeSetValueTo=n.prev(),e&&("("==a||","==a)||!e&&("("==a||","==a||"="==a||a in t.operatorjson||"&"==a))return!0}return!1},rangechangeindex:null,rangestart:!1,rangetosheet:null,rangeSetValueTo:null,func_selectedrange:{},rangeSetValue:function(e,t){let l,n=this,a="",s=e.row[0],r=e.column[0];if(a=null!=v.config.merge&&s+"_"+r in v.config.merge?C(v.currentSheetIndex,{column:[r,r],row:[s,s]},n.rangetosheet):C(v.currentSheetIndex,e,n.rangetosheet),n.rangestart||n.rangedrag_column_start||n.rangedrag_row_start)if($("#luckysheet-search-formula-parm").is(":visible")||$("#luckysheet-search-formula-parm-select").is(":visible")){l=$("#luckysheet-rich-text-editor"),$("#luckysheet-search-formula-parm-select-input").val(a),$("#luckysheet-search-formula-parm .parmBox").eq(n.data_parm_index).find(".txt input").val(a);let e=oe(a).data;if(e instanceof Array){let t=[];for(let l=0;l<e.length;l++)for(let n=0;n<e[l].length;n++)null==e[l][n]?t.push(null):t.push(e[l][n].v);$("#luckysheet-search-formula-parm .parmBox").eq(n.data_parm_index).find(".val").text(" = {"+t.join(",")+"}")}else $("#luckysheet-search-formula-parm .parmBox").eq(n.data_parm_index).find(".val").text(" = {"+e.v+"}");let t,s=!0,r=[],c=-1;if($("#luckysheet-search-formula-parm .parmBox").each(function(e,t){let l=$(t).find(".txt input").val();""==l&&"m"==$(t).find(".txt input").attr("data_parm_require")&&(s=!1),""!=l&&(c=e)}),-1==c)t="="+$("#luckysheet-search-formula-parm .luckysheet-modal-dialog-title-text").text()+"()";else if(0==c)t="="+$("#luckysheet-search-formula-parm .luckysheet-modal-dialog-title-text").text()+"("+$("#luckysheet-search-formula-parm .parmBox").eq(0).find(".txt input").val()+")";else{for(let e=0;e<=c;e++)r.push($("#luckysheet-search-formula-parm .parmBox").eq(e).find(".txt input").val());t="="+$("#luckysheet-search-formula-parm .luckysheet-modal-dialog-title-text").text()+"("+r.join(",")+")"}let u=n.functionHTMLGenerate(t);if($("#luckysheet-rich-text-editor").html(u),$("#luckysheet-functionbox-cell").html($("#luckysheet-rich-text-editor").html()),s){let e=$.trim(n.functionParserExe($("#luckysheet-rich-text-editor").text())),t=new Function("return "+e)();$("#luckysheet-search-formula-parm .result span").text(t)}}else{let e=window.getSelection().anchorNode,t=(l=$(e).closest("div")).find("span[rangeindex='"+n.rangechangeindex+"']").html(a);n.setCaretPosition(t.get(0),0,a.length)}else{let e='<span class="luckysheet-formula-functionrange-cell" rangeindex="'+n.functionHTMLIndex+'" dir="auto" style="color:'+H[n.functionHTMLIndex]+';">'+a+"</span>";$(e).insertAfter(n.rangeSetValueTo);n.rangechangeindex=n.functionHTMLIndex,l=$(n.rangeSetValueTo).closest("div"),n.setCaretPosition(l.find("span[rangeindex='"+n.rangechangeindex+"']").get(0),0,a.length),n.functionHTMLIndex++}"luckysheet-rich-text-editor"==l.attr("id")?$("#luckysheet-functionbox-cell").html($("#luckysheet-rich-text-editor").html()):$("#luckysheet-rich-text-editor").html($("#luckysheet-functionbox-cell").html())},rangedrag:function(e){let t=this,l=ne(e.pageX,e.pageY),n=l[0]+$("#luckysheet-cell-main").scrollLeft(),s=l[1]+$("#luckysheet-cell-main").scrollTop(),r=ee(s),c=r[1],u=r[0],i=r[2],o=te(n),h=o[1],f=o[0],g=o[2],d=0,p=0,m=[];t.func_selectedrange.top>u?(d=u,p=t.func_selectedrange.top+t.func_selectedrange.height-u,m=[i,t.func_selectedrange.row[1]]):t.func_selectedrange.top==u?(d=u,p=t.func_selectedrange.top+t.func_selectedrange.height-u,m=[i,t.func_selectedrange.row[0]]):(d=t.func_selectedrange.top,p=c-t.func_selectedrange.top-1,m=[t.func_selectedrange.row[0],i]);let y=0,k=0,x=[];t.func_selectedrange.left>f?(y=f,k=t.func_selectedrange.left+t.func_selectedrange.width-f,x=[g,t.func_selectedrange.column[1]]):t.func_selectedrange.left==f?(y=f,k=t.func_selectedrange.left+t.func_selectedrange.width-f,x=[g,t.func_selectedrange.column[0]]):(y=t.func_selectedrange.left,k=h-t.func_selectedrange.left-1,x=[t.func_selectedrange.column[0],g]),m[0]=a.changeFreezenIndex(m[0],"h"),m[1]=a.changeFreezenIndex(m[1],"h"),x[0]=a.changeFreezenIndex(x[0],"v"),x[1]=a.changeFreezenIndex(x[1],"v");let b=w.mergeMoveMain(x,m,t.func_selectedrange,d,p,y,k);if(null!=b&&(x=b[0],m=b[1],d=b[2],p=b[3],y=b[4],k=b[5]),t.func_selectedrange.row=m,t.func_selectedrange.column=x,t.func_selectedrange.left_move=y,t.func_selectedrange.width_move=k,t.func_selectedrange.top_move=d,t.func_selectedrange.height_move=p,A(y,d,k,p,m,x),$("#luckysheet-formula-functionrange-select").css({left:y,width:k,top:d,height:p}).show(),$("#luckysheet-ifFormulaGenerator-multiRange-dialog").is(":visible")){let e=C(v.currentSheetIndex,{row:m,column:x},v.currentSheetIndex);$("#luckysheet-ifFormulaGenerator-multiRange-dialog input").val(e)}else t.rangeSetValue({row:m,column:x});a.scrollFreezen(m,x)},rangedrag_column_start:!1,rangedrag_row_start:!1,rangedrag_column:function(e){let t=this,l=ne(e.pageX,e.pageY),n=l[0]+$("#luckysheet-cell-main").scrollLeft(),s=(l[1],$("#luckysheet-cell-main").scrollTop(),v.visibledatarow),r=s.length-1,c=s[r],u=te(n),i=u[1],o=u[0],h=u[2],f=0,g=0,d=[];t.func_selectedrange.left>o?(f=o,g=t.func_selectedrange.left+t.func_selectedrange.width-o,d=[h,t.func_selectedrange.column[1]]):t.func_selectedrange.left==o?(f=o,g=t.func_selectedrange.left+t.func_selectedrange.width-o,d=[h,t.func_selectedrange.column[0]]):(f=t.func_selectedrange.left,g=i-t.func_selectedrange.left-1,d=[t.func_selectedrange.column[0],h]),d[0]=a.changeFreezenIndex(d[0],"v"),d[1]=a.changeFreezenIndex(d[1],"v");let p=w.mergeMoveMain(d,[0,r],t.func_selectedrange,0,c-0-1,f,g);null!=p&&(d=p[0],f=p[4],g=p[5]),t.func_selectedrange.column=d,t.func_selectedrange.left_move=f,t.func_selectedrange.width_move=g,A(f,0,g,c-0-1,[0,r],d),t.rangeSetValue({row:[null,null],column:d}),$("#luckysheet-formula-functionrange-select").css({left:f,width:g,top:0,height:c-0-1}).show(),a.scrollFreezen([0,r],d)},rangedrag_row:function(e){let t=this,l=ne(e.pageX,e.pageY),n=(l[0],$("#luckysheet-cell-main").scrollLeft(),l[1]+$("#luckysheet-cell-main").scrollTop()),s=ee(n),r=s[1],c=s[0],u=s[2],i=v.visibledatacolumn,o=i.length-1,h=i[o],f=0,g=0,d=[];t.func_selectedrange.top>c?(f=c,g=t.func_selectedrange.top+t.func_selectedrange.height-c,d=[u,t.func_selectedrange.row[1]]):t.func_selectedrange.top==c?(f=c,g=t.func_selectedrange.top+t.func_selectedrange.height-c,d=[u,t.func_selectedrange.row[0]]):(f=t.func_selectedrange.top,g=r-t.func_selectedrange.top-1,d=[t.func_selectedrange.row[0],u]),d[0]=a.changeFreezenIndex(d[0],"h"),d[1]=a.changeFreezenIndex(d[1],"h");let p=w.mergeMoveMain([0,o],d,t.func_selectedrange,f,g,0,h-0-1);null!=p&&(d=p[1],f=p[2],g=p[3]),t.func_selectedrange.row=d,t.func_selectedrange.top_move=f,t.func_selectedrange.height_move=g,A(0,f,h-0-1,g,d,[0,o]),t.rangeSetValue({row:d,column:[null,null]}),$("#luckysheet-formula-functionrange-select").css({left:0,width:h-0-1,top:f,height:g}).show(),a.scrollFreezen(d,[0,o])},rangedragged:function(){},rangeResizeObj:null,rangeResize:null,rangeResizeIndex:null,rangeResizexy:null,rangeResizeWinH:null,rangeResizeWinW:null,rangeResizeTo:null,rangeResizeDraging:function(e,t,l,n,a,s,r,c){let u=$("#luckysheet-scrollbar-y").scrollTop(),i=$("#luckysheet-scrollbar-x").scrollLeft(),o=ne(e.pageX,e.pageY),h=o[0]+i,f=o[1]+u,g=ee(f),d=g[1],p=g[0],m=(g[2],te(h)),y=m[1],k=m[0];m[2];if(h<0||f<0)return!1;let x=p-l[1],b=k-l[0],_=l[5],w=l[3],S=l[4],N=l[2];if("lt"==n||"lb"==n){if(l[0]+l[2]<k)return;S=k,N=l[2]-b,S>l[2]+l[4]-y+k?(S=l[2]+l[4]-y+k,N=l[2]-(l[2]+l[4]-y+k-l[0])):S<=0&&(S=0,N=l[2]+l[0])}if("rt"==n||"rb"==n){if(l[6]-l[2]>y)return;(N=l[2]+y-l[6])<y-k-1?N=y-k-1:N>=r-S&&(N=r-S)}if("lt"==n||"rt"==n){if(l[1]+l[3]<p)return;_=p,w=l[3]-x,_>l[3]+l[5]-d+p?(_=l[3]+l[5]-d+p,w=l[3]-(l[3]+l[5]-d+p-l[1])):_<=0&&(_=0,w=l[3]+l[1])}if("lb"==n||"rb"==n){if(l[7]-l[3]>d)return;(w=l[3]+d-l[7])<d-p-1?w=d-p-1:w>=c-_&&(w=c-_)}let q=this.rangeResizeIndex,I={top:_,left:S,height:w,width:N},F=this.getSelectedFromRange(I),T=C(v.currentSheetIndex,F,this.rangetosheet);this.rangeResizeTo.find("span[rangeindex='"+q+"']").html(T);ae(this.rangeResizeTo[0]),t.css(I).data("range",F)},getSelectedFromRange:function(e){let t=e.top+2,l=e.top+e.height-2,n=e.left+2,a=e.left+e.width-2;return{row:[ee(t)[2],ee(l)[2]],column:[te(n)[2],te(a)[2]]}},rangeResizeDragged:function(e,t,l,n,a,s){this.rangeResize=null,$("#luckysheet-formula-functionrange-highlight-"+this.rangeResizeIndex).find(".luckysheet-selection-copy-hc").css("opacity",.03)},rangeMovexy:null,rangeMove:!1,rangeMoveObj:null,rangeMoveIndex:null,rangeMoveRangedata:null,rangeMoveDraging:function(e,t,l,n,a,s){let r=ne(e.pageX,e.pageY),c=$("#luckysheet-scrollbar-x").scrollLeft(),u=$("#luckysheet-scrollbar-y").scrollTop(),i=r[0]+c,o=r[1]+u,h=$(window).height()+u-a-s,f=$(window).width()+c,g=t[0],d=t[1],p=l.row[0]-g+ee(o)[2],m=l.row[1]-g+ee(o)[2],y=l.column[0]-d+te(i)[2],k=l.column[1]-d+te(i)[2];(p<0||o<0)&&(p=0,m=l.row[1]-l.row[0]),(y<0||i<0)&&(y=0,k=l.column[1]-l.column[0]);let x=v.visibledatarow;(m>=x[x.length-1]||o>h)&&(p=x.length-1-l.row[1]+l.row[0],m=x.length-1);let b=v.visibledatacolumn;(k>=b[b.length-1]||i>f)&&(y=b.length-1-l.column[1]+l.column[0],k=b.length-1);let _=y-1==-1?0:b[y-1],w=b[k],S=p-1==-1?0:x[p-1],N=x[m],q=this.rangeMoveIndex,I={left:_,width:w-_-2,top:S,height:N-S-2,display:"block"},F=this.getSelectedFromRange(I),T=C(v.currentSheetIndex,F,this.rangetosheet);this.rangeResizeTo.find("span[rangeindex='"+q+"']").html(T);ae(this.rangeResizeTo[0]),this.rangeMoveRangedata=F,n.css(I)},rangeMoveDragged:function(e){this.rangeMove=!1,$("#luckysheet-formula-functionrange-highlight-"+this.rangeMoveIndex).data("range",this.rangeMoveRangedata).find(".luckysheet-selection-copy-hc").css("opacity",.03)},functionHTMLIndex:0,functionRangeIndex:null,findrangeindex:function(e,t){let l=/<span.*?>/g,n=e.replace(l,""),a=t.replace(l,"");n=n.split("</span>"),a=a.split("</span>"),n.pop(),a.pop();let s=this.functionRangeIndex,r=(a.length>n.length?n.length:a.length,a.length),c=n.length;if(r==c){let e=s[0],t=a[e],l=n[e];if(null==t)return a.length<=e?s=[a.length-1,a.length-1]:n.length<=e&&(s=[n.length-1,n.length-1]),s;if(t.length==l.length)return null!=a[e+1]&&null!=n[e+1]&&a[e+1].length<n[e+1].length&&(s[0]=s[0]+1,s[1]=1),s;if(t.length>l.length)return null!=t&&null!=n[e+1]&&'"'==n[e+1].substr(0,1)&&(t.indexOf("{")>-1||t.indexOf("}")>-1)&&(s[0]=s[0]+1,s[1]=1),s;if(t.length<l.length)return s[1]>l.length&&(s[1]=l.length),s}else{if(r>c){let e=s[0],t=a[e],l=n[e];if(null==l)if(n[e-1].indexOf("{")>-1){s[0]=s[0]-1;let t=n[e-1].search("{");s[1]=s[1]+t}else s[0]=0,s[1]=0;else{if(t.length==l.length)return null==n[e+1]||'"'!=n[e+1].substr(0,1)&&"{"!=n[e+1].substr(0,1)&&"}"!=n[e+1].substr(0,1)?null!=t&&t.length>2&&'"'==t.substr(0,1)&&'"'==t.substr(t.length-1,1)||(null!=n[e]&&'")'==n[e]?s[1]=1:null!=n[e]&&'"}'==n[e]?s[1]=1:null!=n[e]&&"{)"==n[e]?s[1]=1:s[1]=l.length):(s[0]=s[0]+1,s[1]=1),s;if(t.length>l.length)return null==n[e+1]||'"'!=n[e+1].substr(0,1)&&"{"!=n[e+1].substr(0,1)&&"}"!=n[e+1].substr(0,1)||(s[0]=s[0]+1,s[1]=1),s;if(t.length<l.length)return s}return s}if(r<c){let e=s[0],t=a[e],l=n[e];if(null==t)s[0]=n.length-1,s[1]=null!=l?l.length:1;else{if(t.length==l.length)return null==a[e+1]||'"'!=a[e+1].substr(0,1)&&"{"!=a[e+1].substr(0,1)&&"}"!=a[e+1].substr(0,1)?null==n[e+1]||'"'!=n[e+1].substr(0,1)||"{"!=n[e+1].substr(0,1)&&"}"!=n[e+1].substr(0,1)?null!=l&&'"'==l.substr(0,1)&&'"'==l.substr(l.length-1,1)&&'"'==t.substr(0,1)&&")"==t.substr(t.length-1,1)?s[1]=l.length:null!=l&&"{"==l.substr(0,1)&&"}"==l.substr(l.length-1,1)&&"{"==t.substr(0,1)&&")"==t.substr(t.length-1,1)?s[1]=l.length:(s[0]=s[0]+c-r,n.length>a.length?s[1]=n[e+1].length:s[1]=1):(s[0]=s[0]+1,s[1]=1):s[1]=l.length,s;if(t.length>l.length)return null!=t&&'"'==t.substr(0,1)?s[1]=l.length:null!=n[e+1]&&/{.*?}/.test(n[e+1])?(s[0]=s[0]+1,s[1]=n[e+1].length):null!=t&&'"'==n[e+1].substr(0,1)&&(t.indexOf("{")>-1||t.indexOf("}")>-1)?(s[0]=s[0]+1,s[1]=1):null!=t&&(t.indexOf("{")>-1||t.indexOf("}")>-1)||(s[0]=s[0]+c-r-1,s[1]=n[e-1].length),s;if(t.length<l.length)return s}return s}}return null},setCaretPosition:function(e,t,l){return se(e,t,l)},functionRange:function(e,t,l){let n=this;if(window.getSelection){let a=window.getSelection(),s=n.findrangeindex(t,l);null==s?(a.selectAllChildren(e.get(0)),a.collapseToEnd()):n.setCaretPosition(e.find("span").get(s[0]),0,s[1])}else document.selection&&(n.functionRangeIndex.moveToElementText(e),n.functionRangeIndex.collapse(!1),n.functionRangeIndex.select())},functionInputHanddler:function(e,t,l){if(V())return;let n=this,a=e,s=t,r=s.html(),c=s.text();setTimeout(function(){let e=s.text();if(e.length>0&&"="==e.substr(0,1)&&(229!=l||1==e.length)){if(e=n.functionHTMLGenerate(e),r=n.functionHTMLGenerate(c),window.getSelection){let e=window.getSelection();if($(e.anchorNode).is("div")){let e=$("#luckysheet-rich-text-editor span").length;n.functionRangeIndex=[e-1,$("#luckysheet-rich-text-editor").find("span").eq(e-1).text().length]}else n.functionRangeIndex=[$(e.anchorNode).parent().index(),e.anchorOffset]}else{let e=document.selection.createRange();n.functionRangeIndex=e}s.html(e),n.functionRange(s,e,r),n.canceFunctionrangeSelected(),46!=l&&n.createRangeHightlight(),a.html(e),n.rangestart=!1,n.rangedrag_column_start=!1,n.rangedrag_row_start=!1,n.rangeHightlightselected(s,l)}else"="!=c.substr(0,1)&&("luckysheet-rich-text-editor"==a.attr("id")&&"<span"==a.html().substr(0,5)||a.html(e))},1)},functionHTMLGenerate:function(e){return 0==e.length||"="!=e.substr(0,1)?e:(this.functionHTMLIndex=0,'<span dir="auto" class="luckysheet-formula-text-color">=</span>'+this.functionHTML(e))},functionHTML:function(e){let t=this;if(null==t.operatorjson){let e=t.operator.split("|"),l={};for(let t=0;t<e.length;t++)l[e[t].toString()]=1;t.operatorjson=l}"="==e.substr(0,1)&&(e=e.substr(1));let l=e.split(""),n=0,a="",s="",r={bracket:0,comma:0,squote:0,dquote:0,braces:0};for(;n<l.length;){let e=l[n];if("("==e&&0==r.squote&&0==r.dquote&&0==r.braces)r.bracket+=1,a.length>0?s+='<span dir="auto" class="luckysheet-formula-text-func">'+a+'</span><span dir="auto" class="luckysheet-formula-text-lpar">(</span>':s+='<span dir="auto" class="luckysheet-formula-text-lpar">(</span>',a="";else if(")"==e&&0==r.squote&&0==r.dquote&&0==r.braces)r.bracket-=1,s+=t.functionHTML(a)+'<span dir="auto" class="luckysheet-formula-text-rpar">)</span>',a="";else if("{"==e&&0==r.squote&&0==r.dquote)a+="{",r.braces+=1;else if("}"==e&&0==r.squote&&0==r.dquote)a+="}",r.braces-=1;else if('"'==e&&0==r.squote)r.dquote>0?(a.length>0?s+=a+'"</span>':s+='"</span>',r.dquote-=1,a=""):(r.dquote+=1,a.length>0?s+=t.functionHTML(a)+'<span dir="auto" class="luckysheet-formula-text-string">"':s+='<span dir="auto" class="luckysheet-formula-text-string">"',a="");else if("'"==e&&0==r.dquote)a+="'",r.squote=0==r.squote?1:0;else if(","==e&&0==r.squote&&0==r.dquote&&0==r.braces)s+=t.functionHTML(a)+'<span dir="auto" class="luckysheet-formula-text-comma">,</span>',a="";else if("&"==e&&0==r.squote&&0==r.dquote&&0==r.braces)a.length>0?(s+=t.functionHTML(a)+'<span dir="auto" class="luckysheet-formula-text-calc">&</span>',a=""):s+='<span dir="auto" class="luckysheet-formula-text-calc">&</span>';else if(e in t.operatorjson&&0==r.squote&&0==r.dquote&&0==r.braces){let r="";n+1<l.length&&(r=l[n+1]);let c=n-1,u=null;if(c>=0)do{u=l[c--]}while(c>=0&&" "==u);e+r in t.operatorjson?(a.length>0?(s+=t.functionHTML(a)+'<span dir="auto" class="luckysheet-formula-text-calc">'+e+r+"</span>",a=""):s+='<span dir="auto" class="luckysheet-formula-text-calc">'+e+r+"</span>",n++):!/[^0-9]/.test(r)&&"-"==e&&("("==u||null==u||","==u||" "==u||u in t.operatorjson)?a+=e:a.length>0?(s+=t.functionHTML(a)+'<span dir="auto" class="luckysheet-formula-text-calc">'+e+"</span>",a=""):s+='<span dir="auto" class="luckysheet-formula-text-calc">'+e+"</span>"}else a+=e;if(n==l.length-1)if(t.iscelldata($.trim(a)))s+='<span class="luckysheet-formula-functionrange-cell" rangeindex="'+t.functionHTMLIndex+'" dir="auto" style="color:'+H[t.functionHTMLIndex]+';">'+a+"</span>",t.functionHTMLIndex++;else if(r.dquote>0)s+=a+"</span>";else if(-1==a.indexOf("</span>")&&a.length>0){let e=/{.*?}/;if(e.test($.trim(a))){let t=e.exec(a)[0],l=a.search(e),n="";l>0&&(n+='<span dir="auto" class="luckysheet-formula-text-color">'+a.substr(0,l)+"</span>"),n+='<span dir="auto" style="color:#959a05" class="luckysheet-formula-text-array">'+t+"</span>",l+t.length<a.length&&(n+='<span dir="auto" class="luckysheet-formula-text-color">'+a.substr(l+t.length,a.length)+"</span>"),s+=n}else s+='<span dir="auto" class="luckysheet-formula-text-color">'+a+"</span>"}n++}return s}})});
//# sourceMappingURL=../sourcemaps/controllers/formula.js.map
